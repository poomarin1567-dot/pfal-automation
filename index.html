<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AGROTECH WMS - Login</title>

  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° Font Awesome (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

  <style>

      /* --- ‚ú® Premium Light & Fan Control Panel CSS ‚ú® --- */

      .light-control-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 28px;
        margin-top: 25px;
      }

      .control-card {
        background: linear-gradient(145deg, var(--card-bg), #F9FAFB);
        border-radius: 24px;
        padding: 28px;
        border: 1px solid var(--card-border);
        box-shadow: var(--shadow-base);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        animation: popIn 0.5s ease-out forwards;
        opacity: 0;
      }

      .control-card:hover {
        transform: translateY(-8px) scale(1.01);
        box-shadow: var(--shadow-hover);
      }

      .control-card h3 {
        display: flex;
        align-items: center;
        gap: 14px;
        font-size: 1.3em;
        font-weight: 600;
        color: var(--primary-dark);
        margin: 0 0 25px 0;
        padding-bottom: 18px;
        border-bottom: 1px solid #eef2f7;
      }
       .control-card h3 i {
        font-size: 1.2em;
        color: var(--primary-light);
       }


      .control-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 10px;
         border-bottom: 1px solid #f3f4f6;
      }
       .control-card .control-row:last-of-type {
        border-bottom: none;
        padding-bottom: 5px; /* Less padding for the last item */
      }


      .control-label {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 1.05em;
        font-weight: 500;
        color: var(--text-dark);
      }
      .control-label i {
        font-size: 1.4em;
        width: 32px;
        text-align: center;
        color: var(--text-light);
        transition: color 0.3s, transform 0.3s;
      }

       /* Icon Colors */
      .control-label .fa-lightbulb.red { color: #f97316; }
      .control-label .fa-lightbulb.white { color: #f59e0b; }
      .control-label .fa-fan { color: #3b82f6; }


      .status-indicator {
          font-size: 0.85em;
          font-weight: 600;
          color: var(--text-light);
          background-color: #f8fafc;
          padding: 5px 12px;
          border-radius: 16px;
          border: 1px solid #e2e8f0;
          margin-left: 8px;
          min-width: 50px;
          text-align: center;
      }

       .control-actions {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      /* ‚ú® Living Buttons ‚ú® */
      .light-btn {
          padding: 9px 18px;
          border-radius: 10px;
          border: 1px solid transparent;
          cursor: pointer;
          font-weight: 600;
          font-size: 0.9em;
          transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
          display: inline-flex;
          align-items: center;
          gap: 8px;
      }

      .light-btn.on {
          background-color: #dcfce7;
          color: #166534;
          border-color: #86efac;
      }
       .light-btn.on:hover {
        background-color: #bbf7d0;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(74, 222, 128, 0.2);
       }


      .light-btn.off {
          background-color: #f1f5f9;
          color: #475569;
           border-color: #e2e8f0;
      }
      .light-btn.off:hover {
        background-color: #e2e8f0;
         transform: translateY(-2px);
         box-shadow: 0 4px 12px rgba(100, 116, 139, 0.1);
      }


      /* ‚ú® Animated Dimmer Slider ‚ú® */
      .dimmer-slider {
        -webkit-appearance: none; appearance: none;
        width: 120px; height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        outline: none;
        transition: background .3s;
        cursor: pointer;
      }
      .dimmer-slider:hover {
        background: #cbd5e1;
      }
      .dimmer-slider::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none;
        width: 20px; height: 20px;
        background: var(--primary-light);
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: transform 0.2s ease;
      }
       .dimmer-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
      }

      .dimmer-value {
        font-weight: 600;
        width: 55px;
        text-align: right;
        color: var(--primary-dark);
        background-color: #f8fafc;
        padding: 4px 8px;
        border-radius: 8px;
      }

      /* ‚ú® Global Control Panel ‚ú® */
      .global-control-panel {
          background: #fff;
          border-radius: 24px;
          padding: 25px 35px;
          margin-bottom: 30px;
          box-shadow: var(--shadow-base);
          border: 1px solid var(--card-border);
      }
      .global-control-panel h3 {
        color: var(--primary-dark);
        font-size: 1.4em;
        margin-bottom: 8px;
      }
       .global-control-panel p {
        color: var(--text-light);
        margin-top: 0;
        margin-bottom: 20px;
      }

      .global-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
      }

      .global-btn {
        flex-grow: 1;
        padding: 12px 20px;
        font-size: 1em;
        font-weight: 600;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .global-btn.all-on {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2);
      }
       .global-btn.all-on:hover {
        transform: translateY(-3px);
         box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
       }


      .global-btn.all-off {
        background: linear-gradient(135deg, #f43f5e, #e11d48);
         color: white;
         box-shadow: 0 4px 15px rgba(244, 63, 94, 0.2);
      }
        .global-btn.all-off:hover {
        transform: translateY(-3px);
         box-shadow: 0 6px 20px rgba(244, 63, 94, 0.3);
       }



/* ‚ú® HYPER PREMIUM OVERVIEW CSS ‚ú® */

:root {
  --primary-dark: #2d6a4f;
  --primary-light: #52b788;
  --accent-blue: #3b82f6;
  --accent-orange: #f97316;
  --accent-purple: #8b5cf6;
  --card-bg: #ffffff;
  --card-border: #f0f2f5;
  --text-dark: #111827;
  --text-light: #6b7280;
  --shadow-base: 0 5px 15px rgba(0, 0, 0, 0.04), 0 15px 35px rgba(0, 0, 0, 0.05);
  --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.06), 0 20px 50px rgba(0, 0, 0, 0.07);
}

@keyframes popIn {
    0% {
        opacity: 0;
        transform: translateY(25px) scale(0.98);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* --- ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á Content --- */
.content {
  background-color: #f8fafc;
  background-image:
    radial-gradient(circle at 1px 1px, rgba(0,0,0,0.02) 1px, transparent 0);
  background-size: 25px 25px;
}

/* --- Title ‡∏´‡∏•‡∏±‡∏Å --- */
.overview-title {
    font-size: 2.2rem;
    font-weight: 700;
    color: var(--primary-dark);
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    gap: 16px;
    animation: popIn 0.5s ease-out;
    text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.6);
}
.overview-title i {
    color: var(--primary-light);
    filter: drop-shadow(0 3px 5px rgba(82, 183, 136, 0.3));
}

/* --- Hyper Premium Summary Cards --- */
.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 30px;
  margin-bottom: 40px;
}

.summary-card {
  background: linear-gradient(145deg, var(--card-bg), #F9FAFB);
  border-radius: 24px;
  padding: 28px;
  display: flex;
  align-items: center;
  gap: 22px;
  border: 1px solid var(--card-border);
  box-shadow: var(--shadow-base);
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  animation: popIn 0.6s ease-out forwards;
  opacity: 0;
  position: relative;
  overflow: hidden;
}

/* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÅ‡∏™‡∏á‡∏ß‡∏¥‡πà‡∏á‡∏ö‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ Hover */
.summary-card::after {
    content: "";
    position: absolute;
    top: 0;
    left: -150%;
    width: 100%;
    height: 100%;
    background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.5) 50%, transparent 100%);
    transform: skewX(-25deg);
    transition: left 0.6s ease;
}
.summary-card:hover::after {
    left: 150%;
}

.summary-card:hover {
  transform: translateY(-10px) scale(1.02);
  box-shadow: var(--shadow-hover);
  border-color: var(--primary-light);
}

/* Staggered animation */
.summary-card:nth-child(1) { animation-delay: 0.1s; }
.summary-card:nth-child(2) { animation-delay: 0.2s; }
.summary-card:nth-child(3) { animation-delay: 0.3s; }
.summary-card:nth-child(4) { animation-delay: 0.4s; }

.summary-card .icon {
  font-size: 2.4rem;
  width: 72px;
  height: 72px;
  border-radius: 22px;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  box-shadow: 0 6px 12px rgba(0,0,0,0.1), inset 0 2px 4px rgba(0,0,0,0.1);
  text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  border: 2px solid rgba(255, 255, 255, 0.3);
}
.summary-card .icon.inbound { background: linear-gradient(135deg, var(--primary-dark), var(--primary-light)); }
.summary-card .icon.outbound { background: linear-gradient(135deg, #d97706, var(--accent-orange)); }
.summary-card .icon.total { background: linear-gradient(135deg, #2563eb, var(--accent-blue)); }
.summary-card .icon.ontime { background: linear-gradient(135deg, #7c3aed, var(--accent-purple)); }

.summary-card .info .value {
  font-size: 2.8rem;
  font-weight: 700;
  color: var(--text-dark);
  line-height: 1.1;
  margin-bottom: 4px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.summary-card .info .label {
  font-size: 1.05em;
  font-weight: 500;
  color: var(--text-light);
  letter-spacing: 0.5px;
}

/* --- Hyper Premium Chart Cards --- */
.overview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 30px;
}

.overview-card {
  background: var(--card-bg);
  border-radius: 28px;
  padding: 35px;
  box-shadow: var(--shadow-base);
  border: 1px solid var(--card-border);
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  animation: popIn 0.6s ease-out forwards;
  opacity: 0;
}

.overview-grid .overview-card:nth-child(1) { animation-delay: 0.5s; }
.overview-grid .overview-card:nth-child(2) { animation-delay: 0.6s; }
.overview-grid .overview-card:nth-child(3) { animation-delay: 0.7s; }

.overview-card:hover {
  transform: translateY(-10px);
  box-shadow: var(--shadow-hover);
}

.overview-card h3 {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 1.4em;
  font-weight: 600;
  color: var(--primary-dark);
  margin: 0 0 30px 0;
  padding-bottom: 20px;
  border-bottom: 1px solid #eef2f7;
}

.overview-card h3 i {
  font-size: 1.3em;
  color: var(--primary-light);
}

#pieChartContainer, .chart-container {
  height: 320px;
  display: flex;
  justify-content: center;
  align-items: center;
}





/* icon pfal  wms dashborad*/

.premium-logo {
  font-size: 2.5em;
  font-weight: 700;
  font-family: 'Prompt', sans-serif;
  display: inline-flex;
  align-items: center;
  gap: 12px;
  background: linear-gradient(to right, #2d6a4f, #74c69d);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  white-space: nowrap;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
  animation: fadeSlideIn 1s ease-out both;
}

.premium-logo i {
  width: 1.4em;
  height: 1.4em;
  color: #52b788;
  stroke-width: 2.2;
  filter: drop-shadow(0 0 4px rgba(82, 183, 136, 0.2));
  animation: iconBounce 0.8s ease;
}

/* Animation */
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateX(-30px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes iconBounce {
  0%   { transform: scale(0.8); opacity: 0; }
  50%  { transform: scale(1.3); opacity: 1; }
  100% { transform: scale(1); }
}



/* 3. ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Station */
.station-dropdown {
  -webkit-appearance: none; /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Safari/Chrome */
  appearance: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£ default */
  padding: 10px 40px 10px 18px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÉ‡∏´‡∏°‡πà */
  border-radius: 12px;
  border: 1px solid #b7e4c7;
  background-color: #ffffff;
  font-size: 1.05em;
  font-weight: 600;
  color: #1b4332;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  transition: all 0.2s ease-in-out;
  
  /* ‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÉ‡∏´‡∏°‡πà (SVG) */
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%231b4332' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
}

.station-dropdown:hover {
  border-color: #52b788;
  box-shadow: 0 4px 12px rgba(82, 183, 136, 0.15);
}

.station-dropdown:focus {
  outline: none;
  border-color: #40916c;
  box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.3);
}











/* ‚úÖ ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status Badge) traymaster */
/* ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á Tray Master ‚ú® */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-in-row {
  opacity: 0;
  animation: fadeInUp 0.5s ease-out forwards;
}

/* üé® [‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î] ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á üé® */
.status-badge {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 6px 14px; border-radius: 20px;
    font-weight: 600; font-size: 0.9em;
    border: 1px solid transparent;
}
.status-badge.on-shelf {
    background-color: #e6f4ea; color: #1b4332; border-color: #a7d7b9;
}
.status-badge.at-workstation {
    background-color: #fffbeb; color: #b45309; border-color: #fde68a;
}
.action-btn {
    display: inline-flex; align-items: center; justify-content: center;
    gap: 6px; padding: 9px 18px; border-radius: 10px;
    border: none; cursor: pointer; font-weight: 600;
    font-size: 0.9em; transition: all 0.2s ease-in-out;
    min-width: 90px;
}
.action-btn.edit { background-color: #f97316; color: white; }
.action-btn.edit:hover {
    background-color: #ea580c; transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
}
.action-btn.history { background-color: #4b5563; color: white; }
.action-btn.history:hover {
    background-color: #374151; transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(75, 85, 99, 0.3);
}/* ‚úÖ ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status Badge) traymaster */





/* ‚úÖ Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà */
.history-row td {
  background-color: #f8f9fa;
  padding: 20px !important;
  border-bottom: 2px solid #52b788;
}
.history-table {
  width: 100%;
  border-collapse: collapse;
  margin: 0 auto;
}
.history-table th, .history-table td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #e0e0e0;
}
.history-table th {
  background-color: #2d6a4f; /* üé® ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å */
  color: #ffffff; /* üé® ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
  font-weight: 600;
}
.history-row .action-inbound { 
    color: #1b4332; /* ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
    font-weight: bold; 
}
.history-row .action-outbound { color: #ef4444; font-weight: bold; }


/**
 * ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] CSS ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
 */
#outboundValidationBox {
  padding: 18px;
  border-radius: 12px;
  border-width: 1px;
  border-style: solid;
  transition: all 0.3s ease-in-out;
  animation: fadeIn 0.4s;
}

#outboundValidationBox p {
  margin: 0;
  font-size: 1.05em;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠‡∏ñ‡∏≤‡∏î (Success) */
#outboundValidationBox.success {
  background-color: #f0fdf4; /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô */
  border-color: #bbf7d0;
  color: #166534;
}

/* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ñ‡∏≤‡∏î (Warning) */
#outboundValidationBox.warning {
  background-color: #fffbeb; /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô */
  border-color: #fde68a;
  color: #b45309;
}
/* ‚úÖ üíÖ CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pop-up ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î */
/* ‚úÖ Pop-up Styling (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå) */
.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(31, 41, 55, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(5px);
  opacity: 0;
  animation: fadeIn 0.3s ease-out forwards;
}

.popup-container {
  background: #ffffff;
  padding: 35px 40px;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  width: 90%;
  max-width: 520px;
  transform: scale(0.95);
  animation: popIn 0.3s ease-out forwards;
}

.popup-header {
  text-align: center;
  margin-bottom: 25px;
}

.popup-header .icon {
  font-size: 3rem;
  color: #10B981; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (Default) */
}

/* ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô Outbound */
.popup-header .icon.danger {
    color: #e63946;
}

.popup-title {
  font-size: 1.6em;
  font-weight: 700;
  color: #1F2937;
  margin-top: 15px;
  margin-bottom: 8px;
}

.popup-subtitle {
  font-size: 1.1em;
  color: #6B7280;
  margin: 0;
}

.popup-summary {
  background-color: #F9FAFB;
  border-radius: 12px;
  padding: 20px;
  border: 1px solid #E5E7EB;
  margin-top: 20px;
}

.summary-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  font-size: 1.05em;
  border-bottom: 1px solid #F3F4F6;
}

.summary-item:last-child {
  border-bottom: none;
}

.summary-label {
  color: #4B5563;
  font-weight: 500;
}

.summary-value {
  color: #111827;
  font-weight: 600;
  text-align: right;
  word-break: break-all;
}

.summary-value.highlight {
  color: #059669;
  font-weight: 700;
}

.popup-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-top: 30px;
}

.popup-button {
  padding: 14px;
  font-size: 1.1em;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.popup-button.cancel {
  background-color: #E5E7EB;
  color: #4B5563;
  border: 1px solid #D1D5DB;
}

.popup-button.cancel:hover {
  background-color: #D1D5DB;
}

/* -- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -- */
.popup-button.confirm {
  background: linear-gradient(135deg, #10B981, #059669);
  color: white;
}

.popup-button.confirm:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

/* ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á */
.popup-button.confirm.danger {
  background: linear-gradient(135deg, #e63946, #b91c1c);
}

.popup-button.confirm.danger:hover {
  background: linear-gradient(135deg, #b91c1c, #9a141a);
  box-shadow: 0 4px 15px rgba(229, 62, 77, 0.3);
}


/* === üíÖ Deluxe Form Styling === */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

body {
    background: #f0f2f5; /* A softer, more modern background */
    font-family: 'Inter', sans-serif;
}

.form-container-deluxe {
    max-width: 850px;
    margin: 50px auto;
    padding: 45px;
    background: #ffffff;
    border-radius: 24px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
    border: 1px solid #e5e7eb;
    overflow: hidden;
}

.form-header {
    text-align: center;
    margin-bottom: 40px;
}

.form-title {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    font-size: 2.2em; /* Larger, more impactful title */
    font-weight: 700;
    color: #111827;
    margin: 0 0 8px 0;
}

.form-title i {
    color: #10B981; /* A fresh, vibrant green */
}

.form-subtitle {
    font-size: 1.1em;
    color: #6B7280;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 28px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 10px;
    font-size: 0.9em;
}

.form-group label i {
    color: #9CA3AF;
    font-size: 1.1em;
}

.form-input-deluxe {
    width: 100%;
    padding: 14px 18px;
    border: 1px solid #D1D5DB;
    border-radius: 12px;
    font-size: 1em;
    font-family: 'Inter', sans-serif;
    color: #1F2937;
    background-color: #F9FAFB;
    transition: all 0.2s ease-in-out;
}

.form-input-deluxe:focus {
    outline: none;
    border-color: #10B981;
    background-color: #ffffff;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
}

.form-input-deluxe::placeholder {
    color: #9CA3AF;
}

textarea.form-input-deluxe {
    resize: vertical;
    padding-top: 14px;
}

.form-button-action {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    padding: 18px;
    font-size: 1.15em;
    font-weight: 700;
    color: white;
    background: linear-gradient(135deg, #10B981, #059669);
    border: none;
    border-radius: 14px;
    cursor: pointer;
    margin-top: 30px;
    box-shadow: 0 5px 20px rgba(16, 185, 129, 0.2);
    transition: all 0.3s ease;
}

.form-button-action:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
}

.form-button-action.danger {
    background: linear-gradient(135deg, #EF4444, #DC2626);
    box-shadow: 0 5px 20px rgba(239, 68, 68, 0.2);
}

.form-button-action.danger:hover {
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
}

/* Responsive adjustments for smaller screens */
@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    .form-container-deluxe {
        padding: 30px;
    }
    .form-title {
        font-size: 1.8em;
    }
}

/* ‚úÖ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° */
.camera-section {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  justify-content: center;
  align-items: stretch;
  margin-top: 30px;
  padding: 10px 0;
}

/* ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏∏‡∏î‡∏´‡∏£‡∏π */
.camera-box {
  position: relative;
  flex: 1 1 42%;
  max-width: 720px;
  aspect-ratio: 16 / 9;
  background: #000;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.06);
  backdrop-filter: blur(3px);
}

.camera-box:hover {
  transform: scale(1.015);
  box-shadow: 0 12px 36px rgba(0, 0, 0, 0.4);
}

/* ‚úÖ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô) */
.camera-box img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

/* ‚úÖ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏°‡∏∏‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô RGV ‡∏ï‡∏¥‡∏î‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á) */
.camera-box .rotate-left {
  transform: rotate(-90deg);
  transform-origin: center center;
  position: absolute;
  top: 50%;
  left: 50%;
  width: 160%;      /* ‚úÖ ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á */
  height: auto;
  translate: -50% -50%;
  object-fit: cover;
}

/* ‚úÖ ‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏π‡∏´‡∏£‡∏≤ */
.camera-label {
  position: absolute;
  bottom: 12px;
  left: 16px;
  background: rgba(0, 0, 0, 0.6);
  color: #ffffff;
  padding: 6px 14px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 500;
  font-family: 'Segoe UI', 'Kanit', sans-serif;
  letter-spacing: 0.5px;
  backdrop-filter: blur(2px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  gap: 6px;
}

.camera-label i {
  color: #58d68d;
  font-size: 14px;
}
/* ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ AGV ‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á */
.agv-status-box {
  position: relative;
  background: linear-gradient(135deg, var(--boxColor, #1eb980), rgba(255, 255, 255, 0.05));
  border-radius: 20px;
  padding: 26px 36px;
  color: #ffffff;
  font-family: 'Segoe UI', sans-serif;
  width: 100%;
  max-width: 860px;
  margin: 36px auto;
  box-shadow:
    0 10px 24px rgba(0, 0, 0, 0.2),
    0 0 16px var(--boxColor);
  border: 1px solid rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  overflow: hidden;
  z-index: 1;
  text-align: center;
}

/* ‚úÖ ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÅ‡∏™‡∏á‡∏ô‡∏∏‡πà‡∏° (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ animation) */
.agv-status-box::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle at center, var(--boxColor, #1eb980) 0%, transparent 70%);
  opacity: 0.08;
  pointer-events: none;
  z-index: 0;
}

/* ‚úÖ ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏ö‡∏ö‡∏ö‡∏≤‡∏•‡∏≤‡∏ô‡∏ã‡πå */
.agv-status-title {
  font-size: 1.85rem;
  font-weight: 700;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 14px;
  color: #ffffff;
  text-shadow: 0 2px 5px rgba(0, 0, 0, 0.35);
  position: relative;
  z-index: 1;
}

.agv-status-title i {
  font-size: 2rem;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.25));
}

/* ‚úÖ ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏≠‡∏î‡∏µ‡∏™‡∏≤‡∏¢‡∏ï‡∏≤ */
.agv-status-desc {
  font-size: 1.1rem;
  font-weight: 400;
  opacity: 0.94;
  line-height: 1.6;
  color: #f8f9fa;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  position: relative;
  z-index: 1;
}

/* üî¥ Error Style ‡πÅ‡∏ö‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û */
.agv-status-box.error {
  background: linear-gradient(135deg, #dc3545, #6a1b1b);
  box-shadow:
    0 10px 28px rgba(220, 53, 69, 0.35),
    0 0 12px #dc3545;
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: #fff;
}



/* üî∑ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° */
.btn-premium {
  padding: 14px 26px;
  font-size: 1rem;
  font-weight: 600;
  border-radius: 14px;
  background: linear-gradient(135deg, #52b788, #2d6a4f);
  color: #ffffff;
  border: none;
  box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  cursor: pointer;
  transition: all 0.25s ease;
}
.btn-premium:hover {
  transform: translateY(-2px);
  background: linear-gradient(135deg, #2d6a4f, #1b4332);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
}

/* üî∑ ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏ß‡∏¢‡∏´‡∏£‡∏π */
.main-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin: 30px 0;
}

/* üî∑ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° */
.camera-section {
  display: flex;
  flex-wrap: wrap;
  gap: 36px;
  justify-content: center;
  margin: 40px 0;
}
.camera-box {
  flex: 1 1 48%;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
  overflow: hidden;
  position: relative;
  border: 1px solid #e2e8f0;
  height: auto;
}

/* üî∑ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ AGV ‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° */
.lift-status {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  margin: 24px auto;
  padding: 14px 28px;
  font-size: 1.1rem;
  font-weight: 600;
  border-radius: 16px;
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.15);
  border: 2px solid transparent;
  background: linear-gradient(to right, #06b6d4, #0ea5e9);
  color: #ffffff;
  transition: all 0.4s ease;
}
.lift-status.working {
  background: linear-gradient(to right, #06b6d4, #0ea5e9);
  border-color: #0ea5e9;
}
.lift-status.working i {
  margin-right: 6px;
}

/* üî∑ ‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå */
.sensor-status {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
  margin-bottom: 30px;
}
.sensor-tag {
  background: #e6f4ea;
  color: #1b4332;
  border: 1px solid #52b788;
  border-radius: 20px;
  padding: 8px 18px;
  font-size: 0.95em;
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
}

/* üî∑ Dropdown ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á */
.dropdown {
  text-align: center;
  margin-top: 40px;
}
select.dropdown-select {
  padding: 12px 20px;
  font-size: 1em;
  font-weight: 500;
  border-radius: 14px;
  border: 1px solid #cbd5e1;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
  width: 280px;
  margin-top: 10px;
  background-color: #ffffff;
  color: #1b4332;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg fill='none' stroke='%232d6a4f' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  background-size: 16px 16px;
  transition: all 0.3s ease;
}
select.dropdown-select:focus {
  border-color: #40916c;
  box-shadow: 0 0 0 3px rgba(64, 145, 108, 0.25);
}



/* ‚úÖ liftstatus */

.lift-status.working {
  background: linear-gradient(to right, #0284c7, #0ea5e9); /* üíô ‡∏ü‡πâ‡∏≤‡∏™‡∏î */
  color: white;
  border: 2px solid #0ea5e9;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: all 0.4s ease;
}


.lift-status {
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 24px auto;
  padding: 14px 24px;
  font-size: 1.1rem;
  font-weight: 600;
  border-radius: 14px;
  width: fit-content;
  box-shadow: 0 6px 14px rgba(0,0,0,0.15);
  border: 2px solid;
  transition: all 0.4s ease;
}

.lift-status.success {
  background: linear-gradient(to right, #38b000, #70e000);
  color: white;
  border-color: #28a745;
}

.lift-status.recovery {
  background: linear-gradient(to right, #f59e0b, #fbbf24);
  color: white;
  border-color: #f59e0b;
  animation: pulse 1.5s infinite;
}

.lift-status.emergency {
  background: linear-gradient(to right, #dc2626, #ef4444);
  color: white;
  border-color: #dc2626;
  animation: blink 1s infinite;
}

/* ‚úÖ ‡∏´‡∏ô‡πâ‡∏≤ task */
.styled-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  .styled-table th, .styled-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
  }
  .status.success {
    color: #fff;
    background: #4CAF50;
    padding: 4px 8px;
    border-radius: 12px;
  }
  .status.error {
    color: #fff;
    background: #e53935;
    padding: 4px 8px;
    border-radius: 12px;
  }/* ‚úÖ ‡∏´‡∏ô‡πâ‡∏≤ task */
  .blink {
    animation: blinker 1s linear infinite;
  }






/* ‚ú® Premium Tray Info Popup (‡∏â‡∏ö‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà) ‚ú® */
@keyframes popIn {
  from { transform: translateY(20px) scale(0.95); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}

@keyframes popOut {
  from { transform: scale(1); opacity: 1; }
  to { transform: scale(0.95); opacity: 0; }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

.tray-popup-backdrop {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(17, 24, 39, 0.6); /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏•‡∏≠‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  opacity: 0;
  animation: fadeIn 0.3s ease-out forwards;
}

.tray-popup-backdrop.closing {
  animation: fadeOut 0.3s ease-in forwards;
}

.tray-popup-card {
  background: #ffffff;
  padding: 0; /* ‡∏ô‡∏≥ padding ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á header ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
  border-radius: 24px;
  box-shadow: 0 20px 45px rgba(0,0,0,0.25);
  width: 90%;
  max-width: 480px;
  font-family: 'Prompt', sans-serif;
  transform: scale(0.95);
  opacity: 0;
  animation: popIn 0.4s 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  overflow: hidden; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå header */
}

.tray-popup-card.closing {
   animation: popOut 0.3s ease-in forwards;
}


.tray-popup-card .popup-header-premium {
  background: linear-gradient(145deg, #3b82f6, #2563eb);
  color: white;
  padding: 25px 30px;
  text-align: center;
}

.tray-popup-card .popup-header-premium i {
  font-size: 2.5rem;
  margin-bottom: 12px;
  display: block;
  text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.tray-popup-card .popup-header-premium h3 {
  font-size: 1.8em;
  font-weight: 600;
  margin: 0;
}

.tray-popup-card .info-list {
  padding: 25px 35px;
  display: flex;
  flex-direction: column;
  gap: 18px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
}

.tray-popup-card .info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 1.05em;
  padding-bottom: 18px;
  border-bottom: 1px solid #f3f4f6;
  opacity: 0;
  animation: fadeInUp 0.5s ease-out forwards;
}

.tray-popup-card .info-item:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

/* ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏ö‡∏ö Staggered (‡∏ó‡∏¢‡∏≠‡∏¢‡πÅ‡∏™‡∏î‡∏á) */
.tray-popup-card .info-item:nth-child(1) { animation-delay: 0.2s; }
.tray-popup-card .info-item:nth-child(2) { animation-delay: 0.25s; }
.tray-popup-card .info-item:nth-child(3) { animation-delay: 0.3s; }
.tray-popup-card .info-item:nth-child(4) { animation-delay: 0.35s; }
.tray-popup-card .info-item:nth-child(5) { animation-delay: 0.4s; }
.tray-popup-card .info-item:nth-child(6) { animation-delay: 0.45s; }

.tray-popup-card .info-label {
  color: #4b5563;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 12px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô */
}

.tray-popup-card .info-value {
  color: #111827;
  font-weight: 600;
  text-align: right;
}

.tray-popup-card .info-value.highlight {
    background: #e9f5ec;
    color: #1b4332;
    padding: 4px 10px;
    border-radius: 8px;
    font-weight: 700;
}

.tray-popup-card .close-button-wrapper {
  padding: 20px 35px;
  background-color: #f9fafb;
  border-top: 1px solid #e5e7eb;
}

.tray-popup-card .close-button {
  width: 100%;
  background: #4b5563; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏° */
  color: white;
  padding: 14px;
  font-size: 1.1em;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.tray-popup-card .close-button:hover {
  background: #374151;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(75, 85, 99, 0.2);
}








/* ‚úÖ ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° */
.status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  font-size: 0.95em;
  padding: 4px 12px;
  border-radius: 20px;
  transition: 0.3s ease;
}
.status-due {
  background-color: #fff0f0;
  color: #e63946;
  border: 1px solid #e63946;
}
.status-due.blink {
  animation: blinkEffect 1s infinite;
}
.status-growing {
  background-color: #e9f5ec;
  color: #2d6a4f;
  border: 1px solid #2d6a4f;
}
.status i {
  font-size: 0.9em;
}

/* ‚úÖ ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß */
.harvest-due {
  background-color: #fff0f0 !important;
  transition: background-color 0.3s ease;
}

/* ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å */
.card {
  background: linear-gradient(135deg, #ffffff, #f0fdf4);
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
  margin: 24px auto;
  max-width: 95%;
  font-family: 'Prompt', sans-serif;
  animation: fadeIn 0.5s ease-in-out;
}

h2 {
  font-size: 1.8rem;
  color: #1b4332;
  margin-bottom: 24px;
  display: flex;
  align-items: center;
  font-weight: 600;
}
h2 i {
  color: #40916c;
  margin-right: 10px;
  font-size: 1.4em;
}

/* ‚úÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
.styled-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: #ffffff;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.styled-table thead {
  background-color: #2d6a4f;
}

.styled-table th,
.styled-table td {
  text-align: center;
  padding: 16px;
  font-size: 0.95em;
}

.styled-table th {
  color: #ffffff;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.styled-table td {
  color: #333;
  border-bottom: 1px solid #f3f3f3;
}

.styled-table tr:last-child td {
  border-bottom: none;
}

/* ‚úÖ ‡∏à‡∏∏‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏µ */
.status-green::before,
.status-red::before {
  content: '\f111';
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  margin-right: 6px;
  font-size: 0.75em;
}
.status-green::before { color: #2d6a4f; }
.status-red::before { color: #e63946; }

/* ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö Super Dev */
#plantingPagination {
  display: flex !important;
  flex-direction: row !important;
  justify-content: center !important;
  align-items: center;
  gap: 8px;
  margin-top: 24px;
  flex-wrap: wrap;
}

.pagination button {
  background: #e9f5ec;
  border: 1px solid #2d6a4f;
  border-radius: 10px;
  padding: 8px 16px;
  font-size: 0.9em;
  font-weight: 500;
  color: #2d6a4f;
  cursor: pointer;
  transition: 0.3s;
  min-width: 44px;

  /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ */
  width: auto;
  flex: 0 0 auto;
}

.pagination button.active,
.pagination button:hover {
  background: #2d6a4f;
  color: white;
  transform: scale(1.05);
}

/* ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á */
.action-buttons {
  display: flex;
  gap: 8px;
  justify-content: center;
  flex-wrap: wrap;
}

.action-buttons button {
  background-color: #52b788;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 10px;
  font-size: 0.85em;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  font-weight: 500;
}

.action-buttons button:hover {
  background-color: #40916c;
  transform: scale(1.04);
}




.toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #d1fae5; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô */
  color: #065f46;
  padding: 16px 24px;
  border-radius: 12px;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  opacity: 0;
  transition: opacity 0.5s ease;
  z-index: 9999;
  pointer-events: none;
}

.toast.show {
  opacity: 1;
}
/* üçø Premium Log Cards Style */

.log-cards-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 24px;
  max-width: 1400px;
  margin: auto;
  margin-top: 30px;
}

.log-card {
  width: 320px;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  padding: 20px;
  font-family: 'Prompt', sans-serif;
  color: #1b4332;
  border: 1px solid #dde;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.log-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 28px rgba(0,0,0,0.15);
}

.log-card strong {
  color: #40916c;
}

.log-card .expand-btn {
  margin-top: 14px;
  padding: 10px 20px;
  border: none;
  background: linear-gradient(to right, #52b788, #40916c);
  color: white;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
  font-size: 0.95em;
  transition: 0.3s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.log-card .expand-btn:hover {
  background: linear-gradient(to right, #40916c, #2d6a4f);
  transform: translateY(-1px);
}

/* üîç Filter Form */
.user-logs-filters {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 24px;
  margin-bottom: 30px;
  padding: 10px 0;
}

.user-logs-filters label {
  font-weight: 600;
  color: #1b4332;
  margin-bottom: 6px;
  font-size: 0.95em;
  display: block;
}

.user-logs-filters input,
.user-logs-filters select {
  padding: 12px 16px;
  font-size: 1em;
  border-radius: 14px;
  border: 1px solid #ced4da;
  background: #ffffff;
  color: #1b4332;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  transition: border 0.2s ease, box-shadow 0.3s ease;
  min-width: 220px;
}

.user-logs-filters input:focus,
.user-logs-filters select:focus {
  outline: none;
  border-color: #52b788;
  box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.2);
}

.user-logs-filters button {
  padding: 14px 24px;
  background: linear-gradient(to right, #52b788, #40916c);
  border: none;
  border-radius: 14px;
  color: white;
  font-weight: bold;
  font-size: 1em;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.user-logs-filters button:hover {
  background: linear-gradient(to right, #40916c, #2d6a4f);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.15);
}

/* üìè Pagination Premium */
#pagination {
  margin-top: 24px;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  padding: 10px;
}

#pagination button {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  border: none;
  background: #e9f5ec;
  color: #1b4332;
  font-weight: bold;
  font-size: 1em;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
}

#pagination button:hover {
  background: #b7e4c7;
  transform: translateY(-1px);
}

#pagination .active {
  background: #40916c;
  color: white;
}




.manual-btn { /* ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏µ‡πâ‡∏ô‡∏•‡∏á */
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  font-size: 1rem;
  font-family: 'Prompt', sans-serif;
  background: linear-gradient(145deg, #2d6a4f, #40916c);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

 /* ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏µ‡πâ‡∏ô‡∏•‡∏á */
.manual-btn:hover {
  background: linear-gradient(145deg, #1b4332, #2d6a4f);
  transform: translateY(-2px);
}

 /* ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏µ‡πâ‡∏ô‡∏•‡∏á */
.manual-btn i {
  font-size: 1.2rem;
}

lift-container {
  position: relative;
  width: 200px;
  height: 600px;
  margin: 20px auto;
  border: 1px solid #ccc;
}

.lift-bg {
  width: 100%;
  height: 100%;
  display: block;
}

.lift-cart {
  position: absolute;
  left: 0;
  width: 100%;
  height: 60px;
  transition: top 1s ease;
  z-index: 10;
}

.sensor {
  position: absolute;
  left: 90%;
  width: 12px;
  height: 12px;
  background-color: gray;
  border-radius: 50%;
  z-index: 5;
  animation: blinkOff 1s infinite;
}







.video-overlay {
  background: none;
}

#loginVideo {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  z-index: -2;
  filter: brightness(1) blur(0.7px); /* ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô (brightness 1) */
}

.dashboard-title {
  font-size: 2em; /* ‡∏•‡∏î‡∏à‡∏≤‡∏Å 2.6em */
  font-weight: 600; /* ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡∏•‡∏á */
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(to right, #1b4332, #40916c);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 1px 1px 1.5px rgba(0, 0, 0, 0.05);
  margin: 10px 0 15px 0; /* ‡∏ö‡∏µ‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏ö‡∏ô‡∏•‡πà‡∏≤‡∏á */
  text-align: left;
  padding-left: 20px; /* ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
  display: flex;
  align-items: center;
  gap: 8px; /* ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ */
}



.sidebar {
  width: 260px !important;
}

.sidebar-header,
.sidebar-brand {
  padding: 10px 10px !important; /* üîΩ ‡∏•‡∏î padding ‡∏ö‡∏ô‡∏•‡∏á */
  text-align: center;
}

.sidebar-logo {
  width: 180px !important;
  max-width: 100% !important;
  height: auto !important;
  margin: 10px auto 5px !important; /* üîΩ ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏•‡∏á */
  display: block;
}



.footer-illustration {
  width: 200px;           /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å 140px ‚Üí 200px */
  max-width: 90%;
  height: auto;
  display: block;
  margin: 30px auto 0;    /* ‡∏Ç‡∏¢‡∏±‡∏ö‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡πÉ‡∏´‡πâ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏• */
}

.logo {
  width: 120px;
  height: auto;
  display: block;
  margin: 0 auto 20px;
  filter: drop-shadow(0 0 8px rgba(0,255,170,0.2)); /* ‡πÅ‡∏™‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏ô‡∏¥‡∏î‡πÜ */
}
.logo:hover {
  transform: scale(1.05);
}

.sidebar {
  width: 260px !important;
  height: 100vh;              /* ‚úÖ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
  overflow-y: auto;           /* ‚úÖ ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô */
  scroll-behavior: smooth;    /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ scroll */
  padding-bottom: 30px;       /* ‚úÖ ‡∏Å‡∏±‡∏ô footer ‡∏ó‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ */
}

.sidebar-logo {
  width: 140px;
  max-width: 100%;
  height: auto;
  margin: 10px auto;
  display: block;
  transition: transform 0.3s ease;
}
.sidebar-logo:hover {
  transform: scale(1.05);
}

.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal-box {
  background: white;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
  text-align: center;
  width: 300px;
  font-family: 'Prompt', sans-serif;
}

.modal-buttons {
  margin-top: 20px;
  display: flex;
  justify-content: space-around;
}

.modal-buttons button {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1em;
}

.modal-buttons button:first-child {
  background: #2d6a4f;
  color: white;
}

.modal-buttons button:last-child {
  background: #ccc;
  color: #333;
}
/* ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏™ login ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ */
.login-container {
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 20px;
  padding: 40px;
  width: 320px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.08);

  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;

  height: auto !important;      /* ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏à‡∏î‡∏à‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏Å‡πà‡∏≤ */
  min-height: 400px;            /* ‚úÖ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤ Login */
  max-height: 100vh;            /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≠ */
  transition: height 0.2s ease; /* ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ */
}


/* ‚úÖ ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î */
.login-container img {
  width: 140px;
  margin-bottom: 28px;
  filter: drop-shadow(0 0 10px rgba(0, 255, 170, 0.25));
  transition: transform 0.3s ease;
}
.login-container img:hover {
  transform: scale(1.05);
}

/* ‚úÖ Input + icon */
.input-group {
  position: relative;
  margin-bottom: 20px;
}

.input-group i {
  position: absolute;
  top: 50%;
  left: 16px;
  transform: translateY(-50%);
  color: #52b788; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô */
}

.input-group input {
  width: 100%;
  padding: 14px 14px 14px 44px;
  border-radius: 10px;
  border: none;
  background: rgba(255, 255, 255, 0.1);
  color: #52b788; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô */
}

.input-group input::placeholder {
  color: #95d5b2; /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô‡∏≠‡πà‡∏≠‡∏ô */
}

.input-group input:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(64, 145, 108, 0.4);
}

/* ‚úÖ ‡∏õ‡∏∏‡πà‡∏° Sign In */
.login-container button {
  background: linear-gradient(to right, #52b788, #40916c);
  border: none;
  padding: 14px;
  border-radius: 10px;
  color: white;
  font-weight: bold;
  width: 100%;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.login-container button:hover {
  transform: translateY(-2px);
}

/* ‚úÖ ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å */
.login-container a {
  color: white;
  font-size: 0.9em;
  display: block;
  margin-top: 20px;
  text-decoration: none;
}

.login-container a:hover {
  text-decoration: underline;
}
/* üíé Polished & Animated Grid Style üíé */

@keyframes grid-shimmer {
  0% { transform: translateX(-100%) skewX(-20deg); }
  100% { transform: translateX(2500px) skewX(-20deg); } /* 2500px ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏á‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏•‡∏¢‡∏Ç‡∏≠‡∏ö‡πÑ‡∏õ‡πÑ‡∏Å‡∏•‡πÜ */
}

/* --- ‡∏Å‡∏£‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --- */
.tray-grid {
  display: grid;
  gap: 12px;
  padding: 24px;
  background-color: #f8fafc; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ï‡∏≤ */
  border-radius: 18px;
  border: 1px solid #e2e8f0;
  position: relative;
  overflow: hidden; /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Animation */
}

/* --- ‡πÅ‡∏™‡∏á‡∏™‡πÅ‡∏Å‡∏ô (Animation) --- */
.tray-grid::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 10%;
  height: 120%;
  background: linear-gradient(
    to right,
    transparent 0%,
    rgba(255, 255, 255, 0.5) 50%,
    transparent 100%
  );
  animation: grid-shimmer 15s linear infinite;
  pointer-events: none; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏î‡πâ */
}

/* --- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡∏ä‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏±‡πâ‡∏ô) --- */
.tray-header-cell {
  font-weight: 600;
  text-align: center;
  padding: 10px 5px;
  font-size: 0.85em;
  color: #94a3b8; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô */
}

/* --- ‡∏™‡∏•‡πá‡∏≠‡∏ï (‡∏ó‡∏±‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏ñ‡∏≤‡∏î) --- */
.tray-slot {
  border-radius: 10px;
  transition: all 0.25s ease-in-out;
  min-height: 70px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 8px;
  position: relative;
}

/* --- ‡∏™‡∏•‡πá‡∏≠‡∏ï‡∏ß‡πà‡∏≤‡∏á --- */
.tray-slot.empty {
  background-color: #ffffff;
  border: 1px dashed #dce4f2; /* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞ */
  cursor: default;
}
.empty-slot-coords {
    font-size: 0.9em;
    font-weight: 500;
    color: #e2e8f0;
}

/* --- ‡∏™‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ñ‡∏≤‡∏î --- */
.tray-slot.filled {
  background: linear-gradient(145deg, #3b82f6, #2563eb); /* ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô */
  color: white;
  border: 1px solid #1d4ed8;
  box-shadow: 0 6px 16px rgba(59, 130, 246, 0.2);
  cursor: pointer;
}

/* --- ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ --- */
.tray-slot:hover {
  transform: translateY(-4px) scale(1.03);
  box-shadow: 0 10px 25px rgba(148, 163, 184, 0.2);
}
.tray-slot.filled:hover {
  box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
}

/* --- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡∏≠‡∏á Text ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏™‡∏•‡πá‡∏≠‡∏ï --- */
.filled-tray-icon {
  font-size: 1.4em;
  opacity: 0.8;
  margin-bottom: 4px;
}
.filled-tray-veg-name {
    font-size: 0.9em;
    font-weight: 600;
}
.filled-tray-id {
    font-size: 0.75em;
    font-weight: 400;
    background-color: rgba(255, 255, 255, 0.15);
    padding: 1px 5px;
    border-radius: 4px;
    margin-top: 2px;
}



body {
    font-family: 'Prompt', sans-serif;
    background: linear-gradient(to bottom right, #e9f5ec, #ffffff);
  }

.header {
  position: relative; /* ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ absolute ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á */
}

.user-wrapper {
  position: relative;
  display: inline-block;
  font-family: 'Poppins', sans-serif;
}

.user-dropdown {
  display: none;
  position: absolute;
  right: 0;
  top: 110%;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
  padding: 8px 0;
  min-width: 220px;
  z-index: 9999;
  font-family: 'Poppins', sans-serif;
  border: 1px solid #e0e0e0;
}

.user-menu {
  background-color: #f0f0f0;
  padding: 8px 12px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  color: #1b4332;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.user-dropdown .dropdown-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 20px;
  font-size: 1em;
  font-weight: 500;
  color: #1b4332;
  transition: all 0.2s ease;
  border-left: 4px solid transparent;
  cursor: pointer;
}

.user-dropdown .dropdown-item:hover {
  background-color: #e9f5ec;
  border-left: 4px solid #52b788;
  color: #1b4332;
}

.dropdown-item {
  padding: 8px 10px;
  cursor: pointer;
  border-radius: 8px;
  transition: background 0.2s ease;
}

.dropdown-item:hover {
  background-color: #f0f0f0;
}



.theme-toggle {
  padding: 10px 18px;
  background: linear-gradient(to right, #74c69d, #52b788);
  color: white;
  font-weight: bold;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-size: 1em;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
.theme-toggle:hover {
  background: linear-gradient(to right, #52b788, #40916c);
  transform: translateY(-1px);
}


.dropdown-item:hover {
  background: #e9f5ec;
}

#loginPage,
#dashboardPage {
  display: none;
}


#loginPage {
  background: none;
}



.link {
  margin-top: 16px;
  display: block;
  color: #1b4332;
  font-size: 0.9em;
  text-decoration: underline;
  cursor: pointer;
}

    #dashboardPage {
  display: flex;
  flex-direction: row;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
}

.footer-faint p {
  font-weight: 500;
  color: #333;         /* ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å #6c757d */
}

.content {
  padding: 40px;
  overflow-y: auto;
  background: linear-gradient(to bottom, #e9f5ec, #ffffff);
  flex: 1; /* ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ */
}
.footer-faint {
  margin-top: 60px;
  padding-top: 30px;
  text-align: center;
  opacity: 0.95;
  animation: fadeIn 0.8s ease;
  font-size: 1.1em;  /* üî∫ ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏° 0.9em */
  line-height: 1.7;  /* üîÅ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
}

.footer-agrotech {
  max-width: 220px;       /* üî∫ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î */
  margin-top: 25px;
  opacity: 1;
  transition: transform 0.3s ease;
}
.footer-agrotech:hover {
  transform: scale(1.05);  /* ‡πÄ‡∏û‡∏¥‡πà‡∏° interaction ‡∏ï‡∏≠‡∏ô hover */
}




/* ‚úÖ ‡πÅ‡∏ï‡πà‡∏á dropdown menu ‡∏´‡∏ô‡πâ‡∏≤ Inbound */
.tray-form select {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #2d6a4f;              /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° */
  border-radius: 12px;
  font-size: 1.05em;
  font-family: 'Prompt', sans-serif;
  background-color: #ffffff;              /* ‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
  color: #1b4332;                         /* ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏° ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
  appearance: none;                       /* ‡∏ã‡πà‡∏≠‡∏ô dropdown ‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÅ‡∏ö‡∏ö‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏° */
  background-image: url("data:image/svg+xml,%3Csvg fill='none' stroke='%232d6a4f' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  background-size: 16px 16px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); /* ‡πÄ‡∏á‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÜ */
  transition: all 0.3s ease;
}

.tray-form select:focus {
  border-color: #40916c;
  box-shadow: 0 0 0 3px rgba(64, 145, 108, 0.2);
  background-color: #f8fff8;
}

/* ‚úÖ label ‡∏Ç‡πâ‡∏≤‡∏á dropdown */
.tray-form label {
  font-weight: 600;
  margin-bottom: 8px;
  display: block;
  color: #1b4332;
  font-size: 0.95em;
  margin-top: 16px;
}

/* ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î layout ‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° */
.tray-form {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  margin-top: 20px;
}

/* ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á input dropdown */
.tray-form > div {
  flex: 1 1 30%;
  min-width: 240px;
}
/* ‚úÖ ‡πÄ‡πÄ‡∏ï‡πà‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâinborund */
.logo-top {
  text-align: center;
  margin-bottom: 20px;
}
/* ‚úÖ ‡πÄ‡πÄ‡∏ï‡πà‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâoutborun */
.logo-top img {
  max-width: 160px;
  height: auto;
  opacity: 0.9;
  filter: drop-shadow(0 0 3px rgba(0,0,0,0.1));
}




.inbound-btn {
  background: linear-gradient(to right, #95d5b2, #74c69d);
  color: white;
  font-size: 1.2em;
  font-weight: 600;
  padding: 16px 28px;
  border-radius: 20px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 600px;
  display: block;
  margin: 30px auto 10px auto;
}
.inbound-btn:hover {
  transform: translateY(-3px);
  background: linear-gradient(to right, #74c69d, #52b788);
}

.outbound-btn {
  background: linear-gradient(to right, #f87171, #ef4444);
  color: white;
  font-size: 1.2em;
  font-weight: 600;
  padding: 16px 28px;
  border-radius: 20px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 600px;
  display: block;
  margin: 30px auto 10px auto;
}
.outbound-btn:hover {
  transform: translateY(-3px);
  background: linear-gradient(to right, #ef4444, #dc2626);
}

.inbound-title,
.outbound-title {
  text-align: center;
  font-size: 2em;
  font-weight: bold;
  margin-bottom: 10px;
  color: #1b4332;
}

.inbound-desc {
  color: #6c757d;
  text-align: center;
  margin-bottom: 30px;
  font-size: 1em;
}

/* ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÇ‡∏ú‡∏•‡πà */
html, body, #app {
  height: 100%;
  margin: 0;
  padding: 0;
}

/* ‚úÖ ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤ inbound/outbound ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á */
.inbound-page, .outbound-page {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-height: 100vh;
  padding: 40px 20px;
  background: linear-gradient(to bottom, #e9f5ee, #fefefe);
}




/* ‚úÖ ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î */
.warning-message {
  background: #fff5f5;
  color: #dc2626;
  border-left: 6px solid #dc2626;
  padding: 12px 20px;
  font-weight: bold;
  font-size: 0.95em;
  margin-top: 20px;
  border-radius: 12px;
  text-align: center;
  max-width: 700px;
  margin-left: auto;
  margin-right: auto;
}


    * {
      box-sizing: border-box;
      transition: 0.3s ease;
    }
    /* üí° Default: Light Mode */
    body {
  margin: 0;
  padding: 0;
  font-family: 'Prompt', sans-serif;
  background: url('PFAL.png') no-repeat center center fixed;
  background-size: cover;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
.sidebar {
  width: 260px;
  background: #ffffff;
  border-right: 1px solid #cce3d1;
  display: flex;
  flex-direction: column;
  padding: 25px 0;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.04);
  animation: slideInLeft 0.5s ease-out;
}

.sidebar img {
  width: 120px;
  margin: 0 auto 10px;
  transition: transform 0.3s ease;
}
.sidebar img:hover {
  transform: scale(1.1);
}

.sidebar h2 {
  text-align: center;
  color: #2d6a4f;
  margin: 10px 0 0;
  font-weight: 700;
}
.sidebar small {
  color: #6c757d;
  text-align: center;
  display: block;
}
.sidebar a {
  padding: 14px 30px;
  color: #1b4332;
  text-decoration: none;
  font-size: 1.1em;
  display: flex;
  align-items: center;
  border-left: 4px solid transparent;
}
.sidebar a:hover,
.sidebar a.active {
  background: #e9f5ec;
  border-left: 4px solid #52b788;
}
.sidebar a i {
  margin-right: 12px;
  font-size: 1.3em;
}

.main {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 100vh;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 30px;
  background: #ffffff;
  color: #1b4332;
  font-size: 1.6em;
  font-weight: 600;
  border-bottom: 1px solid #cdeed1;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}


.content {
  padding: 40px;
  overflow-y: auto;
  background: linear-gradient(to bottom, #e9f5ec, #ffffff);
}

.section {
  background: #ffffff;
  padding: 35px;
  border-radius: 18px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
  margin-bottom: 40px;
  animation: fadeInUp 0.5s ease;
}
.section h2 {
  color: #1b4332;
  margin-bottom: 20px;
  font-size: 1.4em;
}

select,
button {
  padding: 14px;
  font-size: 1em;
  border-radius: 12px;
  border: 1px solid #ccc;
  margin-bottom: 18px;
  width: 100%;
  background-color: #f8f9fa;
  color: #1b4332;
}

button {
  width: 100%;
  padding: 12px;
  background: #52b788;
  color: white;
  font-weight: bold;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  margin-top: 10px;
  transition: background 0.3s ease;
}

button:hover {
  background: #40916c;
}

.message {
  display: none;
  padding: 14px;
  border-radius: 10px;
  margin-top: 10px;
  font-weight: 600;
  text-align: center;
}
.success {
  background: #d1fae5;
  color: #065f46;
}
.error {
  background: #fee2e2;
  color: #991b1b;
}
/* ‚úÖ Confirm Modal Styling */
.confirm-backdrop {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  animation: fadeIn 0.3s ease;
}

.confirm-box {
  background: #ffffff;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
  text-align: center;
  width: 300px;
  animation: fadeInUp 0.3s ease;
}

.confirm-box h3 {
  margin-bottom: 20px;
  color: #1b4332;
}

.button-group {
  display: flex;
  justify-content: space-between;
}

.confirm-box button {
  padding: 10px 20px;
  font-size: 1em;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  transition: 0.3s;
}

.confirm-box button:first-child {
  background: #52b788;
  color: white;
}
.confirm-box button:first-child:hover {
  background: #40916c;
}
.confirm-box button:last-child {
  background: #ccc;
  color: black;
}
.confirm-box button:last-child:hover {
  background: #aaa;
}

/* üåô Dark Mode Overrides */
body.dark-mode {
  background: linear-gradient(135deg, #121212, #1e1e1e);
  color: #f1f1f1;
}
body.dark-mode .sidebar {
  background: #1f1f1f;
  border-right: 1px solid #333;
  color: #e0e0e0;
}
body.dark-mode .sidebar h2 {
  color: #90ee90;
}
body.dark-mode .sidebar small {
  color: #aaa;
}
body.dark-mode .sidebar a {
  color: #e0e0e0;
}
body.dark-mode .sidebar a:hover,
body.dark-mode .sidebar a.active {
  background: #2d2d2d;
  border-left: 4px solid #52b788;
  color: #90ee90;
}
body.dark-mode .header {
  background: #1c1c1c;
  color: #90ee90;
  border-bottom: 1px solid #2a2a2a;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}
body.dark-mode .content {
  background: #2a2a2a;
}
body.dark-mode .section {
  background: #333;
  color: #f1f1f1;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
}
body.dark-mode select,
body.dark-mode button {
  background-color: #1c1c1c;
  color: #f1f1f1;
  border: 1px solid #555;
}
body.dark-mode .success {
  background: #1d402c;
  color: #90ee90;
}
body.dark-mode .error {
  background: #402020;
  color: #ff6b6b;
}
/* ‚úÖ Dark mode override for Confirm Modal */
body.dark-mode .confirm-box {
  background: #2a2a2a;
  color: #f1f1f1;
}
body.dark-mode .confirm-box h3 {
  color: #f1f1f1;
}
body.dark-mode .confirm-box button:first-child {
  background: #40916c;
}
body.dark-mode .confirm-box button:last-child {
  background: #555;
  color: white;
}
.tab-button {
  background: transparent;
  border: none;
  font-size: 1.2em;
  padding: 12px 24px;
  cursor: pointer;
  color: #1b4332;
  border-bottom: 3px solid transparent;
  font-weight: bold;
  transition: 0.2s ease;
}
.tab-button.active {
  border-bottom: 3px solid #52b788;
  color: #52b788;
}
.tab-button:hover {
  background-color: #e9f5ec;
  border-radius: 8px 8px 0 0;
}


/* üåÄ Animations */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
@keyframes slideInLeft {
  from {
    transform: translateX(-100%);
  }
  to {
    transform: translateX(0);
  }
}

@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}
@media screen and (max-width: 768px) {
  .login-container {
    width: 90%;
  }
}

@keyframes fadeInUp {
  from {
    transform: translateY(20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes blinkOn {
  0%, 100% { background-color: green; }
  50% { background-color: white; }
}

@keyframes blinkOff {
  0%, 100% { background-color: gray; }
}


@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes blinkEffect {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.2; }
}


  @keyframes blinker {
    50% { opacity: 0.4; }
  }



  @keyframes blink {
  0%, 100% { background-color: #b91c1c; }
  50% { background-color: #ef4444; }
}
@keyframes pulse {
  0%, 100% { background-color: #f59e0b; }
  50% { background-color: #fbbf24; }
  
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.03); }
}





  </style>
  
</head>

<body>
 <!-- ‚úÖ popup Returun Workstation  -->
<div class="popup-overlay" id="returnTrayModal" style="display: none;">
  <div class="popup-container" style="max-width: 650px;">
    <div class="popup-header">
      <h2 class="popup-title"><i class="fas fa-arrow-left icon"></i> ‡∏™‡πà‡∏á‡∏ñ‡∏≤‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</h2>
    </div>

    <div style="margin-top: 15px; margin-bottom: 25px;">
        <h3 style="font-weight: 600; color: #4B5563; border-bottom: 1px solid #E5E7EB; padding-bottom: 10px; margin-bottom: 20px;">
          <i class="fas fa-edit" style="margin-right: 8px; color: #6B7280;"></i>
          ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
        </h3>
        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="returnVegType">‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</label>
                <input type="text" id="returnVegType" class="form-input-deluxe" readonly style="background-color: #e9ecef; cursor: not-allowed;">
            </div>
            <div class="form-group">
                <label for="returnPlantQuantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô</label>
                <input type="number" id="returnPlantQuantity" class="form-input-deluxe" placeholder="‡πÄ‡∏ä‡πà‡∏ô 16">
            </div>
            <div class="form-group">
                <label for="returnBatchId">Batch ID (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</label>
                <input type="text" id="returnBatchId" class="form-input-deluxe" readonly style="background-color: #e9ecef; cursor: not-allowed;">
            </div>
             <div class="form-group">
                <label for="returnSeedingDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î</label>
                <input type="date" id="returnSeedingDate" class="form-input-deluxe">
            </div>
            <div class="form-group full-width">
                <label for="returnNotes">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <textarea id="returnNotes" class="form-input-deluxe" rows="2" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..."></textarea>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 25px;">
        <h3 style="font-weight: 600; color: #4B5563; border-bottom: 1px solid #E5E7EB; padding-bottom: 10px; margin-bottom: 20px;">
          <i class="fas fa-map-marker-alt" style="margin-right: 8px; color: #6B7280;"></i>
          ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
        </h3>
        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="returnFloor">‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                <select id="returnFloor" class="form-input-deluxe">
                    <option value="1">‡∏ä‡∏±‡πâ‡∏ô 1</option>
                    <option value="2">‡∏ä‡∏±‡πâ‡∏ô 2</option>
                    <option value="3">‡∏ä‡∏±‡πâ‡∏ô 3</option>
                    <option value="4">‡∏ä‡∏±‡πâ‡∏ô 4</option>
                    <option value="5">‡∏ä‡∏±‡πâ‡∏ô 5</option>
                    <option value="6">‡∏ä‡∏±‡πâ‡∏ô 6</option>
                    <option value="7">‡∏ä‡∏±‡πâ‡∏ô 7</option>
                    <option value="8">‡∏ä‡∏±‡πâ‡∏ô 8</option>
                    <option value="9">‡∏ä‡∏±‡πâ‡∏ô 9</option>
                </select>
            </div>
            <div class="form-group">
                <label for="returnSlot">‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</label>
                 <select id="returnSlot" class="form-input-deluxe">
                    <option value="1">‡∏ä‡πà‡∏≠‡∏á 1</option><option value="2">‡∏ä‡πà‡∏≠‡∏á 2</option><option value="3">‡∏ä‡πà‡∏≠‡∏á 3</option>
                    <option value="4">‡∏ä‡πà‡∏≠‡∏á 4</option><option value="5">‡∏ä‡πà‡∏≠‡∏á 5</option><option value="6">‡∏ä‡πà‡∏≠‡∏á 6</option>
                    <option value="7">‡∏ä‡πà‡∏≠‡∏á 7</option><option value="8">‡∏ä‡πà‡∏≠‡∏á 8</option><option value="9">‡∏ä‡πà‡∏≠‡∏á 9</option>
                    <option value="10">‡∏ä‡πà‡∏≠‡∏á 10</option><option value="11">‡∏ä‡πà‡∏≠‡∏á 11</option><option value="12">‡∏ä‡πà‡∏≠‡∏á 12</option>
                    <option value="13">‡∏ä‡πà‡∏≠‡∏á 13</option><option value="14">‡∏ä‡πà‡∏≠‡∏á 14</option><option value="15">‡∏ä‡πà‡∏≠‡∏á 15</option>
                    <option value="16">‡∏ä‡πà‡∏≠‡∏á 16</option><option value="17">‡∏ä‡πà‡∏≠‡∏á 17</option><option value="18">‡∏ä‡πà‡∏≠‡∏á 18</option>
                    <option value="19">‡∏ä‡πà‡∏≠‡∏á 19</option><option value="20">‡∏ä‡πà‡∏≠‡∏á 20</option>
                </select>
            </div>
        </div>
    </div>

    <div class="popup-actions">
        <button class="popup-button cancel" onclick="closeReturnModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="popup-button confirm" onclick="">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
    </div>
  </div>
</div>



 <!-- ‚úÖ popup Tray Master-->
<div class="popup-overlay" id="editTrayModal" style="display: none;">
  <div class="popup-container">
    <div class="popup-header">
      <h2 class="popup-title"><i class="fas fa-edit icon"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î</h2>
    </div>
    <div class="form-grid" style="grid-template-columns: 1fr;">
        <input type="hidden" id="editTrayId">
        <div class="form-group"><label>‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</label><input type="text" id="editVegType" class="form-input-deluxe"></div>
        <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô</label><input type="number" id="editPlantQuantity" class="form-input-deluxe"></div>
        <div class="form-group"><label>Batch ID</label><input type="text" id="editBatchId" class="form-input-deluxe"></div>
        <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î</label><input type="date" id="editSeedingDate" class="form-input-deluxe"></div>
        <div class="form-group"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea id="editNotes" class="form-input-deluxe" rows="3"></textarea></div>
    </div>
    <div class="popup-actions">
        <button class="popup-button cancel" onclick="closeEditModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="popup-button confirm" onclick="handleUpdateTray()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
    </div>
  </div>
</div>




  <!-- ‚úÖ popup tray inventroy-->
  <div id="trayInfoPopup" class="tray-popup-backdrop" style="display: none;">
  <div class="tray-popup-card">
    <h3><i class="fas fa-boxes"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î</h3>
    <div id="trayInfoContent"></div>
    <button onclick="closeTrayInfoPopup()"><i class="fas fa-times-circle"></i> ‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

 
 <div id="toast" class="toast"></div>


 
  <!-- ‚úÖ ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ai -->
  <video autoplay muted loop id="loginVideo" playsinline>
    <source src="vidu-video-2763632902164823.mp4" type="video/mp4">
  </video>


  

<div id="loginPage" class="login-container">
  <img src="agrotech-logo.png" class="logo" />
  <div class="form-box">
    <div class="input-group">
      <i class="fas fa-user"></i>
      <input type="text" id="username" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" />
    </div>
    <div class="input-group">
      <i class="fas fa-key"></i>
      <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
    </div>
    <button onclick="login()">Sign In</button>
    <div id="loginMsg" class="message"></div>
    <a href="#" onclick="goToRegister()">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>
  </div>
</div>

</div>

<!-- ‚úÖ Register Page -->
<div id="registerPage" class="login-container" style="display: none;">
  <img src="agrotech-logo.png" class="logo" />
  <div class="form-box">
    <div class="input-group">
      <i class="fas fa-user"></i>
      <input type="text" id="regUsername" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà" />
    </div>
    <div class="input-group">
      <i class="fas fa-key"></i>
      <input type="password" id="regPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
    </div>
    <div class="input-group">
      <i class="fas fa-id-badge"></i>
      <select id="regRole">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>
        <option value="‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</option>
        <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>
        <option value="IT">IT</option>
        <option value="Engineer">Engineer</option>
      </select>
    </div>
    <button onclick="register()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
    <div id="registerMsg" class="message"></div>
    <a class="link" onclick="backToLogin()"><i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</a>
  </div>
</div>

<!-- ‚úÖ Modal ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô -->
<div id="changeBox" class="confirm-backdrop" style="display: none;">
  <div class="confirm-box" style="
    max-width: 400px;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    background: #ffffff;
    text-align: center;
    font-family: 'Prompt', sans-serif;
  ">
    <h3 style="font-size: 1.6em; color: #1b4332; display: flex; justify-content: center; align-items: center; gap: 10px;">
      <i class="fa-solid fa-key"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
    </h3>

    <div style="display: flex; flex-direction: column; gap: 16px; margin-top: 25px;">
      <input id="changeUser" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏î‡∏¥‡∏°" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
      <input id="oldPass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
      <input id="newPass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
    </div>

    <div class="button-group" style="margin-top: 30px; display: flex; gap: 16px; justify-content: center;">
      <button onclick="changePassword()" style="
        padding: 12px 24px;
        background: #52b788;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#40916c'" onmouseout="this.style.background='#52b788'">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà
      </button>
      <button onclick="closeChangePassword()" style="
        padding: 12px 24px;
        background: #e2e8f0;
        color: #333;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#cbd5e1'" onmouseout="this.style.background='#e2e8f0'">
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </button>
    </div>

    <div id="changeMsg" class="message" style="
      margin-top: 20px;
      font-weight: 500;
      color: #991b1b;
      display: none;
    "></div>
  </div>
</div>


<!-- ‚úÖ Dete USENAME -->
<div id="deleteBox" class="confirm-backdrop" style="display: none;">
  <div class="confirm-box" style="
    max-width: 400px;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    background: #ffffff;
    text-align: center;
    font-family: 'Prompt', sans-serif;
  ">
    <h3 style="font-size: 1.6em; color: #1b4332; display: flex; justify-content: center; align-items: center; gap: 10px;">
      <i class="fa-solid fa-user-slash"></i> ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    </h3>

    <p style="margin: 18px 0 25px; color: #555; font-size: 0.95em;">
      ‡πÇ‡∏õ‡∏£‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ
    </p>

    <div style="display: flex; flex-direction: column; gap: 16px;">
      <input id="deleteUser" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
      <input id="deletePass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
    </div>

    <div class="button-group" style="margin-top: 30px; display: flex; gap: 16px; justify-content: center;">
      <button onclick="deleteAccount()" style="
        padding: 12px 24px;
        background: #e63946;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#e63946'">
        ‚ùå ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ
      </button>
      <button onclick="closeDeleteBox()" style="
        padding: 12px 24px;
        background: #e2e8f0;
        color: #333;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#cbd5e1'" onmouseout="this.style.background='#e2e8f0'">
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </button>
    </div>

    <div id="deleteMsg" class="message" style="
      margin-top: 20px;
      font-weight: 500;
      color: #991b1b;
      display: none;
    "></div>
  </div>
</div>


<!-- Logout Confirmation Modal -->
<div id="logoutBox" class="modal-overlay" style="display: none;">
  <div class="modal-box">
    <h3>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</h3>
    <div class="modal-buttons">
      <button onclick="confirmLogout()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      <button onclick="closeLogoutBox()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>





<!-- ‚úÖ CONFIRM MODAL -->
<div id="confirmModal" class="confirm-backdrop" style="display:none;">
  <div class="confirm-box">
    <h3 id="confirmText">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</h3>
    <div class="button-group">
      <button onclick="confirmAction(true)">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      <button onclick="confirmAction(false)">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>






<!-- ‚úÖ DASHBOARD PAGE -->
<div id="dashboardPage" style="display: none; flex-direction: row; width: 100vw; height: 100vh;">

  <!-- Sidebar -->
  <div class="sidebar">
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="agrotech-logo.png" alt="Logo" class="sidebar-logo">
    </div>

    <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° data-page ‡πÅ‡∏•‡∏∞‡∏•‡∏ö class="active" ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å -->
    <a href="#" data-page="overview" class="active" onclick="showPage('overview', event)"><i class="fas fa-home"></i> Overview</a>
    <a href="#" data-page="lift" onclick="showPage('lift', event)"><i class="fas fa-arrow-up-wide-short"></i> Lift Control</a>
    <a href="#" data-page="agv" onclick="showPage('agv', event)"><i class="fas fa-truck-moving"></i> RGV Control</a>
    <a href="#" data-page="light-control" onclick="showPage('light-control', event)"><i class="fas fa-lightbulb"></i> light-control</a>
    <a href="#" data-page="tray-inbound" onclick="showPage('tray-inbound', event)"><i class="fas fa-arrow-down"></i> Tray Inbound</a>
    <a href="#" data-page="tray-outbound" onclick="showPage('tray-outbound', event)"><i class="fas fa-arrow-up"></i> Tray Outbound</a>
    <a href="#" data-page="workstation" onclick="showPage('workstation', event)"><i class="fas fa-dolly"></i> Workstation</a>
    <a href="#" data-page="tray-master" onclick="showPage('tray-master', event)"><i class="fas fa-database"></i> Tray Master</a>
    <a href="#" data-page="task" onclick="showPage('task', event)"><i class="fas fa-tasks"></i> Task Monitor</a>
    <a href="#" data-page="task-history" onclick="showPage('task-history', event)"><i class="fas fa-clipboard-list"></i> Task History</a>
    <a href="#" data-page="system" onclick="showPage('system', event)"><i class="fas fa-chart-line"></i> System Monitor</a>
    <a href="#" data-page="tray-map" onclick="showPage('tray-map', event)"><i class="fas fa-boxes"></i> Tray Inventory</a>
    <a href="#" data-page="environment" onclick="showPage('environment', event)"><i class="fas fa-chart-line"></i> Environmental</a>
    <a href="#" data-page="planting-plan" onclick="showPage('planting-plan', event)"><i class="fas fa-leaf"></i> Planting Plan</a>
    <a href="#" data-page="planting-history" onclick="showPage('planting-history', event)"><i class="fas fa-book"></i> Planting History</a>
    <a href="#" data-page="user-logs" onclick="showPage('user-logs', event)"><i class="fas fa-terminal"></i> User Activity Log</a>
   <a href="#" data-page="MonitorSensor" onclick="showPage('MonitorSensor', event)"><i class="fas fa-microchip"></i> MonitorSensor</a>

  </div>


  <!-- Main -->
<div class="main">
 <div class="header">

    <div style="display: flex; align-items: center; gap: 20px;">
      
<h1 class="premium-logo">
  <i data-lucide="leaf"></i> PFAL WMS Dashboard
</h1>



      
      <select id="stationSelect" onchange="onStationChange()" class="station-dropdown">
        <option value="1">Station 1</option>
        <option value="2">Station 2</option>
        <option value="3">Station 3</option>
        <option value="4">Station 4</option>
        <option value="5">Station 5</option>
      </select>
    </div>

    <div class="topbar">
      <div class="user-wrapper" id="userWrapper">
        <div class="user-menu" id="currentUser">
          <i class="fas fa-user" style="color:#40916c; margin-right: 6px;"></i> admin ‚è∑
        </div>
        <div class="user-dropdown" id="userDropdown">
          <div class="dropdown-item" id="toggleTheme">
            <i class="fas fa-moon"></i> <span>Dark Mode</span>
          </div>
          <div class="dropdown-item" onclick="showChangePassword()">
            <i class="fas fa-key"></i> <span>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</span>
          </div>
          <div class="dropdown-item" onclick="showDeleteBox()">
            <i class="fas fa-user-slash"></i> <span>‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
          </div>
          <div class="dropdown-item" onclick="showLogoutBox()">
            <i class="fas fa-sign-out-alt"></i> <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
          </div>
        </div>
      </div>
    </div>
    
</div>


  <!-- ‚úÖ Content Area for each page (loaded dynamically) -->
  <div class="content" id="mainContent"></div>
</div> <!-- ‚úÖ END of dashboardPage -->






<script>
let currentStation = 1; // üü¢ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ default

let currentPage = 'overview'; // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö showPage()
let pieChartInstance = null;
let barChartInstance = null;
let hourlyChartInstance = null;
let activeTimers = []; // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏Ç‡∏≠‡∏á Interval ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà

function clearActiveTimers() {
  activeTimers.forEach(timerId => clearInterval(timerId));
  activeTimers = []; // ‡∏•‡πâ‡∏≤‡∏á array ‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á
}

function renderOverviewPage() {
  const html = `
    <div>
      <h2 class="overview-title">
        <i class="fas fa-chart-line"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (Overview)
      </h2>

      <div class="summary-cards">
        <div class="summary-card">
          <div class="icon inbound"><i class="fas fa-arrow-down"></i></div>
          <div class="info">
            <div id="totalInbound" class="value">-</div>
            <div class="label">Inbound ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="icon outbound"><i class="fas fa-arrow-up"></i></div>
          <div class="info">
            <div id="totalOutbound" class="value">-</div>
            <div class="label">Outbound ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="icon total"><i class="fas fa-boxes-stacked"></i></div>
          <div class="info">
            <div id="totalTrays" class="value">-</div>
            <div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏≤‡∏î‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="icon ontime"><i class="fas fa-check-double"></i></div>
          <div class="info">
            <div id="onTimeTasks" class="value">- %</div>
            <div class="label">‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
          </div>
        </div>
      </div>
      
      <div class="overview-grid">
        <div class="overview-card">
          <h3><i class="fas fa-chart-pie"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
          <div id="pieChartContainer">
            <canvas id="pieChart"></canvas>
          </div>
        </div>
        <div class="overview-card">
          <h3><i class="fas fa-calendar-alt"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢ 7 ‡∏ß‡∏±‡∏ô</h3>
          <div class="chart-container">
            <canvas id="barChart"></canvas>
          </div>
        </div>
        <div class="overview-card">
          <h3><i class="fas fa-clock"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h3>
          <div class="chart-container">
            <canvas id="hourlyChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadFullOverviewData(currentStation); 
}





// ‚úÖ [‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà] ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Overview
async function loadFullOverviewData(stationId) {
  try {
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    loadOverviewCharts(stationId);

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Summary Cards
    const res = await fetch(`/api/overview/summary-cards?station=${stationId}`);
    if (!res.ok) throw new Error('Failed to fetch summary data');
    const data = await res.json();
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î
    document.getElementById('totalInbound').textContent = data.today_inbound || '0';
    document.getElementById('totalOutbound').textContent = data.today_outbound || '0';
    document.getElementById('totalTrays').textContent = data.total_trays || '0';
    document.getElementById('onTimeTasks').textContent = `${data.ontime_percentage || '100'} %`;

  } catch (err) {
    console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Overview ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ:", err);
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    document.getElementById('totalInbound').textContent = 'N/A';
    document.getElementById('totalOutbound').textContent = 'N/A';
    document.getElementById('totalTrays').textContent = 'N/A';
    document.getElementById('onTimeTasks').textContent = 'N/A';
  }
}



// ‚úÖ MOCK DATA ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
const trays = [
  { veg_type: "‡∏ú‡∏±‡∏Å‡∏ö‡∏∏‡πâ‡∏á", floor: 2, slot: 3, start_date: "2025-05-10", harvest_date: "2025-05-20" },
  { veg_type: "‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤", floor: 3, slot: 5, start_date: "2025-05-12", harvest_date: "2025-05-24" },
  { veg_type: "‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ", floor: 4, slot: 6, start_date: "2025-05-01", harvest_date: "2025-05-20" },
  { veg_type: "‡∏ö‡∏±‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏Æ‡∏î", floor: 5, slot: 7, start_date: "2025-05-15", harvest_date: "2025-05-26" },
  { veg_type: "‡∏ú‡∏±‡∏Å‡∏ä‡∏µ", floor: 6, slot: 8, start_date: "2025-05-16", harvest_date: "2025-05-20" },
  { veg_type: "‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î", floor: 7, slot: 9, start_date: "2025-05-17", harvest_date: "2025-05-21" },
  { veg_type: "‡πÇ‡∏´‡∏£‡∏∞‡∏û‡∏≤", floor: 8, slot: 10, start_date: "2025-05-10", harvest_date: "2025-05-20" },
  { veg_type: "‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏≠‡πä‡∏Ñ", floor: 1, slot: 1, start_date: "2025-05-18", harvest_date: "2025-05-28" },
  { veg_type: "‡πÄ‡∏Ñ‡∏•", floor: 2, slot: 2, start_date: "2025-05-19", harvest_date: "2025-05-29" },
  { veg_type: "‡∏™‡∏•‡∏±‡∏î", floor: 3, slot: 3, start_date: "2025-05-20", harvest_date: "2025-05-30" },
  { veg_type: "‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ", floor: 4, slot: 4, start_date: "2025-05-20", harvest_date: "2025-05-20" }
];
const rowsPerPage = 10;








// ü•¶ Global variable ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
let trayInventory = {};
async function loadTrayInventory() {
  trayInventory = {}; // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Object ‡∏ß‡πà‡∏≤‡∏á
  try {
    const response = await fetch(`/api/tray-inventory?station=${currentStation}&t=${Date.now()}`);
    if (!response.ok) {
      console.error("Fetch tray inventory failed!");
      return;
    }
    const data = await response.json();
    const newInventory = {};
    data.forEach(tray => {
      const key = `${tray.floor}-${tray.slot}`;
      newInventory[key] = tray;
    });
    
    trayInventory = newInventory;
    console.log("‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Inventory ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Station:", currentStation);

  } catch (error) {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô loadTrayInventory:", error);
  }
}

// ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å "‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å" ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß
document.addEventListener('DOMContentLoaded', () => {
    // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô DOMContentLoaded ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...
    // ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ login
    const loggedIn = localStorage.getItem("loggedIn");
    if (loggedIn === "true") {
        // ...
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        loadTrayInventory();
    } else {
        // ...
    }
});


let currentUsername = null;  // üåü ‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à

//‡∏£‡∏≠ ip ‡∏à‡∏£‡∏¥‡∏á
const devices = {
  "ESP32-LIFT": { topic: "status/esp32/lift", lastSeen: 0, status: "offline" },
  "ESP32-AGV": { topic: "status/esp32/agv", lastSeen: 0, status: "offline" },
  "AGV-CAM1": { topic: "status/esp32/agvcam1", lastSeen: 0, status: "offline" },
  "AGV-CAM2": { topic: "status/esp32/agvcam2", lastSeen: 0, status: "offline" }
};


//  tabsidebar
function setActiveSidebar(page) {
  const links = document.querySelectorAll(".sidebar a");
  links.forEach(link => {
    const target = link.getAttribute("data-page");
    if (target === page) {
      link.classList.add("active");
    } else {
      link.classList.remove("active");
    }
  });
}




  

  function confirmTray() {
  const floorEl = document.getElementById("floorSelect");
  const slotEl = document.getElementById("slotSelect");
  const vegEl = document.getElementById("vegSelect");
  const msgEl = document.getElementById("trayMsg");

  if (!floorEl || !slotEl || !vegEl || !msgEl) {
    console.warn("‚ùå [confirmTray] Elements ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô DOM");
    return;
  }

  const floor = floorEl.value;
  const slot = slotEl.value;
  const veg = vegEl.value;

  msgEl.style.display = "none";
  msgEl.className = "message";

  if (!floor || !slot || !veg) {
    msgEl.textContent = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö";
    msgEl.classList.add("error");
    msgEl.style.display = "block";
    return;
  }

  const key = `${floor}-${slot}`;
  if (trayStatus[key]) {
    msgEl.textContent = `‚ùå ‡∏ä‡πà‡∏≠‡∏á ${slot} ‡∏ö‡∏ô‡∏ä‡∏±‡πâ‡∏ô ${floor} ‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!`;
    msgEl.classList.add("error");
  } else {
    msgEl.textContent = `‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏á \"${veg}\" ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô ${floor} ‡∏ä‡πà‡∏≠‡∏á ${slot} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`;
    msgEl.classList.add("success");
  }
  msgEl.style.display = "block";
}
/**
 * ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Pop-up ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ (Inbound/Outbound)
/**
 * ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™ .danger ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Icon ‡πÅ‡∏•‡∏∞ Button
 */
function showConfirmationPopup({ title, subtitle, icon, details, onConfirm }) {

  const isDanger = (icon === 'fa-dolly-flatbed');
  const confirmButtonClass = isDanger ? 'danger' : '';
  const iconClass = isDanger ? 'danger' : '';

  const popupHTML = `
    <div class="popup-overlay" id="confirmationPopup">
      <div class="popup-container">
        <div class="popup-header">
          <i class="fas ${icon} icon ${iconClass}"></i>
          <h2 class="popup-title">${title}</h2>
          <p class="popup-subtitle">${subtitle}</p>
        </div>
        <div class="popup-summary">
          ${details.map(item => `
            <div class="summary-item">
              <span class="label">${item.label}</span>
              <span class="value ${item.highlight ? 'highlight' : ''}">${item.value || '-'}</span>
            </div>
          `).join('')}
        </div>
        <div class="popup-actions">
          <button class="popup-button cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="popup-button confirm ${confirmButtonClass}">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', popupHTML);

  const popupElement = document.getElementById('confirmationPopup');
  const confirmBtn = popupElement.querySelector('.popup-button.confirm');
  const cancelBtn = popupElement.querySelector('.popup-button.cancel');

  const closePopup = () => {
    popupElement.remove();
  };

  confirmBtn.onclick = () => {
    onConfirm();
    closePopup();
  };

  cancelBtn.onclick = closePopup;
  popupElement.onclick = (e) => {
    if (e.target === popupElement) {
        closePopup();
    }
  };
}
// ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ slot ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
async function handleInbound() {
    const data = {
        floor: document.getElementById("inFloor").value,
        slot: document.getElementById("inSlot").value, // ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ "inSlot"
        veg_type: document.getElementById("inVeg").value,
        quantity: document.getElementById("inPlantQuantity").value,
        batch_id: document.getElementById("inBatchId").value,
        seeding_date: document.getElementById("inSeedingDate").value,
        notes: document.getElementById("inNotes").value,
        username: localStorage.getItem("username"),
        station: currentStation
    };

    if (!data.floor || !data.slot || !data.veg_type) {
        showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ä‡∏±‡πâ‡∏ô, ‡∏ä‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", false);
        return;
    }
  
    showConfirmationPopup({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà',
        subtitle: '‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        icon: 'fa-leaf',
        details: [
            { label: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', value: `‡∏ä‡∏±‡πâ‡∏ô ${data.floor} / ‡∏ä‡πà‡∏≠‡∏á ${data.slot}`, highlight: true },
            { label: '‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å', value: data.veg_type },
            { label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô', value: data.quantity },
            { label: 'Batch ID', value: data.batch_id },
            { label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î', value: data.seeding_date },
            { label: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', value: data.notes }
        ],
        onConfirm: async () => {
            try {
                const res = await fetch("/api/tray/inbound", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                if (result.error) {
                   showToast(`‚ùå ${result.error}`, false);
                } else {
                   showToast(`‚úÖ ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡πÅ‡∏•‡πâ‡∏ß...`, true);
                   refreshDataAndViews();
                }
            } catch (error) {
                console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î:", error);
                showToast("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", false);
            }
        }
    });
}
// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LIFO
async function handleOutbound() {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô validateOutboundFloor() ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!selectedOutboundTray) {
        showToast("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô", false);
        return;
    }

    const data = {
        floor: selectedOutboundTray.floor, // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ
        slot: selectedOutboundTray.slot,   // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ
        reason: document.getElementById("outReason").value,
        destination: document.getElementById("outDestination").value,
        username: localStorage.getItem("username"),
        station: currentStation
    };
    
    showConfirmationPopup({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å',
        subtitle: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤',
        icon: 'fa-dolly-flatbed', // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô
        details: [
            { label: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', value: `‡∏ä‡∏±‡πâ‡∏ô ${data.floor} / ‡∏ä‡πà‡∏≠‡∏á ${data.slot}`, highlight: true },
            { label: '‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å', value: selectedOutboundTray.veg_type },
            { label: '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•', value: data.reason },
            { label: '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á', value: data.destination }
        ],
        onConfirm: async () => {
            try {
                const res = await fetch("/api/tray/outbound", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                if (result.error) {
                    showToast(`‚ùå ${result.error}`, false);
                } else {
                    showToast(`‚úÖ ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß...`, true);
                    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    refreshDataAndViews();
                }
            } catch (error) {
                console.error("‚ùå ‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
                showToast("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", false);
            }
        }
    }); 
}
function checkOutboundSlot() {
  const floor = document.getElementById("outFloor").value;
  const slot = document.getElementById("outSlot").value;
  const key = `${floor}-${slot}`;

  // ‡∏î‡∏∂‡∏á element ‡∏ï‡πà‡∏≤‡∏á‡πÜ
  const validationBox = document.getElementById("outboundValidationBox");
  const detailsPreview = document.getElementById("trayDetailsPreview");
  const warning = document.getElementById("outboundWarning");
  const reasonSelect = document.getElementById("outReason");
  const destinationInput = document.getElementById("outDestination");
  const confirmBtn = document.getElementById("outboundConfirmBtn");

  const trayInfo = trayInventory[key];

  validationBox.style.display = "block"; // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏°‡∏≠

  if (trayInfo) {
    // ---- ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏à‡∏≠‡∏ñ‡∏≤‡∏î ----
    validationBox.classList.add("success");
    validationBox.classList.remove("warning");

    // ‚úÖ‚úÖ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY ‚úÖ‚úÖ‚úÖ
    const formattedDate = new Date(trayInfo.time_in).toLocaleDateString('th-TH', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric' // ‡πÉ‡∏ä‡πâ 'numeric' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏õ‡∏µ ‡∏Ñ.‡∏®.
    });

    detailsPreview.innerHTML = `<i class="fas fa-check-circle"></i> ‡∏û‡∏ö‡∏ñ‡∏≤‡∏î: ${trayInfo.veg_type} | ‡∏ß‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formattedDate}`;
    detailsPreview.style.display = "block";
    warning.style.display = "none";

    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    reasonSelect.disabled = false;
    destinationInput.disabled = false;
    confirmBtn.disabled = false;

  } else {
    // ---- ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ñ‡∏≤‡∏î (‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á) ----
    validationBox.classList.add("warning");
    validationBox.classList.remove("success");

    warning.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ñ‡∏≤‡∏î‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà`;
    warning.style.display = "block";
    detailsPreview.style.display = "none";

    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    reasonSelect.disabled = true;
    destinationInput.disabled = true;
    confirmBtn.disabled = true;
  }
}

function renderTrayManagement() {
  const html = `
    <div class="section" style="padding: 30px;">
      <h2 style="font-size: 1.8em; color: #1b4332; margin-bottom: 30px;">
        üß∫ Tray Management
      </h2>
      <div style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: space-between;">
        ${renderInboundSection()}
        ${renderOutboundSection()}
      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadTrayInventory(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    const trayTimer = setInterval(loadTrayInventory, 5000); // ‡πÄ‡∏£‡∏¥‡πà‡∏° polling
    activeTimers.push(trayTimer); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Timer ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
}

function renderInboundPage() {
  return `
    <div class="form-container-deluxe">
      <div class="form-header">
          <h2 class="form-title">
            <i class="fas fa-seedling"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ñ‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà (Inbound)
          </h2>
          <p class="form-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ñ‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
      </div>

      <div class="form-grid">
        <div class="form-group">
            <label for="inFloor"><i class="fas fa-layer-group"></i> ‡∏ä‡∏±‡πâ‡∏ô</label>
            <select id="inFloor" class="form-input-deluxe">
                ${[...Array(8)].map((_, i) => `<option value="${i + 1}">‡∏ä‡∏±‡πâ‡∏ô ${i + 1}</option>`).join('')}
            </select>
        </div>

        <div class="form-group">
            <label for="inSlot"><i class="fas fa-th-large"></i> ‡∏ä‡πà‡∏≠‡∏á</label>
            <select id="inSlot" class="form-input-deluxe">
                ${[...Array(18)].map((_, i) => `<option value="${i + 1}">‡∏ä‡πà‡∏≠‡∏á ${i + 1}</option>`).join('')}
            </select>
        </div>

        <div class="form-group">
            <label for="inVeg"><i class="fas fa-seedling"></i> ‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</label>
            <select id="inVeg" class="form-input-deluxe">
                <option>Baby Kale</option><option>Baby Spinach</option><option>Baby Red Oak</option>
                <option>Baby Rocket</option><option>Baby Swiss Chard</option><option>‡∏ö‡∏±‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏Æ‡∏î</option>
                <option>‡∏ã‡∏≤‡∏•‡∏≤‡πÇ‡∏ô‡∏ß‡∏≤</option><option>‡∏Å‡∏£‡∏µ‡∏ô‡∏Ñ‡∏≠‡∏™</option><option>‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏≠‡πä‡∏Ñ</option>
                <option>‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏≠‡∏•</option><option>‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ</option><option>‡πÄ‡∏£‡∏î‡πÇ‡∏Ñ‡∏£‡∏≠‡∏•</option>
                <option>‡∏ü‡∏¥‡∏•‡πÑ‡∏≠‡∏ã‡πå</option><option>‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏•</option><option>‡πÄ‡∏Ñ‡∏•</option>
                <option>‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏≠‡πã</option><option>‡∏™‡∏ß‡∏¥‡∏™‡∏ä‡∏≤‡∏£‡πå‡∏î</option>
            </select>
        </div>

        <div class="form-group">
            <label for="inPlantQuantity"><i class="fas fa-sort-numeric-up"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô</label>
            <input type="number" id="inPlantQuantity" class="form-input-deluxe" placeholder="‡πÄ‡∏ä‡πà‡∏ô 16">
        </div>

        <div class="form-group">
            <label for="inBatchId"><i class="fas fa-tag"></i> ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (Batch ID)</label>
            <input type="text" id="inBatchId" class="form-input-deluxe" placeholder="‡πÄ‡∏ä‡πà‡∏ô BK-020725-A">
        </div>

        <div class="form-group">
            <label for="inSeedingDate"><i class="fas fa-calendar-check"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î</label>
            <input type="date" id="inSeedingDate" class="form-input-deluxe">
        </div>

        <div class="form-group full-width">
            <label for="inNotes"><i class="fas fa-edit"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <textarea id="inNotes" class="form-input-deluxe" rows="4" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
        </div>
      </div>

      <button class="form-button-action" onclick="handleInbound()">
          <i class="fas fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î
      </button>
    </div>
  `;
}
// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏´‡∏ô‡πâ‡∏≤ Outbound ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏±‡πâ‡∏ô
function renderOutboundPage() {
  return `
    <div class="form-container-deluxe">
      <div class="form-header">
        <h2 class="form-title">
          <i class="fas fa-dolly-flatbed" style="color: #e63946;"></i>
          ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å (Outbound)
        </h2>
        <p class="form-subtitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ä‡∏±‡πâ‡∏ô" ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
      </div>

      <div class="form-grid" style="grid-template-columns: 1fr;">
        <div class="form-group">
            <label for="outFloor"><i class="fas fa-layer-group"></i> <strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô (Lane)</strong></label>
            <select id="outFloor" class="form-input-deluxe" onchange="validateOutboundFloor()">
                <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô --</option>
                ${[...Array(9)].map((_, i) => `<option value="${i + 1}">‡∏ä‡∏±‡πâ‡∏ô ${i + 1}</option>`).join('')}
            </select>
        </div>

        <div id="outboundValidationBox" class="form-group full-width" style="display: none;">
             </div>

        <div class="form-group">
            <label for="outReason"><i class="fas fa-question-circle"></i> ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å</label>
            <select id="outReason" class="form-input-deluxe" disabled>
                <option>‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á / ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô</option>
                <option>‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤</option>
                <option>‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á</option>
                <option>‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡∏≤‡∏î</option>
            </select>
        </div>
        <div class="form-group">
            <label for="outDestination"><i class="fas fa-map-marked-alt"></i> ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
            <input type="text" id="outDestination" class="form-input-deluxe" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏•‡πâ‡∏≤‡∏á, ‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏û‡πá‡∏Ñ" disabled>
        </div>
      </div>

      <button id="outboundConfirmBtn" class="form-button-action danger" onclick="handleOutbound()" disabled>
          <i class="fas fa-cogs"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô
      </button>
    </div>
  `;
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á select box ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏´‡∏£‡∏π
function createSelectBox(label, id, options) {
  return `
    <div>
      <label style="font-weight: 600; color: #444; display: block; margin-bottom: 8px;">${label}</label>
      <select id="${id}" style="
        width: 100%;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid rgba(0,0,0,0.08);
        background: rgba(255, 255, 255, 0.9);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        font-size: 1em;
        transition: border 0.2s;
      " onfocus="this.style.border='1px solid #4ade80'" onblur="this.style.border='1px solid rgba(0,0,0,0.08)'">
        ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
      </select>
    </div>
  `;
}
function renderTrayMasterPage() {
  const html = `
    <div class="card">
      <h2><i class="fas fa-database"></i> Tray Master - ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
      
      <div class="user-logs-filters" style="justify-content: flex-start; gap: 16px;">
        
        <div>
          <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</label>
          <input type="text" id="traySearchInput" placeholder="Tray ID, Batch ID, ‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å..." oninput="loadTrayMasterData()">
        </div>

        <div>
          <label>‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          <select id="trayStatusFilter" onchange="loadTrayMasterData()">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="on_shelf">‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</option>
            <option value="AT_WORKSTATION">‡∏ó‡∏µ‡πà Workstation</option>
          </select>
        </div>

        <div>
          <label>‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</label>
          <select id="trayVegFilter" onchange="loadTrayMasterData()">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option>Baby Kale</option><option>Baby Spinach</option><option>Baby Red Oak</option>
            <option>Baby Rocket</option><option>Baby Swiss Chard</option><option>‡∏ö‡∏±‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏Æ‡∏î</option>
            <option>‡∏™‡∏•‡∏±‡∏î‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ</option><option>‡∏ã‡∏≤‡∏•‡∏≤‡πÇ‡∏ô‡∏ß‡∏≤</option><option>‡∏Å‡∏£‡∏µ‡∏ô‡∏Ñ‡∏≠‡∏™</option><option>‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏≠‡πä‡∏Ñ</option>
            <option>‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏≠‡∏•</option><option>‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ</option><option>‡πÄ‡∏£‡∏î‡πÇ‡∏Ñ‡∏£‡∏≠‡∏•</option>
            <option>‡∏ü‡∏¥‡∏•‡πÑ‡∏≠‡∏ã‡πå</option><option>‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏•</option><option>‡πÄ‡∏Ñ‡∏•</option>
            <option>‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏≠‡πã</option><option>‡∏™‡∏ß‡∏¥‡∏™‡∏ä‡∏≤‡∏£‡πå‡∏î</option>
          </select>
        </div>
      </div>

      <div style="overflow-x:auto;">
          <table class="styled-table">
              <thead>
                  <tr>
                      <th>Tray ID</th>
                      <th>Batch ID</th>
                      <th>‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</th>
                      <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞</th>
                      <th>‡∏≠‡∏≤‡∏¢‡∏∏</th>
                      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                      <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                      <th>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</th>
                  </tr>
              </thead>
              <tbody id="trayMasterTableBody"></tbody>
          </table>
      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
}

function renderWorkstationPage() {
  const html = `
    <div class="card">
      <h2 style="display: flex; align-items: center; gap: 12px;">
        <i class="fas fa-dolly"></i> Workstation - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏î
      </h2>
      
      <div id="workstationDisplay">
          </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;

  
}
// ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÅ‡∏•‡∏∞ scroll ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤ Login ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
function showLoginPage() {
  const container = document.querySelector('.login-container');
  if (container) {
    container.style.height = 'auto';
    container.scrollIntoView({ behavior: 'smooth' });
  }
}

function renderTrayGridView() {
  return `
    <div class="section">
      
      <h2 style="display: flex; align-items: center; gap: 14px; margin-bottom: 20px; color: #1b4332; font-weight: 600;">
        <i class="fas fa-boxes-stacked" style="font-size: 1.6em; color: #8d6e63; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); transform: translateY(-2px);"></i>
        <span>‡∏Ñ‡∏•‡∏±‡∏á‡∏ñ‡∏≤‡∏î - Tray Inventory</span>
      </h2>

      <div style="overflow-x: auto;">
        <div class="tray-grid" style="display: grid; grid-template-columns: auto repeat(18, 1fr); gap: 12px; padding: 20px;">
          ${generateTrayGridHTML()}
        </div>
      </div>
    </div>
  `;
}
// ‚úÖ [Polished & Animated Edition] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á Tray Inventory
function generateTrayGridHTML() {
  let html = "";
  const totalFloors = 8;
  const totalSlots = 18;

  // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ---
  html += `<div class="tray-header-cell"></div>`; 
  for (let slot = 1; slot <= totalSlots; slot++) {
    html += `<div class="tray-header-cell">‡∏ä‡πà‡∏≠‡∏á ${slot}</div>`;
  }

  // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
  for (let floor = totalFloors; floor >= 1; floor--) {
    html += `<div class="tray-header-cell">‡∏ä‡∏±‡πâ‡∏ô ${floor}</div>`;

    for (let slot = 1; slot <= totalSlots; slot++) {
      const key = `${floor}-${slot}`;
      const info = trayInventory[key];
      const isFilled = info && (info.status === 'on_shelf' || info.status === 'IN_STORAGE');
      
      const title = isFilled 
        ? `${info.veg_type} (ID: ${info.tray_id})\n‡∏ß‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(info.time_in).toLocaleString("th-TH")}` 
        : `‡∏ß‡πà‡∏≤‡∏á`;

      const onclickAction = isFilled 
        ? `showTrayInfoPopup({ 
             trayId: '${info.tray_id}', 
             username: '${info.username}', 
             veg: '${info.veg_type}', 
             floor: ${floor}, 
             slot: ${slot}, 
             timestamp: '${new Date(info.time_in).toLocaleString("th-TH")}', 
             age: calculateTrayAge('${info.time_in}') 
           })`
        : '';
      
      let cellContent = '';
      if (isFilled) {
        // ‚úÖ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ñ‡∏≤‡∏î (‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà)
        cellContent = `
          <div class="filled-tray-icon"><i class="fas fa-leaf"></i></div>
          <div class="filled-tray-veg-name">${info.veg_type.substring(0, 12)}</div>
          <div class="filled-tray-id">${info.tray_id}</div>
        `;
      } else {
        // ‚úÖ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
        cellContent = `<span class="empty-slot-coords">‡∏ä‡∏±‡πâ‡∏ô ${floor} / ${slot}</span>`;
      }

      html += `
        <div class="tray-slot ${isFilled ? 'filled' : 'empty'}"
             title="${title}"
             onclick="${onclickAction}">
          ${cellContent}
        </div>`;
    }
  }
  return html;
}
// ‚úÖ‚úÖ‚úÖ [FINAL VERSION] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤" ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Polling ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚úÖ‚úÖ‚úÖ
let trayInventoryInterval = null; // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÑ‡∏ß‡πâ‡∏ô‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
function showPage(page) {
  currentPage = page;
  clearActiveTimers(); // ‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ‡∏•‡πâ‡∏≤‡∏á Timer ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  setActiveSidebar(page);

  const mainContent = document.getElementById("mainContent");
  mainContent.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
if (page === 'tray-map') {
    // 1. ‡∏ß‡∏≤‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ "‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß"
    const initialHTML = `
        <div class="section">
          <h2 style="display: flex; align-items: center; gap: 14px; margin-bottom: 20px; color: #1b4332; font-weight: 600;">
            <i class="fas fa-boxes-stacked" style="font-size: 1.6em; color: #8d6e63; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); transform: translateY(-2px);"></i>
            <span>‡∏Ñ‡∏•‡∏±‡∏á‡∏ñ‡∏≤‡∏î - Tray Inventory</span>
          </h2>
          <div style="overflow-x: auto;">
            <div class="tray-grid" style="display: grid; grid-template-columns: auto repeat(18, 1fr); gap: 12px; padding: 20px;">
              <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                  <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
              </div>
            </div>
          </div>
        </div>
    `;
    mainContent.innerHTML = initialHTML;

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á"
    const refreshGridOnly = () => {
        loadTrayInventory().then(() => {
            const gridContainer = document.querySelector(".tray-grid");
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ element '.tray-grid' ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
            if (gridContainer && currentPage === 'tray-map') {
                gridContainer.innerHTML = generateTrayGridHTML(); // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            }
        });
    };

    // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤
    refreshGridOnly();
    const trayTimer = setInterval(refreshGridOnly, 5000); // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    activeTimers.push(trayTimer);

    return;
}


if (page === 'light-control') {
    renderLightControlPage(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏ü
    return;
  }
  
function renderLightControlPage() {
  const html = `
    <style>
      /* --- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏ü‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ --- */
      .light-control-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 30px;
        margin-top: 20px;
      }

      .control-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 18px 0;
        border-bottom: 1px solid var(--card-border);
      }
      .overview-card .control-row:last-of-type {
        border-bottom: none;
      }

      .control-label {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 1.1em;
        font-weight: 600;
        color: var(--text-dark);
      }
      .control-label i {
        font-size: 1.5em;
        width: 30px;
        text-align: center;
      }
      .control-label .fa-lightbulb.red { color: #e53935; }
      .control-label .fa-lightbulb.white { color: #fdd835; }
      .control-label .fa-fan { color: #3b82f6; }
      
      .status-count {
        font-size: 0.9em;
        color: var(--text-light);
        font-weight: 500;
        background-color: #f8fafc;
        padding: 4px 12px;
        border-radius: 8px;
        margin-left: 8px;
      }

      .control-actions {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .dimmer-slider {
        -webkit-appearance: none;
        appearance: none;
        width: 120px;
        height: 8px;
        background: #e2e8f0;
        border-radius: 5px;
        outline: none;
        transition: opacity .2s;
      }
      .dimmer-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: var(--primary-light);
        cursor: pointer;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      .dimmer-value {
        font-weight: 600;
        width: 50px;
        text-align: right;
        color: var(--primary-dark);
      }

      .details-btn {
        margin-top: 20px; width: 100%; padding: 12px;
        font-size: 1em; font-weight: 600; color: var(--primary-dark);
        background-color: #e9f5ec; border: 1px solid var(--primary-light);
        border-radius: 12px; cursor: pointer; transition: all 0.2s ease;
      }
      .details-btn:hover { background-color: var(--primary-light); color: white; }
      
      .individual-controls {
        display: none;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 15px; padding-top: 20px; margin-top: 15px;
        border-top: 1px solid var(--card-border);
      }
    </style>

    <h2 class="overview-title">
      <i class="fas fa-lightbulb"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏ü‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏î‡∏•‡∏°
    </h2>

    <div class="overview-card" style="margin-bottom: 30px;">
        <h3><i class="fas fa-cogs"></i> ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Global Control)</h3>
        <p class="form-subtitle" style="text-align: left; margin-top: -20px; margin-bottom: 20px;">‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>
        <div class="control-row">
            <div class="control-label"><i class="fas fa-power-off" style="color: #e53935;"></i><strong>‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</strong></div>
            <button class="form-button-action danger" style="margin:0; padding: 12px 24px; width: auto;" onclick="alert('‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!')">
                <i class="fas fa-exclamation-triangle"></i> EMERGENCY OFF
            </button>
        </div>
    </div>

    <div class="light-control-grid">
      ${Array.from({ length: 7 }, (_, i) => `
      <div class="overview-card" style="animation-delay: ${0.2 + i * 0.05}s;">
        <h3><i class="fas fa-layer-group"></i> ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà ${i + 1}</h3>

        <div class="control-row">
            <div class="control-label">
                <i class="fas fa-lightbulb red"></i> ‡πÑ‡∏ü‡∏™‡∏µ‡πÅ‡∏î‡∏á <span class="status-count">0/18</span>
            </div>
            <div class="control-actions">
              <span class="dimmer-value">50%</span>
              <input type="range" min="0" max="100" value="50" class="dimmer-slider" oninput="this.previousElementSibling.textContent = this.value + '%'">
            </div>
        </div>
        
        <div class="control-row">
            <div class="control-label">
                <i class="fas fa-lightbulb white"></i> ‡πÑ‡∏ü‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß <span class="status-count">0/18</span>
            </div>
            <div class="control-actions">
              <span class="dimmer-value">75%</span>
              <input type="range" min="0" max="100" value="75" class="dimmer-slider" oninput="this.previousElementSibling.textContent = this.value + '%'">
            </div>
        </div>

        <div class="control-row">
            <div class="control-label">
                <i class="fas fa-fan"></i> ‡∏û‡∏±‡∏î‡∏•‡∏° <span class="status-count">0/18</span>
            </div>
            <div class="control-actions">
                <button class="action-btn history" style="background-color: #3b82f6;" onclick="alert('‡πÄ‡∏õ‡∏¥‡∏î‡∏û‡∏±‡∏î‡∏•‡∏°‡∏ä‡∏±‡πâ‡∏ô ${i+1}')"><i class="fas fa-play"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="action-btn" style="background-color: #6b7280;" onclick="alert('‡∏õ‡∏¥‡∏î‡∏û‡∏±‡∏î‡∏•‡∏°‡∏ä‡∏±‡πâ‡∏ô ${i+1}')"><i class="fas fa-stop"></i> ‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
        </div>

        <button class="details-btn" onclick="alert('‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô ${i+1}')">
            <i class="fas fa-clock"></i> ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î
        </button>
      </div>
      `).join('')}
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
}
    if (page === 'tray-master') {
    renderTrayMasterPage();
    loadTrayMasterData();
    activeTimers.push(trayMasterTimer);
    return;
}

if (page === 'workstation') {
    renderWorkstationPage(); 

    currentWorkstationState = null; // ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ] ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡πà‡∏≤

    checkWorkstationStatus(); 
    const workstationTimer = setInterval(checkWorkstationStatus, 3000);
    activeTimers.push(workstationTimer);

    return;
}
if (page === 'overview') {
  requestAnimationFrame(() => renderOverviewPage()); // ‚úÖ ‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏ß‡πà‡∏≤ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°
  return;
}


  if (page === 'tray-inbound') {
    html = renderInboundPage();
    document.getElementById("mainContent").innerHTML = html;
    return;
  }

  if (page === 'tray-outbound') {
    // ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö Outbound ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
    mainContent.innerHTML = renderOutboundPage();

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
    loadTrayInventory().then(() => {
      checkOutboundSlot(); 
    });

    const outboundTimer = setInterval(() => {
      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
      loadTrayInventory().then(() => {
        if (currentPage === 'tray-outbound') {
          checkOutboundSlot();
        }
      });
    }, 5000); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

    activeTimers.push(outboundTimer);
    return;
  }

if (page === 'task') {
  renderTaskPage(); // ‡∏ß‡∏≤‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ Task Monitor
  
  // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
  loadTaskMonitor(); 
  
  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£ Polling ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
  const taskTimer = setInterval(loadTaskMonitor, 2000); 
  activeTimers.push(taskTimer); 

  return;
}
function renderTaskPage() {
  const html = `
    <div class="card">
      <h2><i class="fas fa-tasks"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h2>
      <table class="styled-table">
        <thead>
          <tr>
            <th>‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô</th>
            <th>‡∏ä‡∏±‡πâ‡∏ô</th>
            <th>‡∏ä‡πà‡∏≠‡∏á</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
            <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th>
            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
            <th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
            <th>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</th>
          </tr>
        </thead>
        <tbody id="taskTableBody"></tbody>
      </table>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
 loadTaskMonitor();
 //const taskTimer = setInterval(loadTaskMonitor, 2000);
   // activeTimers.push(taskTimer); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Timer ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
}

if (page === 'task-history') {
  renderTaskHistoryPage();
  return;
}
function renderTaskHistoryPage() {
  const html = `
    <div class="card">
      <h2><i class="fas fa-clipboard-list"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h2>
      <table class="styled-table">
        <thead>
          <tr>
            <th>‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô</th>
            <th>‡∏ä‡∏±‡πâ‡∏ô</th>
            <th>‡∏ä‡πà‡∏≠‡∏á</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
            <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th>
            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
            <th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
          </tr>
        </thead>
        <tbody id="taskHistoryTableBody"></tbody>
      </table>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadTaskHistory(); // ‡πÉ‡∏ä‡πâ mock data ‡∏´‡∏£‡∏∑‡∏≠ fetch API ‡∏à‡∏£‡∏¥‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
}




  if (page === 'tray') {
    renderTrayManagement();
    return;
  }
if (page === 'lift') {
  const currentFloor = parseInt(localStorage.getItem('currentFloor')) || 1;

  html = `

<div id="liftStatusBox" class="lift-status success">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="margin-right: 12px;">
    <circle cx="12" cy="12" r="10" fill="#2dcc6f"/>
    <path d="M9 12.5l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
</div>




<div id="liftToast" style="position: fixed; top: 20px; right: 20px; background: #333; color: white; padding: 12px 20px; border-radius: 8px; font-weight: bold; z-index: 9999; display: none;">
  <span id="liftToastMessage"></span>
</div>


    <div class="section">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
        <i class="fas fa-elevator" style="font-size: 1.8rem; color: #2d6a4f;"></i>
        <h2 style="margin: 0; font-size: 1.8rem; font-weight: 600; color: #1b4332;">Lift Control</h2>
      </div>

      <div style="display: flex; align-items: flex-start; gap: 40px; max-width: 1100px; margin: auto;">

        <!-- üî≤ ‡∏£‡∏π‡∏õ‡∏•‡∏¥‡∏ü‡∏ï‡πå -->
        <div style="position: relative; width: 260px; height: 600px; border-radius: 12px; overflow: hidden;">
          <img src="lift_9levels.png.jpg" alt="Lift Structure"
               style="width: 100%; height: 100%; object-fit: contain;" />
          <img id="liftCart" src="lift_cart.png.png" alt="Lift Cart"
               style="position: absolute; left: 50%; transform: translateX(-50%);
                      width: 86%; transition: top 0.05s linear; z-index: 10;" />
        </div>

        <!-- üî¢ LEVEL INDICATOR -->
        <div style="height: 600px; display: flex; flex-direction: column; justify-content: space-around;
                    background: #e6f4ea; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <h4 style="text-align:center; margin-bottom: 12px; color: #2d6a4f;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏¥‡∏ü‡∏ï‡πå<br>(LEVEL)</h4>
          ${[...Array(9)].map((_, i) => {
            const level = 8 - i;
            return `<div id="floor-${level}" style="margin: 6px 0; display: flex; align-items: center;">
                      <span data-light style="display:inline-block; width: 16px; height: 16px; border-radius: 50%; 
                           background: #ccc; margin-right: 8px; transition: all 0.3s;"></span>
                      <span style="color: #2d6a4f; font-weight: 600;">‡∏ä‡∏±‡πâ‡∏ô ${level}</span>
                    </div>`;
          }).join('')}
        </div>

        <!-- üîò ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
        <div style="min-width: 180px;">
          <div id="currentFloorDisplay"
            style="margin-bottom: 16px; padding: 12px; background: #d8f3dc; color: #1b4332;
                   border: 2px solid #52b788; border-radius: 12px; font-size: 1.1rem; font-weight: bold;
                   text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
            ‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô: <span id="currentFloor">${currentFloor}</span>
          </div>

          <label for="floorSelect" style="font-weight: bold;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô:</label>
          <select id="floorSelect" style="padding: 8px; width: 100%; margin: 10px 0;">
            ${[...Array(8)].map((_, i) => `<option value="${i + 1}">‡∏ä‡∏±‡πâ‡∏ô ${i + 1}</option>`).join('')}
          </select>
          <button onclick="moveLift()" 
            style="padding: 10px 20px; background: #2d6a4f; color: white; border: none; border-radius: 6px; width: 100%; cursor: pointer;">
            ‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏¥‡∏ü‡∏ï‡πå
          </button>

          <div style="margin-top: 20px; padding: 16px; background: #f0fdf4; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <h4 style="color: #1b4332; margin-bottom: 16px;">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏ö‡∏ö Manual</h4>
            <button class="manual-btn"
              onmousedown="startLiftMove('up')"
              onmouseup="stopLiftMove()"
              onmouseleave="stopLiftMove()">
              <i class="fas fa-arrow-up"></i> ‡∏Ç‡∏∂‡πâ‡∏ô
            </button>
            <button class="manual-btn"
              onmousedown="startLiftMove('down')"
              onmouseup="stopLiftMove()"
              onmouseleave="stopLiftMove()">
              <i class="fas fa-arrow-down"></i> ‡∏•‡∏á
            </button>
             <!-- ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á EMERGENCY ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á Manual -->
<div style="margin-top: 20px; padding: 16px; background: #fff5f5;
            border-radius: 16px; width: 220px; text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #f5c2c7;">
  <h4 style="color: #c1121f; margin-bottom: 16px;">‡∏õ‡∏∏‡πà‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (EMERGENCY)</h4>
  <button id="emButton" onclick="toggleEmergency()"
    style="padding: 12px 20px; font-weight: bold; border: none; border-radius: 8px;
           background: #c1121f; color: white; font-size: 1rem; width: 100%; cursor: pointer;">
    ‚õî ‡∏´‡∏¢‡∏∏‡∏î‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  </button>
</div>
          </div>
        </div>
      </div>
    </div>
  `;

  document.getElementById("mainContent").innerHTML = html;

  // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
  initLiftPage();
    connectMqttLift();        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  return;
}
function connectMqttLift() {
  client.subscribe("automation/station1/lift/status", (err) => {
    if (err) {
      console.error("‚ùå MQTT subscribe failed:", err.message);
    } else {
      console.log("‚úÖ MQTT subscribed to automation/station1/lift/status");
    }
  });

  client.on("message", (topic, message) => {
    if (topic === "automation/station1/lift/status") {
      try {
        const data = JSON.parse(message.toString());
        currentLiftFloor = data.floor;
        isLiftMoving = data.moving;
        isEmergency = data.emergency || false;

        // ‚úÖ Sync UI
        updateLiftDisplay(currentLiftFloor);

        const floorDisplay = document.getElementById("currentFloor");
        if (floorDisplay) floorDisplay.innerText = currentLiftFloor;

        const movingStatus = document.getElementById("movingStatus");
        if (movingStatus) movingStatus.innerText = isLiftMoving ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà..." : "‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏¥‡πà‡∏á";

        const statusBox = document.getElementById("liftStatusBox");
        if (statusBox) {
          statusBox.innerText = isEmergency ? "üö® ‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥" : "üü¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥";
        }

      } catch (e) {
        console.error("MQTT parse error:", e);
      }
    }
  });
}
function renderAgvPage() {
  return `
    <div class="section">
      <h2><i class="fas fa-truck-moving"></i> RGV Control</h2>

      <!-- ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ AGV ‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° -->
      <div id="agvTaskStatus">
        <div class="agv-status-box" style="--boxColor: #0ea5e9;">
          <div class="agv-status-title">
            <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...
          </div>
          <div class="agv-status-desc">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö AGV
          </div>
        </div>
      </div>

      <!-- ‚úÖ Sensor Tags -->
      <div class="sensor-status" id="agvSensorStatus">
        <div class="sensor-tag" id="sensorTray">
          <i class="fas fa-eye"></i> ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ñ‡∏≤‡∏î: <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </div>
        <div class="sensor-tag" id="sensorPos1">
          <i class="fas fa-location-arrow"></i> ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á 1: <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </div>
        <div class="sensor-tag" id="sensorPos2">
          <i class="fas fa-location-arrow"></i> ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á 2: <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </div>
      </div>

      <!-- ‚úÖ ‡∏Å‡∏•‡πâ‡∏≠‡∏á RGV -->
      <h3><i class="fas fa-video"></i> ‡∏Å‡∏•‡πâ‡∏≠‡∏á RGV (Real-Time)</h3>
      <div class="camera-section">
        <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ RGV (‡∏´‡∏°‡∏∏‡∏ô‡∏ã‡πâ‡∏≤‡∏¢) -->
        <div class="camera-box">
          <img src="/api/camera/stream/CAM001" class="rotate-left" />
          <div class="camera-label">
            <i class="fas fa-video"></i> ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ RGV
          </div>
        </div>

        <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á RGV -->
        <div class="camera-box">
          <img src="/api/camera/stream/CAM002" class="camera-image" />
          <div class="camera-label">
            <i class="fas fa-video"></i> ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á RGV
          </div>
        </div>
      </div>

      <!-- ‚úÖ Manual AGV Control -->
      <h3 style="margin-top: 40px;"><i class="fas fa-tools"></i> Manual AGV Control (MQTT)</h3>
      <div class="main-buttons">
        <button class="btn-premium" onclick="sendAgvCommand('go_lift')">Manual ‡πÑ‡∏õ Lift</button>
        <button class="btn-premium" onclick="sendAgvCommand('go_home')">Manual ‡∏Å‡∏•‡∏±‡∏ö Home</button>
        <button class="btn-premium" onclick="sendTrayCommand('tray_up')">Manual ‡∏¢‡∏Å‡∏ñ‡∏≤‡∏î</button>
        <button class="btn-premium" onclick="sendTrayCommand('tray_down')">Manual ‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î</button>
      </div>

      <div class="dropdown" style="margin-top: 20px;">
        <label for="slotSelectManual"><strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (Manual)</strong></label><br/>
        <select id="slotSelectManual" class="dropdown-select">
          <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á</option>
          ${[...Array(17)].map((_, i) => `<option value="${i + 1}">‡∏ä‡πà‡∏≠‡∏á ${i + 1}</option>`).join('')}
        </select>
        <button class="btn-premium" onclick="handleSlotManual()">‡∏™‡πà‡∏á Manual Slot</button>
      </div>
    </div>
  `;
}
if (page === 'agv') {
  const html = renderAgvPage();
  document.getElementById("mainContent").innerHTML = html;
  const agvStatusEl = document.getElementById('agvTaskStatus');

  function renderPrettyStatus(status) {
    const match = status.match(/^(.*?)(_)?(\d+)?$/);
    const base = match?.[1] || status;
    const suffix = match?.[3] ? parseInt(match[3]) : null;

    switch (base) {
      // --- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ---
      case "idle":
        return { title: "‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Idle)", desc: "AGV ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà", color: "#6c757d", icon: "fas fa-pause-circle" };
      case "unknown":
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...", desc: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö AGV", color: "#0ea5e9", icon: "fas fa-satellite-dish" };
      case "flow_done":
      case "done": // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° case ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö flowState
        return { title: "‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå", desc: "AGV ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", color: "#28a745", icon: "fas fa-check-circle" };
      case "error":
        return { title: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", desc: "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö", color: "#dc3545", icon: "fas fa-exclamation-circle" };

      // --- ‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Flow State ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ---
      case "inbound_start_lift_tray":
      case "inbound_wait_for_tray_lift":
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡∏ñ‡∏≤‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô", desc: "‡∏£‡∏≠ AGV ‡∏¢‡∏Å‡∏ñ‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô Inbound", color: "#ffc107", icon: "fas fa-arrow-alt-circle-up" };
      case "start": // (Outbound)
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô Outbound", desc: `AGV ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${suffix || '...'}`, color: "#17a2b8", icon: "fas fa-route" };
      case "wait_agv_at_lift":
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠ AGV", desc: "‡∏£‡∏≠ AGV ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå", color: "#6610f2", icon: "fas fa-parking" };
      case "lift_moving_up":
        return { title: "‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏∂‡πâ‡∏ô", desc: "‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢", color: "#0dcaf0", icon: "fas fa-arrow-up" };
      case "wait_agv_at_slot":
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠ AGV", desc: `‡∏£‡∏≠ AGV ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${suffix || '...'}`, color: "#198754", icon: "fas fa-map-marker-alt" };
      case "wait_tray_action_done":
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏ñ‡∏≤‡∏î", desc: "‡∏£‡∏≠ AGV ‡∏¢‡∏Å/‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô", color: "#fd7e14", icon: "fas fa-cogs" };
      case "wait_agv_return_to_lift":
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠ AGV ‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏¥‡∏ü‡∏ï‡πå", desc: "‡∏£‡∏≠ AGV ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏ü‡∏ï‡πå", color: "#007bff", icon: "fas fa-undo-alt" };
      case "lift_moving_down":
        return { title: "‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á", desc: "‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡∏±‡πâ‡∏ô 2", color: "#0d6efd", icon: "fas fa-arrow-down" };
      case "wait_agv_home":
        return { title: "AGV ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ê‡∏≤‡∏ô", desc: "‡∏£‡∏≠ AGV ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô", color: "#6c757d", icon: "fas fa-home" };
      case "outbound_wait_for_final_place":
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡∏Ñ‡∏∑‡∏ô", desc: "‡∏£‡∏≠ AGV ‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Home ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö‡∏á‡∏≤‡∏ô Outbound", color: "#20c997", icon: "fas fa-box-open" };

      // --- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å AGV (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô Fallback) ---
      case "agv_moving_to_slot":
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö", desc: suffix ? `AGV ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${suffix}` : "AGV ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö", color: "#17a2b8", icon: "fas fa-route" };
      case "agv_arrived_at_slot":
        return { title: "‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß", desc: suffix ? `AGV ‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${suffix} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢` : "AGV ‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", color: "#198754", icon: "fas fa-boxes" };
      case "arrived_at_home":
        return { title: "‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß", desc: "AGV ‡∏Å‡∏•‡∏±‡∏ö‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ", color: "#28a745", icon: "fas fa-parking" };

      // --- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Default ---
      default:
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...", desc: `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${status}`, color: "#adb5bd", icon: "fas fa-spinner fa-spin" };
    }
  }

  async function fetchAgvStatus() {
    try {
      const res = await fetch(`/api/agv/status?_t=${new Date().getTime()}`);
      const data = await res.json();
      const rawStatus = data.status || 'unknown';
      const pretty = renderPrettyStatus(rawStatus);

      const isGlowingStatus = [
        'working', 'moving', 'processing', 'agv_moving_to_slot', 'agv_moving_to_lift', 'lift_moving_up', 'lift_moving_down',
        'pickup_tray', 'agv_returning_home', 'agv_returning_to_lift', 'wait_agv_at_lift', 'wait_agv_at_slot',
        'wait_tray_action_done', 'wait_agv_return_to_lift', 'wait_agv_home'
      ].includes(rawStatus.replace(/_\d+$/, ''));

      agvStatusEl.innerHTML = `
        <div class="agv-status-box ${isGlowingStatus ? 'glow' : ''}" style="--boxColor: ${pretty.color || '#999'}">
          <div class="agv-status-title">
            <i class="${pretty.icon || 'fas fa-question-circle'}"></i> ${pretty.title || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'}
          </div>
          <div class="agv-status-desc">${pretty.desc || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'}</div>
        </div>
      `;
    } catch (err) {
      agvStatusEl.innerHTML = `
        <div class="agv-status-box error">
          <div class="agv-status-title">
            <i class="fas fa-exclamation-triangle"></i> ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ
          </div>
          <div class="agv-status-desc"> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö AGV </div>
        </div>
      `;
      console.error('[AGV Status Error]', err);
    }
  }

  fetchAgvStatus();
  setInterval(fetchAgvStatus, 2000);

  return;
}



  if (page === 'system') {
    html = `
      <div class="section">
        <h2 style="margin-bottom: 20px; color:#2d6a4f;">üîß System Monitor</h2>
        <div id="systemStatus" style="display: flex; gap: 20px; flex-wrap: wrap;"></div>
      </div>
    `;
    document.getElementById("mainContent").innerHTML = html;
    return;
  }

  if (page === 'environment') {
    html = `
      <div class="section">
        <h2 style="color: #2d6a4f;">üìä Environmental Data (Real-Time)</h2>
        <canvas id="co2Chart" style="max-height: 300px;"></canvas>
        <canvas id="tempChart" style="max-height: 300px; margin-top: 30px;"></canvas>
        <canvas id="humidityChart" style="max-height: 300px; margin-top: 30px;"></canvas>
      </div>
    `;
    document.getElementById("mainContent").innerHTML = html;
    setupEnvironmentCharts();
    if (window.environmentInterval) clearInterval(window.environmentInterval);
    window.environmentInterval = setInterval(updateEnvironmentCharts, 5000);
    return;

  }if (page === 'planting-plan') {
  renderPlantingPlanPage();
  return;
}

function renderPlantingPlanPage() {
  const html = `
    <div class="card">
      <h2><i class="fas fa-seedling"></i> ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å</h2>
      <table class="styled-table">
        <thead>
          <tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏±‡∏Å</th>
            <th>‡∏ä‡∏±‡πâ‡∏ô</th>
            <th>‡∏ä‡πà‡∏≠‡∏á</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á</th>
            <th>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</th>
          </tr>
        </thead>
        <tbody id="realPlanTableBody"></tbody>
      </table>
      <div id="plantingPagination" class="pagination"></div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadRealPlanMock();
}

if (page === 'planting-history') {
  renderPlantingHistoryPage();
  return;
}

function renderPlantingHistoryPage() {
  const html = `
    <div class="card">
      <h2><i class="fas fa-book-open"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
      <table class="styled-table">
        <thead>
          <tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏±‡∏Å</th>
            <th>‡∏ä‡∏±‡πâ‡∏ô</th>
            <th>‡∏ä‡πà‡∏≠‡∏á</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á</th>
            <th>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
          </tr>
        </thead>
        <tbody id="plantingHistoryTableBody"></tbody>
      </table>
      <div id="historyPagination" class="pagination"></div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadPlantingHistoryMock(); // ‡πÉ‡∏ä‡πâ mock ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° SQL ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
}


if (page === 'user-logs') {
  renderUserLogsPage();
  return;
}
function renderUserLogsPage() {
  const html = `
    <div class="section">
      <h2><i class="fas fa-terminal"></i> ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (User Logs)</h2>
      <div class="user-logs-filters">
        <div><label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</label><input type="text" id="logSearchInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ / ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥ / ‡πÄ‡∏ß‡∏•‡∏≤"></div>
        <div>
          <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</label>
          <select id="logCategoryFilter">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</option><option value="‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î">‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î</option>
            <option value="‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å">‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å</option><option value="‡∏•‡∏¥‡∏ü‡∏ï‡πå">‡∏•‡∏¥‡∏ü‡∏ï‡πå</option><option value="AGV">AGV</option>
          </select>
        </div>
        <div><button onclick="exportLogsToExcelWithLogo()">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel</button></div>
      </div>
      <div id="logCardsContainer" class="log-cards-container"></div>
      <div id="pagination"></div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;

  // ‚úÖ ‡∏ú‡∏π‡∏Å Event Listener ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
  document.getElementById("logSearchInput").addEventListener("input", () => {
    logCurrentPage = 1;
    renderUserLogs(); 
  });
  document.getElementById("logCategoryFilter").addEventListener("change", () => {
    logCurrentPage = 1;
    renderUserLogs();
  });

  fetchUserLogs();
}



function renderMonitorSensorPage() {
  const html = `
    <div class="section">
      <h2><i class="fas fa-microchip"></i> Monitor Sensor</h2>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 60px; margin-top: 30px; align-items: start;">

        <!-- ‚úÖ LIFT ZONE -->
        <div>
          <h3><i class="fas fa-arrow-up"></i> Lift</h3>
          <div style="text-align:center; margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <img src="lift_9levels.png.jpg" alt="Lift Image"
  style="max-width: 100%; max-height: 350px; width: auto; height: auto; object-fit: contain; aspect-ratio: 3/4; border-radius: 12px;" />

          </div>
          <div class="sensor-group">
            <div class="sensor-item">Gripper Floor 1: <span id="gripper_f1" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Gripper Floor 2: <span id="gripper_f2" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Gripper Floor 3: <span id="gripper_f3" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Gripper Floor 4: <span id="gripper_f4" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Gripper Floor 5: <span id="gripper_f5" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Limit Top: <span id="limit_top" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Limit Bottom: <span id="limit_bottom" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Emergency: <span id="emergency_btn" class="sensor-status-indicator">OFF</span></div>
          </div>
        </div>

        <!-- ‚úÖ AGV ZONE -->
        <div>
          <h3><i class="fas fa-truck-moving"></i> AGV</h3>
          <div style="text-align:center; margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <img src="AGV.png" alt="AGV Image"
              style="max-width: 100%; max-height: 350px; width: auto; height: auto; object-fit: contain; aspect-ratio: 4/3; border-radius: 12px;" />
          </div>
          <div class="sensor-group">
            <div class="sensor-item">Tray Sensor: <span id="tray_sensor" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Position Sensor 1: <span id="pos_sensor1" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Position Sensor 2: <span id="pos_sensor2" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Limit AGV 1: <span id="limit_agv_1" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Limit AGV 2: <span id="limit_agv_2" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Power ON: <span id="agv_on" class="sensor-status-indicator">OFF</span></div>
          </div>
        </div>

      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
}



if (page === "MonitorSensor") {
  renderMonitorSensorPage();
    return;
}



  // fallback: ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ
  document.getElementById("mainContent").innerHTML = "<div class='section'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</div>";
}




    

  let confirmCallback = null;

  function showConfirmDialog(message, callback) {
    document.getElementById('confirmText').innerText = message;
    document.getElementById('confirmModal').style.display = 'flex';
    confirmCallback = callback;
  }

  function confirmAction(result) {
    document.getElementById('confirmModal').style.display = 'none';
    if (confirmCallback) confirmCallback(result);
  }
  function switchTab(tab) {
  document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
  if (tab === 'in') {
    document.getElementById("inboundTab").style.display = 'block';
    document.getElementById("outboundTab").style.display = 'none';
    document.querySelector(".tab-button:nth-child(1)").classList.add("active");
  } else {
    document.getElementById("inboundTab").style.display = 'none';
    document.getElementById("outboundTab").style.display = 'block';
    document.querySelector(".tab-button:nth-child(2)").classList.add("active");
  }
}

// ‚úÖ Login function ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
function login() {
  const userEl = document.querySelector('input#username');
  const passEl = document.querySelector('input#password');
  const msgEl = document.querySelector('#loginMsg');

  if (!userEl || !passEl || !msgEl) {
    console.warn("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö input ‡∏´‡∏£‡∏∑‡∏≠ div loginMsg ‡∏ö‡∏ô DOM");
    return;
  }

  const user = userEl.value.trim();
  const pass = passEl.value.trim();
  msgEl.textContent = '';
  msgEl.style.color = '';

  fetch("/api/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: user, password: pass })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      msgEl.style.color = '#dc2626';
      msgEl.textContent = `‚ùå ${data.error}`;
      msgEl.style.display = 'block';
    } else {
      // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö userId ‡πÅ‡∏•‡∏∞ username ‡∏•‡∏á localStorage
      localStorage.setItem("loggedIn", "true");
      localStorage.setItem("username", data.username);
      localStorage.setItem("userId", data.id);  // <-- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°

      document.getElementById("loginPage").style.display = "none";
      document.getElementById("dashboardPage").style.display = "flex";

      // ‚úÖ ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠ user ‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô
      document.getElementById("currentUser").innerHTML =
        `<i class="fas fa-user" style="color:#40916c; margin-right: 6px;"></i> ${data.username} ‚è∑`;

      showPage('overview');
      logAction(data.username, "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
    }
  })
  .catch(err => {
    console.error("‚ùå login error", err);
    msgEl.style.color = '#b91c1c';
    msgEl.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ';
  });
}



document.addEventListener("DOMContentLoaded", function () {
  const loggedIn = localStorage.getItem("loggedIn");
  const username = localStorage.getItem("username");

  if (loggedIn === "true" && username) {
    currentUsername = username;

    document.getElementById("loginPage").style.display = "none";
    document.getElementById("dashboardPage").style.display = "flex";

    document.getElementById("currentUser").innerHTML =
      `<i class="fas fa-user" style="color:#40916c; margin-right: 6px;"></i> ${username} ‚è∑`;

    showPage("overview");
  } else {
    document.getElementById("loginPage").style.display = "flex";
    document.getElementById("dashboardPage").style.display = "none";
  }
});


function register() {
  const regUsername = document.getElementById("regUsername").value;
  const regPassword = document.getElementById("regPassword").value;
  const regRole = document.getElementById("regRole").value;

  fetch("/api/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: regUsername, password: regPassword, role: regRole })
  })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        showToast("‚ùå " + data.error);
      } else {
        showToast("‚úÖ " + data.message + " ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login");
        showPage("login");
      }
    })
    .catch(err => showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠"));
}

function showToast(message, success = true) {
  const toast = document.getElementById("toast");
  toast.innerText = message;

  // ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á / ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏° success
  toast.style.backgroundColor = success ? "#d1fae5" : "#fee2e2";
  toast.style.color = success ? "#065f46" : "#991b1b";

  toast.classList.add("show");

  // ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏ô 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}









function showOutput(text) {
  const output = document.getElementById("output") || document.createElement("div");
  output.id = "output";
  output.innerText = typeof text === "object" ? JSON.stringify(text, null, 2) : text;
  output.style.background = "#eee";
  output.style.padding = "10px";
  document.body.appendChild(output);
}




function showChangePassword() {
  document.getElementById("changeBox").style.display = "flex";
}

function closeChangePassword() {
  document.getElementById("changeBox").style.display = "none";

  // üßº ‡∏•‡πâ‡∏≤‡∏á input ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  document.getElementById("changeUser").value = "";
  document.getElementById("oldPass").value = "";
  document.getElementById("newPass").value = "";
  const msg = document.getElementById("changeMsg");
  msg.style.display = "none";
  msg.textContent = "";
  msg.className = "message";
}



  // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
  function backToLogin() {
  document.getElementById("registerPage").style.display = "none";

  const loginPage = document.getElementById("loginPage");
  loginPage.style.display = "flex";
  loginPage.style.flexDirection = "column";
  loginPage.style.justifyContent = "center";
  loginPage.style.alignItems = "center";
  loginPage.style.height = "100vh";
}

  
  function showRegister() {
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("registerPage").style.display = "block";
}

function goToRegister() {
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("registerPage").style.display = "block";
}

function goToChangePassword() {
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("changePasswordPage").style.display = "block";
}



//‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
function deleteAccount() {
  const inputUser = document.getElementById('deleteUser').value.trim();
  const inputPass = document.getElementById('deletePass').value.trim();
  const currentUser = localStorage.getItem('currentUser');
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  const msg = document.getElementById('deleteMsg');

  // Reset message
  msg.style.display = "none";
  msg.style.color = "#991b1b";

  // 1Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡πÑ‡∏´‡∏°
  if (!inputUser || !inputPass) {
    msg.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô";
    msg.style.display = "block";
    return;
  }

  // 2Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ inputUser ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö currentUser
  if (inputUser !== currentUser) {
    msg.innerText = "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
    msg.style.display = "block";
    return;
  }

  // 3Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
  if (users[currentUser] !== inputPass) {
    msg.innerText = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
    msg.style.display = "block";
    return;
  }

  // 4Ô∏è‚É£ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  delete users[currentUser];

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏°‡∏µ admin ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏™‡∏°‡∏≠
  if (!users["admin"]) {
    users["admin"] = "1234";
  }

  localStorage.setItem("users", JSON.stringify(users));
  msg.style.color = "#065f46";
  msg.innerText = "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
  msg.style.display = "block";

  // 5Ô∏è‚É£ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö
  setTimeout(() => {
    logout();
  }, 1500);
}

function closeDeleteBox() {
  document.getElementById("deleteBox").style.display = "none";
  document.getElementById("deleteMsg").style.display = "none";
}

function showDeleteBox() {
  document.getElementById("deleteUser").value = "";
  document.getElementById("deletePass").value = "";
  document.getElementById("deleteMsg").style.display = "none";
  document.getElementById("deleteBox").style.display = "flex";
}

function showLogoutBox() {
  document.getElementById("logoutBox").style.display = "flex";
}

function closeLogoutBox() {
  document.getElementById("logoutBox").style.display = "none";
}

function confirmLogout() {
  localStorage.removeItem("loggedIn");
  localStorage.removeItem("currentUser");
  localStorage.removeItem("userRole");

  closeLogoutBox();
  document.getElementById("dashboardPage").style.display = "none";
  document.getElementById("loginPage").style.display = "flex";
}



  function logout() {
  // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
  localStorage.removeItem("loggedIn");
  localStorage.removeItem("currentUser");
  
  window.onload = function () {
  const loggedIn = localStorage.getItem("loggedIn");

  if (loggedIn === "true") {
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("dashboardPage").style.display = "block";
  } else {
    document.getElementById("loginPage").style.display = "block";
    document.getElementById("dashboardPage").style.display = "none";
  }
}




  // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ loginPage (‡πÉ‡∏ô index.html)
  location.reload();
}
function changePassword() {
  const user = document.getElementById("changeUser").value.trim();
  const oldPass = document.getElementById("oldPass").value.trim();
  const newPass = document.getElementById("newPass").value.trim();
  const msg = document.getElementById("changeMsg");

  msg.className = "message";
  msg.style.display = "none";

  if (!user || !oldPass || !newPass) {
    msg.textContent = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö";
    msg.classList.add("error");
    msg.style.display = "block";
    return;
  }

  const users = JSON.parse(localStorage.getItem("users") || "{}");

  if (!users[user]) {
  msg.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ";
  msg.classList.add("error");
} else if (users[user].password !== oldPass) {
  msg.textContent = "‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
  msg.classList.add("error");
} else {
  users[user].password = newPass;  // ‚úÖ update password ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  localStorage.setItem("users", JSON.stringify(users));
  msg.textContent = "‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  msg.classList.add("success");
}

  msg.style.display = "block";
}


document.addEventListener('DOMContentLoaded', () => {
  const userWrapper = document.getElementById("userWrapper");
  const dropdown = document.getElementById("userDropdown");

  let isHovering = false;
  let hideTimeout;

  userWrapper.addEventListener("mouseenter", () => {
    clearTimeout(hideTimeout);
    dropdown.style.display = "block";
  });

  userWrapper.addEventListener("mouseleave", () => {
    hideTimeout = setTimeout(() => {
      dropdown.style.display = "none";
    }, 200); // ‡∏£‡∏≠ 200ms ‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏ô
  });
});
// ‚úÖ [‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á Inventory ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á Tray ID ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Popup
function renderTrayGrid() {
  const grid = document.querySelector(".tray-grid");
  if (!grid) {
    console.warn("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ .tray-grid ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‚Äì renderTrayGrid() ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Å‡πà‡∏≠‡∏ô DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°");
    return;
  }
  grid.innerHTML = "";

  for (let floor = 9; floor >= 1; floor--) {
    for (let slot = 1; slot <= 18; slot++) { // ‚ùóÔ∏è ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 18
      const key = `${floor}-${slot}`;
      const info = trayInventory[key];

      const isFilled = info && (info.status === 'on_shelf' || info.status === 'IN_STORAGE');

      const div = document.createElement("div");
      div.className = "tray-slot fade-in";
      div.style.padding = "12px";
      div.style.border = "1px solid #ccc";
      div.style.borderRadius = "6px";
      div.style.fontSize = "0.8em";
      div.style.textAlign = "center";
      
      if (isFilled) {
        div.style.background = "#52b788";
        div.style.color = "#fff";
        div.title = `${info.veg_type} \n‡πÄ‡∏ß‡∏•‡∏≤: ${info.time_in}`;
        div.classList.add("filled");
      } else {
        div.style.background = "#e2e8f0";
        div.style.color = "#555";
        div.title = `‡∏ß‡πà‡∏≤‡∏á`;
        div.classList.add("empty");
      }
      
      div.textContent = `‡∏ä‡∏±‡πâ‡∏ô ${floor} / ${slot}`;

      div.onclick = () => {
        if (isFilled && info) {
          const placedTime = new Date(info.time_in);
          const now = new Date();
          const diffMs = now - placedTime;
          const diffMins = Math.floor(diffMs / 1000 / 60);
          const hours = Math.floor(diffMins / 60);
          const minutes = diffMins % 60;
          const days = Math.floor(hours / 24);
          const remainHours = hours % 24;

          let ageStr = "";
          if (days > 0) ageStr += `${days} ‡∏ß‡∏±‡∏ô `;
          if (remainHours > 0 || days > 0) ageStr += `${remainHours} ‡∏ä‡∏°. `;
          ageStr += `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;

          // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ] ‡πÄ‡∏û‡∏¥‡πà‡∏° trayId ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
          showTrayInfoPopup({
            trayId: info.tray_id, 
            username: info.username || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏",
            veg: info.veg_type,
            floor: info.floor,
            slot: info.slot,
            timestamp: new Date(info.time_in).toLocaleString("th-TH"),
            age: ageStr
          });
        }
      };
      grid.appendChild(div);
    }
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const userMenu = document.getElementById("currentUser");
  const userDropdown = document.getElementById("userDropdown");
  const toggleButton = document.getElementById("toggleTheme");

  // üëâ ‡∏Å‡∏î‡∏ó‡∏µ‡πà user menu ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå/‡∏ã‡πà‡∏≠‡∏ô dropdown
  userMenu.addEventListener("click", () => {
    const isVisible = userDropdown.style.display === "block";
    userDropdown.style.display = isVisible ? "none" : "block";
  });

  // üëâ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô ‡∏ã‡πà‡∏≠‡∏ô dropdown
  window.addEventListener("click", (e) => {
    if (!userMenu.contains(e.target) && !userDropdown.contains(e.target)) {
      userDropdown.style.display = "none";
    }
  });

  // üåô ‡πÇ‡∏´‡∏•‡∏î‡∏ò‡∏µ‡∏°‡∏à‡∏≤‡∏Å localStorage ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
    if (toggleButton) toggleButton.textContent = "‚òÄÔ∏è Light Mode";
  }

  // üåó ‡∏õ‡∏∏‡πà‡∏° toggle theme
  if (toggleButton) {
    toggleButton.addEventListener("click", () => {
      const isDark = document.body.classList.toggle("dark-mode");
      toggleButton.textContent = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });
  }
});


const hourlyCtx = document.getElementById('hourlyChart')?.getContext('2d');
if (hourlyCtx) {
  const hourlyChart = new Chart(hourlyCtx, {
    type: 'line',
    data: {
      labels: [...Array(24).keys()].map(h => `${String(h).padStart(2, '0')}:00`),
      datasets: [
        {
          label: 'Inbound',
          data: [1, 0, 2, 1, 3, 4, 6, 9, 12, 10, 8, 7, 5, 6, 7, 9, 8, 7, 5, 4, 3, 2, 1, 0],
          borderColor: '#40916c',
          backgroundColor: 'rgba(64,145,108,0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 3
        },
        {
          label: 'Outbound',
          data: [0, 1, 1, 0, 2, 3, 5, 8, 9, 11, 9, 6, 4, 4, 6, 8, 7, 6, 4, 3, 2, 1, 0, 0],
          borderColor: '#74c69d',
          backgroundColor: 'rgba(116,198,157,0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 3
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å ‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (00:00 - 23:00)',
          font: {
            size: 18
          },
          color: '#1b4332'
        },
        legend: {
          labels: {
            font: { size: 14 },
            color: '#1b4332'
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 2,
            color: '#1b4332'
          },
          title: {
            display: true,
            text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏≤‡∏î',
            color: '#1b4332',
            font: {
              size: 14
            }
          }
        },
        x: {
          ticks: {
            color: '#1b4332'
          },
          title: {
            display: true,
            text: '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)',
            color: '#1b4332',
            font: {
              size: 14
            }
          }
        }
      }
    }
  });
}


//‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ñ‡πà‡∏≠ esp32 ‡∏à‡∏≥‡∏•‡∏≠‡∏á
function simulateMQTTHeartbeat(topic) {
  // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏µ message ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
  for (const [name, dev] of Object.entries(devices)) {
    if (dev.topic === topic) {
      dev.lastSeen = Date.now();
      dev.status = "online";
    }
  }
}



// ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
function updateSystemUI() {
  const container = document.getElementById("systemStatus");
  if (!container) return; // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ element ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà ‚Üí ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢

  container.innerHTML = "";

  const now = Date.now();
  for (const [name, dev] of Object.entries(devices)) {
    const diff = now - dev.lastSeen;
    const isOnline = diff < 10000;
    dev.status = isOnline ? "online" : "offline";

    const card = document.createElement("div");
    card.style = `
      padding: 20px;
      border-radius: 16px;
      background: ${isOnline ? '#d8f3dc' : '#f8d7da'};
      border-left: 8px solid ${isOnline ? '#2d6a4f' : '#c82333'};
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      min-width: 220px;
      font-family: 'Prompt', sans-serif;
    `;

    card.innerHTML = `
      <h3 style="margin: 0 0 10px 0;">${name}</h3>
      <p>Status: <strong style="color: ${isOnline ? '#2d6a4f' : '#c82333'}">${dev.status.toUpperCase()}</strong></p>
      <p>Last Seen: ${isOnline ? (Math.floor(diff / 1000) + 's ago') : '‚ùå Offline'}</p>
    `;
    container.appendChild(card);
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£ heartbeat ‡∏à‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞ ESP32
function simulateMQTTHeartbeat(topic) {
  for (const dev of Object.values(devices)) {
    if (dev.topic === topic) {
      dev.lastSeen = Date.now();
    }
  }
}

let co2Chart, tempChart, humidityChart;
let currentDay = new Date().getDate(); // üîÅ ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà

function setupEnvironmentCharts() {
  const co2Ctx = document.getElementById('co2Chart')?.getContext('2d');
  const tempCtx = document.getElementById('tempChart')?.getContext('2d');
  const humidityCtx = document.getElementById('humidityChart')?.getContext('2d');
  const timeNow = () => new Date().toLocaleTimeString('th-TH', { hour12: false });

  co2Chart = new Chart(co2Ctx, {
    type: 'line',
    data: {
      labels: [timeNow()],
      datasets: [{
        label: 'CO2 (ppm)',
        data: [getRandom(440, 520)],
        borderColor: '#ef476f',
        backgroundColor: 'rgba(239, 71, 111, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: { responsive: true }
  });

  tempChart = new Chart(tempCtx, {
    type: 'line',
    data: {
      labels: [timeNow()],
      datasets: [{
        label: 'Temperature (¬∞C)',
        data: [getRandom(24, 30)],
        borderColor: '#ffd166',
        backgroundColor: 'rgba(255, 209, 102, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: { responsive: true }
  });

  humidityChart = new Chart(humidityCtx, {
    type: 'line',
    data: {
      labels: [timeNow()],
      datasets: [{
        label: 'Humidity (%)',
        data: [getRandom(60, 80)],
        borderColor: '#06d6a0',
        backgroundColor: 'rgba(6, 214, 160, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: { responsive: true }
  });
}

function updateEnvironmentCharts() {
  const now = new Date();
  const timeNow = now.toLocaleTimeString('th-TH', { hour12: false });

  // üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô
  if (now.getDate() !== currentDay) {
    currentDay = now.getDate();     // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
    resetEnvironmentCharts();       // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏≤‡∏ü
  }

  const co2Val = getRandom(440, 520);
  const tempVal = getRandom(24, 30);
  const humidVal = getRandom(60, 80);

  function update(chart, value) {
    chart.data.labels.push(timeNow);
    chart.data.datasets[0].data.push(value);
    chart.update();
  }

  update(co2Chart, co2Val);
  update(tempChart, tempVal);
  update(humidityChart, humidVal);
}

function resetEnvironmentCharts() {
  co2Chart.data.labels = [];
  co2Chart.data.datasets[0].data = [];
  co2Chart.update();

  tempChart.data.labels = [];
  tempChart.data.datasets[0].data = [];
  tempChart.update();

  humidityChart.data.labels = [];
  humidityChart.data.datasets[0].data = [];
  humidityChart.update();
}

function getRandom(min, max) {
  return +(Math.random() * (max - min) + min).toFixed(1);
}


// ‡∏ü‡∏±‡πà‡∏á‡∏ä‡∏±‡πà‡∏ô popup tray inventory (‡∏â‡∏ö‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà)
function showTrayInfoPopup({ trayId, username, veg, floor, slot, timestamp, age }) {
  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á popup ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
  const existingPopup = document.getElementById("trayInfoPopup");
  if (existingPopup) {
    existingPopup.remove();
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á popup ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà
  const contentHTML = `
    <div class="popup-header-premium">
      <i class="fas fa-boxes"></i>
      <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î</h3>
    </div>
    <div class="info-list">
      <div class="info-item">
        <span class="info-label"><i class="fas fa-tag"></i> Tray ID</span>
        <span class="info-value highlight">${trayId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-leaf"></i> ‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</span>
        <span class="info-value">${veg}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-layer-group"></i> ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
        <span class="info-value">‡∏ä‡∏±‡πâ‡∏ô ${floor}, ‡∏ä‡πà‡∏≠‡∏á ${slot}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-calendar-alt"></i> ‡∏ß‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</span>
        <span class="info-value">${timestamp}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-hourglass-half"></i> ‡∏≠‡∏≤‡∏¢‡∏∏‡∏ñ‡∏≤‡∏î</span>
        <span class="info-value">${age}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-user-circle"></i> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
        <span class="info-value">${username || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
      </div>
    </div>
    <div class="close-button-wrapper">
      <button class="close-button" onclick="closeTrayInfoPopup()">
        <i class="fas fa-times"></i> ‡∏õ‡∏¥‡∏î
      </button>
    </div>
  `;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Element ‡∏Ç‡∏≠‡∏á Popup ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
  const popupBackdrop = document.createElement('div');
  popupBackdrop.id = 'trayInfoPopup';
  popupBackdrop.className = 'tray-popup-backdrop';

  const popupCard = document.createElement('div');
  popupCard.className = 'tray-popup-card';
  popupCard.innerHTML = contentHTML;

  popupBackdrop.appendChild(popupCard);
  document.body.appendChild(popupBackdrop);
}

function closeTrayInfoPopup() {
  const popupBackdrop = document.getElementById("trayInfoPopup");
  if (popupBackdrop) {
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° animation ‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î
    popupBackdrop.classList.add('closing');
    popupBackdrop.querySelector('.tray-popup-card').classList.add('closing');

    // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö Element ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DOM ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ animation ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏ö
    setTimeout(() => {
      if (popupBackdrop) {
          popupBackdrop.remove();
      }
    }, 300); // ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö animation-duration ‡πÉ‡∏ô CSS
  }
}






function showTrayPopup(message) {
  const popup = document.getElementById('trayPopup');
  popup.textContent = message || "‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  popup.style.display = 'block';

  setTimeout(() => {
    popup.style.display = 'none';
  }, 5000); // 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
}





function showLiftToast(message) {
  const toast = document.getElementById("liftToast");
  const msg = document.getElementById("liftToastMessage");
  if (!toast || !msg) return;

  msg.textContent = message;
  toast.style.display = "block";

  setTimeout(() => {
    toast.style.display = "none";
  }, 4000);
}






function onStationChange() {
  const select = document.getElementById("stationSelect");
  const selected = parseInt(select.value);
  if (!isNaN(selected)) {
    currentStation = selected;
  } else {
    currentStation = 1; // fallback ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ dropdown ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î
  }
  showPage(currentPage); // ‚úÖ reload ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°
}




function loadOverviewCharts(stationId) {
  fetch(`/api/overview?station=${stationId}`)
    .then(res => res.json())
    .then(data => {
      renderPie(data.total);
      renderBar(data.daily);
      renderHourly(data.hourly);
    });
}
// ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ currentPage ‡πÄ‡∏õ‡πá‡∏ô logCurrentPage
let userLogs = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• log ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å backend
let logCurrentPage = 1;
const logsPerPage = 10;

// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î log ‡∏à‡∏≤‡∏Å backend
async function fetchUserLogs() {
  const res = await fetch("/api/logs"); // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ token ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ

  if (res.ok) {
    userLogs = await res.json();
    renderUserLogs(); // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
  } else {
    alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Log ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }
}
// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
function mapCategory(log) {
  const act = (log.activity || "").toLowerCase();
  const cat = (log.category || "").toLowerCase();

  if (cat === "tray") {
    if (act.includes("‡∏ß‡∏≤‡∏á")) return "‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤";
    if (act.includes("‡∏ô‡∏≥") && act.includes("‡∏≠‡∏≠‡∏Å")) return "‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å";
    return "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏î";
  }
  if (cat === "inbound") return "‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤";
  if (cat === "outbound") return "‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å";
  if (cat === "lift") return "‡∏•‡∏¥‡∏ü‡∏ï‡πå";
  if (cat === "agv") return "AGV";
  if (cat === "login") return "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";

  if (act.includes("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö")) return "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
  if (act.includes("‡∏ß‡∏≤‡∏á")) return "‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤";
  if (act.includes("‡∏ô‡∏≥") && act.includes("‡∏≠‡∏≠‡∏Å")) return "‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å";
  if (act.includes("‡∏•‡∏¥‡∏ü")) return "‡∏•‡∏¥‡∏ü‡∏ï‡πå";
  if (act.includes("agv")) return "AGV";

  return "-";
}

function renderUserLogs() {
    const container = document.getElementById("logCardsContainer");
    const searchInput = document.getElementById("logSearchInput");
    const categoryFilter = document.getElementById("logCategoryFilter");
    const pagination = document.getElementById("pagination");
    const logsPerPage = 20;

    if (!container || !searchInput || !categoryFilter || !pagination) return;
    
    // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ filter ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    // ... (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ...
    const query = searchInput.value.toLowerCase();
    const selectedCategory = categoryFilter.value.trim();

    const filtered = userLogs.filter(log =>
      (!selectedCategory || mapCategory(log) === selectedCategory) &&
      (
        (log.username?.toLowerCase().includes(query)) ||
        (log.activity?.toLowerCase().includes(query)) ||
        (log.timestamp && new Date(log.timestamp).toLocaleString().toLowerCase().includes(query))
      )
    );

    const totalPages = Math.ceil(filtered.length / logsPerPage);
    const start = (logCurrentPage - 1) * logsPerPage;
    const pageLogs = filtered.slice(start, start + logsPerPage);
    container.innerHTML = "";

    pageLogs.forEach(log => {
      const card = document.createElement("div");
      card.className = "log-card";
      card.innerHTML = `
        <div><strong>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</strong> ${log.username || "-"}</div>
        <div><strong>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</strong> ${log.activity || "-"}</div>
        <div><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${log.timestamp ? new Date(log.timestamp).toLocaleString() : "-"}</div>
        <button class="expand-btn" onclick="toggleDetails(this)">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
        <div class="log-details" style="display: none; margin-top: 10px;">
          <div><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${mapCategory(log)}</div>
          <div><strong>‡∏ä‡∏±‡πâ‡∏ô:</strong> ${log.floor ?? "-"}</div>
          <div><strong>‡∏ä‡πà‡∏≠‡∏á:</strong> ${log.slot ?? "-"}</div>
          <div><strong>‡∏ú‡∏±‡∏Å:</strong> ${log.veg_type || "-"}</div>
          <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ:</strong> ${log.station || "-"}</div>
        </div>
      `;
      container.appendChild(card);
    });

    pagination.innerHTML = "";
    for (let i = 1; i <= totalPages; i++) {
      const active = i === logCurrentPage ? "background:#40916c; color:white;" : "background:#e9f5ec;";
      pagination.innerHTML += `
        <button onclick="goToLogPage(${i})" style="margin: 2px; padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; ${active}">
          ${i}
        </button>
      `;
    }
}


function toggleDetails(button) {
  const detailsDiv = button.nextElementSibling;
  if (detailsDiv.style.display === "none") {
    detailsDiv.style.display = "block";
    button.innerText = "‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î";
  } else {
    detailsDiv.style.display = "none";
    button.innerText = "‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î";
  }
}



// ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
fetchUserLogs();

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á log ‡πÅ‡∏ö‡∏ö‡πÉ‡∏ä‡πâ username (frontend ‚Üí /api/log)
function logAction(username, activity, action_type = "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", category, station = "", floor = "", slot = "", veg_type = "", description = "") {
  // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á username ‚Üí ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å localStorage
  if (!username) {
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (user && user.username) {
      username = user.username;
    }
  }

  fetch("/api/log", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username,
      activity,
      action_type,
      category,
      station,
      floor,
      slot,
      veg_type,
      description
    })
  })
  .then(res => res.json())
  .then(data => {
    console.log("‚úÖ Log saved:", data);
  })
  .catch(err => {
    console.error("‚ùå logAction error:", err);
  });
}
function exportLogsToExcelWithLogo() {
  if (!userLogs || userLogs.length === 0) {
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å");
    return;
  }

  const exportData = userLogs.map((log, index) => [
    index + 1,
    new Date(log.timestamp).toLocaleString('th-TH', { hour12: false }),
    log.username,
    log.role || "-",
    log.activity,
    log.type,
    log.floor || "-",
    log.slot || "-",
    log.veg_type || "-",
    log.station || "-"
  ]);

  const headers = [
    "‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡πÄ‡∏ß‡∏•‡∏≤", "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", "‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó", "‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó",
    "‡∏ä‡∏±‡πâ‡∏ô", "‡∏ä‡πà‡∏≠‡∏á", "‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ"
  ];

  XlsxPopulate.fromBlankAsync().then(workbook => {
    const sheet = workbook.sheet(0).name("User Logs");

    // ‚úÖ ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢
    sheet.cell("A1").value("AGROTECH WMS").style({
      bold: true,
      fontSize: 18,
      fontColor: "2d6a4f"
    });

    // ‚úÖ ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    headers.forEach((header, i) => {
      sheet.cell(3, i + 1).value(header).style({
        bold: true,
        fill: "2d6a4f",
        fontColor: "ffffff",
        horizontalAlignment: "center"
      });
      sheet.column(i + 1).width(16);
    });

    // ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    exportData.forEach((row, r) => {
      row.forEach((val, c) => {
        sheet.cell(r + 4, c + 1).value(val);
      });
    });

    // ‚úÖ ‚úÖ ‚úÖ FIX: ‡πÉ‡∏ä‡πâ .range().autoFilter() ‡πÅ‡∏ó‡∏ô
    sheet.range("A3:J3").autoFilter();

    // ‚úÖ freeze row
    sheet.freezePanes(4, 1);

    return workbook.outputAsync();
  }).then(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `user_logs_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.xlsx`;
    a.click();
    URL.revokeObjectURL(url);
  }).catch(err => {
    console.error("‚ùå Export Error:", err);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel");
  });
}








function calculateTrayAge(time_in_string) {
  if (!time_in_string) return "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
  
  const startTime = new Date(time_in_string);
  const now = new Date();
  let diff = (now.getTime() - startTime.getTime()) / 1000; // ‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

  const days = Math.floor(diff / (24 * 3600));
  diff -= days * 24 * 3600;
  const hours = Math.floor(diff / 3600);
  diff -= hours * 3600;
  const minutes = Math.floor(diff / 60);

  let age = "";
  if (days > 0) age += `${days} ‡∏ß‡∏±‡∏ô `;
  if (hours > 0) age += `${hours} ‡∏ä‡∏°. `;
  age += `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
  
  return age;
}


function showTrayDetails(floor, slot) {
  const key = `${floor}-${slot}`;
  const info = trayInventory[key];

  if (!info) {
    alert(`‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ\n‡∏ä‡∏±‡πâ‡∏ô ${floor}, ‡∏ä‡πà‡∏≠‡∏á ${slot}`);
    return;
  }

  const veg = info.veg_type || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";          // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ veg_type
  const timeText = info.time_in
    ? new Date(info.time_in).toLocaleString("th-TH") // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ time_in
    : "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ß‡∏•‡∏≤";

  let ageStr = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡πÑ‡∏î‡πâ";
  if (info.time_in) {
    const placed = new Date(info.time_in);
    const now = new Date();
    const diff = now - placed;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    ageStr = days > 0 ? `${days} ‡∏ß‡∏±‡∏ô ${hours} ‡∏ä‡∏°.` : `${hours} ‡∏ä‡∏°.`;
  }

  alert(`üîç ‡∏ñ‡∏≤‡∏î: ${veg}\n‡∏ä‡∏±‡πâ‡∏ô ${floor}, ‡∏ä‡πà‡∏≠‡∏á ${slot}\n‡∏ß‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${timeText}\n‡∏≠‡∏≤‡∏¢‡∏∏: ${ageStr}`);
}


// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
function loadRealPlanMock(page = 1) {
  currentPage = page;
  const today = new Date().toISOString().split("T")[0];
  const tbody = document.getElementById("realPlanTableBody");
  tbody.innerHTML = "";

  const start = (page - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const displayTrays = trays.slice(start, end);

  displayTrays.forEach(tray => {
    const isDue = tray.harvest_date <= today;
 const statusHTML = isDue
  ? `<span class="status status-due blink"><i class="fas fa-bell"></i> ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</span>`
  : `<span class="status status-growing"><i class="fas fa-leaf"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</span>`;

    const actionHTML = `
      <div class="action-buttons">
        <button onclick="sendRefill(${tray.floor}, ${tray.slot})">‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥</button>
        <button onclick="toggleWater(${tray.floor}, ${tray.slot})">‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</button>
      </div>
    `;

    const row = document.createElement("tr");
    row.className = isDue ? "harvest-due" : "";
    row.innerHTML = `
      <td>${tray.veg_type}</td>
      <td>‡∏ä‡∏±‡πâ‡∏ô ${tray.floor}</td>
      <td>‡∏ä‡πà‡∏≠‡∏á ${tray.slot}</td>
      <td>${tray.start_date}</td>
      <td>${tray.harvest_date}</td>
      <td>${statusHTML}</td>
      <td>${actionHTML}</td>
    `;
    tbody.appendChild(row);
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô)
const historyRow = document.createElement('tr');
historyRow.className = 'history-row';
historyRow.id = `history-${tray.tray_id}`;
historyRow.style.display = 'none';
historyRow.innerHTML = `<td colspan="10"></td>`; // Colspan ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
tbody.appendChild(historyRow);
  });

  renderPagination();
}

// ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ñ‡∏≤‡∏î (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏≤‡∏¢‡∏∏)
async function toggleTrayHistory(trayId, button) {
    const historyRow = document.getElementById(`history-${trayId}`);
    const historyCell = historyRow.querySelector('td');

    const isVisible = historyRow.style.display !== 'none';

    if (isVisible) {
        historyRow.style.display = 'none';
        button.innerText = '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥';
        button.style.backgroundColor = '#64748b';
        return;
    }

    historyRow.style.display = 'table-row';
    button.innerText = '‡πÇ‡∏´‡∏•‡∏î...';
    button.disabled = true;
    historyCell.innerHTML = '<p style="text-align:center; padding: 10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</p>';

    try {
        const response = await fetch(`/api/tray/history/${trayId}`);
        const historyData = await response.json();
        
        button.innerText = '‡∏ã‡πà‡∏≠‡∏ô';
        button.style.backgroundColor = '#1f2937';
        button.disabled = false;

        if (!historyData || historyData.length === 0) {
            historyCell.innerHTML = '<p style="text-align:center; font-weight: 500; padding: 10px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ñ‡∏≤‡∏î‡∏ô‡∏µ‡πâ</p>';
            return;
        }

        let historyHtml = `
            <table class="history-table">
                <thead>
                    <tr>
                        <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                        <th>‡∏≠‡∏≤‡∏¢‡∏∏‡∏ñ‡∏≤‡∏î (‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</th>
                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô</th>
                        <th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
                        <th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                    </tr>
                </thead>
                <tbody>
        `;

        historyData.forEach(log => {
            const actionClass = log.action_type === 'inbound' ? 'action-inbound' : 'action-outbound';
            const actionText = log.action_type === 'inbound' ? '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å';
            
            // --- [‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á] ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏ñ‡∏≤‡∏î ---
            let ageDisplay = '-';
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 'inbound' ‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏
            if (log.action_type !== 'inbound' && log.birth_time && log.created_at) {
    const actionTime = new Date(log.created_at);
    const birthTime = new Date(log.birth_time); // <-- ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ log.birth_time
    const diffMs = actionTime.getTime() - birthTime.getTime();
    
    if (diffMs >= 0) {
        const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diffMs / (1000 * 60 * 60)) % 24);
        ageDisplay = `${days} ‡∏ß‡∏±‡∏ô ${hours} ‡∏ä‡∏°.`;
    }
}

            historyHtml += `
                <tr>
                    <td>${log.timestamp_th}</td>
                    <td class="${actionClass}">${actionText}</td>
                    <td>‡∏ä‡∏±‡πâ‡∏ô ${log.floor} / ‡∏ä‡πà‡∏≠‡∏á ${log.slot}</td>
                    <td>${ageDisplay}</td>
                    <td>${log.plant_quantity || '-'}</td>
                    <td>${log.reason || '-'}</td>
                    <td>${log.username || '-'}</td>
                </tr>
            `;
        });

        historyHtml += '</tbody></table>';
        historyCell.innerHTML = historyHtml;

    } catch (error) {
        console.error('Failed to load tray history:', error);
        historyCell.innerHTML = '<p style="text-align:center; color: red; padding: 10px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>';
        button.innerText = '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
        button.disabled = false;
    }
}




// ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
function renderPagination() {
  const totalPages = Math.ceil(trays.length / rowsPerPage);
  const pagination = document.getElementById("plantingPagination");
  pagination.innerHTML = "";

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.className = i === currentPage ? "active" : "";
    btn.onclick = () => loadRealPlanMock(i);
    pagination.appendChild(btn);
  }
}

// ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (mock)
function sendRefill(floor, slot) {
  alert(`üíß ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà ‡∏ä‡∏±‡πâ‡∏ô ${floor} / ‡∏ä‡πà‡∏≠‡∏á ${slot}`);
}

function toggleWater(floor, slot) {
  alert(`‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏ó‡∏µ‡πà ‡∏ä‡∏±‡πâ‡∏ô ${floor} / ‡∏ä‡πà‡∏≠‡∏á ${slot}`);
}



async function loadTaskMonitor() {
  try {
    const response = await fetch('/api/task-monitor');
    const tasks = await response.json();
    renderTaskTable(tasks);
  } catch (err) {
    console.error('‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Task Monitor ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', err);
  }
}

function renderTaskTable(tasks) {
  const tbody = document.getElementById("taskTableBody");
  tbody.innerHTML = "";

  tasks.forEach(task => {
    const tr = document.createElement("tr");

    const statusClass = task.status === 'done' ? 'success' :
                        task.status === 'error' ? 'error blink' : '' ;

    const endTime = task.completed_at ? formatDate(task.completed_at) : '-';

    tr.innerHTML = `
      <td>${task.tray_id}</td>
      <td>${task.action_type}</td>
      <td>${task.floor || '-'}</td>
      <td>${task.slot || '-'}</td>
      <td>${task.station_id || '-'}</td>
      <td><span class="status ${statusClass}">${convertStatusLabel(task.status)}</span></td>
      <td>${formatDate(task.created_at)}</td>
      <td>${endTime}</td>
      <td>${task.username || '-'}</td>
    `;

    tbody.appendChild(tr);
  });
}
// ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå index.html (‡∏™‡πà‡∏ß‡∏ô <script>)

function convertStatusLabel(status) {
  if (status === 'pending') return '‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
  if (status === 'working') return 'üöö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
  if (status === 'at_workstation') return 'üì¶ ‡∏£‡∏≠‡∏ó‡∏µ‡πà Workstation'; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  if (status === 'success') return '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≤‡∏Å 'done' ‡πÄ‡∏õ‡πá‡∏ô 'success' ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend
  if (status === 'error') return '‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
  return status; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
}
function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleString("th-TH", { hour12: false });
}


//‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà
function loadTaskHistory() {
  const historyTasks = [
    {
      task_id: "T001",
      floor: 4,
      slot: 8,
      status: "success",
      start_time: "2025-05-21T08:15:00",
      end_time: "2025-05-21T08:16:30",
      type: "tray_inbound",
      username: "admin"
    },
    {
      task_id: "T004",
      floor: 2,
      slot: 5,
      status: "success",
      start_time: "2025-05-21T07:00:00",
      end_time: "2025-05-21T07:01:45",
      type: "agv_move",
      username: "staff02"
    }
  ];

  renderTaskHistoryTable(historyTasks);
}

// task history
function renderTaskHistoryTable(tasks) {
  const tbody = document.getElementById("taskHistoryTableBody");
  tbody.innerHTML = "";

  tasks.forEach(task => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${task.task_id}</td>
      <td>${task.floor || '-'}</td>
      <td>${task.slot || '-'}</td>
      <td><span class="status success">${formatStatus(task.status)}</span></td>
      <td>${formatDate(task.start_time)}</td>
      <td>${formatDate(task.end_time)}</td>
      <td>${task.type}</td>
      <td>${task.username || '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}


async function loadOverviewCharts() {
  try {
    const station = currentStation || 1;

    const [summaryRes, weeklyRes, hourlyRes] = await Promise.all([
      fetch(`/api/stats/summary?station=${station}`),
      fetch(`/api/stats/weekly?station=${station}`),
      fetch(`/api/stats/hourly?station=${station}`)
    ]);

    const summary = await summaryRes.json();
    const weekly = await weeklyRes.json();
    const hourly = await hourlyRes.json();

    renderPieChart(summary);
    renderBarChart(weekly);
    renderHourlyChart(hourly);
  } catch (err) {
    console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• overview ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
  }
}



function renderPieChart(data) {
  if (pieChartInstance) pieChartInstance.destroy(); // ‚úÖ ‡∏•‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
  pieChartInstance = new Chart(document.getElementById('pieChart'), {
    type: 'pie',
    data: {
      labels: ['Inbound (‡πÄ‡∏Ç‡πâ‡∏≤)', 'Outbound (‡∏≠‡∏≠‡∏Å)'],
      datasets: [{
        data: [data.inbound, data.outbound],
        backgroundColor: ['#b7e4c7', '#52b788']
      }]
    }
  });
}

function getLast7Dates() {
  const dates = [];
  const now = new Date();
  for (let i = 6; i >= 0; i--) {
    const d = new Date(now);
    d.setDate(now.getDate() - i);
    const formatted = d.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit' });
    dates.push(formatted);
  }
  return dates;
}

function renderBarChart(data) {
  if (barChartInstance) barChartInstance.destroy();

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á map ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà API ‡∏™‡πà‡∏á‡∏°‡∏≤
  const inboundMap = {};
  const outboundMap = {};

  data.forEach(row => {
    inboundMap[row.date] = row.inbound;
    outboundMap[row.date] = row.outbound;
  });

  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ['21/05', '22/05', ..., '27/05'])
  const labels = getLast7Dates();

  const inboundData = labels.map(date => inboundMap[date] || 0);
  const outboundData = labels.map(date => outboundMap[date] || 0);
barChartInstance = new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Inbound',
                    data: inboundData,
                    backgroundColor: '#52b788', // ‚úÖ ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏•‡∏±‡∏Å
                    borderRadius: 6
                },
                {
                    label: 'Outbound',
                    data: outboundData,
                    backgroundColor: '#d8f3dc', // ‚úÖ ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏à‡∏≤‡∏á
                    borderRadius: 6
                }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function getHourlyLabels() {
  const hours = [];
  for (let i = 0; i < 24; i++) {
    const label = i.toString().padStart(2, '0') + ':00';
    hours.push(label);
  }
  return hours;
}


function renderHourlyChart(data) {
  if (hourlyChartInstance) hourlyChartInstance.destroy();

  const inboundMap = {};
  const outboundMap = {};

  // ‚è± API ‡∏™‡πà‡∏á hour ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÄ‡∏ä‡πà‡∏ô 9, 10
  data.forEach(row => {
    const hourLabel = row.hour.toString().padStart(2, '0') + ':00';
    inboundMap[hourLabel] = row.inbound;
    outboundMap[hourLabel] = row.outbound;
  });

  const labels = getHourlyLabels(); // ['00:00', ..., '23:00']

  const inboundData = labels.map(h => inboundMap[h] || 0);
  const outboundData = labels.map(h => outboundMap[h] || 0);

  hourlyChartInstance = new Chart(document.getElementById('hourlyChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Inbound',
                    data: inboundData,
                    borderColor: '#40916c', // ‚úÖ ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°
                    backgroundColor: 'rgba(64, 145, 108, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Outbound',
                    data: outboundData,
                    borderColor: '#74c69d', // ‚úÖ ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏Å‡∏•‡∏≤‡∏á
                    backgroundColor: 'rgba(116, 198, 157, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

// ‚úÖ Global State
let currentFloor = 1;
let liftAnimation = null;
let isEmergency = false;
let liftStatusTimer = null;
let currentUser = JSON.parse(localStorage.getItem("loggedInUser") || "{}");

// ‚úÖ Map ‡∏ä‡∏±‡πâ‡∏ô ‚Üí ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á %
const levelTop = {
  1: 70, 2: 60, 3: 50, 4: 39, 5: 30,
  6: 20, 7: 12, 8: 5, 9: -1
};

// ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå + ‡∏à‡∏∏‡∏î sensor
function updateLiftDisplay(floor) {
  const liftCart = document.getElementById("liftCart");
  if (!liftCart) return;

  animateLiftTo(levelTop[floor] ?? 60);

  const floorDisplay = document.getElementById("currentFloor");
  if (floorDisplay) floorDisplay.innerText = floor;

  for (let i = 1; i <= 9; i++) {
    const dot = document.querySelector(`#floor-${i} [data-light]`);
    if (dot) {
      dot.style.background = (i === floor) ? '#52b788' : '#ccc';
      dot.style.boxShadow = (i === floor) ? '0 0 8px #52b788' : 'none';
    }
  }
}

// ‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô lift ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•
function animateLiftTo(targetPercent) {
  const liftCart = document.getElementById("liftCart");
  if (!liftCart) return;

  cancelAnimationFrame(liftAnimation);
  let currentTop = parseFloat(liftCart.style.top?.replace('%', '')) || targetPercent;
  const duration = 800;
  const startTime = performance.now();

  function step(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 0.5 * (1 - Math.cos(Math.PI * progress));
    const newTop = currentTop + (targetPercent - currentTop) * eased;
    liftCart.style.top = `${newTop}%`;
    if (progress < 1) liftAnimation = requestAnimationFrame(step);
  }

  requestAnimationFrame(step);
}

// ‚úÖ ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡πà‡∏≤‡∏ô REST
async function moveLift() {
  const targetFloor = parseInt(document.getElementById("floorSelect").value);
  if (!targetFloor || isNaN(targetFloor)) {
    alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    return;
  }

  try {
    const res = await fetch("/api/lift/move", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: currentUser.id,
        fromFloor: currentFloor,
        toFloor: targetFloor,
        station: currentStation
      })
    });

    const result = await res.json();
    showToast(`üì§ ${result.message}`);
    logLiftAction(currentUser.id, `‡∏™‡∏±‡πà‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÑ‡∏õ‡∏ä‡∏±‡πâ‡∏ô ${targetFloor}`, currentStation, targetFloor);
  } catch (err) {
    showToast("‚ùå ‡∏™‡∏±‡πà‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
    console.error("Move Lift Error:", err.message);
  }
}

// ‚úÖ Jog Up / Down (REST)
function startLiftMove(direction) {
  const action = direction === "up" ? "jogUp" : "jogDown";
  fetch("/api/lift/jog", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId: currentUser.id,
      station: currentStation,
      action: action
    })
  });

  logLiftAction(currentUser.id, `‡∏™‡∏±‡πà‡∏á Jog ${direction === 'up' ? '‡∏Ç‡∏∂‡πâ‡∏ô' : '‡∏•‡∏á'}`, currentStation, null);
}

// ‚úÖ ‡∏´‡∏¢‡∏∏‡∏î Jog
function stopLiftMove() {
  fetch("/api/lift/stop", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId: currentUser.id,
      station: currentStation
    })
  });

  logLiftAction(currentUser.id, "‡∏´‡∏¢‡∏∏‡∏î‡∏•‡∏¥‡∏ü‡∏ï‡πå (Jog)", currentStation, null);
}

// ‚úÖ ‡∏õ‡∏∏‡πà‡∏° EMERGENCY (REST)
function toggleEmergency() {
  isEmergency = !isEmergency;

  fetch("/api/lift/emergency", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId: currentUser.id,
      station: currentStation
    })
  });

  const emBtn = document.getElementById("emButton");
  const statusBox = document.getElementById("liftStatusBox");

  if (isEmergency) {
    emBtn.innerText = "‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥";
    emBtn.style.background = "#444";
    if (statusBox) statusBox.innerText = "üö® ‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥";
  } else {
    emBtn.innerText = "‚õî ‡∏´‡∏¢‡∏∏‡∏î‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ";
    emBtn.style.background = "#c1121f";
    if (statusBox) statusBox.innerText = "üü¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥";
  }

  logLiftAction(currentUser.id, `EMERGENCY: ${isEmergency ? 'ON' : 'OFF'}`, currentStation, null);
}
function startLiftStatusPolling() {
  if (liftStatusTimer) clearInterval(liftStatusTimer);

  liftStatusTimer = setInterval(async () => {
    try {
      const res = await fetch(`/api/lift/status?station=${currentStation}`);
      const data = await res.json();

      // ‚úÖ Debug log: ‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å backend
      console.log("[Lift Polling]", data);

      if (!data || typeof data.floor !== "number") return;

      // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏à‡∏≤‡∏Å floor sensor ‡∏à‡∏£‡∏¥‡∏á
      currentFloor = data.floor;
      updateLiftDisplay(data.floor);

      // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏•‡πá‡∏Å)
      const movingStatus = document.getElementById("movingStatus");
      if (movingStatus) {
        movingStatus.innerText = data.moving ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà..." : "‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏¥‡πà‡∏á";
      }

      // ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°
      const statusBox = document.getElementById("liftStatusBox");
      if (statusBox) {
        // ‡∏•‡πâ‡∏≤‡∏á class ‡πÄ‡∏î‡∏¥‡∏°
        statusBox.classList.remove("success", "emergency", "recovery", "working");

        if (Boolean(data.emergency)) {
          // üü• ‡∏´‡∏¢‡∏∏‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
          statusBox.classList.add("emergency");
          statusBox.innerHTML = `
            <i class="lucide lucide-alert-triangle" style="margin-right: 6px;"></i>
            ‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏´‡∏¢‡∏∏‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (Emergency Stop)
          `;

        } else if (Boolean(data.recovery)) {
          // üüß Recovery ‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
          statusBox.classList.add("recovery");
          statusBox.innerHTML = `
            <i class="lucide lucide-rotate-cw" style="margin-right: 6px;"></i>
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢...
          `;

        } else if (Boolean(data.moving)) {
          // üü¶ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
          statusBox.classList.add("working");
          statusBox.innerHTML = `
            <i class="lucide lucide-truck" style="margin-right: 6px;"></i>
            ‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
          `;
        } else {
          // üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥
          statusBox.classList.add("success");
          statusBox.innerHTML = `
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="margin-right: 12px;">
              <circle cx="12" cy="12" r="10" fill="#2dcc6f"/>
              <path d="M9 12.5l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
          `;
        }
      }

      // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ EM ‡∏ó‡∏±‡πà‡∏ß‡∏£‡∏∞‡∏ö‡∏ö
      isEmergency = Boolean(data.emergency);

    } catch (err) {
      console.warn("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err.message);
    }
  }, 500); // polling ‡∏ó‡∏∏‡∏Å 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
}




// ‚úÖ Log ‡πÑ‡∏õ backend
function logLiftAction(userId, activity, station, floor) {
  fetch("/api/log", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId,
      activity,
      action_type: "lift",
      category: "‡∏•‡∏¥‡∏ü‡∏ï‡πå",
      station,
      floor
    })
  });
}

// ‚úÖ Toast
function showToast(msg) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.innerText = msg;
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    z-index: 9999;
    font-size: 14px;
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ‚úÖ Init ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
function initLiftPage() {
  const liftCart = document.getElementById("liftCart");
  if (liftCart && levelTop[currentFloor]) {
    liftCart.style.top = `${levelTop[currentFloor]}%`;
  }

  const select = document.getElementById("floorSelect");
  if (select) select.value = currentFloor;

  const display = document.getElementById("currentFloor");
  if (display) display.innerText = currentFloor;

  startLiftStatusPolling();
}

//agv
function handleSlotSelection(slot) {
  if (slot) {
    sendAgvCommandUI(`go_slot${slot}`);
  }
}


//  status  sensor
async function fetchAgvSensorStatus() {
  try {
    const res = await fetch('/api/sensors');
    if (!res.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    const data = await res.json();

    document.querySelector('#sensorTray span').textContent = data.sensor3 ? "‚úÖ" : "‚ùå";
    document.querySelector('#sensorPos1 span').textContent = data.sensor1 ? "‡∏ñ‡∏∂‡∏á" : "‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á";
    document.querySelector('#sensorPos2 span').textContent = data.sensor2 ? "‡∏ñ‡∏∂‡∏á" : "‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á";
  } catch (err) {
    console.error("[AGV Sensor] ‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", err);
    document.querySelector('#sensorTray span').textContent = "‚ö†Ô∏è";
    document.querySelector('#sensorPos1 span').textContent = "‚ö†Ô∏è";
    document.querySelector('#sensorPos2 span').textContent = "‚ö†Ô∏è";
  }
}


async function sendAgvCommand(command) {
  try {
    const res = await fetch('/api/agv/manual', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id,
        station: currentStation, // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ currentStation
        command
      })
    });
    const data = await res.json();
    console.log('‚úÖ AGV command sent:', data.message);
  } catch (err) {
    console.error('‚ùå AGV Command Error:', err);
    alert('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á AGV ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
}

function handleSlotManual() {
  const slot = document.getElementById("slotSelectManual").value;
  if (!slot) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }
  const cmd = `go_slot${slot}`;
  sendAgvCommand(cmd);
}


async function sendTrayCommand(command) {
  try {
    const res = await fetch('/api/tray/manual', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id,
       station: currentStation, // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ currentStation
        command  // ‡πÄ‡∏ä‡πà‡∏ô tray_up, tray_down
      })
    });
    const data = await res.json();
    console.log('‚úÖ TRAY command sent:', data.message);
  } catch (err) {
    console.error('‚ùå Tray Command Error:', err);
    alert('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á TRAY ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
}





async function loadTaskHistory() {
  try {
    const res = await fetch('/api/task/history');
    const data = await res.json();

    const tableBody = document.getElementById('taskHistoryTableBody');
    tableBody.innerHTML = '';

    data.forEach(task => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${task.tray_id}</td>  <!-- ‚úÖ ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
        <td>${task.floor}</td>
        <td>${task.slot}</td>
        <td><span class="status ${task.status}">${task.status.toUpperCase()}</span></td>
        <td>${new Date(task.created_at).toLocaleString()}</td>
        <td>${new Date(task.completed_at).toLocaleString()}</td>
        <td>${task.action_type}</td>
        <td>${task.username}</td>
      `;
      tableBody.appendChild(row);
    });
  } catch (err) {
    console.error("‚ùå Failed to load task history:", err);
  }
}
// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Tray Master ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
async function loadTrayMasterData() {
    try {
        const res = await fetch('/api/tray-inventory');
        const trays = await res.json();
        const tbody = document.getElementById('trayMasterTableBody');

        if (!tbody) return;
        tbody.innerHTML = '';

        const searchQuery = document.getElementById('traySearchInput').value.toLowerCase();
        const statusFilter = document.getElementById('trayStatusFilter').value;
        const vegFilter = document.getElementById('trayVegFilter').value;

        const filteredTrays = trays.filter(tray => {
            const searchMatch = (
                tray.tray_id.toLowerCase().includes(searchQuery) ||
                (tray.batch_id || '').toLowerCase().includes(searchQuery) ||
                tray.veg_type.toLowerCase().includes(searchQuery)
            );
            const statusMatch = !statusFilter || tray.status === statusFilter;
            const vegMatch = !vegFilter || tray.veg_type === vegFilter;
            return searchMatch && statusMatch && vegMatch;
        });

        if (filteredTrays.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á</td></tr>';
            return;
        }

        filteredTrays.forEach((tray, index) => {
            const age = calculateTrayAge(tray.time_in);
            const row = document.createElement('tr');

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô
            row.className = 'fade-in-row';
            row.style.animationDelay = `${index * 50}ms`;

            // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà
            row.innerHTML = `
                <td>${tray.tray_id}</td>
                <td>${tray.batch_id || '-'}</td>
                <td>${tray.veg_type}</td>
                <td>‡∏ä‡∏±‡πâ‡∏ô ${tray.floor} / ‡∏ä‡πà‡∏≠‡∏á ${tray.slot}</td>
                <td>${tray.plant_quantity || '-'}</td>
                <td>${tray.seeding_date ? new Date(tray.seeding_date).toLocaleDateString('th-TH') : '-'}</td>
                <td>${age}</td>
                <td>${renderTrayStatusLabel(tray.status)}</td>
                <td>${tray.notes || '-'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn edit" onclick="editTray('${tray.tray_id}')">
                            <i class="fas fa-pencil-alt"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                        <button class="action-btn history" onclick="toggleTrayHistory('${tray.tray_id}', this)">
                            <i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);

            const historyRow = document.createElement('tr');
            historyRow.className = 'history-row';
            historyRow.id = `history-${tray.tray_id}`;
            historyRow.style.display = 'none';
            historyRow.innerHTML = `<td colspan="10"></td>`;
            tbody.appendChild(historyRow);
        });

    } catch (err) {
        console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Tray Master ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
        const tbody = document.getElementById('trayMasterTableBody');
        if(tbody) tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding: 20px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
    }
}

// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
function renderTrayStatusLabel(status) {
    if (status === 'on_shelf' || status === 'IN_STORAGE') {
        return `<span class="status-badge on-shelf"><i class="fas fa-warehouse"></i> ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</span>`;
    }
    if (status === 'AT_WORKSTATION') {
        return `<span class="status-badge at-workstation"><i class="fas fa-wrench"></i> ‡∏ó‡∏µ‡πà Workstation</span>`;
    }
    return status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
}
// Function ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô)
function editTray(trayId) {
    alert(`‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ñ‡∏≤‡∏î ID: ${trayId}`);
    // ‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal popup ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    // ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á request ‡πÑ‡∏õ‡∏ó‡∏µ‡πà API ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
}


let workstationTimer = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö interval
let currentWorkstationState = null; // ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Workstation
// ‚úÖ‚úÖ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Workstation ‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ ‚úÖ‚úÖ‚úÖ
async function checkWorkstationStatus() {
    try {
        const res = await fetch(`/api/workstation/current?station=${currentStation}`);
        const waitingTray = await res.json();
        const displayDiv = document.getElementById('workstationDisplay');

        if (!displayDiv) return;

        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ñ‡∏≤‡∏î (‡∏°‡∏µ ID ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô null)
        const newState = waitingTray ? waitingTray.tray_id : null;

        // 2. ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏ß‡πâ
        if (newState === currentWorkstationState) {
            // 3. ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° -> ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            return; 
        }

        // 4. ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô -> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏ß‡πâ
        currentWorkstationState = newState;

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) ---
        if (waitingTray) {
            const reason = waitingTray.reason || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
            let actionHTML = '';

            switch (reason.toLowerCase()) {
                case '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á':
                    actionHTML = `<button class="form-button-action danger" onclick="disposeTray('${waitingTray.tray_id}')"><i class="fas fa-trash-alt"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á</button>`;
                    break;
                case '‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡∏≤‡∏î':
                    actionHTML = `<button class="form-button-action" style="background: linear-gradient(135deg, #60A5FA, #3B82F6);" onclick="returnTrayToStorage('relocate')"><i class="fas fa-random"></i> ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</button>`;
                    break;
                default:
                    actionHTML = `
                        <div class="popup-actions">
                            <button class="popup-button cancel" onclick="disposeTray('${waitingTray.tray_id}')"><i class="fas fa-check-circle"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å)</button>
                            <button class="popup-button confirm" onclick="returnTrayToStorage('return')"><i class="fas fa-arrow-left"></i> ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</button>
                        </div>`;
                    break;
            }

            displayDiv.innerHTML = `
                <div class="popup-container" style="max-width: 700px; margin: 20px auto; animation: popIn 0.4s ease-out;">
                    <div class="popup-header">
                        <i class="fas fa-box-open icon" style="color: #FBBF24;"></i>
                        <h2 class="popup-title">‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h2>
                        <p class="popup-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ñ‡∏≤‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ</p>
                    </div>
                    <div class="popup-summary">
                        <div class="summary-item"><span class="summary-label">Tray ID</span><span class="summary-value">${waitingTray.tray_id}</span></div>
                        <div class="summary-item"><span class="summary-label">‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</span><span class="summary-value highlight">${waitingTray.veg_type || 'N/A'}</span></div>
                        <div class="summary-item"><span class="summary-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å</span><span class="summary-value" style="font-weight: 700;">${reason}</span></div>
                    </div>
                    <div class="popup-actions" style="grid-template-columns: 1fr; margin-top: 25px;">${actionHTML}</div>
                </div>
            `;
        } else {
            displayDiv.innerHTML = `
                <div class="agv-status-box" style="--boxColor: #6c757d; margin-top: 20px;">
                    <div class="agv-status-title"><i class="fas fa-pause-circle"></i> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>
                    <div class="agv-status-desc">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏µ‡πà Home ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
                </div>
            `;
        }

    } catch(err) {
        console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Workstation ‡πÑ‡∏î‡πâ", err);
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î error ‡∏Å‡πá‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô
        currentWorkstationState = 'error'; // ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ß‡∏ô‡∏ã‡πâ‡∏≥‡∏ñ‡πâ‡∏≤ error ‡∏ï‡∏•‡∏≠‡∏î
    }
}





// ‚úÖ‚úÖ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö tray_id ‡πÄ‡∏õ‡πá‡∏ô parameter ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‚úÖ‚úÖ‚úÖ
async function disposeTray(tray_id) {
    if (!tray_id) {
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Tray ID', false);
        return;
    }

    showConfirmationPopup({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ñ‡∏≤‡∏î',
        subtitle: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î ID: ${tray_id} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`,
        icon: 'fa-trash-alt', // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞
        details: [
            { label: 'Tray ID ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö', value: tray_id, highlight: true },
            { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', value: '‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£' }
        ],
        onConfirm: async () => {
            try {
                await fetch('/api/workstation/dispose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tray_id: tray_id, station_id: currentStation })
                });
                showToast(`‚úÖ ‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î ID: ${tray_id} ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß`, true);
                checkWorkstationStatus(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            } catch(err) {
                showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å', false);
            }
        }
    });
}

// ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô editTray ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
async function editTray(trayId) {
    // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏à‡∏≤‡∏Å trayInventory ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    const tray = Object.values(trayInventory).find(t => t.tray_id === trayId);
    if (!tray) {
        showToast("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î", false);
        return;
    }

    // ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏á Modal
    document.getElementById("editTrayId").value = tray.tray_id;
    document.getElementById("editVegType").value = tray.veg_type || '';
    document.getElementById("editPlantQuantity").value = tray.plant_quantity || '';
    document.getElementById("editBatchId").value = tray.batch_id || '';
    // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ input type="date" ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ (YYYY-MM-DD)
    document.getElementById("editSeedingDate").value = tray.seeding_date ? new Date(tray.seeding_date).toISOString().split('T')[0] : '';
    document.getElementById("editNotes").value = tray.notes || '';

    // ‡πÅ‡∏™‡∏î‡∏á Modal
    document.getElementById("editTrayModal").style.display = 'flex';
}

// ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal
function closeEditModal() {
    document.getElementById("editTrayModal").style.display = 'none';
}

// ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ Backend
async function handleUpdateTray() {
    const trayId = document.getElementById("editTrayId").value;
    const updatedData = {
        veg_type: document.getElementById("editVegType").value,
        plant_quantity: document.getElementById("editPlantQuantity").value,
        batch_id: document.getElementById("editBatchId").value,
        seeding_date: document.getElementById("editSeedingDate").value,
        notes: document.getElementById("editNotes").value
    };

    try {
        const res = await fetch(`/api/tray-inventory/${trayId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData)
        });
        const result = await res.json();

        if (result.error) {
            showToast(`‚ùå ${result.error}`, false);
        } else {
            showToast(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, true);
            closeEditModal();
            loadTrayMasterData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            loadTrayInventory();  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Grid View ‡∏î‡πâ‡∏ß‡∏¢
        }
    } catch(err) {
        showToast("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï", false);
    }
}




let returnTrayData = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô
async function returnTrayToStorage(mode = 'return') {
    const res = await fetch(`/api/workstation/current?station=${currentStation}`);
    const waitingTray = await res.json();
    
    if (!waitingTray) {
        showToast("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà Workstation", false);
        return;
    }

    const modal = document.getElementById('returnTrayModal');
    const titleElement = modal.querySelector('.popup-title');
    const confirmButton = modal.querySelector('.popup-button.confirm');

    const qtyInput = document.getElementById("returnPlantQuantity");
    const dateInput = document.getElementById("returnSeedingDate");
    const notesInput = document.getElementById("returnNotes");

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Title ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
    if (mode === 'relocate') {
        titleElement.innerHTML = `<i class="fas fa-random icon" style="color:#60A5FA;"></i> ‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡∏≤‡∏î`;
        confirmButton.innerHTML = `<i class="fas fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á`;
        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        [qtyInput, dateInput, notesInput].forEach(el => {
            el.disabled = true;
            el.style.backgroundColor = '#e9ecef';
            el.style.cursor = 'not-allowed';
        });
    } else { 
        titleElement.innerHTML = `<i class="fas fa-arrow-left icon"></i> ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á`;
        confirmButton.innerHTML = `<i class="fas fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö`;
        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        [qtyInput, dateInput, notesInput].forEach(el => {
            el.disabled = false;
            el.style.backgroundColor = '';
            el.style.cursor = '';
        });
    }

    // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    document.getElementById("returnVegType").value = waitingTray.veg_type || '';
    qtyInput.value = waitingTray.plant_quantity || '';
    document.getElementById("returnBatchId").value = waitingTray.batch_id || '';
    dateInput.value = waitingTray.seeding_date ? new Date(waitingTray.seeding_date).toISOString().split('T')[0] : '';
    notesInput.value = waitingTray.notes || '';
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ onclick ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    confirmButton.setAttribute('onclick', `handleReturnToStorage('${waitingTray.tray_id}', ${waitingTray.station_id})`);
    
    modal.style.display = 'flex';
}

async function handleReturnToStorage(tray_id, station_id) {
    if (!tray_id) {
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Tray ID ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö', false);
        return;
    }

    // 1. ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
    const newFloor = document.getElementById('returnFloor').value;
    const newSlot = document.getElementById('returnSlot').value;
    const dataToSend = {
        tray_id: tray_id,
        veg_type: document.getElementById("returnVegType").value,
        quantity: document.getElementById("returnPlantQuantity").value,
        batch_id: document.getElementById("returnBatchId").value,
        seeding_date: document.getElementById("returnSeedingDate").value,
        notes: document.getElementById("returnNotes").value,
        floor: newFloor,
        slot: newSlot,
        username: localStorage.getItem("username"),
        station: currentStation,
    };
    
    try {
        // 2. ‚úÖ [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà Workstation ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Flow State ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 'idle'
        const completeRes = await fetch('/api/workstation/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                tray_id: tray_id, 
                station_id: station_id || currentStation 
            })
        });

        if (!completeRes.ok) {
            const errData = await completeRes.json();
            throw new Error(errData.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà Workstation ‡πÑ‡∏î‡πâ');
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Delay ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Server ‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï State
        await new Promise(resolve => setTimeout(resolve, 200));

        // 3. ‚úÖ [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö idle ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∂‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏° Flow ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏Å‡∏•‡∏±‡∏ö (Inbound)
        const inboundRes = await fetch("/api/tray/inbound", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dataToSend)
        });
        const result = await inboundRes.json();
        
        if (result.error) {
           showToast(`‚ùå ${result.error}`, false);
        } else {
           showToast(`‚úÖ ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡πà‡∏á‡∏ñ‡∏≤‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß...`, true);
           closeReturnModal();
           refreshDataAndViews();
           checkWorkstationStatus(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Workstation
           loadTrayInventory();    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á
        }
    } catch (err) {
        console.error("‚ùå Error during return to storage:", err);
        showToast(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ñ‡∏≤‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ: ${err.message}`, false);
    }
}

function closeReturnModal() {
    document.getElementById('returnTrayModal').style.display = 'none';
}



async function refreshDataAndViews() {
  console.log("üîÑ Refreshing data and relevant views...");
  
  // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å 2 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏™‡∏°‡∏≠
  await Promise.all([
    loadTrayInventory(),
    loadTrayMasterData() // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Tray Master ‡∏î‡πâ‡∏ß‡∏¢
  ]);

  // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏î‡∏ã‡πâ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  if (currentPage === 'tray-map') {
    renderTrayGrid();
  } else if (currentPage === 'tray-master') {
    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ loadTrayMasterData() ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß
  } else if (currentPage === 'workstation') {
    checkWorkstationStatus();
  } else if (currentPage === 'tray-outbound') {
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß
    checkOutboundSlot(); 
  }
  
  console.log("‚úÖ Refresh complete.");
}




// ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å
let selectedOutboundTray = null;
// ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Inbound
function validateInboundSlot() {
    const floor = document.getElementById("inFloor").value;
    const slot = document.getElementById("inSlot").value;
    const statusDiv = document.getElementById("inboundSlotStatus");
    const confirmBtn = document.getElementById("inboundConfirmBtn");

    if (!floor || !slot) {
        statusDiv.innerHTML = "";
        confirmBtn.disabled = true; // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
        return;
    }

    const key = `${floor}-${slot}`;
    if (trayInventory[key] && trayInventory[key].status === 'on_shelf') {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á ---
        statusDiv.innerHTML = `
            <div style="padding: 14px; background: #fffbeb; color: #b45309; border-left: 5px solid #facc15; border-radius: 8px; font-weight: 600;">
                ‚ö†Ô∏è ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏ß‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
            </div>`;
        confirmBtn.disabled = true;
    } else {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ---
        statusDiv.innerHTML = `
            <div style="padding: 14px; background: #f0fdf4; color: #166534; border-left: 5px solid #4ade80; border-radius: 8px; font-weight: 600;">
                ‚úÖ ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤‡∏á ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡πÑ‡∏î‡πâ
            </div>`;
        confirmBtn.disabled = false;
    }
}
// ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô
function validateOutboundFloor() {
    const selectedFloor = document.getElementById("outFloor").value;
    const validationBox = document.getElementById("outboundValidationBox");
    const confirmBtn = document.getElementById("outboundConfirmBtn");
    const reasonSelect = document.getElementById("outReason");
    const destinationInput = document.getElementById("outDestination");

    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏±‡πâ‡∏ô
    selectedOutboundTray = null;
    validationBox.style.display = 'none';
    validationBox.innerHTML = '';
    confirmBtn.disabled = true;
    reasonSelect.disabled = true;
    destinationInput.disabled = true;

    if (!selectedFloor) return; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ñ‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 'on_shelf'
    const traysOnFloor = Object.values(trayInventory).filter(
        tray => tray.floor == selectedFloor && tray.status === 'on_shelf'
    );

    validationBox.style.display = 'block';

    if (traysOnFloor.length === 0) {
        // ---- ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ñ‡∏≤‡∏î‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏±‡πâ‡∏ô ----
        validationBox.innerHTML = `
            <div class="warning-message" style="background: #fffbeb; color: #b45309; border-left-color: #fde68a;">
                <i class="fas fa-info-circle"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô ${selectedFloor}
            </div>
        `;
        return;
    }

    // ---- ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏à‡∏≠‡∏ñ‡∏≤‡∏î -> ‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏Ç‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î) ----
    const frontTray = traysOnFloor.reduce((prev, curr) => (prev.slot < curr.slot ? prev : curr));
    selectedOutboundTray = frontTray; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ

    const formattedDate = new Date(frontTray.time_in).toLocaleDateString('th-TH');
    validationBox.innerHTML = `
        <div style="background-color: #f0fdf4; padding: 15px; border-radius: 12px; border: 1px solid #bbf7d0; color: #166534; font-weight: 600;">
            <i class="fas fa-check-circle"></i> ‡∏û‡∏ö‡∏ñ‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î: <strong>${frontTray.veg_type}</strong> (‡∏ä‡πà‡∏≠‡∏á ${frontTray.slot})<br>
            <small>‡∏ß‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formattedDate}</small>
        </div>
    `;

    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏î‡πâ
    confirmBtn.disabled = false;
    reasonSelect.disabled = false;
    destinationInput.disabled = false;
}







</script>

<!-- ‚úÖ Popup ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
<div id="trayPopup" style="
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: #52b788;
  color: white;
  padding: 16px 26px;
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  font-size: 1.1em;
  font-weight: 600;
  z-index: 9999;
  display: none;
  animation: fadeInUp 0.3s ease;
">
  ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
</div>


</body>


</html>
