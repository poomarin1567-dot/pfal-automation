<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AGROTECH WMS - Login</title>

  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <!-- เพิ่ม Font Awesome (เฉพาะถ้ายังไม่มี) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

  <style>

      /* --- ✨ Premium Light & Fan Control Panel CSS ✨ --- */

      .light-control-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 28px;
        margin-top: 25px;
      }

      .control-card {
        background: linear-gradient(145deg, var(--card-bg), #F9FAFB);
        border-radius: 24px;
        padding: 28px;
        border: 1px solid var(--card-border);
        box-shadow: var(--shadow-base);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        animation: popIn 0.5s ease-out forwards;
        opacity: 0;
      }

      .control-card:hover {
        transform: translateY(-8px) scale(1.01);
        box-shadow: var(--shadow-hover);
      }

      .control-card h3 {
        display: flex;
        align-items: center;
        gap: 14px;
        font-size: 1.3em;
        font-weight: 600;
        color: var(--primary-dark);
        margin: 0 0 25px 0;
        padding-bottom: 18px;
        border-bottom: 1px solid #eef2f7;
      }
       .control-card h3 i {
        font-size: 1.2em;
        color: var(--primary-light);
       }


      .control-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 10px;
         border-bottom: 1px solid #f3f4f6;
      }
       .control-card .control-row:last-of-type {
        border-bottom: none;
        padding-bottom: 5px; /* Less padding for the last item */
      }


      .control-label {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 1.05em;
        font-weight: 500;
        color: var(--text-dark);
      }
      .control-label i {
        font-size: 1.4em;
        width: 32px;
        text-align: center;
        color: var(--text-light);
        transition: color 0.3s, transform 0.3s;
      }

       /* Icon Colors */
      .control-label .fa-lightbulb.red { color: #f97316; }
      .control-label .fa-lightbulb.white { color: #f59e0b; }
      .control-label .fa-fan { color: #3b82f6; }


      .status-indicator {
          font-size: 0.85em;
          font-weight: 600;
          color: var(--text-light);
          background-color: #f8fafc;
          padding: 5px 12px;
          border-radius: 16px;
          border: 1px solid #e2e8f0;
          margin-left: 8px;
          min-width: 50px;
          text-align: center;
      }

       .control-actions {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      /* ✨ Living Buttons ✨ */
      .light-btn {
          padding: 9px 18px;
          border-radius: 10px;
          border: 1px solid transparent;
          cursor: pointer;
          font-weight: 600;
          font-size: 0.9em;
          transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
          display: inline-flex;
          align-items: center;
          gap: 8px;
      }

      .light-btn.on {
          background-color: #dcfce7;
          color: #166534;
          border-color: #86efac;
      }
       .light-btn.on:hover {
        background-color: #bbf7d0;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(74, 222, 128, 0.2);
       }


      .light-btn.off {
          background-color: #f1f5f9;
          color: #475569;
           border-color: #e2e8f0;
      }
      .light-btn.off:hover {
        background-color: #e2e8f0;
         transform: translateY(-2px);
         box-shadow: 0 4px 12px rgba(100, 116, 139, 0.1);
      }


      /* ✨ Animated Dimmer Slider ✨ */
      .dimmer-slider {
        -webkit-appearance: none; appearance: none;
        width: 120px; height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        outline: none;
        transition: background .3s;
        cursor: pointer;
      }
      .dimmer-slider:hover {
        background: #cbd5e1;
      }
      .dimmer-slider::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none;
        width: 20px; height: 20px;
        background: var(--primary-light);
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: transform 0.2s ease;
      }
       .dimmer-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
      }

      .dimmer-value {
        font-weight: 600;
        width: 55px;
        text-align: right;
        color: var(--primary-dark);
        background-color: #f8fafc;
        padding: 4px 8px;
        border-radius: 8px;
      }

      /* ✨ Global Control Panel ✨ */
      .global-control-panel {
          background: #fff;
          border-radius: 24px;
          padding: 25px 35px;
          margin-bottom: 30px;
          box-shadow: var(--shadow-base);
          border: 1px solid var(--card-border);
      }
      .global-control-panel h3 {
        color: var(--primary-dark);
        font-size: 1.4em;
        margin-bottom: 8px;
      }
       .global-control-panel p {
        color: var(--text-light);
        margin-top: 0;
        margin-bottom: 20px;
      }

      .global-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
      }

      .global-btn {
        flex-grow: 1;
        padding: 12px 20px;
        font-size: 1em;
        font-weight: 600;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .global-btn.all-on {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2);
      }
       .global-btn.all-on:hover {
        transform: translateY(-3px);
         box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
       }


      .global-btn.all-off {
        background: linear-gradient(135deg, #f43f5e, #e11d48);
         color: white;
         box-shadow: 0 4px 15px rgba(244, 63, 94, 0.2);
      }
        .global-btn.all-off:hover {
        transform: translateY(-3px);
         box-shadow: 0 6px 20px rgba(244, 63, 94, 0.3);
       }



/* ✨ HYPER PREMIUM OVERVIEW CSS ✨ */

:root {
  --primary-dark: #2d6a4f;
  --primary-light: #52b788;
  --accent-blue: #3b82f6;
  --accent-orange: #f97316;
  --accent-purple: #8b5cf6;
  --card-bg: #ffffff;
  --card-border: #f0f2f5;
  --text-dark: #111827;
  --text-light: #6b7280;
  --shadow-base: 0 5px 15px rgba(0, 0, 0, 0.04), 0 15px 35px rgba(0, 0, 0, 0.05);
  --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.06), 0 20px 50px rgba(0, 0, 0, 0.07);
}

@keyframes popIn {
    0% {
        opacity: 0;
        transform: translateY(25px) scale(0.98);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* --- พื้นหลัง Content --- */
.content {
  background-color: #f8fafc;
  background-image:
    radial-gradient(circle at 1px 1px, rgba(0,0,0,0.02) 1px, transparent 0);
  background-size: 25px 25px;
}

/* --- Title หลัก --- */
.overview-title {
    font-size: 2.2rem;
    font-weight: 700;
    color: var(--primary-dark);
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    gap: 16px;
    animation: popIn 0.5s ease-out;
    text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.6);
}
.overview-title i {
    color: var(--primary-light);
    filter: drop-shadow(0 3px 5px rgba(82, 183, 136, 0.3));
}

/* --- Hyper Premium Summary Cards --- */
.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 30px;
  margin-bottom: 40px;
}

.summary-card {
  background: linear-gradient(145deg, var(--card-bg), #F9FAFB);
  border-radius: 24px;
  padding: 28px;
  display: flex;
  align-items: center;
  gap: 22px;
  border: 1px solid var(--card-border);
  box-shadow: var(--shadow-base);
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  animation: popIn 0.6s ease-out forwards;
  opacity: 0;
  position: relative;
  overflow: hidden;
}

/* เอฟเฟกต์แสงวิ่งบนการ์ดเมื่อ Hover */
.summary-card::after {
    content: "";
    position: absolute;
    top: 0;
    left: -150%;
    width: 100%;
    height: 100%;
    background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.5) 50%, transparent 100%);
    transform: skewX(-25deg);
    transition: left 0.6s ease;
}
.summary-card:hover::after {
    left: 150%;
}

.summary-card:hover {
  transform: translateY(-10px) scale(1.02);
  box-shadow: var(--shadow-hover);
  border-color: var(--primary-light);
}

/* Staggered animation */
.summary-card:nth-child(1) { animation-delay: 0.1s; }
.summary-card:nth-child(2) { animation-delay: 0.2s; }
.summary-card:nth-child(3) { animation-delay: 0.3s; }
.summary-card:nth-child(4) { animation-delay: 0.4s; }

.summary-card .icon {
  font-size: 2.4rem;
  width: 72px;
  height: 72px;
  border-radius: 22px;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  box-shadow: 0 6px 12px rgba(0,0,0,0.1), inset 0 2px 4px rgba(0,0,0,0.1);
  text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  border: 2px solid rgba(255, 255, 255, 0.3);
}
.summary-card .icon.inbound { background: linear-gradient(135deg, var(--primary-dark), var(--primary-light)); }
.summary-card .icon.outbound { background: linear-gradient(135deg, #d97706, var(--accent-orange)); }
.summary-card .icon.total { background: linear-gradient(135deg, #2563eb, var(--accent-blue)); }
.summary-card .icon.ontime { background: linear-gradient(135deg, #7c3aed, var(--accent-purple)); }

.summary-card .info .value {
  font-size: 2.8rem;
  font-weight: 700;
  color: var(--text-dark);
  line-height: 1.1;
  margin-bottom: 4px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.summary-card .info .label {
  font-size: 1.05em;
  font-weight: 500;
  color: var(--text-light);
  letter-spacing: 0.5px;
}

/* --- Hyper Premium Chart Cards --- */
.overview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 30px;
}

.overview-card {
  background: var(--card-bg);
  border-radius: 28px;
  padding: 35px;
  box-shadow: var(--shadow-base);
  border: 1px solid var(--card-border);
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  animation: popIn 0.6s ease-out forwards;
  opacity: 0;
}

.overview-grid .overview-card:nth-child(1) { animation-delay: 0.5s; }
.overview-grid .overview-card:nth-child(2) { animation-delay: 0.6s; }
.overview-grid .overview-card:nth-child(3) { animation-delay: 0.7s; }

.overview-card:hover {
  transform: translateY(-10px);
  box-shadow: var(--shadow-hover);
}

.overview-card h3 {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 1.4em;
  font-weight: 600;
  color: var(--primary-dark);
  margin: 0 0 30px 0;
  padding-bottom: 20px;
  border-bottom: 1px solid #eef2f7;
}

.overview-card h3 i {
  font-size: 1.3em;
  color: var(--primary-light);
}

#pieChartContainer, .chart-container {
  height: 320px;
  display: flex;
  justify-content: center;
  align-items: center;
}





/* icon pfal  wms dashborad*/

.premium-logo {
  font-size: 2.5em;
  font-weight: 700;
  font-family: 'Prompt', sans-serif;
  display: inline-flex;
  align-items: center;
  gap: 12px;
  background: linear-gradient(to right, #2d6a4f, #74c69d);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  white-space: nowrap;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
  animation: fadeSlideIn 1s ease-out both;
}

.premium-logo i {
  width: 1.4em;
  height: 1.4em;
  color: #52b788;
  stroke-width: 2.2;
  filter: drop-shadow(0 0 4px rgba(82, 183, 136, 0.2));
  animation: iconBounce 0.8s ease;
}

/* Animation */
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateX(-30px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes iconBounce {
  0%   { transform: scale(0.8); opacity: 0; }
  50%  { transform: scale(1.3); opacity: 1; }
  100% { transform: scale(1); }
}



/* 3. สไตล์สำหรับ Dropdown เลือก Station */
.station-dropdown {
  -webkit-appearance: none; /* สำหรับ Safari/Chrome */
  appearance: none; /* ซ่อนลูกศร default */
  padding: 10px 40px 10px 18px; /* เพิ่มที่ว่างด้านขวาสำหรับลูกศรใหม่ */
  border-radius: 12px;
  border: 1px solid #b7e4c7;
  background-color: #ffffff;
  font-size: 1.05em;
  font-weight: 600;
  color: #1b4332;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  transition: all 0.2s ease-in-out;
  
  /* ลูกศรใหม่ (SVG) */
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%231b4332' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
}

.station-dropdown:hover {
  border-color: #52b788;
  box-shadow: 0 4px 12px rgba(82, 183, 136, 0.15);
}

.station-dropdown:focus {
  outline: none;
  border-color: #40916c;
  box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.3);
}











/* ✅ ดีไซน์ใหม่สำหรับป้ายสถานะ (Status Badge) traymaster */
/* ✨ [เพิ่มใหม่] อนิเมชั่นสำหรับแถวในตาราง Tray Master ✨ */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-in-row {
  opacity: 0;
  animation: fadeInUp 0.5s ease-out forwards;
}

/* 🎨 [อัปเกรด] ดีไซน์สำหรับป้ายสถานะและปุ่มคำสั่ง 🎨 */
.status-badge {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 6px 14px; border-radius: 20px;
    font-weight: 600; font-size: 0.9em;
    border: 1px solid transparent;
}
.status-badge.on-shelf {
    background-color: #e6f4ea; color: #1b4332; border-color: #a7d7b9;
}
.status-badge.at-workstation {
    background-color: #fffbeb; color: #b45309; border-color: #fde68a;
}
.action-btn {
    display: inline-flex; align-items: center; justify-content: center;
    gap: 6px; padding: 9px 18px; border-radius: 10px;
    border: none; cursor: pointer; font-weight: 600;
    font-size: 0.9em; transition: all 0.2s ease-in-out;
    min-width: 90px;
}
.action-btn.edit { background-color: #f97316; color: white; }
.action-btn.edit:hover {
    background-color: #ea580c; transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
}
.action-btn.history { background-color: #4b5563; color: white; }
.action-btn.history:hover {
    background-color: #374151; transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(75, 85, 99, 0.3);
}/* ✅ ดีไซน์ใหม่สำหรับป้ายสถานะ (Status Badge) traymaster */





/* ✅ Style สำหรับแถวประวัติที่เพิ่มเข้ามาใหม่ */
.history-row td {
  background-color: #f8f9fa;
  padding: 20px !important;
  border-bottom: 2px solid #52b788;
}
.history-table {
  width: 100%;
  border-collapse: collapse;
  margin: 0 auto;
}
.history-table th, .history-table td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #e0e0e0;
}
.history-table th {
  background-color: #2d6a4f; /* 🎨 สีเขียวเข้มเหมือนตารางหลัก */
  color: #ffffff; /* 🎨 ตัวอักษรสีขาว */
  font-weight: 600;
}
.history-row .action-inbound { 
    color: #1b4332; /* ✅ เปลี่ยนเป็นสีเขียวเข้มเพื่อให้อ่านง่าย */
    font-weight: bold; 
}
.history-row .action-outbound { color: #ef4444; font-weight: bold; }


/**
 * ✅ [เพิ่มใหม่] CSS ทำให้กล่องข้อความแจ้งเตือนสวยงาม
 */
#outboundValidationBox {
  padding: 18px;
  border-radius: 12px;
  border-width: 1px;
  border-style: solid;
  transition: all 0.3s ease-in-out;
  animation: fadeIn 0.4s;
}

#outboundValidationBox p {
  margin: 0;
  font-size: 1.05em;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* สถานะเมื่อเจอถาด (Success) */
#outboundValidationBox.success {
  background-color: #f0fdf4; /* เขียวอ่อน */
  border-color: #bbf7d0;
  color: #166534;
}

/* สถานะเมื่อไม่เจอถาด (Warning) */
#outboundValidationBox.warning {
  background-color: #fffbeb; /* เหลืองอ่อน */
  border-color: #fde68a;
  color: #b45309;
}
/* ✅ 💅 CSS สำหรับ Pop-up ยืนยันข้อมูลแบบละเอียด */
/* ✅ Pop-up Styling (ฉบับสมบูรณ์) */
.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(31, 41, 55, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(5px);
  opacity: 0;
  animation: fadeIn 0.3s ease-out forwards;
}

.popup-container {
  background: #ffffff;
  padding: 35px 40px;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  width: 90%;
  max-width: 520px;
  transform: scale(0.95);
  animation: popIn 0.3s ease-out forwards;
}

.popup-header {
  text-align: center;
  margin-bottom: 25px;
}

.popup-header .icon {
  font-size: 3rem;
  color: #10B981; /* สีเขียว (Default) */
}

/* ✅ [เพิ่มใหม่] ทำให้ไอคอนเป็นสีแดงเมื่องานเป็น Outbound */
.popup-header .icon.danger {
    color: #e63946;
}

.popup-title {
  font-size: 1.6em;
  font-weight: 700;
  color: #1F2937;
  margin-top: 15px;
  margin-bottom: 8px;
}

.popup-subtitle {
  font-size: 1.1em;
  color: #6B7280;
  margin: 0;
}

.popup-summary {
  background-color: #F9FAFB;
  border-radius: 12px;
  padding: 20px;
  border: 1px solid #E5E7EB;
  margin-top: 20px;
}

.summary-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  font-size: 1.05em;
  border-bottom: 1px solid #F3F4F6;
}

.summary-item:last-child {
  border-bottom: none;
}

.summary-label {
  color: #4B5563;
  font-weight: 500;
}

.summary-value {
  color: #111827;
  font-weight: 600;
  text-align: right;
  word-break: break-all;
}

.summary-value.highlight {
  color: #059669;
  font-weight: 700;
}

.popup-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-top: 30px;
}

.popup-button {
  padding: 14px;
  font-size: 1.1em;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.popup-button.cancel {
  background-color: #E5E7EB;
  color: #4B5563;
  border: 1px solid #D1D5DB;
}

.popup-button.cancel:hover {
  background-color: #D1D5DB;
}

/* -- ปุ่มยืนยัน -- */
.popup-button.confirm {
  background: linear-gradient(135deg, #10B981, #059669);
  color: white;
}

.popup-button.confirm:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

/* ✅ [เพิ่มใหม่] สไตล์สำหรับปุ่มยืนยันสีแดง */
.popup-button.confirm.danger {
  background: linear-gradient(135deg, #e63946, #b91c1c);
}

.popup-button.confirm.danger:hover {
  background: linear-gradient(135deg, #b91c1c, #9a141a);
  box-shadow: 0 4px 15px rgba(229, 62, 77, 0.3);
}


/* === 💅 Deluxe Form Styling === */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

body {
    background: #f0f2f5; /* A softer, more modern background */
    font-family: 'Inter', sans-serif;
}

.form-container-deluxe {
    max-width: 850px;
    margin: 50px auto;
    padding: 45px;
    background: #ffffff;
    border-radius: 24px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
    border: 1px solid #e5e7eb;
    overflow: hidden;
}

.form-header {
    text-align: center;
    margin-bottom: 40px;
}

.form-title {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    font-size: 2.2em; /* Larger, more impactful title */
    font-weight: 700;
    color: #111827;
    margin: 0 0 8px 0;
}

.form-title i {
    color: #10B981; /* A fresh, vibrant green */
}

.form-subtitle {
    font-size: 1.1em;
    color: #6B7280;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 28px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 10px;
    font-size: 0.9em;
}

.form-group label i {
    color: #9CA3AF;
    font-size: 1.1em;
}

.form-input-deluxe {
    width: 100%;
    padding: 14px 18px;
    border: 1px solid #D1D5DB;
    border-radius: 12px;
    font-size: 1em;
    font-family: 'Inter', sans-serif;
    color: #1F2937;
    background-color: #F9FAFB;
    transition: all 0.2s ease-in-out;
}

.form-input-deluxe:focus {
    outline: none;
    border-color: #10B981;
    background-color: #ffffff;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
}

.form-input-deluxe::placeholder {
    color: #9CA3AF;
}

textarea.form-input-deluxe {
    resize: vertical;
    padding-top: 14px;
}

.form-button-action {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    padding: 18px;
    font-size: 1.15em;
    font-weight: 700;
    color: white;
    background: linear-gradient(135deg, #10B981, #059669);
    border: none;
    border-radius: 14px;
    cursor: pointer;
    margin-top: 30px;
    box-shadow: 0 5px 20px rgba(16, 185, 129, 0.2);
    transition: all 0.3s ease;
}

.form-button-action:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
}

.form-button-action.danger {
    background: linear-gradient(135deg, #EF4444, #DC2626);
    box-shadow: 0 5px 20px rgba(239, 68, 68, 0.2);
}

.form-button-action.danger:hover {
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
}

/* Responsive adjustments for smaller screens */
@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    .form-container-deluxe {
        padding: 30px;
    }
    .form-title {
        font-size: 1.8em;
    }
}

/* ✅ กลุ่มแสดงกล้องแบบพรีเมียม */
.camera-section {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  justify-content: center;
  align-items: stretch;
  margin-top: 30px;
  padding: 10px 0;
}

/* ✅ กล่องกล้องสุดหรู */
.camera-box {
  position: relative;
  flex: 1 1 42%;
  max-width: 720px;
  aspect-ratio: 16 / 9;
  background: #000;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.06);
  backdrop-filter: blur(3px);
}

.camera-box:hover {
  transform: scale(1.015);
  box-shadow: 0 12px 36px rgba(0, 0, 0, 0.4);
}

/* ✅ กล้องปกติ (แนวนอน) */
.camera-box img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

/* ✅ กล้องที่ต้องหมุนซ้าย (เช่น RGV ติดแนวตั้ง) */
.camera-box .rotate-left {
  transform: rotate(-90deg);
  transform-origin: center center;
  position: absolute;
  top: 50%;
  left: 50%;
  width: 160%;      /* ✅ ขยายความกว้างให้เต็มกล่อง */
  height: auto;
  translate: -50% -50%;
  object-fit: cover;
}

/* ✅ ป้ายชื่อกล้องหรูหรา */
.camera-label {
  position: absolute;
  bottom: 12px;
  left: 16px;
  background: rgba(0, 0, 0, 0.6);
  color: #ffffff;
  padding: 6px 14px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 500;
  font-family: 'Segoe UI', 'Kanit', sans-serif;
  letter-spacing: 0.5px;
  backdrop-filter: blur(2px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  gap: 6px;
}

.camera-label i {
  color: #58d68d;
  font-size: 14px;
}
/* ✅ กล่องแสดงสถานะ AGV แบบพรีเมียมระดับสูง */
.agv-status-box {
  position: relative;
  background: linear-gradient(135deg, var(--boxColor, #1eb980), rgba(255, 255, 255, 0.05));
  border-radius: 20px;
  padding: 26px 36px;
  color: #ffffff;
  font-family: 'Segoe UI', sans-serif;
  width: 100%;
  max-width: 860px;
  margin: 36px auto;
  box-shadow:
    0 10px 24px rgba(0, 0, 0, 0.2),
    0 0 16px var(--boxColor);
  border: 1px solid rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  overflow: hidden;
  z-index: 1;
  text-align: center;
}

/* ✅ เอฟเฟกต์แสงนุ่ม (ไม่ใช้ animation) */
.agv-status-box::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle at center, var(--boxColor, #1eb980) 0%, transparent 70%);
  opacity: 0.08;
  pointer-events: none;
  z-index: 0;
}

/* ✅ หัวข้อใหญ่แบบบาลานซ์ */
.agv-status-title {
  font-size: 1.85rem;
  font-weight: 700;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 14px;
  color: #ffffff;
  text-shadow: 0 2px 5px rgba(0, 0, 0, 0.35);
  position: relative;
  z-index: 1;
}

.agv-status-title i {
  font-size: 2rem;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.25));
}

/* ✅ คำอธิบายใต้สถานะพอดีสายตา */
.agv-status-desc {
  font-size: 1.1rem;
  font-weight: 400;
  opacity: 0.94;
  line-height: 1.6;
  color: #f8f9fa;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  position: relative;
  z-index: 1;
}

/* 🔴 Error Style แบบมืออาชีพ */
.agv-status-box.error {
  background: linear-gradient(135deg, #dc3545, #6a1b1b);
  box-shadow:
    0 10px 28px rgba(220, 53, 69, 0.35),
    0 0 12px #dc3545;
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: #fff;
}



/* 🔷 ปุ่มสั่งงานแบบพรีเมียม */
.btn-premium {
  padding: 14px 26px;
  font-size: 1rem;
  font-weight: 600;
  border-radius: 14px;
  background: linear-gradient(135deg, #52b788, #2d6a4f);
  color: #ffffff;
  border: none;
  box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  cursor: pointer;
  transition: all 0.25s ease;
}
.btn-premium:hover {
  transform: translateY(-2px);
  background: linear-gradient(135deg, #2d6a4f, #1b4332);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
}

/* 🔷 ปุ่มกลุ่มจัดเรียงสวยหรู */
.main-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin: 30px 0;
}

/* 🔷 กล่องกล้องแบบพรีเมียม */
.camera-section {
  display: flex;
  flex-wrap: wrap;
  gap: 36px;
  justify-content: center;
  margin: 40px 0;
}
.camera-box {
  flex: 1 1 48%;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
  overflow: hidden;
  position: relative;
  border: 1px solid #e2e8f0;
  height: auto;
}

/* 🔷 กล่องสถานะ AGV แบบพรีเมียม */
.lift-status {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  margin: 24px auto;
  padding: 14px 28px;
  font-size: 1.1rem;
  font-weight: 600;
  border-radius: 16px;
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.15);
  border: 2px solid transparent;
  background: linear-gradient(to right, #06b6d4, #0ea5e9);
  color: #ffffff;
  transition: all 0.4s ease;
}
.lift-status.working {
  background: linear-gradient(to right, #06b6d4, #0ea5e9);
  border-color: #0ea5e9;
}
.lift-status.working i {
  margin-right: 6px;
}

/* 🔷 ป้ายแสดงสถานะเซ็นเซอร์ */
.sensor-status {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
  margin-bottom: 30px;
}
.sensor-tag {
  background: #e6f4ea;
  color: #1b4332;
  border: 1px solid #52b788;
  border-radius: 20px;
  padding: 8px 18px;
  font-size: 0.95em;
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
}

/* 🔷 Dropdown ช่องปลายทาง */
.dropdown {
  text-align: center;
  margin-top: 40px;
}
select.dropdown-select {
  padding: 12px 20px;
  font-size: 1em;
  font-weight: 500;
  border-radius: 14px;
  border: 1px solid #cbd5e1;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
  width: 280px;
  margin-top: 10px;
  background-color: #ffffff;
  color: #1b4332;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg fill='none' stroke='%232d6a4f' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  background-size: 16px 16px;
  transition: all 0.3s ease;
}
select.dropdown-select:focus {
  border-color: #40916c;
  box-shadow: 0 0 0 3px rgba(64, 145, 108, 0.25);
}



/* ✅ liftstatus */

.lift-status.working {
  background: linear-gradient(to right, #0284c7, #0ea5e9); /* 💙 ฟ้าสด */
  color: white;
  border: 2px solid #0ea5e9;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: all 0.4s ease;
}


.lift-status {
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 24px auto;
  padding: 14px 24px;
  font-size: 1.1rem;
  font-weight: 600;
  border-radius: 14px;
  width: fit-content;
  box-shadow: 0 6px 14px rgba(0,0,0,0.15);
  border: 2px solid;
  transition: all 0.4s ease;
}

.lift-status.success {
  background: linear-gradient(to right, #38b000, #70e000);
  color: white;
  border-color: #28a745;
}

.lift-status.recovery {
  background: linear-gradient(to right, #f59e0b, #fbbf24);
  color: white;
  border-color: #f59e0b;
  animation: pulse 1.5s infinite;
}

.lift-status.emergency {
  background: linear-gradient(to right, #dc2626, #ef4444);
  color: white;
  border-color: #dc2626;
  animation: blink 1s infinite;
}

/* ✅ หน้า task */
.styled-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  .styled-table th, .styled-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
  }
  .status.success {
    color: #fff;
    background: #4CAF50;
    padding: 4px 8px;
    border-radius: 12px;
  }
  .status.error {
    color: #fff;
    background: #e53935;
    padding: 4px 8px;
    border-radius: 12px;
  }/* ✅ หน้า task */
  .blink {
    animation: blinker 1s linear infinite;
  }






/* ✨ Premium Tray Info Popup (ฉบับปรับปรุงใหม่) ✨ */
@keyframes popIn {
  from { transform: translateY(20px) scale(0.95); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}

@keyframes popOut {
  from { transform: scale(1); opacity: 1; }
  to { transform: scale(0.95); opacity: 0; }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

.tray-popup-backdrop {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(17, 24, 39, 0.6); /* ทำให้พื้นหลังเข้มและเบลอมากขึ้น */
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  opacity: 0;
  animation: fadeIn 0.3s ease-out forwards;
}

.tray-popup-backdrop.closing {
  animation: fadeOut 0.3s ease-in forwards;
}

.tray-popup-card {
  background: #ffffff;
  padding: 0; /* นำ padding ออกเพื่อสร้าง header เต็มความกว้าง */
  border-radius: 24px;
  box-shadow: 0 20px 45px rgba(0,0,0,0.25);
  width: 90%;
  max-width: 480px;
  font-family: 'Prompt', sans-serif;
  transform: scale(0.95);
  opacity: 0;
  animation: popIn 0.4s 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  overflow: hidden; /* สำคัญมากสำหรับดีไซน์ header */
}

.tray-popup-card.closing {
   animation: popOut 0.3s ease-in forwards;
}


.tray-popup-card .popup-header-premium {
  background: linear-gradient(145deg, #3b82f6, #2563eb);
  color: white;
  padding: 25px 30px;
  text-align: center;
}

.tray-popup-card .popup-header-premium i {
  font-size: 2.5rem;
  margin-bottom: 12px;
  display: block;
  text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.tray-popup-card .popup-header-premium h3 {
  font-size: 1.8em;
  font-weight: 600;
  margin: 0;
}

.tray-popup-card .info-list {
  padding: 25px 35px;
  display: flex;
  flex-direction: column;
  gap: 18px; /* เพิ่มระยะห่างระหว่างรายการ */
}

.tray-popup-card .info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 1.05em;
  padding-bottom: 18px;
  border-bottom: 1px solid #f3f4f6;
  opacity: 0;
  animation: fadeInUp 0.5s ease-out forwards;
}

.tray-popup-card .info-item:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

/* อนิเมชั่นแบบ Staggered (ทยอยแสดง) */
.tray-popup-card .info-item:nth-child(1) { animation-delay: 0.2s; }
.tray-popup-card .info-item:nth-child(2) { animation-delay: 0.25s; }
.tray-popup-card .info-item:nth-child(3) { animation-delay: 0.3s; }
.tray-popup-card .info-item:nth-child(4) { animation-delay: 0.35s; }
.tray-popup-card .info-item:nth-child(5) { animation-delay: 0.4s; }
.tray-popup-card .info-item:nth-child(6) { animation-delay: 0.45s; }

.tray-popup-card .info-label {
  color: #4b5563;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 12px; /* เพิ่มระยะห่างไอคอน */
}

.tray-popup-card .info-value {
  color: #111827;
  font-weight: 600;
  text-align: right;
}

.tray-popup-card .info-value.highlight {
    background: #e9f5ec;
    color: #1b4332;
    padding: 4px 10px;
    border-radius: 8px;
    font-weight: 700;
}

.tray-popup-card .close-button-wrapper {
  padding: 20px 35px;
  background-color: #f9fafb;
  border-top: 1px solid #e5e7eb;
}

.tray-popup-card .close-button {
  width: 100%;
  background: #4b5563; /* สีเทาเข้ม */
  color: white;
  padding: 14px;
  font-size: 1.1em;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.tray-popup-card .close-button:hover {
  background: #374151;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(75, 85, 99, 0.2);
}








/* ✅ ป้ายสถานะพรีเมียม */
.status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  font-size: 0.95em;
  padding: 4px 12px;
  border-radius: 20px;
  transition: 0.3s ease;
}
.status-due {
  background-color: #fff0f0;
  color: #e63946;
  border: 1px solid #e63946;
}
.status-due.blink {
  animation: blinkEffect 1s infinite;
}
.status-growing {
  background-color: #e9f5ec;
  color: #2d6a4f;
  border: 1px solid #2d6a4f;
}
.status i {
  font-size: 0.9em;
}

/* ✅ แถวเมื่อถึงวันเก็บเกี่ยว */
.harvest-due {
  background-color: #fff0f0 !important;
  transition: background-color 0.3s ease;
}

/* ✅ กล่องข้อมูลหลัก */
.card {
  background: linear-gradient(135deg, #ffffff, #f0fdf4);
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
  margin: 24px auto;
  max-width: 95%;
  font-family: 'Prompt', sans-serif;
  animation: fadeIn 0.5s ease-in-out;
}

h2 {
  font-size: 1.8rem;
  color: #1b4332;
  margin-bottom: 24px;
  display: flex;
  align-items: center;
  font-weight: 600;
}
h2 i {
  color: #40916c;
  margin-right: 10px;
  font-size: 1.4em;
}

/* ✅ ตารางสวยงาม */
.styled-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: #ffffff;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.styled-table thead {
  background-color: #2d6a4f;
}

.styled-table th,
.styled-table td {
  text-align: center;
  padding: 16px;
  font-size: 0.95em;
}

.styled-table th {
  color: #ffffff;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.styled-table td {
  color: #333;
  border-bottom: 1px solid #f3f3f3;
}

.styled-table tr:last-child td {
  border-bottom: none;
}

/* ✅ จุดสถานะสี */
.status-green::before,
.status-red::before {
  content: '\f111';
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  margin-right: 6px;
  font-size: 0.75em;
}
.status-green::before { color: #2d6a4f; }
.status-red::before { color: #e63946; }

/* ✅ บังคับแนวนอนแบบ Super Dev */
#plantingPagination {
  display: flex !important;
  flex-direction: row !important;
  justify-content: center !important;
  align-items: center;
  gap: 8px;
  margin-top: 24px;
  flex-wrap: wrap;
}

.pagination button {
  background: #e9f5ec;
  border: 1px solid #2d6a4f;
  border-radius: 10px;
  padding: 8px 16px;
  font-size: 0.9em;
  font-weight: 500;
  color: #2d6a4f;
  cursor: pointer;
  transition: 0.3s;
  min-width: 44px;

  /* ✅ เพิ่มบรรทัดนี้เพื่อแก้ปัญหา */
  width: auto;
  flex: 0 0 auto;
}

.pagination button.active,
.pagination button:hover {
  background: #2d6a4f;
  color: white;
  transform: scale(1.05);
}

/* ✅ ปุ่มคำสั่ง */
.action-buttons {
  display: flex;
  gap: 8px;
  justify-content: center;
  flex-wrap: wrap;
}

.action-buttons button {
  background-color: #52b788;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 10px;
  font-size: 0.85em;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  font-weight: 500;
}

.action-buttons button:hover {
  background-color: #40916c;
  transform: scale(1.04);
}




.toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #d1fae5; /* สีเขียวมิ้น */
  color: #065f46;
  padding: 16px 24px;
  border-radius: 12px;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  opacity: 0;
  transition: opacity 0.5s ease;
  z-index: 9999;
  pointer-events: none;
}

.toast.show {
  opacity: 1;
}
/* 🍿 Premium Log Cards Style */

.log-cards-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 24px;
  max-width: 1400px;
  margin: auto;
  margin-top: 30px;
}

.log-card {
  width: 320px;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  padding: 20px;
  font-family: 'Prompt', sans-serif;
  color: #1b4332;
  border: 1px solid #dde;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.log-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 28px rgba(0,0,0,0.15);
}

.log-card strong {
  color: #40916c;
}

.log-card .expand-btn {
  margin-top: 14px;
  padding: 10px 20px;
  border: none;
  background: linear-gradient(to right, #52b788, #40916c);
  color: white;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
  font-size: 0.95em;
  transition: 0.3s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.log-card .expand-btn:hover {
  background: linear-gradient(to right, #40916c, #2d6a4f);
  transform: translateY(-1px);
}

/* 🔍 Filter Form */
.user-logs-filters {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 24px;
  margin-bottom: 30px;
  padding: 10px 0;
}

.user-logs-filters label {
  font-weight: 600;
  color: #1b4332;
  margin-bottom: 6px;
  font-size: 0.95em;
  display: block;
}

.user-logs-filters input,
.user-logs-filters select {
  padding: 12px 16px;
  font-size: 1em;
  border-radius: 14px;
  border: 1px solid #ced4da;
  background: #ffffff;
  color: #1b4332;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  transition: border 0.2s ease, box-shadow 0.3s ease;
  min-width: 220px;
}

.user-logs-filters input:focus,
.user-logs-filters select:focus {
  outline: none;
  border-color: #52b788;
  box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.2);
}

.user-logs-filters button {
  padding: 14px 24px;
  background: linear-gradient(to right, #52b788, #40916c);
  border: none;
  border-radius: 14px;
  color: white;
  font-weight: bold;
  font-size: 1em;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.user-logs-filters button:hover {
  background: linear-gradient(to right, #40916c, #2d6a4f);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.15);
}

/* 📏 Pagination Premium */
#pagination {
  margin-top: 24px;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  padding: 10px;
}

#pagination button {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  border: none;
  background: #e9f5ec;
  color: #1b4332;
  font-weight: bold;
  font-size: 1em;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
}

#pagination button:hover {
  background: #b7e4c7;
  transform: translateY(-1px);
}

#pagination .active {
  background: #40916c;
  color: white;
}




.manual-btn { /* ปุ่มขี้นลง */
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  font-size: 1rem;
  font-family: 'Prompt', sans-serif;
  background: linear-gradient(145deg, #2d6a4f, #40916c);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

 /* ปุ่มขี้นลง */
.manual-btn:hover {
  background: linear-gradient(145deg, #1b4332, #2d6a4f);
  transform: translateY(-2px);
}

 /* ปุ่มขี้นลง */
.manual-btn i {
  font-size: 1.2rem;
}

lift-container {
  position: relative;
  width: 200px;
  height: 600px;
  margin: 20px auto;
  border: 1px solid #ccc;
}

.lift-bg {
  width: 100%;
  height: 100%;
  display: block;
}

.lift-cart {
  position: absolute;
  left: 0;
  width: 100%;
  height: 60px;
  transition: top 1s ease;
  z-index: 10;
}

.sensor {
  position: absolute;
  left: 90%;
  width: 12px;
  height: 12px;
  background-color: gray;
  border-radius: 50%;
  z-index: 5;
  animation: blinkOff 1s infinite;
}







.video-overlay {
  background: none;
}

#loginVideo {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  z-index: -2;
  filter: brightness(1) blur(0.7px); /* ชัดขึ้น (brightness 1) */
}

.dashboard-title {
  font-size: 2em; /* ลดจาก 2.6em */
  font-weight: 600; /* นุ่มนวลลง */
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(to right, #1b4332, #40916c);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 1px 1px 1.5px rgba(0, 0, 0, 0.05);
  margin: 10px 0 15px 0; /* บีบระยะบนล่าง */
  text-align: left;
  padding-left: 20px; /* ชิดซ้ายขึ้นเล็กน้อย */
  display: flex;
  align-items: center;
  gap: 8px; /* ช่องว่างไอคอนและตัวหนังสือ */
}



.sidebar {
  width: 260px !important;
}

.sidebar-header,
.sidebar-brand {
  padding: 10px 10px !important; /* 🔽 ลด padding บนลง */
  text-align: center;
}

.sidebar-logo {
  width: 180px !important;
  max-width: 100% !important;
  height: auto !important;
  margin: 10px auto 5px !important; /* 🔽 ลดระยะห่างด้านบนลง */
  display: block;
}



.footer-illustration {
  width: 200px;           /* ขยายขึ้นจาก 140px → 200px */
  max-width: 90%;
  height: auto;
  display: block;
  margin: 30px auto 0;    /* ขยับลงนิดนึงให้นุ่มนวล */
}

.logo {
  width: 120px;
  height: auto;
  display: block;
  margin: 0 auto 20px;
  filter: drop-shadow(0 0 8px rgba(0,255,170,0.2)); /* แสงแบบเรืองนิดๆ */
}
.logo:hover {
  transform: scale(1.05);
}

.sidebar {
  width: 260px !important;
  height: 100vh;              /* ✅ ให้ความสูงเต็มหน้าจอ */
  overflow-y: auto;           /* ✅ ให้เลื่อนแนวตั้งเมื่อยาวเกิน */
  scroll-behavior: smooth;    /* ✅ เพิ่มความลื่นเวลา scroll */
  padding-bottom: 30px;       /* ✅ กัน footer ทับเมนูสุดท้าย */
}

.sidebar-logo {
  width: 140px;
  max-width: 100%;
  height: auto;
  margin: 10px auto;
  display: block;
  transition: transform 0.3s ease;
}
.sidebar-logo:hover {
  transform: scale(1.05);
}

.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal-box {
  background: white;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
  text-align: center;
  width: 300px;
  font-family: 'Prompt', sans-serif;
}

.modal-buttons {
  margin-top: 20px;
  display: flex;
  justify-content: space-around;
}

.modal-buttons button {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1em;
}

.modal-buttons button:first-child {
  background: #2d6a4f;
  color: white;
}

.modal-buttons button:last-child {
  background: #ccc;
  color: #333;
}
/* ✅ กล่องใส login อยู่กลางจอ */
.login-container {
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 20px;
  padding: 40px;
  width: 320px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.08);

  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;

  height: auto !important;      /* ✅ บังคับให้ไม่จดจำความสูงเก่า */
  min-height: 400px;            /* ✅ ความสูงขั้นต่ำตามหน้า Login */
  max-height: 100vh;            /* ป้องกันไม่ให้ยืดเกินจอ */
  transition: height 0.2s ease; /* ลื่นไหลเวลาสลับหน้า */
}


/* ✅ โลโก้บนสุด */
.login-container img {
  width: 140px;
  margin-bottom: 28px;
  filter: drop-shadow(0 0 10px rgba(0, 255, 170, 0.25));
  transition: transform 0.3s ease;
}
.login-container img:hover {
  transform: scale(1.05);
}

/* ✅ Input + icon */
.input-group {
  position: relative;
  margin-bottom: 20px;
}

.input-group i {
  position: absolute;
  top: 50%;
  left: 16px;
  transform: translateY(-50%);
  color: #52b788; /* เปลี่ยนเป็นสีเขียวมิ้น */
}

.input-group input {
  width: 100%;
  padding: 14px 14px 14px 44px;
  border-radius: 10px;
  border: none;
  background: rgba(255, 255, 255, 0.1);
  color: #52b788; /* เปลี่ยนข้อความในช่องให้เป็นสีเขียวมิ้น */
}

.input-group input::placeholder {
  color: #95d5b2; /* เขียวมิ้นอ่อน */
}

.input-group input:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(64, 145, 108, 0.4);
}

/* ✅ ปุ่ม Sign In */
.login-container button {
  background: linear-gradient(to right, #52b788, #40916c);
  border: none;
  padding: 14px;
  border-radius: 10px;
  color: white;
  font-weight: bold;
  width: 100%;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.login-container button:hover {
  transform: translateY(-2px);
}

/* ✅ ลิงก์สมัครสมาชิก */
.login-container a {
  color: white;
  font-size: 0.9em;
  display: block;
  margin-top: 20px;
  text-decoration: none;
}

.login-container a:hover {
  text-decoration: underline;
}
/* 💎 Polished & Animated Grid Style 💎 */

@keyframes grid-shimmer {
  0% { transform: translateX(-100%) skewX(-20deg); }
  100% { transform: translateX(2500px) skewX(-20deg); } /* 2500px ให้แสงวิ่งเลยขอบไปไกลๆ */
}

/* --- กรอบของตารางทั้งหมด --- */
.tray-grid {
  display: grid;
  gap: 12px;
  padding: 24px;
  background-color: #f8fafc; /* พื้นหลังสะอาดตา */
  border-radius: 18px;
  border: 1px solid #e2e8f0;
  position: relative;
  overflow: hidden; /* สำหรับ Animation */
}

/* --- แสงสแกน (Animation) --- */
.tray-grid::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 10%;
  height: 120%;
  background: linear-gradient(
    to right,
    transparent 0%,
    rgba(255, 255, 255, 0.5) 50%,
    transparent 100%
  );
  animation: grid-shimmer 15s linear infinite;
  pointer-events: none; /* ทำให้คลิกทะลุได้ */
}

/* --- หัวข้อ (ช่อง และ ชั้น) --- */
.tray-header-cell {
  font-weight: 600;
  text-align: center;
  padding: 10px 5px;
  font-size: 0.85em;
  color: #94a3b8; /* สีเทาอมน้ำเงิน */
}

/* --- สล็อต (ทั้งว่างและมีถาด) --- */
.tray-slot {
  border-radius: 10px;
  transition: all 0.25s ease-in-out;
  min-height: 70px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 8px;
  position: relative;
}

/* --- สล็อตว่าง --- */
.tray-slot.empty {
  background-color: #ffffff;
  border: 1px dashed #dce4f2; /* เส้นขอบแบบประ */
  cursor: default;
}
.empty-slot-coords {
    font-size: 0.9em;
    font-weight: 500;
    color: #e2e8f0;
}

/* --- สล็อตที่มีถาด --- */
.tray-slot.filled {
  background: linear-gradient(145deg, #3b82f6, #2563eb); /* โทนสีน้ำเงิน */
  color: white;
  border: 1px solid #1d4ed8;
  box-shadow: 0 6px 16px rgba(59, 130, 246, 0.2);
  cursor: pointer;
}

/* --- เอฟเฟกต์เมื่อเมาส์ชี้ --- */
.tray-slot:hover {
  transform: translateY(-4px) scale(1.03);
  box-shadow: 0 10px 25px rgba(148, 163, 184, 0.2);
}
.tray-slot.filled:hover {
  box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
}

/* --- สไตล์ของ Text ภายในสล็อต --- */
.filled-tray-icon {
  font-size: 1.4em;
  opacity: 0.8;
  margin-bottom: 4px;
}
.filled-tray-veg-name {
    font-size: 0.9em;
    font-weight: 600;
}
.filled-tray-id {
    font-size: 0.75em;
    font-weight: 400;
    background-color: rgba(255, 255, 255, 0.15);
    padding: 1px 5px;
    border-radius: 4px;
    margin-top: 2px;
}



body {
    font-family: 'Prompt', sans-serif;
    background: linear-gradient(to bottom right, #e9f5ec, #ffffff);
  }

.header {
  position: relative; /* ✅ ต้องมีเพื่อให้ absolute ของลูกทำงานถูกต้อง */
}

.user-wrapper {
  position: relative;
  display: inline-block;
  font-family: 'Poppins', sans-serif;
}

.user-dropdown {
  display: none;
  position: absolute;
  right: 0;
  top: 110%;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
  padding: 8px 0;
  min-width: 220px;
  z-index: 9999;
  font-family: 'Poppins', sans-serif;
  border: 1px solid #e0e0e0;
}

.user-menu {
  background-color: #f0f0f0;
  padding: 8px 12px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  color: #1b4332;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.user-dropdown .dropdown-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 20px;
  font-size: 1em;
  font-weight: 500;
  color: #1b4332;
  transition: all 0.2s ease;
  border-left: 4px solid transparent;
  cursor: pointer;
}

.user-dropdown .dropdown-item:hover {
  background-color: #e9f5ec;
  border-left: 4px solid #52b788;
  color: #1b4332;
}

.dropdown-item {
  padding: 8px 10px;
  cursor: pointer;
  border-radius: 8px;
  transition: background 0.2s ease;
}

.dropdown-item:hover {
  background-color: #f0f0f0;
}



.theme-toggle {
  padding: 10px 18px;
  background: linear-gradient(to right, #74c69d, #52b788);
  color: white;
  font-weight: bold;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-size: 1em;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
.theme-toggle:hover {
  background: linear-gradient(to right, #52b788, #40916c);
  transform: translateY(-1px);
}


.dropdown-item:hover {
  background: #e9f5ec;
}

#loginPage,
#dashboardPage {
  display: none;
}


#loginPage {
  background: none;
}



.link {
  margin-top: 16px;
  display: block;
  color: #1b4332;
  font-size: 0.9em;
  text-decoration: underline;
  cursor: pointer;
}

    #dashboardPage {
  display: flex;
  flex-direction: row;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
}

.footer-faint p {
  font-weight: 500;
  color: #333;         /* ชัดขึ้นจาก #6c757d */
}

.content {
  padding: 40px;
  overflow-y: auto;
  background: linear-gradient(to bottom, #e9f5ec, #ffffff);
  flex: 1; /* ✅ [แก้ไข] เพิ่มบรรทัดนี้เพื่อให้ขยายเต็มพื้นที่ที่เหลือ */
}
.footer-faint {
  margin-top: 60px;
  padding-top: 30px;
  text-align: center;
  opacity: 0.95;
  animation: fadeIn 0.8s ease;
  font-size: 1.1em;  /* 🔺 จากเดิม 0.9em */
  line-height: 1.7;  /* 🔁 เพื่อให้อ่านง่ายขึ้น */
}

.footer-agrotech {
  max-width: 220px;       /* 🔺 เพิ่มขนาด */
  margin-top: 25px;
  opacity: 1;
  transition: transform 0.3s ease;
}
.footer-agrotech:hover {
  transform: scale(1.05);  /* เพิ่ม interaction ตอน hover */
}




/* ✅ แต่ง dropdown menu หน้า Inbound */
.tray-form select {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #2d6a4f;              /* เปลี่ยนสีขอบเป็นเขียวพรีเมียม */
  border-radius: 12px;
  font-size: 1.05em;
  font-family: 'Prompt', sans-serif;
  background-color: #ffffff;              /* ฉากหลังสีขาว */
  color: #1b4332;                         /* ตัวอักษรสีเข้ม อ่านง่าย */
  appearance: none;                       /* ซ่อน dropdown ลูกศรแบบดั้งเดิม */
  background-image: url("data:image/svg+xml,%3Csvg fill='none' stroke='%232d6a4f' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  background-size: 16px 16px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); /* เงาอ่อนๆ */
  transition: all 0.3s ease;
}

.tray-form select:focus {
  border-color: #40916c;
  box-shadow: 0 0 0 3px rgba(64, 145, 108, 0.2);
  background-color: #f8fff8;
}

/* ✅ label ข้าง dropdown */
.tray-form label {
  font-weight: 600;
  margin-bottom: 8px;
  display: block;
  color: #1b4332;
  font-size: 0.95em;
  margin-top: 16px;
}

/* ✅ กำหนด layout โดยรวมของฟอร์ม */
.tray-form {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  margin-top: 20px;
}

/* ✅ กำหนดความกว้างของ input dropdown */
.tray-form > div {
  flex: 1 1 30%;
  min-width: 240px;
}
/* ✅ เเต่งโลโก้inborund */
.logo-top {
  text-align: center;
  margin-bottom: 20px;
}
/* ✅ เเต่งโลโก้outborun */
.logo-top img {
  max-width: 160px;
  height: auto;
  opacity: 0.9;
  filter: drop-shadow(0 0 3px rgba(0,0,0,0.1));
}




.inbound-btn {
  background: linear-gradient(to right, #95d5b2, #74c69d);
  color: white;
  font-size: 1.2em;
  font-weight: 600;
  padding: 16px 28px;
  border-radius: 20px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 600px;
  display: block;
  margin: 30px auto 10px auto;
}
.inbound-btn:hover {
  transform: translateY(-3px);
  background: linear-gradient(to right, #74c69d, #52b788);
}

.outbound-btn {
  background: linear-gradient(to right, #f87171, #ef4444);
  color: white;
  font-size: 1.2em;
  font-weight: 600;
  padding: 16px 28px;
  border-radius: 20px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 600px;
  display: block;
  margin: 30px auto 10px auto;
}
.outbound-btn:hover {
  transform: translateY(-3px);
  background: linear-gradient(to right, #ef4444, #dc2626);
}

.inbound-title,
.outbound-title {
  text-align: center;
  font-size: 2em;
  font-weight: bold;
  margin-bottom: 10px;
  color: #1b4332;
}

.inbound-desc {
  color: #6c757d;
  text-align: center;
  margin-bottom: 30px;
  font-size: 1em;
}

/* ✅ ป้องกันพื้นหลังวิดีโอโผล่ */
html, body, #app {
  height: 100%;
  margin: 0;
  padding: 0;
}

/* ✅ ให้หน้า inbound/outbound เต็มความสูง */
.inbound-page, .outbound-page {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-height: 100vh;
  padding: 40px 20px;
  background: linear-gradient(to bottom, #e9f5ee, #fefefe);
}




/* ✅ คำเตือนเด่นชัด */
.warning-message {
  background: #fff5f5;
  color: #dc2626;
  border-left: 6px solid #dc2626;
  padding: 12px 20px;
  font-weight: bold;
  font-size: 0.95em;
  margin-top: 20px;
  border-radius: 12px;
  text-align: center;
  max-width: 700px;
  margin-left: auto;
  margin-right: auto;
}


    * {
      box-sizing: border-box;
      transition: 0.3s ease;
    }
    /* 💡 Default: Light Mode */
    body {
  margin: 0;
  padding: 0;
  font-family: 'Prompt', sans-serif;
  background: url('PFAL.png') no-repeat center center fixed;
  background-size: cover;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
.sidebar {
  width: 260px;
  background: #ffffff;
  border-right: 1px solid #cce3d1;
  display: flex;
  flex-direction: column;
  padding: 25px 0;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.04);
  animation: slideInLeft 0.5s ease-out;
}

.sidebar img {
  width: 120px;
  margin: 0 auto 10px;
  transition: transform 0.3s ease;
}
.sidebar img:hover {
  transform: scale(1.1);
}

.sidebar h2 {
  text-align: center;
  color: #2d6a4f;
  margin: 10px 0 0;
  font-weight: 700;
}
.sidebar small {
  color: #6c757d;
  text-align: center;
  display: block;
}
.sidebar a {
  padding: 14px 30px;
  color: #1b4332;
  text-decoration: none;
  font-size: 1.1em;
  display: flex;
  align-items: center;
  border-left: 4px solid transparent;
}
.sidebar a:hover,
.sidebar a.active {
  background: #e9f5ec;
  border-left: 4px solid #52b788;
}
.sidebar a i {
  margin-right: 12px;
  font-size: 1.3em;
}

.main {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 100vh;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 30px;
  background: #ffffff;
  color: #1b4332;
  font-size: 1.6em;
  font-weight: 600;
  border-bottom: 1px solid #cdeed1;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}


.content {
  padding: 40px;
  overflow-y: auto;
  background: linear-gradient(to bottom, #e9f5ec, #ffffff);
}

.section {
  background: #ffffff;
  padding: 35px;
  border-radius: 18px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
  margin-bottom: 40px;
  animation: fadeInUp 0.5s ease;
}
.section h2 {
  color: #1b4332;
  margin-bottom: 20px;
  font-size: 1.4em;
}

select,
button {
  padding: 14px;
  font-size: 1em;
  border-radius: 12px;
  border: 1px solid #ccc;
  margin-bottom: 18px;
  width: 100%;
  background-color: #f8f9fa;
  color: #1b4332;
}

button {
  width: 100%;
  padding: 12px;
  background: #52b788;
  color: white;
  font-weight: bold;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  margin-top: 10px;
  transition: background 0.3s ease;
}

button:hover {
  background: #40916c;
}

.message {
  display: none;
  padding: 14px;
  border-radius: 10px;
  margin-top: 10px;
  font-weight: 600;
  text-align: center;
}
.success {
  background: #d1fae5;
  color: #065f46;
}
.error {
  background: #fee2e2;
  color: #991b1b;
}
/* ✅ Confirm Modal Styling */
.confirm-backdrop {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  animation: fadeIn 0.3s ease;
}

.confirm-box {
  background: #ffffff;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
  text-align: center;
  width: 300px;
  animation: fadeInUp 0.3s ease;
}

.confirm-box h3 {
  margin-bottom: 20px;
  color: #1b4332;
}

.button-group {
  display: flex;
  justify-content: space-between;
}

.confirm-box button {
  padding: 10px 20px;
  font-size: 1em;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  transition: 0.3s;
}

.confirm-box button:first-child {
  background: #52b788;
  color: white;
}
.confirm-box button:first-child:hover {
  background: #40916c;
}
.confirm-box button:last-child {
  background: #ccc;
  color: black;
}
.confirm-box button:last-child:hover {
  background: #aaa;
}

/* 🌙 Dark Mode Overrides */
body.dark-mode {
  background: linear-gradient(135deg, #121212, #1e1e1e);
  color: #f1f1f1;
}
body.dark-mode .sidebar {
  background: #1f1f1f;
  border-right: 1px solid #333;
  color: #e0e0e0;
}
body.dark-mode .sidebar h2 {
  color: #90ee90;
}
body.dark-mode .sidebar small {
  color: #aaa;
}
body.dark-mode .sidebar a {
  color: #e0e0e0;
}
body.dark-mode .sidebar a:hover,
body.dark-mode .sidebar a.active {
  background: #2d2d2d;
  border-left: 4px solid #52b788;
  color: #90ee90;
}
body.dark-mode .header {
  background: #1c1c1c;
  color: #90ee90;
  border-bottom: 1px solid #2a2a2a;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}
body.dark-mode .content {
  background: #2a2a2a;
}
body.dark-mode .section {
  background: #333;
  color: #f1f1f1;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
}
body.dark-mode select,
body.dark-mode button {
  background-color: #1c1c1c;
  color: #f1f1f1;
  border: 1px solid #555;
}
body.dark-mode .success {
  background: #1d402c;
  color: #90ee90;
}
body.dark-mode .error {
  background: #402020;
  color: #ff6b6b;
}
/* ✅ Dark mode override for Confirm Modal */
body.dark-mode .confirm-box {
  background: #2a2a2a;
  color: #f1f1f1;
}
body.dark-mode .confirm-box h3 {
  color: #f1f1f1;
}
body.dark-mode .confirm-box button:first-child {
  background: #40916c;
}
body.dark-mode .confirm-box button:last-child {
  background: #555;
  color: white;
}
.tab-button {
  background: transparent;
  border: none;
  font-size: 1.2em;
  padding: 12px 24px;
  cursor: pointer;
  color: #1b4332;
  border-bottom: 3px solid transparent;
  font-weight: bold;
  transition: 0.2s ease;
}
.tab-button.active {
  border-bottom: 3px solid #52b788;
  color: #52b788;
}
.tab-button:hover {
  background-color: #e9f5ec;
  border-radius: 8px 8px 0 0;
}


/* 🌀 Animations */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
@keyframes slideInLeft {
  from {
    transform: translateX(-100%);
  }
  to {
    transform: translateX(0);
  }
}

@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}
@media screen and (max-width: 768px) {
  .login-container {
    width: 90%;
  }
}

@keyframes fadeInUp {
  from {
    transform: translateY(20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes blinkOn {
  0%, 100% { background-color: green; }
  50% { background-color: white; }
}

@keyframes blinkOff {
  0%, 100% { background-color: gray; }
}


@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes blinkEffect {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.2; }
}


  @keyframes blinker {
    50% { opacity: 0.4; }
  }



  @keyframes blink {
  0%, 100% { background-color: #b91c1c; }
  50% { background-color: #ef4444; }
}
@keyframes pulse {
  0%, 100% { background-color: #f59e0b; }
  50% { background-color: #fbbf24; }
  
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.03); }
}





  </style>
  
</head>

<body>
 <!-- ✅ popup Returun Workstation  -->
<div class="popup-overlay" id="returnTrayModal" style="display: none;">
  <div class="popup-container" style="max-width: 650px;">
    <div class="popup-header">
      <h2 class="popup-title"><i class="fas fa-arrow-left icon"></i> ส่งถาดกลับเข้าคลัง</h2>
    </div>

    <div style="margin-top: 15px; margin-bottom: 25px;">
        <h3 style="font-weight: 600; color: #4B5563; border-bottom: 1px solid #E5E7EB; padding-bottom: 10px; margin-bottom: 20px;">
          <i class="fas fa-edit" style="margin-right: 8px; color: #6B7280;"></i>
          แก้ไขข้อมูลถาด (ถ้าต้องการ)
        </h3>
        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="returnVegType">ชนิดผัก (ไม่สามารถแก้ไขได้)</label>
                <input type="text" id="returnVegType" class="form-input-deluxe" readonly style="background-color: #e9ecef; cursor: not-allowed;">
            </div>
            <div class="form-group">
                <label for="returnPlantQuantity">จำนวนต้น</label>
                <input type="number" id="returnPlantQuantity" class="form-input-deluxe" placeholder="เช่น 16">
            </div>
            <div class="form-group">
                <label for="returnBatchId">Batch ID (ไม่สามารถแก้ไขได้)</label>
                <input type="text" id="returnBatchId" class="form-input-deluxe" readonly style="background-color: #e9ecef; cursor: not-allowed;">
            </div>
             <div class="form-group">
                <label for="returnSeedingDate">วันที่เพาะเมล็ด</label>
                <input type="date" id="returnSeedingDate" class="form-input-deluxe">
            </div>
            <div class="form-group full-width">
                <label for="returnNotes">หมายเหตุ</label>
                <textarea id="returnNotes" class="form-input-deluxe" rows="2" placeholder="เพิ่มหมายเหตุ..."></textarea>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 25px;">
        <h3 style="font-weight: 600; color: #4B5563; border-bottom: 1px solid #E5E7EB; padding-bottom: 10px; margin-bottom: 20px;">
          <i class="fas fa-map-marker-alt" style="margin-right: 8px; color: #6B7280;"></i>
          เลือกตำแหน่งใหม่
        </h3>
        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="returnFloor">ชั้นใหม่</label>
                <select id="returnFloor" class="form-input-deluxe">
                    <option value="1">ชั้น 1</option>
                    <option value="2">ชั้น 2</option>
                    <option value="3">ชั้น 3</option>
                    <option value="4">ชั้น 4</option>
                    <option value="5">ชั้น 5</option>
                    <option value="6">ชั้น 6</option>
                    <option value="7">ชั้น 7</option>
                    <option value="8">ชั้น 8</option>
                    <option value="9">ชั้น 9</option>
                </select>
            </div>
            <div class="form-group">
                <label for="returnSlot">ช่องใหม่</label>
                 <select id="returnSlot" class="form-input-deluxe">
                    <option value="1">ช่อง 1</option><option value="2">ช่อง 2</option><option value="3">ช่อง 3</option>
                    <option value="4">ช่อง 4</option><option value="5">ช่อง 5</option><option value="6">ช่อง 6</option>
                    <option value="7">ช่อง 7</option><option value="8">ช่อง 8</option><option value="9">ช่อง 9</option>
                    <option value="10">ช่อง 10</option><option value="11">ช่อง 11</option><option value="12">ช่อง 12</option>
                    <option value="13">ช่อง 13</option><option value="14">ช่อง 14</option><option value="15">ช่อง 15</option>
                    <option value="16">ช่อง 16</option><option value="17">ช่อง 17</option><option value="18">ช่อง 18</option>
                    <option value="19">ช่อง 19</option><option value="20">ช่อง 20</option>
                </select>
            </div>
        </div>
    </div>

    <div class="popup-actions">
        <button class="popup-button cancel" onclick="closeReturnModal()">ยกเลิก</button>
        <button class="popup-button confirm" onclick="">ยืนยัน</button>
    </div>
  </div>
</div>



 <!-- ✅ popup Tray Master-->
<div class="popup-overlay" id="editTrayModal" style="display: none;">
  <div class="popup-container">
    <div class="popup-header">
      <h2 class="popup-title"><i class="fas fa-edit icon"></i> แก้ไขข้อมูลถาด</h2>
    </div>
    <div class="form-grid" style="grid-template-columns: 1fr;">
        <input type="hidden" id="editTrayId">
        <div class="form-group"><label>ชนิดผัก</label><input type="text" id="editVegType" class="form-input-deluxe"></div>
        <div class="form-group"><label>จำนวนต้น</label><input type="number" id="editPlantQuantity" class="form-input-deluxe"></div>
        <div class="form-group"><label>Batch ID</label><input type="text" id="editBatchId" class="form-input-deluxe"></div>
        <div class="form-group"><label>วันที่เพาะเมล็ด</label><input type="date" id="editSeedingDate" class="form-input-deluxe"></div>
        <div class="form-group"><label>หมายเหตุ</label><textarea id="editNotes" class="form-input-deluxe" rows="3"></textarea></div>
    </div>
    <div class="popup-actions">
        <button class="popup-button cancel" onclick="closeEditModal()">ยกเลิก</button>
        <button class="popup-button confirm" onclick="handleUpdateTray()">บันทึกการเปลี่ยนแปลง</button>
    </div>
  </div>
</div>




  <!-- ✅ popup tray inventroy-->
  <div id="trayInfoPopup" class="tray-popup-backdrop" style="display: none;">
  <div class="tray-popup-card">
    <h3><i class="fas fa-boxes"></i> ข้อมูลถาด</h3>
    <div id="trayInfoContent"></div>
    <button onclick="closeTrayInfoPopup()"><i class="fas fa-times-circle"></i> ปิด</button>
  </div>
</div>

 
 <div id="toast" class="toast"></div>


 
  <!-- ✅ พื้นหลัง ai -->
  <video autoplay muted loop id="loginVideo" playsinline>
    <source src="vidu-video-2763632902164823.mp4" type="video/mp4">
  </video>


  

<div id="loginPage" class="login-container">
  <img src="agrotech-logo.png" class="logo" />
  <div class="form-box">
    <div class="input-group">
      <i class="fas fa-user"></i>
      <input type="text" id="username" placeholder="ชื่อผู้ใช้" />
    </div>
    <div class="input-group">
      <i class="fas fa-key"></i>
      <input type="password" id="password" placeholder="รหัสผ่าน" />
    </div>
    <button onclick="login()">Sign In</button>
    <div id="loginMsg" class="message"></div>
    <a href="#" onclick="goToRegister()">ยังไม่มีบัญชี? สมัครสมาชิก</a>
  </div>
</div>

</div>

<!-- ✅ Register Page -->
<div id="registerPage" class="login-container" style="display: none;">
  <img src="agrotech-logo.png" class="logo" />
  <div class="form-box">
    <div class="input-group">
      <i class="fas fa-user"></i>
      <input type="text" id="regUsername" placeholder="ชื่อผู้ใช้ใหม่" />
    </div>
    <div class="input-group">
      <i class="fas fa-key"></i>
      <input type="password" id="regPassword" placeholder="รหัสผ่าน" />
    </div>
    <div class="input-group">
      <i class="fas fa-id-badge"></i>
      <select id="regRole">
        <option value="">-- เลือกตำแหน่ง --</option>
        <option value="หัวหน้างาน">หัวหน้างาน</option>
        <option value="พนักงาน">พนักงาน</option>
        <option value="IT">IT</option>
        <option value="Engineer">Engineer</option>
      </select>
    </div>
    <button onclick="register()">สร้างบัญชี</button>
    <div id="registerMsg" class="message"></div>
    <a class="link" onclick="backToLogin()"><i class="fas fa-arrow-left"></i> กลับหน้าล็อกอิน</a>
  </div>
</div>

<!-- ✅ Modal เปลี่ยนรหัสผ่าน -->
<div id="changeBox" class="confirm-backdrop" style="display: none;">
  <div class="confirm-box" style="
    max-width: 400px;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    background: #ffffff;
    text-align: center;
    font-family: 'Prompt', sans-serif;
  ">
    <h3 style="font-size: 1.6em; color: #1b4332; display: flex; justify-content: center; align-items: center; gap: 10px;">
      <i class="fa-solid fa-key"></i> เปลี่ยนรหัสผ่าน
    </h3>

    <div style="display: flex; flex-direction: column; gap: 16px; margin-top: 25px;">
      <input id="changeUser" type="text" placeholder="ชื่อผู้ใช้เดิม" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
      <input id="oldPass" type="password" placeholder="รหัสผ่านเดิม" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
      <input id="newPass" type="password" placeholder="รหัสผ่านใหม่" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
    </div>

    <div class="button-group" style="margin-top: 30px; display: flex; gap: 16px; justify-content: center;">
      <button onclick="changePassword()" style="
        padding: 12px 24px;
        background: #52b788;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#40916c'" onmouseout="this.style.background='#52b788'">
        💾 บันทึกรหัสใหม่
      </button>
      <button onclick="closeChangePassword()" style="
        padding: 12px 24px;
        background: #e2e8f0;
        color: #333;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#cbd5e1'" onmouseout="this.style.background='#e2e8f0'">
        ยกเลิก
      </button>
    </div>

    <div id="changeMsg" class="message" style="
      margin-top: 20px;
      font-weight: 500;
      color: #991b1b;
      display: none;
    "></div>
  </div>
</div>


<!-- ✅ Dete USENAME -->
<div id="deleteBox" class="confirm-backdrop" style="display: none;">
  <div class="confirm-box" style="
    max-width: 400px;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    background: #ffffff;
    text-align: center;
    font-family: 'Prompt', sans-serif;
  ">
    <h3 style="font-size: 1.6em; color: #1b4332; display: flex; justify-content: center; align-items: center; gap: 10px;">
      <i class="fa-solid fa-user-slash"></i> ลบบัญชีผู้ใช้
    </h3>

    <p style="margin: 18px 0 25px; color: #555; font-size: 0.95em;">
      โปรดยืนยันชื่อผู้ใช้และรหัสผ่านก่อนลบบัญชีนี้ ข้อมูลทั้งหมดจะไม่สามารถกู้คืนได้
    </p>

    <div style="display: flex; flex-direction: column; gap: 16px;">
      <input id="deleteUser" type="text" placeholder="ชื่อผู้ใช้" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
      <input id="deletePass" type="password" placeholder="รหัสผ่าน" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
    </div>

    <div class="button-group" style="margin-top: 30px; display: flex; gap: 16px; justify-content: center;">
      <button onclick="deleteAccount()" style="
        padding: 12px 24px;
        background: #e63946;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#e63946'">
        ❌ ลบบัญชีนี้
      </button>
      <button onclick="closeDeleteBox()" style="
        padding: 12px 24px;
        background: #e2e8f0;
        color: #333;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#cbd5e1'" onmouseout="this.style.background='#e2e8f0'">
        ยกเลิก
      </button>
    </div>

    <div id="deleteMsg" class="message" style="
      margin-top: 20px;
      font-weight: 500;
      color: #991b1b;
      display: none;
    "></div>
  </div>
</div>


<!-- Logout Confirmation Modal -->
<div id="logoutBox" class="modal-overlay" style="display: none;">
  <div class="modal-box">
    <h3>คุณต้องการออกจากระบบหรือไม่?</h3>
    <div class="modal-buttons">
      <button onclick="confirmLogout()">ยืนยัน</button>
      <button onclick="closeLogoutBox()">ยกเลิก</button>
    </div>
  </div>
</div>





<!-- ✅ CONFIRM MODAL -->
<div id="confirmModal" class="confirm-backdrop" style="display:none;">
  <div class="confirm-box">
    <h3 id="confirmText">คุณแน่ใจหรือไม่?</h3>
    <div class="button-group">
      <button onclick="confirmAction(true)">ยืนยัน</button>
      <button onclick="confirmAction(false)">ยกเลิก</button>
    </div>
  </div>
</div>






<!-- ✅ DASHBOARD PAGE -->
<div id="dashboardPage" style="display: none; flex-direction: row; width: 100vw; height: 100vh;">

  <!-- Sidebar -->
  <div class="sidebar">
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="agrotech-logo.png" alt="Logo" class="sidebar-logo">
    </div>

    <!-- ✅ เพิ่ม data-page และลบ class="active" ยกเว้นหน้าแรก -->
    <a href="#" data-page="overview" class="active" onclick="showPage('overview', event)"><i class="fas fa-home"></i> Overview</a>
    <a href="#" data-page="lift" onclick="showPage('lift', event)"><i class="fas fa-arrow-up-wide-short"></i> Lift Control</a>
    <a href="#" data-page="agv" onclick="showPage('agv', event)"><i class="fas fa-truck-moving"></i> RGV Control</a>
    <a href="#" data-page="light-control" onclick="showPage('light-control', event)"><i class="fas fa-lightbulb"></i> light-control</a>
    <a href="#" data-page="tray-inbound" onclick="showPage('tray-inbound', event)"><i class="fas fa-arrow-down"></i> Tray Inbound</a>
    <a href="#" data-page="tray-outbound" onclick="showPage('tray-outbound', event)"><i class="fas fa-arrow-up"></i> Tray Outbound</a>
    <a href="#" data-page="workstation" onclick="showPage('workstation', event)"><i class="fas fa-dolly"></i> Workstation</a>
    <a href="#" data-page="tray-master" onclick="showPage('tray-master', event)"><i class="fas fa-database"></i> Tray Master</a>
    <a href="#" data-page="task" onclick="showPage('task', event)"><i class="fas fa-tasks"></i> Task Monitor</a>
    <a href="#" data-page="task-history" onclick="showPage('task-history', event)"><i class="fas fa-clipboard-list"></i> Task History</a>
    <a href="#" data-page="system" onclick="showPage('system', event)"><i class="fas fa-chart-line"></i> System Monitor</a>
    <a href="#" data-page="tray-map" onclick="showPage('tray-map', event)"><i class="fas fa-boxes"></i> Tray Inventory</a>
    <a href="#" data-page="environment" onclick="showPage('environment', event)"><i class="fas fa-chart-line"></i> Environmental</a>
    <a href="#" data-page="planting-plan" onclick="showPage('planting-plan', event)"><i class="fas fa-leaf"></i> Planting Plan</a>
    <a href="#" data-page="planting-history" onclick="showPage('planting-history', event)"><i class="fas fa-book"></i> Planting History</a>
    <a href="#" data-page="user-logs" onclick="showPage('user-logs', event)"><i class="fas fa-terminal"></i> User Activity Log</a>
   <a href="#" data-page="MonitorSensor" onclick="showPage('MonitorSensor', event)"><i class="fas fa-microchip"></i> MonitorSensor</a>

  </div>


  <!-- Main -->
<div class="main">
 <div class="header">

    <div style="display: flex; align-items: center; gap: 20px;">
      
<h1 class="premium-logo">
  <i data-lucide="leaf"></i> PFAL WMS Dashboard
</h1>



      
      <select id="stationSelect" onchange="onStationChange()" class="station-dropdown">
        <option value="1">Station 1</option>
        <option value="2">Station 2</option>
        <option value="3">Station 3</option>
        <option value="4">Station 4</option>
        <option value="5">Station 5</option>
      </select>
    </div>

    <div class="topbar">
      <div class="user-wrapper" id="userWrapper">
        <div class="user-menu" id="currentUser">
          <i class="fas fa-user" style="color:#40916c; margin-right: 6px;"></i> admin ⏷
        </div>
        <div class="user-dropdown" id="userDropdown">
          <div class="dropdown-item" id="toggleTheme">
            <i class="fas fa-moon"></i> <span>Dark Mode</span>
          </div>
          <div class="dropdown-item" onclick="showChangePassword()">
            <i class="fas fa-key"></i> <span>เปลี่ยนรหัสผ่าน</span>
          </div>
          <div class="dropdown-item" onclick="showDeleteBox()">
            <i class="fas fa-user-slash"></i> <span>ลบบัญชีผู้ใช้</span>
          </div>
          <div class="dropdown-item" onclick="showLogoutBox()">
            <i class="fas fa-sign-out-alt"></i> <span>ออกจากระบบ</span>
          </div>
        </div>
      </div>
    </div>
    
</div>


  <!-- ✅ Content Area for each page (loaded dynamically) -->
  <div class="content" id="mainContent"></div>
</div> <!-- ✅ END of dashboardPage -->






<script>
let currentStation = 1; // 🟢 กำหนดค่า default

let currentPage = 'overview'; // ใช้สำหรับ showPage()
let pieChartInstance = null;
let barChartInstance = null;
let hourlyChartInstance = null;
let activeTimers = []; // เก็บ ID ของ Interval ทั้งหมดที่ทำงานอยู่

function clearActiveTimers() {
  activeTimers.forEach(timerId => clearInterval(timerId));
  activeTimers = []; // ล้าง array ให้ว่าง
}

function renderOverviewPage() {
  const html = `
    <div>
      <h2 class="overview-title">
        <i class="fas fa-chart-line"></i> ภาพรวมสถิติ (Overview)
      </h2>

      <div class="summary-cards">
        <div class="summary-card">
          <div class="icon inbound"><i class="fas fa-arrow-down"></i></div>
          <div class="info">
            <div id="totalInbound" class="value">-</div>
            <div class="label">Inbound วันนี้</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="icon outbound"><i class="fas fa-arrow-up"></i></div>
          <div class="info">
            <div id="totalOutbound" class="value">-</div>
            <div class="label">Outbound วันนี้</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="icon total"><i class="fas fa-boxes-stacked"></i></div>
          <div class="info">
            <div id="totalTrays" class="value">-</div>
            <div class="label">จำนวนถาดในคลัง</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="icon ontime"><i class="fas fa-check-double"></i></div>
          <div class="info">
            <div id="onTimeTasks" class="value">- %</div>
            <div class="label">งานสำเร็จตรงเวลา</div>
          </div>
        </div>
      </div>
      
      <div class="overview-grid">
        <div class="overview-card">
          <h3><i class="fas fa-chart-pie"></i> สรุปภาพรวมทั้งหมด</h3>
          <div id="pieChartContainer">
            <canvas id="pieChart"></canvas>
          </div>
        </div>
        <div class="overview-card">
          <h3><i class="fas fa-calendar-alt"></i> สรุปราย 7 วัน</h3>
          <div class="chart-container">
            <canvas id="barChart"></canvas>
          </div>
        </div>
        <div class="overview-card">
          <h3><i class="fas fa-clock"></i> สรุปรายชั่วโมง (วันนี้)</h3>
          <div class="chart-container">
            <canvas id="hourlyChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadFullOverviewData(currentStation); 
}





// ✅ [ฟังก์ชันใหม่] สำหรับโหลดข้อมูลทั้งหมดในหน้า Overview
async function loadFullOverviewData(stationId) {
  try {
    // โหลดข้อมูลสำหรับกราฟ (เหมือนเดิม)
    loadOverviewCharts(stationId);

    // โหลดข้อมูลสำหรับ Summary Cards
    const res = await fetch(`/api/overview/summary-cards?station=${stationId}`);
    if (!res.ok) throw new Error('Failed to fetch summary data');
    const data = await res.json();
    
    // อัปเดตข้อมูลในการ์ด
    document.getElementById('totalInbound').textContent = data.today_inbound || '0';
    document.getElementById('totalOutbound').textContent = data.today_outbound || '0';
    document.getElementById('totalTrays').textContent = data.total_trays || '0';
    document.getElementById('onTimeTasks').textContent = `${data.ontime_percentage || '100'} %`;

  } catch (err) {
    console.error("❌ ไม่สามารถโหลดข้อมูล Overview ทั้งหมดได้:", err);
    // แสดงค่าเริ่มต้นเมื่อโหลดไม่สำเร็จ
    document.getElementById('totalInbound').textContent = 'N/A';
    document.getElementById('totalOutbound').textContent = 'N/A';
    document.getElementById('totalTrays').textContent = 'N/A';
    document.getElementById('onTimeTasks').textContent = 'N/A';
  }
}



// ✅ MOCK DATA ตัวอย่าง
const trays = [
  { veg_type: "ผักบุ้ง", floor: 2, slot: 3, start_date: "2025-05-10", harvest_date: "2025-05-20" },
  { veg_type: "คะน้า", floor: 3, slot: 5, start_date: "2025-05-12", harvest_date: "2025-05-24" },
  { veg_type: "เรดโอ๊ค", floor: 4, slot: 6, start_date: "2025-05-01", harvest_date: "2025-05-20" },
  { veg_type: "บัตเตอร์เฮด", floor: 5, slot: 7, start_date: "2025-05-15", harvest_date: "2025-05-26" },
  { veg_type: "ผักชี", floor: 6, slot: 8, start_date: "2025-05-16", harvest_date: "2025-05-20" },
  { veg_type: "ผักกาด", floor: 7, slot: 9, start_date: "2025-05-17", harvest_date: "2025-05-21" },
  { veg_type: "โหระพา", floor: 8, slot: 10, start_date: "2025-05-10", harvest_date: "2025-05-20" },
  { veg_type: "กรีนโอ๊ค", floor: 1, slot: 1, start_date: "2025-05-18", harvest_date: "2025-05-28" },
  { veg_type: "เคล", floor: 2, slot: 2, start_date: "2025-05-19", harvest_date: "2025-05-29" },
  { veg_type: "สลัด", floor: 3, slot: 3, start_date: "2025-05-20", harvest_date: "2025-05-30" },
  { veg_type: "มินิเรดโอ๊ค", floor: 4, slot: 4, start_date: "2025-05-20", harvest_date: "2025-05-20" }
];
const rowsPerPage = 10;








// 🥦 Global variable สำหรับเก็บสถานะถาดทั้งหมด (ใช้ตัวนี้ตัวเดียว)
let trayInventory = {};
async function loadTrayInventory() {
  trayInventory = {}; // ✅ [แก้ไข] ต้องล้างข้อมูลเป็น Object ว่าง
  try {
    const response = await fetch(`/api/tray-inventory?station=${currentStation}&t=${Date.now()}`);
    if (!response.ok) {
      console.error("Fetch tray inventory failed!");
      return;
    }
    const data = await response.json();
    const newInventory = {};
    data.forEach(tray => {
      const key = `${tray.floor}-${tray.slot}`;
      newInventory[key] = tray;
    });
    
    trayInventory = newInventory;
    console.log("✅ ข้อมูล Inventory ถูกโหลดใหม่เรียบร้อยแล้วสำหรับ Station:", currentStation);

  } catch (error) {
    console.error("❌ เกิดข้อผิดพลาดใน loadTrayInventory:", error);
  }
}

// ✅ เรียกใช้งานครั้งแรก "หลังจาก" ที่หน้าเว็บโหลดเสร็จสมบูรณ์แล้ว
document.addEventListener('DOMContentLoaded', () => {
    // โค้ดส่วนอื่นๆ ที่อยู่ใน DOMContentLoaded ของคุณ...
    // เช่น การตรวจสอบสถานะ login
    const loggedIn = localStorage.getItem("loggedIn");
    if (loggedIn === "true") {
        // ...
        // โหลดข้อมูลถาดเริ่มต้น
        loadTrayInventory();
    } else {
        // ...
    }
});


let currentUsername = null;  // 🌟 ใช้เก็บชื่อผู้ใช้ที่ login สำเร็จ

//รอ ip จริง
const devices = {
  "ESP32-LIFT": { topic: "status/esp32/lift", lastSeen: 0, status: "offline" },
  "ESP32-AGV": { topic: "status/esp32/agv", lastSeen: 0, status: "offline" },
  "AGV-CAM1": { topic: "status/esp32/agvcam1", lastSeen: 0, status: "offline" },
  "AGV-CAM2": { topic: "status/esp32/agvcam2", lastSeen: 0, status: "offline" }
};


//  tabsidebar
function setActiveSidebar(page) {
  const links = document.querySelectorAll(".sidebar a");
  links.forEach(link => {
    const target = link.getAttribute("data-page");
    if (target === page) {
      link.classList.add("active");
    } else {
      link.classList.remove("active");
    }
  });
}




  

  function confirmTray() {
  const floorEl = document.getElementById("floorSelect");
  const slotEl = document.getElementById("slotSelect");
  const vegEl = document.getElementById("vegSelect");
  const msgEl = document.getElementById("trayMsg");

  if (!floorEl || !slotEl || !vegEl || !msgEl) {
    console.warn("❌ [confirmTray] Elements ยังไม่อยู่บน DOM");
    return;
  }

  const floor = floorEl.value;
  const slot = slotEl.value;
  const veg = vegEl.value;

  msgEl.style.display = "none";
  msgEl.className = "message";

  if (!floor || !slot || !veg) {
    msgEl.textContent = "⚠️ กรุณาเลือกข้อมูลให้ครบ";
    msgEl.classList.add("error");
    msgEl.style.display = "block";
    return;
  }

  const key = `${floor}-${slot}`;
  if (trayStatus[key]) {
    msgEl.textContent = `❌ ช่อง ${slot} บนชั้น ${floor} มีถาดอยู่แล้ว!`;
    msgEl.classList.add("error");
  } else {
    msgEl.textContent = `✅ สั่งวาง \"${veg}\" ที่ชั้น ${floor} ช่อง ${slot} เรียบร้อย`;
    msgEl.classList.add("success");
  }
  msgEl.style.display = "block";
}
/**
 * ✅ [แก้ไข] ทำให้ Pop-up แสดงไอคอนตามที่ส่งเข้ามา (Inbound/Outbound)
/**
 * ✅ [แก้ไข] เพิ่มคลาส .danger ให้กับ Icon และ Button
 */
function showConfirmationPopup({ title, subtitle, icon, details, onConfirm }) {

  const isDanger = (icon === 'fa-dolly-flatbed');
  const confirmButtonClass = isDanger ? 'danger' : '';
  const iconClass = isDanger ? 'danger' : '';

  const popupHTML = `
    <div class="popup-overlay" id="confirmationPopup">
      <div class="popup-container">
        <div class="popup-header">
          <i class="fas ${icon} icon ${iconClass}"></i>
          <h2 class="popup-title">${title}</h2>
          <p class="popup-subtitle">${subtitle}</p>
        </div>
        <div class="popup-summary">
          ${details.map(item => `
            <div class="summary-item">
              <span class="label">${item.label}</span>
              <span class="value ${item.highlight ? 'highlight' : ''}">${item.value || '-'}</span>
            </div>
          `).join('')}
        </div>
        <div class="popup-actions">
          <button class="popup-button cancel">ยกเลิก</button>
          <button class="popup-button confirm ${confirmButtonClass}">ยืนยัน</button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', popupHTML);

  const popupElement = document.getElementById('confirmationPopup');
  const confirmBtn = popupElement.querySelector('.popup-button.confirm');
  const cancelBtn = popupElement.querySelector('.popup-button.cancel');

  const closePopup = () => {
    popupElement.remove();
  };

  confirmBtn.onclick = () => {
    onConfirm();
    closePopup();
  };

  cancelBtn.onclick = closePopup;
  popupElement.onclick = (e) => {
    if (e.target === popupElement) {
        closePopup();
    }
  };
}
// ✅ [แก้ไข] ฟังก์ชันยืนยันการนำเข้า ให้กลับไปใช้ slot ที่ผู้ใช้เลือกเอง
async function handleInbound() {
    const data = {
        floor: document.getElementById("inFloor").value,
        slot: document.getElementById("inSlot").value, // ✅ กลับมาใช้ "inSlot"
        veg_type: document.getElementById("inVeg").value,
        quantity: document.getElementById("inPlantQuantity").value,
        batch_id: document.getElementById("inBatchId").value,
        seeding_date: document.getElementById("inSeedingDate").value,
        notes: document.getElementById("inNotes").value,
        username: localStorage.getItem("username"),
        station: currentStation
    };

    if (!data.floor || !data.slot || !data.veg_type) {
        showToast("⚠️ กรุณาเลือก ชั้น, ช่อง และชนิดผักให้ครบ", false);
        return;
    }
  
    showConfirmationPopup({
        title: 'ยืนยันการวางถาดใหม่',
        subtitle: 'โปรดตรวจสอบความถูกต้องของข้อมูล',
        icon: 'fa-leaf',
        details: [
            { label: 'ตำแหน่ง', value: `ชั้น ${data.floor} / ช่อง ${data.slot}`, highlight: true },
            { label: 'ชนิดผัก', value: data.veg_type },
            { label: 'จำนวนต้น', value: data.quantity },
            { label: 'Batch ID', value: data.batch_id },
            { label: 'วันที่เพาะเมล็ด', value: data.seeding_date },
            { label: 'หมายเหตุ', value: data.notes }
        ],
        onConfirm: async () => {
            try {
                const res = await fetch("/api/tray/inbound", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                if (result.error) {
                   showToast(`❌ ${result.error}`, false);
                } else {
                   showToast(`✅ รับคำสั่งวางถาดแล้ว...`, true);
                   refreshDataAndViews();
                }
            } catch (error) {
                console.error("❌ เกิดข้อผิดพลาดขณะวางถาด:", error);
                showToast("❌ ไม่สามารถวางถาดได้ กรุณาลองใหม่", false);
            }
        }
    });
}
// [แก้ไข] ฟังก์ชันยืนยันการนำออก ให้ใช้ข้อมูลจาก LIFO
async function handleOutbound() {
    // ตรวจสอบว่ามีถาดที่ถูกเลือกจากฟังก์ชัน validateOutboundFloor() หรือไม่
    if (!selectedOutboundTray) {
        showToast("⚠️ ไม่ได้เลือกถาดที่ต้องการนำออก กรุณาเลือกชั้นก่อน", false);
        return;
    }

    const data = {
        floor: selectedOutboundTray.floor, // ใช้ข้อมูลที่ระบบเลือกให้
        slot: selectedOutboundTray.slot,   // ใช้ข้อมูลที่ระบบเลือกให้
        reason: document.getElementById("outReason").value,
        destination: document.getElementById("outDestination").value,
        username: localStorage.getItem("username"),
        station: currentStation
    };
    
    showConfirmationPopup({
        title: 'ยืนยันการนำถาดออก',
        subtitle: 'ระบบจะนำถาดที่อยู่หน้าสุดของชั้นที่เลือกออกมา',
        icon: 'fa-dolly-flatbed', // ไอคอนรถเข็น
        details: [
            { label: 'ตำแหน่ง', value: `ชั้น ${data.floor} / ช่อง ${data.slot}`, highlight: true },
            { label: 'ชนิดผัก', value: selectedOutboundTray.veg_type },
            { label: 'เหตุผล', value: data.reason },
            { label: 'ปลายทาง', value: data.destination }
        ],
        onConfirm: async () => {
            try {
                const res = await fetch("/api/tray/outbound", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                if (result.error) {
                    showToast(`❌ ${result.error}`, false);
                } else {
                    showToast(`✅ รับคำสั่งนำถาดออกแล้ว...`, true);
                    // โหลดข้อมูลทั้งหมดใหม่หลังจากทำงานสำเร็จ
                    refreshDataAndViews();
                }
            } catch (error) {
                console.error("❌ นำถาดออกผิดพลาด:", error);
                showToast("❌ ไม่สามารถนำถาดออกได้ กรุณาลองใหม่", false);
            }
        }
    }); 
}
function checkOutboundSlot() {
  const floor = document.getElementById("outFloor").value;
  const slot = document.getElementById("outSlot").value;
  const key = `${floor}-${slot}`;

  // ดึง element ต่างๆ
  const validationBox = document.getElementById("outboundValidationBox");
  const detailsPreview = document.getElementById("trayDetailsPreview");
  const warning = document.getElementById("outboundWarning");
  const reasonSelect = document.getElementById("outReason");
  const destinationInput = document.getElementById("outDestination");
  const confirmBtn = document.getElementById("outboundConfirmBtn");

  const trayInfo = trayInventory[key];

  validationBox.style.display = "block"; // แสดงกล่องข้อความเสมอ

  if (trayInfo) {
    // ---- กรณีเจอถาด ----
    validationBox.classList.add("success");
    validationBox.classList.remove("warning");

    // ✅✅✅ [แก้ไข] จัดรูปแบบวันที่ใหม่ให้เป็น DD/MM/YYYY ✅✅✅
    const formattedDate = new Date(trayInfo.time_in).toLocaleDateString('th-TH', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric' // ใช้ 'numeric' เพื่อให้ได้ปี ค.ศ.
    });

    detailsPreview.innerHTML = `<i class="fas fa-check-circle"></i> พบถาด: ${trayInfo.veg_type} | วางเมื่อ: ${formattedDate}`;
    detailsPreview.style.display = "block";
    warning.style.display = "none";

    // เปิดให้กรอกข้อมูลและกดยืนยัน
    reasonSelect.disabled = false;
    destinationInput.disabled = false;
    confirmBtn.disabled = false;

  } else {
    // ---- กรณีไม่เจอถาด (ช่องว่าง) ----
    validationBox.classList.add("warning");
    validationBox.classList.remove("success");

    warning.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ไม่พบถาดในตำแหน่งนี้ กรุณาเลือกใหม่`;
    warning.style.display = "block";
    detailsPreview.style.display = "none";

    // ปิดการกรอกข้อมูลและปุ่มยืนยัน
    reasonSelect.disabled = true;
    destinationInput.disabled = true;
    confirmBtn.disabled = true;
  }
}

function renderTrayManagement() {
  const html = `
    <div class="section" style="padding: 30px;">
      <h2 style="font-size: 1.8em; color: #1b4332; margin-bottom: 30px;">
        🧺 Tray Management
      </h2>
      <div style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: space-between;">
        ${renderInboundSection()}
        ${renderOutboundSection()}
      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadTrayInventory(); // โหลดครั้งแรก
    const trayTimer = setInterval(loadTrayInventory, 5000); // เริ่ม polling
    activeTimers.push(trayTimer); // ✅ เพิ่ม Timer เข้าสู่ระบบจัดการ
}

function renderInboundPage() {
  return `
    <div class="form-container-deluxe">
      <div class="form-header">
          <h2 class="form-title">
            <i class="fas fa-seedling"></i> ลงทะเบียนถาดใหม่ (Inbound)
          </h2>
          <p class="form-subtitle">กรุณากรอกข้อมูลทั้งหมดเพื่อลงทะเบียนถาดใหม่ในระบบ</p>
      </div>

      <div class="form-grid">
        <div class="form-group">
            <label for="inFloor"><i class="fas fa-layer-group"></i> ชั้น</label>
            <select id="inFloor" class="form-input-deluxe">
                ${[...Array(8)].map((_, i) => `<option value="${i + 1}">ชั้น ${i + 1}</option>`).join('')}
            </select>
        </div>

        <div class="form-group">
            <label for="inSlot"><i class="fas fa-th-large"></i> ช่อง</label>
            <select id="inSlot" class="form-input-deluxe">
                ${[...Array(18)].map((_, i) => `<option value="${i + 1}">ช่อง ${i + 1}</option>`).join('')}
            </select>
        </div>

        <div class="form-group">
            <label for="inVeg"><i class="fas fa-seedling"></i> ชนิดผัก</label>
            <select id="inVeg" class="form-input-deluxe">
                <option>Baby Kale</option><option>Baby Spinach</option><option>Baby Red Oak</option>
                <option>Baby Rocket</option><option>Baby Swiss Chard</option><option>บัตเตอร์เฮด</option>
                <option>ซาลาโนวา</option><option>กรีนคอส</option><option>กรีนโอ๊ค</option>
                <option>กรีนโครอล</option><option>เรดโอ๊ค</option><option>เรดโครอล</option>
                <option>ฟิลไอซ์</option><option>ซอร์เรล</option><option>เคล</option>
                <option>ตั้งโอ๋</option><option>สวิสชาร์ด</option>
            </select>
        </div>

        <div class="form-group">
            <label for="inPlantQuantity"><i class="fas fa-sort-numeric-up"></i> จำนวนต้น</label>
            <input type="number" id="inPlantQuantity" class="form-input-deluxe" placeholder="เช่น 16">
        </div>

        <div class="form-group">
            <label for="inBatchId"><i class="fas fa-tag"></i> รหัสรุ่นการผลิต (Batch ID)</label>
            <input type="text" id="inBatchId" class="form-input-deluxe" placeholder="เช่น BK-020725-A">
        </div>

        <div class="form-group">
            <label for="inSeedingDate"><i class="fas fa-calendar-check"></i> วันที่เพาะเมล็ด</label>
            <input type="date" id="inSeedingDate" class="form-input-deluxe">
        </div>

        <div class="form-group full-width">
            <label for="inNotes"><i class="fas fa-edit"></i> หมายเหตุ</label>
            <textarea id="inNotes" class="form-input-deluxe" rows="4" placeholder="เพิ่มหมายเหตุที่เกี่ยวข้องที่นี่..."></textarea>
        </div>
      </div>

      <button class="form-button-action" onclick="handleInbound()">
          <i class="fas fa-check-circle"></i> ยืนยันและวางถาด
      </button>
    </div>
  `;
}
// [แก้ไข] หน้า Outbound ให้เลือกเฉพาะชั้น
function renderOutboundPage() {
  return `
    <div class="form-container-deluxe">
      <div class="form-header">
        <h2 class="form-title">
          <i class="fas fa-dolly-flatbed" style="color: #e63946;"></i>
          สร้างงานนำออก (Outbound)
        </h2>
        <p class="form-subtitle">เลือก "ชั้น" ที่ต้องการนำถาดออก ระบบจะเลือกถาดที่อยู่หน้าสุดให้โดยอัตโนมัติ</p>
      </div>

      <div class="form-grid" style="grid-template-columns: 1fr;">
        <div class="form-group">
            <label for="outFloor"><i class="fas fa-layer-group"></i> <strong>เลือกชั้น (Lane)</strong></label>
            <select id="outFloor" class="form-input-deluxe" onchange="validateOutboundFloor()">
                <option value="">-- กรุณาเลือกชั้น --</option>
                ${[...Array(9)].map((_, i) => `<option value="${i + 1}">ชั้น ${i + 1}</option>`).join('')}
            </select>
        </div>

        <div id="outboundValidationBox" class="form-group full-width" style="display: none;">
             </div>

        <div class="form-group">
            <label for="outReason"><i class="fas fa-question-circle"></i> เหตุผลการนำออก</label>
            <select id="outReason" class="form-input-deluxe" disabled>
                <option>ตัดแต่ง / เก็บเกี่ยวบางส่วน</option>
                <option>เก็บเกี่ยวทั้งหมด</option>
                <option>ตรวจสอบ / บำรุงรักษา</option>
                <option>กำจัดทิ้ง</option>
                <option>ย้ายตำแหน่งถาด</option>
            </select>
        </div>
        <div class="form-group">
            <label for="outDestination"><i class="fas fa-map-marked-alt"></i> ปลายทาง</label>
            <input type="text" id="outDestination" class="form-input-deluxe" placeholder="เช่น สถานีล้าง, โต๊ะแพ็ค" disabled>
        </div>
      </div>

      <button id="outboundConfirmBtn" class="form-button-action danger" onclick="handleOutbound()" disabled>
          <i class="fas fa-cogs"></i> ยืนยันและสร้างงาน
      </button>
    </div>
  `;
}
// ฟังก์ชันสร้าง select box สไตล์หรู
function createSelectBox(label, id, options) {
  return `
    <div>
      <label style="font-weight: 600; color: #444; display: block; margin-bottom: 8px;">${label}</label>
      <select id="${id}" style="
        width: 100%;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid rgba(0,0,0,0.08);
        background: rgba(255, 255, 255, 0.9);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        font-size: 1em;
        transition: border 0.2s;
      " onfocus="this.style.border='1px solid #4ade80'" onblur="this.style.border='1px solid rgba(0,0,0,0.08)'">
        ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
      </select>
    </div>
  `;
}
function renderTrayMasterPage() {
  const html = `
    <div class="card">
      <h2><i class="fas fa-database"></i> Tray Master - ฐานข้อมูลถาดทั้งหมด</h2>
      
      <div class="user-logs-filters" style="justify-content: flex-start; gap: 16px;">
        
        <div>
          <label>ค้นหาทั่วไป</label>
          <input type="text" id="traySearchInput" placeholder="Tray ID, Batch ID, ชนิดผัก..." oninput="loadTrayMasterData()">
        </div>

        <div>
          <label>กรองตามสถานะ</label>
          <select id="trayStatusFilter" onchange="loadTrayMasterData()">
            <option value="">ทั้งหมด</option>
            <option value="on_shelf">ในคลัง</option>
            <option value="AT_WORKSTATION">ที่ Workstation</option>
          </select>
        </div>

        <div>
          <label>กรองตามชนิดผัก</label>
          <select id="trayVegFilter" onchange="loadTrayMasterData()">
            <option value="">ทั้งหมด</option>
            <option>Baby Kale</option><option>Baby Spinach</option><option>Baby Red Oak</option>
            <option>Baby Rocket</option><option>Baby Swiss Chard</option><option>บัตเตอร์เฮด</option>
            <option>สลัดเรดโอ๊ค</option><option>ซาลาโนวา</option><option>กรีนคอส</option><option>กรีนโอ๊ค</option>
            <option>กรีนโครอล</option><option>เรดโอ๊ค</option><option>เรดโครอล</option>
            <option>ฟิลไอซ์</option><option>ซอร์เรล</option><option>เคล</option>
            <option>ตั้งโอ๋</option><option>สวิสชาร์ด</option>
          </select>
        </div>
      </div>

      <div style="overflow-x:auto;">
          <table class="styled-table">
              <thead>
                  <tr>
                      <th>Tray ID</th>
                      <th>Batch ID</th>
                      <th>ชนิดผัก</th>
                      <th>ตำแหน่ง</th>
                      <th>จำนวน</th>
                      <th>วันที่เพาะ</th>
                      <th>อายุ</th>
                      <th>สถานะ</th>
                      <th>หมายเหตุ</th>
                      <th>คำสั่ง</th>
                  </tr>
              </thead>
              <tbody id="trayMasterTableBody"></tbody>
          </table>
      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
}

function renderWorkstationPage() {
  const html = `
    <div class="card">
      <h2 style="display: flex; align-items: center; gap: 12px;">
        <i class="fas fa-dolly"></i> Workstation - สถานีจัดการถาด
      </h2>
      
      <div id="workstationDisplay">
          </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;

  
}
// ✅ รีเซตความสูงและ scroll ให้แน่ใจว่าแสดงผลหน้า Login ถูกต้อง
function showLoginPage() {
  const container = document.querySelector('.login-container');
  if (container) {
    container.style.height = 'auto';
    container.scrollIntoView({ behavior: 'smooth' });
  }
}

function renderTrayGridView() {
  return `
    <div class="section">
      
      <h2 style="display: flex; align-items: center; gap: 14px; margin-bottom: 20px; color: #1b4332; font-weight: 600;">
        <i class="fas fa-boxes-stacked" style="font-size: 1.6em; color: #8d6e63; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); transform: translateY(-2px);"></i>
        <span>คลังถาด - Tray Inventory</span>
      </h2>

      <div style="overflow-x: auto;">
        <div class="tray-grid" style="display: grid; grid-template-columns: auto repeat(18, 1fr); gap: 12px; padding: 20px;">
          ${generateTrayGridHTML()}
        </div>
      </div>
    </div>
  `;
}
// ✅ [Polished & Animated Edition] ฟังก์ชันสร้างแผนผัง Tray Inventory
function generateTrayGridHTML() {
  let html = "";
  const totalFloors = 8;
  const totalSlots = 18;

  // --- สร้างหัวคอลัมน์ ---
  html += `<div class="tray-header-cell"></div>`; 
  for (let slot = 1; slot <= totalSlots; slot++) {
    html += `<div class="tray-header-cell">ช่อง ${slot}</div>`;
  }

  // --- สร้างแถวและข้อมูล ---
  for (let floor = totalFloors; floor >= 1; floor--) {
    html += `<div class="tray-header-cell">ชั้น ${floor}</div>`;

    for (let slot = 1; slot <= totalSlots; slot++) {
      const key = `${floor}-${slot}`;
      const info = trayInventory[key];
      const isFilled = info && (info.status === 'on_shelf' || info.status === 'IN_STORAGE');
      
      const title = isFilled 
        ? `${info.veg_type} (ID: ${info.tray_id})\nวางเมื่อ: ${new Date(info.time_in).toLocaleString("th-TH")}` 
        : `ว่าง`;

      const onclickAction = isFilled 
        ? `showTrayInfoPopup({ 
             trayId: '${info.tray_id}', 
             username: '${info.username}', 
             veg: '${info.veg_type}', 
             floor: ${floor}, 
             slot: ${slot}, 
             timestamp: '${new Date(info.time_in).toLocaleString("th-TH")}', 
             age: calculateTrayAge('${info.time_in}') 
           })`
        : '';
      
      let cellContent = '';
      if (isFilled) {
        // ✅ เนื้อหาสำหรับช่องที่มีถาด (ดีไซน์ใหม่)
        cellContent = `
          <div class="filled-tray-icon"><i class="fas fa-leaf"></i></div>
          <div class="filled-tray-veg-name">${info.veg_type.substring(0, 12)}</div>
          <div class="filled-tray-id">${info.tray_id}</div>
        `;
      } else {
        // ✅ เนื้อหาสำหรับช่องว่าง
        cellContent = `<span class="empty-slot-coords">ชั้น ${floor} / ${slot}</span>`;
      }

      html += `
        <div class="tray-slot ${isFilled ? 'filled' : 'empty'}"
             title="${title}"
             onclick="${onclickAction}">
          ${cellContent}
        </div>`;
    }
  }
  return html;
}
// ✅✅✅ [FINAL VERSION] ฟังก์ชัน "จัดการหน้า" ที่มีการ Polling อัตโนมัติ ✅✅✅
let trayInventoryInterval = null; // ประกาศตัวแปรไว้นอกฟังก์ชันเพื่อใช้อ้างอิง
function showPage(page) {
  currentPage = page;
  clearActiveTimers(); // ✅ ถูกต้อง: ล้าง Timer ทั้งหมดในที่เดียว
  setActiveSidebar(page);

  const mainContent = document.getElementById("mainContent");
  mainContent.innerHTML = ""; // เคลียร์หน้าจอ
if (page === 'tray-map') {
    // 1. วาดโครงสร้างหลักของหน้า "เพียงครั้งเดียว"
    const initialHTML = `
        <div class="section">
          <h2 style="display: flex; align-items: center; gap: 14px; margin-bottom: 20px; color: #1b4332; font-weight: 600;">
            <i class="fas fa-boxes-stacked" style="font-size: 1.6em; color: #8d6e63; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); transform: translateY(-2px);"></i>
            <span>คลังถาด - Tray Inventory</span>
          </h2>
          <div style="overflow-x: auto;">
            <div class="tray-grid" style="display: grid; grid-template-columns: auto repeat(18, 1fr); gap: 12px; padding: 20px;">
              <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                  <i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...
              </div>
            </div>
          </div>
        </div>
    `;
    mainContent.innerHTML = initialHTML;

    // 2. สร้างฟังก์ชันสำหรับอัปเดต "เฉพาะตาราง"
    const refreshGridOnly = () => {
        loadTrayInventory().then(() => {
            const gridContainer = document.querySelector(".tray-grid");
            // ตรวจสอบว่ายังอยู่หน้านี้ และมี element '.tray-grid' อยู่จริง
            if (gridContainer && currentPage === 'tray-map') {
                gridContainer.innerHTML = generateTrayGridHTML(); // ✅ อัปเดตเฉพาะส่วนตาราง
            }
        });
    };

    // 3. เรียกใช้งานครั้งแรก และตั้งเวลา
    refreshGridOnly();
    const trayTimer = setInterval(refreshGridOnly, 5000); // ตั้งเวลาโหลดซ้ำทุก 5 วินาที
    activeTimers.push(trayTimer);

    return;
}


if (page === 'light-control') {
    renderLightControlPage(); // เรียกใช้ฟังก์ชันวาดหน้าควบคุมไฟ
    return;
  }
  
function renderLightControlPage() {
  const html = `
    <style>
      /* --- สไตล์สำหรับหน้าควบคุมไฟโดยเฉพาะ --- */
      .light-control-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 30px;
        margin-top: 20px;
      }

      .control-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 18px 0;
        border-bottom: 1px solid var(--card-border);
      }
      .overview-card .control-row:last-of-type {
        border-bottom: none;
      }

      .control-label {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 1.1em;
        font-weight: 600;
        color: var(--text-dark);
      }
      .control-label i {
        font-size: 1.5em;
        width: 30px;
        text-align: center;
      }
      .control-label .fa-lightbulb.red { color: #e53935; }
      .control-label .fa-lightbulb.white { color: #fdd835; }
      .control-label .fa-fan { color: #3b82f6; }
      
      .status-count {
        font-size: 0.9em;
        color: var(--text-light);
        font-weight: 500;
        background-color: #f8fafc;
        padding: 4px 12px;
        border-radius: 8px;
        margin-left: 8px;
      }

      .control-actions {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .dimmer-slider {
        -webkit-appearance: none;
        appearance: none;
        width: 120px;
        height: 8px;
        background: #e2e8f0;
        border-radius: 5px;
        outline: none;
        transition: opacity .2s;
      }
      .dimmer-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: var(--primary-light);
        cursor: pointer;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      .dimmer-value {
        font-weight: 600;
        width: 50px;
        text-align: right;
        color: var(--primary-dark);
      }

      .details-btn {
        margin-top: 20px; width: 100%; padding: 12px;
        font-size: 1em; font-weight: 600; color: var(--primary-dark);
        background-color: #e9f5ec; border: 1px solid var(--primary-light);
        border-radius: 12px; cursor: pointer; transition: all 0.2s ease;
      }
      .details-btn:hover { background-color: var(--primary-light); color: white; }
      
      .individual-controls {
        display: none;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 15px; padding-top: 20px; margin-top: 15px;
        border-top: 1px solid var(--card-border);
      }
    </style>

    <h2 class="overview-title">
      <i class="fas fa-lightbulb"></i> ระบบควบคุมไฟและพัดลม
    </h2>

    <div class="overview-card" style="margin-bottom: 30px;">
        <h3><i class="fas fa-cogs"></i> แผงควบคุมทั้งหมด (Global Control)</h3>
        <p class="form-subtitle" style="text-align: left; margin-top: -20px; margin-bottom: 20px;">ใช้สำหรับสั่งการอุปกรณ์ทุกชั้นพร้อมกันในครั้งเดียว</p>
        <div class="control-row">
            <div class="control-label"><i class="fas fa-power-off" style="color: #e53935;"></i><strong>ปิดระบบทั้งหมดฉุกเฉิน</strong></div>
            <button class="form-button-action danger" style="margin:0; padding: 12px 24px; width: auto;" onclick="alert('ปิดระบบทั้งหมด!')">
                <i class="fas fa-exclamation-triangle"></i> EMERGENCY OFF
            </button>
        </div>
    </div>

    <div class="light-control-grid">
      ${Array.from({ length: 7 }, (_, i) => `
      <div class="overview-card" style="animation-delay: ${0.2 + i * 0.05}s;">
        <h3><i class="fas fa-layer-group"></i> ชั้นที่ ${i + 1}</h3>

        <div class="control-row">
            <div class="control-label">
                <i class="fas fa-lightbulb red"></i> ไฟสีแดง <span class="status-count">0/18</span>
            </div>
            <div class="control-actions">
              <span class="dimmer-value">50%</span>
              <input type="range" min="0" max="100" value="50" class="dimmer-slider" oninput="this.previousElementSibling.textContent = this.value + '%'">
            </div>
        </div>
        
        <div class="control-row">
            <div class="control-label">
                <i class="fas fa-lightbulb white"></i> ไฟสีขาว <span class="status-count">0/18</span>
            </div>
            <div class="control-actions">
              <span class="dimmer-value">75%</span>
              <input type="range" min="0" max="100" value="75" class="dimmer-slider" oninput="this.previousElementSibling.textContent = this.value + '%'">
            </div>
        </div>

        <div class="control-row">
            <div class="control-label">
                <i class="fas fa-fan"></i> พัดลม <span class="status-count">0/18</span>
            </div>
            <div class="control-actions">
                <button class="action-btn history" style="background-color: #3b82f6;" onclick="alert('เปิดพัดลมชั้น ${i+1}')"><i class="fas fa-play"></i> เปิดทั้งหมด</button>
                <button class="action-btn" style="background-color: #6b7280;" onclick="alert('ปิดพัดลมชั้น ${i+1}')"><i class="fas fa-stop"></i> ปิดทั้งหมด</button>
            </div>
        </div>

        <button class="details-btn" onclick="alert('เปิดหน้าต่างตั้งเวลาสำหรับชั้น ${i+1}')">
            <i class="fas fa-clock"></i> ตั้งเวลาเปิด/ปิด
        </button>
      </div>
      `).join('')}
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
}
    if (page === 'tray-master') {
    renderTrayMasterPage();
    loadTrayMasterData();
    activeTimers.push(trayMasterTimer);
    return;
}

if (page === 'workstation') {
    renderWorkstationPage(); 

    currentWorkstationState = null; // ✅ [เพิ่มบรรทัดนี้] เพื่อล้างสถานะเก่า

    checkWorkstationStatus(); 
    const workstationTimer = setInterval(checkWorkstationStatus, 3000);
    activeTimers.push(workstationTimer);

    return;
}
if (page === 'overview') {
  requestAnimationFrame(() => renderOverviewPage()); // ✅ ชัวร์ว่า DOM พร้อม
  return;
}


  if (page === 'tray-inbound') {
    html = renderInboundPage();
    document.getElementById("mainContent").innerHTML = html;
    return;
  }

  if (page === 'tray-outbound') {
    // วาดหน้าเว็บ Outbound ขึ้นมาก่อน
    mainContent.innerHTML = renderOutboundPage();

    // โหลดข้อมูลถาดล่าสุดทันทีที่เปิดหน้า และตรวจสอบช่องที่เลือกไว้
    loadTrayInventory().then(() => {
      checkOutboundSlot(); 
    });

    const outboundTimer = setInterval(() => {
      // โหลดข้อมูลใหม่ก่อนเสมอ
      loadTrayInventory().then(() => {
        if (currentPage === 'tray-outbound') {
          checkOutboundSlot();
        }
      });
    }, 5000); // อัปเดตทุก 5 วินาที

    activeTimers.push(outboundTimer);
    return;
  }

if (page === 'task') {
  renderTaskPage(); // วาดโครงสร้างหน้า Task Monitor
  
  // สั่งให้โหลดข้อมูลและวาดตารางทันทีที่เปิดหน้า
  loadTaskMonitor(); 
  
  // เริ่มการ Polling เฉพาะหน้านี้ และเพิ่มเข้าตัวจัดการ
  const taskTimer = setInterval(loadTaskMonitor, 2000); 
  activeTimers.push(taskTimer); 

  return;
}
function renderTaskPage() {
  const html = `
    <div class="card">
      <h2><i class="fas fa-tasks"></i> รายการงานที่กำลังดำเนินการ</h2>
      <table class="styled-table">
        <thead>
          <tr>
            <th>รหัสงาน</th>
            <th>ชั้น</th>
            <th>ช่อง</th>
            <th>สถานะ</th>
            <th>เวลาเริ่ม</th>
            <th>เวลาสำเร็จ</th>
            <th>ประเภท</th>
            <th>ผู้ใช้</th>
            <th>คำสั่ง</th>
          </tr>
        </thead>
        <tbody id="taskTableBody"></tbody>
      </table>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
 loadTaskMonitor();
 //const taskTimer = setInterval(loadTaskMonitor, 2000);
   // activeTimers.push(taskTimer); // ✅ เพิ่ม Timer เข้าสู่ระบบจัดการ
}

if (page === 'task-history') {
  renderTaskHistoryPage();
  return;
}
function renderTaskHistoryPage() {
  const html = `
    <div class="card">
      <h2><i class="fas fa-clipboard-list"></i> ประวัติคำสั่งงานที่สำเร็จ</h2>
      <table class="styled-table">
        <thead>
          <tr>
            <th>รหัสงาน</th>
            <th>ชั้น</th>
            <th>ช่อง</th>
            <th>สถานะ</th>
            <th>เวลาเริ่ม</th>
            <th>เวลาสำเร็จ</th>
            <th>ประเภท</th>
            <th>ผู้ใช้</th>
          </tr>
        </thead>
        <tbody id="taskHistoryTableBody"></tbody>
      </table>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadTaskHistory(); // ใช้ mock data หรือ fetch API จริงภายหลัง
}




  if (page === 'tray') {
    renderTrayManagement();
    return;
  }
if (page === 'lift') {
  const currentFloor = parseInt(localStorage.getItem('currentFloor')) || 1;

  html = `

<div id="liftStatusBox" class="lift-status success">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="margin-right: 12px;">
    <circle cx="12" cy="12" r="10" fill="#2dcc6f"/>
    <path d="M9 12.5l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  ระบบทำงานปกติ
</div>




<div id="liftToast" style="position: fixed; top: 20px; right: 20px; background: #333; color: white; padding: 12px 20px; border-radius: 8px; font-weight: bold; z-index: 9999; display: none;">
  <span id="liftToastMessage"></span>
</div>


    <div class="section">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
        <i class="fas fa-elevator" style="font-size: 1.8rem; color: #2d6a4f;"></i>
        <h2 style="margin: 0; font-size: 1.8rem; font-weight: 600; color: #1b4332;">Lift Control</h2>
      </div>

      <div style="display: flex; align-items: flex-start; gap: 40px; max-width: 1100px; margin: auto;">

        <!-- 🔲 รูปลิฟต์ -->
        <div style="position: relative; width: 260px; height: 600px; border-radius: 12px; overflow: hidden;">
          <img src="lift_9levels.png.jpg" alt="Lift Structure"
               style="width: 100%; height: 100%; object-fit: contain;" />
          <img id="liftCart" src="lift_cart.png.png" alt="Lift Cart"
               style="position: absolute; left: 50%; transform: translateX(-50%);
                      width: 86%; transition: top 0.05s linear; z-index: 10;" />
        </div>

        <!-- 🔢 LEVEL INDICATOR -->
        <div style="height: 600px; display: flex; flex-direction: column; justify-content: space-around;
                    background: #e6f4ea; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <h4 style="text-align:center; margin-bottom: 12px; color: #2d6a4f;">สถานะลิฟต์<br>(LEVEL)</h4>
          ${[...Array(9)].map((_, i) => {
            const level = 8 - i;
            return `<div id="floor-${level}" style="margin: 6px 0; display: flex; align-items: center;">
                      <span data-light style="display:inline-block; width: 16px; height: 16px; border-radius: 50%; 
                           background: #ccc; margin-right: 8px; transition: all 0.3s;"></span>
                      <span style="color: #2d6a4f; font-weight: 600;">ชั้น ${level}</span>
                    </div>`;
          }).join('')}
        </div>

        <!-- 🔘 ปุ่มควบคุม -->
        <div style="min-width: 180px;">
          <div id="currentFloorDisplay"
            style="margin-bottom: 16px; padding: 12px; background: #d8f3dc; color: #1b4332;
                   border: 2px solid #52b788; border-radius: 12px; font-size: 1.1rem; font-weight: bold;
                   text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
            ลิฟต์อยู่ที่ชั้น: <span id="currentFloor">${currentFloor}</span>
          </div>

          <label for="floorSelect" style="font-weight: bold;">เลือกชั้น:</label>
          <select id="floorSelect" style="padding: 8px; width: 100%; margin: 10px 0;">
            ${[...Array(8)].map((_, i) => `<option value="${i + 1}">ชั้น ${i + 1}</option>`).join('')}
          </select>
          <button onclick="moveLift()" 
            style="padding: 10px 20px; background: #2d6a4f; color: white; border: none; border-radius: 6px; width: 100%; cursor: pointer;">
            ย้ายลิฟต์
          </button>

          <div style="margin-top: 20px; padding: 16px; background: #f0fdf4; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <h4 style="color: #1b4332; margin-bottom: 16px;">ควบคุมแบบ Manual</h4>
            <button class="manual-btn"
              onmousedown="startLiftMove('up')"
              onmouseup="stopLiftMove()"
              onmouseleave="stopLiftMove()">
              <i class="fas fa-arrow-up"></i> ขึ้น
            </button>
            <button class="manual-btn"
              onmousedown="startLiftMove('down')"
              onmouseup="stopLiftMove()"
              onmouseleave="stopLiftMove()">
              <i class="fas fa-arrow-down"></i> ลง
            </button>
             <!-- ✅ กล่อง EMERGENCY ที่จัดรูปแบบเหมือนกล่อง Manual -->
<div style="margin-top: 20px; padding: 16px; background: #fff5f5;
            border-radius: 16px; width: 220px; text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #f5c2c7;">
  <h4 style="color: #c1121f; margin-bottom: 16px;">ปุ่มฉุกเฉิน (EMERGENCY)</h4>
  <button id="emButton" onclick="toggleEmergency()"
    style="padding: 12px 20px; font-weight: bold; border: none; border-radius: 8px;
           background: #c1121f; color: white; font-size: 1rem; width: 100%; cursor: pointer;">
    ⛔ หยุดลิฟต์ทันที
  </button>
</div>
          </div>
        </div>
      </div>
    </div>
  `;

  document.getElementById("mainContent").innerHTML = html;

  // ✅ เรียกใช้งานเมื่อโหลดเสร็จ
  initLiftPage();
    connectMqttLift();        // ✅ เพิ่มตรงนี้
  return;
}
function connectMqttLift() {
  client.subscribe("automation/station1/lift/status", (err) => {
    if (err) {
      console.error("❌ MQTT subscribe failed:", err.message);
    } else {
      console.log("✅ MQTT subscribed to automation/station1/lift/status");
    }
  });

  client.on("message", (topic, message) => {
    if (topic === "automation/station1/lift/status") {
      try {
        const data = JSON.parse(message.toString());
        currentLiftFloor = data.floor;
        isLiftMoving = data.moving;
        isEmergency = data.emergency || false;

        // ✅ Sync UI
        updateLiftDisplay(currentLiftFloor);

        const floorDisplay = document.getElementById("currentFloor");
        if (floorDisplay) floorDisplay.innerText = currentLiftFloor;

        const movingStatus = document.getElementById("movingStatus");
        if (movingStatus) movingStatus.innerText = isLiftMoving ? "กำลังเคลื่อนที่..." : "หยุดนิ่ง";

        const statusBox = document.getElementById("liftStatusBox");
        if (statusBox) {
          statusBox.innerText = isEmergency ? "🚨 ลิฟต์ทำงานผิดปกติ" : "🟢 ระบบทำงานปกติ";
        }

      } catch (e) {
        console.error("MQTT parse error:", e);
      }
    }
  });
}
function renderAgvPage() {
  return `
    <div class="section">
      <h2><i class="fas fa-truck-moving"></i> RGV Control</h2>

      <!-- ✅ กล่องสถานะ AGV แบบพรีเมียม -->
      <div id="agvTaskStatus">
        <div class="agv-status-box" style="--boxColor: #0ea5e9;">
          <div class="agv-status-title">
            <i class="fas fa-spinner fa-spin"></i> กำลังโหลดสถานะ...
          </div>
          <div class="agv-status-desc">
            กรุณารอสถานะจากระบบ AGV
          </div>
        </div>
      </div>

      <!-- ✅ Sensor Tags -->
      <div class="sensor-status" id="agvSensorStatus">
        <div class="sensor-tag" id="sensorTray">
          <i class="fas fa-eye"></i> เซ็นเซอร์ถาด: <span>กำลังโหลด...</span>
        </div>
        <div class="sensor-tag" id="sensorPos1">
          <i class="fas fa-location-arrow"></i> ระบุตำแหน่ง 1: <span>กำลังโหลด...</span>
        </div>
        <div class="sensor-tag" id="sensorPos2">
          <i class="fas fa-location-arrow"></i> ระบุตำแหน่ง 2: <span>กำลังโหลด...</span>
        </div>
      </div>

      <!-- ✅ กล้อง RGV -->
      <h3><i class="fas fa-video"></i> กล้อง RGV (Real-Time)</h3>
      <div class="camera-section">
        <!-- กล้องหน้า RGV (หมุนซ้าย) -->
        <div class="camera-box">
          <img src="/api/camera/stream/CAM001" class="rotate-left" />
          <div class="camera-label">
            <i class="fas fa-video"></i> กล้องหน้า RGV
          </div>
        </div>

        <!-- กล้องด้านล่าง RGV -->
        <div class="camera-box">
          <img src="/api/camera/stream/CAM002" class="camera-image" />
          <div class="camera-label">
            <i class="fas fa-video"></i> กล้องด้านล่าง RGV
          </div>
        </div>
      </div>

      <!-- ✅ Manual AGV Control -->
      <h3 style="margin-top: 40px;"><i class="fas fa-tools"></i> Manual AGV Control (MQTT)</h3>
      <div class="main-buttons">
        <button class="btn-premium" onclick="sendAgvCommand('go_lift')">Manual ไป Lift</button>
        <button class="btn-premium" onclick="sendAgvCommand('go_home')">Manual กลับ Home</button>
        <button class="btn-premium" onclick="sendTrayCommand('tray_up')">Manual ยกถาด</button>
        <button class="btn-premium" onclick="sendTrayCommand('tray_down')">Manual วางถาด</button>
      </div>

      <div class="dropdown" style="margin-top: 20px;">
        <label for="slotSelectManual"><strong>เลือกช่องปลายทาง (Manual)</strong></label><br/>
        <select id="slotSelectManual" class="dropdown-select">
          <option value="">เลือกช่อง</option>
          ${[...Array(17)].map((_, i) => `<option value="${i + 1}">ช่อง ${i + 1}</option>`).join('')}
        </select>
        <button class="btn-premium" onclick="handleSlotManual()">ส่ง Manual Slot</button>
      </div>
    </div>
  `;
}
if (page === 'agv') {
  const html = renderAgvPage();
  document.getElementById("mainContent").innerHTML = html;
  const agvStatusEl = document.getElementById('agvTaskStatus');

  function renderPrettyStatus(status) {
    const match = status.match(/^(.*?)(_)?(\d+)?$/);
    const base = match?.[1] || status;
    const suffix = match?.[3] ? parseInt(match[3]) : null;

    switch (base) {
      // --- สถานะทั่วไป ---
      case "idle":
        return { title: "ระบบพร้อมใช้งาน (Idle)", desc: "AGV และระบบควบคุมพร้อมรับคำสั่งใหม่", color: "#6c757d", icon: "fas fa-pause-circle" };
      case "unknown":
        return { title: "กำลังเชื่อมต่อ...", desc: "กำลังรอรับสถานะเริ่มต้นจากระบบ AGV", color: "#0ea5e9", icon: "fas fa-satellite-dish" };
      case "flow_done":
      case "done": // ✅ เพิ่ม case สำหรับ flowState
        return { title: "งานเสร็จสมบูรณ์", desc: "AGV ทำภารกิจสำเร็จเรียบร้อย", color: "#28a745", icon: "fas fa-check-circle" };
      case "error":
        return { title: "เกิดข้อผิดพลาด", desc: "การทำงานล้มเหลว กรุณาตรวจสอบระบบ", color: "#dc3545", icon: "fas fa-exclamation-circle" };

      // --- ✅ สถานะจาก Flow State โดยเฉพาะ ---
      case "inbound_start_lift_tray":
      case "inbound_wait_for_tray_lift":
        return { title: "กำลังยกถาดเริ่มต้น", desc: "รอ AGV ยกถาดขึ้นเพื่อเริ่มงาน Inbound", color: "#ffc107", icon: "fas fa-arrow-alt-circle-up" };
      case "start": // (Outbound)
        return { title: "กำลังเริ่มงาน Outbound", desc: `AGV เริ่มเคลื่อนที่ไปยังช่องที่ ${suffix || '...'}`, color: "#17a2b8", icon: "fas fa-route" };
      case "wait_agv_at_lift":
        return { title: "กำลังรอ AGV", desc: "รอ AGV เคลื่อนที่ไปถึงตำแหน่งลิฟต์", color: "#6610f2", icon: "fas fa-parking" };
      case "lift_moving_up":
        return { title: "ลิฟต์กำลังขึ้น", desc: "ลิฟต์กำลังเคลื่อนที่ขึ้นไปยังชั้นเป้าหมาย", color: "#0dcaf0", icon: "fas fa-arrow-up" };
      case "wait_agv_at_slot":
        return { title: "กำลังรอ AGV", desc: `รอ AGV เคลื่อนที่ไปถึงช่องที่ ${suffix || '...'}`, color: "#198754", icon: "fas fa-map-marker-alt" };
      case "wait_tray_action_done":
        return { title: "กำลังทำงานกับถาด", desc: "รอ AGV ยก/วางถาดให้เสร็จสิ้น", color: "#fd7e14", icon: "fas fa-cogs" };
      case "wait_agv_return_to_lift":
        return { title: "กำลังรอ AGV กลับลิฟต์", desc: "รอ AGV เดินทางจากช่องกลับมาที่ลิฟต์", color: "#007bff", icon: "fas fa-undo-alt" };
      case "lift_moving_down":
        return { title: "ลิฟต์กำลังลง", desc: "ลิฟต์กำลังเคลื่อนที่ลงไปยังชั้น 2", color: "#0d6efd", icon: "fas fa-arrow-down" };
      case "wait_agv_home":
        return { title: "AGV กำลังกลับฐาน", desc: "รอ AGV เดินทางกลับสู่จุดเริ่มต้น", color: "#6c757d", icon: "fas fa-home" };
      case "outbound_wait_for_final_place":
        return { title: "กำลังวางถาดคืน", desc: "รอ AGV วางถาดที่ตำแหน่ง Home หลังจบงาน Outbound", color: "#20c997", icon: "fas fa-box-open" };

      // --- สถานะจาก AGV (ยังคงไว้เป็น Fallback) ---
      case "agv_moving_to_slot":
        return { title: "กำลังไปยังช่องจัดเก็บ", desc: suffix ? `AGV กำลังไปยังช่องที่ ${suffix}` : "AGV กำลังไปยังช่องจัดเก็บ", color: "#17a2b8", icon: "fas fa-route" };
      case "agv_arrived_at_slot":
        return { title: "ถึงช่องแล้ว", desc: suffix ? `AGV ถึงช่องที่ ${suffix} เรียบร้อย` : "AGV ถึงช่องจัดเก็บเรียบร้อย", color: "#198754", icon: "fas fa-boxes" };
      case "arrived_at_home":
        return { title: "ถึงฐานแล้ว", desc: "AGV กลับถึงที่หมายและพร้อมสำหรับงานต่อไป", color: "#28a745", icon: "fas fa-parking" };

      // --- สถานะ Default ---
      default:
        return { title: "กำลังประมวลผล...", desc: `สถานะปัจจุบัน: ${status}`, color: "#adb5bd", icon: "fas fa-spinner fa-spin" };
    }
  }

  async function fetchAgvStatus() {
    try {
      const res = await fetch(`/api/agv/status?_t=${new Date().getTime()}`);
      const data = await res.json();
      const rawStatus = data.status || 'unknown';
      const pretty = renderPrettyStatus(rawStatus);

      const isGlowingStatus = [
        'working', 'moving', 'processing', 'agv_moving_to_slot', 'agv_moving_to_lift', 'lift_moving_up', 'lift_moving_down',
        'pickup_tray', 'agv_returning_home', 'agv_returning_to_lift', 'wait_agv_at_lift', 'wait_agv_at_slot',
        'wait_tray_action_done', 'wait_agv_return_to_lift', 'wait_agv_home'
      ].includes(rawStatus.replace(/_\d+$/, ''));

      agvStatusEl.innerHTML = `
        <div class="agv-status-box ${isGlowingStatus ? 'glow' : ''}" style="--boxColor: ${pretty.color || '#999'}">
          <div class="agv-status-title">
            <i class="${pretty.icon || 'fas fa-question-circle'}"></i> ${pretty.title || 'ไม่มีสถานะ'}
          </div>
          <div class="agv-status-desc">${pretty.desc || 'ไม่มีรายละเอียดเพิ่มเติม'}</div>
        </div>
      `;
    } catch (err) {
      agvStatusEl.innerHTML = `
        <div class="agv-status-box error">
          <div class="agv-status-title">
            <i class="fas fa-exclamation-triangle"></i> ไม่สามารถโหลดสถานะได้
          </div>
          <div class="agv-status-desc"> กรุณาตรวจสอบการเชื่อมต่อกับระบบ AGV </div>
        </div>
      `;
      console.error('[AGV Status Error]', err);
    }
  }

  fetchAgvStatus();
  setInterval(fetchAgvStatus, 2000);

  return;
}



  if (page === 'system') {
    html = `
      <div class="section">
        <h2 style="margin-bottom: 20px; color:#2d6a4f;">🔧 System Monitor</h2>
        <div id="systemStatus" style="display: flex; gap: 20px; flex-wrap: wrap;"></div>
      </div>
    `;
    document.getElementById("mainContent").innerHTML = html;
    return;
  }

  if (page === 'environment') {
    html = `
      <div class="section">
        <h2 style="color: #2d6a4f;">📊 Environmental Data (Real-Time)</h2>
        <canvas id="co2Chart" style="max-height: 300px;"></canvas>
        <canvas id="tempChart" style="max-height: 300px; margin-top: 30px;"></canvas>
        <canvas id="humidityChart" style="max-height: 300px; margin-top: 30px;"></canvas>
      </div>
    `;
    document.getElementById("mainContent").innerHTML = html;
    setupEnvironmentCharts();
    if (window.environmentInterval) clearInterval(window.environmentInterval);
    window.environmentInterval = setInterval(updateEnvironmentCharts, 5000);
    return;

  }if (page === 'planting-plan') {
  renderPlantingPlanPage();
  return;
}

function renderPlantingPlanPage() {
  const html = `
    <div class="card">
      <h2><i class="fas fa-seedling"></i> แผนการปลูก</h2>
      <table class="styled-table">
        <thead>
          <tr>
            <th>ชื่อผัก</th>
            <th>ชั้น</th>
            <th>ช่อง</th>
            <th>วันที่วาง</th>
            <th>วันเก็บเกี่ยว</th>
            <th>สถานะ</th>
            <th>คำสั่ง</th>
          </tr>
        </thead>
        <tbody id="realPlanTableBody"></tbody>
      </table>
      <div id="plantingPagination" class="pagination"></div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadRealPlanMock();
}

if (page === 'planting-history') {
  renderPlantingHistoryPage();
  return;
}

function renderPlantingHistoryPage() {
  const html = `
    <div class="card">
      <h2><i class="fas fa-book-open"></i> ประวัติการปลูกย้อนหลัง</h2>
      <table class="styled-table">
        <thead>
          <tr>
            <th>ชื่อผัก</th>
            <th>ชั้น</th>
            <th>ช่อง</th>
            <th>วันที่วาง</th>
            <th>วันเก็บเกี่ยว</th>
            <th>วันที่นำออก</th>
            <th>หมายเหตุ</th>
          </tr>
        </thead>
        <tbody id="plantingHistoryTableBody"></tbody>
      </table>
      <div id="historyPagination" class="pagination"></div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadPlantingHistoryMock(); // ใช้ mock ก่อน เชื่อม SQL ทีหลัง
}


if (page === 'user-logs') {
  renderUserLogsPage();
  return;
}
function renderUserLogsPage() {
  const html = `
    <div class="section">
      <h2><i class="fas fa-terminal"></i> กิจกรรมผู้ใช้ (User Logs)</h2>
      <div class="user-logs-filters">
        <div><label>ค้นหา:</label><input type="text" id="logSearchInput" placeholder="ชื่อผู้ใช้ / การกระทำ / เวลา"></div>
        <div>
          <label>ประเภท:</label>
          <select id="logCategoryFilter">
            <option value="">ทั้งหมด</option><option value="เข้าสู่ระบบ">เข้าสู่ระบบ</option><option value="วางถาด">วางถาด</option>
            <option value="นำถาดออก">นำถาดออก</option><option value="ลิฟต์">ลิฟต์</option><option value="AGV">AGV</option>
          </select>
        </div>
        <div><button onclick="exportLogsToExcelWithLogo()">ดาวน์โหลด Excel</button></div>
      </div>
      <div id="logCardsContainer" class="log-cards-container"></div>
      <div id="pagination"></div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;

  // ✅ ผูก Event Listener เพียงครั้งเดียวหลังจากวาดหน้าเสร็จ
  document.getElementById("logSearchInput").addEventListener("input", () => {
    logCurrentPage = 1;
    renderUserLogs(); 
  });
  document.getElementById("logCategoryFilter").addEventListener("change", () => {
    logCurrentPage = 1;
    renderUserLogs();
  });

  fetchUserLogs();
}



function renderMonitorSensorPage() {
  const html = `
    <div class="section">
      <h2><i class="fas fa-microchip"></i> Monitor Sensor</h2>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 60px; margin-top: 30px; align-items: start;">

        <!-- ✅ LIFT ZONE -->
        <div>
          <h3><i class="fas fa-arrow-up"></i> Lift</h3>
          <div style="text-align:center; margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <img src="lift_9levels.png.jpg" alt="Lift Image"
  style="max-width: 100%; max-height: 350px; width: auto; height: auto; object-fit: contain; aspect-ratio: 3/4; border-radius: 12px;" />

          </div>
          <div class="sensor-group">
            <div class="sensor-item">Gripper Floor 1: <span id="gripper_f1" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Gripper Floor 2: <span id="gripper_f2" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Gripper Floor 3: <span id="gripper_f3" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Gripper Floor 4: <span id="gripper_f4" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Gripper Floor 5: <span id="gripper_f5" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Limit Top: <span id="limit_top" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Limit Bottom: <span id="limit_bottom" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Emergency: <span id="emergency_btn" class="sensor-status-indicator">OFF</span></div>
          </div>
        </div>

        <!-- ✅ AGV ZONE -->
        <div>
          <h3><i class="fas fa-truck-moving"></i> AGV</h3>
          <div style="text-align:center; margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <img src="AGV.png" alt="AGV Image"
              style="max-width: 100%; max-height: 350px; width: auto; height: auto; object-fit: contain; aspect-ratio: 4/3; border-radius: 12px;" />
          </div>
          <div class="sensor-group">
            <div class="sensor-item">Tray Sensor: <span id="tray_sensor" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Position Sensor 1: <span id="pos_sensor1" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Position Sensor 2: <span id="pos_sensor2" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Limit AGV 1: <span id="limit_agv_1" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Limit AGV 2: <span id="limit_agv_2" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Power ON: <span id="agv_on" class="sensor-status-indicator">OFF</span></div>
          </div>
        </div>

      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
}



if (page === "MonitorSensor") {
  renderMonitorSensorPage();
    return;
}



  // fallback: แสดงหน้าเปล่าๆ
  document.getElementById("mainContent").innerHTML = "<div class='section'>ไม่พบหน้านี้</div>";
}




    

  let confirmCallback = null;

  function showConfirmDialog(message, callback) {
    document.getElementById('confirmText').innerText = message;
    document.getElementById('confirmModal').style.display = 'flex';
    confirmCallback = callback;
  }

  function confirmAction(result) {
    document.getElementById('confirmModal').style.display = 'none';
    if (confirmCallback) confirmCallback(result);
  }
  function switchTab(tab) {
  document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
  if (tab === 'in') {
    document.getElementById("inboundTab").style.display = 'block';
    document.getElementById("outboundTab").style.display = 'none';
    document.querySelector(".tab-button:nth-child(1)").classList.add("active");
  } else {
    document.getElementById("inboundTab").style.display = 'none';
    document.getElementById("outboundTab").style.display = 'block';
    document.querySelector(".tab-button:nth-child(2)").classList.add("active");
  }
}

// ✅ Login function แก้ไขสมบูรณ์
function login() {
  const userEl = document.querySelector('input#username');
  const passEl = document.querySelector('input#password');
  const msgEl = document.querySelector('#loginMsg');

  if (!userEl || !passEl || !msgEl) {
    console.warn("❌ ไม่พบ input หรือ div loginMsg บน DOM");
    return;
  }

  const user = userEl.value.trim();
  const pass = passEl.value.trim();
  msgEl.textContent = '';
  msgEl.style.color = '';

  fetch("/api/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: user, password: pass })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      msgEl.style.color = '#dc2626';
      msgEl.textContent = `❌ ${data.error}`;
      msgEl.style.display = 'block';
    } else {
      // ✅ เก็บ userId และ username ลง localStorage
      localStorage.setItem("loggedIn", "true");
      localStorage.setItem("username", data.username);
      localStorage.setItem("userId", data.id);  // <-- ส่วนสำคัญที่เพิ่ม

      document.getElementById("loginPage").style.display = "none";
      document.getElementById("dashboardPage").style.display = "flex";

      // ✅ ดึงชื่อ user ไปใส่ในมุมขวาบน
      document.getElementById("currentUser").innerHTML =
        `<i class="fas fa-user" style="color:#40916c; margin-right: 6px;"></i> ${data.username} ⏷`;

      showPage('overview');
      logAction(data.username, "เข้าสู่ระบบ", "เข้าสู่ระบบ");
    }
  })
  .catch(err => {
    console.error("❌ login error", err);
    msgEl.style.color = '#b91c1c';
    msgEl.textContent = '❌ ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้';
  });
}



document.addEventListener("DOMContentLoaded", function () {
  const loggedIn = localStorage.getItem("loggedIn");
  const username = localStorage.getItem("username");

  if (loggedIn === "true" && username) {
    currentUsername = username;

    document.getElementById("loginPage").style.display = "none";
    document.getElementById("dashboardPage").style.display = "flex";

    document.getElementById("currentUser").innerHTML =
      `<i class="fas fa-user" style="color:#40916c; margin-right: 6px;"></i> ${username} ⏷`;

    showPage("overview");
  } else {
    document.getElementById("loginPage").style.display = "flex";
    document.getElementById("dashboardPage").style.display = "none";
  }
});


function register() {
  const regUsername = document.getElementById("regUsername").value;
  const regPassword = document.getElementById("regPassword").value;
  const regRole = document.getElementById("regRole").value;

  fetch("/api/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: regUsername, password: regPassword, role: regRole })
  })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        showToast("❌ " + data.error);
      } else {
        showToast("✅ " + data.message + " กรุณา Login");
        showPage("login");
      }
    })
    .catch(err => showToast("เกิดข้อผิดพลาดในการเชื่อมต่อ"));
}

function showToast(message, success = true) {
  const toast = document.getElementById("toast");
  toast.innerText = message;

  // สีพื้นหลัง / ข้อความตาม success
  toast.style.backgroundColor = success ? "#d1fae5" : "#fee2e2";
  toast.style.color = success ? "#065f46" : "#991b1b";

  toast.classList.add("show");

  // หายไปใน 3 วินาที
  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}









function showOutput(text) {
  const output = document.getElementById("output") || document.createElement("div");
  output.id = "output";
  output.innerText = typeof text === "object" ? JSON.stringify(text, null, 2) : text;
  output.style.background = "#eee";
  output.style.padding = "10px";
  document.body.appendChild(output);
}




function showChangePassword() {
  document.getElementById("changeBox").style.display = "flex";
}

function closeChangePassword() {
  document.getElementById("changeBox").style.display = "none";

  // 🧼 ล้าง input และข้อความแจ้งเตือน
  document.getElementById("changeUser").value = "";
  document.getElementById("oldPass").value = "";
  document.getElementById("newPass").value = "";
  const msg = document.getElementById("changeMsg");
  msg.style.display = "none";
  msg.textContent = "";
  msg.className = "message";
}



  // ✅ ฟังก์ชันกลับไปหน้าล็อกอิน
  function backToLogin() {
  document.getElementById("registerPage").style.display = "none";

  const loginPage = document.getElementById("loginPage");
  loginPage.style.display = "flex";
  loginPage.style.flexDirection = "column";
  loginPage.style.justifyContent = "center";
  loginPage.style.alignItems = "center";
  loginPage.style.height = "100vh";
}

  
  function showRegister() {
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("registerPage").style.display = "block";
}

function goToRegister() {
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("registerPage").style.display = "block";
}

function goToChangePassword() {
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("changePasswordPage").style.display = "block";
}



//ลบบัญชี
function deleteAccount() {
  const inputUser = document.getElementById('deleteUser').value.trim();
  const inputPass = document.getElementById('deletePass').value.trim();
  const currentUser = localStorage.getItem('currentUser');
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  const msg = document.getElementById('deleteMsg');

  // Reset message
  msg.style.display = "none";
  msg.style.color = "#991b1b";

  // 1️⃣ ตรวจสอบว่าผู้ใช้กรอกครบไหม
  if (!inputUser || !inputPass) {
    msg.innerText = "กรุณากรอกชื่อผู้ใช้และรหัสผ่าน";
    msg.style.display = "block";
    return;
  }

  // 2️⃣ ตรวจสอบว่า inputUser ตรงกับ currentUser
  if (inputUser !== currentUser) {
    msg.innerText = "ชื่อผู้ใช้ไม่ตรงกับบัญชีที่เข้าสู่ระบบ";
    msg.style.display = "block";
    return;
  }

  // 3️⃣ ตรวจสอบรหัสผ่าน
  if (users[currentUser] !== inputPass) {
    msg.innerText = "รหัสผ่านไม่ถูกต้อง";
    msg.style.display = "block";
    return;
  }

  // 4️⃣ ยืนยันและลบบัญชี
  delete users[currentUser];

  // ถ้ายังอยากให้มี admin อยู่เสมอ
  if (!users["admin"]) {
    users["admin"] = "1234";
  }

  localStorage.setItem("users", JSON.stringify(users));
  msg.style.color = "#065f46";
  msg.innerText = "บัญชีถูกลบเรียบร้อยแล้ว";
  msg.style.display = "block";

  // 5️⃣ ออกจากระบบหลังจากลบ
  setTimeout(() => {
    logout();
  }, 1500);
}

function closeDeleteBox() {
  document.getElementById("deleteBox").style.display = "none";
  document.getElementById("deleteMsg").style.display = "none";
}

function showDeleteBox() {
  document.getElementById("deleteUser").value = "";
  document.getElementById("deletePass").value = "";
  document.getElementById("deleteMsg").style.display = "none";
  document.getElementById("deleteBox").style.display = "flex";
}

function showLogoutBox() {
  document.getElementById("logoutBox").style.display = "flex";
}

function closeLogoutBox() {
  document.getElementById("logoutBox").style.display = "none";
}

function confirmLogout() {
  localStorage.removeItem("loggedIn");
  localStorage.removeItem("currentUser");
  localStorage.removeItem("userRole");

  closeLogoutBox();
  document.getElementById("dashboardPage").style.display = "none";
  document.getElementById("loginPage").style.display = "flex";
}



  function logout() {
  // ล้างข้อมูลการเข้าสู่ระบบ
  localStorage.removeItem("loggedIn");
  localStorage.removeItem("currentUser");
  
  window.onload = function () {
  const loggedIn = localStorage.getItem("loggedIn");

  if (loggedIn === "true") {
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("dashboardPage").style.display = "block";
  } else {
    document.getElementById("loginPage").style.display = "block";
    document.getElementById("dashboardPage").style.display = "none";
  }
}




  // รีโหลดหน้าเว็บ เพื่อให้กลับไป loginPage (ใน index.html)
  location.reload();
}
function changePassword() {
  const user = document.getElementById("changeUser").value.trim();
  const oldPass = document.getElementById("oldPass").value.trim();
  const newPass = document.getElementById("newPass").value.trim();
  const msg = document.getElementById("changeMsg");

  msg.className = "message";
  msg.style.display = "none";

  if (!user || !oldPass || !newPass) {
    msg.textContent = "⚠️ กรุณากรอกข้อมูลให้ครบ";
    msg.classList.add("error");
    msg.style.display = "block";
    return;
  }

  const users = JSON.parse(localStorage.getItem("users") || "{}");

  if (!users[user]) {
  msg.textContent = "❌ ไม่พบชื่อผู้ใช้นี้";
  msg.classList.add("error");
} else if (users[user].password !== oldPass) {
  msg.textContent = "❌ รหัสผ่านเดิมไม่ถูกต้อง";
  msg.classList.add("error");
} else {
  users[user].password = newPass;  // ✅ update password ที่ถูกต้อง
  localStorage.setItem("users", JSON.stringify(users));
  msg.textContent = "✅ เปลี่ยนรหัสผ่านสำเร็จ";
  msg.classList.add("success");
}

  msg.style.display = "block";
}


document.addEventListener('DOMContentLoaded', () => {
  const userWrapper = document.getElementById("userWrapper");
  const dropdown = document.getElementById("userDropdown");

  let isHovering = false;
  let hideTimeout;

  userWrapper.addEventListener("mouseenter", () => {
    clearTimeout(hideTimeout);
    dropdown.style.display = "block";
  });

  userWrapper.addEventListener("mouseleave", () => {
    hideTimeout = setTimeout(() => {
      dropdown.style.display = "none";
    }, 200); // รอ 200ms ก่อนซ่อน
  });
});
// ✅ [อัปเดต] ฟังก์ชันวาดตาราง Inventory ให้ส่ง Tray ID ไปยัง Popup
function renderTrayGrid() {
  const grid = document.querySelector(".tray-grid");
  if (!grid) {
    console.warn("⚠️ ยังไม่มี .tray-grid บนหน้า – renderTrayGrid() ถูกเรียกก่อน DOM พร้อม");
    return;
  }
  grid.innerHTML = "";

  for (let floor = 9; floor >= 1; floor--) {
    for (let slot = 1; slot <= 18; slot++) { // ❗️ ปรับจำนวนช่องเป็น 18
      const key = `${floor}-${slot}`;
      const info = trayInventory[key];

      const isFilled = info && (info.status === 'on_shelf' || info.status === 'IN_STORAGE');

      const div = document.createElement("div");
      div.className = "tray-slot fade-in";
      div.style.padding = "12px";
      div.style.border = "1px solid #ccc";
      div.style.borderRadius = "6px";
      div.style.fontSize = "0.8em";
      div.style.textAlign = "center";
      
      if (isFilled) {
        div.style.background = "#52b788";
        div.style.color = "#fff";
        div.title = `${info.veg_type} \nเวลา: ${info.time_in}`;
        div.classList.add("filled");
      } else {
        div.style.background = "#e2e8f0";
        div.style.color = "#555";
        div.title = `ว่าง`;
        div.classList.add("empty");
      }
      
      div.textContent = `ชั้น ${floor} / ${slot}`;

      div.onclick = () => {
        if (isFilled && info) {
          const placedTime = new Date(info.time_in);
          const now = new Date();
          const diffMs = now - placedTime;
          const diffMins = Math.floor(diffMs / 1000 / 60);
          const hours = Math.floor(diffMins / 60);
          const minutes = diffMins % 60;
          const days = Math.floor(hours / 24);
          const remainHours = hours % 24;

          let ageStr = "";
          if (days > 0) ageStr += `${days} วัน `;
          if (remainHours > 0 || days > 0) ageStr += `${remainHours} ชม. `;
          ageStr += `${minutes} นาที`;

          // ✅ [แก้ไขจุดนี้] เพิ่ม trayId เข้าไป
          showTrayInfoPopup({
            trayId: info.tray_id, 
            username: info.username || "ไม่ระบุ",
            veg: info.veg_type,
            floor: info.floor,
            slot: info.slot,
            timestamp: new Date(info.time_in).toLocaleString("th-TH"),
            age: ageStr
          });
        }
      };
      grid.appendChild(div);
    }
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const userMenu = document.getElementById("currentUser");
  const userDropdown = document.getElementById("userDropdown");
  const toggleButton = document.getElementById("toggleTheme");

  // 👉 กดที่ user menu เพื่อโชว์/ซ่อน dropdown
  userMenu.addEventListener("click", () => {
    const isVisible = userDropdown.style.display === "block";
    userDropdown.style.display = isVisible ? "none" : "block";
  });

  // 👉 คลิกที่อื่น ซ่อน dropdown
  window.addEventListener("click", (e) => {
    if (!userMenu.contains(e.target) && !userDropdown.contains(e.target)) {
      userDropdown.style.display = "none";
    }
  });

  // 🌙 โหลดธีมจาก localStorage ถ้ามี
  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
    if (toggleButton) toggleButton.textContent = "☀️ Light Mode";
  }

  // 🌗 ปุ่ม toggle theme
  if (toggleButton) {
    toggleButton.addEventListener("click", () => {
      const isDark = document.body.classList.toggle("dark-mode");
      toggleButton.textContent = isDark ? "☀️ Light Mode" : "🌙 Dark Mode";
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });
  }
});


const hourlyCtx = document.getElementById('hourlyChart')?.getContext('2d');
if (hourlyCtx) {
  const hourlyChart = new Chart(hourlyCtx, {
    type: 'line',
    data: {
      labels: [...Array(24).keys()].map(h => `${String(h).padStart(2, '0')}:00`),
      datasets: [
        {
          label: 'Inbound',
          data: [1, 0, 2, 1, 3, 4, 6, 9, 12, 10, 8, 7, 5, 6, 7, 9, 8, 7, 5, 4, 3, 2, 1, 0],
          borderColor: '#40916c',
          backgroundColor: 'rgba(64,145,108,0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 3
        },
        {
          label: 'Outbound',
          data: [0, 1, 1, 0, 2, 3, 5, 8, 9, 11, 9, 6, 4, 4, 6, 8, 7, 6, 4, 3, 2, 1, 0, 0],
          borderColor: '#74c69d',
          backgroundColor: 'rgba(116,198,157,0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 3
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'สถิติถาดเข้า/ออก รายชั่วโมง (00:00 - 23:00)',
          font: {
            size: 18
          },
          color: '#1b4332'
        },
        legend: {
          labels: {
            font: { size: 14 },
            color: '#1b4332'
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 2,
            color: '#1b4332'
          },
          title: {
            display: true,
            text: 'จำนวนถาด',
            color: '#1b4332',
            font: {
              size: 14
            }
          }
        },
        x: {
          ticks: {
            color: '#1b4332'
          },
          title: {
            display: true,
            text: 'ช่วงเวลา (ชั่วโมง)',
            color: '#1b4332',
            font: {
              size: 14
            }
          }
        }
      }
    }
  });
}


//การเชื่อมค่อ esp32 จำลอง
function simulateMQTTHeartbeat(topic) {
  // จำลองว่ามี message เข้ามา
  for (const [name, dev] of Object.entries(devices)) {
    if (dev.topic === topic) {
      dev.lastSeen = Date.now();
      dev.status = "online";
    }
  }
}



// ✅ อัปเดต UI ทุก 2 วินาที
function updateSystemUI() {
  const container = document.getElementById("systemStatus");
  if (!container) return; // ✅ ถ้าไม่มี element นี้อยู่ → หยุดทำงานเลย

  container.innerHTML = "";

  const now = Date.now();
  for (const [name, dev] of Object.entries(devices)) {
    const diff = now - dev.lastSeen;
    const isOnline = diff < 10000;
    dev.status = isOnline ? "online" : "offline";

    const card = document.createElement("div");
    card.style = `
      padding: 20px;
      border-radius: 16px;
      background: ${isOnline ? '#d8f3dc' : '#f8d7da'};
      border-left: 8px solid ${isOnline ? '#2d6a4f' : '#c82333'};
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      min-width: 220px;
      font-family: 'Prompt', sans-serif;
    `;

    card.innerHTML = `
      <h3 style="margin: 0 0 10px 0;">${name}</h3>
      <p>Status: <strong style="color: ${isOnline ? '#2d6a4f' : '#c82333'}">${dev.status.toUpperCase()}</strong></p>
      <p>Last Seen: ${isOnline ? (Math.floor(diff / 1000) + 's ago') : '❌ Offline'}</p>
    `;
    container.appendChild(card);
  }
}

// ✅ ฟังก์ชันจำลองการ heartbeat จากแต่ละ ESP32
function simulateMQTTHeartbeat(topic) {
  for (const dev of Object.values(devices)) {
    if (dev.topic === topic) {
      dev.lastSeen = Date.now();
    }
  }
}

let co2Chart, tempChart, humidityChart;
let currentDay = new Date().getDate(); // 🔁 ใช้ตรวจจับวันใหม่

function setupEnvironmentCharts() {
  const co2Ctx = document.getElementById('co2Chart')?.getContext('2d');
  const tempCtx = document.getElementById('tempChart')?.getContext('2d');
  const humidityCtx = document.getElementById('humidityChart')?.getContext('2d');
  const timeNow = () => new Date().toLocaleTimeString('th-TH', { hour12: false });

  co2Chart = new Chart(co2Ctx, {
    type: 'line',
    data: {
      labels: [timeNow()],
      datasets: [{
        label: 'CO2 (ppm)',
        data: [getRandom(440, 520)],
        borderColor: '#ef476f',
        backgroundColor: 'rgba(239, 71, 111, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: { responsive: true }
  });

  tempChart = new Chart(tempCtx, {
    type: 'line',
    data: {
      labels: [timeNow()],
      datasets: [{
        label: 'Temperature (°C)',
        data: [getRandom(24, 30)],
        borderColor: '#ffd166',
        backgroundColor: 'rgba(255, 209, 102, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: { responsive: true }
  });

  humidityChart = new Chart(humidityCtx, {
    type: 'line',
    data: {
      labels: [timeNow()],
      datasets: [{
        label: 'Humidity (%)',
        data: [getRandom(60, 80)],
        borderColor: '#06d6a0',
        backgroundColor: 'rgba(6, 214, 160, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: { responsive: true }
  });
}

function updateEnvironmentCharts() {
  const now = new Date();
  const timeNow = now.toLocaleTimeString('th-TH', { hour12: false });

  // 🔄 รีเซ็ตกราฟตอนข้ามวัน
  if (now.getDate() !== currentDay) {
    currentDay = now.getDate();     // อัปเดตวันใหม่
    resetEnvironmentCharts();       // เคลียร์ข้อมูลเก่าออกจากกราฟ
  }

  const co2Val = getRandom(440, 520);
  const tempVal = getRandom(24, 30);
  const humidVal = getRandom(60, 80);

  function update(chart, value) {
    chart.data.labels.push(timeNow);
    chart.data.datasets[0].data.push(value);
    chart.update();
  }

  update(co2Chart, co2Val);
  update(tempChart, tempVal);
  update(humidityChart, humidVal);
}

function resetEnvironmentCharts() {
  co2Chart.data.labels = [];
  co2Chart.data.datasets[0].data = [];
  co2Chart.update();

  tempChart.data.labels = [];
  tempChart.data.datasets[0].data = [];
  tempChart.update();

  humidityChart.data.labels = [];
  humidityChart.data.datasets[0].data = [];
  humidityChart.update();
}

function getRandom(min, max) {
  return +(Math.random() * (max - min) + min).toFixed(1);
}


// ฟั่งชั่น popup tray inventory (ฉบับปรับปรุงใหม่)
function showTrayInfoPopup({ trayId, username, veg, floor, slot, timestamp, age }) {
  // ป้องกันการสร้าง popup ซ้ำซ้อน
  const existingPopup = document.getElementById("trayInfoPopup");
  if (existingPopup) {
    existingPopup.remove();
  }

  // สร้างโครงสร้าง HTML ของ popup ดีไซน์ใหม่
  const contentHTML = `
    <div class="popup-header-premium">
      <i class="fas fa-boxes"></i>
      <h3>ข้อมูลถาด</h3>
    </div>
    <div class="info-list">
      <div class="info-item">
        <span class="info-label"><i class="fas fa-tag"></i> Tray ID</span>
        <span class="info-value highlight">${trayId || 'ไม่ระบุ'}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-leaf"></i> ชนิดผัก</span>
        <span class="info-value">${veg}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-layer-group"></i> ตำแหน่ง</span>
        <span class="info-value">ชั้น ${floor}, ช่อง ${slot}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-calendar-alt"></i> วางเมื่อ</span>
        <span class="info-value">${timestamp}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-hourglass-half"></i> อายุถาด</span>
        <span class="info-value">${age}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-user-circle"></i> ผู้ใช้</span>
        <span class="info-value">${username || 'ไม่ระบุ'}</span>
      </div>
    </div>
    <div class="close-button-wrapper">
      <button class="close-button" onclick="closeTrayInfoPopup()">
        <i class="fas fa-times"></i> ปิด
      </button>
    </div>
  `;

  // สร้าง Element ของ Popup และเพิ่มเข้าไปในหน้าเว็บ
  const popupBackdrop = document.createElement('div');
  popupBackdrop.id = 'trayInfoPopup';
  popupBackdrop.className = 'tray-popup-backdrop';

  const popupCard = document.createElement('div');
  popupCard.className = 'tray-popup-card';
  popupCard.innerHTML = contentHTML;

  popupBackdrop.appendChild(popupCard);
  document.body.appendChild(popupBackdrop);
}

function closeTrayInfoPopup() {
  const popupBackdrop = document.getElementById("trayInfoPopup");
  if (popupBackdrop) {
    // เพิ่ม class เพื่อเริ่ม animation การปิด
    popupBackdrop.classList.add('closing');
    popupBackdrop.querySelector('.tray-popup-card').classList.add('closing');

    // หน่วงเวลาก่อนลบ Element ออกจาก DOM เพื่อให้ animation เล่นจบ
    setTimeout(() => {
      if (popupBackdrop) {
          popupBackdrop.remove();
      }
    }, 300); // ระยะเวลาควรตรงกับ animation-duration ใน CSS
  }
}






function showTrayPopup(message) {
  const popup = document.getElementById('trayPopup');
  popup.textContent = message || "✅ สำเร็จ";
  popup.style.display = 'block';

  setTimeout(() => {
    popup.style.display = 'none';
  }, 5000); // 5 วินาที
}





function showLiftToast(message) {
  const toast = document.getElementById("liftToast");
  const msg = document.getElementById("liftToastMessage");
  if (!toast || !msg) return;

  msg.textContent = message;
  toast.style.display = "block";

  setTimeout(() => {
    toast.style.display = "none";
  }, 4000);
}






function onStationChange() {
  const select = document.getElementById("stationSelect");
  const selected = parseInt(select.value);
  if (!isNaN(selected)) {
    currentStation = selected;
  } else {
    currentStation = 1; // fallback เผื่อ dropdown ไม่โหลด
  }
  showPage(currentPage); // ✅ reload หน้าเดิม
}




function loadOverviewCharts(stationId) {
  fetch(`/api/overview?station=${stationId}`)
    .then(res => res.json())
    .then(data => {
      renderPie(data.total);
      renderBar(data.daily);
      renderHourly(data.hourly);
    });
}
// ✅ เปลี่ยนชื่อ currentPage เป็น logCurrentPage
let userLogs = []; // เก็บข้อมูล log ที่โหลดมาจาก backend
let logCurrentPage = 1;
const logsPerPage = 10;

// ✅ โหลด log จาก backend
async function fetchUserLogs() {
  const res = await fetch("/api/logs"); // ไม่ต้องใช้ token ในระบบนี้

  if (res.ok) {
    userLogs = await res.json();
    renderUserLogs(); // แสดงผลเมื่อโหลดเสร็จ
  } else {
    alert("โหลดข้อมูล Log ไม่สำเร็จ");
  }
}
// ✅ ฟังก์ชันแปลงประเภทกิจกรรมให้แสดงผลสวยงาม
function mapCategory(log) {
  const act = (log.activity || "").toLowerCase();
  const cat = (log.category || "").toLowerCase();

  if (cat === "tray") {
    if (act.includes("วาง")) return "ถาดเข้า";
    if (act.includes("นำ") && act.includes("ออก")) return "ถาดออก";
    return "จัดการถาด";
  }
  if (cat === "inbound") return "ถาดเข้า";
  if (cat === "outbound") return "ถาดออก";
  if (cat === "lift") return "ลิฟต์";
  if (cat === "agv") return "AGV";
  if (cat === "login") return "เข้าสู่ระบบ";

  if (act.includes("เข้าสู่ระบบ")) return "เข้าสู่ระบบ";
  if (act.includes("วาง")) return "ถาดเข้า";
  if (act.includes("นำ") && act.includes("ออก")) return "ถาดออก";
  if (act.includes("ลิฟ")) return "ลิฟต์";
  if (act.includes("agv")) return "AGV";

  return "-";
}

function renderUserLogs() {
    const container = document.getElementById("logCardsContainer");
    const searchInput = document.getElementById("logSearchInput");
    const categoryFilter = document.getElementById("logCategoryFilter");
    const pagination = document.getElementById("pagination");
    const logsPerPage = 20;

    if (!container || !searchInput || !categoryFilter || !pagination) return;
    
    // โค้ดส่วนที่เหลือที่ใช้ filter ข้อมูลและแสดงผลยังคงเหมือนเดิม
    // ... (ส่วนนี้ในไฟล์ของคุณถูกต้องแล้ว ไม่ต้องแก้ไข) ...
    const query = searchInput.value.toLowerCase();
    const selectedCategory = categoryFilter.value.trim();

    const filtered = userLogs.filter(log =>
      (!selectedCategory || mapCategory(log) === selectedCategory) &&
      (
        (log.username?.toLowerCase().includes(query)) ||
        (log.activity?.toLowerCase().includes(query)) ||
        (log.timestamp && new Date(log.timestamp).toLocaleString().toLowerCase().includes(query))
      )
    );

    const totalPages = Math.ceil(filtered.length / logsPerPage);
    const start = (logCurrentPage - 1) * logsPerPage;
    const pageLogs = filtered.slice(start, start + logsPerPage);
    container.innerHTML = "";

    pageLogs.forEach(log => {
      const card = document.createElement("div");
      card.className = "log-card";
      card.innerHTML = `
        <div><strong>ผู้ใช้:</strong> ${log.username || "-"}</div>
        <div><strong>กิจกรรม:</strong> ${log.activity || "-"}</div>
        <div><strong>เวลา:</strong> ${log.timestamp ? new Date(log.timestamp).toLocaleString() : "-"}</div>
        <button class="expand-btn" onclick="toggleDetails(this)">แสดงรายละเอียด</button>
        <div class="log-details" style="display: none; margin-top: 10px;">
          <div><strong>ประเภท:</strong> ${mapCategory(log)}</div>
          <div><strong>ชั้น:</strong> ${log.floor ?? "-"}</div>
          <div><strong>ช่อง:</strong> ${log.slot ?? "-"}</div>
          <div><strong>ผัก:</strong> ${log.veg_type || "-"}</div>
          <div><strong>สถานี:</strong> ${log.station || "-"}</div>
        </div>
      `;
      container.appendChild(card);
    });

    pagination.innerHTML = "";
    for (let i = 1; i <= totalPages; i++) {
      const active = i === logCurrentPage ? "background:#40916c; color:white;" : "background:#e9f5ec;";
      pagination.innerHTML += `
        <button onclick="goToLogPage(${i})" style="margin: 2px; padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; ${active}">
          ${i}
        </button>
      `;
    }
}


function toggleDetails(button) {
  const detailsDiv = button.nextElementSibling;
  if (detailsDiv.style.display === "none") {
    detailsDiv.style.display = "block";
    button.innerText = "ซ่อนรายละเอียด";
  } else {
    detailsDiv.style.display = "none";
    button.innerText = "แสดงรายละเอียด";
  }
}



// ✅ เรียกเมื่อเปิดหน้านี้
fetchUserLogs();

// ✅ ฟังก์ชันส่ง log แบบใช้ username (frontend → /api/log)
function logAction(username, activity, action_type = "ทั่วไป", category, station = "", floor = "", slot = "", veg_type = "", description = "") {
  // ✅ กรณีไม่ได้ส่ง username → ดึงจาก localStorage
  if (!username) {
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (user && user.username) {
      username = user.username;
    }
  }

  fetch("/api/log", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username,
      activity,
      action_type,
      category,
      station,
      floor,
      slot,
      veg_type,
      description
    })
  })
  .then(res => res.json())
  .then(data => {
    console.log("✅ Log saved:", data);
  })
  .catch(err => {
    console.error("❌ logAction error:", err);
  });
}
function exportLogsToExcelWithLogo() {
  if (!userLogs || userLogs.length === 0) {
    alert("ไม่มีข้อมูลให้ส่งออก");
    return;
  }

  const exportData = userLogs.map((log, index) => [
    index + 1,
    new Date(log.timestamp).toLocaleString('th-TH', { hour12: false }),
    log.username,
    log.role || "-",
    log.activity,
    log.type,
    log.floor || "-",
    log.slot || "-",
    log.veg_type || "-",
    log.station || "-"
  ]);

  const headers = [
    "ลำดับ", "เวลา", "ผู้ใช้", "บทบาท", "การกระทำ", "ประเภท",
    "ชั้น", "ช่อง", "ชนิดผัก", "สถานี"
  ];

  XlsxPopulate.fromBlankAsync().then(workbook => {
    const sheet = workbook.sheet(0).name("User Logs");

    // ✅ โลโก้เป็นข้อความสวย
    sheet.cell("A1").value("AGROTECH WMS").style({
      bold: true,
      fontSize: 18,
      fontColor: "2d6a4f"
    });

    // ✅ หัวตาราง
    headers.forEach((header, i) => {
      sheet.cell(3, i + 1).value(header).style({
        bold: true,
        fill: "2d6a4f",
        fontColor: "ffffff",
        horizontalAlignment: "center"
      });
      sheet.column(i + 1).width(16);
    });

    // ✅ ข้อมูล
    exportData.forEach((row, r) => {
      row.forEach((val, c) => {
        sheet.cell(r + 4, c + 1).value(val);
      });
    });

    // ✅ ✅ ✅ FIX: ใช้ .range().autoFilter() แทน
    sheet.range("A3:J3").autoFilter();

    // ✅ freeze row
    sheet.freezePanes(4, 1);

    return workbook.outputAsync();
  }).then(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `user_logs_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.xlsx`;
    a.click();
    URL.revokeObjectURL(url);
  }).catch(err => {
    console.error("❌ Export Error:", err);
    alert("เกิดข้อผิดพลาดในการส่งออก Excel");
  });
}








function calculateTrayAge(time_in_string) {
  if (!time_in_string) return "ไม่ระบุ";
  
  const startTime = new Date(time_in_string);
  const now = new Date();
  let diff = (now.getTime() - startTime.getTime()) / 1000; // ได้ผลต่างเป็นวินาที

  const days = Math.floor(diff / (24 * 3600));
  diff -= days * 24 * 3600;
  const hours = Math.floor(diff / 3600);
  diff -= hours * 3600;
  const minutes = Math.floor(diff / 60);

  let age = "";
  if (days > 0) age += `${days} วัน `;
  if (hours > 0) age += `${hours} ชม. `;
  age += `${minutes} นาที`;
  
  return age;
}


function showTrayDetails(floor, slot) {
  const key = `${floor}-${slot}`;
  const info = trayInventory[key];

  if (!info) {
    alert(`❌ ไม่มีข้อมูลถาดในตำแหน่งนี้\nชั้น ${floor}, ช่อง ${slot}`);
    return;
  }

  const veg = info.veg_type || "ไม่ทราบ";          // ✅ ต้องใช้ veg_type
  const timeText = info.time_in
    ? new Date(info.time_in).toLocaleString("th-TH") // ✅ ต้องใช้ time_in
    : "ไม่พบเวลา";

  let ageStr = "ไม่สามารถคำนวณอายุได้";
  if (info.time_in) {
    const placed = new Date(info.time_in);
    const now = new Date();
    const diff = now - placed;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    ageStr = days > 0 ? `${days} วัน ${hours} ชม.` : `${hours} ชม.`;
  }

  alert(`🔍 ถาด: ${veg}\nชั้น ${floor}, ช่อง ${slot}\nวางเมื่อ: ${timeText}\nอายุ: ${ageStr}`);
}


// ✅ โหลดข้อมูลแสดงในตาราง
function loadRealPlanMock(page = 1) {
  currentPage = page;
  const today = new Date().toISOString().split("T")[0];
  const tbody = document.getElementById("realPlanTableBody");
  tbody.innerHTML = "";

  const start = (page - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const displayTrays = trays.slice(start, end);

  displayTrays.forEach(tray => {
    const isDue = tray.harvest_date <= today;
 const statusHTML = isDue
  ? `<span class="status status-due blink"><i class="fas fa-bell"></i> ถึงวันเก็บเกี่ยว</span>`
  : `<span class="status status-growing"><i class="fas fa-leaf"></i> กำลังเติบโต</span>`;

    const actionHTML = `
      <div class="action-buttons">
        <button onclick="sendRefill(${tray.floor}, ${tray.slot})">เติมน้ำ</button>
        <button onclick="toggleWater(${tray.floor}, ${tray.slot})">เก็บผลผลิต</button>
      </div>
    `;

    const row = document.createElement("tr");
    row.className = isDue ? "harvest-due" : "";
    row.innerHTML = `
      <td>${tray.veg_type}</td>
      <td>ชั้น ${tray.floor}</td>
      <td>ช่อง ${tray.slot}</td>
      <td>${tray.start_date}</td>
      <td>${tray.harvest_date}</td>
      <td>${statusHTML}</td>
      <td>${actionHTML}</td>
    `;
    tbody.appendChild(row);
    // เพิ่มแถวสำหรับแสดงประวัติ (ซ่อนไว้ก่อน)
const historyRow = document.createElement('tr');
historyRow.className = 'history-row';
historyRow.id = `history-${tray.tray_id}`;
historyRow.style.display = 'none';
historyRow.innerHTML = `<td colspan="10"></td>`; // Colspan ต้องเท่ากับจำนวนคอลัมน์ทั้งหมด
tbody.appendChild(historyRow);
  });

  renderPagination();
}

// ✅ [แก้ไข] ฟังก์ชันสำหรับแสดง/ซ่อนประวัติของถาด (ปรับปรุงการแสดงผลอายุ)
async function toggleTrayHistory(trayId, button) {
    const historyRow = document.getElementById(`history-${trayId}`);
    const historyCell = historyRow.querySelector('td');

    const isVisible = historyRow.style.display !== 'none';

    if (isVisible) {
        historyRow.style.display = 'none';
        button.innerText = 'ประวัติ';
        button.style.backgroundColor = '#64748b';
        return;
    }

    historyRow.style.display = 'table-row';
    button.innerText = 'โหลด...';
    button.disabled = true;
    historyCell.innerHTML = '<p style="text-align:center; padding: 10px;">กำลังโหลดประวัติ...</p>';

    try {
        const response = await fetch(`/api/tray/history/${trayId}`);
        const historyData = await response.json();
        
        button.innerText = 'ซ่อน';
        button.style.backgroundColor = '#1f2937';
        button.disabled = false;

        if (!historyData || historyData.length === 0) {
            historyCell.innerHTML = '<p style="text-align:center; font-weight: 500; padding: 10px;">ไม่พบประวัติสำหรับถาดนี้</p>';
            return;
        }

        let historyHtml = `
            <table class="history-table">
                <thead>
                    <tr>
                        <th>เวลา</th>
                        <th>ประเภท</th>
                        <th>ตำแหน่ง</th>
                        <th>อายุถาด (ณ เวลานั้น)</th>
                        <th>จำนวนต้น</th>
                        <th>เหตุผล</th>
                        <th>ผู้ใช้</th>
                    </tr>
                </thead>
                <tbody>
        `;

        historyData.forEach(log => {
            const actionClass = log.action_type === 'inbound' ? 'action-inbound' : 'action-outbound';
            const actionText = log.action_type === 'inbound' ? 'นำเข้า' : 'นำออก';
            
            // --- [ปรับปรุง] ส่วนคำนวณอายุถาด ---
            let ageDisplay = '-';
            // ถ้าไม่ใช่ 'inbound' ค่อยคำนวณอายุ
            if (log.action_type !== 'inbound' && log.birth_time && log.created_at) {
    const actionTime = new Date(log.created_at);
    const birthTime = new Date(log.birth_time); // <-- ✅ เปลี่ยนมาใช้ log.birth_time
    const diffMs = actionTime.getTime() - birthTime.getTime();
    
    if (diffMs >= 0) {
        const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diffMs / (1000 * 60 * 60)) % 24);
        ageDisplay = `${days} วัน ${hours} ชม.`;
    }
}

            historyHtml += `
                <tr>
                    <td>${log.timestamp_th}</td>
                    <td class="${actionClass}">${actionText}</td>
                    <td>ชั้น ${log.floor} / ช่อง ${log.slot}</td>
                    <td>${ageDisplay}</td>
                    <td>${log.plant_quantity || '-'}</td>
                    <td>${log.reason || '-'}</td>
                    <td>${log.username || '-'}</td>
                </tr>
            `;
        });

        historyHtml += '</tbody></table>';
        historyCell.innerHTML = historyHtml;

    } catch (error) {
        console.error('Failed to load tray history:', error);
        historyCell.innerHTML = '<p style="text-align:center; color: red; padding: 10px;">เกิดข้อผิดพลาดในการโหลดประวัติ</p>';
        button.innerText = 'ลองใหม่';
        button.disabled = false;
    }
}




// ✅ สร้างปุ่มเปลี่ยนหน้า
function renderPagination() {
  const totalPages = Math.ceil(trays.length / rowsPerPage);
  const pagination = document.getElementById("plantingPagination");
  pagination.innerHTML = "";

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.className = i === currentPage ? "active" : "";
    btn.onclick = () => loadRealPlanMock(i);
    pagination.appendChild(btn);
  }
}

// ✅ ปุ่มคำสั่ง (mock)
function sendRefill(floor, slot) {
  alert(`💧 เติมน้ำที่ ชั้น ${floor} / ช่อง ${slot}`);
}

function toggleWater(floor, slot) {
  alert(`✅ เก็บผลผลิตที่ ชั้น ${floor} / ช่อง ${slot}`);
}



async function loadTaskMonitor() {
  try {
    const response = await fetch('/api/task-monitor');
    const tasks = await response.json();
    renderTaskTable(tasks);
  } catch (err) {
    console.error('❌ ดึงข้อมูล Task Monitor ล้มเหลว:', err);
  }
}

function renderTaskTable(tasks) {
  const tbody = document.getElementById("taskTableBody");
  tbody.innerHTML = "";

  tasks.forEach(task => {
    const tr = document.createElement("tr");

    const statusClass = task.status === 'done' ? 'success' :
                        task.status === 'error' ? 'error blink' : '' ;

    const endTime = task.completed_at ? formatDate(task.completed_at) : '-';

    tr.innerHTML = `
      <td>${task.tray_id}</td>
      <td>${task.action_type}</td>
      <td>${task.floor || '-'}</td>
      <td>${task.slot || '-'}</td>
      <td>${task.station_id || '-'}</td>
      <td><span class="status ${statusClass}">${convertStatusLabel(task.status)}</span></td>
      <td>${formatDate(task.created_at)}</td>
      <td>${endTime}</td>
      <td>${task.username || '-'}</td>
    `;

    tbody.appendChild(tr);
  });
}
// ในไฟล์ index.html (ส่วน <script>)

function convertStatusLabel(status) {
  if (status === 'pending') return '⏳ รอดำเนินการ';
  if (status === 'working') return '🚚 กำลังทำงาน';
  if (status === 'at_workstation') return '📦 รอที่ Workstation'; // ✅ เพิ่มบรรทัดนี้
  if (status === 'success') return '✅ สำเร็จ'; // ✅ แก้ไขจาก 'done' เป็น 'success' ให้ตรงกับ Backend
  if (status === 'error') return '❌ ผิดพลาด';
  return status; // สำหรับสถานะอื่นๆ ที่อาจมีในอนาคต
}
function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleString("th-TH", { hour12: false });
}


//จำลองประวัติการเคลื่อนที่
function loadTaskHistory() {
  const historyTasks = [
    {
      task_id: "T001",
      floor: 4,
      slot: 8,
      status: "success",
      start_time: "2025-05-21T08:15:00",
      end_time: "2025-05-21T08:16:30",
      type: "tray_inbound",
      username: "admin"
    },
    {
      task_id: "T004",
      floor: 2,
      slot: 5,
      status: "success",
      start_time: "2025-05-21T07:00:00",
      end_time: "2025-05-21T07:01:45",
      type: "agv_move",
      username: "staff02"
    }
  ];

  renderTaskHistoryTable(historyTasks);
}

// task history
function renderTaskHistoryTable(tasks) {
  const tbody = document.getElementById("taskHistoryTableBody");
  tbody.innerHTML = "";

  tasks.forEach(task => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${task.task_id}</td>
      <td>${task.floor || '-'}</td>
      <td>${task.slot || '-'}</td>
      <td><span class="status success">${formatStatus(task.status)}</span></td>
      <td>${formatDate(task.start_time)}</td>
      <td>${formatDate(task.end_time)}</td>
      <td>${task.type}</td>
      <td>${task.username || '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}


async function loadOverviewCharts() {
  try {
    const station = currentStation || 1;

    const [summaryRes, weeklyRes, hourlyRes] = await Promise.all([
      fetch(`/api/stats/summary?station=${station}`),
      fetch(`/api/stats/weekly?station=${station}`),
      fetch(`/api/stats/hourly?station=${station}`)
    ]);

    const summary = await summaryRes.json();
    const weekly = await weeklyRes.json();
    const hourly = await hourlyRes.json();

    renderPieChart(summary);
    renderBarChart(weekly);
    renderHourlyChart(hourly);
  } catch (err) {
    console.error("❌ โหลดข้อมูล overview ไม่สำเร็จ:", err);
  }
}



function renderPieChart(data) {
  if (pieChartInstance) pieChartInstance.destroy(); // ✅ ลบกราฟเก่าออกก่อน
  pieChartInstance = new Chart(document.getElementById('pieChart'), {
    type: 'pie',
    data: {
      labels: ['Inbound (เข้า)', 'Outbound (ออก)'],
      datasets: [{
        data: [data.inbound, data.outbound],
        backgroundColor: ['#b7e4c7', '#52b788']
      }]
    }
  });
}

function getLast7Dates() {
  const dates = [];
  const now = new Date();
  for (let i = 6; i >= 0; i--) {
    const d = new Date(now);
    d.setDate(now.getDate() - i);
    const formatted = d.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit' });
    dates.push(formatted);
  }
  return dates;
}

function renderBarChart(data) {
  if (barChartInstance) barChartInstance.destroy();

  // สร้าง map จากข้อมูลที่ API ส่งมา
  const inboundMap = {};
  const outboundMap = {};

  data.forEach(row => {
    inboundMap[row.date] = row.inbound;
    outboundMap[row.date] = row.outbound;
  });

  // วันที่ย้อนหลัง 7 วัน (เช่น ['21/05', '22/05', ..., '27/05'])
  const labels = getLast7Dates();

  const inboundData = labels.map(date => inboundMap[date] || 0);
  const outboundData = labels.map(date => outboundMap[date] || 0);
barChartInstance = new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Inbound',
                    data: inboundData,
                    backgroundColor: '#52b788', // ✅ สีเขียวหลัก
                    borderRadius: 6
                },
                {
                    label: 'Outbound',
                    data: outboundData,
                    backgroundColor: '#d8f3dc', // ✅ สีเขียวจาง
                    borderRadius: 6
                }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function getHourlyLabels() {
  const hours = [];
  for (let i = 0; i < 24; i++) {
    const label = i.toString().padStart(2, '0') + ':00';
    hours.push(label);
  }
  return hours;
}


function renderHourlyChart(data) {
  if (hourlyChartInstance) hourlyChartInstance.destroy();

  const inboundMap = {};
  const outboundMap = {};

  // ⏱ API ส่ง hour เป็นตัวเลข เช่น 9, 10
  data.forEach(row => {
    const hourLabel = row.hour.toString().padStart(2, '0') + ':00';
    inboundMap[hourLabel] = row.inbound;
    outboundMap[hourLabel] = row.outbound;
  });

  const labels = getHourlyLabels(); // ['00:00', ..., '23:00']

  const inboundData = labels.map(h => inboundMap[h] || 0);
  const outboundData = labels.map(h => outboundMap[h] || 0);

  hourlyChartInstance = new Chart(document.getElementById('hourlyChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Inbound',
                    data: inboundData,
                    borderColor: '#40916c', // ✅ สีเขียวเข้ม
                    backgroundColor: 'rgba(64, 145, 108, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Outbound',
                    data: outboundData,
                    borderColor: '#74c69d', // ✅ สีเขียวกลาง
                    backgroundColor: 'rgba(116, 198, 157, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

// ✅ Global State
let currentFloor = 1;
let liftAnimation = null;
let isEmergency = false;
let liftStatusTimer = null;
let currentUser = JSON.parse(localStorage.getItem("loggedInUser") || "{}");

// ✅ Map ชั้น → ตำแหน่ง %
const levelTop = {
  1: 70, 2: 60, 3: 50, 4: 39, 5: 30,
  6: 20, 7: 12, 8: 5, 9: -1
};

// ✅ แสดงผลตำแหน่งลิฟต์ + จุด sensor
function updateLiftDisplay(floor) {
  const liftCart = document.getElementById("liftCart");
  if (!liftCart) return;

  animateLiftTo(levelTop[floor] ?? 60);

  const floorDisplay = document.getElementById("currentFloor");
  if (floorDisplay) floorDisplay.innerText = floor;

  for (let i = 1; i <= 9; i++) {
    const dot = document.querySelector(`#floor-${i} [data-light]`);
    if (dot) {
      dot.style.background = (i === floor) ? '#52b788' : '#ccc';
      dot.style.boxShadow = (i === floor) ? '0 0 8px #52b788' : 'none';
    }
  }
}

// ✅ เคลื่อน lift อย่างนุ่มนวล
function animateLiftTo(targetPercent) {
  const liftCart = document.getElementById("liftCart");
  if (!liftCart) return;

  cancelAnimationFrame(liftAnimation);
  let currentTop = parseFloat(liftCart.style.top?.replace('%', '')) || targetPercent;
  const duration = 800;
  const startTime = performance.now();

  function step(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 0.5 * (1 - Math.cos(Math.PI * progress));
    const newTop = currentTop + (targetPercent - currentTop) * eased;
    liftCart.style.top = `${newTop}%`;
    if (progress < 1) liftAnimation = requestAnimationFrame(step);
  }

  requestAnimationFrame(step);
}

// ✅ สั่งให้ลิฟต์ไปยังชั้นที่เลือกผ่าน REST
async function moveLift() {
  const targetFloor = parseInt(document.getElementById("floorSelect").value);
  if (!targetFloor || isNaN(targetFloor)) {
    alert("❌ กรุณาเลือกชั้นให้ถูกต้อง");
    return;
  }

  try {
    const res = await fetch("/api/lift/move", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: currentUser.id,
        fromFloor: currentFloor,
        toFloor: targetFloor,
        station: currentStation
      })
    });

    const result = await res.json();
    showToast(`📤 ${result.message}`);
    logLiftAction(currentUser.id, `สั่งลิฟต์ไปชั้น ${targetFloor}`, currentStation, targetFloor);
  } catch (err) {
    showToast("❌ สั่งลิฟต์ล้มเหลว");
    console.error("Move Lift Error:", err.message);
  }
}

// ✅ Jog Up / Down (REST)
function startLiftMove(direction) {
  const action = direction === "up" ? "jogUp" : "jogDown";
  fetch("/api/lift/jog", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId: currentUser.id,
      station: currentStation,
      action: action
    })
  });

  logLiftAction(currentUser.id, `สั่ง Jog ${direction === 'up' ? 'ขึ้น' : 'ลง'}`, currentStation, null);
}

// ✅ หยุด Jog
function stopLiftMove() {
  fetch("/api/lift/stop", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId: currentUser.id,
      station: currentStation
    })
  });

  logLiftAction(currentUser.id, "หยุดลิฟต์ (Jog)", currentStation, null);
}

// ✅ ปุ่ม EMERGENCY (REST)
function toggleEmergency() {
  isEmergency = !isEmergency;

  fetch("/api/lift/emergency", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId: currentUser.id,
      station: currentStation
    })
  });

  const emBtn = document.getElementById("emButton");
  const statusBox = document.getElementById("liftStatusBox");

  if (isEmergency) {
    emBtn.innerText = "✅ กลับสู่สถานะปกติ";
    emBtn.style.background = "#444";
    if (statusBox) statusBox.innerText = "🚨 ลิฟต์ทำงานผิดปกติ";
  } else {
    emBtn.innerText = "⛔ หยุดลิฟต์ทันที";
    emBtn.style.background = "#c1121f";
    if (statusBox) statusBox.innerText = "🟢 ระบบทำงานปกติ";
  }

  logLiftAction(currentUser.id, `EMERGENCY: ${isEmergency ? 'ON' : 'OFF'}`, currentStation, null);
}
function startLiftStatusPolling() {
  if (liftStatusTimer) clearInterval(liftStatusTimer);

  liftStatusTimer = setInterval(async () => {
    try {
      const res = await fetch(`/api/lift/status?station=${currentStation}`);
      const data = await res.json();

      // ✅ Debug log: ดูค่าจริงที่ได้จาก backend
      console.log("[Lift Polling]", data);

      if (!data || typeof data.floor !== "number") return;

      // ✅ อัปเดตตำแหน่งลิฟต์จาก floor sensor จริง
      currentFloor = data.floor;
      updateLiftDisplay(data.floor);

      // ✅ แสดงสถานะการเคลื่อนที่ (ข้อความเล็ก)
      const movingStatus = document.getElementById("movingStatus");
      if (movingStatus) {
        movingStatus.innerText = data.moving ? "กำลังเคลื่อนที่..." : "หยุดนิ่ง";
      }

      // ✅ กล่องแสดงสถานะลิฟต์แบบพรีเมียม
      const statusBox = document.getElementById("liftStatusBox");
      if (statusBox) {
        // ล้าง class เดิม
        statusBox.classList.remove("success", "emergency", "recovery", "working");

        if (Boolean(data.emergency)) {
          // 🟥 หยุดฉุกเฉิน
          statusBox.classList.add("emergency");
          statusBox.innerHTML = `
            <i class="lucide lucide-alert-triangle" style="margin-right: 6px;"></i>
            ลิฟต์หยุดฉุกเฉิน (Emergency Stop)
          `;

        } else if (Boolean(data.recovery)) {
          // 🟧 Recovery กลับตำแหน่งปลอดภัย
          statusBox.classList.add("recovery");
          statusBox.innerHTML = `
            <i class="lucide lucide-rotate-cw" style="margin-right: 6px;"></i>
            กำลังนำลิฟต์กลับสู่ตำแหน่งปลอดภัย...
          `;

        } else if (Boolean(data.moving)) {
          // 🟦 กำลังทำงาน
          statusBox.classList.add("working");
          statusBox.innerHTML = `
            <i class="lucide lucide-truck" style="margin-right: 6px;"></i>
            ลิฟต์กำลังทำงาน
          `;
        } else {
          // 🟢 ปกติ
          statusBox.classList.add("success");
          statusBox.innerHTML = `
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="margin-right: 12px;">
              <circle cx="12" cy="12" r="10" fill="#2dcc6f"/>
              <path d="M9 12.5l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            ระบบทำงานปกติ
          `;
        }
      }

      // ✅ บันทึกสถานะ EM ทั่วระบบ
      isEmergency = Boolean(data.emergency);

    } catch (err) {
      console.warn("❌ โหลดสถานะลิฟต์ล้มเหลว:", err.message);
    }
  }, 500); // polling ทุก 0.5 วินาที
}




// ✅ Log ไป backend
function logLiftAction(userId, activity, station, floor) {
  fetch("/api/log", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId,
      activity,
      action_type: "lift",
      category: "ลิฟต์",
      station,
      floor
    })
  });
}

// ✅ Toast
function showToast(msg) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.innerText = msg;
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    z-index: 9999;
    font-size: 14px;
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ✅ Init ตอนโหลดหน้า
function initLiftPage() {
  const liftCart = document.getElementById("liftCart");
  if (liftCart && levelTop[currentFloor]) {
    liftCart.style.top = `${levelTop[currentFloor]}%`;
  }

  const select = document.getElementById("floorSelect");
  if (select) select.value = currentFloor;

  const display = document.getElementById("currentFloor");
  if (display) display.innerText = currentFloor;

  startLiftStatusPolling();
}

//agv
function handleSlotSelection(slot) {
  if (slot) {
    sendAgvCommandUI(`go_slot${slot}`);
  }
}


//  status  sensor
async function fetchAgvSensorStatus() {
  try {
    const res = await fetch('/api/sensors');
    if (!res.ok) throw new Error("โหลดข้อมูลไม่สำเร็จ");
    const data = await res.json();

    document.querySelector('#sensorTray span').textContent = data.sensor3 ? "✅" : "❌";
    document.querySelector('#sensorPos1 span').textContent = data.sensor1 ? "ถึง" : "ไม่ถึง";
    document.querySelector('#sensorPos2 span').textContent = data.sensor2 ? "ถึง" : "ไม่ถึง";
  } catch (err) {
    console.error("[AGV Sensor] ⚠️ โหลดข้อมูลผิดพลาด:", err);
    document.querySelector('#sensorTray span').textContent = "⚠️";
    document.querySelector('#sensorPos1 span').textContent = "⚠️";
    document.querySelector('#sensorPos2 span').textContent = "⚠️";
  }
}


async function sendAgvCommand(command) {
  try {
    const res = await fetch('/api/agv/manual', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id,
        station: currentStation, // ✅ [แก้ไข] ใช้ตัวแปร currentStation
        command
      })
    });
    const data = await res.json();
    console.log('✅ AGV command sent:', data.message);
  } catch (err) {
    console.error('❌ AGV Command Error:', err);
    alert('ส่งคำสั่ง AGV ไม่สำเร็จ');
  }
}

function handleSlotManual() {
  const slot = document.getElementById("slotSelectManual").value;
  if (!slot) {
    alert("กรุณาเลือกช่องก่อน");
    return;
  }
  const cmd = `go_slot${slot}`;
  sendAgvCommand(cmd);
}


async function sendTrayCommand(command) {
  try {
    const res = await fetch('/api/tray/manual', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id,
       station: currentStation, // ✅ [แก้ไข] ใช้ตัวแปร currentStation
        command  // เช่น tray_up, tray_down
      })
    });
    const data = await res.json();
    console.log('✅ TRAY command sent:', data.message);
  } catch (err) {
    console.error('❌ Tray Command Error:', err);
    alert('ส่งคำสั่ง TRAY ไม่สำเร็จ');
  }
}





async function loadTaskHistory() {
  try {
    const res = await fetch('/api/task/history');
    const data = await res.json();

    const tableBody = document.getElementById('taskHistoryTableBody');
    tableBody.innerHTML = '';

    data.forEach(task => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${task.tray_id}</td>  <!-- ✅ แก้ตรงนี้ -->
        <td>${task.floor}</td>
        <td>${task.slot}</td>
        <td><span class="status ${task.status}">${task.status.toUpperCase()}</span></td>
        <td>${new Date(task.created_at).toLocaleString()}</td>
        <td>${new Date(task.completed_at).toLocaleString()}</td>
        <td>${task.action_type}</td>
        <td>${task.username}</td>
      `;
      tableBody.appendChild(row);
    });
  } catch (err) {
    console.error("❌ Failed to load task history:", err);
  }
}
// [แก้ไข] ฟังก์ชันโหลดข้อมูล Tray Master เพื่อใช้ดีไซน์ปุ่มใหม่
async function loadTrayMasterData() {
    try {
        const res = await fetch('/api/tray-inventory');
        const trays = await res.json();
        const tbody = document.getElementById('trayMasterTableBody');

        if (!tbody) return;
        tbody.innerHTML = '';

        const searchQuery = document.getElementById('traySearchInput').value.toLowerCase();
        const statusFilter = document.getElementById('trayStatusFilter').value;
        const vegFilter = document.getElementById('trayVegFilter').value;

        const filteredTrays = trays.filter(tray => {
            const searchMatch = (
                tray.tray_id.toLowerCase().includes(searchQuery) ||
                (tray.batch_id || '').toLowerCase().includes(searchQuery) ||
                tray.veg_type.toLowerCase().includes(searchQuery)
            );
            const statusMatch = !statusFilter || tray.status === statusFilter;
            const vegMatch = !vegFilter || tray.veg_type === vegFilter;
            return searchMatch && statusMatch && vegMatch;
        });

        if (filteredTrays.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding: 20px;">ไม่พบข้อมูลตามที่กรอง</td></tr>';
            return;
        }

        filteredTrays.forEach((tray, index) => {
            const age = calculateTrayAge(tray.time_in);
            const row = document.createElement('tr');

            // ✅ เพิ่มอนิเมชั่น
            row.className = 'fade-in-row';
            row.style.animationDelay = `${index * 50}ms`;

            // ✅ ใช้ดีไซน์ใหม่
            row.innerHTML = `
                <td>${tray.tray_id}</td>
                <td>${tray.batch_id || '-'}</td>
                <td>${tray.veg_type}</td>
                <td>ชั้น ${tray.floor} / ช่อง ${tray.slot}</td>
                <td>${tray.plant_quantity || '-'}</td>
                <td>${tray.seeding_date ? new Date(tray.seeding_date).toLocaleDateString('th-TH') : '-'}</td>
                <td>${age}</td>
                <td>${renderTrayStatusLabel(tray.status)}</td>
                <td>${tray.notes || '-'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn edit" onclick="editTray('${tray.tray_id}')">
                            <i class="fas fa-pencil-alt"></i> แก้ไข
                        </button>
                        <button class="action-btn history" onclick="toggleTrayHistory('${tray.tray_id}', this)">
                            <i class="fas fa-history"></i> ประวัติ
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);

            const historyRow = document.createElement('tr');
            historyRow.className = 'history-row';
            historyRow.id = `history-${tray.tray_id}`;
            historyRow.style.display = 'none';
            historyRow.innerHTML = `<td colspan="10"></td>`;
            tbody.appendChild(historyRow);
        });

    } catch (err) {
        console.error("❌ โหลดข้อมูล Tray Master ไม่สำเร็จ:", err);
        const tbody = document.getElementById('trayMasterTableBody');
        if(tbody) tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding: 20px;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
    }
}

// [แก้ไข] ฟังก์ชันสร้างป้ายสถานะให้สวยงาม
function renderTrayStatusLabel(status) {
    if (status === 'on_shelf' || status === 'IN_STORAGE') {
        return `<span class="status-badge on-shelf"><i class="fas fa-warehouse"></i> ในคลัง</span>`;
    }
    if (status === 'AT_WORKSTATION') {
        return `<span class="status-badge at-workstation"><i class="fas fa-wrench"></i> ที่ Workstation</span>`;
    }
    return status || 'ไม่ระบุ';
}
// Function ที่จะถูกเรียกเมื่อกดปุ่มแก้ไข (ตัวอย่างเบื้องต้น)
function editTray(trayId) {
    alert(`คุณกำลังจะแก้ไขถาด ID: ${trayId}`);
    // ในขั้นต่อไป คุณสามารถสร้าง Modal popup เพื่อให้ผู้ใช้กรอกข้อมูลใหม่
    // แล้วส่ง request ไปที่ API ที่เราสร้างไว้ด้านบน
}


let workstationTimer = null; // ตัวแปรสำหรับเก็บ interval
let currentWorkstationState = null; // ✅ [เพิ่มใหม่] ใช้สำหรับจำสถานะ Workstation
// ✅✅✅ [แก้ไขใหม่] ฟังก์ชันตรวจสอบสถานะ Workstation แบบอัจฉริยะ ✅✅✅
async function checkWorkstationStatus() {
    try {
        const res = await fetch(`/api/workstation/current?station=${currentStation}`);
        const waitingTray = await res.json();
        const displayDiv = document.getElementById('workstationDisplay');

        if (!displayDiv) return;

        // 1. ตรวจสอบสถานะปัจจุบันของถาด (มี ID หรือเป็น null)
        const newState = waitingTray ? waitingTray.tray_id : null;

        // 2. เปรียบเทียบสถานะใหม่กับสถานะเดิมที่จำไว้
        if (newState === currentWorkstationState) {
            // 3. ถ้าสถานะเหมือนเดิม -> ไม่ต้องทำอะไรเลย ออกจากฟังก์ชันทันที
            return; 
        }

        // 4. ถ้าสถานะเปลี่ยน -> อัปเดตหน้าจอ และจำสถานะใหม่ไว้
        currentWorkstationState = newState;

        // --- ส่วนของการวาดหน้าจอ (จะทำงานเฉพาะตอนที่สถานะเปลี่ยนเท่านั้น) ---
        if (waitingTray) {
            const reason = waitingTray.reason || 'ทั่วไป';
            let actionHTML = '';

            switch (reason.toLowerCase()) {
                case 'กำจัดทิ้ง':
                    actionHTML = `<button class="form-button-action danger" onclick="disposeTray('${waitingTray.tray_id}')"><i class="fas fa-trash-alt"></i> ยืนยันการกำจัดทิ้ง</button>`;
                    break;
                case 'ย้ายตำแหน่งถาด':
                    actionHTML = `<button class="form-button-action" style="background: linear-gradient(135deg, #60A5FA, #3B82F6);" onclick="returnTrayToStorage('relocate')"><i class="fas fa-random"></i> ย้ายไปยังตำแหน่งใหม่</button>`;
                    break;
                default:
                    actionHTML = `
                        <div class="popup-actions">
                            <button class="popup-button cancel" onclick="disposeTray('${waitingTray.tray_id}')"><i class="fas fa-check-circle"></i> เสร็จสิ้น (นำออก)</button>
                            <button class="popup-button confirm" onclick="returnTrayToStorage('return')"><i class="fas fa-arrow-left"></i> ส่งกลับเข้าคลัง</button>
                        </div>`;
                    break;
            }

            displayDiv.innerHTML = `
                <div class="popup-container" style="max-width: 700px; margin: 20px auto; animation: popIn 0.4s ease-out;">
                    <div class="popup-header">
                        <i class="fas fa-box-open icon" style="color: #FBBF24;"></i>
                        <h2 class="popup-title">มีถาดรอการจัดการ</h2>
                        <p class="popup-subtitle">กรุณาเลือกคำสั่งสำหรับถาดด้านล่างนี้</p>
                    </div>
                    <div class="popup-summary">
                        <div class="summary-item"><span class="summary-label">Tray ID</span><span class="summary-value">${waitingTray.tray_id}</span></div>
                        <div class="summary-item"><span class="summary-label">ชนิดผัก</span><span class="summary-value highlight">${waitingTray.veg_type || 'N/A'}</span></div>
                        <div class="summary-item"><span class="summary-label">เหตุผลนำออก</span><span class="summary-value" style="font-weight: 700;">${reason}</span></div>
                    </div>
                    <div class="popup-actions" style="grid-template-columns: 1fr; margin-top: 25px;">${actionHTML}</div>
                </div>
            `;
        } else {
            displayDiv.innerHTML = `
                <div class="agv-status-box" style="--boxColor: #6c757d; margin-top: 20px;">
                    <div class="agv-status-title"><i class="fas fa-pause-circle"></i> ไม่มีถาดรอการจัดการ</div>
                    <div class="agv-status-desc">เมื่อมีถาดถูกนำออกมาที่ Home สถานะจะแสดงที่นี่</div>
                </div>
            `;
        }

    } catch(err) {
        console.error("❌ ไม่สามารถเช็คสถานะ Workstation ได้", err);
        // เมื่อเกิด error ก็ควรจะหยุดการทำงานเช่นกัน
        currentWorkstationState = 'error'; // ตั้งสถานะเป็น error เพื่อไม่ให้วนซ้ำถ้า error ตลอด
    }
}





// ✅✅✅ [แก้ไข] ให้ฟังก์ชันรับ tray_id เป็น parameter โดยตรง ✅✅✅
async function disposeTray(tray_id) {
    if (!tray_id) {
        showToast('❌ ไม่พบ Tray ID', false);
        return;
    }

    showConfirmationPopup({
        title: 'ยืนยันการกำจัดถาด',
        subtitle: `คุณต้องการนำถาด ID: ${tray_id} ออกจากระบบใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้`,
        icon: 'fa-trash-alt', // ไอคอนถังขยะ
        details: [
            { label: 'Tray ID ที่จะลบ', value: tray_id, highlight: true },
            { label: 'สถานะ', value: 'จะถูกนำออกจากระบบถาวร' }
        ],
        onConfirm: async () => {
            try {
                await fetch('/api/workstation/dispose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tray_id: tray_id, station_id: currentStation })
                });
                showToast(`✅ นำถาด ID: ${tray_id} ออกแล้ว`, true);
                checkWorkstationStatus(); // รีเฟรชสถานะทันที
            } catch(err) {
                showToast('❌ เกิดข้อผิดพลาดในการนำถาดออก', false);
            }
        }
    });
}

// ✅ [แก้ไข] ฟังก์ชัน editTray เดิมให้ทำงานได้จริง
async function editTray(trayId) {
    // หาข้อมูลถาดจาก trayInventory ที่เรามีอยู่แล้ว
    const tray = Object.values(trayInventory).find(t => t.tray_id === trayId);
    if (!tray) {
        showToast("❌ ไม่พบข้อมูลถาด", false);
        return;
    }

    // นำข้อมูลไปใส่ในฟอร์มของ Modal
    document.getElementById("editTrayId").value = tray.tray_id;
    document.getElementById("editVegType").value = tray.veg_type || '';
    document.getElementById("editPlantQuantity").value = tray.plant_quantity || '';
    document.getElementById("editBatchId").value = tray.batch_id || '';
    // จัดรูปแบบวันที่ให้ input type="date" รับได้ (YYYY-MM-DD)
    document.getElementById("editSeedingDate").value = tray.seeding_date ? new Date(tray.seeding_date).toISOString().split('T')[0] : '';
    document.getElementById("editNotes").value = tray.notes || '';

    // แสดง Modal
    document.getElementById("editTrayModal").style.display = 'flex';
}

// ✅ [เพิ่มใหม่] ฟังก์ชันปิด Modal
function closeEditModal() {
    document.getElementById("editTrayModal").style.display = 'none';
}

// ✅ [เพิ่มใหม่] ฟังก์ชันส่งข้อมูลที่แก้ไขแล้วไป Backend
async function handleUpdateTray() {
    const trayId = document.getElementById("editTrayId").value;
    const updatedData = {
        veg_type: document.getElementById("editVegType").value,
        plant_quantity: document.getElementById("editPlantQuantity").value,
        batch_id: document.getElementById("editBatchId").value,
        seeding_date: document.getElementById("editSeedingDate").value,
        notes: document.getElementById("editNotes").value
    };

    try {
        const res = await fetch(`/api/tray-inventory/${trayId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData)
        });
        const result = await res.json();

        if (result.error) {
            showToast(`❌ ${result.error}`, false);
        } else {
            showToast(`✅ อัปเดตข้อมูลสำเร็จ`, true);
            closeEditModal();
            loadTrayMasterData(); // โหลดข้อมูลใหม่เพื่ออัปเดตตาราง
            loadTrayInventory();  // อัปเดตข้อมูลใน Grid View ด้วย
        }
    } catch(err) {
        showToast("❌ เกิดข้อผิดพลาดในการอัปเดต", false);
    }
}




let returnTrayData = null; // ตัวแปรเก็บข้อมูลถาดที่จะส่งคืน
async function returnTrayToStorage(mode = 'return') {
    const res = await fetch(`/api/workstation/current?station=${currentStation}`);
    const waitingTray = await res.json();
    
    if (!waitingTray) {
        showToast("❌ ไม่พบข้อมูลถาดที่ Workstation", false);
        return;
    }

    const modal = document.getElementById('returnTrayModal');
    const titleElement = modal.querySelector('.popup-title');
    const confirmButton = modal.querySelector('.popup-button.confirm');

    const qtyInput = document.getElementById("returnPlantQuantity");
    const dateInput = document.getElementById("returnSeedingDate");
    const notesInput = document.getElementById("returnNotes");

    // กำหนด Title และปุ่มตามโหมด
    if (mode === 'relocate') {
        titleElement.innerHTML = `<i class="fas fa-random icon" style="color:#60A5FA;"></i> ย้ายตำแหน่งถาด`;
        confirmButton.innerHTML = `<i class="fas fa-check-circle"></i> ยืนยันและย้ายตำแหน่ง`;
        // ปิดการแก้ไขข้อมูล
        [qtyInput, dateInput, notesInput].forEach(el => {
            el.disabled = true;
            el.style.backgroundColor = '#e9ecef';
            el.style.cursor = 'not-allowed';
        });
    } else { 
        titleElement.innerHTML = `<i class="fas fa-arrow-left icon"></i> ส่งกลับเข้าคลัง`;
        confirmButton.innerHTML = `<i class="fas fa-check-circle"></i> ยืนยันและส่งกลับ`;
        // เปิดให้แก้ไข
        [qtyInput, dateInput, notesInput].forEach(el => {
            el.disabled = false;
            el.style.backgroundColor = '';
            el.style.cursor = '';
        });
    }

    // ใส่ข้อมูลเดิมลงในฟอร์ม
    document.getElementById("returnVegType").value = waitingTray.veg_type || '';
    qtyInput.value = waitingTray.plant_quantity || '';
    document.getElementById("returnBatchId").value = waitingTray.batch_id || '';
    dateInput.value = waitingTray.seeding_date ? new Date(waitingTray.seeding_date).toISOString().split('T')[0] : '';
    notesInput.value = waitingTray.notes || '';
    
    // ตั้งค่า onclick ของปุ่มยืนยัน
    confirmButton.setAttribute('onclick', `handleReturnToStorage('${waitingTray.tray_id}', ${waitingTray.station_id})`);
    
    modal.style.display = 'flex';
}

async function handleReturnToStorage(tray_id, station_id) {
    if (!tray_id) {
        showToast('❌ ไม่พบ Tray ID ที่จะส่งกลับ', false);
        return;
    }

    // 1. รวบรวมข้อมูลจากฟอร์มสำหรับส่งกลับทั้งหมดก่อน
    const newFloor = document.getElementById('returnFloor').value;
    const newSlot = document.getElementById('returnSlot').value;
    const dataToSend = {
        tray_id: tray_id,
        veg_type: document.getElementById("returnVegType").value,
        quantity: document.getElementById("returnPlantQuantity").value,
        batch_id: document.getElementById("returnBatchId").value,
        seeding_date: document.getElementById("returnSeedingDate").value,
        notes: document.getElementById("returnNotes").value,
        floor: newFloor,
        slot: newSlot,
        username: localStorage.getItem("username"),
        station: currentStation,
    };
    
    try {
        // 2. ✅ [สำคัญ] เคลียร์งานที่ Workstation ก่อน เพื่อให้ Flow State กลับเป็น 'idle'
        const completeRes = await fetch('/api/workstation/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                tray_id: tray_id, 
                station_id: station_id || currentStation 
            })
        });

        if (!completeRes.ok) {
            const errData = await completeRes.json();
            throw new Error(errData.error || 'ไม่สามารถเคลียร์งานที่ Workstation ได้');
        }
        
        // เพิ่ม Delay เล็กน้อยเพื่อให้ Server มีเวลาอัปเดต State
        await new Promise(resolve => setTimeout(resolve, 200));

        // 3. ✅ [สำคัญ] หลังจากระบบ idle แล้ว จึงเริ่ม Flow การนำถาดกลับ (Inbound)
        const inboundRes = await fetch("/api/tray/inbound", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dataToSend)
        });
        const result = await inboundRes.json();
        
        if (result.error) {
           showToast(`❌ ${result.error}`, false);
        } else {
           showToast(`✅ รับคำสั่งส่งถาดกลับคลังแล้ว...`, true);
           closeReturnModal();
           refreshDataAndViews();
           checkWorkstationStatus(); // รีเฟรชสถานะ Workstation
           loadTrayInventory();    // รีเฟรชข้อมูลคลัง
        }
    } catch (err) {
        console.error("❌ Error during return to storage:", err);
        showToast(`❌ ไม่สามารถส่งถาดกลับได้: ${err.message}`, false);
    }
}

function closeReturnModal() {
    document.getElementById('returnTrayModal').style.display = 'none';
}



async function refreshDataAndViews() {
  console.log("🔄 Refreshing data and relevant views...");
  
  // 1. โหลดข้อมูลหลัก 2 อย่างนี้ใหม่เสมอ
  await Promise.all([
    loadTrayInventory(),
    loadTrayMasterData() // โหลดข้อมูลสำหรับหน้า Tray Master ด้วย
  ]);

  // 2. ตรวจสอบหน้าปัจจุบัน แล้ววาดซ้ำเฉพาะหน้าที่จำเป็น
  if (currentPage === 'tray-map') {
    renderTrayGrid();
  } else if (currentPage === 'tray-master') {
    // ไม่ต้องทำอะไร เพราะ loadTrayMasterData() วาดตารางใหม่ให้แล้ว
  } else if (currentPage === 'workstation') {
    checkWorkstationStatus();
  } else if (currentPage === 'tray-outbound') {
    // อัปเดตสถานะของช่องที่อาจจะว่างลงแล้ว
    checkOutboundSlot(); 
  }
  
  console.log("✅ Refresh complete.");
}




// ✅ [เพิ่มใหม่] ตัวแปรสำหรับเก็บข้อมูลถาดที่จะนำออก
let selectedOutboundTray = null;
// ✅ [เพิ่มใหม่] ฟังก์ชันสำหรับตรวจสอบสถานะช่องที่เลือกในหน้า Inbound
function validateInboundSlot() {
    const floor = document.getElementById("inFloor").value;
    const slot = document.getElementById("inSlot").value;
    const statusDiv = document.getElementById("inboundSlotStatus");
    const confirmBtn = document.getElementById("inboundConfirmBtn");

    if (!floor || !slot) {
        statusDiv.innerHTML = "";
        confirmBtn.disabled = true; // ปิดปุ่มถ้ายังเลือกไม่ครบ
        return;
    }

    const key = `${floor}-${slot}`;
    if (trayInventory[key] && trayInventory[key].status === 'on_shelf') {
        // --- กรณีช่องไม่ว่าง ---
        statusDiv.innerHTML = `
            <div style="padding: 14px; background: #fffbeb; color: #b45309; border-left: 5px solid #facc15; border-radius: 8px; font-weight: 600;">
                ⚠️ ช่องนี้มีถาดวางอยู่แล้ว กรุณาเลือกตำแหน่งใหม่
            </div>`;
        confirmBtn.disabled = true;
    } else {
        // --- กรณีช่องว่าง ---
        statusDiv.innerHTML = `
            <div style="padding: 14px; background: #f0fdf4; color: #166534; border-left: 5px solid #4ade80; border-radius: 8px; font-weight: 600;">
                ✅ ช่องนี้ว่าง สามารถวางถาดได้
            </div>`;
        confirmBtn.disabled = false;
    }
}
// ✅ [เพิ่มใหม่] ฟังก์ชันสำหรับตรวจสอบและแสดงผลถาดที่อยู่หน้าสุดของชั้น
function validateOutboundFloor() {
    const selectedFloor = document.getElementById("outFloor").value;
    const validationBox = document.getElementById("outboundValidationBox");
    const confirmBtn = document.getElementById("outboundConfirmBtn");
    const reasonSelect = document.getElementById("outReason");
    const destinationInput = document.getElementById("outDestination");

    // รีเซ็ตสถานะทุกครั้งที่เปลี่ยนชั้น
    selectedOutboundTray = null;
    validationBox.style.display = 'none';
    validationBox.innerHTML = '';
    confirmBtn.disabled = true;
    reasonSelect.disabled = true;
    destinationInput.disabled = true;

    if (!selectedFloor) return; // ถ้าไม่ได้เลือกชั้น ก็ไม่ต้องทำอะไรต่อ

    // ค้นหาถาดทั้งหมดในชั้นที่เลือก และมีสถานะ 'on_shelf'
    const traysOnFloor = Object.values(trayInventory).filter(
        tray => tray.floor == selectedFloor && tray.status === 'on_shelf'
    );

    validationBox.style.display = 'block';

    if (traysOnFloor.length === 0) {
        // ---- กรณีไม่เจอถาดในชั้นนั้น ----
        validationBox.innerHTML = `
            <div class="warning-message" style="background: #fffbeb; color: #b45309; border-left-color: #fde68a;">
                <i class="fas fa-info-circle"></i> ไม่พบถาดที่พร้อมใช้งานในชั้น ${selectedFloor}
            </div>
        `;
        return;
    }

    // ---- กรณีเจอถาด -> หาช่องที่เลขน้อยที่สุด (หน้าสุด) ----
    const frontTray = traysOnFloor.reduce((prev, curr) => (prev.slot < curr.slot ? prev : curr));
    selectedOutboundTray = frontTray; // เก็บข้อมูลถาดที่เลือกไว้

    const formattedDate = new Date(frontTray.time_in).toLocaleDateString('th-TH');
    validationBox.innerHTML = `
        <div style="background-color: #f0fdf4; padding: 15px; border-radius: 12px; border: 1px solid #bbf7d0; color: #166534; font-weight: 600;">
            <i class="fas fa-check-circle"></i> พบถาดหน้าสุด: <strong>${frontTray.veg_type}</strong> (ช่อง ${frontTray.slot})<br>
            <small>วางเมื่อ: ${formattedDate}</small>
        </div>
    `;

    // เปิดให้กรอกข้อมูลและกดยืนยันได้
    confirmBtn.disabled = false;
    reasonSelect.disabled = false;
    destinationInput.disabled = false;
}







</script>

<!-- ✅ Popup แจ้งเตือน -->
<div id="trayPopup" style="
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: #52b788;
  color: white;
  padding: 16px 26px;
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  font-size: 1.1em;
  font-weight: 600;
  z-index: 9999;
  display: none;
  animation: fadeInUp 0.3s ease;
">
  ✅ แจ้งเตือน
</div>


</body>


</html>
