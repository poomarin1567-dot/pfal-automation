<!DOCTYPE html> 
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AGROTECH WMS - Login</title>

  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

  <style>
/* ================================================================================================
   🎨 AGROTECH WMS STYLESHEET
   ================================================================================================
   
   📋 TABLE OF CONTENTS:
   ────────────────────────────────────────────────────────────────────────────────────────────
   1. 🚀 PERFORMANCE & RESET STYLES
   2. 📱 UTILITY & DROPDOWN COMPONENTS  
   3. 📄 PAGINATION COMPONENTS
   4. 🔧 FORM & INPUT COMPONENTS
   5. 📊 DASHBOARD & OVERVIEW COMPONENTS
   6. 🏗️ LAYOUT & NAVIGATION
   7. 📹 CAMERA & MEDIA COMPONENTS
   8. 🎛️ CONTROL & MONITORING COMPONENTS
   9. 📈 CHART & VISUALIZATION COMPONENTS
   10. 📱 RESPONSIVE DESIGN
   ================================================================================================ */

/* ================================================================================================
   1. 🚀 PERFORMANCE & RESET STYLES
   ================================================================================================ */
    
    /* CSS Performance Optimizations */
    * {
      box-sizing: border-box;
    }
    
    /* GPU acceleration for smooth animations */
    .animated, .btn, .card, .modal {
      transform: translateZ(0);
      will-change: transform, opacity;
    }
    
    /* Reduce layout thrashing */
    img, video {
      max-width: 100%;
      height: auto;
    }

/* ================================================================================================
   2. 📱 UTILITY & DROPDOWN COMPONENTS
   ================================================================================================ */
    
    /*สำหรับปุ่ม Excel Dropdown task history */
.excel-dropdown-container {
    position: relative;
    display: inline-block;
}

.excel-dropdown-menu {
    display: none;
    position: absolute;
    background-color: #ffffff;
    min-width: 180px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    z-index: 100;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #e2e8f0;
    margin-top: 8px;
}

.excel-dropdown-menu a {
    color: #334155;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    font-weight: 500;
    transition: background-color 0.2s ease;
}

.excel-dropdown-menu a:hover {
    background-color: #f1f5f9;
}

.excel-dropdown-menu.show-menu {
    display: block;
}

/* ================================================================================================
   3. 📄 PAGINATION COMPONENTS
   ================================================================================================ */
   
/* ✅  Pagination task history */
.pagination-container {
   display: flex;
   justify-content: space-between;
   align-items: center;
   padding: 25px 30px;
   margin-top: 0;
   background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
   border-top: 1px solid #e2e8f0;
   flex-wrap: wrap;
   gap: 1rem;
}

.pagination-summary {
   color: #475569;
   font-weight: 600;
   font-size: 0.95rem;
}

.pagination-buttons {
   display: flex;
   gap: 8px;
}

.pagination-buttons button {
   min-width: 45px;
   padding: 10px 16px;
   border: 2px solid #e2e8f0;
   background: white;
   border-radius: 10px;
   font-weight: 600;
   color: #475569;
   cursor: pointer;
   transition: all 0.3s ease;
}

.pagination-buttons button:hover:not(:disabled) {
   border-color: #4f46e5;
   color: #4f46e5;
   transform: translateY(-2px);
   box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
}

.pagination-buttons button.active {
   background: linear-gradient(135deg, #4f46e5, #7c3aed);
   color: white;
   border-color: #4f46e5;
   box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
}

.pagination-buttons button:disabled {
   opacity: 0.5;
   cursor: not-allowed;
   transform: none !important;
}

.pagination-summary {
    color: #475569;
    font-weight: 500;
}

.pagination-buttons {
    display: flex;
    gap: 8px;
}

.pagination-buttons button {
    min-width: 40px;
    padding: 8px 16px;
    border: 1px solid #e2e8f0;
    background-color: #ffffff;
    border-radius: 8px;
    font-weight: 600;
    color: #475569;
    cursor: pointer;
    transition: all 0.2s ease;
}

.pagination-buttons button:hover {
    border-color: #4f46e5;
    color: #4f46e5;
}

.pagination-buttons button.active {
    background-color: #4f46e5;
    color: #ffffff;
    border-color: #4f46e5;
}

.pagination-buttons button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* 🎯 PROFESSIONAL MODERN TASK HISTORY */
.task-monitor-enhanced {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 20px;
  padding: 32px 40px;
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.08),
    0 8px 24px rgba(0, 0, 0, 0.04);
  margin-bottom: 32px;
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.8);
}

/* ✨ Elegant top border */
.task-monitor-enhanced::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, 
    #6366f1 0%, 
    #8b5cf6 25%, 
    #ec4899 50%, 
    #06b6d4 75%, 
    #10b981 100%);
  border-radius: 20px 20px 0 0;
}

/* 🎨 Subtle floating decoration */
.task-monitor-enhanced::after {
  content: '';
  position: absolute;
  top: -80px;
  right: -80px;
  width: 160px;
  height: 160px;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.04));
  border-radius: 50%;
  filter: blur(30px);
  z-index: 0;
}

/* 📝 Modern header */
.task-monitor-enhanced h2 {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 28px;
  position: relative;
  z-index: 1;
  background: linear-gradient(135deg, #1f2937 0%, #6366f1 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.task-monitor-enhanced h2 i {
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-size: 2.2rem;
  animation: gentlePulse 4s ease-in-out infinite;
}

@keyframes gentlePulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* 🎛️ Clean controls */
.history-controls {
  display: flex;
  gap: 20px;
  align-items: center;
  margin-bottom: 28px;
  flex-wrap: wrap;
  background: rgba(255, 255, 255, 0.8);
  padding: 24px;
  border-radius: 16px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.6);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
  position: relative;
  z-index: 1;
}

/* 🔍 Clean search box */
.search-box {
  position: relative;
  flex: 1;
  min-width: 300px;
}

.search-box input {
  width: 100%;
  padding: 14px 50px 14px 18px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 500;
  transition: all 0.3s ease;
  background: #ffffff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.search-box input:focus {
  outline: none;
  border-color: #6366f1;
  box-shadow: 
    0 0 0 3px rgba(99, 102, 241, 0.1),
    0 4px 16px rgba(99, 102, 241, 0.15);
  transform: translateY(-1px);
}

.search-box i {
  position: absolute;
  right: 18px;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  font-size: 1.1rem;
  transition: all 0.3s ease;
}

.search-box input:focus + i {
  color: #6366f1;
  transform: translateY(-50%) scale(1.1);
}

/* 📋 Clean filter */
#historyFilter {
  padding: 14px 20px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  background: #ffffff;
  color: #374151;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  transition: all 0.3s ease;
  min-width: 140px;
  appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 12px center;
  background-repeat: no-repeat;
  background-size: 16px;
  padding-right: 40px;
}

#historyFilter:hover {
  border-color: #6366f1;
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(99, 102, 241, 0.15);
}

/* 📊 Clean export button */
.filter-btn {
  padding: 14px 24px;
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 
    0 4px 16px rgba(16, 185, 129, 0.25),
    0 2px 8px rgba(0, 0, 0, 0.08);
}

.filter-btn:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 8px 24px rgba(16, 185, 129, 0.35),
    0 4px 16px rgba(0, 0, 0, 0.12);
}

/* 📊 Clean table */
.table-responsive-wrapper {
  background: white;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  border: 1px solid #f3f4f6;
}

.task-table-enhanced {
  width: 100%;
  border-collapse: collapse;
  background: white;
  margin: 0;
}

.task-table-enhanced thead th {
  background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
  color: white;
  padding: 16px 14px;
  font-weight: 600;
  font-size: 0.9rem;
  text-align: left;
  border: none;
}

.task-table-enhanced tbody tr {
  transition: all 0.2s ease;
  border-bottom: 1px solid #f3f4f6;
}

.task-table-enhanced tbody tr:hover {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  transform: translateX(2px);
}

.task-table-enhanced tbody td {
  padding: 14px;
  font-size: 0.9rem;
  color: #374151;
  border: none;
  vertical-align: middle;
}

.task-table-enhanced tbody td strong {
  color: #1f2937;
  font-weight: 700;
}

/* 🏷️ Clean badges */
.status-enhanced, .floor-badge, .slot-badge, .action-badge, .user-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  font-weight: 600;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border: 1px solid transparent;
}

.status-enhanced.pending {
  background: #fef3c7;
  color: #92400e;
  border-color: #fbbf24;
}

.status-enhanced.working {
  background: #dbeafe;
  color: #1e40af;
  border-color: #3b82f6;
}

.status-enhanced.success {
  background: #d1fae5;
  color: #065f46;
  border-color: #10b981;
}

.action-badge.inbound {
  background: #d1fae5;
  color: #047857;
  border-color: #059669;
}

.action-badge.outbound {
  background: #fed7aa;
  color: #c2410c;
  border-color: #ea580c;
}

.floor-badge, .slot-badge {
  background: #e0e7ff;
  color: #3730a3;
  border-color: #6366f1;
}

.user-badge {
  background: #f3e8ff;
  color: #6b21a8;
  border-color: #8b5cf6;
}

/* 📱 Responsive */
@media (max-width: 768px) {
  .task-monitor-enhanced {
    padding: 24px 20px;
  }
  
  .task-monitor-enhanced h2 {
    font-size: 1.6rem;
  }
  
  .history-controls {
    flex-direction: column;
    align-items: stretch;
  }
  
  .search-box {
    min-width: auto;
  }
}

/* ✅ CSS สำหรับ Status Badge และ Progress Bar */
.status-badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: inline-block;
}

.status-success { background: #d1fae5; color: #065f46; }
.status-warning { background: #fef3c7; color: #92400e; }
.status-danger { background: #fee2e2; color: #991b1b; }
.status-info { background: #dbeafe; color: #1e40af; }
.status-primary { background: #e0e7ff; color: #3730a3; }
.status-secondary { background: #f1f5f9; color: #475569; }

.task-type-badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  display: inline-block;
}

.task-planting { background: #dcfce7; color: #166534; }
.task-harvest { background: #fed7aa; color: #9a3412; }
.task-maintenance { background: #e0e7ff; color: #3730a3; }
.task-default { background: #f1f5f9; color: #475569; }

.priority-badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  display: inline-block;
}

.priority-low { background: #f0f9ff; color: #0369a1; }
.priority-normal { background: #f1f5f9; color: #475569; }
.priority-high { background: #fef3c7; color: #92400e; }
.priority-urgent { background: #fee2e2; color: #991b1b; }

.progress-bar {
  position: relative;
  width: 80px;
  height: 20px;
  background: #f1f5f9;
  border-radius: 10px;
  overflow: hidden;
  margin: 0 auto;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #10b981, #059669);
  border-radius: 10px;
  transition: width 0.3s ease;
}

.progress-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 11px;
  font-weight: 600;
  color: #374151;
  z-index: 1;
}

/* ✅ WMS-Style Dashboard */
.wms-dashboard-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 24px;
  border-radius: 12px;
  margin-bottom: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

.dashboard-title h1 {
  margin: 0;
  font-size: 1.8rem;
  font-weight: 700;
}

.dashboard-title p {
  margin: 8px 0 0 0;
  opacity: 0.9;
  font-size: 0.95rem;
}

.dashboard-stats {
  display: flex;
  gap: 24px;
  flex-wrap: wrap;
}

.stat-item {
  text-align: center;
  min-width: 80px;
}

.stat-value {
  font-size: 2rem;
  font-weight: 800;
  color: #fff;
  text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.stat-label {
  font-size: 0.85rem;
  opacity: 0.9;
  margin-top: 4px;
}

.wms-control-panel {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 24px;
}

.control-section h3 {
  color: #475569;
  font-size: 1rem;
  margin: 0 0 12px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.control-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.form-select {
  padding: 8px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  background: white;
  font-size: 0.9rem;
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  color: #475569;
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  display: inline-block;
}

.status-dot.online { background: #10b981; }
.status-dot.offline { background: #ef4444; }
.status-dot.warning { background: #f59e0b; }

.wms-section {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  margin-bottom: 24px;
  overflow: hidden;
}

.section-header {
  background: #f8fafc;
  padding: 16px 20px;
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

.section-header h2 {
  margin: 0;
  color: #1e293b;
  font-size: 1.25rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.section-actions {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.last-sync {
  font-size: 0.85rem;
  color: #64748b;
}

.filter-bar {
  padding: 16px 20px;
  background: #f9fafb;
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.table-container {
  overflow-x: auto;
}

.wms-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}

.wms-table th {
  background: #f1f5f9;
  color: #475569;
  font-weight: 600;
  padding: 12px 16px;
  text-align: left;
  border-bottom: 2px solid #e2e8f0;
  white-space: nowrap;
}

.wms-table td {
  padding: 12px 16px;
  border-bottom: 1px solid #f1f5f9;
  vertical-align: middle;
}

.wms-table tbody tr:hover {
  background: #f8fafc;
}

.no-data {
  text-align: center;
  color: #94a3b8;
  font-style: italic;
  padding: 40px !important;
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s ease;
  text-decoration: none;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-primary {
  background: #3b82f6;
  color: white;
}

.btn-success {
  background: #10b981;
  color: white;
}

.btn-warning {
  background: #f59e0b;
  color: white;
}

.btn-info {
  background: #06b6d4;
  color: white;
}

.btn-secondary {
  background: #6b7280;
  color: white;
}

.btn-sm {
  padding: 4px 8px;
  font-size: 0.8rem;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
}

.modal-content {
  background: white;
  margin: 5% auto;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header {
  padding: 20px;
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  color: #1e293b;
  display: flex;
  align-items: center;
  gap: 10px;
}

.close {
  font-size: 24px;
  cursor: pointer;
  color: #94a3b8;
}

.close:hover {
  color: #ef4444;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
  padding: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-group label {
  font-weight: 500;
  color: #374151;
  font-size: 0.9rem;
}

.form-group input,
.form-group select {
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 0.9rem;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.modal-actions {
  padding: 20px;
  border-top: 1px solid #e2e8f0;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

/* ✅ Additional WMS Badges */
.level-badge {
  background: #e0e7ff;
  color: #3730a3;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

.quantity-badge {
  background: #f0fdf4;
  color: #166534;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

.no-data.error {
  color: #ef4444 !important;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .wms-dashboard-header {
    flex-direction: column;
    text-align: center;
    gap: 16px;
  }
  
  .dashboard-stats {
    justify-content: center;
  }
  
  .wms-control-panel {
    grid-template-columns: 1fr;
  }
  
  .section-header {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }
  
  .filter-bar {
    flex-direction: column;
  }
  
  .wms-table {
    font-size: 0.8rem;
  }
  
  .wms-table th,
  .wms-table td {
    padding: 8px 12px;
  }
}

/* 📊 สถิติสวยๆ */
.task-stats-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card-mini {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  padding: 18px 20px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
  border: 1px solid #f1f5f9;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.stat-card-mini::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #6366f1, #8b5cf6, #ec4899);
  border-radius: 12px 12px 0 0;
}

.stat-card-mini:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.stat-card-mini .stat-number {
  font-size: 1.8rem;
  font-weight: 800;
  color: #6366f1;
  margin-bottom: 4px;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.stat-card-mini .stat-label {
  font-size: 0.85rem;
  color: #64748b;
  font-weight: 600;
}

.stat-card-mini .stat-icon {
  font-size: 1.2rem;
  color: #8b5cf6;
  margin-bottom: 8px;
}

    /* ✅ แก้ไขขนาดกราฟให้ใหญ่ขึ้นพอดีกับ container */

/* ===== CHART CONTAINERS - ปรับขนาดใหม่ ===== */
#pieChartContainer-new, .chart-container-new {
  position: relative;
  height: 400px; /* ✅ เพิ่มจาก 320px เป็น 400px */
  padding: 0.5rem; /* ✅ ลด padding จาก 1rem เป็น 0.5rem */
  background: rgba(248, 250, 252, 0.3);
  border-radius: 16px;
  border: 1px solid var(--overview-border-light);
}

/* ✅ เพิ่มขนาด pie chart container เป็นพิเศษ */
#pieChartContainer-new {
  height: 420px; /* ✅ เพิ่มจาก 280px เป็น 420px */
  padding: 0.25rem; /* ✅ ลด padding ให้น้อยสุด */
}

/* ✅ ปรับ hourly chart ให้สูงขึ้นด้วย */
.chart-container-new.hourly {
  height: 280px; /* ✅ เพิ่มจาก 220px เป็น 280px */
}

/* ✅ เพิ่ม CSS สำหรับให้กราฟใช้พื้นที่เต็มที่ */
#pieChart, #barChart, #hourlyChart {
  width: 100% !important;
  height: 100% !important;
  max-width: none !important;
  max-height: none !important;
}

/* ✅ ปรับ Chart.js options เพื่อให้กราฟใหญ่สุด */
.chart-container-new canvas {
  width: 100% !important;
  height: 100% !important;
}


    /* CSS สำหรับตารางผู้ใช้ (เพิ่มเข้าไปใน <style>) */
.user-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
}

.user-table th, .user-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #f1f5f9;
}

.user-table th {
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
}

.user-row:hover {
    background-color: #f8fafc;
}

.user-info-cell {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-weight: 600;
    color: #1e293b;
}

.user-info-cell .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
}

.status-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 0.5rem;
}

.status-dot.online { background-color: #10b981; }
.status-dot.offline { background-color: #94a3b8; }

/* ทำให้ปุ่มในตารางเล็กลง */
.user-table .action-btn {
    padding: 0.5rem;
    font-size: 0.8rem;
}
.user-table .user-card-actions {
    justify-content: flex-start;
}
/* === 🎯 ENHANCED USER MANAGEMENT DESIGN === */

.user-management-page {
    background: #f8fafc;
    min-height: 100vh;
    padding: 2rem;
    position: relative;
    overflow: hidden;
}

/* Background decoration */
.user-management-page::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(16, 185, 129, 0.08) 0%, transparent 70%);
    animation: float 20s ease-in-out infinite;
    pointer-events: none;
}

@keyframes float {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    50% { transform: translate(-50px, -50px) rotate(180deg); }
}

/* Header Section */
.user-management-header {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.header-title {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header-title h2 {
    font-size: 2.2rem;
    font-weight: 800;
    background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0;
    letter-spacing: -0.03em;
}

.header-title i {
    font-size: 2rem;
    color: #10b981;
}

/* Stats Cards */
.user-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.stat-card {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border: 1px solid #bbf7d0;
    border-radius: 12px;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.15);
}

.stat-icon {
    width: 50px;
    height: 50px;
    background: white;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: #10b981;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.stat-info h4 {
    margin: 0 0 0.25rem 0;
    font-size: 0.875rem;
    color: #64748b;
    font-weight: 500;
}

.stat-info p {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 800;
    color: #1e293b;
}

/* Search and Filter Section */
.search-filter-section {
    background: white;
    border-radius: 20px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
}
.search-box {
    position: relative;
    flex: 1;
    z-index: 1;
}

.search-box input {
    width: 100%;
    padding: 12px 40px 12px 15px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    pointer-events: auto;
    cursor: text;
}

.search-box input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-box i {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
    pointer-events: none;
}

.filter-group {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 0.75rem 1.5rem;
    border: 2px solid #e2e8f0;
    background: white;
    border-radius: 12px;
    font-size: 0.95rem;
    font-weight: 600;
    color: #64748b;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-btn:hover {
    border-color: #10b981;
    color: #10b981;
    background: #f0fdf4;
}

.filter-btn.active {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border-color: transparent;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

/* Add User Button */
.btn-add-user {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    padding: 1rem 2rem;
    border: none;
    border-radius: 12px;
    font-size: 1.05rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
    transition: all 0.3s ease;
}

.btn-add-user:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px rgba(59, 130, 246, 0.4);
}

/* User Grid */
.user-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

/* Enhanced User Card */
.user-card {
    background: white;
    border-radius: 20px;
    padding: 1.75rem;
    position: relative;
    transition: all 0.3s ease;
    border: 1px solid #f1f5f9;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
}

.user-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
    transform: translateX(-100%);
    transition: transform 0.5s ease;
}

.user-card:hover::before {
    transform: translateX(0);
}

.user-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
}

.user-card-header {
    display: flex;
    align-items: flex-start;
    gap: 1.25rem;
    margin-bottom: 1.25rem;
}

.user-avatar {
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    position: relative;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.user-status {
    position: absolute;
    bottom: -2px;
    right: -2px;
    width: 18px;
    height: 18px;
    background: #10b981;
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.user-status.offline {
    background: #94a3b8;
}

.user-info {
    flex: 1;
    min-width: 0;
}

.user-info .username {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.verified-badge {
    font-size: 1rem;
    color: #3b82f6;
}

/* Enhanced Role Badge */
.role-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.875rem;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.025em;
    text-transform: uppercase;
    gap: 0.375rem;
}

.role-badge i {
    font-size: 0.75rem;
}

.role-it { 
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #93c5fd;
}

.role-engineer { 
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fcd34d;
}

.role-หัวหน้างาน { 
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #6ee7b7;
}

.role-พนักงาน { 
    background: #ede9fe;
    color: #5b21b6;
    border: 1px solid #c4b5fd;
}

/* User Details */
.user-details {
    display: grid;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 12px;
    font-size: 0.9rem;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #64748b;
}

.detail-item i {
    width: 16px;
    color: #94a3b8;
}

.detail-item strong {
    color: #475569;
}

/* Card Actions */
.user-card-actions {
    display: flex;
    gap: 0.75rem;
}

.action-btn {
    flex: 1;
    padding: 0.75rem;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.action-btn.edit {
    background: #f1f5f9;
    color: #475569;
}

.action-btn.edit:hover {
    background: #3b82f6;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.action-btn.delete {
    background: #fef2f2;
    color: #991b1b;
}

.action-btn.delete:hover {
    background: #ef4444;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

/* Enhanced Modal */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.modal-backdrop.show {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: white;
    border-radius: 24px;
    padding: 2rem;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    transform: scale(0.9) translateY(20px);
    transition: all 0.3s ease;
}

.modal-backdrop.show .modal-content {
    transform: scale(1) translateY(0);
}

.modal-header {
    text-align: center;
    margin-bottom: 2rem;
}

.modal-title {
    font-size: 1.75rem;
    font-weight: 800;
    color: #1e293b;
    margin: 0 0 0.5rem 0;
}

.modal-subtitle {
    color: #64748b;
    font-size: 1rem;
}

/* Form Styling */
.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: #475569;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.form-input,
.form-select {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #f8fafc;
}

.form-input:focus,
.form-select:focus {
    outline: none;
    border-color: #3b82f6;
    background: white;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-input:disabled {
    background: #f1f5f9;
    cursor: not-allowed;
    opacity: 0.7;
}

/* Password strength indicator */
.password-strength {
    display: flex;
    gap: 0.25rem;
    margin-top: 0.5rem;
    height: 4px;
}

.strength-bar {
    flex: 1;
    background: #e2e8f0;
    border-radius: 2px;
    transition: all 0.3s ease;
}

.strength-bar.active {
    background: #10b981;
}

.strength-bar.weak {
    background: #f59e0b;
}

.strength-bar.strong {
    background: #10b981;
}

/* Modal Actions */
.modal-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
}

.modal-btn {
    flex: 1;
    padding: 1rem;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.modal-btn.primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
}

.modal-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px rgba(59, 130, 246, 0.4);
}

.modal-btn.secondary {
    background: #f1f5f9;
    color: #64748b;
}

.modal-btn.secondary:hover {
    background: #e2e8f0;
}

/* Loading States */
.skeleton {
    background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.empty-state i {
    font-size: 4rem;
    color: #e2e8f0;
    margin-bottom: 1rem;
}

.empty-state h3 {
    font-size: 1.5rem;
    color: #64748b;
    margin: 0 0 0.5rem 0;
}

.empty-state p {
    color: #94a3b8;
    margin: 0 0 2rem 0;
}

/* Responsive Design */
@media (max-width: 768px) {
    .user-management-page {
        padding: 1rem;
    }
    
    .header-top {
        flex-direction: column;
        align-items: stretch;
    }
    
    .user-stats {
        grid-template-columns: 1fr;
    }
    
    .search-filter-section {
        flex-direction: column;
    }
    
    .user-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .modal-content {
        padding: 1.5rem;
    }
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.user-card {
    animation: fadeIn 0.5s ease-out;
    animation-fill-mode: both;
}

.user-card:nth-child(1) { animation-delay: 0.1s; }
.user-card:nth-child(2) { animation-delay: 0.2s; }
.user-card:nth-child(3) { animation-delay: 0.3s; }
.user-card:nth-child(4) { animation-delay: 0.4s; }
.user-card:nth-child(5) { animation-delay: 0.5s; }
.user-card:nth-child(6) { animation-delay: 0.6s; }





/* popup ยืนยันเวลา */
@keyframes modal-pulse-green {
  0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
  70% { box-shadow: 0 0 0 12px rgba(16, 185, 129, 0); }
  100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}
@keyframes modal-pulse-red {
  0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
  70% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
  100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
}

.timer-modal-backdrop {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(9, 30, 27, 0.4);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    display: none; align-items: center; justify-content: center;
    z-index: 1000; opacity: 0; transition: opacity 0.3s ease;
}
.timer-modal-backdrop.show { display: flex; opacity: 1; }

.timer-modal-backdrop .timer-modal-content {
    position: relative; background: #ffffff;
    border-radius: 20px; padding: 35px 30px 30px 30px;
    width: 90%; max-width: 400px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    text-align: center;
    transform: scale(0.95); opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
    border-top: 4px solid transparent;
}
.timer-modal-backdrop.show .timer-modal-content { transform: scale(1); opacity: 1; }

.timer-modal-backdrop .modal-status-indicator {
    position: absolute; top: -11px; left: 50%;
    transform: translateX(-50%); width: 20px; height: 20px;
    border-radius: 50%; border: 4px solid #ffffff;
}
.timer-modal-backdrop .timer-modal-content.is-on .modal-status-indicator {
    background-color: #10b981; animation: modal-pulse-green 2s infinite;
}
.timer-modal-backdrop .timer-modal-content.is-off .modal-status-indicator {
    background-color: #ef4444; animation: modal-pulse-red 2s infinite;
}
.timer-modal-backdrop .timer-modal-content.is-on { border-top-color: #10b981; }
.timer-modal-backdrop .timer-modal-content.is-off { border-top-color: #ef4444; }

.timer-modal-backdrop .modal-title {
    font-size: 1.5rem; font-weight: 600;
    color: var(--global-text-bright); margin: 10px 0 30px 0;
}
.timer-modal-backdrop .timer-group { margin-bottom: 20px; text-align: left; }
.timer-modal-backdrop .timer-group label { display: block; font-weight: 600; color: var(--global-text-normal); margin-bottom: 10px; }
.timer-modal-backdrop .timer-input {
    width: 100%; padding: 14px; border: 1px solid var(--global-border);
    background-color: var(--global-bg-main); border-radius: 12px;
    font-size: 1.1rem; color: var(--global-text-bright);
}
.timer-modal-backdrop .timer-modal-actions { margin-top: 30px; display: flex; gap: 15px; }
.timer-modal-backdrop .modal-btn {
    flex-grow: 1; padding: 14px; border-radius: 14px;
    font-size: 1rem; font-weight: 700;
    border: none; cursor: pointer; transition: all 0.2s ease;
}
.timer-modal-backdrop .modal-btn.cancel { background-color: #e5e7eb; color: #4b5563; }
.timer-modal-backdrop .modal-btn.cancel:hover { background-color: #d1d5db; }
.timer-modal-backdrop .modal-btn.save.is-on { background: #059669; color: white; }
.timer-modal-backdrop .modal-btn.save.is-on:hover { background: #047857; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3); }
.timer-modal-backdrop .modal-btn.save.is-off { background: #dc2626; color: white; }
.timer-modal-backdrop .modal-btn.save.is-off:hover { background: #b91c1c; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(220, 38, 38, 0.3); }

/* หัวเรื่อง light control  --- */
.light-control-header-new {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.9));
    backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    border: 1px solid rgba(255,255,255,0.3);
    position: relative;
    overflow: hidden;
}

.light-control-header-new::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #f59e0b, #ef4444, #10b981);
    background-size: 300% 100%;
    animation: headerFlow 4s ease-in-out infinite;
}

@keyframes headerFlow {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 300% center; }
}

.header-content-new {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.header-icon-new {
    position: relative;
    width: 60px; height: 60px;
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 25px rgba(59,130,246,0.3);
}

.header-icon-new i {
    font-size: 1.8rem;
    color: white;
    z-index: 2;
}

.icon-glow-new {
    position: absolute;
    width: 100%; height: 100%;
    background: rgba(255,255,255,0.3);
    border-radius: 18px;
    animation: iconPulse 2s ease-in-out infinite;
}

@keyframes iconPulse {
    0%, 100% { transform: scale(1); opacity: 0.3; }
    50% { transform: scale(1.1); opacity: 0.1; }
}

.header-text-new h1 {
    font-size: 2rem;
    font-weight: 800;
    margin: 0;
    background: linear-gradient(135deg, #1e293b, #3b82f6, #8b5cf6);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: titleShift 3s ease-in-out infinite;
}

.header-text-new p {
    color: #64748b;
    font-weight: 500;
    margin: 0.5rem 0 0 0;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.9rem;
}

@keyframes titleShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.status-badge-new {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: rgba(16,185,129,0.1);
    border: 1px solid rgba(16,185,129,0.3);
    border-radius: 12px;
    color: #10b981;
    font-weight: 600;
}

.status-dot-new {
    width: 8px; height: 8px;
    background: #10b981;
    border-radius: 50%;
    animation: statusPulse 2s ease-in-out infinite;
}

@keyframes statusPulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.2); }
}

/* เพิ่ม hover effects ให้ปุ่มเดิม */
.global-power-btn {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.global-power-btn::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.6s ease;
}

.global-power-btn:hover::before {
    left: 100%;
}

.global-power-btn:hover {
    transform: translateY(-3px);
}

/* เพิ่ม hover effects ให้ floor cards เดิม */
.floor-card {
    position: relative;
    overflow: hidden;
    transition: all 0.4s ease;
}

.floor-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
}

.floor-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #f59e0b, #ef4444);
    transform: scaleX(0);
    transition: transform 0.4s ease;
}

.floor-card:hover::before {
    transform: scaleX(1);
}

/* เพิ่ม animation ให้ control rows เดิม */
.control-row {
    transition: all 0.2s ease;
    border-radius: 8px;
    padding: 0.5rem;
    margin: 0.25rem 0;
}

.control-row:hover {
    background: rgba(59, 130, 246, 0.05);
    transform: translateX(5px);
}

.control-timer-btn:hover {
    transform: scale(1.1);
    background: #f3f4f6;
}

.premium-slider:hover {
    transform: scaleY(1.2);
}

/* Responsive */
@media (max-width: 768px) {
    .light-control-header-new {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .header-content-new {
        flex-direction: column;
        gap: 1rem;
    }
    
    .header-text-new h1 {
        font-size: 1.5rem;
    }
}


/* Light Control Page  --- */


.light-control-page-theme {
  --lc-bg: linear-gradient(120deg, #f3f9ff 0%, #e6f7f4 100%);
  --lc-card-bg: rgba(255, 255, 255, 0.7);
  --lc-card-border: rgba(255, 255, 255, 0.9);
  --lc-shadow: rgba(45, 212, 191, 0.1);
  --lc-text-header: #0a3d34;
  --lc-text-primary: #115e59;
  --lc-text-secondary: #526a82;
  --lc-accent-green: #2dd4bf;
  --lc-accent-red: #f43f5e;
  --lc-accent-blue: #3b82f6;
  --lc-slider-track: #e0f2fe;
}
.light-control-page-theme .light-control-container {
  background: var(--lc-bg); padding: 30px;
}
.light-control-page-theme .light-control-header {
  font-size: 2.2rem; font-weight: 700; color: var(--lc-text-header);
  display: flex; align-items: center; gap: 16px; margin-bottom: 24px;
}
.light-control-page-theme .light-control-header i { color: var(--lc-accent-green); }
.light-control-page-theme .global-control-card,
.light-control-page-theme .floor-card {
  background: var(--lc-card-bg);
  backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
  border-radius: 24px; padding: 28px;
  border: 1px solid var(--lc-card-border);
  box-shadow: 0 10px 30px var(--lc-shadow);
  margin-bottom: 28px;
}
.light-control-page-theme .card-title,
.light-control-page-theme .floor-title h3 {
  font-size: 1.4rem; font-weight: 600; color: var(--lc-text-primary);
  display: flex; align-items: center; gap: 12px; margin: 0;
  padding-bottom: 20px; border-bottom: 1px solid rgba(13, 148, 136, 0.1);
}
.light-control-page-theme .floor-title h3 { padding-bottom: 0; border-bottom: none; }
.light-control-page-theme .global-actions { display: flex; gap: 20px; margin-top: 24px; }
.light-control-page-theme .global-power-btn {
  flex-grow: 1; display: flex; align-items: center; justify-content: center;
  gap: 12px; padding: 18px; border: 1px solid transparent; border-radius: 18px;
  cursor: pointer; transition: all 0.3s ease; font-size: 1.1rem; font-weight: 700;
}
.light-control-page-theme .global-power-btn.on { background: var(--lc-accent-green); color: white; box-shadow: 0 8px 20px rgba(45, 212, 191, 0.3); }
.light-control-page-theme .global-power-btn.on:hover { transform: translateY(-3px); }
.light-control-page-theme .global-power-btn.off { background: #e7eef7; color: var(--lc-text-secondary); border: 1px solid #dbe2ef; }
.light-control-page-theme .global-power-btn.off:hover { background-color: #dbe2ef; }
.light-control-page-theme .global-timer-section { margin-top: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.light-control-page-theme .timer-group label { font-weight: 600; color: var(--lc-text-secondary); margin-bottom: 8px; display: block; }
.light-control-page-theme .timer-input {
  width: 100%; background-color: #f3f7fe; border: 1px solid #e0e9f8;
  border-radius: 12px; padding: 12px; font-size: 1rem; color: var(--lc-text-primary);
}
.light-control-page-theme .timer-input:focus { outline: none; border-color: var(--lc-accent-green); box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.2); }
.light-control-page-theme .floor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap: 28px; }
.light-control-page-theme .floor-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.light-control-page-theme .floor-title-actions { display: flex; align-items: center; gap: 12px; }
.light-control-page-theme .floor-timer-btn {
  background: transparent; border: 1px solid #cedbe7; color: var(--lc-text-secondary);
  font-weight: 600; font-size: 0.9rem; padding: 8px 16px;
  border-radius: 12px; cursor: pointer; display: flex;
  align-items: center; gap: 8px; transition: all 0.2s ease;
}
.light-control-page-theme .floor-timer-btn:hover { background-color: rgba(255,255,255,0.5); border-color: #a8b9d0; }
.light-control-page-theme .control-row { display: flex; align-items: center; gap: 16px; padding: 10px 0; }
.light-control-page-theme .control-icon { font-size: 1.4rem; width: 30px; text-align: center; }
.light-control-page-theme .control-value { font-size: 1.1rem; font-weight: 700; color: var(--lc-text-primary); min-width: 55px; text-align: right; }
.light-control-page-theme .control-timer-btn {
  background: transparent; border: 1px solid #dbe2ef; color: #8397b0;
  cursor: pointer; font-size: 1.1rem; width: 38px; height: 38px;
  border-radius: 50%; transition: all 0.2s ease;
}
.light-control-page-theme .control-timer-btn:hover { background: #e7eef7; color: var(--lc-text-secondary); }
.light-control-page-theme .slider-container { flex-grow: 1; }
.light-control-page-theme input[type="range"].premium-slider {
  -webkit-appearance: none; appearance: none;
  width: 100%; height: 6px; background: var(--lc-slider-track);
  border-radius: 3px; outline: none;
  background-image: linear-gradient(var(--fill-color, var(--lc-accent-green)), var(--fill-color, var(--lc-accent-green)));
  background-size: var(--value, 50%) 100%;
  background-repeat: no-repeat;
}
.light-control-page-theme input[type="range"].premium-slider::-webkit-slider-thumb {
  -webkit-appearance: none; appearance: none;
  width: 22px; height: 22px; background: #ffffff;
  cursor: pointer; border-radius: 50%;
  border: 3px solid var(--fill-color, var(--lc-accent-green));
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.light-control-page-theme input[type="range"].premium-slider:disabled { opacity: 0.4; }








/* ✨ FINAL: XL Header & All Elements Enlarged ✨ *

/* อนิเมชั่นแสงกวาด (เหมือนเดิม) */
@keyframes gradient-sweep {
  0% { background-position: 200% center; }
  100% { background-position: -200% center; }
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 30px; 
  background: #ffffff; /* ✅ กำหนดเป็นสีขาวทึบโดยตรง */
  border-bottom: 1px solid #e2e8f0; /* 💡 แนะนำให้ใช้สีที่ชัดเจน */
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); /* 💡 เงาที่ดูนุ่มนวลขึ้น */
}

/* --- ส่วนด้านซ้าย --- */
.header-left {
    display: flex;
    align-items: center;
    gap: 30px; /* 🔼 เพิ่มระยะห่าง */
    flex: 1; /* ให้ขยายเต็มพื้นที่ */
    min-width: 0; /* ป้องกัน flex item overflow */
}

.dashboard-title {
    display: flex;
    align-items: center;
    gap: 18px;
}

.dashboard-title h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* แสดง ... เมื่อข้อความยาวเกิน */
    /* ✅ แก้ไขเป็นตัวแปรที่ถูกต้อง */
    background: linear-gradient(90deg, #1b4332, var(--overview-accent-green), #b7e4c7, var(--overview-accent-green), #1b4332);
    background-size: 200% auto;
    color: #000;
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: gradient-sweep 10s linear infinite;
}
.dashboard-icon {
    height: 60px; /* 🔼🔼🔼 เพิ่มขนาดไอคอน */
    width: 60px;
}

.station-dropdown {
    padding: 12px 20px; /* 🔼 เพิ่มขนาด Dropdown */
    font-size: 1rem;    /* 🔼 เพิ่มขนาดฟอนต์ */
    font-weight: 600;
    border-radius: 12px;
}

/* --- ส่วนด้านขวา --- */
.header-right {
    position: relative;
}

.user-menu {
  padding: 12px 18px; /* 🔼 เพิ่มขนาดเมนูผู้ใช้ */
  font-size: 1rem;    /* 🔼 เพิ่มขนาดฟอนต์ */
  border-radius: 12px;
}

/* ===== ENHANCED OVERVIEW CSS - FIXED VERSION ===== */

/* CSS Variables สำหรับ Enhanced Overview */
:root {
  /* Enhanced Color Palette */
  --overview-primary: #0f766e;
  --overview-primary-light: #14b8a6;
  --overview-accent-green: #10b981;
  --overview-accent-blue: #0ea5e9;
  --overview-accent-purple: #8b5cf6;
  --overview-accent-orange: #f59e0b;
  --overview-accent-red: #ef4444;
  --overview-accent-cyan: #06b6d4;
  
  /* Background & Surface */
  --overview-bg-main: #f1f5f9;
  --overview-bg-card: #ffffff;
  --overview-bg-glass: rgba(255, 255, 255, 0.95);
  
  /* Text Colors */
  --overview-text-primary: #0f172a;
  --overview-text-secondary: #475569;
  --overview-text-muted: #64748b;
  
  /* Border & Effects */
  --overview-border: #e2e8f0;
  --overview-border-light: #f1f5f9;
  --overview-shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
  --overview-shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
  --overview-shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
  --overview-shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
  
  /* Gradients */
  --overview-gradient-primary: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
  --overview-gradient-green: linear-gradient(135deg, #10b981 0%, #34d399 100%);
  --overview-gradient-blue: linear-gradient(135deg, #0ea5e9 0%, #60a5fa 100%);
  --overview-gradient-purple: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
  --overview-gradient-orange: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
  --overview-gradient-red: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
  --overview-gradient-cyan: linear-gradient(135deg, #06b6d4 0%, #67e8f9 100%);
}

/* ===== MAIN CONTAINER - แก้ไขไม่ให้ทับ header ===== */
.enhanced-overview {
  padding: 0;
  margin: 0;
  background: none;
  font-family: 'Prompt', sans-serif;
  position: relative;
  z-index: auto;
}

.overview-content-wrapper {
  padding: 1.5rem;
  margin: 0;
  background: none;
  position: relative;
  z-index: auto;
}

/* ===== SUMMARY CARDS GRID ===== */
.summary-cards-new {
  display: grid;
  grid-template-columns: repeat(6, 1fr); /* ✅ แก้ไขเป็น 6 คอลัมน์เสมอ */
  gap: 1.5rem; /* 💡 แนะนำ: ลด gap ลงเล็กน้อยเพื่อให้พอดีสวยงามขึ้น */
  margin-bottom: 3rem;
}

.summary-card-new {
  background: var(--overview-bg-glass);
  backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 24px;
  padding: 2.5rem 2rem;
  box-shadow: var(--overview-shadow-lg);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  cursor: pointer;
  z-index: 1;
}

.summary-card-new::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
  transition: height 0.4s ease;
}

.summary-card-new.inbound::before { background: var(--overview-gradient-green); }
.summary-card-new.outbound::before { background: var(--overview-gradient-orange); }
.summary-card-new.total::before { background: var(--overview-gradient-blue); }
.summary-card-new.ontime::before { background: var(--overview-gradient-purple); }
.summary-card-new.users::before { background: var(--overview-gradient-cyan); }
.summary-card-new.tasks::before { background: var(--overview-gradient-red); }

.summary-card-new:hover {
  transform: translateY(-12px) scale(1.02);
  box-shadow: var(--overview-shadow-xl);
}

.summary-card-new:hover::before {
  height: 8px;
}

.summary-card-new::after {
  content: '';
  position: absolute;
  top: 50%;
  right: -50%;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
  transform: translateY(-50%);
  transition: right 0.6s ease;
  pointer-events: none;
}

.summary-card-new:hover::after {
  right: -10%;
}

/* Card Animation Delays */
.summary-card-new:nth-child(1) { animation: slideInUp 0.6s ease-out 0.1s backwards; }
.summary-card-new:nth-child(2) { animation: slideInUp 0.6s ease-out 0.2s backwards; }
.summary-card-new:nth-child(3) { animation: slideInUp 0.6s ease-out 0.3s backwards; }
.summary-card-new:nth-child(4) { animation: slideInUp 0.6s ease-out 0.4s backwards; }
.summary-card-new:nth-child(5) { animation: slideInUp 0.6s ease-out 0.5s backwards; }
.summary-card-new:nth-child(6) { animation: slideInUp 0.6s ease-out 0.6s backwards; }

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.card-header-new {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2rem;
}

.card-icon-new {
  width: 70px;
  height: 70px;
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  color: white;
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
  position: relative;
  overflow: hidden;
}

.card-icon-new::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
}

.card-icon-new.inbound { background: var(--overview-gradient-green); }
.card-icon-new.outbound { background: var(--overview-gradient-orange); }
.card-icon-new.total { background: var(--overview-gradient-blue); }
.card-icon-new.ontime { background: var(--overview-gradient-purple); }
.card-icon-new.users { background: var(--overview-gradient-cyan); }
.card-icon-new.tasks { background: var(--overview-gradient-red); }

.card-trend-new {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  font-weight: 600;
  padding: 0.5rem 1rem;
  border-radius: 12px;
  backdrop-filter: blur(8px);
  transition: all 0.3s ease;
}

.card-trend-new.up {
  background: rgba(16, 185, 129, 0.15);
  color: var(--overview-accent-green);
  border: 1px solid rgba(16, 185, 129, 0.2);
}

.card-trend-new.down {
  background: rgba(239, 68, 68, 0.15);
  color: var(--overview-accent-red);
  border: 1px solid rgba(239, 68, 68, 0.2);
}

.card-trend-new.neutral {
  background: rgba(100, 116, 139, 0.15);
  color: var(--overview-text-muted);
  border: 1px solid rgba(100, 116, 139, 0.2);
}

.card-content-new {
  margin-top: 1.5rem;
}

.card-value-new {
  font-size: 3rem;
  font-weight: 800;
  color: var(--overview-text-primary);
  margin-bottom: 0.5rem;
  line-height: 1;
  letter-spacing: -0.02em;
}

.card-label-new {
  font-size: 1rem;
  color: var(--overview-text-muted);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* ===== OVERVIEW GRID LAYOUT ===== */
.overview-grid-new {
  display: grid;
  grid-template-columns: 2fr 1fr;
  grid-template-rows: auto auto auto;
  gap: 2rem;
  margin-bottom: 2rem;
}

.overview-card-new {
  background: var(--overview-bg-glass);
  backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 24px;
  padding: 2.5rem;
  box-shadow: var(--overview-shadow-lg);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  z-index: 1;
}

.overview-card-new::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--overview-gradient-primary);
  transform: scaleX(0);
  transition: transform 0.4s ease;
}

.overview-card-new:hover {
  transform: translateY(-8px);
  box-shadow: var(--overview-shadow-xl);
}

.overview-card-new:hover::before {
  transform: scaleX(1);
}

.overview-card-new.full-width {
  grid-column: span 2;
}

/* ===== CARD HEADERS ===== */
.card-header-overview {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid rgba(226, 232, 240, 0.8);
  position: relative;
}

.card-header-overview::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 60px;
  height: 2px;
  background: var(--overview-gradient-primary);
  border-radius: 1px;
}

.card-title-new {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.card-title-new h3 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--overview-text-primary);
  margin: 0;
  letter-spacing: -0.01em;
   white-space: nowrap; /* ✅ เพิ่มบรรทัดนี้เพื่อไม่ให้ตัดคำ */
}

.card-title-new i {
  font-size: 1.5rem;
  background: var(--overview-gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* ===== CONTROL BUTTONS ===== */
.card-controls {
  display: flex;
  gap: 0.75rem;
}

.control-btn {
  padding: 0.75rem 1.5rem;
  border: 1px solid var(--overview-border);
  border-radius: 12px;
  background: var(--overview-bg-card);
  color: var(--overview-text-muted);
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.control-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: var(--overview-gradient-primary);
  transition: left 0.3s ease;
  z-index: -1;
}

.control-btn:hover, .control-btn.active {
  color: white;
  border-color: var(--overview-accent-green);
  transform: translateY(-2px);
  box-shadow: var(--overview-shadow-md);
}

.control-btn:hover::before, .control-btn.active::before {
  left: 0;
}

/* ===== STATUS SYSTEM ===== */
.status-grid-new {
  display: grid;
  gap: 1.5rem;
}

.status-item-new {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.25rem 1.5rem;
  background: rgba(248, 250, 252, 0.5);
  border: 1px solid var(--overview-border-light);
  border-radius: 16px;
  transition: all 0.3s ease;
}

.status-item-new:hover {
  background: rgba(248, 250, 252, 0.8);
  transform: translateX(4px);
  box-shadow: var(--overview-shadow-sm);
}

.status-label-new {
  font-size: 1rem;
  color: var(--overview-text-secondary);
  font-weight: 600;
}

.status-value-new {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-weight: 700;
  color: var(--overview-text-primary);
  font-size: 0.95rem;
}

.status-indicator-new {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  position: relative;
}

.status-indicator-new::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  animation: pulse-glow 2s ease-in-out infinite;
}

.status-indicator-new.success {
  background: var(--overview-accent-green);
}

.status-indicator-new.success::before {
  background: var(--overview-accent-green);
}

.status-indicator-new.warning {
  background: var(--overview-accent-orange);
}

.status-indicator-new.warning::before {
  background: var(--overview-accent-orange);
}

.status-indicator-new.error {
  background: var(--overview-accent-red);
}

.status-indicator-new.error::before {
  background: var(--overview-accent-red);
}

.status-indicator-new.offline {
  background: #94a3b8;
}

.status-indicator-new.offline::before {
  background: #94a3b8;
}

@keyframes pulse-glow {
  0%, 100% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
  50% {
    opacity: 0.3;
    transform: translate(-50%, -50%) scale(1.5);
  }
}

/* ===== ACTIVITY FEED ===== */
.activity-feed-new {
  max-height: 450px;
  overflow-y: auto;
  padding-right: 1rem;
  margin-right: -1rem;
}

.activity-feed-new::-webkit-scrollbar {
  width: 6px;
}

.activity-feed-new::-webkit-scrollbar-track {
  background: var(--overview-border-light);
  border-radius: 3px;
}

.activity-feed-new::-webkit-scrollbar-thumb {
  background: var(--overview-border);
  border-radius: 3px;
}

.activity-feed-new::-webkit-scrollbar-thumb:hover {
  background: var(--overview-text-muted);
}

.activity-item-new {
  display: flex;
  align-items: center;
  gap: 1.25rem;
  padding: 1.25rem 0;
  border-bottom: 1px solid var(--overview-border-light);
  transition: all 0.3s ease;
  border-radius: 12px;
}

.activity-item-new:hover {
  background: rgba(248, 250, 252, 0.6);
  padding-left: 1rem;
  padding-right: 1rem;
  margin-left: -1rem;
  margin-right: -1rem;
  transform: translateX(4px);
}

.activity-item-new:last-child {
  border-bottom: none;
}

.activity-icon-new {
  width: 48px;
  height: 48px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  color: white;
  flex-shrink: 0;
  position: relative;
  overflow: hidden;
}

.activity-icon-new::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
}

.activity-icon-new.inbound { background: var(--overview-gradient-green); }
.activity-icon-new.outbound { background: var(--overview-gradient-orange); }
.activity-icon-new.system { background: var(--overview-gradient-blue); }
.activity-icon-new.user { background: var(--overview-gradient-purple); }

.activity-content-new {
  flex: 1;
  min-width: 0;
}

.activity-text-new {
  font-size: 1rem;
  color: var(--overview-text-primary);
  margin-bottom: 0.25rem;
  font-weight: 500;
  line-height: 1.4;
}

.activity-time-new {
  font-size: 0.85rem;
  color: var(--overview-text-muted);
  font-weight: 500;
}

/* ===== ENVIRONMENTAL CARDS ===== */
.env-grid-new {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.5rem;
}

.env-card-new {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 80%, #bae6fd 100%);
  border: 1px solid rgba(6, 182, 212, 0.2);
  border-radius: 20px;
  padding: 2rem 1.5rem;
  text-align: center;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.env-card-new::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(6, 182, 212, 0.1) 0%, transparent 70%);
  transform: rotate(45deg);
  transition: transform 0.6s ease;
}

.env-card-new:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 20px 40px rgba(6, 182, 212, 0.15);
  border-color: rgba(6, 182, 212, 0.3);
}

.env-card-new:hover::before {
  transform: rotate(225deg);
}

.env-value-new {
  font-size: 2.5rem;
  font-weight: 800;
  color: var(--overview-text-primary);
  margin-bottom: 0.75rem;
  line-height: 1;
  background: linear-gradient(135deg, var(--overview-accent-cyan) 0%, var(--overview-accent-blue) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  position: relative;
  z-index: 1;
}

.env-label-new {
  font-size: 1rem;
  color: var(--overview-text-secondary);
  margin-bottom: 0.5rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  position: relative;
  z-index: 1;
}

.env-range-new {
  font-size: 0.9rem;
  color: var(--overview-accent-cyan);
  font-weight: 700;
  background: rgba(6, 182, 212, 0.1);
  padding: 0.25rem 0.75rem;
  border-radius: 8px;
  display: inline-block;
  position: relative;
  z-index: 1;
}

/* ===== CHART CONTAINERS ===== */
#pieChartContainer-new, .chart-container-new {
  position: relative;
  /* height: 420px; */ /* ❌ เอาความสูงคงที่ออก */
  min-height: 400px;  /* ✅ ใช้ความสูงขั้นต่ำแทน */
  padding: 1rem;
  background: rgba(248, 250, 252, 0.3);
  border-radius: 16px;
  border: 1px solid var(--overview-border-light);
  display: flex;
  align-items: center;
  justify-content: center;
}

#pieChartContainer-new {
  height: 280px;
}

.chart-container-new.hourly {
  height: 220px;
}

/* ===== LOADING & ERROR STATES ===== */
.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: var(--overview-text-muted);
  text-align: center;
}

.loading-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  background: var(--overview-gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: spin-loading 2s linear infinite;
}

.loading-state p {
  font-size: 1.1rem;
  font-weight: 500;
  margin: 0;
}

@keyframes spin-loading {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.error-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: var(--overview-text-muted);
  text-align: center;
  padding: 2rem;
}

.error-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  color: var(--overview-accent-red);
  animation: shake 0.5s ease-in-out;
}

.error-state p {
  font-size: 1.1rem;
  font-weight: 500;
  margin: 0 0 1rem 0;
}

.error-state button {
  padding: 0.75rem 1.5rem;
  background: var(--overview-gradient-primary);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.error-state button:hover {
  transform: translateY(-2px);
  box-shadow: var(--overview-shadow-md);
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

/* ===== SPECIAL EFFECTS ===== */
.card-glow {
  position: relative;
}

.card-glow::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: var(--overview-gradient-primary);
  border-radius: 26px;
  z-index: -1;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.card-glow:hover::before {
  opacity: 0.7;
}

/* ===== TOOLTIP STYLES ===== */
.tooltip {
  position: relative;
  cursor: help;
}

.tooltip::before {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--overview-text-primary);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 500;
  white-space: nowrap;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  z-index: 1000;
}

.tooltip::after {
  content: '';
  position: absolute;
  bottom: 115%;
  left: 50%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-top-color: var(--overview-text-primary);
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  z-index: 1000;
}

.tooltip:hover::before,
.tooltip:hover::after {
  opacity: 1;
  visibility: visible;
}

/* ===== BADGE STYLES ===== */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap; /* ✅ เพิ่มบรรทัดนี้ */
}

.status-badge.success {
  background: rgba(16, 185, 129, 0.15);
  color: var(--overview-accent-green);
  border: 1px solid rgba(16, 185, 129, 0.2);
}

.status-badge.warning {
  background: rgba(245, 158, 11, 0.15);
  color: var(--overview-accent-orange);
  border: 1px solid rgba(245, 158, 11, 0.2);
}

.status-badge.error {
  background: rgba(239, 68, 68, 0.15);
  color: var(--overview-accent-red);
  border: 1px solid rgba(239, 68, 68, 0.2);
}

.status-badge.info {
  background: rgba(14, 165, 233, 0.15);
  color: var(--overview-accent-blue);
  border: 1px solid rgba(14, 165, 233, 0.2);
}

/* ===== FLOATING ACTION BUTTON ===== */
.fab {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  width: 64px;
  height: 64px;
  background: var(--overview-gradient-primary);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  box-shadow: var(--overview-shadow-lg);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 100;
}

.fab:hover {
  transform: scale(1.1) translateY(-4px);
  box-shadow: var(--overview-shadow-xl);
}

.fab:active {
  transform: scale(0.95);
}

/* ===== NOTIFICATION STYLES (Bottom-Right) ===== */
.notification {
  position: fixed;
  bottom: 2rem;   /* ✅ เปลี่ยนจาก top เป็น bottom */
  right: 2rem;    /* ✅ ยังคงไว้ที่ด้านขวา */
  background: var(--overview-bg-glass);
  backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 16px;
  padding: 1.5rem;
  box-shadow: var(--overview-shadow-xl);
  z-index: 9999;
  max-width: 400px;
  
  /* ✅ เปลี่ยนอนิเมชันให้สไลด์ขึ้นจากด้านล่าง */
  transform: translateY(100%);
  opacity: 0;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.notification.show {
  /* ✅ เปลี่ยนอนิเมชันให้สไลด์ขึ้นมาที่ตำแหน่ง 0 */
  transform: translateY(0);
  opacity: 1;
}

.notification.success {
  border-left: 4px solid var(--overview-accent-green);
}

.notification.warning {
  border-left: 4px solid var(--overview-accent-orange);
}

.notification.error {
  border-left: 4px solid var(--overview-accent-red);
}

.notification.info {
  border-left: 4px solid var(--overview-accent-blue);
}

/* ===== ANIMATION UTILITIES ===== */
.fade-in {
  animation: fadeIn 0.6s ease-out;
}

.slide-in-left {
  animation: slideInLeft 0.6s ease-out;
}

.slide-in-right {
  animation: slideInRight 0.6s ease-out;
}

.scale-in {
  animation: scaleIn 0.4s ease-out;
}

.bounce-in {
  animation: bounceIn 0.6s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-50px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(50px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes bounceIn {
  0% {
    opacity: 0;
    transform: scale(0.3);
  }
  50% {
    opacity: 1;
    transform: scale(1.05);
  }
  70% {
    transform: scale(0.9);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 1400px) {
  .overview-grid-new {
    grid-template-columns: 1fr;
  }
  
  .overview-card-new.full-width {
    grid-column: span 1;
  }
}

@media (max-width: 1024px) {
  .overview-content-wrapper {
    padding: 1rem;
  }
  
  .summary-cards-new {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }
}

@media (max-width: 768px) {
  .overview-content-wrapper {
    padding: 0.75rem;
  }
  
  .summary-cards-new {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  
  .summary-card-new {
    padding: 1.5rem;
  }
  
  .overview-card-new {
    padding: 1.5rem;
  }
  
  .env-grid-new {
    grid-template-columns: 1fr;
  }
  
  .card-header-overview {
    flex-direction: column;
    gap: 1rem;
    align-items: flex-start;
  }
}

@media (max-width: 480px) {
  .overview-content-wrapper {
    padding: 0.5rem;
  }
  
  .summary-card-new {
    padding: 1.25rem;
    border-radius: 16px;
  }
  
  .card-value-new {
    font-size: 2.25rem;
  }
  
  .overview-card-new {
    padding: 1rem;
    border-radius: 16px;
  }
  
  .fab {
    width: 56px;
    height: 56px;
    bottom: 1rem;
    right: 1rem;
  }
}

/* ===== UTILITY CLASSES ===== */
.text-gradient {
  background: var(--overview-gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.bg-gradient {
  background: var(--overview-gradient-primary);
}

.shadow-soft {
  box-shadow: var(--overview-shadow-md);
}

.shadow-strong {
  box-shadow: var(--overview-shadow-lg);
}

.border-gradient {
  border: 2px solid transparent;
  background: linear-gradient(white, white), var(--overview-gradient-primary);
  background-clip: padding-box, border-box;
}

.backdrop-blur {
  backdrop-filter: blur(16px);
}

.glass-effect {
  background: var(--overview-bg-glass);
  backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

/* ===== ACCESSIBILITY ===== */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* ===== HIGH CONTRAST MODE ===== */
@media (prefers-contrast: high) {
  :root {
    --overview-border: #000000;
    --overview-border-light: #333333;
    --overview-text-muted: #000000;
  }
  
  .summary-card-new,
  .overview-card-new {
    border: 2px solid #000000 !important;
  }
}

/* ===== FOCUS STYLES FOR ACCESSIBILITY ===== */
.control-btn:focus,
.fab:focus,
button:focus {
  outline: 2px solid var(--overview-accent-blue);
  outline-offset: 2px;
}

.control-btn:focus-visible,
.fab:focus-visible,
button:focus-visible {
  outline: 2px solid var(--overview-accent-blue);
  outline-offset: 2px;
}

/* ===== PERFORMANCE OPTIMIZATIONS ===== */
.summary-card-new,
.overview-card-new,
.activity-item-new {
  will-change: transform;
}

.summary-card-new:hover,
.overview-card-new:hover {
  will-change: auto;
}

/* ================================================================================================
   📱 COMPREHENSIVE MOBILE RESPONSIVE DESIGN
   ================================================================================================ */

/* Mobile First - Base Styles */
@media (max-width: 768px) {
  /* Layout Structure */
  #dashboardPage {
    flex-direction: column !important;
    height: 100vh;
    overflow: hidden;
  }
  
  /* Sidebar Mobile */
  .sidebar {
    position: fixed !important;
    top: 0;
    left: -280px;
    width: 280px !important;
    height: 100vh;
    transition: left 0.3s ease;
    z-index: 1000;
    background: white;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    overflow-y: auto;
  }
  
  .sidebar.show {
    left: 0 !important;
  }
  
  .sidebar a {
    padding: 15px 20px !important;
    font-size: 16px !important;
    border-bottom: 1px solid #f1f5f9;
  }
  
  .sidebar a i {
    width: 24px !important;
    margin-right: 12px !important;
  }
  
  /* Main Content Mobile */
  .main {
    width: 100% !important;
    margin-left: 0 !important;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  
  /* Header Mobile */
  .header {
    padding: 12px 16px !important;
    height: auto !important;
    min-height: 60px;
    flex-shrink: 0;
  }
  
  .header-left {
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .dashboard-title h1 {
    font-size: 18px !important;
    margin: 0;
  }
  
  .dashboard-icon {
    width: 24px !important;
    height: 24px !important;
  }
  
  #hamburger-menu {
    display: block !important;
    padding: 8px;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
  }
  
  /* Station Dropdown Mobile */
  .station-dropdown {
    font-size: 14px !important;
    padding: 8px 12px !important;
    width: 120px;
  }
  
  /* Content Area Mobile */
  .content {
    flex: 1;
    overflow-y: auto;
    padding: 16px !important;
    -webkit-overflow-scrolling: touch;
  }
  
  /* Cards Mobile */
  .card, .overview-card-new, .summary-card-new {
    margin-bottom: 16px !important;
    border-radius: 12px !important;
    padding: 16px !important;
  }
  
  /* Tables Mobile */
  .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  table {
    min-width: 600px;
    font-size: 14px !important;
  }
  
  th, td {
    padding: 8px 12px !important;
    white-space: nowrap;
  }
  
  /* Buttons Mobile */
  .btn, button {
    padding: 12px 16px !important;
    font-size: 16px !important;
    min-height: 44px;
    border-radius: 8px !important;
  }
  
  /* Form Controls Mobile */
  input, select, textarea {
    padding: 12px !important;
    font-size: 16px !important;
    min-height: 44px;
    border-radius: 8px !important;
  }
  
  /* Modal Mobile */
  .modal {
    padding: 16px !important;
  }
  
  .modal-content {
    width: 95% !important;
    max-width: none !important;
    margin: 20px auto !important;
    border-radius: 12px !important;
  }
  
  /* Charts Mobile */
  .chart-container {
    height: 250px !important;
    margin-bottom: 20px;
  }
}

/* Extra Small Mobile Devices */
@media (max-width: 480px) {
  .sidebar {
    width: 260px !important;
    left: -260px;
  }
  
  .header {
    padding: 10px 12px !important;
  }
  
  .dashboard-title h1 {
    font-size: 16px !important;
  }
  
  .content {
    padding: 12px !important;
  }
  
  .btn, button {
    padding: 10px 14px !important;
    font-size: 14px !important;
  }
  
  table {
    font-size: 12px !important;
  }
  
  th, td {
    padding: 6px 8px !important;
  }
}

/* Touch Improvements */
@media (hover: none) and (pointer: coarse) {
  .btn:hover, button:hover, .sidebar a:hover {
    transform: none !important;
  }
  
  .btn:active, button:active {
    transform: scale(0.98);
  }
  
  .sidebar a {
    padding: 16px 20px !important;
  }
}

/* Landscape Mobile */
@media (max-width: 768px) and (orientation: landscape) {
  .header {
    padding: 8px 16px !important;
    min-height: 50px;
  }
  
  .sidebar {
    width: 260px !important;
  }
  
  .content {
    padding: 12px !important;
  }
}

/* Mobile Overlay for Sidebar */
@media (max-width: 768px) {
  .sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    display: none;
  }
  
  .sidebar-overlay.show {
    display: block;
  }
}

/* Hide desktop elements on mobile */
@media (max-width: 768px) {
  .desktop-only {
    display: none !important;
  }
}

/* Mobile-specific utility classes */
.mobile-only {
  display: none;
}

@media (max-width: 768px) {
  .mobile-only {
    display: block;
  }
  
  /* Light Control Mobile Specific */
  .light-control-popup {
    width: 95% !important;
    max-width: none !important;
    height: 90vh !important;
    overflow-y: auto;
    border-radius: 16px !important;
  }
  
  .light-schedule-grid {
    grid-template-columns: 1fr !important;
    gap: 12px !important;
  }
  
  .light-control-item {
    padding: 12px !important;
    border-radius: 12px !important;
  }
  
  /* Camera View Mobile */
  .camera-grid {
    grid-template-columns: 1fr !important;
    gap: 16px !important;
  }
  
  .camera-container {
    aspect-ratio: 16/9;
    border-radius: 12px !important;
  }
  
  /* AGV/RGV Control Mobile */
  .agv-controls {
    flex-direction: column !important;
    gap: 12px !important;
  }
  
  .agv-control-btn {
    width: 100% !important;
    padding: 16px !important;
    font-size: 16px !important;
  }
  
  /* Workstation Mobile */
  .workstation-grid {
    grid-template-columns: 1fr !important;
    gap: 16px !important;
  }
  
  .workstation-card {
    padding: 16px !important;
    border-radius: 12px !important;
  }
  
  /* Environment Monitor Mobile */
  .env-sensor-grid {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
    gap: 12px !important;
  }
  
  .sensor-card {
    padding: 12px !important;
    border-radius: 10px !important;
  }
  
  /* Task Monitor Mobile */
  .task-list {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .task-item {
    padding: 12px !important;
    margin-bottom: 8px !important;
    border-radius: 10px !important;
  }
  
  /* User Management Mobile */
  .user-form {
    padding: 16px !important;
  }
  
  .form-group {
    margin-bottom: 16px !important;
  }
  
  .form-group label {
    font-size: 14px !important;
    margin-bottom: 6px !important;
  }
  
  /* Statistics Cards Mobile */
  .stat-value {
    font-size: 24px !important;
  }
  
  .stat-label {
    font-size: 12px !important;
  }
  
  /* Action Buttons Mobile */
  .action-buttons {
    flex-direction: column !important;
    gap: 8px !important;
  }
  
  .action-btn {
    width: 100% !important;
    justify-content: center !important;
  }
  
  /* Pagination Mobile */
  .pagination {
    flex-wrap: wrap !important;
    justify-content: center !important;
    gap: 4px !important;
  }
  
  .pagination button {
    min-width: 40px !important;
    padding: 8px !important;
  }
  
  /* Search Bar Mobile */
  .search-container {
    flex-direction: column !important;
    gap: 12px !important;
  }
  
  .search-input {
    width: 100% !important;
  }
  
  /* Status Indicators Mobile */
  .status-indicator {
    padding: 6px 12px !important;
    font-size: 12px !important;
    border-radius: 16px !important;
  }
  
  /* Progress Bars Mobile */
  .progress-container {
    height: 8px !important;
    border-radius: 4px !important;
  }
  
  /* Toast Notifications Mobile */
  .toast {
    width: calc(100vw - 32px) !important;
    max-width: 400px !important;
    bottom: 20px !important;
    left: 16px !important;
    right: 16px !important;
    margin: 0 auto !important;
  }
}

/* ===== FINAL TOUCHES ===== */
.enhanced-overview * {
  box-sizing: border-box;
}

.enhanced-overview ::-moz-selection {
  background: rgba(16, 185, 129, 0.2);
}

.enhanced-overview ::selection {
  background: rgba(16, 185, 129, 0.2);
}

/* หัวเรื่อง overview */
.overview-header-enhanced {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding: 1.5rem 2rem;
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.95) 0%, 
        rgba(248, 250, 252, 0.9) 100%);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.08),
        0 1px 0 rgba(255, 255, 255, 0.5) inset;
    border: 1px solid rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
}

.overview-header-enhanced::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, 
        var(--overview-accent-green) 0%,
        var(--overview-accent-blue) 50%,
        var(--overview-accent-green) 100%);
    background-size: 200% 100%;
    animation: headerGradientFlow 3s ease-in-out infinite;
}

@keyframes headerGradientFlow {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 200% center; }
}

.header-icon-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, 
        var(--overview-accent-green) 0%, 
        var(--overview-accent-blue) 100%);
    border-radius: 18px;
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
}

.header-icon {
    font-size: 1.8rem;
    color: white;
    z-index: 2;
    position: relative;
}

.icon-pulse {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 18px;
    animation: iconPulse 2s ease-in-out infinite;
}

@keyframes iconPulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; }
    50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.1; }
}

.enhanced-title {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    margin: 0;
    font-weight: 700;
}

.title-gradient {
    font-size: 2.2rem;
    font-weight: 800;
    background: linear-gradient(135deg, 
        var(--overview-primary) 0%,
        var(--overview-accent-green) 50%,
        var(--overview-accent-blue) 100%);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: titleGradientShift 3s ease-in-out infinite;
    line-height: 1.1;
}

.title-subtitle {
    font-size: 1.4rem;
    font-weight: 500;
    color: var(--overview-text-muted);
    opacity: 0.8;
}

@keyframes titleGradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.title-decoration {
    width: 50px;
    height: 3px;
    background: linear-gradient(90deg, 
        var(--overview-accent-green) 0%,
        var(--overview-accent-blue) 100%);
    border-radius: 2px;
    margin-left: auto;
    animation: decorationGlow 2s ease-in-out infinite;
}

@keyframes decorationGlow {
    0%, 100% { opacity: 0.6; transform: scaleX(1); }
    50% { opacity: 1; transform: scaleX(1.1); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .overview-header-enhanced {
        flex-direction: column;
        gap: 1rem;
        padding: 1.2rem;
        text-align: center;
    }
    
    .enhanced-title {
        flex-direction: column;
        gap: 0.3rem;
    }
    
    .title-gradient {
        font-size: 1.8rem;
    }
    
    .title-subtitle {
        font-size: 1.1rem;
    }
}
.station-dropdown {
  width: 180px; /* ⭐ [เพิ่ม] กำหนดความกว้างให้สั้นลง */
  -webkit-appearance: none;
  appearance: none;
  padding: 12px 40px 12px 20px;
  border-radius: 12px;
  border: 1px solid #b7e4c7;
  background-color: #ffffff;
  font-size: 1rem;
  font-weight: 600;
  color: #1b4332;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  transition: all 0.2s ease-in-out;

  /* ลูกศรแบบกำหนดเอง */
  background-image: url("data:image/svg+xml,..."); /* (โค้ด SVG ของคุณเหมือนเดิม) */
  background-repeat: no-repeat;
  background-position: right 14px center;
}

.station-dropdown:hover {
  border-color: #52b788;
  box-shadow: 0 4px 12px rgba(82, 183, 136, 0.15);
}

.station-dropdown:focus {
  outline: none;
  border-color: #40916c;
  box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.3);
}











/* ✅ ดีไซน์ใหม่สำหรับป้ายสถานะ (Status Badge) traymaster */
/* ✨ [เพิ่มใหม่] อนิเมชั่นสำหรับแถวในตาราง Tray Master ✨ */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-in-row {
  opacity: 0;
  animation: fadeInUp 0.5s ease-out forwards;
}

/* 🎨 [อัปเกรด] ดีไซน์สำหรับป้ายสถานะและปุ่มคำสั่ง 🎨 */
.status-badge {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 6px 14px; border-radius: 20px;
    font-weight: 600; font-size: 0.9em;
    border: 1px solid transparent;
}
.status-badge.on-shelf {
    background-color: #e6f4ea; color: #1b4332; border-color: #a7d7b9;
}
.status-badge.at-workstation {
    background-color: #fffbeb; color: #b45309; border-color: #fde68a;
}
.action-btn {
    display: inline-flex; align-items: center; justify-content: center;
    gap: 6px; padding: 9px 18px; border-radius: 10px;
    border: none; cursor: pointer; font-weight: 600;
    font-size: 0.9em; transition: all 0.2s ease-in-out;
    min-width: 90px;
}
.action-btn.edit { background-color: #f97316; color: white; }
.action-btn.edit:hover {
    background-color: #ea580c; transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
}
.action-btn.history { background-color: #4b5563; color: white; }
.action-btn.history:hover {
    background-color: #374151; transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(75, 85, 99, 0.3);
}/* ✅ ดีไซน์ใหม่สำหรับป้ายสถานะ (Status Badge) traymaster */





/* ✅ Style สำหรับแถวประวัติที่เพิ่มเข้ามาใหม่ */
.history-row td {
  background-color: #f8f9fa;
  padding: 20px !important;
  border-bottom: 2px solid #52b788;
}
.history-table {
  width: 100%;
  border-collapse: collapse;
  margin: 0 auto;
}
.history-table th, .history-table td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #e0e0e0;
}
.history-table th {
  background-color: #2d6a4f; /* 🎨 สีเขียวเข้มเหมือนตารางหลัก */
  color: #ffffff; /* 🎨 ตัวอักษรสีขาว */
  font-weight: 600;
}
.history-row .action-inbound { 
    color: #1b4332; /* ✅ เปลี่ยนเป็นสีเขียวเข้มเพื่อให้อ่านง่าย */
    font-weight: bold; 
}
.history-row .action-outbound { color: #ef4444; font-weight: bold; }


/**
 * ✅ [เพิ่มใหม่] CSS ทำให้กล่องข้อความแจ้งเตือนสวยงาม
 */
#outboundValidationBox {
  padding: 18px;
  border-radius: 12px;
  border-width: 1px;
  border-style: solid;
  transition: all 0.3s ease-in-out;
  animation: fadeIn 0.4s;
}

#outboundValidationBox p {
  margin: 0;
  font-size: 1.05em;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* สถานะเมื่อเจอถาด (Success) */
#outboundValidationBox.success {
  background-color: #f0fdf4; /* เขียวอ่อน */
  border-color: #bbf7d0;
  color: #166534;
}

/* สถานะเมื่อไม่เจอถาด (Warning) */
#outboundValidationBox.warning {
  background-color: #fffbeb; /* เหลืองอ่อน */
  border-color: #fde68a;
  color: #b45309;
}
/* ✅ 💅 CSS สำหรับ Pop-up ยืนยันข้อมูลแบบละเอียด */
/* ✅ Pop-up Styling (ฉบับสมบูรณ์) */
.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(31, 41, 55, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(5px);
  opacity: 0;
  animation: fadeIn 0.3s ease-out forwards;
}

.popup-container {
  background: #ffffff;
  padding: 35px 40px;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  width: 90%;
  max-width: 520px;
  transform: scale(0.95);
  animation: popIn 0.3s ease-out forwards;
}

.popup-header {
  text-align: center;
  margin-bottom: 25px;
}

.popup-header .icon {
  font-size: 3rem;
  color: #10B981; /* สีเขียว (Default) */
}

/* ✅ [เพิ่มใหม่] ทำให้ไอคอนเป็นสีแดงเมื่องานเป็น Outbound */
.popup-header .icon.danger {
    color: #e63946;
}

.popup-title {
  font-size: 1.6em;
  font-weight: 700;
  color: #1F2937;
  margin-top: 15px;
  margin-bottom: 8px;
}

.popup-subtitle {
  font-size: 1.1em;
  color: #6B7280;
  margin: 0;
}

.popup-summary {
  background-color: #F9FAFB;
  border-radius: 12px;
  padding: 20px;
  border: 1px solid #E5E7EB;
  margin-top: 20px;
}

.summary-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  font-size: 1.05em;
  border-bottom: 1px solid #F3F4F6;
}

.summary-item:last-child {
  border-bottom: none;
}

.summary-label {
  color: #4B5563;
  font-weight: 500;
}

.summary-value {
  color: #111827;
  font-weight: 600;
  text-align: right;
  word-break: break-all;
}

.summary-value.highlight {
  color: #059669;
  font-weight: 700;
}

.popup-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-top: 30px;
}

.popup-button {
  padding: 14px;
  font-size: 1.1em;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.popup-button.cancel {
  background-color: #E5E7EB;
  color: #4B5563;
  border: 1px solid #D1D5DB;
}

.popup-button.cancel:hover {
  background-color: #D1D5DB;
}

/* -- ปุ่มยืนยัน -- */
.popup-button.confirm {
  background: linear-gradient(135deg, #10B981, #059669);
  color: white;
}

.popup-button.confirm:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

/* ✅ [เพิ่มใหม่] สไตล์สำหรับปุ่มยืนยันสีแดง */
.popup-button.confirm.danger {
  background: linear-gradient(135deg, #e63946, #b91c1c);
}

.popup-button.confirm.danger:hover {
  background: linear-gradient(135deg, #b91c1c, #9a141a);
  box-shadow: 0 4px 15px rgba(229, 62, 77, 0.3);
}

/* === 💅 Deluxe Form Styling + Beautiful Animations === */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');

body {
    background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);
    font-family: 'Prompt', sans-serif; /* ✅✅✅ แก้ไขเป็น 'Prompt' */
    position: relative;
    overflow-x: hidden;
    transition: all 0.6s ease;
}

/* ✨ Animated Background */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 80%, rgba(45, 106, 79, 0.4) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(64, 145, 108, 0.3) 0%, transparent 50%);
    z-index: -1;
    animation: backgroundPulse 8s ease-in-out infinite;
}

@keyframes backgroundPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

/* 🔴 Outbound Background Animation */
.page-tray-outbound {
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%) !important;
}

.page-tray-outbound::before {
    background: 
        radial-gradient(circle at 20% 80%, rgba(220, 38, 38, 0.4) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(239, 68, 68, 0.3) 0%, transparent 50%) !important;
}

/* ✅ ปรับให้กว้างขึ้นและสูงน้อยลง */
.form-container-deluxe {
    max-width: 800px;
    width: 95%;
    margin: 40px auto;
    padding: 30px 40px;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    border: none;
    border-radius: 24px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
    overflow: hidden;
    position: relative;
    animation: slideInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    transform-origin: center;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* 🌟 Shimmer Effect */
.form-container-deluxe::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #2d6a4f, #40916c, #2d6a4f);
    background-size: 200% 100%;
    animation: shimmer 3s linear infinite;
}

.page-tray-outbound .form-container-deluxe::before {
    background: linear-gradient(90deg, #dc2626, #ef4444, #dc2626) !important;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(60px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* ✅ ปรับ header ให้สูงน้อยลง */
.form-header {
    text-align: center;
    margin-bottom: 25px;
    position: relative;
    width: 100%;
}

/* ✅ ปรับ title ให้สูงน้อยลง */
.form-title {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    font-size: 2.2em;
    font-weight: 700;
    background: linear-gradient(135deg, #2d6a4f 0%, #40916c 50%, #2d6a4f 100%);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0 0 8px 0;
    animation: titleGradient 4s ease-in-out infinite;
    letter-spacing: -0.5px;
    text-align: center;
}

.page-tray-outbound .form-title {
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 50%, #dc2626 100%) !important;
    background-size: 200% 200%;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    animation: titleGradientRed 4s ease-in-out infinite;
}

@keyframes titleGradient {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

@keyframes titleGradientRed {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

/* 🎪 Bouncing Icon */
.form-title i {
    font-size: 1.2em;
    background: linear-gradient(135deg, #40916c, #2d6a4f);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 2px 4px rgba(64, 145, 108, 0.3));
    animation: iconBounce 2s ease-in-out infinite;
}

.page-tray-outbound .form-title i {
    background: linear-gradient(135deg, #ef4444, #dc2626) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    filter: drop-shadow(0 2px 4px rgba(239, 68, 68, 0.3)) !important;
}

@keyframes iconBounce {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
}

/* ✅ ปรับ subtitle ให้สูงน้อยลง */
.form-subtitle {
    font-size: 1.1em;
    color: #6B7280;
    font-weight: 400;
    line-height: 1.4;
    max-width: 600px;
    margin: 0 auto 5px auto;
    text-align: center;
    animation: fadeInUp 0.8s ease-out 0.3s both;
}

/* ✅ ปรับ form-grid ให้กว้างขึ้น */
.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 30px;
    width: 100%;
    max-width: 700px;
    margin: 0 auto;
}

.form-group {
    display: flex;
    flex-direction: column;
    position: relative;
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
}

/* 🎭 Staggered Animation */
.form-group:nth-child(1) { animation-delay: 0.1s; }
.form-group:nth-child(2) { animation-delay: 0.2s; }
.form-group:nth-child(3) { animation-delay: 0.3s; }
.form-group:nth-child(4) { animation-delay: 0.4s; }
.form-group:nth-child(5) { animation-delay: 0.5s; }
.form-group:nth-child(6) { animation-delay: 0.6s; }

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 12px;
    font-size: 1em;
    transition: color 0.3s ease;
}

/* 🎨 Animated Label Icons */
.form-group label i {
    color: #40916c;
    font-size: 1.2em;
    transition: all 0.3s ease;
}

.page-tray-outbound .form-group label i {
    color: #ef4444 !important;
}

.form-group:hover label i {
    transform: scale(1.2) rotate(5deg);
}

/* ✅ ปรับ input ให้เหมาะกับความกว้างใหม่ */
.form-input-deluxe {
    width: 100%;
    padding: 16px 20px;
    border: 2px solid transparent;
    border-radius: 16px;
    font-size: 1.1em;
    font-family: 'Poppins', sans-serif;
    color: #1F2937;
    background: linear-gradient(white, white) padding-box,
                linear-gradient(135deg, #e5e7eb, #f3f4f6) border-box;
    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    position: relative;
}

.form-input-deluxe:focus {
    outline: none;
    background: linear-gradient(white, white) padding-box,
                linear-gradient(135deg, #2d6a4f, #40916c) border-box;
    transform: translateY(-3px);
    box-shadow: 0 12px 30px rgba(64, 145, 108, 0.25);
}

.page-tray-outbound .form-input-deluxe:focus {
    background: linear-gradient(white, white) padding-box,
                linear-gradient(135deg, #dc2626, #ef4444) border-box !important;
    box-shadow: 0 12px 30px rgba(239, 68, 68, 0.25) !important;
}

.form-input-deluxe::placeholder {
    color: #9CA3AF;
    font-style: italic;
}

textarea.form-input-deluxe {
    resize: vertical;
    padding-top: 16px;
    min-height: 100px;
}

/* ✅ ปรับ button ให้กว้างขึ้น */
.form-button-action {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    width: 100%;
    max-width: 500px;
    margin: 25px auto 0 auto;
    padding: 18px 40px;
    font-size: 1.2em;
    font-weight: 700;
    color: white;
    background: linear-gradient(135deg, #40916c 0%, #2d6a4f 50%, #40916c 100%);
    background-size: 200% 200%;
    border: none;
    border-radius: 16px;
    cursor: pointer;
    box-shadow: 
        0 10px 30px rgba(64, 145, 108, 0.35),
        0 0 0 1px rgba(255, 255, 255, 0.1) inset;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    text-transform: uppercase;
    letter-spacing: 1.2px;
    position: relative;
    overflow: hidden;
    animation: buttonGlow 3s ease-in-out infinite;
}

@keyframes buttonGlow {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

/* 🌟 Shimmer Effect on Button */
.form-button-action::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
    transition: left 0.8s ease;
}

.form-button-action:hover {
    transform: translateY(-6px) scale(1.02);
    box-shadow: 
        0 20px 50px rgba(64, 145, 108, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.2) inset;
}

.form-button-action:hover::before {
    left: 100%;
}

.form-button-action:active {
    transform: translateY(-3px) scale(1.01);
}

/* 🔥 Red Button for Outbound */
.form-button-action.danger {
    background: linear-gradient(135deg, #EF4444 0%, #DC2626 50%, #EF4444 100%);
    background-size: 200% 200%;
    box-shadow: 
        0 10px 30px rgba(239, 68, 68, 0.35),
        0 0 0 1px rgba(255, 255, 255, 0.1) inset;
    animation: dangerGlow 3s ease-in-out infinite;
}

@keyframes dangerGlow {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.form-button-action.danger:hover {
    transform: translateY(-6px) scale(1.02);
    box-shadow: 
        0 20px 50px rgba(239, 68, 68, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.2) inset;
}

/* ✅ ปรับ responsive */
@media (max-width: 768px) {
    .form-container-deluxe {
        width: 98%;
        margin: 20px auto;
        padding: 25px 20px;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
        gap: 20px;
        max-width: 100%;
    }
    
    .form-title {
        font-size: 1.8em;
    }
    
    .form-button-action {
        padding: 16px 30px;
        font-size: 1.1em;
        max-width: 100%;
    }
    
    .form-input-deluxe {
        padding: 14px 18px;
    }
}

/* ✅ เพิ่ม smooth centering effect */
.form-container-deluxe:hover {
    transform: translateY(-3px) scale(1.01);
    box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.15),
        0 0 0 1px rgba(255, 255, 255, 0.2) inset;
}

/* Responsive adjustments for smaller screens */
@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    .form-container-deluxe {
        padding: 30px;
    }
    .form-title {
        font-size: 1.8em;
    }
}

/* ✅ กลุ่มแสดงกล้องแบบพรีเมียม */
.camera-section {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  justify-content: center;
  align-items: stretch;
  margin-top: 30px;
  padding: 10px 0;
}

/* ✅ กล่องกล้องสุดหรู */
.camera-box {
  position: relative;
  flex: 1 1 42%;
  max-width: 720px;
  aspect-ratio: 16 / 9;
  background: #000;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.06);
  backdrop-filter: blur(3px);
}


.camera-box:hover {
  transform: scale(1.015);
  box-shadow: 0 12px 36px rgba(0, 0, 0, 0.4);
}

/* ✅ กล้องปกติ (แนวนอน) */
.camera-box img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

/* ✅ กล้องปกติ (ไม่มีการหมุน) */
.camera-box .camera-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* ✅ กล้องที่ต้องหมุนซ้าย (เช่น RGV ติดแนวตั้ง) */
.camera-box .rotate-left {
  transform: rotate(-90deg);
  transform-origin: center center;
  position: absolute;
  top: 50%;
  left: 50%;
  width: 160%;      /* ✅ ขยายความกว้างให้เต็มกล่อง */
  height: auto;
  translate: -50% -50%;
  object-fit: cover;
}

/* ✅ ป้ายชื่อกล้องหรูหรา */
.camera-label {
  position: absolute;
  bottom: 12px;
  left: 16px;
  background: rgba(0, 0, 0, 0.6);
  color: #ffffff;
  padding: 6px 14px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 500;
  font-family: 'Segoe UI', 'Kanit', sans-serif;
  letter-spacing: 0.5px;
  backdrop-filter: blur(2px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  gap: 6px;
}

.camera-label i {
  color: #58d68d;
  font-size: 14px;
}
/* ✅ กล่องแสดงสถานะ AGV แบบพรีเมียมระดับสูง */
.agv-status-box {
  position: relative;
  background: linear-gradient(135deg, var(--boxColor, #1eb980), rgba(255, 255, 255, 0.05));
  border-radius: 20px;
  padding: 26px 36px;
  color: #ffffff;
  font-family: 'Segoe UI', sans-serif;
  width: 100%;
  max-width: 860px;
  margin: 36px auto;
  box-shadow:
    0 10px 24px rgba(0, 0, 0, 0.2),
    0 0 16px var(--boxColor);
  border: 1px solid rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  overflow: hidden;
  z-index: 1;
  text-align: center;
}

/* ✅ เอฟเฟกต์แสงนุ่ม (ไม่ใช้ animation) */
.agv-status-box::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle at center, var(--boxColor, #1eb980) 0%, transparent 70%);
  opacity: 0.08;
  pointer-events: none;
  z-index: 0;
}

/* ✅ หัวข้อใหญ่แบบบาลานซ์ */
.agv-status-title {
  font-size: 1.85rem;
  font-weight: 700;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 14px;
  color: #ffffff;
  text-shadow: 0 2px 5px rgba(0, 0, 0, 0.35);
  position: relative;
  z-index: 1;
}

.agv-status-title i {
  font-size: 2rem;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.25));
}

/* ✅ คำอธิบายใต้สถานะพอดีสายตา */
.agv-status-desc {
  font-size: 1.1rem;
  font-weight: 400;
  opacity: 0.94;
  line-height: 1.6;
  color: #f8f9fa;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  position: relative;
  z-index: 1;
}

/* 🔴 Error Style แบบมืออาชีพ */
.agv-status-box.error {
  background: linear-gradient(135deg, #dc3545, #6a1b1b);
  box-shadow:
    0 10px 28px rgba(220, 53, 69, 0.35),
    0 0 12px #dc3545;
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: #fff;
}



/* 🔷 ปุ่มสั่งงานแบบพรีเมียม */
.btn-premium {
  padding: 14px 26px;
  font-size: 1rem;
  font-weight: 600;
  border-radius: 14px;
  background: linear-gradient(135deg, #52b788, #2d6a4f);
  color: #ffffff;
  border: none;
  box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  cursor: pointer;
  transition: all 0.25s ease;
}
.btn-premium:hover {
  transform: translateY(-2px);
  background: linear-gradient(135deg, #2d6a4f, #1b4332);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
}

/* 🔷 ปุ่มกลุ่มจัดเรียงสวยหรู */
.main-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin: 30px 0;
}

/* 🔷 กล่องกล้องแบบพรีเมียม */
.camera-section {
  display: flex;
  flex-wrap: wrap;
  gap: 36px;
  justify-content: center;
  margin: 40px 0;
}
.camera-box {
  flex: 1 1 48%;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
  overflow: hidden;
  position: relative;
  border: 1px solid #e2e8f0;
  height: auto;
}

/* 🔷 กล่องสถานะ AGV แบบพรีเมียม */
.lift-status {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  margin: 24px auto;
  padding: 14px 28px;
  font-size: 1.1rem;
  font-weight: 600;
  border-radius: 16px;
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.15);
  border: 2px solid transparent;
  background: linear-gradient(to right, #06b6d4, #0ea5e9);
  color: #ffffff;
  transition: all 0.4s ease;
}
.lift-status.working {
  background: linear-gradient(to right, #06b6d4, #0ea5e9);
  border-color: #0ea5e9;
}
.lift-status.working i {
  margin-right: 6px;
}

/* 🔷 ป้ายแสดงสถานะเซ็นเซอร์ */
.sensor-status {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
  margin-bottom: 30px;
}
.sensor-tag {
  background: #e6f4ea;
  color: #1b4332;
  border: 1px solid #52b788;
  border-radius: 20px;
  padding: 8px 18px;
  font-size: 0.95em;
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
}

/* 🔷 Dropdown ช่องปลายทาง */
.dropdown {
  text-align: center;
  margin-top: 40px;
}
select.dropdown-select {
  padding: 12px 20px;
  font-size: 1em;
  font-weight: 500;
  border-radius: 14px;
  border: 1px solid #cbd5e1;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
  width: 280px;
  margin-top: 10px;
  background-color: #ffffff;
  color: #1b4332;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg fill='none' stroke='%232d6a4f' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  background-size: 16px 16px;
  transition: all 0.3s ease;
}
select.dropdown-select:focus {
  border-color: #40916c;
  box-shadow: 0 0 0 3px rgba(64, 145, 108, 0.25);
}



/* ✅ liftstatus */

.lift-status.working {
  background: linear-gradient(to right, #0284c7, #0ea5e9); /* 💙 ฟ้าสด */
  color: white;
  border: 2px solid #0ea5e9;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: all 0.4s ease;
}


.lift-status {
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 24px auto;
  padding: 14px 24px;
  font-size: 1.1rem;
  font-weight: 600;
  border-radius: 14px;
  width: fit-content;
  box-shadow: 0 6px 14px rgba(0,0,0,0.15);
  border: 2px solid;
  transition: all 0.4s ease;
}

.lift-status.success {
  background: linear-gradient(to right, #38b000, #70e000);
  color: white;
  border-color: #28a745;
}

.lift-status.recovery {
  background: linear-gradient(to right, #f59e0b, #fbbf24);
  color: white;
  border-color: #f59e0b;
  animation: pulse 1.5s infinite;
}

.lift-status.emergency {
  background: linear-gradient(to right, #dc2626, #ef4444);
  color: white;
  border-color: #dc2626;
  animation: blink 1s infinite;
}

/* ✅ หน้า task */
.styled-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  .styled-table th, .styled-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
  }
  .status.success {
    color: #fff;
    background: #4CAF50;
    padding: 4px 8px;
    border-radius: 12px;
  }
  .status.error {
    color: #fff;
    background: #e53935;
    padding: 4px 8px;
    border-radius: 12px;
  }/* ✅ หน้า task */
  .blink {
    animation: blinker 1s linear infinite;
  }





/* ========================================================== */
/* === ✨ [FINAL FIX v2] TRAY INFO POPUP STYLES ✨ === */
/* ========================================================== */

/* --- 🎬 Animations (ของคุณ อยู่ครบเหมือนเดิม) --- */
@keyframes popIn {
  from { transform: translateY(20px) scale(0.95); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}
@keyframes popOut {
  from { transform: scale(1); opacity: 1; }
  to { transform: scale(0.95); opacity: 0; }
}
@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(15px); }
  to { opacity: 1; transform: translateY(0); }
}

/* --- 1. พื้นหลัง (Backdrop) --- */
.tray-popup-backdrop {
  position: fixed; top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(17, 24, 39, 0.6);
  backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
  z-index: 9999;
  opacity: 0;
  animation: fadeIn 0.3s ease-out forwards;
}
.tray-popup-backdrop.closing {
  animation: fadeOut 0.3s ease-in forwards;
}

/* --- 2. ตัวกล่อง Popup หลัก (Card) --- */
.tray-popup-card {
  background: #ffffff;
  border-radius: 24px;
  box-shadow: 0 20px 45px rgba(0,0,0,0.25);
  width: 90%;
  max-width: 450px;
  font-family: 'Prompt', sans-serif;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  max-height: 85vh;
  /* 🎬 Animation ของคุณ */
  transform: scale(0.95);
  opacity: 0;
  animation: popIn 0.4s 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
}
.tray-popup-card.closing {
  animation: popOut 0.3s ease-in forwards;
}

/* --- 3. ส่วนหัว (Header) [ไม่ scroll] --- */
.tray-popup-card .popup-header-premium {
  background: linear-gradient(145deg, #3b82f6, #2563eb);
  color: white;
  padding: 20px 25px;
  text-align: center;
  flex-shrink: 0; /* ✨ [เพิ่ม] ตรึงส่วนหัวไว้ ไม่ให้หด */
}
.tray-popup-card .popup-header-premium i {
  font-size: 2rem; margin-bottom: 10px; display: block;
}
.tray-popup-card .popup-header-premium h3 {
  font-size: 1.5em; font-weight: 600; margin: 0;
}

/* --- 4. ส่วนเนื้อหา (Info List) [⭐️⭐️⭐️ ส่วนนี้จะ Scroll] --- */
.tray-popup-card .info-list {
  padding: 20px 30px;
  display: flex;
  flex-direction: column;
  gap: 14px;
  overflow-y: auto;   /* ✨ [เพิ่ม] ทำให้ส่วนนี้ scroll ได้เมื่อยาว */
  flex-grow: 1;     /* ✨ [เพิ่ม] ทำให้ขยายเต็มพื้นที่ที่เหลือ */
}

/* --- 5. รายการข้อมูลและ Animation (ของคุณ อยู่ครบเหมือนเดิม) --- */
.tray-popup-card .info-item {
  display: flex; justify-content: space-between; align-items: center;
  font-size: 1em; padding-bottom: 14px; border-bottom: 1px solid #f3f4f6;
  opacity: 0;
  animation: fadeInUp 0.5s ease-out forwards; /* 🎬 Animation ของคุณ */
}
.tray-popup-card .info-item:last-child { border-bottom: none; padding-bottom: 0; }
/* 🎬 Staggered Animation ของคุณ */
.tray-popup-card .info-item:nth-child(1) { animation-delay: 0.2s; }
.tray-popup-card .info-item:nth-child(2) { animation-delay: 0.25s; }
.tray-popup-card .info-item:nth-child(3) { animation-delay: 0.3s; }
.tray-popup-card .info-item:nth-child(4) { animation-delay: 0.35s; }
.tray-popup-card .info-item:nth-child(5) { animation-delay: 0.4s; }
.tray-popup-card .info-item:nth-child(6) { animation-delay: 0.45s; }

.tray-popup-card .info-label {
  color: #4b5563; font-weight: 500; display: flex; align-items: center; gap: 10px;
}
.tray-popup-card .info-value {
  color: #111827; font-weight: 600; text-align: right;
}
.tray-popup-card .info-value.highlight {
  background: #e0f2fe; color: #0c4a6e; padding: 4px 10px; border-radius: 8px; font-weight: 700;
}

/* --- 6. ส่วนท้ายและปุ่มปิด (Footer) [ไม่ scroll] --- */
.tray-popup-card .close-button-wrapper {
  padding: 15px 30px;
  background-color: #f9fafb;
  border-top: 1px solid #e5e7eb;
  flex-shrink: 0; /* ✨ [เพิ่ม] ตรึงส่วนท้ายไว้ ไม่ให้หด */
}
.tray-popup-card .close-button {
  width: 100%; background: #4b5563; color: white;
  padding: 12px; font-size: 1em; font-weight: 600;
  border: none; border-radius: 12px; cursor: pointer;
  transition: all 0.3s ease; display: flex; align-items: center;
  justify-content: center; gap: 8px;
}
.tray-popup-card .close-button:hover {
  background: #374151; transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(75, 85, 99, 0.2);
}








/* ✅ ป้ายสถานะพรีเมียม */
.status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  font-size: 0.95em;
  padding: 4px 12px;
  border-radius: 20px;
  transition: 0.3s ease;
}
.status-due {
  background-color: #fff0f0;
  color: #e63946;
  border: 1px solid #e63946;
}
.status-due.blink {
  animation: blinkEffect 1s infinite;
}
.status-growing {
  background-color: #e9f5ec;
  color: #2d6a4f;
  border: 1px solid #2d6a4f;
}
.status i {
  font-size: 0.9em;
}

/* ✅ แถวเมื่อถึงวันเก็บเกี่ยว */
.harvest-due {
  background-color: #fff0f0 !important;
  transition: background-color 0.3s ease;
}

/* ✅ กล่องข้อมูลหลัก */
.card {
  background: linear-gradient(135deg, #ffffff, #f0fdf4);
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
  margin: 24px auto;
  max-width: 95%;
  font-family: 'Prompt', sans-serif;
  animation: fadeIn 0.5s ease-in-out;
}

h2 {
  font-size: 1.8rem;
  color: #1b4332;
  margin-bottom: 24px;
  display: flex;
  align-items: center;
  font-weight: 600;
}
h2 i {
  color: #40916c;
  margin-right: 10px;
  font-size: 1.4em;
}

/* ✅ ตารางสวยงาม */
.styled-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: #ffffff;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.styled-table thead {
  background-color: #2d6a4f;
}

.styled-table th,
.styled-table td {
  text-align: center;
  padding: 16px;
  font-size: 0.95em;
}

.styled-table th {
  color: #ffffff;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.styled-table td {
  color: #333;
  border-bottom: 1px solid #f3f3f3;
}

.styled-table tr:last-child td {
  border-bottom: none;
}

/* ✅ จุดสถานะสี */
.status-green::before,
.status-red::before {
  content: '\f111';
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  margin-right: 6px;
  font-size: 0.75em;
}
.status-green::before { color: #2d6a4f; }
.status-red::before { color: #e63946; }

/* ✅ บังคับแนวนอนแบบ Super Dev */
#plantingPagination {
  display: flex !important;
  flex-direction: row !important;
  justify-content: center !important;
  align-items: center;
  gap: 8px;
  margin-top: 24px;
  flex-wrap: wrap;
}

.pagination button {
  background: #e9f5ec;
  border: 1px solid #2d6a4f;
  border-radius: 10px;
  padding: 8px 16px;
  font-size: 0.9em;
  font-weight: 500;
  color: #2d6a4f;
  cursor: pointer;
  transition: 0.3s;
  min-width: 44px;

  /* ✅ เพิ่มบรรทัดนี้เพื่อแก้ปัญหา */
  width: auto;
  flex: 0 0 auto;
}

.pagination button.active,
.pagination button:hover {
  background: #2d6a4f;
  color: white;
  transform: scale(1.05);
}

/* ✅ ปุ่มคำสั่ง */
.action-buttons {
  display: flex;
  gap: 8px;
  justify-content: center;
  flex-wrap: wrap;
}

.action-buttons button {
  background-color: #52b788;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 10px;
  font-size: 0.85em;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  font-weight: 500;
}

.action-buttons button:hover {
  background-color: #40916c;
  transform: scale(1.04);
}




.toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #d1fae5; /* สีเขียวมิ้น */
  color: #065f46;
  padding: 16px 24px;
  border-radius: 12px;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  opacity: 0;
  transition: opacity 0.5s ease;
  z-index: 9999;
  pointer-events: none;
}

.toast.show {
  opacity: 1;
}
/* 🍿 Premium Log Cards Style */

.log-cards-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 24px;
  max-width: 1400px;
  margin: auto;
  margin-top: 30px;
}

.log-card {
  width: 320px;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  padding: 20px;
  font-family: 'Prompt', sans-serif;
  color: #1b4332;
  border: 1px solid #dde;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.log-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 28px rgba(0,0,0,0.15);
}

.log-card strong {
  color: #40916c;
}

.log-card .expand-btn {
  margin-top: 14px;
  padding: 10px 20px;
  border: none;
  background: linear-gradient(to right, #52b788, #40916c);
  color: white;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
  font-size: 0.95em;
  transition: 0.3s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.log-card .expand-btn:hover {
  background: linear-gradient(to right, #40916c, #2d6a4f);
  transform: translateY(-1px);
}

/* 🔍 Filter Form */
.user-logs-filters {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 24px;
  margin-bottom: 30px;
  padding: 10px 0;
}

.user-logs-filters label {
  font-weight: 600;
  color: #1b4332;
  margin-bottom: 6px;
  font-size: 0.95em;
  display: block;
}

.user-logs-filters input,
.user-logs-filters select {
  padding: 12px 16px;
  font-size: 1em;
  border-radius: 14px;
  border: 1px solid #ced4da;
  background: #ffffff;
  color: #1b4332;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  transition: border 0.2s ease, box-shadow 0.3s ease;
  min-width: 220px;
}

.user-logs-filters input:focus,
.user-logs-filters select:focus {
  outline: none;
  border-color: #52b788;
  box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.2);
}

.user-logs-filters button {
  padding: 14px 24px;
  background: linear-gradient(to right, #52b788, #40916c);
  border: none;
  border-radius: 14px;
  color: white;
  font-weight: bold;
  font-size: 1em;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.user-logs-filters button:hover {
  background: linear-gradient(to right, #40916c, #2d6a4f);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.15);
}

/* 📏 Pagination Premium */
#pagination {
  margin-top: 24px;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  padding: 10px;
}
#pagination button {
  min-width: 40px;
  height: 40px;
  padding: 8px 12px;
  border-radius: 10px;
  border: none;
  background: #e9f5ec;
  color: #1b4332;
  font-weight: bold;
  font-size: 1em;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

#pagination button:hover {
  background: #b7e4c7;
  transform: translateY(-1px);
}

#pagination .active {
  background: #40916c;
  color: white;
}




.manual-btn { /* ปุ่มขี้นลง */
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  font-size: 1rem;
  font-family: 'Prompt', sans-serif;
  background: linear-gradient(145deg, #2d6a4f, #40916c);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

 /* ปุ่มขี้นลง */
.manual-btn:hover {
  background: linear-gradient(145deg, #1b4332, #2d6a4f);
  transform: translateY(-2px);
}

 /* ปุ่มขี้นลง */
.manual-btn i {
  font-size: 1.2rem;
}

lift-container {
  position: relative;
  width: 200px;
  height: 600px;
  margin: 20px auto;
  border: 1px solid #ccc;
}

.lift-bg {
  width: 100%;
  height: 100%;
  display: block;
}

.lift-cart {
  position: absolute;
  left: 0;
  width: 100%;
  height: 60px;
  transition: top 1s ease;
  z-index: 10;
}

.sensor {
  position: absolute;
  left: 90%;
  width: 12px;
  height: 12px;
  background-color: gray;
  border-radius: 50%;
  z-index: 5;
  animation: blinkOff 1s infinite;
}







.video-overlay {
  background: none;
}

#loginVideo {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  z-index: -2;
  filter: brightness(1) blur(0.7px); /* ชัดขึ้น (brightness 1) */
}






.sidebar-header,
.sidebar-brand {
  padding: 10px 10px !important; /* 🔽 ลด padding บนลง */
  text-align: center;
}





.footer-illustration {
  width: 200px;           /* ขยายขึ้นจาก 140px → 200px */
  max-width: 90%;
  height: auto;
  display: block;
  margin: 30px auto 0;    /* ขยับลงนิดนึงให้นุ่มนวล */
}

.logo {
  width: 120px;
  height: auto;
  display: block;
  margin: 0 auto 20px;
  filter: drop-shadow(0 0 8px rgba(0,255,170,0.2)); /* แสงแบบเรืองนิดๆ */
}
.logo:hover {
  transform: scale(1.05);
}

.sidebar {
  width: 260px !important;
  height: 100vh;              /* ✅ ให้ความสูงเต็มหน้าจอ */
  overflow-y: auto;           /* ✅ ให้เลื่อนแนวตั้งเมื่อยาวเกิน */
  scroll-behavior: smooth;    /* ✅ เพิ่มความลื่นเวลา scroll */
  padding-bottom: 30px;       /* ✅ กัน footer ทับเมนูสุดท้าย */
}

.sidebar-logo {
  width: 140px;
  max-width: 100%;
  height: auto;
  margin: 10px auto;
  display: block;
  transition: transform 0.3s ease;
}
.sidebar-logo:hover {
  transform: scale(1.05);
}

.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal-box {
  background: white;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
  text-align: center;
  width: 300px;
  font-family: 'Prompt', sans-serif;
}

.modal-buttons {
  margin-top: 20px;
  display: flex;
  justify-content: space-around;
}

.modal-buttons button {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1em;
}

.modal-buttons button:first-child {
  background: #2d6a4f;
  color: white;
}

.modal-buttons button:last-child {
  background: #ccc;
  color: #333;
}
/* ✅ กล่องใส login อยู่กลางจอ */
.login-container {
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 20px;
  padding: 40px;
  width: 320px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.08);

  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;

  height: auto !important;      /* ✅ บังคับให้ไม่จดจำความสูงเก่า */
  min-height: 400px;            /* ✅ ความสูงขั้นต่ำตามหน้า Login */
  max-height: 100vh;            /* ป้องกันไม่ให้ยืดเกินจอ */
  transition: height 0.2s ease; /* ลื่นไหลเวลาสลับหน้า */
}


/* ✅ โลโก้บนสุด */
.login-container img {
  width: 140px;
  margin-bottom: 28px;
  filter: drop-shadow(0 0 10px rgba(0, 255, 170, 0.25));
  transition: transform 0.3s ease;
}
.login-container img:hover {
  transform: scale(1.05);
}

/* ✅ Input + icon */
.input-group {
  position: relative;
  margin-bottom: 20px;
}

.input-group i {
  position: absolute;
  top: 50%;
  left: 16px;
  transform: translateY(-50%);
  color: #52b788; /* เปลี่ยนเป็นสีเขียวมิ้น */
}

.input-group input {
  width: 100%;
  padding: 14px 14px 14px 44px;
  border-radius: 10px;
  border: none;
  background: rgba(255, 255, 255, 0.1);
  color: #52b788; /* เปลี่ยนข้อความในช่องให้เป็นสีเขียวมิ้น */
}

.input-group input::placeholder {
  color: #95d5b2; /* เขียวมิ้นอ่อน */
}

.input-group input:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(64, 145, 108, 0.4);
}

/* ✅ ปุ่ม Sign In */
.login-container button {
  background: linear-gradient(to right, #52b788, #40916c);
  border: none;
  padding: 14px;
  border-radius: 10px;
  color: white;
  font-weight: bold;
  width: 100%;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.login-container button:hover {
  transform: translateY(-2px);
}

/* ✅ ลิงก์สมัครสมาชิก */
.login-container a {
  color: white;
  font-size: 0.9em;
  display: block;
  margin-top: 20px;
  text-decoration: none;
}

.login-container a:hover {
  text-decoration: underline;
}
/* 💎 Polished & Animated Grid Style 💎 */

@keyframes grid-shimmer {
  0% { transform: translateX(-100%) skewX(-20deg); }
  100% { transform: translateX(2500px) skewX(-20deg); } /* 2500px ให้แสงวิ่งเลยขอบไปไกลๆ */
}

/* --- กรอบของตารางทั้งหมด --- */
.tray-grid {
  display: grid;
  gap: 12px;
  padding: 24px;
  background-color: #f8fafc; /* พื้นหลังสะอาดตา */
  border-radius: 18px;
  border: 1px solid #e2e8f0;
  position: relative;
  overflow: hidden; /* สำหรับ Animation */
}

/* --- แสงสแกน (Animation) --- */
.tray-grid::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 10%;
  height: 120%;
  background: linear-gradient(
    to right,
    transparent 0%,
    rgba(255, 255, 255, 0.5) 50%,
    transparent 100%
  );
  animation: grid-shimmer 15s linear infinite;
  pointer-events: none; /* ทำให้คลิกทะลุได้ */
}

/* --- หัวข้อ (ช่อง และ ชั้น) --- */
.tray-header-cell {
  font-weight: 600;
  text-align: center;
  padding: 10px 5px;
  font-size: 0.85em;
  color: #94a3b8; /* สีเทาอมน้ำเงิน */
}

/* --- สล็อต (ทั้งว่างและมีถาด) --- */
.tray-slot {
  border-radius: 10px;
  transition: all 0.25s ease-in-out;
  min-height: 70px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 8px;
  position: relative;
}

/* --- สล็อตว่าง --- */
.tray-slot.empty {
  background-color: #ffffff;
  border: 1px dashed #dce4f2; /* เส้นขอบแบบประ */
  cursor: default;
}
.empty-slot-coords {
    font-size: 0.9em;
    font-weight: 500;
    color: #e2e8f0;
}

/* --- สล็อตที่มีถาด --- */
.tray-slot.filled {
  background: linear-gradient(145deg, #3b82f6, #2563eb); /* โทนสีน้ำเงิน */
  color: white;
  border: 1px solid #1d4ed8;
  box-shadow: 0 6px 16px rgba(59, 130, 246, 0.2);
  cursor: pointer;
}

/* --- เอฟเฟกต์เมื่อเมาส์ชี้ --- */
.tray-slot:hover {
  transform: translateY(-4px) scale(1.03);
  box-shadow: 0 10px 25px rgba(148, 163, 184, 0.2);
}
.tray-slot.filled:hover {
  box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
}

/* --- สไตล์ของ Text ภายในสล็อต --- */
.filled-tray-icon {
  font-size: 1.4em;
  opacity: 0.8;
  margin-bottom: 4px;
}
.filled-tray-veg-name {
    font-size: 0.9em;
    font-weight: 600;
}
.filled-tray-id {
    font-size: 0.75em;
    font-weight: 400;
    background-color: rgba(255, 255, 255, 0.15);
    padding: 1px 5px;
    border-radius: 4px;
    margin-top: 2px;
}



body {
    font-family: 'Prompt', sans-serif;
    background: linear-gradient(to bottom right, #e9f5ec, #ffffff);
  }

.header {
  position: relative; /* ✅ ต้องมีเพื่อให้ absolute ของลูกทำงานถูกต้อง */
}

.user-wrapper {
  position: relative;
  display: inline-block;
  font-family: 'Poppins', sans-serif;
}

.user-dropdown {
  display: none;
  position: absolute;
  right: 0;
  top: 110%;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
  padding: 8px 0;
  min-width: 220px;
  z-index: 9999;
  font-family: 'Poppins', sans-serif;
  border: 1px solid #e0e0e0;
}

.user-menu {
  background-color: #f0f0f0;
  padding: 8px 12px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  color: #1b4332;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.user-dropdown .dropdown-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 20px;
  font-size: 1em;
  font-weight: 500;
  color: #1b4332;
  transition: all 0.2s ease;
  border-left: 4px solid transparent;
  cursor: pointer;
}

.user-dropdown .dropdown-item:hover {
  background-color: #e9f5ec;
  border-left: 4px solid #52b788;
  color: #1b4332;
}

.dropdown-item {
  padding: 8px 10px;
  cursor: pointer;
  border-radius: 8px;
  transition: background 0.2s ease;
}

.dropdown-item:hover {
  background-color: #f0f0f0;
}



.theme-toggle {
  padding: 10px 18px;
  background: linear-gradient(to right, #74c69d, #52b788);
  color: white;
  font-weight: bold;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-size: 1em;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
.theme-toggle:hover {
  background: linear-gradient(to right, #52b788, #40916c);
  transform: translateY(-1px);
}


.dropdown-item:hover {
  background: #e9f5ec;
}

#loginPage,
#dashboardPage {
  display: none;
}


#loginPage {
  background: none;
}



.link {
  margin-top: 16px;
  display: block;
  color: #1b4332;
  font-size: 0.9em;
  text-decoration: underline;
  cursor: pointer;
}

    #dashboardPage {
  display: flex;
  flex-direction: row;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
}

.footer-faint p {
  font-weight: 500;
  color: #333;         /* ชัดขึ้นจาก #6c757d */
}

.content {
  padding: 40px;
  overflow-y: auto;
  background: linear-gradient(to bottom, #e9f5ec, #ffffff);
  flex: 1; /* ✅ [แก้ไข] เพิ่มบรรทัดนี้เพื่อให้ขยายเต็มพื้นที่ที่เหลือ */
}
.footer-faint {
  margin-top: 60px;
  padding-top: 30px;
  text-align: center;
  opacity: 0.95;
  animation: fadeIn 0.8s ease;
  font-size: 1.1em;  /* 🔺 จากเดิม 0.9em */
  line-height: 1.7;  /* 🔁 เพื่อให้อ่านง่ายขึ้น */
}

.footer-agrotech {
  max-width: 220px;       /* 🔺 เพิ่มขนาด */
  margin-top: 25px;
  opacity: 1;
  transition: transform 0.3s ease;
}
.footer-agrotech:hover {
  transform: scale(1.05);  /* เพิ่ม interaction ตอน hover */
}




/* ✅ แต่ง dropdown menu หน้า Inbound */
.tray-form select {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #2d6a4f;              /* เปลี่ยนสีขอบเป็นเขียวพรีเมียม */
  border-radius: 12px;
  font-size: 1.05em;
  font-family: 'Prompt', sans-serif;
  background-color: #ffffff;              /* ฉากหลังสีขาว */
  color: #1b4332;                         /* ตัวอักษรสีเข้ม อ่านง่าย */
  appearance: none;                       /* ซ่อน dropdown ลูกศรแบบดั้งเดิม */
  background-image: url("data:image/svg+xml,%3Csvg fill='none' stroke='%232d6a4f' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  background-size: 16px 16px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); /* เงาอ่อนๆ */
  transition: all 0.3s ease;
}

.tray-form select:focus {
  border-color: #40916c;
  box-shadow: 0 0 0 3px rgba(64, 145, 108, 0.2);
  background-color: #f8fff8;
}

/* ✅ label ข้าง dropdown */
.tray-form label {
  font-weight: 600;
  margin-bottom: 8px;
  display: block;
  color: #1b4332;
  font-size: 0.95em;
  margin-top: 16px;
}

/* ✅ กำหนด layout โดยรวมของฟอร์ม */
.tray-form {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  margin-top: 20px;
}

/* ✅ กำหนดความกว้างของ input dropdown */
.tray-form > div {
  flex: 1 1 30%;
  min-width: 240px;
}
/* ✅ เเต่งโลโก้inborund */
.logo-top {
  text-align: center;
  margin-bottom: 20px;
}
/* ✅ เเต่งโลโก้outborun */
.logo-top img {
  max-width: 160px;
  height: auto;
  opacity: 0.9;
  filter: drop-shadow(0 0 3px rgba(0,0,0,0.1));
}




.inbound-btn {
  background: linear-gradient(to right, #95d5b2, #74c69d);
  color: white;
  font-size: 1.2em;
  font-weight: 600;
  padding: 16px 28px;
  border-radius: 20px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 600px;
  display: block;
  margin: 30px auto 10px auto;
}
.inbound-btn:hover {
  transform: translateY(-3px);
  background: linear-gradient(to right, #74c69d, #52b788);
}

.outbound-btn {
  background: linear-gradient(to right, #f87171, #ef4444);
  color: white;
  font-size: 1.2em;
  font-weight: 600;
  padding: 16px 28px;
  border-radius: 20px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 600px;
  display: block;
  margin: 30px auto 10px auto;
}
.outbound-btn:hover {
  transform: translateY(-3px);
  background: linear-gradient(to right, #ef4444, #dc2626);
}

.inbound-title,
.outbound-title {
  text-align: center;
  font-size: 2em;
  font-weight: bold;
  margin-bottom: 10px;
  color: #1b4332;
}

.inbound-desc {
  color: #6c757d;
  text-align: center;
  margin-bottom: 30px;
  font-size: 1em;
}

/* ✅ ป้องกันพื้นหลังวิดีโอโผล่ */
html, body, #app {
  height: 100%;
  margin: 0;
  padding: 0;
}

/* ✅ ให้หน้า inbound/outbound เต็มความสูง */
.inbound-page, .outbound-page {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-height: 100vh;
  padding: 40px 20px;
  background: linear-gradient(to bottom, #e9f5ee, #fefefe);
}




/* ✅ คำเตือนเด่นชัด */
.warning-message {
  background: #fff5f5;
  color: #dc2626;
  border-left: 6px solid #dc2626;
  padding: 12px 20px;
  font-weight: bold;
  font-size: 0.95em;
  margin-top: 20px;
  border-radius: 12px;
  text-align: center;
  max-width: 700px;
  margin-left: auto;
  margin-right: auto;
}


    * {
      box-sizing: border-box;
      transition: 0.3s ease;
    }
    /* 💡 Default: Light Mode */
    body {
  margin: 0;
  padding: 0;
  font-family: 'Prompt', sans-serif;
  background-size: cover;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
.sidebar {
  width: 260px;
  background: #ffffff;
  border-right: 1px solid #cce3d1;
  display: flex;
  flex-direction: column;
  padding: 25px 0;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.04);
  animation: slideInLeft 0.5s ease-out;
}

.sidebar img {
  width: 120px;
  margin: 0 auto 10px;
  transition: transform 0.3s ease;
}
.sidebar img:hover {
  transform: scale(1.1);
}

.sidebar h2 {
  text-align: center;
  color: #2d6a4f;
  margin: 10px 0 0;
  font-weight: 700;
}
.sidebar small {
  color: #6c757d;
  text-align: center;
  display: block;
}
.sidebar a {
  padding: 14px 30px;
  color: #1b4332;
  text-decoration: none;
  font-size: 1.1em;
  display: flex;
  align-items: center;
  border-left: 4px solid transparent;
}
.sidebar a:hover,
.sidebar a.active {
  background: #e9f5ec;
  border-left: 4px solid #52b788;
}
.sidebar a i {
  margin-right: 12px;
  font-size: 1.3em;
}

.main {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 100vh;
}



.content {
  padding: 40px;
  overflow-y: auto;
  background: linear-gradient(to bottom, #e9f5ec, #ffffff);
}

.section {
  background: #ffffff;
  padding: 35px;
  border-radius: 18px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
  margin-bottom: 40px;
  animation: fadeInUp 0.5s ease;
}
.section h2 {
  color: #1b4332;
  margin-bottom: 20px;
  font-size: 1.4em;
}

select,
button {
  padding: 14px;
  font-size: 1em;
  border-radius: 12px;
  border: 1px solid #ccc;
  margin-bottom: 18px;
  width: 100%;
  background-color: #f8f9fa;
  color: #1b4332;
}

button {
  width: 100%;
  padding: 12px;
  background: #52b788;
  color: white;
  font-weight: bold;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  margin-top: 10px;
  transition: background 0.3s ease;
}

button:hover {
  background: #40916c;
}

.message {
  display: none;
  padding: 14px;
  border-radius: 10px;
  margin-top: 10px;
  font-weight: 600;
  text-align: center;
}
.success {
  background: #d1fae5;
  color: #065f46;
}
.error {
  background: #fee2e2;
  color: #991b1b;
}
/* ✅ Confirm Modal Styling */
.confirm-backdrop {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  animation: fadeIn 0.3s ease;
}

.confirm-box {
  background: #ffffff;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
  text-align: center;
  width: 300px;
  animation: fadeInUp 0.3s ease;
}

.confirm-box h3 {
  margin-bottom: 20px;
  color: #1b4332;
}

.button-group {
  display: flex;
  justify-content: space-between;
}

.confirm-box button {
  padding: 10px 20px;
  font-size: 1em;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  transition: 0.3s;
}

.confirm-box button:first-child {
  background: #52b788;
  color: white;
}
.confirm-box button:first-child:hover {
  background: #40916c;
}
.confirm-box button:last-child {
  background: #ccc;
  color: black;
}
.confirm-box button:last-child:hover {
  background: #aaa;
}

/* 🌙 Dark Mode Overrides */
body.dark-mode {
  background: linear-gradient(135deg, #121212, #1e1e1e);
  color: #f1f1f1;
}
body.dark-mode .sidebar {
  background: #1f1f1f;
  border-right: 1px solid #333;
  color: #e0e0e0;
}
body.dark-mode .sidebar h2 {
  color: #90ee90;
}
body.dark-mode .sidebar small {
  color: #aaa;
}
body.dark-mode .sidebar a {
  color: #e0e0e0;
}
body.dark-mode .sidebar a:hover,
body.dark-mode .sidebar a.active {
  background: #2d2d2d;
  border-left: 4px solid #52b788;
  color: #90ee90;
}
body.dark-mode .header {
  background: #1c1c1c;
  color: #90ee90;
  border-bottom: 1px solid #2a2a2a;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}
body.dark-mode .content {
  background: #2a2a2a;
}
body.dark-mode .section {
  background: #333;
  color: #f1f1f1;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
}
body.dark-mode select,
body.dark-mode button {
  background-color: #1c1c1c;
  color: #f1f1f1;
  border: 1px solid #555;
}
body.dark-mode .success {
  background: #1d402c;
  color: #90ee90;
}
body.dark-mode .error {
  background: #402020;
  color: #ff6b6b;
}
/* ✅ Dark mode override for Confirm Modal */
body.dark-mode .confirm-box {
  background: #2a2a2a;
  color: #f1f1f1;
}
body.dark-mode .confirm-box h3 {
  color: #f1f1f1;
}
body.dark-mode .confirm-box button:first-child {
  background: #40916c;
}
body.dark-mode .confirm-box button:last-child {
  background: #555;
  color: white;
}
.tab-button {
  background: transparent;
  border: none;
  font-size: 1.2em;
  padding: 12px 24px;
  cursor: pointer;
  color: #1b4332;
  border-bottom: 3px solid transparent;
  font-weight: bold;
  transition: 0.2s ease;
}
.tab-button.active {
  border-bottom: 3px solid #52b788;
  color: #52b788;
}
.tab-button:hover {
  background-color: #e9f5ec;
  border-radius: 8px 8px 0 0;
}


/* 🌀 Animations */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
@keyframes slideInLeft {
  from {
    transform: translateX(-100%);
  }
  to {
    transform: translateX(0);
  }
}

@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}
@media screen and (max-width: 768px) {
  .login-container {
    width: 90%;
  }
}


@keyframes blinkOn {
  0%, 100% { background-color: green; }
  50% { background-color: white; }
}

@keyframes blinkOff {
  0%, 100% { background-color: gray; }
}


@keyframes blinkEffect {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.2; }
}


  @keyframes blinker {
    50% { opacity: 0.4; }
  }



  @keyframes blink {
  0%, 100% { background-color: #b91c1c; }
  50% { background-color: #ef4444; }
}
@keyframes pulse {
  0%, 100% { background-color: #f59e0b; }
  50% { background-color: #fbbf24; }
  
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.03); }
}


/* ======================================================== */
/* === ✨ FINAL RESPONSIVE STYLES (for Mobile & Tablet) ✨ === */
/* ======================================================== */

/* --- 1. Universal Reset & Debug --- */
/* บังคับให้ทุกอย่างคำนวณขนาดแบบไม่ล้น และตัดคำยาวๆ */
* {
    box-sizing: border-box;
    word-break: break-word; /* ⭐️⭐️⭐️ สำคัญมาก: ตัดคำยาวๆ ไม่ให้ล้นจอ */
}

/* --- 2. Hamburger Menu --- */
/* ซ่อนปุ่มบนจอใหญ่ */
#hamburger-menu {
    display: none;
    background: transparent;
    border: 1px solid #d1d5db;
    font-size: 1.1rem;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    color: #1b4332;
    margin-right: 1rem;
    z-index: 1002;
}

/* --- 3. Tablet View (<= 1024px) --- */
/* จุดนี้จะเริ่มซ่อน Sidebar */
@media (max-width: 1024px) {
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100%;
        transform: translateX(-100%);
        z-index: 1001;
        transition: transform 0.3s ease-out;
        box-shadow: 5px 0 25px rgba(0,0,0,0.1);
    }
    .sidebar.show {
        transform: translateX(0);
    }
    .main {
        margin-left: 0;
        width: 100%; /* ทำให้ Main Content กว้างเต็มจอเสมอ */
    }
    #hamburger-menu {
        display: block; /* แสดงปุ่มเมนู */
    }

    /* ✨ [เพิ่มส่วนนี้] แก้ไข Header สำหรับ Tablet ✨ */
    .dashboard-title h1 {
        font-size: 1.8rem; /* ลดขนาดฟอนต์ลง */
    }
    .header-left {
        gap: 1rem; /* ลดระยะห่างระหว่างโลโก้กับชื่อ */
    }
}
/* เพิ่มเข้าไปในส่วน CSS ของคุณ (นอก @media query) */
.table-responsive-wrapper {
    width: 100%;
    overflow-x: auto; /* ⭐️ ทำให้ scroll แนวนอนได้ */
    -webkit-overflow-scrolling: touch; /* ทำให้ลื่นบน iOS */
    border: 1px solid #e2e8f0;
    border-radius: 16px; /* ทำให้ขอบมนสวยงาม */
}

/* กำหนดความกว้างขั้นต่ำให้ตารางข้างใน */
.table-responsive-wrapper .styled-table {
    min-width: 800px; /* ⭐️ ความกว้างขั้นต่ำของตาราง */
    border: none; /* เอา border ของตารางออก เพราะ wrapper มีแล้ว */
}
/* --- 4. Mobile View (<= 768px) --- */
/* จุดนี้จะเริ่มปรับ Layout หลักๆ ให้เป็นแนวตั้ง */
@media (max-width: 768px) {
    /* ทำให้ Header ไม่เบียดกัน - คืนสู่ layout เดิม */
    .header {
        padding: 1rem;
        flex-wrap: wrap; /* อนุญาตให้ปุ่มขึ้นบรรทัดใหม่ */
    }
    .header-left, .header-right {
        gap: 1rem;
    }
    .dashboard-title h1 {
        font-size: 1.5rem;
        white-space: normal; /* ⭐️⭐️⭐️ สำคัญมาก: อนุญาตให้ตัดคำได้ */
    }

    /* จัดเรียง Cards และ Grid ต่างๆ เป็น 1 คอลัมน์ */
    .summary-cards-new,
    .overview-grid-new,
    .user-stats,
    .user-grid,
    .form-grid,
    .env-grid-new,
    .main-buttons,
    .camera-section {
        grid-template-columns: 1fr !important; /* ⭐️ สำคัญ: บังคับ 1 คอลัมน์ */
    }
    .search-filter-section, .header-top {
        flex-direction: column;
        align-items: stretch;
    }

    /* ลดขนาด Padding เพื่อเพิ่มพื้นที่ */
    .content, .section, .overview-card-new, .form-container-deluxe, .user-management-page {
        padding: 1rem;
    }
    .summary-card-new {
        padding: 1.25rem;
    }

    /* ป้องกันตารางล้นจอ โดยการเพิ่ม scroll แนวนอน */
    .user-table-container, .table-responsive, [style*="overflow-x:auto"] {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .styled-table {
        min-width: 600px; /* กำหนดความกว้างขั้นต่ำให้ตาราง เพื่อให้ scroll ได้ */
    }
}

/* --- 5. Fine-tuning for Small Phones (<= 480px) --- */
/* ปรับแก้รายละเอียดสำหรับจอที่แคบมากๆ */
@media (max-width: 480px) {
    .header {
        padding: 0.75rem;
    }
    
    .dashboard-title h1 {
        font-size: 1.1rem;
        line-height: 1.2;
    }
    
    .dashboard-icon {
        width: 32px;
        height: 32px;
    }
    
    .station-dropdown, .user-menu {
        font-size: 0.85rem;
        padding: 8px 12px;
        min-width: 100px;
    }
    
    .header-left, .header-right {
        flex-wrap: wrap;
        justify-content: center;
    }

    /* ปรับ Layout ของ Summary Card ให้เหมาะกับจอเล็กสุดๆ */
    .summary-card-new {
        flex-direction: row;
        align-items: center;
    }
    .card-value-new {
        font-size: 1.8rem;
    }

    /* ลดขนาดหัวข้อในการ์ดต่างๆ */
    .card-title-new h3, .form-title {
        font-size: 1.2rem;
    }
}

  </style>
  
</head>

<body>



<div class="timer-modal-backdrop" id="batchScheduleModal">
    <div class="timer-modal-content" style="max-width: 1200px;">
        <h3 class="modal-title">ตั้งเวลาเปิด-ปิด LED & FAN ทั้งหมด</h3>
        <p style="color: #64748b; margin-bottom: 20px;">ตั้งค่าเวลาสำหรับอุปกรณ์แต่ละชิ้นในแต่ละชั้น</p>
        <div id="batchScheduleForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            </div>
        <div class="timer-modal-actions" style="margin-top: 30px;">
            <button class="modal-btn cancel" onclick="closeBatchScheduleModal()">ยกเลิก</button>
            <button class="modal-btn save is-on" onclick="saveBatchSchedules()">บันทึกทั้งหมด</button>
        </div>
    </div>
</div>





<!-- ✅ Popup แจ้งเตือน -->
<div id="trayPopup" style="
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: #52b788;
  color: white;
  padding: 16px 26px;
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  font-size: 1.1em;
  font-weight: 600;
  z-index: 9999;
  display: none;
  animation: fadeInUp 0.3s ease;
">
  ✅ แจ้งเตือน
</div>


<!-- ✅ popup excel task history  -->
<div class="popup-overlay" id="exportDateModal" style="display: none;">
  <div class="popup-container" style="max-width: 480px;">
    <div class="popup-header">
      <h2 class="popup-title"><i class="fas fa-calendar-alt icon"></i> เลือกช่วงข้อมูลสำหรับ Export</h2>
    </div>

    <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 15px;">
      
      <label style="display: block; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; cursor: pointer;">
        <input type="radio" name="exportRange" value="all" checked onchange="toggleDateInputs()"> <strong>ข้อมูลทั้งหมด</strong>
      </label>
      <label style="display: block; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; cursor: pointer;">
        <input type="radio" name="exportRange" value="today" onchange="toggleDateInputs()"> <strong>เฉพาะข้อมูลวันนี้</strong>
      </label>
      <label style="display: block; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; cursor: pointer;">
        <input type="radio" name="exportRange" value="range" onchange="toggleDateInputs()"> <strong>เลือกช่วงวันที่เอง</strong>
      </label>

      <div id="dateRangePicker" style="display: none; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center; margin-top: 10px; padding: 15px; background: #f8fafc; border-radius: 8px;">
        <div>
            <label for="startDate" style="font-weight: 500; font-size: 0.9em;">วันที่เริ่มต้น:</label>
            <input type="date" id="startDate" class="form-input-deluxe" style="padding: 10px;">
        </div>
        <div>
            <label for="endDate" style="font-weight: 500; font-size: 0.9em;">วันที่สิ้นสุด:</label>
            <input type="date" id="endDate" class="form-input-deluxe" style="padding: 10px;">
        </div>
      </div>
    </div>

    <div class="popup-actions">
        <button class="popup-button cancel" onclick="closeExportModal()">ยกเลิก</button>
        <button class="popup-button confirm" onclick="initiateExport()">ยืนยันและดาวน์โหลด</button>
    </div>
  </div>
</div>







 <!-- ✅ popup Returun Workstation  -->
<div class="popup-overlay" id="returnTrayModal" style="display: none;">
  <div class="popup-container" style="max-width: 650px;">
    <div class="popup-header">
      <h2 class="popup-title"><i class="fas fa-arrow-left icon"></i> ส่งถาดกลับเข้าคลัง</h2>
    </div>

    <div style="margin-top: 15px; margin-bottom: 25px;">
        <h3 style="font-weight: 600; color: #4B5563; border-bottom: 1px solid #E5E7EB; padding-bottom: 10px; margin-bottom: 20px;">
          <i class="fas fa-edit" style="margin-right: 8px; color: #6B7280;"></i>
          แก้ไขข้อมูลถาด (ถ้าต้องการ)
        </h3>
        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="returnVegType">ชนิดผัก (ไม่สามารถแก้ไขได้)</label>
                <input type="text" id="returnVegType" class="form-input-deluxe" readonly style="background-color: #e9ecef; cursor: not-allowed;">
            </div>
            <div class="form-group">
                <label for="returnPlantQuantity">จำนวนต้น</label>
                <input type="number" id="returnPlantQuantity" class="form-input-deluxe" placeholder="เช่น 16">
            </div>
            <div class="form-group">
                <label for="returnBatchId">Batch ID (ไม่สามารถแก้ไขได้)</label>
                <input type="text" id="returnBatchId" class="form-input-deluxe" readonly style="background-color: #e9ecef; cursor: not-allowed;">
            </div>
             <div class="form-group">
                <label for="returnSeedingDate">วันที่เพาะเมล็ด</label>
                <input type="date" id="returnSeedingDate" class="form-input-deluxe">
            </div>
            <div class="form-group full-width">
                <label for="returnNotes">หมายเหตุ</label>
                <textarea id="returnNotes" class="form-input-deluxe" rows="2" placeholder="เพิ่มหมายเหตุ..."></textarea>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 25px;">
        <h3 style="font-weight: 600; color: #4B5563; border-bottom: 1px solid #E5E7EB; padding-bottom: 10px; margin-bottom: 20px;">
          <i class="fas fa-map-marker-alt" style="margin-right: 8px; color: #6B7280;"></i>
          เลือกตำแหน่งใหม่
        </h3>
        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="returnFloor">ชั้นใหม่</label>
                <select id="returnFloor" class="form-input-deluxe">
                    <option value="1">ชั้น 1</option>
                    <option value="2">ชั้น 2</option>
                    <option value="3">ชั้น 3</option>
                    <option value="4">ชั้น 4</option>
                    <option value="5">ชั้น 5</option>
                    <option value="6">ชั้น 6</option>
                    <option value="7">ชั้น 7</option>
                    <option value="8">ชั้น 8</option>
                    <option value="9">ชั้น 9</option>
                </select>
            </div>
            <div class="form-group">
                <label for="returnSlot">ช่องใหม่</label>
                 <select id="returnSlot" class="form-input-deluxe">
                    <option value="1">ช่อง 1</option><option value="2">ช่อง 2</option><option value="3">ช่อง 3</option>
                    <option value="4">ช่อง 4</option><option value="5">ช่อง 5</option><option value="6">ช่อง 6</option>
                    <option value="7">ช่อง 7</option><option value="8">ช่อง 8</option><option value="9">ช่อง 9</option>
                    <option value="10">ช่อง 10</option><option value="11">ช่อง 11</option><option value="12">ช่อง 12</option>
                    <option value="13">ช่อง 13</option><option value="14">ช่อง 14</option><option value="15">ช่อง 15</option>
                    <option value="16">ช่อง 16</option><option value="17">ช่อง 17</option><option value="18">ช่อง 18</option>
                    <option value="19">ช่อง 19</option><option value="20">ช่อง 20</option>
                </select>
            </div>
        </div>
    </div>

    <div class="popup-actions">
        <button class="popup-button cancel" onclick="closeReturnModal()">ยกเลิก</button>
        <button class="popup-button confirm" onclick="">ยืนยัน</button>
    </div>
  </div>
</div>



 <!-- ✅ popup Tray Master-->
<div class="popup-overlay" id="editTrayModal" style="display: none;">
  <div class="popup-container">
    <div class="popup-header">
      <h2 class="popup-title"><i class="fas fa-edit icon"></i> แก้ไขข้อมูลถาด</h2>
    </div>
    <div class="form-grid" style="grid-template-columns: 1fr;">
        <input type="hidden" id="editTrayId">
        <div class="form-group"><label>ชนิดผัก</label><input type="text" id="editVegType" class="form-input-deluxe"></div>
        <div class="form-group"><label>จำนวนต้น</label><input type="number" id="editPlantQuantity" class="form-input-deluxe"></div>
        <div class="form-group"><label>Batch ID</label><input type="text" id="editBatchId" class="form-input-deluxe"></div>
        <div class="form-group"><label>วันที่เพาะเมล็ด</label><input type="date" id="editSeedingDate" class="form-input-deluxe"></div>
        <div class="form-group"><label>หมายเหตุ</label><textarea id="editNotes" class="form-input-deluxe" rows="3"></textarea></div>
    </div>
    <div class="popup-actions">
        <button class="popup-button cancel" onclick="closeEditModal()">ยกเลิก</button>
        <button class="popup-button confirm" onclick="handleUpdateTray()">บันทึกการเปลี่ยนแปลง</button>
    </div>
  </div>
</div>




  <!-- ✅ popup tray inventroy-->
  <div id="trayInfoPopup" class="tray-popup-backdrop" style="display: none;">
  <div class="tray-popup-card">
    <h3><i class="fas fa-boxes"></i> ข้อมูลถาด</h3>
    <div id="trayInfoContent"></div>
    <button onclick="closeTrayInfoPopup()"><i class="fas fa-times-circle"></i> ปิด</button>
  </div>
</div>

 
 <div id="toast" class="toast"></div>


 
  <!-- ✅ พื้นหลัง ai -->
  <video autoplay muted loop id="loginVideo" playsinline>
    <source src="vidu-video-2763632902164823.mp4" type="video/mp4">
  </video>


  

<div id="loginPage" class="login-container">
  <img src="agrotech-logo.png" class="logo" />
  <div class="form-box">
    <div class="input-group">
      <i class="fas fa-user"></i>
      <input type="text" id="username" placeholder="ชื่อผู้ใช้" 
             aria-label="ชื่อผู้ใช้" aria-required="true" autocomplete="username" tabindex="1" />
    </div>
    <div class="input-group">
      <i class="fas fa-key"></i>
      <input type="password" id="password" placeholder="รหัสผ่าน" 
             aria-label="รหัสผ่าน" aria-required="true" autocomplete="current-password" tabindex="2" />
    </div>
    <button onclick="login()" aria-describedby="loginMsg" tabindex="3">Sign In</button>
    <div id="loginMsg" class="message"></div>
  </div>
</div>

</div>


<!-- ✅ Modal เปลี่ยนรหัสผ่าน -->
<div id="changeBox" class="confirm-backdrop" style="display: none;">
  <div class="confirm-box" style="
    max-width: 400px;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    background: #ffffff;
    text-align: center;
    font-family: 'Prompt', sans-serif;
  ">
    <h3 style="font-size: 1.6em; color: #1b4332; display: flex; justify-content: center; align-items: center; gap: 10px;">
      <i class="fa-solid fa-key"></i> เปลี่ยนรหัสผ่าน
    </h3>

    <div style="display: flex; flex-direction: column; gap: 16px; margin-top: 25px;">
      <input id="changeUser" type="text" placeholder="ชื่อผู้ใช้เดิม" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
      <input id="oldPass" type="password" placeholder="รหัสผ่านเดิม" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
      <input id="newPass" type="password" placeholder="รหัสผ่านใหม่" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
    </div>

    <div class="button-group" style="margin-top: 30px; display: flex; gap: 16px; justify-content: center;">
      <button onclick="changePassword()" style="
        padding: 12px 24px;
        background: #52b788;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#40916c'" onmouseout="this.style.background='#52b788'">
        💾 บันทึกรหัสใหม่
      </button>
      <button onclick="closeChangePassword()" style="
        padding: 12px 24px;
        background: #e2e8f0;
        color: #333;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#cbd5e1'" onmouseout="this.style.background='#e2e8f0'">
        ยกเลิก
      </button>
    </div>

    <div id="changeMsg" class="message" style="
      margin-top: 20px;
      font-weight: 500;
      color: #991b1b;
      display: none;
    "></div>
  </div>
</div>


<!-- ✅ Dete USENAME -->
<div id="deleteBox" class="confirm-backdrop" style="display: none;">
  <div class="confirm-box" style="
    max-width: 400px;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    background: #ffffff;
    text-align: center;
    font-family: 'Prompt', sans-serif;
  ">
    <h3 style="font-size: 1.6em; color: #1b4332; display: flex; justify-content: center; align-items: center; gap: 10px;">
      <i class="fa-solid fa-user-slash"></i> ลบบัญชีผู้ใช้
    </h3>

    <p style="margin: 18px 0 25px; color: #555; font-size: 0.95em;">
      โปรดยืนยันชื่อผู้ใช้และรหัสผ่านก่อนลบบัญชีนี้ ข้อมูลทั้งหมดจะไม่สามารถกู้คืนได้
    </p>

    <div style="display: flex; flex-direction: column; gap: 16px;">
      <input id="deleteUser" type="text" placeholder="ชื่อผู้ใช้" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
      <input id="deletePass" type="password" placeholder="รหัสผ่าน" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
    </div>

    <div class="button-group" style="margin-top: 30px; display: flex; gap: 16px; justify-content: center;">
      <button onclick="deleteAccount()" style="
        padding: 12px 24px;
        background: #e63946;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#e63946'">
        ❌ ลบบัญชีนี้
      </button>
      <button onclick="closeDeleteBox()" style="
        padding: 12px 24px;
        background: #e2e8f0;
        color: #333;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#cbd5e1'" onmouseout="this.style.background='#e2e8f0'">
        ยกเลิก
      </button>
    </div>

    <div id="deleteMsg" class="message" style="
      margin-top: 20px;
      font-weight: 500;
      color: #991b1b;
      display: none;
    "></div>
  </div>
</div>


<!-- Logout Confirmation Modal -->
<div id="logoutBox" class="modal-overlay" style="display: none;">
  <div class="modal-box">
    <h3>คุณต้องการออกจากระบบหรือไม่?</h3>
    <div class="modal-buttons">
      <button onclick="confirmLogout()">ยืนยัน</button>
      <button onclick="closeLogoutBox()">ยกเลิก</button>
    </div>
  </div>
</div>





<!-- ✅ CONFIRM MODAL -->
<div id="confirmModal" class="confirm-backdrop" style="display:none;">
  <div class="confirm-box">
    <h3 id="confirmText">คุณแน่ใจหรือไม่?</h3>
    <div class="button-group">
      <button onclick="confirmAction(true)">ยืนยัน</button>
      <button onclick="confirmAction(false)">ยกเลิก</button>
    </div>
  </div>
</div>






<!-- ✅ DASHBOARD PAGE -->
<div id="dashboardPage" style="display: none; flex-direction: row; width: 100vw; height: 100vh;">

  <!-- Mobile Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="agrotech-logo.png" alt="Logo" class="sidebar-logo">
    </div>

    <!-- ✅ เพิ่ม data-page และลบ class="active" ยกเว้นหน้าแรก -->
    <a href="#" data-page="overview" class="active" onclick="showPage('overview', event)"><i class="fas fa-home"></i> Overview</a>
    <a href="#" data-page="lift" onclick="showPage('lift', event)"><i class="fas fa-arrow-up-wide-short"></i> Lift Control</a>
    <a href="#" data-page="agv" onclick="showPage('agv', event)"><i class="fas fa-truck-moving"></i> RGV Control</a>
    <a href="#" data-page="light-control" onclick="showPage('light-control', event)"><i class="fas fa-lightbulb"></i> Light Control </a>
    <a href="#" data-page="tray-inbound" onclick="showPage('tray-inbound', event)"><i class="fas fa-arrow-down"></i> Tray Inbound</a>
    <a href="#" data-page="tray-outbound" onclick="showPage('tray-outbound', event)"><i class="fas fa-arrow-up"></i> Tray Outbound</a>
    <a href="#" data-page="workstation" onclick="showPage('workstation', event)"><i class="fas fa-dolly"></i> Workstation</a>
    <a href="#" data-page="tray-master" onclick="showPage('tray-master', event)"><i class="fas fa-database"></i> Tray Master</a>
    <a href="#" data-page="task" onclick="showPage('task', event)"><i class="fas fa-tasks"></i> Task Monitor</a>
    <a href="#" data-page="task-history" onclick="showPage('task-history', event)"><i class="fas fa-clipboard-list"></i> Task History</a>
    <a href="#" data-page="system" onclick="showPage('system', event)"><i class="fas fa-chart-line"></i> System Monitor</a>
    <a href="#" data-page="tray-map" onclick="showPage('tray-map', event)"><i class="fas fa-boxes"></i> Tray Inventory</a>
    <a href="#" data-page="environment" onclick="showPage('environment', event)"><i class="fas fa-chart-line"></i> Environmental</a>
    <a href="#" data-page="planting-plan" onclick="showPage('planting-plan', event)"><i class="fas fa-leaf"></i> Planting Plan</a>
    <a href="#" data-page="planting-history" onclick="showPage('planting-history', event)"><i class="fas fa-book"></i> Planting History</a>
    <a href="#" data-page="user-logs" onclick="showPage('user-logs', event)"><i class="fas fa-terminal"></i> User Activity Log</a>
    <a href="#" data-page="user-management" onclick="showPage('user-management', event)"><i class="fas fa-users-cog"></i> User Management</a>
   <a href="#" data-page="MonitorSensor" onclick="showPage('MonitorSensor', event)"><i class="fas fa-microchip"></i> MonitorSensor</a>

  </div>


  <!-- Main -->
<div class="main">
 <div class="header">
    <div class="header-left">
          <button id="hamburger-menu">
        <i class="fas fa-bars"></i>
    </button>
        <div class="dashboard-title">
            <img src="wms-dashboard-icon.png" alt="WMS Icon" class="dashboard-icon">
            <h1>PFAL WMS Dashboard</h1>
        </div>
        <select id="stationSelect" onchange="onStationChange()" class="station-dropdown">
            <option value="1">Station 1</option>
            <option value="2">Station 2</option>
            <option value="3">Station 3</option>
            <option value="4">Station 4</option>
            <option value="5">Station 5</option>
        </select>
    </div>

    <div class="header-right">
        <div class="user-wrapper" id="userWrapper">
            <div class="user-menu" id="currentUser">
                <i class="fas fa-user"></i>
                <span id="usernameDisplay">IT</span> <i class="fas fa-caret-down" style="font-size: 0.8em; margin-left: 4px;"></i>
            </div>
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-item" id="toggleTheme"><i class="fas fa-moon"></i> <span>Dark Mode</span></div>
                <div class="dropdown-item" onclick="showChangePassword()"><i class="fas fa-key"></i> <span>เปลี่ยนรหัสผ่าน</span></div>
                <div class="dropdown-item" onclick="showDeleteBox()"><i class="fas fa-user-slash"></i> <span>ลบบัญชีผู้ใช้</span></div>
                <div class="dropdown-item" onclick="showLogoutBox()"><i class="fas fa-sign-out-alt"></i> <span>ออกจากระบบ</span></div>
            </div>
        </div>
    </div>
</div>


  <!-- ✅ Content Area for each page (loaded dynamically) -->
  <div class="content" id="mainContent"></div>
</div> <!-- ✅ END of dashboardPage -->






<script>



/* ================================================================================================
   💾 JAVASCRIPT - AGROTECH WMS APPLICATION
   ================================================================================================
   
   📋 TABLE OF CONTENTS:
   ────────────────────────────────────────────────────────────────────────────────────────────
   1. 🔧 GLOBAL VARIABLES & CONFIGURATION
   2. 🚀 PERFORMANCE & OPTIMIZATION FUNCTIONS
   3. 📄 PAGE RENDERING FUNCTIONS
   4. 📊 DASHBOARD & OVERVIEW FUNCTIONS
   5. 🎛️ CONTROL SYSTEM FUNCTIONS
   6. 📹 CAMERA & MONITORING FUNCTIONS
   7. 📈 CHART & VISUALIZATION FUNCTIONS
   8. 🔐 AUTHENTICATION & USER MANAGEMENT
   9. 📱 EVENT HANDLERS & UI INTERACTIONS
   10. 🌐 API & DATA MANAGEMENT
   ================================================================================================ */

/* ================================================================================================
   1. 🔧 GLOBAL VARIABLES & CONFIGURATION
   ================================================================================================ */

let currentStation = 1; // 🟢 กำหนดค่า default

let currentPage = 'overview'; // ใช้สำหรับ showPage()
let pieChartInstance = null;
let barChartInstance = null;
let hourlyChartInstance = null;
let activeTimers = []; // เก็บ ID ของ Interval ทั้งหมดที่ทำงานอยู่

// Performance optimization globals
const apiCache = new Map();
const domCache = new Map();
let requestQueue = new Map();

/* ================================================================================================
   2. 🚀 PERFORMANCE & OPTIMIZATION FUNCTIONS
   ================================================================================================ */

// 🔒 Security Functions - XSS Protection
const SecurityUtils = {
  // HTML Sanitization
  sanitizeHTML(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  },
  
  // Safe innerHTML replacement
  safeSetHTML(element, html) {
    if (!element) return;
    element.textContent = '';
    const sanitized = this.sanitizeHTML(html);
    element.innerHTML = sanitized;
  },
  
  // Input validation
  validateInput(input, type = 'text') {
    if (!input) return false;
    
    const patterns = {
      email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
      username: /^[a-zA-Z0-9_]{2,20}$/,  // ลดจาก 3 เป็น 2 ตัวอักษร
      number: /^\d+$/,
      text: /^[^<>\"'&]*$/
    };
    
    return patterns[type] ? patterns[type].test(input) : true;
  },
  
  // Generate CSRF token
  generateCSRFToken() {
    return 'csrf_' + Math.random().toString(36).substr(2, 15) + Date.now().toString(36);
  },
  
  // Get CSRF token
  getCSRFToken() {
    let token = sessionStorage.getItem('csrf_token');
    if (!token) {
      token = this.generateCSRFToken();
      sessionStorage.setItem('csrf_token', token);
    }
    return token;
  }
};

function clearActiveTimers() {
  activeTimers.forEach(timerId => clearInterval(timerId))
  activeTimers = []; // ล้าง array ให้ว่าง
}

// Enhanced memory management
function addManagedTimer(timerId) {
  activeTimers.push(timerId);
  return timerId;
}

// API caching system
function getCachedData(key, maxAge = 30000) {
  const cached = apiCache.get(key);
  if (cached && Date.now() - cached.timestamp < maxAge) {
    return cached.data;
  }
  return null;
}

function setCachedData(key, data) {
  apiCache.set(key, { data, timestamp: Date.now() });
  if (apiCache.size > 100) {
    const firstKey = apiCache.keys().next().value;
    apiCache.delete(firstKey);
  }
}

// Debounced API calls
function debounceApiCall(key, fn, delay = 500) {
  if (requestQueue.has(key)) {
    clearTimeout(requestQueue.get(key));
  }
  
  const timeoutId = setTimeout(async () => {
    await fn();
    requestQueue.delete(key);
  }, delay);
  
  requestQueue.set(key, timeoutId);
}

// Optimized DOM updates with Security
function updateElementSafely(elementId, content, useCache = true) {
  if (useCache && domCache.get(elementId) === content) {
    return; // Skip if content hasn't changed
  }
  
  const element = document.getElementById(elementId);
  if (element) {
    // Use safe HTML setting instead of innerHTML
    SecurityUtils.safeSetHTML(element, content);
    if (useCache) domCache.set(elementId, content);
  }
}

// Enhanced API function with Security
async function secureApiCall(url, options = {}) {
  const headers = {
    'Content-Type': 'application/json',
    'X-CSRF-Token': SecurityUtils.getCSRFToken(),
    ...options.headers
  };

  const config = {
    ...options,
    headers
  };

  try {
    const response = await fetch(url, config);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error('API call failed:', error);
    showNotification(`การเชื่อมต่อล้มเหลว: ${error.message}`, 'error');
    throw error;
  }
}

// Enhanced Performance monitoring
const perfMonitor = {
  apiCalls: 0,
  cacheHits: 0,
  domUpdates: 0,
  memoryUsage: 0,
  apiTimes: new Map(),
  errors: new Map(),
  
  logApiCall(endpoint, duration) { 
    this.apiCalls++; 
    
    if (!this.apiTimes.has(endpoint)) {
      this.apiTimes.set(endpoint, []);
    }
    this.apiTimes.get(endpoint).push(duration);
  },
  
  logCacheHit() { this.cacheHits++; },
  logDomUpdate() { this.domUpdates++; },
  
  logError(context, error) {
    const key = `${context}: ${error.message}`;
    this.errors.set(key, (this.errors.get(key) || 0) + 1);
  },
  
  getStats() {
    return {
      apiCalls: this.apiCalls,
      cacheHits: this.cacheHits,
      domUpdates: this.domUpdates,
      cacheHitRate: this.apiCalls ? (this.cacheHits / this.apiCalls * 100).toFixed(1) : 0,
      memoryUsage: performance.memory ? Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) : 'N/A',
      activeTimers: activeTimers.length,
      cacheSize: apiCache.size,
      requestQueueSize: requestQueue.size
    };
  },
  
  getSlowApiCalls() {
    const slow = [];
    this.apiTimes.forEach((times, endpoint) => {
      const avg = times.reduce((a, b) => a + b, 0) / times.length;
      if (avg > 2000) {
        slow.push({ endpoint, avgTime: Math.round(avg), callCount: times.length });
      }
    });
    return slow;
  },
  
  getTopErrors() {
    return Array.from(this.errors.entries())
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5)
      .map(([error, count]) => ({ error, count }));
  },
  
  reset() {
    this.apiCalls = 0;
    this.cacheHits = 0;
    this.domUpdates = 0;
    this.apiTimes.clear();
    this.errors.clear();
  }
};

// Auto-performance reporting (disabled in production)
// Uncomment for development monitoring:
/*
if (process.env.NODE_ENV === 'development' && typeof console !== 'undefined') {
  setInterval(() => {
    const stats = perfMonitor.getStats();
    if (stats.apiCalls > 0) {
      console.log('📊 Performance Stats:', stats);
    }
  }, 60000);
}
*/

// Enhanced caching with monitoring
function getCachedDataWithMonitoring(key, maxAge = 30000) {
  const cached = apiCache.get(key);
  if (cached && Date.now() - cached.timestamp < maxAge) {
    perfMonitor.logCacheHit();
    return cached.data;
  }
  perfMonitor.logApiCall();
  return null;
}

// Loading State Management
const LoadingManager = {
  activeLoaders: new Set(),
  
  show(elementId, message = 'กำลังโหลด...') {
    const element = document.getElementById(elementId);
    if (element) {
      element.innerHTML = `
        <div class="loading-state" role="status" aria-live="polite">
          <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
          <span>${SecurityUtils.sanitizeHTML(message)}</span>
        </div>
      `;
      this.activeLoaders.add(elementId);
    }
  },
  
  hide(elementId) {
    this.activeLoaders.delete(elementId);
  },
  
  hideAll() {
    this.activeLoaders.clear();
  }
};

// Enhanced Error Handling with Retry Logic
function handleError(error, context = 'ระบบ') {
  console.error(`Error in ${context}:`, error);
  
  const errorMessage = error.message || 'เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ';
  
  showNotification(
    `❌ ${context}: ${SecurityUtils.sanitizeHTML(errorMessage)}`, 
    'error'
  );
  
  // Log error for monitoring
  if (typeof gtag !== 'undefined') {
    gtag('event', 'exception', {
      description: errorMessage,
      fatal: false
    });
  }
}

// Retry mechanism for failed API calls
async function retryApiCall(apiCall, maxRetries = 3, delay = 1000) {
  let lastError;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      console.log(`🔄 API attempt ${attempt}/${maxRetries}`);
      const result = await apiCall();
      return result;
    } catch (error) {
      lastError = error;
      console.warn(`⚠️ API attempt ${attempt} failed:`, error.message);
      
      if (attempt < maxRetries) {
        await new Promise(resolve => setTimeout(resolve, delay * attempt));
      }
    }
  }
  
  throw lastError;
}

// Network-aware API calling
async function resilientApiCall(url, options = {}) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
  
  try {
    const response = await fetch(url, {
      ...options,
      signal: controller.signal,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': SecurityUtils.getCSRFToken(),
        ...options.headers
      }
    });
    
    clearTimeout(timeoutId);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    return await response.json();
  } catch (error) {
    clearTimeout(timeoutId);
    
    if (error.name === 'AbortError') {
      throw new Error('การเชื่อมต่อหมดเวลา กรุณาลองใหม่อีกครั้ง');
    }
    
    throw error;
  }
}

// Enhanced cleanup system with better memory management
function cleanupCurrentPage() {
  // Starting comprehensive page cleanup
  
  // Clear all managed timers
  clearActiveTimers();
  
  // Clear global intervals that might not be in activeTimers
  const globalIntervals = [
    'envUpdateInterval',
    'overviewRefreshInterval', 
    'trayInventoryInterval',
    'workstationTimer',
    'taskTimer',
    'agvStatusTimer',
    'sensorTimer',
    'environmentInterval'
  ];
  
  globalIntervals.forEach(intervalName => {
    if (window[intervalName]) {
      clearInterval(window[intervalName]);
      window[intervalName] = null;
      // Cleared global interval: ${intervalName}
    }
  });
  
  // Clear pending API requests
  requestQueue.forEach(timeoutId => clearTimeout(timeoutId));
  requestQueue.clear();
  
  // Destroy chart instances to prevent memory leaks
  destroyAllCharts();
  
  // Clear DOM cache for current page only
  if (currentPage !== 'overview') {
    domCache.clear();
  }
  
  // Clear API cache if too large
  if (apiCache.size > 50) {
    apiCache.clear();
    // API cache cleared due to size limit
  }
  
  // Comprehensive page cleanup completed
}

// Dedicated chart cleanup function
function destroyAllCharts() {
  const charts = {
    pieChartInstance,
    barChartInstance, 
    hourlyChartInstance
  };
  
  Object.entries(charts).forEach(([name, instance]) => {
    if (instance) {
      try {
        instance.destroy();
        console.log(`📊 Destroyed chart: ${name}`);
      } catch (error) {
        console.warn(`⚠️ Error destroying ${name}:`, error);
      }
    }
  });
  
  // Reset global chart variables
  pieChartInstance = null;
  barChartInstance = null;
  hourlyChartInstance = null;
}

// Enhanced Keyboard Event Handlers
function setupLoginKeyboardHandlers() {
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  
  if (usernameInput && passwordInput) {
    [usernameInput, passwordInput].forEach(input => {
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          login();
        }
      });
    });
  }
}

/* ================================================================================================
   3. 📄 PAGE RENDERING FUNCTIONS
   ================================================================================================ */

// 🎯 เก็บโครงสร้างเดิมและเพิ่มเฉพาะส่วนที่ขาดไป
function renderOverviewPage() {
  console.log('🎯 Starting renderOverviewPage...');
  const html = `
    <div class="enhanced-overview">
      
     <div class="overview-header-enhanced">
    <div class="header-icon-wrapper">
        <i class="fas fa-chart-pie header-icon"></i>
        <div class="icon-pulse"></div>
    </div>
    <h2 class="enhanced-title">
        <span class="title-gradient">ภาพรวมระบบ</span>
        <span class="title-subtitle">(Overview)</span>
    </h2>
    <div class="title-decoration"></div>
</div>

      <div class="summary-cards-new">
        <div class="summary-card-new inbound card-glow">
          <div class="card-header-new">
            <div class="card-icon-new inbound">
              <i class="fas fa-arrow-down"></i>
            </div>
            <div class="card-trend-new up" id="inboundTrend">
              <i class="fas fa-arrow-up"></i>
              <span>+12%</span>
            </div>
          </div>
          <div class="card-content-new">
            <div class="card-value-new" id="totalInbound">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="card-label-new">Inbound วันนี้</div>
          </div>
        </div>

        <div class="summary-card-new outbound card-glow">
          <div class="card-header-new">
            <div class="card-icon-new outbound">
              <i class="fas fa-arrow-up"></i>
            </div>
            <div class="card-trend-new up" id="outboundTrend">
              <i class="fas fa-arrow-up"></i>
              <span>+8%</span>
            </div>
          </div>
          <div class="card-content-new">
            <div class="card-value-new" id="totalOutbound">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="card-label-new">Outbound วันนี้</div>
          </div>
        </div>

        <div class="summary-card-new total card-glow">
          <div class="card-header-new">
            <div class="card-icon-new total">
              <i class="fas fa-boxes"></i>
            </div>
            <div class="card-trend-new neutral" id="totalTraysTrend">
              <i class="fas fa-equals"></i>
              <span>Stable</span>
            </div>
          </div>
          <div class="card-content-new">
            <div class="card-value-new" id="totalTrays">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="card-label-new">ถาดทั้งหมด</div>
          </div>
        </div>

        <div class="summary-card-new ontime card-glow">
          <div class="card-header-new">
            <div class="card-icon-new ontime">
              <i class="fas fa-clock"></i>
            </div>
            <div class="card-trend-new up" id="ontimeTrend">
              <i class="fas fa-arrow-up"></i>
              <span>+5%</span>
            </div>
          </div>
          <div class="card-content-new">
            <div class="card-value-new" id="onTimeTasks">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="card-label-new">งานตรงเวลา</div>
          </div>
        </div>

        <div class="summary-card-new users card-glow">
          <div class="card-header-new">
            <div class="card-icon-new users">
              <i class="fas fa-users"></i>
            </div>
            <div class="card-trend-new neutral" id="usersTrend">
              <i class="fas fa-circle"></i>
              <span>Online</span>
            </div>
          </div>
          <div class="card-content-new">
            <div class="card-value-new" id="onlineUsers">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="card-label-new">ผู้ใช้งานออนไลน์</div>
          </div>
        </div>

        <div class="summary-card-new tasks card-glow">
          <div class="card-header-new">
            <div class="card-icon-new tasks">
              <i class="fas fa-tasks"></i>
            </div>
            <div class="card-trend-new neutral" id="tasksTrend">
              <i class="fas fa-clock"></i>
              <span>Active</span>
            </div>
          </div>
          <div class="card-content-new">
            <div class="card-value-new" id="activeTasks">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="card-label-new">งานกำลังดำเนินการ</div>
          </div>
        </div>
      </div>

      <div class="overview-grid-new">
        <div class="overview-card-new fade-in">
          <div class="card-header-overview">
            <div class="card-title-new">
              <i class="fas fa-calendar-alt"></i>
              <h3>สรุปการนำถาดเข้าออก 7วัน</h3>
            </div>
            <div class="card-controls">
              <button class="control-btn active" onclick="switchTimeRange('week')" data-tooltip="แสดงข้อมูล 7 วันล่าสุด">
                <i class="fas fa-calendar-week"></i> 7 วัน
              </button>
              <button class="control-btn" onclick="switchTimeRange('month')" data-tooltip="แสดงข้อมูล 30 วันล่าสุด">
                <i class="fas fa-calendar-alt"></i> 30 วัน
              </button>
            </div>
          </div>
          <div class="chart-container-new">
            <canvas id="barChart"></canvas>
          </div>
        </div>

        <div class="overview-card-new slide-in-right">
          <div class="card-header-overview">
            <div class="card-title-new">
              <i class="fas fa-cogs"></i>
              <h3>สถานะระบบ</h3>
            </div>
            <button class="control-btn" onclick="refreshSystemStatus()" data-tooltip="รีเฟรชสถานะระบบ">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
          <div class="status-grid-new">
            <div class="status-item-new tooltip" data-tooltip="สถานะการทำงานของระบบลิฟต์">
              <span class="status-label-new">
                <i class="fas fa-elevator"></i> Lift System
              </span>
              <div class="status-value-new">
                <div class="status-indicator-new success" id="liftStatus"></div>
                <span id="liftStatusText">กำลังตรวจสอบ...</span>
              </div>
            </div>
            
            <div class="status-item-new tooltip" data-tooltip="สถานะการทำงานของระบบ AGV">
              <span class="status-label-new">
                <i class="fas fa-truck-moving"></i> AGV System
              </span>
              <div class="status-value-new">
                <div class="status-indicator-new success" id="agvStatus"></div>
                <span id="agvStatusText">กำลังตรวจสอบ...</span>
              </div>
            </div>
            
            <div class="status-item-new tooltip" data-tooltip="สถานะเซนเซอร์ทั้งหมดในระบบ">
              <span class="status-label-new">
                <i class="fas fa-microchip"></i> Sensors
              </span>
              <div class="status-value-new">
                <div class="status-indicator-new success" id="sensorStatus"></div>
                <span id="sensorStatusText">กำลังตรวจสอบ...</span>
              </div>
            </div>
            
            <div class="status-item-new tooltip" data-tooltip="สถานะการเชื่อมต่อฐานข้อมูล">
              <span class="status-label-new">
                <i class="fas fa-database"></i> Database
              </span>
              <div class="status-value-new">
                <div class="status-indicator-new success" id="dbStatus"></div>
                <span id="dbStatusText">Connected</span>
              </div>
            </div>
            
            <div class="status-item-new tooltip" data-tooltip="สถานะการเชื่อมต่อ MQTT Broker">
              <span class="status-label-new">
                <i class="fas fa-broadcast-tower"></i> MQTT Broker
              </span>
              <div class="status-value-new">
                <div class="status-indicator-new success" id="mqttStatus"></div>
                <span id="mqttStatusText">Connected</span>
              </div>
            </div>
          </div>
        </div>

        <div class="overview-card-new scale-in">
          <div class="card-header-overview">
            <div class="card-title-new">
              <i class="fas fa-chart-pie"></i>
              <h3>สรุปภาพรวมทั้งหมด</h3>
            </div>
            <div class="status-badge success">
              <i class="fas fa-check-circle"></i>
              อัพเดทแล้ว
            </div>
          </div>
          <div id="pieChartContainer-new">
            <canvas id="pieChart"></canvas>
          </div>
        </div>

        <div class="overview-card-new slide-in-left">
          <div class="card-header-overview">
            <div class="card-title-new">
              <i class="fas fa-stream"></i>
              <h3>กิจกรรมล่าสุด</h3>
            </div>
            <button class="control-btn" onclick="refreshActivityFeed()" data-tooltip="รีเฟรชกิจกรรมล่าสุด">
              <i class="fas fa-refresh"></i>
            </button>
          </div>
          <div class="activity-feed-new" id="activityFeed">
            <div class="loading-state">
              <i class="fas fa-spinner fa-spin"></i>
              <p>กำลังโหลดกิจกรรม...</p>
            </div>
          </div>
        </div>

        <div class="overview-card-new full-width bounce-in">
          <div class="card-header-overview">
            <div class="card-title-new">
              <i class="fas fa-clock"></i>
              <h3>กิจกรรมรายชั่วโมง (วันนี้)</h3>
            </div>
            <div class="card-controls">
              <div class="status-badge info">
                <i class="fas fa-calendar-day"></i>
                วันนี้
              </div>
            </div>
          </div>
          <div class="chart-container-new hourly">
            <canvas id="hourlyChart"></canvas>
          </div>
        </div>

        <div class="overview-card-new full-width fade-in">
          <div class="card-header-overview">
            <div class="card-title-new">
              <i class="fas fa-thermometer-half"></i>
              <h3>ข้อมูลสภาพแวดล้อม</h3>
            </div>
            <div class="card-controls">
              <div class="status-badge success" id="envStatus">
                <i class="fas fa-broadcast-tower"></i>
                Real-time
              </div>
              <button class="control-btn" onclick="resetEnvironmentalData()" data-tooltip="รีเซ็ตข้อมูลสภาพแวดล้อม">
                <i class="fas fa-redo"></i>
              </button>
            </div>
          </div>
          <div class="env-grid-new">
            <div class="env-card-new tooltip" data-tooltip="อุณหภูมิปัจจุบันในพื้นที่เพาะปลูก">
              <div class="env-value-new" id="tempValue">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <div class="env-label-new">
                <i class="fas fa-thermometer-half"></i> อุณหภูมิ
              </div>
              <div class="env-range-new">เป้าหมาย: 23-28°C</div>
            </div>
            
            <div class="env-card-new tooltip" data-tooltip="ความชื้นสัมพัทธ์ในอากาศ">
              <div class="env-value-new" id="humidityValue">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <div class="env-label-new">
                <i class="fas fa-tint"></i> ความชื้น
              </div>
              <div class="env-range-new">เป้าหมาย: 60-80%</div>
            </div>
            
            <div class="env-card-new tooltip" data-tooltip="ระดับคาร์บอนไดออกไซด์ในอากาศ">
              <div class="env-value-new" id="co2Value">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <div class="env-label-new">
                <i class="fas fa-smog"></i> CO₂
              </div>
              <div class="env-range-new">เป้าหมาย: 400-600ppm</div>
            </div>
            
            <div class="env-card-new tooltip" data-tooltip="ความเข้มแสงสำหรับการเจริญเติบโต">
              <div class="env-value-new" id="lightValue">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <div class="env-label-new">
                <i class="fas fa-lightbulb"></i> แสง
              </div>
              <div class="env-range-new">เป้าหมาย: 7-10k lux</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <button class="fab" onclick="showOverviewSettings()" data-tooltip="ตั้งค่าหน้าภาพรวม">
      <i class="fas fa-cog"></i>
    </button>
  `;
  
  console.log('📝 Setting innerHTML for mainContent...');
  const mainContent = document.getElementById("mainContent");
  if (!mainContent) {
    console.error('❌ mainContent element not found!');
    return;
  }
  
  mainContent.innerHTML = html;
  console.log('✅ HTML set successfully');
  
  // ✅ แก้ไขปัญหาที่ 3: รอให้ DOM พร้อมก่อนเรียกฟังก์ชัน
  setTimeout(() => {
    console.log('⚡ Calling initOverviewPage...');
    initOverviewPage();
  }, 100);
}

/* ================================================================================================
   4. 📊 DASHBOARD & OVERVIEW FUNCTIONS
   ================================================================================================ */

// ✅ ฟังก์ชันเริ่มต้นหน้า Overview (แก้ไขลำดับการเรียก)
function initOverviewPage() {
  // ตรวจสอบว่า canvas elements มีอยู่หรือไม่
  const pieChart = document.getElementById('pieChart');
  const barChart = document.getElementById('barChart');
  const hourlyChart = document.getElementById('hourlyChart');
  
  console.log('🔍 ตรวจสอบ Canvas Elements:');
  console.log('pieChart:', pieChart);
  console.log('barChart:', barChart);
  console.log('hourlyChart:', hourlyChart);
  
  if (!pieChart || !barChart || !hourlyChart) {
    console.error('❌ ไม่พบ canvas elements ที่จำเป็น');
    return;
  }
  
  // แสดง Loading Animation
  showOverviewLoading();
  
  // โหลดข้อมูลทั้งหมด
  loadFullOverviewData(currentStation);
  
  // เริ่ม Auto Refresh
  startOverviewAutoRefresh();
}

// ✅ ฟังก์ชันแสดง Loading State
function showOverviewLoading() {
  const loadingElements = ['totalInbound', 'totalOutbound', 'totalTrays', 'onTimeTasks', 'onlineUsers', 'activeTasks'];
  loadingElements.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
  });
}



/// ✅ ฟังก์ชันโหลดข้อมูลครบถ้วน (ใช้ตัวแปรเดิม)
async function loadFullOverviewData(stationId) {
  try {
    // โหลดข้อมูลแบบ Parallel เพื่อความเร็ว
    const promises = [
      loadSummaryCards(),
      loadOverviewCharts(stationId), // ใช้ฟังก์ชันเดิม
      loadUsersAndTasks(),
      loadSystemStatus(),
      loadRecentActivity(),
      loadEnvironmentalData()
    ];

    await Promise.allSettled(promises);
    
    // แสดงการแจ้งเตือนเมื่อโหลดเสร็จ
    showNotification('ข้อมูลอัพเดทเรียบร้อยแล้ว', 'success');
    
  } catch (error) {
    console.error('Error loading overview data:', error);
    showNotification('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
  }
}

// ✅ โหลดข้อมูล Summary Cards
async function loadSummaryCards() {
  try {
    const cacheKey = `summary-cards-${currentStation}`;
    let data = getCachedData(cacheKey, 15000); // Cache for 15 seconds
    
    if (!data) {
      data = await secureApiCall(`/api/overview/summary-cards?station=${currentStation}`);
      setCachedData(cacheKey, data);
    }
    
    updateSummaryCards(data);
    
  } catch (error) {
    console.error('Error loading summary cards:', error);
    // ใช้ข้อมูล 0 เมื่อ error
    updateSummaryCards({
      today_inbound: 0,
      today_outbound: 0,
      total_trays: 0,
      ontime_percentage: 0,
      inbound_trend: 0,
      outbound_trend: 0,
      trays_trend: 0,
      ontime_trend: 0
    });
  }
}

// ✅ อัพเดท Summary Cards พร้อม Animation
function updateSummaryCards(data) {
  // อัพเดทตัวเลข
  animateCounter('totalInbound', data.today_inbound || 0);
  animateCounter('totalOutbound', data.today_outbound || 0);
  animateCounter('totalTrays', data.total_trays || 0);
  animateCounter('onTimeTasks', data.ontime_percentage || 0, '%');

  // อัพเดท trend
  updateTrendIndicator('inboundTrend', data.inbound_trend || 0);
  updateTrendIndicator('outboundTrend', data.outbound_trend || 0);
  updateTrendIndicator('totalTraysTrend', data.trays_trend || 0);
  updateTrendIndicator('ontimeTrend', data.ontime_trend || 0);
}


// ✅ Animation สำหรับตัวเลข
function animateCounter(elementId, targetValue, suffix = '') {
  const element = document.getElementById(elementId);
  if (!element) return;

  const startValue = 0;
  const duration = 1500; // 1.5 
  const startTime = Date.now();

  function updateCounter() {
    const elapsed = Date.now() - startTime;
    const progress = Math.min(elapsed / duration, 1);
    
    // ใช้ easing function สำหรับ smooth animation
    const easeOut = 1 - Math.pow(1 - progress, 3);
    const currentValue = Math.round(startValue + (targetValue - startValue) * easeOut);
    
    element.textContent = currentValue + suffix;
    
    if (progress < 1) {
      requestAnimationFrame(updateCounter);
    }
  }
  
  updateCounter();
}

// ✅ อัพเดท Trend Indicator
function updateTrendIndicator(elementId, value, direction) {
  const element = document.getElementById(elementId);
  if (!element) return;

  const icon = direction === 'up' ? 'fas fa-arrow-up' : 
               direction === 'down' ? 'fas fa-arrow-down' : 'fas fa-minus';
  
  const className = direction === 'up' ? 'up' : 
                   direction === 'down' ? 'down' : 'neutral';

  element.className = `card-trend-new ${className}`;
  element.innerHTML = `<i class="${icon}"></i><span>${value > 0 ? '+' : ''}${value}%</span>`;
}

// ✅ โหลดข้อมูลผู้ใช้และงาน
async function loadUsersAndTasks() {
  try {
    const [usersResponse, tasksResponse] = await Promise.all([
      fetch('/api/users').catch(() => ({ ok: false })),
      fetch('/api/task-monitor').catch(() => ({ ok: false }))
    ]);

    // อัพเดทผู้ใช้ออนไลน์
    if (usersResponse.ok) {
      const users = await usersResponse.json();
      const onlineCount = users.filter(user => user.is_online).length;
      animateCounter('onlineUsers', onlineCount);
      updateTrendIndicator('usersTrend', onlineCount, 'neutral');
      
      // อัพเดท trend text
      const usersTrendEl = document.getElementById('usersTrend');
      if (usersTrendEl) {
        usersTrendEl.innerHTML = `<i class="fas fa-circle"></i><span>${onlineCount} คนออนไลน์</span>`;
      }
    } else {
      animateCounter('onlineUsers', 0);
    }

    // อัพเดทงานที่กำลังดำเนินการ
    if (tasksResponse.ok) {
      const tasks = await tasksResponse.json();
      const activeCount = tasks.filter(task => 
        task.status === 'pending' || task.status === 'processing' || task.status === 'at_workstation'
      ).length;
      animateCounter('activeTasks', activeCount);
      
      // อัพเดท trend text
      const tasksTrendEl = document.getElementById('tasksTrend');
      if (tasksTrendEl) {
        tasksTrendEl.innerHTML = `<i class="fas fa-clock"></i><span>${activeCount} งานใน Queue</span>`;
      }
    } else {
      animateCounter('activeTasks', 0);
    }

  } catch (error) {
    console.error('Error loading users and tasks:', error);
    animateCounter('onlineUsers', 0);
    animateCounter('activeTasks', 0);
  }
}

// ✅ โหลดสถานะระบบ
async function loadSystemStatus() {
  const statusChecks = [
    { name: 'lift', endpoint: `/api/lift/status?station=${currentStation}`, timeout: 5000 },
    { name: 'agv', endpoint: `/api/agv/status?station=${currentStation}`, timeout: 5000 },
    { name: 'sensor', endpoint: '/api/sensors', timeout: 3000 }
  ];

  // ตรวจสอบแต่ละระบบแบบ Parallel
  statusChecks.forEach(async (check) => {
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), check.timeout);

      const response = await fetch(check.endpoint, {
        signal: controller.signal,
        method: 'GET'
      });

      clearTimeout(timeoutId);

      if (response.ok) {
        if (check.name === 'sensor') {
          const sensorData = await response.json();
          const activeSensors = Object.values(sensorData).filter(Boolean).length;
          const totalSensors = Object.keys(sensorData).length;
          updateSystemStatus(check.name, `${activeSensors}/${totalSensors} Active`, 'success');
        } else {
          const data = await response.json();
          updateSystemStatus(check.name, data.status || 'Online', 'success');
        }
      } else {
        updateSystemStatus(check.name, 'Offline', 'error');
      }
    } catch (error) {
      if (error.name === 'AbortError') {
        updateSystemStatus(check.name, 'Timeout', 'warning');
      } else {
        updateSystemStatus(check.name, 'Error', 'error');
      }
    }
  });

  // สถานะ Database และ MQTT (เสมอ Connected เนื่องจากถ้าไม่เชื่อมต่อจะไม่สามารถโหลดหน้านี้ได้)
  updateSystemStatus('db', 'Connected', 'success');
  updateSystemStatus('mqtt', 'Connected', 'success');
}

// ✅ อัพเดทสถานะระบบพร้อม Animation
function updateSystemStatus(system, status, type) {
  const statusMap = {
    'lift': { indicator: 'liftStatus', text: 'liftStatusText' },
    'agv': { indicator: 'agvStatus', text: 'agvStatusText' },
    'sensor': { indicator: 'sensorStatus', text: 'sensorStatusText' },
    'db': { indicator: 'dbStatus', text: 'dbStatusText' },
    'mqtt': { indicator: 'mqttStatus', text: 'mqttStatusText' }
  };

  const elements = statusMap[system];
  if (!elements) return;

  const indicator = document.getElementById(elements.indicator);
  const text = document.getElementById(elements.text);
  
  if (indicator && text) {
    // อัพเดท indicator พร้อม animation
    indicator.className = `status-indicator-new ${type}`;
    
    // อัพเดทข้อความพร้อม fade effect
    text.style.opacity = '0';
    setTimeout(() => {
      text.textContent = status;
      text.style.opacity = '1';
    }, 150);
  }
}

// ✅ โหลดกิจกรรมล่าสุด
async function loadRecentActivity() {
  try {
    const response = await fetch('/api/logs');
    if (response.ok) {
      const logs = await response.json();
      const recentLogs = logs.slice(0, 8); // แสดง 8 กิจกรรมล่าสุด
      renderActivityFeed(recentLogs);
    } else {
      renderActivityFeed([]);
    }
  } catch (error) {
    console.error('Error loading recent activity:', error);
    renderActivityFeed([]);
  }
}

// ✅ แสดงกิจกรรมล่าสุดพร้อม Animation
function renderActivityFeed(logs) {
  const feedContainer = document.getElementById('activityFeed');
  if (!feedContainer) return;
  
  if (!logs || logs.length === 0) {
    feedContainer.innerHTML = `
      <div class="error-state">
        <i class="fas fa-inbox"></i>
        <p>ไม่มีกิจกรรมล่าสุด</p>
        <button onclick="refreshActivityFeed()">รีเฟรช</button>
      </div>
    `;
    return;
  }

  let activitiesHtml = '';
  logs.forEach((log, index) => {
    const activityType = getActivityType(log.category || log.action_type);
    const timeAgo = getTimeAgo(new Date(log.created_at || log.timestamp));
    const activityText = log.activity || log.description || 'กิจกรรมไม่ระบุ';
    
    activitiesHtml += `
      <div class="activity-item-new" style="animation-delay: ${index * 0.1}s">
        <div class="activity-icon-new ${activityType}">
          <i class="${getActivityIcon(activityType)}"></i>
        </div>
        <div class="activity-content-new">
          <div class="activity-text-new">${activityText}</div>
          <div class="activity-time-new">
            <i class="fas fa-clock"></i> ${timeAgo}
          </div>
        </div>
      </div>
    `;
  });

  feedContainer.innerHTML = activitiesHtml;
  
  // เพิ่ม fade-in animation
  feedContainer.classList.add('fade-in');
}

// ✅ กำหนดประเภทกิจกรรม
function getActivityType(category) {
  if (!category) return 'system';
  
  const cat = category.toLowerCase();
  if (cat.includes('inbound') || cat.includes('เข้า') || cat.includes('วาง')) return 'inbound';
  if (cat.includes('outbound') || cat.includes('ออก') || cat.includes('นำออก')) return 'outbound';
  if (cat.includes('user') || cat.includes('ผู้ใช้') || cat.includes('login') || cat.includes('เข้าสู่ระบบ')) return 'user';
  return 'system';
}

// ✅ กำหนดไอคอนกิจกรรม
function getActivityIcon(type) {
  const icons = {
    'inbound': 'fas fa-arrow-down',
    'outbound': 'fas fa-arrow-up',
    'user': 'fas fa-user-check',
    'system': 'fas fa-cogs'
  };
  return icons[type] || 'fas fa-info-circle';
}

// ✅ คำนวณเวลาที่ผ่านมา
function getTimeAgo(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'เมื่อสักครู่';
  if (diffMins < 60) return `${diffMins} นาทีที่แล้ว`;
  if (diffHours < 24) return `${diffHours} ชั่วโมงที่แล้ว`;
  if (diffDays < 7) return `${diffDays} วันที่แล้ว`;
  return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
}



// ✅ โหลดข้อมูลสภาพแวดล้อม (Real-time)
function loadEnvironmentalData() {
  // ฟังก์ชันสำหรับอัพเดทข้อมูลสภาพแวดล้อม
  function updateEnvironmentalValues() {
    try {
      // สร้างข้อมูลแบบสุ่มที่สมจริงกว่า (มีการเปลี่ยนแปลงน้อย)
      const temp = (Math.random() * 2 + 25).toFixed(1); // 25-27°C
      const humidity = (Math.random() * 10 + 65).toFixed(0); // 65-75%
      const co2 = (Math.random() * 80 + 460).toFixed(0); // 460-540 ppm
      const light = (Math.random() * 2 + 8).toFixed(1); // 8-10k lux

      // อัพเดทค่าพร้อม animation
      updateEnvironmentalValue('tempValue', `${temp}°C`);
      updateEnvironmentalValue('humidityValue', `${humidity}%`);
      updateEnvironmentalValue('co2Value', `${co2}ppm`);
      updateEnvironmentalValue('lightValue', `${light}k`);

      // อัพเดทสถานะ Environmental badge
      const envStatus = document.getElementById('envStatus');
      if (envStatus) {
        const now = new Date().toLocaleTimeString('th-TH', { 
          hour: '2-digit', 
          minute: '2-digit',
          second: '2-digit'
        });
        envStatus.innerHTML = `<i class="fas fa-broadcast-tower"></i> อัพเดท ${now}`;
      }

    } catch (error) {
      console.error('Error updating environmental data:', error);
    }
  }

  // อัพเดททันทีและทุก 8 วินาที
  updateEnvironmentalValues();
  
  // เคลียร์ interval เก่าก่อน (ถ้ามี)
  if (window.envUpdateInterval) {
    clearInterval(window.envUpdateInterval);
  }
  
  window.envUpdateInterval = addManagedTimer(setInterval(updateEnvironmentalValues, 8000));
}

// ✅ อัพเดทค่าสภาพแวดล้อมพร้อม Animation
function updateEnvironmentalValue(elementId, newValue) {
  const element = document.getElementById(elementId);
  if (!element) return;

  // Fade out -> Change value -> Fade in
  element.style.transition = 'opacity 0.3s ease';
  element.style.opacity = '0.5';
  
  setTimeout(() => {
    element.textContent = newValue;
    element.style.opacity = '1';
  }, 150);
}

// ✅ ฟังก์ชันสลับช่วงเวลา
function switchTimeRange(range) {
  // อัพเดทสถานะปุ่ม
  document.querySelectorAll('.control-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // แสดง loading ขณะโหลดข้อมูลใหม่
  const chartContainer = document.querySelector('.chart-container-new canvas');
  if (chartContainer) {
    chartContainer.style.opacity = '0.5';
  }
  
  // โหลดข้อมูลใหม่ตามช่วงเวลาที่เลือก
  if (range === 'week') {
    loadOverviewCharts(currentStation); // โหลดข้อมูล 7 วัน
  } else if (range === 'month') {
    loadMonthlyCharts(currentStation); // โหลดข้อมูล 30 วัน
  }
  
  // แสดงการแจ้งเตือน
  showNotification(`เปลี่ยนเป็นข้อมูล ${range === 'week' ? '7 วัน' : '30 วัน'} แล้ว`, 'info');
}

// ✅ โหลดข้อมูลกราฟ 30 วัน
async function loadMonthlyCharts(stationId) {
  try {
    // ✨ จุดสำคัญ: เปลี่ยน endpoint เป็น /api/stats/monthly
    const response = await fetch(`/api/stats/monthly?station=${stationId}`);
    if (response.ok) {
      const data = await response.json();
      renderBarChart(data, 'monthly'); // ส่งข้อมูลไปวาดกราฟ
    } else {
      // กรณี API ไม่พร้อมใช้งาน ให้ใช้ข้อมูลจำลอง (Mock Data) แทน
      console.warn('Monthly API failed, using mock data.');
      const mockData = generateMockMonthlyData();
      renderBarChart(mockData, 'monthly');
    }
  } catch (error) {
    console.error('Error loading monthly charts:', error);
    const mockData = generateMockMonthlyData();
    renderBarChart(mockData, 'monthly');
  }
}

// ✅ สร้างข้อมูล Mock สำหรับ 30 วัน
function generateMockMonthlyData() {
  const data = [];
  for (let i = 29; i >= 0; i--) {
    data.push({
      day_offset: i,
      inbound: Math.floor(Math.random() * 20) + 5,
      outbound: Math.floor(Math.random() * 15) + 3
    });
  }
  return data;
}





// ✅ MOCK DATA ตัวอย่าง
const trays = [
  { veg_type: "ผักบุ้ง", floor: 2, slot: 3, start_date: "2025-05-10", harvest_date: "2025-05-20" },
  { veg_type: "คะน้า", floor: 3, slot: 5, start_date: "2025-05-12", harvest_date: "2025-05-24" },
  { veg_type: "เรดโอ๊ค", floor: 4, slot: 6, start_date: "2025-05-01", harvest_date: "2025-05-20" },
  { veg_type: "บัตเตอร์เฮด", floor: 5, slot: 7, start_date: "2025-05-15", harvest_date: "2025-05-26" },
  { veg_type: "ผักชี", floor: 6, slot: 8, start_date: "2025-05-16", harvest_date: "2025-05-20" },
  { veg_type: "ผักกาด", floor: 7, slot: 9, start_date: "2025-05-17", harvest_date: "2025-05-21" },
  { veg_type: "โหระพา", floor: 8, slot: 10, start_date: "2025-05-10", harvest_date: "2025-05-20" },
  { veg_type: "กรีนโอ๊ค", floor: 1, slot: 1, start_date: "2025-05-18", harvest_date: "2025-05-28" },
  { veg_type: "เคล", floor: 2, slot: 2, start_date: "2025-05-19", harvest_date: "2025-05-29" },
  { veg_type: "สลัด", floor: 3, slot: 3, start_date: "2025-05-20", harvest_date: "2025-05-30" },
  { veg_type: "มินิเรดโอ๊ค", floor: 4, slot: 4, start_date: "2025-05-20", harvest_date: "2025-05-20" }
];
const rowsPerPage = 10;








// 🥦 Global variable สำหรับเก็บสถานะถาดทั้งหมด (ใช้ตัวนี้ตัวเดียว)
let trayInventory = {};
async function loadTrayInventory() {
  trayInventory = {}; // ✅ [แก้ไข] ต้องล้างข้อมูลเป็น Object ว่าง
  try {
    const response = await fetch(`/api/tray-inventory?station=${currentStation}&t=${Date.now()}`);
    if (!response.ok) {
      console.error("Fetch tray inventory failed!");
      return;
    }
    const data = await response.json();
    const newInventory = {};
    data.forEach(tray => {
      const key = `${tray.floor}-${tray.slot}`;
      newInventory[key] = tray;
    });
    
    trayInventory = newInventory;
    console.log("✅ ข้อมูล Inventory ถูกโหลดใหม่เรียบร้อยแล้วสำหรับ Station:", currentStation);

  } catch (error) {
    console.error("❌ เกิดข้อผิดพลาดใน loadTrayInventory:", error);
  }
}

// ✅ เรียกใช้งานครั้งแรก "หลังจาก" ที่หน้าเว็บโหลดเสร็จสมบูรณ์แล้ว
document.addEventListener('DOMContentLoaded', () => {
    // โค้ดส่วนอื่นๆ ที่อยู่ใน DOMContentLoaded ของคุณ...
    // เช่น การตรวจสอบสถานะ login
    const loggedIn = localStorage.getItem("loggedIn");
    if (loggedIn === "true") {
        // ...
        // โหลดข้อมูลถาดเริ่มต้น
        loadTrayInventory();
    } else {
        // ...
    }
});


let currentUsername = null;  // 🌟 ใช้เก็บชื่อผู้ใช้ที่ login สำเร็จ



//  tabsidebar
function setActiveSidebar(page) {
  const links = document.querySelectorAll(".sidebar a");
  links.forEach(link => {
    const target = link.getAttribute("data-page");
    if (target === page) {
      link.classList.add("active");
    } else {
      link.classList.remove("active");
    }
  });
}




  

  function confirmTray() {
  const floorEl = document.getElementById("floorSelect");
  const slotEl = document.getElementById("slotSelect");
  const vegEl = document.getElementById("vegSelect");
  const msgEl = document.getElementById("trayMsg");

  if (!floorEl || !slotEl || !vegEl || !msgEl) {
    console.warn("❌ [confirmTray] Elements ยังไม่อยู่บน DOM");
    return;
  }

  const floor = floorEl.value;
  const slot = slotEl.value;
  const veg = vegEl.value;

  msgEl.style.display = "none";
  msgEl.className = "message";

  if (!floor || !slot || !veg) {
    msgEl.textContent = "⚠️ กรุณาเลือกข้อมูลให้ครบ";
    msgEl.classList.add("error");
    msgEl.style.display = "block";
    return;
  }

  const key = `${floor}-${slot}`;
  if (trayStatus[key]) {
    msgEl.textContent = `❌ ช่อง ${slot} บนชั้น ${floor} มีถาดอยู่แล้ว!`;
    msgEl.classList.add("error");
  } else {
    msgEl.textContent = `✅ สั่งวาง \"${veg}\" ที่ชั้น ${floor} ช่อง ${slot} เรียบร้อย`;
    msgEl.classList.add("success");
  }
  msgEl.style.display = "block";
}
/**
 * ✅ [แก้ไข] ทำให้ Pop-up แสดงไอคอนตามที่ส่งเข้ามา (Inbound/Outbound)
/**
 * ✅ [แก้ไข] เพิ่มคลาส .danger ให้กับ Icon และ Button
 */
function showConfirmationPopup({ title, subtitle, icon, details, onConfirm }) {

  const isDanger = (icon === 'fa-dolly-flatbed');
  const confirmButtonClass = isDanger ? 'danger' : '';
  const iconClass = isDanger ? 'danger' : '';

  const popupHTML = `
    <div class="popup-overlay" id="confirmationPopup">
      <div class="popup-container">
        <div class="popup-header">
          <i class="fas ${icon} icon ${iconClass}"></i>
          <h2 class="popup-title">${title}</h2>
          <p class="popup-subtitle">${subtitle}</p>
        </div>
        <div class="popup-summary">
          ${details.map(item => `
            <div class="summary-item">
              <span class="label">${item.label}</span>
              <span class="value ${item.highlight ? 'highlight' : ''}">${item.value || '-'}</span>
            </div>
          `).join('')}
        </div>
        <div class="popup-actions">
          <button class="popup-button cancel">ยกเลิก</button>
          <button class="popup-button confirm ${confirmButtonClass}">ยืนยัน</button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', popupHTML);

  const popupElement = document.getElementById('confirmationPopup');
  const confirmBtn = popupElement.querySelector('.popup-button.confirm');
  const cancelBtn = popupElement.querySelector('.popup-button.cancel');

  const closePopup = () => {
    popupElement.remove();
  };

  confirmBtn.onclick = () => {
    onConfirm();
    closePopup();
  };

  cancelBtn.onclick = closePopup;
  popupElement.onclick = (e) => {
    if (e.target === popupElement) {
        closePopup();
    }
  };
}
// ✅ [แก้ไข] ฟังก์ชันยืนยันการนำเข้า ให้กลับไปใช้ slot ที่ผู้ใช้เลือกเอง
async function handleInbound() {
    const data = {
        floor: document.getElementById("inFloor").value,
        slot: document.getElementById("inSlot").value, // ✅ กลับมาใช้ "inSlot"
        veg_type: document.getElementById("inVeg").value,
        quantity: document.getElementById("inPlantQuantity").value,
        batch_id: document.getElementById("inBatchId").value,
        seeding_date: document.getElementById("inSeedingDate").value,
        notes: document.getElementById("inNotes").value,
        username: localStorage.getItem("username"),
        station: currentStation
    };

    if (!data.floor || !data.slot || !data.veg_type) {
        showToast("⚠️ กรุณาเลือก ชั้น, ช่อง และชนิดผักให้ครบ", false);
        return;
    }
  
    showConfirmationPopup({
        title: 'ยืนยันการวางถาดใหม่',
        subtitle: 'โปรดตรวจสอบความถูกต้องของข้อมูล',
        icon: 'fa-leaf',
        details: [
            { label: 'ตำแหน่ง', value: `ชั้น ${data.floor} / ช่อง ${data.slot}`, highlight: true },
            { label: 'ชนิดผัก', value: data.veg_type },
            { label: 'จำนวนต้น', value: data.quantity },
            { label: 'Batch ID', value: data.batch_id },
            { label: 'วันที่เพาะเมล็ด', value: data.seeding_date },
            { label: 'หมายเหตุ', value: data.notes }
        ],
        onConfirm: async () => {
            try {
                const res = await fetch("/api/tray/inbound", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                if (result.error) {
                   showToast(`❌ ${result.error}`, false);
                } else {
                   showToast(`✅ รับคำสั่งวางถาดแล้ว...`, true);
                   refreshDataAndViews();
                }
            } catch (error) {
                console.error("❌ เกิดข้อผิดพลาดขณะวางถาด:", error);
                showToast("❌ ไม่สามารถวางถาดได้ กรุณาลองใหม่", false);
            }
        }
    });
}
// [แก้ไข] ฟังก์ชันยืนยันการนำออก ให้ใช้ข้อมูลจาก LIFO
async function handleOutbound() {
    // ตรวจสอบว่ามีถาดที่ถูกเลือกจากฟังก์ชัน validateOutboundFloor() หรือไม่
    if (!selectedOutboundTray) {
        showToast("⚠️ ไม่ได้เลือกถาดที่ต้องการนำออก กรุณาเลือกชั้นก่อน", false);
        return;
    }

    const data = {
        floor: selectedOutboundTray.floor, // ใช้ข้อมูลที่ระบบเลือกให้
        slot: selectedOutboundTray.slot,   // ใช้ข้อมูลที่ระบบเลือกให้
        reason: document.getElementById("outReason").value,
        destination: document.getElementById("outDestination").value,
        username: localStorage.getItem("username"),
        station: currentStation
    };
    
    showConfirmationPopup({
        title: 'ยืนยันการนำถาดออก',
        subtitle: 'ระบบจะนำถาดที่อยู่หน้าสุดของชั้นที่เลือกออกมา',
        icon: 'fa-dolly-flatbed', // ไอคอนรถเข็น
        details: [
            { label: 'ตำแหน่ง', value: `ชั้น ${data.floor} / ช่อง ${data.slot}`, highlight: true },
            { label: 'ชนิดผัก', value: selectedOutboundTray.veg_type },
            { label: 'เหตุผล', value: data.reason },
            { label: 'ปลายทาง', value: data.destination }
        ],
        onConfirm: async () => {
            try {
                const res = await fetch("/api/tray/outbound", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                if (result.error) {
                    showToast(`❌ ${result.error}`, false);
                } else {
                    showToast(`✅ รับคำสั่งนำถาดออกแล้ว...`, true);
                    // โหลดข้อมูลทั้งหมดใหม่หลังจากทำงานสำเร็จ
                    refreshDataAndViews();
                }
            } catch (error) {
                console.error("❌ นำถาดออกผิดพลาด:", error);
                showToast("❌ ไม่สามารถนำถาดออกได้ กรุณาลองใหม่", false);
            }
        }
    }); 
}
function checkOutboundSlot() {
  const floor = document.getElementById("outFloor").value;
  const slot = document.getElementById("outSlot").value;
  const key = `${floor}-${slot}`;

  // ดึง element ต่างๆ
  const validationBox = document.getElementById("outboundValidationBox");
  const detailsPreview = document.getElementById("trayDetailsPreview");
  const warning = document.getElementById("outboundWarning");
  const reasonSelect = document.getElementById("outReason");
  const destinationInput = document.getElementById("outDestination");
  const confirmBtn = document.getElementById("outboundConfirmBtn");

  const trayInfo = trayInventory[key];

  validationBox.style.display = "block"; // แสดงกล่องข้อความเสมอ

  if (trayInfo) {
    // ---- กรณีเจอถาด ----
    validationBox.classList.add("success");
    validationBox.classList.remove("warning");

    // ✅✅✅ [แก้ไข] จัดรูปแบบวันที่ใหม่ให้เป็น DD/MM/YYYY ✅✅✅
    const formattedDate = new Date(trayInfo.time_in).toLocaleDateString('th-TH', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric' // ใช้ 'numeric' เพื่อให้ได้ปี ค.ศ.
    });

    detailsPreview.innerHTML = `<i class="fas fa-check-circle"></i> พบถาด: ${trayInfo.veg_type} | วางเมื่อ: ${formattedDate}`;
    detailsPreview.style.display = "block";
    warning.style.display = "none";

    // เปิดให้กรอกข้อมูลและกดยืนยัน
    reasonSelect.disabled = false;
    destinationInput.disabled = false;
    confirmBtn.disabled = false;

  } else {
    // ---- กรณีไม่เจอถาด (ช่องว่าง) ----
    validationBox.classList.add("warning");
    validationBox.classList.remove("success");

    warning.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ไม่พบถาดในตำแหน่งนี้ กรุณาเลือกใหม่`;
    warning.style.display = "block";
    detailsPreview.style.display = "none";

    // ปิดการกรอกข้อมูลและปุ่มยืนยัน
    reasonSelect.disabled = true;
    destinationInput.disabled = true;
    confirmBtn.disabled = true;
  }
}

function renderTrayManagement() {
  const html = `
    <div class="section" style="padding: 30px;">
      <h2 style="font-size: 1.8em; color: #1b4332; margin-bottom: 30px;">
        🧺 Tray Management
      </h2>
      <div style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: space-between;">
        ${renderInboundSection()}
        ${renderOutboundSection()}
      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadTrayInventory(); // โหลดครั้งแรก
    const trayTimer = addManagedTimer(setInterval(() => {
      debounceApiCall('trayInventory', loadTrayInventory, 200);
    }, 5000)); // เริ่ม polling
    activeTimers.push(trayTimer); // ✅ เพิ่ม Timer เข้าสู่ระบบจัดการ
}

function renderInboundPage() {
  return `
    <div class="form-container-deluxe">
      <div class="form-header">
          <h2 class="form-title">
            <i class="fas fa-seedling"></i> ลงทะเบียนถาดใหม่ (Inbound)
          </h2>
          <p class="form-subtitle">กรุณากรอกข้อมูลทั้งหมดเพื่อลงทะเบียนถาดใหม่ในระบบ</p>
      </div>

      <div class="form-grid">
        <div class="form-group">
            <label for="inFloor"><i class="fas fa-layer-group"></i> ชั้น</label>
            <select id="inFloor" class="form-input-deluxe">
                ${[...Array(8)].map((_, i) => `<option value="${i + 1}">ชั้น ${i + 1}</option>`).join('')}
            </select>
        </div>

        <div class="form-group">
            <label for="inSlot"><i class="fas fa-th-large"></i> ช่อง</label>
            <select id="inSlot" class="form-input-deluxe">
                ${[...Array(18)].map((_, i) => `<option value="${i + 1}">ช่อง ${i + 1}</option>`).join('')}
            </select>
        </div>

        <div class="form-group">
            <label for="inVeg"><i class="fas fa-seedling"></i> ชนิดผัก</label>
            <select id="inVeg" class="form-input-deluxe">
                <option>Baby Kale</option><option>Baby Spinach</option><option>Baby Red Oak</option>
                <option>Baby Rocket</option><option>Baby Swiss Chard</option><option>บัตเตอร์เฮด</option>
                <option>ซาลาโนวา</option><option>กรีนคอส</option><option>กรีนโอ๊ค</option>
                <option>กรีนโครอล</option><option>เรดโอ๊ค</option><option>เรดโครอล</option>
                <option>ฟิลไอซ์</option><option>ซอร์เรล</option><option>เคล</option>
                <option>ตั้งโอ๋</option><option>สวิสชาร์ด</option>
            </select>
        </div>

        <div class="form-group">
            <label for="inPlantQuantity"><i class="fas fa-sort-numeric-up"></i> จำนวนต้น</label>
            <input type="number" id="inPlantQuantity" class="form-input-deluxe" placeholder="เช่น 16">
        </div>

        <div class="form-group">
            <label for="inBatchId"><i class="fas fa-tag"></i> รหัสรุ่นการผลิต (Batch ID)</label>
            <input type="text" id="inBatchId" class="form-input-deluxe" placeholder="เช่น BK-020725-A">
        </div>

        <div class="form-group">
            <label for="inSeedingDate"><i class="fas fa-calendar-check"></i> วันที่เพาะเมล็ด</label>
            <input type="date" id="inSeedingDate" class="form-input-deluxe">
        </div>

        <div class="form-group full-width">
            <label for="inNotes"><i class="fas fa-edit"></i> หมายเหตุ</label>
            <textarea id="inNotes" class="form-input-deluxe" rows="4" placeholder="เพิ่มหมายเหตุที่เกี่ยวข้องที่นี่..."></textarea>
        </div>
      </div>

      <button class="form-button-action" onclick="handleInbound()">
          <i class="fas fa-check-circle"></i> ยืนยันและวางถาด
      </button>
    </div>
  `;
}
// [แก้ไข] หน้า Outbound ให้เลือกเฉพาะชั้น
function renderOutboundPage() {
  return `
    <div class="form-container-deluxe">
      <div class="form-header">
        <h2 class="form-title">
          <i class="fas fa-dolly-flatbed" style="color: #e63946;"></i>
          สร้างงานนำออก (Outbound)
        </h2>
        <p class="form-subtitle">เลือก "ชั้น" ที่ต้องการนำถาดออก ระบบจะเลือกถาดที่อยู่หน้าสุดให้โดยอัตโนมัติ</p>
      </div>

      <div class="form-grid" style="grid-template-columns: 1fr;">
        <div class="form-group">
            <label for="outFloor"><i class="fas fa-layer-group"></i> <strong>เลือกชั้น (Lane)</strong></label>
            <select id="outFloor" class="form-input-deluxe" onchange="validateOutboundFloor()">
                <option value="">-- กรุณาเลือกชั้น --</option>
                ${[...Array(9)].map((_, i) => `<option value="${i + 1}">ชั้น ${i + 1}</option>`).join('')}
            </select>
        </div>

        <div id="outboundValidationBox" class="form-group full-width" style="display: none;">
             </div>

        <div class="form-group">
            <label for="outReason"><i class="fas fa-question-circle"></i> เหตุผลการนำออก</label>
            <select id="outReason" class="form-input-deluxe" disabled>
                <option>ตัดแต่ง / เก็บเกี่ยวบางส่วน</option>
                <option>เก็บเกี่ยวทั้งหมด</option>
                <option>ตรวจสอบ / บำรุงรักษา</option>
                <option>กำจัดทิ้ง</option>
                <option>ย้ายตำแหน่งถาด</option>
            </select>
        </div>
        <div class="form-group">
            <label for="outDestination"><i class="fas fa-map-marked-alt"></i> ปลายทาง</label>
            <input type="text" id="outDestination" class="form-input-deluxe" placeholder="เช่น สถานีล้าง, โต๊ะแพ็ค" disabled>
        </div>
      </div>

      <button id="outboundConfirmBtn" class="form-button-action danger" onclick="handleOutbound()" disabled>
          <i class="fas fa-cogs"></i> ยืนยันและสร้างงาน
      </button>
    </div>
  `;
}
// ฟังก์ชันสร้าง select box สไตล์หรู
function createSelectBox(label, id, options) {
  return `
    <div>
      <label style="font-weight: 600; color: #444; display: block; margin-bottom: 8px;">${label}</label>
      <select id="${id}" style="
        width: 100%;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid rgba(0,0,0,0.08);
        background: rgba(255, 255, 255, 0.9);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        font-size: 1em;
        transition: border 0.2s;
      " onfocus="this.style.border='1px solid #4ade80'" onblur="this.style.border='1px solid rgba(0,0,0,0.08)'">
        ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
      </select>
    </div>
  `;
}


function renderTrayMasterPage() {
  const html = `
    <div class="card">
      <h2><i class="fas fa-database"></i> Tray Master - ฐานข้อมูลถาดทั้งหมด</h2>
      
      <div class="user-logs-filters" style="justify-content: flex-start; gap: 16px; align-items: flex-end;">
        
        <div>
          <label>ค้นหาทั่วไป</label>
          <input type="text" id="traySearchInput" placeholder="Tray ID, Batch ID, ชนิดผัก..." oninput="loadTrayMasterData()">
        </div>

        <div>
          <label>กรองตามสถานะ</label>
          <select id="trayStatusFilter" onchange="loadTrayMasterData()">
            <option value="">ทั้งหมด</option>
            <option value="on_shelf">ในคลัง</option>
            <option value="AT_WORKSTATION">ที่ Workstation</option>
          </select>
        </div>

        <div>
          <label>กรองตามชนิดผัก</label>
          <select id="trayVegFilter" onchange="loadTrayMasterData()">
            <option value="">ทั้งหมด</option>
            <option>Baby Kale</option><option>Baby Spinach</option><option>Baby Red Oak</option>
            <option>Baby Rocket</option><option>Baby Swiss Chard</option><option>บัตเตอร์เฮด</option>
            <option>สลัดเรดโอ๊ค</option><option>ซาลาโนวา</option><option>กรีนคอส</option><option>กรีนโอ๊ค</option>
            <option>กรีนโครอล</option><option>เรดโอ๊ค</option><option>เรดโครอล</option>
            <option>ฟิลไอซ์</option><option>ซอร์เรล</option><option>เคล</option>
            <option>ตั้งโอ๋</option><option>สวิสชาร์ด</option>
          </select>
        </div>
        
        <div>
            <button class="filter-btn" onclick="exportTrayMasterToExcel()" style="background-color: #10b981; color: white; padding: 12px 20px;">
                <i class="fas fa-file-excel"></i> ดาวน์โหลด Excel
            </button>
        </div>

      </div>

      <div style="overflow-x:auto;">
          <table class="styled-table">
              <thead>
                  <tr>
                      <th>Tray ID</th>
                      <th>Batch ID</th>
                      <th>ชนิดผัก</th>
                      <th>ตำแหน่ง</th>
                      <th>จำนวน</th>
                      <th>วันที่เพาะ</th>
                      <th>อายุ</th>
                      <th>สถานะ</th>
                      <th>หมายเหตุ</th>
                      <th>คำสั่ง</th>
                  </tr>
              </thead>
              <tbody id="trayMasterTableBody"></tbody>
          </table>
      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
}

function renderWorkstationPage() {
  const html = `
    <div class="card">
      <h2 style="display: flex; align-items: center; gap: 12px;">
        <i class="fas fa-dolly"></i> Workstation - สถานีจัดการถาด
      </h2>
      
      <div id="workstationDisplay">
          </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;

  
}
// ✅ รีเซตความสูงและ scroll ให้แน่ใจว่าแสดงผลหน้า Login ถูกต้อง
function showLoginPage() {
  const container = document.querySelector('.login-container');
  if (container) {
    container.style.height = 'auto';
    container.scrollIntoView({ behavior: 'smooth' });
  }
}

function renderTrayGridView() {
  return `
    <div class="section">
      
      <h2 style="display: flex; align-items: center; gap: 14px; margin-bottom: 20px; color: #1b4332; font-weight: 600;">
        <i class="fas fa-boxes-stacked" style="font-size: 1.6em; color: #8d6e63; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); transform: translateY(-2px);"></i>
        <span>คลังถาด - Tray Inventory</span>
      </h2>

      <div style="overflow-x: auto;">
        <div class="tray-grid" style="display: grid; grid-template-columns: auto repeat(18, 1fr); gap: 12px; padding: 20px;">
          ${generateTrayGridHTML()}
        </div>
      </div>
    </div>
  `;
}
// ✅ [Polished & Animated Edition] ฟังก์ชันสร้างแผนผัง Tray Inventory
function generateTrayGridHTML() {
  let html = "";
  const totalFloors = 8;
  const totalSlots = 18;

  // --- สร้างหัวคอลัมน์ ---
  html += `<div class="tray-header-cell"></div>`; 
  for (let slot = 1; slot <= totalSlots; slot++) {
    html += `<div class="tray-header-cell">ช่อง ${slot}</div>`;
  }

  // --- สร้างแถวและข้อมูล ---
  for (let floor = totalFloors; floor >= 1; floor--) {
    html += `<div class="tray-header-cell">ชั้น ${floor}</div>`;

    for (let slot = 1; slot <= totalSlots; slot++) {
      const key = `${floor}-${slot}`;
      const info = trayInventory[key];
      const isFilled = info && (info.status === 'on_shelf' || info.status === 'IN_STORAGE');
      
      const title = isFilled 
        ? `${info.veg_type} (ID: ${info.tray_id})\nวางเมื่อ: ${new Date(info.time_in).toLocaleString("th-TH")}` 
        : `ว่าง`;

      const onclickAction = isFilled 
        ? `showTrayInfoPopup({ 
             trayId: '${info.tray_id}', 
             username: '${info.username}', 
             veg: '${info.veg_type}', 
             floor: ${floor}, 
             slot: ${slot}, 
             timestamp: '${new Date(info.time_in).toLocaleString("th-TH")}', 
             age: calculateTrayAge('${info.time_in}') 
           })`
        : '';
      
      let cellContent = '';
      if (isFilled) {
        // ✅ เนื้อหาสำหรับช่องที่มีถาด (ดีไซน์ใหม่)
        cellContent = `
          <div class="filled-tray-icon"><i class="fas fa-leaf"></i></div>
          <div class="filled-tray-veg-name">${info.veg_type.substring(0, 12)}</div>
          <div class="filled-tray-id">${info.tray_id}</div>
        `;
      } else {
        // ✅ เนื้อหาสำหรับช่องว่าง
        cellContent = `<span class="empty-slot-coords">ชั้น ${floor} / ${slot}</span>`;
      }

      html += `
        <div class="tray-slot ${isFilled ? 'filled' : 'empty'}"
             title="${title}"
             onclick="${onclickAction}">
          ${cellContent}
        </div>`;
    }
  }
  return html;
}
// ✅✅✅ [FINAL VERSION] ฟังก์ชัน "จัดการหน้า" ที่มีการ Polling อัตโนมัติ ✅✅✅
let trayInventoryInterval = null; // ประกาศตัวแปรไว้นอกฟังก์ชันเพื่อใช้อ้างอิง
function showPage(page) {
  console.log(`🔄 Switching from ${currentPage} to ${page}`);
  
  // Cleanup before switching pages
  if (currentPage !== page) {
    cleanupCurrentPage();
  }
  
  currentPage = page;
  // Don't clear timers here - already done in cleanup
  setActiveSidebar(page);
 document.body.className = document.body.className.replace(/page-\w+/g, '');
    document.body.classList.add(`page-${page}`);
  const mainContent = document.getElementById("mainContent");
  mainContent.innerHTML = ""; // เคลียร์หน้าจอ
if (page === 'tray-map') {
    // 1. วาดโครงสร้างหลักของหน้า "เพียงครั้งเดียว"
    const initialHTML = `
        <div class="section">
          <h2 style="display: flex; align-items: center; gap: 14px; margin-bottom: 20px; color: #1b4332; font-weight: 600;">
            <i class="fas fa-boxes-stacked" style="font-size: 1.6em; color: #8d6e63; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); transform: translateY(-2px);"></i>
            <span>คลังถาด - Tray Inventory</span>
          </h2>
          <div style="overflow-x: auto;">
            <div class="tray-grid" style="display: grid; grid-template-columns: auto repeat(18, 1fr); gap: 12px; padding: 20px;">
              <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                  <i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...
              </div>
            </div>
          </div>
        </div>
    `;
    mainContent.innerHTML = initialHTML;

    // 2. สร้างฟังก์ชันสำหรับอัปเดต "เฉพาะตาราง"
    const refreshGridOnly = () => {
        loadTrayInventory().then(() => {
            const gridContainer = document.querySelector(".tray-grid");
            // ตรวจสอบว่ายังอยู่หน้านี้ และมี element '.tray-grid' อยู่จริง
            if (gridContainer && currentPage === 'tray-map') {
                gridContainer.innerHTML = generateTrayGridHTML(); // ✅ อัปเดตเฉพาะส่วนตาราง
            }
        });
    };

    // 3. เรียกใช้งานครั้งแรก และตั้งเวลา
    refreshGridOnly();
    const trayTimer = setInterval(refreshGridOnly, 5000); // ตั้งเวลาโหลดซ้ำทุก 5 วินาที
    activeTimers.push(trayTimer);

    return;
}

    if (page === 'tray-master') {
    renderTrayMasterPage();
    loadTrayMasterData();
    activeTimers.push(trayMasterTimer);
    return;
}

  if (page === 'light-control') {
    renderLightControlPage(); // วาดหน้าเว็บ Light Control
    startLightControlPolling(); // ✅ เริ่มการ Polling สถานะ UI จาก Backend
    return;
  }


/**
 * 💡 [NEW] Helper สร้างแถวควบคุม, onchange จะเรียก markFloorAsChanged
 */
function createControlRow(type, floor, icon, color) {
    return `
        <div class="control-row">
            <i class="fas ${icon} control-icon" style="color: ${color};"></i>
            <div class="slider-container">
                <input type="range" min="0" max="100" value="0" class="premium-slider device-slider"
                       onchange="markFloorAsChanged(${floor})"
                       oninput="updateSliderVisual(this, '${type}', ${floor})"
                       data-floor="${floor}" data-type="${type}" style="--fill-color: ${color};">
            </div>
            <span class="control-value" id="${type}-value-${floor}">0%</span>
            <button class="control-timer-btn" onclick="openIndividualTimerModal('${type}', ${floor})">
                <i class="fas fa-clock"></i>
            </button>
        </div>
    `;
}
if (page === 'workstation') {
    renderWorkstationPage(); 

    currentWorkstationState = null; // ✅ [เพิ่มบรรทัดนี้] เพื่อล้างสถานะเก่า

    checkWorkstationStatus(); 
    const workstationTimer = setInterval(checkWorkstationStatus, 3000);
    activeTimers.push(workstationTimer);

    return;
}
if (page === 'overview') {
    console.log('🔄 Loading Overview Page...');
    renderOverviewPage();
    return;
}


  if (page === 'tray-inbound') {
    html = renderInboundPage();
    document.getElementById("mainContent").innerHTML = html;
    return;
  }

  if (page === 'tray-outbound') {
    mainContent.innerHTML = renderOutboundPage();
    loadTrayInventory().then(() => {
      // ✅ แก้จาก checkOutboundSlot() เป็น validateOutboundFloor()
      validateOutboundFloor(); 
    });
    const outboundTimer = setInterval(() => {
      loadTrayInventory().then(() => {
        if (currentPage === 'tray-outbound') {
          // ✅ แก้จาก checkOutboundSlot() เป็น validateOutboundFloor()
          validateOutboundFloor();
        }
      });
    }, 5000);
    activeTimers.push(outboundTimer);
    return;
  }

  if (page === 'task') {
    renderTaskPage();
    loadTaskMonitor(); // โหลดข้อมูลทันที
    
    // เริ่ม polling
    const taskTimer = setInterval(loadTaskMonitor, 2000);
    activeTimers.push(taskTimer);
    return;
  }

// แก้ไขใน index.html
function renderTaskPage() {
  const html = `
    <div class="task-monitor-enhanced">
      <h2><i class="fas fa-tasks"></i> รายการงานที่กำลังดำเนินการ</h2>
      <div class="task-stats-row">
        <div class="stat-card">
          <i class="fas fa-clock"></i>
          <div>
            <span class="stat-number" id="pendingCount">0</span>
            <span class="stat-label">รอดำเนินการ</span>
          </div>
        </div>
        <div class="stat-card">
          <i class="fas fa-cogs"></i>
          <div>
            <span class="stat-number" id="workingCount">0</span>
            <span class="stat-label">กำลังทำงาน</span>
          </div>
        </div>
        <div class="stat-card">
          <i class="fas fa-check-circle"></i>
          <div>
            <span class="stat-number" id="successCount">0</span>
            <span class="stat-label">สำเร็จแล้ว</span>
          </div>
        </div>
      </div>
      <table class="task-table-enhanced">
        <thead>
          <tr>
            <th><i class="fas fa-qrcode"></i> รหัสถาด</th>
            <th><i class="fas fa-layer-group"></i> ชั้น</th>
            <th><i class="fas fa-grip-vertical"></i> ช่อง</th>
            <th><i class="fas fa-info-circle"></i> สถานะ</th>
            <th><i class="fas fa-play"></i> เวลาเริ่ม</th>
            <th><i class="fas fa-check"></i> เวลาสำเร็จ</th>
            <th><i class="fas fa-tag"></i> ประเภท</th>
            <th><i class="fas fa-user"></i> ผู้ใช้</th>
          </tr>
        </thead>
        <tbody id="taskTableBody"></tbody>
      </table>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadTaskMonitor();
}



 if (page === 'task-history') {
    renderTaskHistoryPage();
    loadTaskHistory(); // โหลดข้อมูลทันที
    return;
  }
  
function renderTaskHistoryPage() {
  const html = `
    <div class="task-monitor-enhanced">
      <h2><i class="fas fa-history"></i> ประวัติคำสั่งงานทั้งหมด</h2>
      
      <!-- 📊 สถิติย่อ -->
      <div class="task-stats-overview">
        <div class="stat-card-mini">
          <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
          <div class="stat-number" id="todayTaskCount">-</div>
          <div class="stat-label">วันนี้</div>
        </div>
        <div class="stat-card-mini">
          <div class="stat-icon"><i class="fas fa-arrow-down"></i></div>
          <div class="stat-number" id="inboundCount">-</div>
          <div class="stat-label">งานเข้า</div>
        </div>
        <div class="stat-card-mini">
          <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
          <div class="stat-number" id="outboundCount">-</div>
          <div class="stat-label">งานออก</div>
        </div>
        <div class="stat-card-mini">
          <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
          <div class="stat-number" id="successCount">-</div>
          <div class="stat-label">สำเร็จ</div>
        </div>
        <div class="stat-card-mini">
          <div class="stat-icon"><i class="fas fa-clock"></i></div>
          <div class="stat-number" id="pendingCount">-</div>
          <div class="stat-label">รอดำเนินการ</div>
        </div>
      </div>
      <div class="history-controls">
        <div class="search-box">
          <input type="text" id="historySearch" placeholder="ค้นหาด้วยรหัสถาด หรือ ผู้ใช้...">
          <i class="fas fa-search"></i>
        </div>
        <select id="historyFilter">
          <option value="">ทั้งหมด</option>
          <option value="inbound">นำเข้า</option>
          <option value="outbound">นำออก</option>
        </select>
        
     <button class="filter-btn" onclick="openExportModal()" style="background-color: #10b981; color: white;">
    <i class="fas fa-file-excel"></i> ดาวน์โหลด Excel
</button>
    <div class="excel-dropdown-menu" id="excelDropdown">
        <a href="#" onclick="exportTaskHistoryToExcel('today')">เฉพาะข้อมูลวันนี้</a>
        <a href="#" onclick="exportTaskHistoryToExcel('all')">ข้อมูลทั้งหมด</a>
    </div>
</div>
      </div>
      <div class="table-responsive-wrapper">
          <table class="task-table-enhanced">
            <thead>
              <tr>
                <th>รหัสถาด</th>
                <th>ชั้น</th>
                <th>ช่อง</th>
                <th>สถานะ</th>
                <th>เวลาเริ่ม</th>
                <th>เวลาสำเร็จ</th>
                <th>ประเภท</th>
                <th>ผู้ใช้</th>
              </tr>
            </thead>
            <tbody id="taskHistoryTableBody">
                <tr><td colspan="8" style="text-align:center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...
                </td></tr>
            </tbody>
          </table>
      </div>
      
      <div class="pagination-container" id="taskHistoryPagination"></div>

    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  
  // เรียกใช้ฟังก์ชันหลักเมื่อวาดหน้าเสร็จ
  initTaskHistoryPage();
  setupHistoryEventListeners();
}
 



  if (page === 'tray') {
    renderTrayManagement();
    return;
  }
if (page === 'lift') {
  const currentFloor = parseInt(localStorage.getItem('currentFloor')) || 1;

  html = `

<div id="liftStatusBox" class="lift-status success">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="margin-right: 12px;">
    <circle cx="12" cy="12" r="10" fill="#2dcc6f"/>
    <path d="M9 12.5l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  ระบบทำงานปกติ
</div>




<div id="liftToast" style="position: fixed; top: 20px; right: 20px; background: #333; color: white; padding: 12px 20px; border-radius: 8px; font-weight: bold; z-index: 9999; display: none;">
  <span id="liftToastMessage"></span>
</div>


    <div class="section">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
        <i class="fas fa-elevator" style="font-size: 1.8rem; color: #2d6a4f;"></i>
        <h2 style="margin: 0; font-size: 1.8rem; font-weight: 600; color: #1b4332;">Lift Control</h2>
      </div>

      <div style="display: flex; align-items: flex-start; gap: 40px; max-width: 1100px; margin: auto;">

        <!-- 🔲 รูปลิฟต์ -->
        <div style="position: relative; width: 260px; height: 600px; border-radius: 12px; overflow: hidden;">
          <img src="lift_9levels.png.jpg" alt="Lift Structure"
               style="width: 100%; height: 100%; object-fit: contain;" />
          <img id="liftCart" src="lift_cart.png.png" alt="Lift Cart"
               style="position: absolute; left: 50%; transform: translateX(-50%);
                      width: 86%; transition: top 0.05s linear; z-index: 10;" />
        </div>

        <!-- 🔢 LEVEL INDICATOR -->
        <div style="height: 600px; display: flex; flex-direction: column; justify-content: space-around;
                    background: #e6f4ea; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <h4 style="text-align:center; margin-bottom: 12px; color: #2d6a4f;">สถานะลิฟต์<br>(LEVEL)</h4>
          ${[...Array(9)].map((_, i) => {
            const level = 8 - i;
            return `<div id="floor-${level}" style="margin: 6px 0; display: flex; align-items: center;">
                      <span data-light style="display:inline-block; width: 16px; height: 16px; border-radius: 50%; 
                           background: #ccc; margin-right: 8px; transition: all 0.3s;"></span>
                      <span style="color: #2d6a4f; font-weight: 600;">ชั้น ${level}</span>
                    </div>`;
          }).join('')}
        </div>

        <!-- 🔘 ปุ่มควบคุม -->
        <div style="min-width: 180px;">
          <div id="currentFloorDisplay"
            style="margin-bottom: 16px; padding: 12px; background: #d8f3dc; color: #1b4332;
                   border: 2px solid #52b788; border-radius: 12px; font-size: 1.1rem; font-weight: bold;
                   text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
            ลิฟต์อยู่ที่ชั้น: <span id="currentFloor">${currentFloor}</span>
          </div>

          <label for="floorSelect" style="font-weight: bold;">เลือกชั้น:</label>
          <select id="floorSelect" style="padding: 8px; width: 100%; margin: 10px 0;">
            ${[...Array(8)].map((_, i) => `<option value="${i + 1}">ชั้น ${i + 1}</option>`).join('')}
          </select>
          <button onclick="moveLift()" 
            style="padding: 10px 20px; background: #2d6a4f; color: white; border: none; border-radius: 6px; width: 100%; cursor: pointer;">
            ย้ายลิฟต์
          </button>

          <div style="margin-top: 20px; padding: 16px; background: #f0fdf4; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <h4 style="color: #1b4332; margin-bottom: 16px;">ควบคุมแบบ Manual</h4>
            <button class="manual-btn"
              onmousedown="startLiftMove('up')"
              onmouseup="stopLiftMove()"
              onmouseleave="stopLiftMove()">
              <i class="fas fa-arrow-up"></i> ขึ้น
            </button>
            <button class="manual-btn"
              onmousedown="startLiftMove('down')"
              onmouseup="stopLiftMove()"
              onmouseleave="stopLiftMove()">
              <i class="fas fa-arrow-down"></i> ลง
            </button>
             <!-- ✅ กล่อง EMERGENCY ที่จัดรูปแบบเหมือนกล่อง Manual -->
<div style="margin-top: 20px; padding: 16px; background: #fff5f5;
            border-radius: 16px; width: 220px; text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #f5c2c7;">
  <h4 style="color: #c1121f; margin-bottom: 16px;">ปุ่มฉุกเฉิน (EMERGENCY)</h4>
  <button id="emButton" onclick="toggleEmergency()"
    style="padding: 12px 20px; font-weight: bold; border: none; border-radius: 8px;
           background: #c1121f; color: white; font-size: 1rem; width: 100%; cursor: pointer;">
    ⛔ หยุดลิฟต์ทันที
  </button>
</div>
          </div>
        </div>
      </div>
    </div>
  `;

  document.getElementById("mainContent").innerHTML = html;

  // ✅ เรียกใช้งานเมื่อโหลดเสร็จ
  initLiftPage();
    connectMqttLift();        // ✅ เพิ่มตรงนี้
  return;
}
function connectMqttLift() {
  client.subscribe("automation/station1/lift/status", (err) => {
    if (err) {
      console.error("❌ MQTT subscribe failed:", err.message);
    } else {
      console.log("✅ MQTT subscribed to automation/station1/lift/status");
    }
  });

  client.on("message", (topic, message) => {
    if (topic === "automation/station1/lift/status") {
      try {
        const data = JSON.parse(message.toString());
        currentLiftFloor = data.floor;
        isLiftMoving = data.moving;
        isEmergency = data.emergency || false;

        // ✅ Sync UI
        updateLiftDisplay(currentLiftFloor);

        const floorDisplay = document.getElementById("currentFloor");
        if (floorDisplay) floorDisplay.innerText = currentLiftFloor;

        const movingStatus = document.getElementById("movingStatus");
        if (movingStatus) movingStatus.innerText = isLiftMoving ? "กำลังเคลื่อนที่..." : "หยุดนิ่ง";

        const statusBox = document.getElementById("liftStatusBox");
        if (statusBox) {
          statusBox.innerText = isEmergency ? "🚨 ลิฟต์ทำงานผิดปกติ" : "🟢 ระบบทำงานปกติ";
        }

      } catch (e) {
        console.error("MQTT parse error:", e);
      }
    }
  });
}
function renderAgvPage() {
  return `
    <div class="section">
      <h2><i class="fas fa-truck-moving"></i> RGV Control</h2>

      <!-- ✅ กล่องสถานะ AGV แบบพรีเมียม -->
      <div id="agvTaskStatus">
        <div class="agv-status-box" style="--boxColor: #0ea5e9;">
          <div class="agv-status-title">
            <i class="fas fa-spinner fa-spin"></i> กำลังโหลดสถานะ...
          </div>
          <div class="agv-status-desc">
            กรุณารอสถานะจากระบบ AGV
          </div>
        </div>
      </div>

      <!-- ✅ Sensor Tags -->
      <div class="sensor-status" id="agvSensorStatus">
        <div class="sensor-tag" id="sensorTray">
          <i class="fas fa-eye"></i> เซ็นเซอร์ถาด: <span>กำลังโหลด...</span>
        </div>
        <div class="sensor-tag" id="sensorPos1">
          <i class="fas fa-location-arrow"></i> ระบุตำแหน่ง 1: <span>กำลังโหลด...</span>
        </div>
        <div class="sensor-tag" id="sensorPos2">
          <i class="fas fa-location-arrow"></i> ระบุตำแหน่ง 2: <span>กำลังโหลด...</span>
        </div>
      </div>

      <!-- ✅ กล้อง RGV -->
      <h3><i class="fas fa-video"></i> กล้อง RGV (Real-Time)</h3>
      <div class="camera-section">
        <!-- กล้องหน้า RGV (หมุนซ้าย) -->
        <div class="camera-box">
          <img src="/api/camera/stream/CAM001" class="rotate-left" />
          <div class="camera-label">
            <i class="fas fa-video"></i> กล้องหน้า RGV
          </div>
        </div>

        <!-- กล้องด้านล่าง RGV -->
        <div class="camera-box">
          <img src="/api/camera/stream/CAM002" class="camera-image" />
          <div class="camera-label">
            <i class="fas fa-video"></i> กล้องด้านล่าง RGV
          </div>
        </div>
      </div>

      <!-- ✅ Manual AGV Control -->
      <h3 style="margin-top: 40px;"><i class="fas fa-tools"></i> Manual AGV Control (MQTT)</h3>
      <div class="main-buttons">
        <button class="btn-premium" onclick="sendAgvCommand('go_lift')">Manual ไป Lift</button>
        <button class="btn-premium" onclick="sendAgvCommand('go_home')">Manual กลับ Home</button>
        <button class="btn-premium" onclick="sendTrayCommand('tray_up')">Manual ยกถาด</button>
        <button class="btn-premium" onclick="sendTrayCommand('tray_down')">Manual วางถาด</button>
      </div>

      <div class="dropdown" style="margin-top: 20px;">
        <label for="slotSelectManual"><strong>เลือกช่องปลายทาง (Manual)</strong></label><br/>
        <select id="slotSelectManual" class="dropdown-select">
          <option value="">เลือกช่อง</option>
          ${[...Array(17)].map((_, i) => `<option value="${i + 1}">ช่อง ${i + 1}</option>`).join('')}
        </select>
        <button class="btn-premium" onclick="handleSlotManual()">ส่ง Manual Slot</button>
      </div>
    </div>
  `;
}

if (page === 'agv') {
  const html = renderAgvPage();
  document.getElementById("mainContent").innerHTML = html;
  
  const agvStatusEl = document.getElementById('agvTaskStatus');

  // [แก้ไข] ฟังก์ชัน renderPrettyStatus ที่ปรับปรุงใหม่ทั้งหมด
  function renderPrettyStatus(status) {
    // [แก้ไข] ปรับปรุง Regular Expression ให้แยกตัวเลขข้างท้ายได้แม่นยำขึ้น
    const match = status.match(/^(.*?)(?:_(\d+))?$/);
    const base = match?.[1] || status;
    const suffix = match?.[2] ? parseInt(match[2]) : null;

    switch (base) {
      // --- สถานะทั่วไป ---
      case "idle":
        return { title: " ระบบพร้อมใช้งาน (Idle)", desc: "AGV และระบบควบคุมพร้อมรับคำสั่งใหม่", color: "#28a745", icon: "fas fa-pause-circle" };
      case "unknown":
        return { title: "กำลังเชื่อมต่อ...", desc: "กำลังรอรับสถานะเริ่มต้นจากระบบ AGV", color: "#0ea5e9", icon: "fas fa-satellite-dish" };
      case "flow_done":
      case "done":
        return { title: " งานเสร็จสมบูรณ์", desc: "AGV ทำภารกิจสำเร็จและกลับสู่สถานะ Idle", color: "#198754", icon: "fas fa-check-circle" };
      case "error":
        return { title: " เกิดข้อผิดพลาด", desc: "การทำงานล้มเหลว กรุณาตรวจสอบระบบ", color: "#dc3545", icon: "fas fa-exclamation-circle" };

      // --- [เพิ่ม] สถานะสำหรับงานที่รออยู่ที่ Workstation ---
      case "at_workstation":
        return { title: "มีถาดรออยู่ที่ Workstation", desc: "กรุณาจัดการถาดที่โต๊ะปฏิบัติงาน", color: "#fd7e14", icon: "fas fa-box-open" };

      // --- สถานะจาก Flow State ---
      case "inbound_start_lift_tray":
      case "inbound_wait_for_tray_lift":
        return { title: "กำลังยกถาด (Inbound)", desc: "AGV กำลังยกถาดขึ้นเพื่อเริ่มงานนำเข้า", color: "#ffc107", icon: "fas fa-arrow-alt-circle-up" };
      case "start": // (Outbound)
        return { title: "กำลังเริ่มงานนำออก (Outbound)", desc: `AGV เริ่มเคลื่อนที่ไปยังช่องที่ ${suffix || '...'}`, color: "#17a2b8", icon: "fas fa-route" };
      case "wait_agv_at_lift":
        return { title: "AGV กำลังไปที่ลิฟต์", desc: "รอ AGV เคลื่อนที่ไปถึงตำแหน่งลิฟต์", color: "#6610f2", icon: "fas fa-parking" };
      case "lift_moving_up":
        return { title: "ลิฟต์กำลังขึ้น", desc: "ลิฟต์กำลังเคลื่อนที่ขึ้นไปยังชั้นเป้าหมาย", color: "#0dcaf0", icon: "fas fa-arrow-up" };
      case "lift_moving_down":
        return { title: "ลิฟต์กำลังลง", desc: "ลิฟต์กำลังเคลื่อนที่ลงไปยังชั้น 2", color: "#0d6efd", icon: "fas fa-arrow-down" };
      case "wait_agv_at_slot":
        return { title: "AGV กำลังไปที่ช่องจัดเก็บ", desc: `รอ AGV เคลื่อนที่ไปถึงช่องที่ ${suffix || '...'}`, color: "#198754", icon: "fas fa-map-marker-alt" };
      case "wait_tray_action_done":
        return { title: "AGV กำลังทำงานกับถาด", desc: "รอ AGV ยก/วางถาดให้เสร็จสิ้นที่ช่องเป้าหมาย", color: "#fd7e14", icon: "fas fa-cogs" };
      case "wait_agv_return_to_lift":
        return { title: "AGV กำลังกลับไปที่ลิฟต์", desc: "รอ AGV เดินทางจากช่องกลับมาที่ลิฟต์", color: "#007bff", icon: "fas fa-undo-alt" };
      case "wait_agv_home":
        return { title: "AGV กำลังกลับฐาน", desc: "รอ AGV เดินทางกลับสู่จุดเริ่มต้น (Home)", color: "#6c757d", icon: "fas fa-home" };
      case "outbound_wait_for_final_place":
        return { title: "AGV กำลังวางถาดที่ Workstation", desc: "รอ AGV วางถาดที่ตำแหน่ง Home หลังจบงาน Outbound", color: "#20c997", icon: "fas fa-box-open" };

      // --- สถานะจากตัว AGV โดยตรง (Fallback) ---
      case "moving_to_lift":
        return { title: "กำลังเคลื่อนที่ไปลิฟต์", desc: "สถานะจาก AGV: กำลังไปที่ลิฟต์", color: "#6610f2", icon: "fas fa-parking" };
      case "arrived_at_lift": // [เพิ่ม] สถานะ AGV ถึงลิฟต์ เพื่อความสมบูรณ์
        return { title: "ถึงลิฟต์แล้ว", desc: "AGV ถึงตำแหน่งลิฟต์เรียบร้อย", color: "#6f42c1", icon: "fas fa-check-circle" };
      case "moving_to_slot":
      case "agv_moving_to_slot":
        return { title: "กำลังไปยังช่องจัดเก็บ", desc: suffix ? `AGV กำลังไปยังช่องที่ ${suffix}` : "AGV กำลังไปยังช่องจัดเก็บ", color: "#17a2b8", icon: "fas fa-route" };
      case "arrived_at_slot":
      case "agv_arrived_at_slot":
        return { title: "ถึงช่องจัดเก็บแล้ว", desc: suffix ? `AGV ถึงช่องที่ ${suffix} เรียบร้อย` : "AGV ถึงช่องจัดเก็บเรียบร้อย", color: "#198754", icon: "fas fa-check-circle" };
      case "arrived_at_home":
        return { title: "ถึงฐาน (Home) แล้ว", desc: "AGV กลับถึงที่หมายและพร้อมสำหรับงานต่อไป", color: "#28a745", icon: "fas fa-parking" };

      // --- สถานะ Default ---
      default:
        return { title: "กำลังประมวลผล...", desc: `สถานะปัจจุบัน: ${status}`, color: "#adb5bd", icon: "fas fa-spinner fa-spin" };
    }
  }

  // ฟังก์ชันดึงสถานะหลักของ AGV (เหมือนเดิม)
  async function fetchAgvStatus() {
    try {
      const res = await fetch(`/api/agv/status?_t=${new Date().getTime()}`);
      const data = await res.json();
      const rawStatus = data.status || 'unknown';
      const pretty = renderPrettyStatus(rawStatus);

      const isGlowingStatus = [
        'working', 'moving', 'processing', 'moving_to_slot', 'moving_to_lift', 
        'lift_moving_up', 'lift_moving_down', 'pickup_tray', 'wait_agv_at_lift', 
        'wait_agv_at_slot', 'wait_tray_action_done', 'wait_agv_return_to_lift', 
        'wait_agv_home'
      ].includes(pretty.base || rawStatus);

      agvStatusEl.innerHTML = `
        <div class="agv-status-box ${isGlowingStatus ? 'glow' : ''}" style="--boxColor: ${pretty.color || '#999'}">
          <div class="agv-status-title">
            <i class="${pretty.icon || 'fas fa-question-circle'}"></i> ${pretty.title || 'ไม่มีสถานะ'}
          </div>
          <div class="agv-status-desc">${pretty.desc || 'ไม่มีรายละเอียดเพิ่มเติม'}</div>
        </div>
      `;
    } catch (err) {
      agvStatusEl.innerHTML = `
        <div class="agv-status-box error">
          <div class="agv-status-title"><i class="fas fa-exclamation-triangle"></i> ไม่สามารถโหลดสถานะได้</div>
          <div class="agv-status-desc">กรุณาตรวจสอบการเชื่อมต่อกับระบบ AGV</div>
        </div>
      `;
      console.error('[AGV Status Error]', err);
    }
  }

  // [เพิ่มส่วนนี้] เรียกสถานะเซ็นเซอร์ทุก 1 วินาที
  fetchAgvStatus(); // เรียกสถานะหลักครั้งแรก
  const agvStatusTimer = setInterval(fetchAgvStatus, 2000);
  activeTimers.push(agvStatusTimer);

  // ✅ ใช้ WebSocket สำหรับ sensor data พร้อม fallback
  initSensorWebSocket();
  fetchAgvSensorStatus(); // เรียกสถานะเซ็นเซอร์ครั้งแรก
  
  // เริ่ม fallback polling ในกรณีที่ WebSocket ใช้งานไม่ได้
  setTimeout(() => {
    if (!isWebSocketConnected) {
      console.log('⚠️ WebSocket not connected, starting fallback polling');
      startSensorFallback();
    }
  }, 2000);

  return;
}


  if (page === 'system') {
    html = `
      <div class="section">
        <h2 style="margin-bottom: 20px; color:#2d6a4f;">🔧 System Monitor</h2>
        <div id="systemStatus" style="display: flex; gap: 20px; flex-wrap: wrap;"></div>
      </div>
    `;
    document.getElementById("mainContent").innerHTML = html;
    return;
  }

  if (page === 'environment') {
    html = `
      <div class="section">
        <h2 style="color: #2d6a4f;">📊 Environmental Data (Real-Time)</h2>
        <canvas id="co2Chart" style="max-height: 300px;"></canvas>
        <canvas id="tempChart" style="max-height: 300px; margin-top: 30px;"></canvas>
        <canvas id="humidityChart" style="max-height: 300px; margin-top: 30px;"></canvas>
      </div>
    `;
    document.getElementById("mainContent").innerHTML = html;
    setupEnvironmentCharts();
    if (window.environmentInterval) clearInterval(window.environmentInterval);
    window.environmentInterval = setInterval(updateEnvironmentCharts, 5000);
    return;

  }if (page === 'planting-plan') {
  renderPlantingPlanPage();
  return;
}

function renderPlantingPlanPage() {
  const html = `
    <!-- Dashboard Overview -->
    <div class="wms-dashboard-header">
      <div class="dashboard-title">
        <h1><i class="fas fa-industry"></i> ระบบวางแผนการผลิต PFAL</h1>
        <p>เชื่อมต่อกับระบบ ERP - จัดการการผลิตแบบเรียลไทม์</p>
      </div>
      <div class="dashboard-stats">
        <div class="stat-item">
          <div class="stat-value" id="totalPlans">-</div>
          <div class="stat-label">แผนทั้งหมด</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="activeTasks">-</div>
          <div class="stat-label">งานที่กำลังทำ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="completionRate">-</div>
          <div class="stat-label">อัตราความสำเร็จ</div>
        </div>
      </div>
    </div>

    <!-- Control Panel -->
    <div class="wms-control-panel">
      <div class="control-section">
        <h3><i class="fas fa-download"></i> การเชื่อมต่อ ERP</h3>
        <button onclick="loadPlantingPlans()" class="btn btn-primary">
          <i class="fas fa-sync-alt"></i> ดึงข้อมูลจาก ERP
        </button>
        <button onclick="showAddPlanModal()" class="btn btn-success">
          <i class="fas fa-plus"></i> เพิ่มข้อมูลเอง
        </button>
        <button onclick="exportPlans()" class="btn btn-info">
          <i class="fas fa-file-export"></i> ส่งออกข้อมูล
        </button>
      </div>
      
      <div class="control-section">
        <h3><i class="fas fa-filter"></i> กรองข้อมูล</h3>
        <select id="levelFilter" onchange="filterData()" class="form-select">
          <option value="">ทุกชั้น</option>
          <option value="1">ชั้น 1</option>
          <option value="2">ชั้น 2</option>
          <option value="3">ชั้น 3</option>
        </select>
        <select id="statusFilterMain" onchange="filterData()" class="form-select">
          <option value="">ทุกสถานะ</option>
          <option value="received">ได้รับแล้ว</option>
          <option value="processed">ประมวลผลแล้ว</option>
          <option value="in_production">กำลังผลิต</option>
        </select>
      </div>

      <div class="control-section">
        <h3><i class="fas fa-bell"></i> สถานะระบบ</h3>
        <div class="status-indicator">
          <span class="status-dot online" id="erpStatus"></span>
          <span>การเชื่อมต่อ ERP</span>
        </div>
        <div class="status-indicator">
          <span class="status-dot online" id="dbStatus"></span>
          <span>ฐานข้อมูล</span>
        </div>
      </div>
    </div>

    <!-- Production Plans from ERP -->
    <div class="wms-section">
      <div class="section-header">
        <h2><i class="fas fa-seedling"></i> แผนการผลิต (ซิงค์จาก ERP)</h2>
        <div class="section-actions">
          <span class="last-sync">ซิงค์ครั้งล่าสุด: <span id="lastSyncTime">ยังไม่เคย</span></span>
        </div>
      </div>
      
      <div class="table-container">
        <table class="wms-table">
          <thead>
            <tr>
              <th>รหัสแผน</th>
              <th>ชื่อผลิตภัณฑ์</th>
              <th>ชั้น</th>
              <th>วันที่ปลูก</th>
              <th>วันเก็บเกี่ยว</th>
              <th>จำนวน</th>
              <th>พันธุ์</th>
              <th>สถานะ ERP</th>
              <th>วันที่ได้รับ</th>
              <th>การจัดการ</th>
            </tr>
          </thead>
          <tbody id="plantingPlanTableBody">
            <tr><td colspan="10" class="no-data">ไม่มีข้อมูล - กดปุ่ม "ดึงข้อมูลจาก ERP" เพื่อโหลด</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Work Orders Management -->
    <div class="wms-section">
      <div class="section-header">
        <h2><i class="fas fa-clipboard-list"></i> การจัดการใบงาน</h2>
        <div class="section-actions">
          <button onclick="createWorkOrdersFromPlans()" class="btn btn-warning">
            <i class="fas fa-magic"></i> สร้างใบงานอัตโนมัติ
          </button>
          <button onclick="showCreateWorkOrderModal()" class="btn btn-success">
            <i class="fas fa-plus"></i> สร้างใบงานใหม่
          </button>
        </div>
      </div>

      <div class="filter-bar">
        <select id="taskTypeFilter" onchange="loadWorkOrders()" class="form-select">
          <option value="">ทุกประเภทงาน</option>
          <option value="planting">งานปลูก</option>
          <option value="harvest">งานเก็บเกี่ยว</option>
          <option value="maintenance">งานบำรุงรักษา</option>
        </select>
        <select id="statusFilter" onchange="loadWorkOrders()" class="form-select">
          <option value="">ทุกสถานะ</option>
          <option value="pending">รอดำเนินการ</option>
          <option value="in_progress">กำลังทำ</option>
          <option value="completed">เสร็จแล้ว</option>
          <option value="cancelled">ยกเลิก</option>
        </select>
        <select id="priorityFilter" onchange="loadWorkOrders()" class="form-select">
          <option value="">ทุกระดับความสำคัญ</option>
          <option value="urgent">เร่งด่วน</option>
          <option value="high">สูง</option>
          <option value="normal">ปกติ</option>
          <option value="low">ต่ำ</option>
        </select>
      </div>
      
      <div class="table-container">
        <table class="wms-table">
          <thead>
            <tr>
              <th>เลขที่ใบงาน</th>
              <th>ประเภทงาน</th>
              <th>ผลิตภัณฑ์</th>
              <th>ชั้น</th>
              <th>วันกำหนดส่ง</th>
              <th>จำนวน</th>
              <th>ผู้รับผิดชอบ</th>
              <th>ความสำคัญ</th>
              <th>สถานะ</th>
              <th>ความคืบหน้า</th>
              <th>การจัดการ</th>
            </tr>
          </thead>
          <tbody id="workOrderTableBody">
            <tr><td colspan="11" class="no-data">ไม่มีใบงาน</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Add Plan Modal -->
    <div id="addPlanModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-plus"></i> เพิ่มแผนการผลิต</h3>
          <span class="close" onclick="closeAddPlanModal()">&times;</span>
        </div>
        <form id="addPlanForm" onsubmit="submitPlan(event)">
          <div class="form-grid">
            <div class="form-group">
              <label>ชื่อผลิตภัณฑ์</label>
              <input type="text" id="vegetableName" required placeholder="เช่น ผักกาดหอม">
            </div>
            <div class="form-group">
              <label>ชั้น</label>
              <select id="level" required>
                <option value="">เลือกชั้น</option>
                <option value="1">ชั้น 1</option>
                <option value="2">ชั้น 2</option>
                <option value="3">ชั้น 3</option>
              </select>
            </div>
            <div class="form-group">
              <label>วันที่ปลูก</label>
              <input type="date" id="plantingDate" required>
            </div>
            <div class="form-group">
              <label>วันเก็บเกี่ยว</label>
              <input type="date" id="harvestDate" required>
            </div>
            <div class="form-group">
              <label>จำนวน (ต้น)</label>
              <input type="number" id="plantCount" min="1" required placeholder="100">
            </div>
            <div class="form-group">
              <label>พันธุ์</label>
              <input type="text" id="variety" placeholder="ระบุพันธุ์ (ถ้ามี)">
            </div>
          </div>
          <div class="modal-actions">
            <button type="button" onclick="closeAddPlanModal()" class="btn btn-secondary">ยกเลิก</button>
            <button type="submit" class="btn btn-primary">สร้างแผน</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  
  // Initialize page
  updateDashboardStats();
  loadPlantingPlans();
  loadWorkOrders();
  updateLastSyncTime();
}

if (page === 'planting-history') {
  renderPlantingHistoryPage();
  return;
}

function renderPlantingHistoryPage() {
  const html = `
    <div class="card">
      <h2><i class="fas fa-book-open"></i> ประวัติการปลูกย้อนหลัง</h2>
      <table class="styled-table">
        <thead>
          <tr>
            <th>ชื่อผัก</th>
            <th>ชั้น</th>
            <th>ช่อง</th>
            <th>วันที่วาง</th>
            <th>วันเก็บเกี่ยว</th>
            <th>วันที่นำออก</th>
            <th>หมายเหตุ</th>
          </tr>
        </thead>
        <tbody id="plantingHistoryTableBody"></tbody>
      </table>
      <div id="historyPagination" class="pagination"></div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadPlantingHistoryMock(); // ใช้ mock ก่อน เชื่อม SQL ทีหลัง
}

if (page === 'user-logs') {
    renderUserLogsPage();
    return;
}

// ✅ อัปเดตฟังก์ชัน renderUserLogsPage
function renderUserLogsPage() {
    const html = `
        <div class="section">
            <h2><i class="fas fa-terminal"></i> กิจกรรมผู้ใช้ (User Logs)</h2>
            <div class="user-logs-filters">
                <div><label>ค้นหา:</label><input type="text" id="logSearchInput" placeholder="ชื่อผู้ใช้ / การกระทำ / เวลา"></div>
                <div>
                    <label>ประเภท:</label>
                    <select id="logCategoryFilter">
                        <option value="">ทั้งหมด</option>
                        <option value="เข้าสู่ระบบ">เข้าสู่ระบบ</option>
                        <option value="ถาดเข้า">ถาดเข้า</option>
                        <option value="ถาดออก">ถาดออก</option>
                        <option value="ลิฟต์">ลิฟต์</option>
                        <option value="AGV">AGV</option>
                    </select>
                </div>
                <div><button onclick="exportLogsToExcelWithLogo()">ดาวน์โหลด Excel</button></div>
            </div>
            <div id="logCardsContainer" class="log-cards-container"></div>
            <div id="pagination"></div>
        </div>
    `;
    document.getElementById("mainContent").innerHTML = html;
    
    // เรียกใช้ฟังก์ชันใหม่
    initUserLogsPage();
}

if (page === 'user-management') {
    renderUserManagementPage();
    return;
}


// ฟังก์ชันหลักสำหรับ render หน้า User Management
function renderUserManagementPage() {
    const html = `
        <div class="user-management-page">
            <!-- Header Section -->
            <div class="user-management-header">
                <div class="header-top">
                    <div class="header-title">
                        <i class="fas fa-users-cog"></i>
                        <h2>จัดการผู้ใช้งาน</h2>
                    </div>
                    <button class="btn-add-user" onclick="showAddUserModal()">
                        <i class="fas fa-user-plus"></i> เพิ่มผู้ใช้ใหม่
                    </button>
                </div>
                
                <!-- Stats Cards -->
                <div class="user-stats" id="userStats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h4>ผู้ใช้ทั้งหมด</h4>
                            <p id="totalUsers">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="stat-info">
                            <h4>ออนไลน์</h4>
                            <p id="onlineUsers">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="stat-info">
                            <h4>ผู้ดูแลระบบ</h4>
                            <p id="adminUsers">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h4>เพิ่มใหม่วันนี้</h4>
                            <p id="newUsers">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div class="search-filter-section">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" 
                           class="search-input" 
                           id="userSearchInput"
                           placeholder="ค้นหาด้วยชื่อผู้ใช้..." 
                           onkeyup="handleSearch(event)">
                </div>
                
                <div class="filter-group">
                    <button class="filter-btn active" 
                            onclick="filterByRole('all')" 
                            id="filter-all">
                        <i class="fas fa-th"></i> ทั้งหมด
                    </button>
                    <button class="filter-btn" 
                            onclick="filterByRole('it')" 
                            id="filter-it">
                        <i class="fas fa-laptop-code"></i> IT
                    </button>
                    <button class="filter-btn" 
                            onclick="filterByRole('engineer')" 
                            id="filter-engineer">
                        <i class="fas fa-hard-hat"></i> Engineer
                    </button>
                    <button class="filter-btn" 
                            onclick="filterByRole('หัวหน้างาน')" 
                            id="filter-supervisor">
                        <i class="fas fa-user-tie"></i> หัวหน้างาน
                    </button>
                    <button class="filter-btn" 
                            onclick="filterByRole('พนักงาน')" 
                            id="filter-employee">
                        <i class="fas fa-user"></i> พนักงาน
                    </button>
                </div>
            </div>

            <!-- User Grid Container -->
            <div class="user-table-container" style="background: white; border-radius: 20px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
    <table class="user-table">
        <thead>
            <tr>
                <th>ผู้ใช้งาน</th>
                <th>บทบาท</th>
                <th>วันที่เข้าร่วม</th>
                <th>สถานะ</th>
                <th>คำสั่ง</th>
            </tr>
        </thead>
        <tbody id="userTableBody">
            </tbody>
    </table>
</div>
            <!-- Enhanced Modal -->
            <div class="modal-backdrop" id="userModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="userModalTitle">เพิ่มผู้ใช้ใหม่</h2>
                        <p class="modal-subtitle" id="userModalSubtitle">สร้างบัญชีสำหรับสมาชิกในทีมของคุณ</p>
                    </div>
                    
                    <form id="userForm" onsubmit="handleSaveUser(event)">
                        <input type="hidden" id="userId" />
                        
                        <div class="form-group">
                            <label for="userUsername">
                                <i class="fas fa-user"></i> ชื่อผู้ใช้งาน
                            </label>
                            <input type="text" 
                                   id="userUsername" 
                                   class="form-input" 
                                   placeholder="กรอกชื่อผู้ใช้งาน"
                                   required>
                        </div>
                        
                        <div class="form-group">
                            <label for="userPassword">
                                <i class="fas fa-lock"></i> รหัสผ่าน
                            </label>
                            <input type="password" 
                                   id="userPassword" 
                                   class="form-input" 
                                   placeholder="กรอกรหัสผ่านที่ปลอดภัย"
                                   onkeyup="checkPasswordStrength(this.value)">
                            <div class="password-strength" id="passwordStrength" style="display: none;">
                                <div class="strength-bar" id="strength1"></div>
                                <div class="strength-bar" id="strength2"></div>
                                <div class="strength-bar" id="strength3"></div>
                                <div class="strength-bar" id="strength4"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="userRole">
                                <i class="fas fa-user-tag"></i> บทบาท
                            </label>
                            <select id="userRole" class="form-select" required>
                                <option value="พนักงาน">พนักงาน</option>
                                <option value="หัวหน้างาน">หัวหน้างาน</option>
                                <option value="engineer">Engineer</option>
                                <option value="it">IT</option>
                            </select>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" 
                                    class="modal-btn secondary" 
                                    onclick="closeUserModal()">
                                <i class="fas fa-times"></i> ยกเลิก
                            </button>
                            <button type="submit" 
                                    class="modal-btn primary">
                                <i class="fas fa-save"></i> บันทึก
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="modal-backdrop" id="deleteConfirmModal">
    <div class="modal-content" style="max-width: 420px; text-align: center;">
        
        <div id="delete-modal-icon" style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;">
            <i class="fas fa-exclamation-triangle"></i>
        </div>

        <div class="modal-header" style="margin-bottom: 1.5rem; text-align: center;">
            <h2 class="modal-title" style="font-size: 1.5rem;">ยืนยันการลบ</h2>
            <p class="modal-subtitle" id="deleteConfirmText" style="font-size: 1rem; color: #64748b;">
                คุณต้องการลบผู้ใช้นี้ใช่หรือไม่?
            </p>
        </div>
        
        <div class="modal-actions">
            <button type="button" class="modal-btn secondary" onclick="closeDeleteConfirmModal()">
                <i class="fas fa-times"></i> ยกเลิก
            </button>
            <button type="button" id="confirmDeleteBtn" class="modal-btn" 
                    style="background: #ef4444; color: white;" 
                    onclick="handleConfirmDelete()">
                <i class="fas fa-trash-alt"></i> ยืนยันการลบ
            </button>
        </div>
    </div>
</div>
    `;
    
    document.getElementById("mainContent").innerHTML = html;
    loadUsers();
}

function renderMonitorSensorPage() {
  const html = `
    <div class="section">
      <h2><i class="fas fa-microchip"></i> Monitor Sensor</h2>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 60px; margin-top: 30px; align-items: start;">

        <!-- ✅ LIFT ZONE -->
        <div>
          <h3><i class="fas fa-arrow-up"></i> Lift</h3>
          <div style="text-align:center; margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <img src="lift_9levels.png.jpg" alt="Lift Image"
  style="max-width: 100%; max-height: 350px; width: auto; height: auto; object-fit: contain; aspect-ratio: 3/4; border-radius: 12px;" />

          </div>
          <div class="sensor-group">
            <div class="sensor-item">Gripper Floor 1: <span id="gripper_f1" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Gripper Floor 2: <span id="gripper_f2" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Gripper Floor 3: <span id="gripper_f3" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Gripper Floor 4: <span id="gripper_f4" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Gripper Floor 5: <span id="gripper_f5" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Limit Top: <span id="limit_top" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Limit Bottom: <span id="limit_bottom" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Emergency: <span id="emergency_btn" class="sensor-status-indicator">OFF</span></div>
          </div>
        </div>

        <!-- ✅ AGV ZONE -->
        <div>
          <h3><i class="fas fa-truck-moving"></i> AGV</h3>
          <div style="text-align:center; margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <img src="AGV.png" alt="AGV Image"
              style="max-width: 100%; max-height: 350px; width: auto; height: auto; object-fit: contain; aspect-ratio: 4/3; border-radius: 12px;" />
          </div>
          <div class="sensor-group">
            <div class="sensor-item">Tray Sensor: <span id="tray_sensor" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Position Sensor 1: <span id="pos_sensor1" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Position Sensor 2: <span id="pos_sensor2" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Limit AGV 1: <span id="limit_agv_1" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Limit AGV 2: <span id="limit_agv_2" class="sensor-status-indicator">OFF</span></div>
            <div class="sensor-item">Power ON: <span id="agv_on" class="sensor-status-indicator">OFF</span></div>
          </div>
        </div>

      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
}




if (page === "MonitorSensor") {
  renderMonitorSensorPage();
    return;
}



  // fallback: แสดงหน้าเปล่าๆ
  document.getElementById("mainContent").innerHTML = "<div class='section'>ไม่พบหน้านี้</div>";
}




    

  let confirmCallback = null;

  function showConfirmDialog(message, callback) {
    document.getElementById('confirmText').innerText = message;
    document.getElementById('confirmModal').style.display = 'flex';
    confirmCallback = callback;
  }

  function confirmAction(result) {
    document.getElementById('confirmModal').style.display = 'none';
    if (confirmCallback) confirmCallback(result);
  }
  function switchTab(tab) {
  document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
  if (tab === 'in') {
    document.getElementById("inboundTab").style.display = 'block';
    document.getElementById("outboundTab").style.display = 'none';
    document.querySelector(".tab-button:nth-child(1)").classList.add("active");
  } else {
    document.getElementById("inboundTab").style.display = 'none';
    document.getElementById("outboundTab").style.display = 'block';
    document.querySelector(".tab-button:nth-child(2)").classList.add("active");
  }
}
// ✅ Login function ที่ปรับปรุงแล้ว (v2)
async function login() {
  // Login function called
  
  // 1. ดึง Element ที่จำเป็นทั้งหมด
  const userEl = document.querySelector('input#username');
  const passEl = document.querySelector('input#password');
  const msgEl = document.querySelector('#loginMsg');
  const loginBtn = document.querySelector('#loginPage button'); // <-- ดึงปุ่ม Login

  if (!userEl || !passEl || !msgEl || !loginBtn) {
    console.warn("❌ ไม่พบ Element ที่จำเป็นสำหรับฟังก์ชัน Login");
    return;
  }

  // 2. Input Validation and basic checks
  const user = userEl.value.trim();
  const pass = passEl.value.trim();

  // Basic validation first
  if (!user || !pass) {
    msgEl.style.color = '#f59e0b';
    msgEl.textContent = '⚠️ กรุณากรอกชื่อผู้ใช้และรหัสผ่านให้ครบถ้วน';
    msgEl.style.display = 'block';
    return;
  }

  // Skip detailed validation - ใช้ basic check เท่านั้นเพื่อรองรับ username เดิม
  console.log('🔍 Login attempt:', { username: user, password: '***' });

  // 3. เข้าสู่สถานะ Loading
  const originalBtnText = loginBtn.innerHTML;
  loginBtn.disabled = true;
  loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังเข้าสู่ระบบ...';
  msgEl.style.display = 'none';

  try {
    // 4. ส่งข้อมูลไปที่ Server
    const response = await fetch("/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: user, password: pass })
    });

    const data = await response.json();

    if (!response.ok) {
      // ถ้า Server ตอบกลับมาว่ามีข้อผิดพลาด (status 4xx, 5xx)
      throw new Error(data.error || 'เกิดข้อผิดพลาดบางอย่าง');
    }

    // 5. กรณี Login สำเร็จ
    localStorage.setItem("loggedIn", "true");
    localStorage.setItem("username", data.username);
    localStorage.setItem("userId", data.id);
    startPinging();
    
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("dashboardPage").style.display = "flex";

    document.getElementById("currentUser").innerHTML =
      `<i class="fas fa-user" style="color:#40916c; margin-right: 6px;"></i> ${data.username} ⏷`;

    showPage('overview');
    logAction(data.username, "ผู้ใช้เข้าสู่ระบบ", "login", "การเข้าสู่ระบบ");

  } catch (err) {
    // 6. จัดการ Error (ทั้งจาก Network และที่ Server แจ้งมา)
    console.error("❌ login error", err);
    msgEl.style.color = '#dc2626';
    msgEl.textContent = `❌ ${err.message}`;
    msgEl.style.display = 'block';

  } finally {
    // 7. คืนสถานะปุ่มให้กลับมาเป็นปกติ (ส่วนนี้จะทำงานเสมอไม่ว่าจะสำเร็จหรือล้มเหลว)
    loginBtn.disabled = false;
    loginBtn.innerHTML = originalBtnText;
  }
}



document.addEventListener("DOMContentLoaded", function () {
  const loggedIn = localStorage.getItem("loggedIn");
  const username = localStorage.getItem("username");

  if (loggedIn === "true" && username) {
    currentUsername = username;
startPinging();
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("dashboardPage").style.display = "flex";

    document.getElementById("currentUser").innerHTML =
      `<i class="fas fa-user" style="color:#40916c; margin-right: 6px;"></i> ${username} ⏷`;
 
    showPage("overview");
  } else {
    document.getElementById("loginPage").style.display = "flex";
    document.getElementById("dashboardPage").style.display = "none";
    
    // Setup keyboard handlers for login page
    setTimeout(() => {
      setupLoginKeyboardHandlers();
      SecurityUtils.getCSRFToken(); // Initialize CSRF token
    }, 100);
  }
});


let systemAlerts = {
  lift: false, // ถ้าเป็น true คือแจ้งเตือนเรื่องลิฟต์ไปแล้ว
  agv: false   // ถ้าเป็น true คือแจ้งเตือนเรื่อง AGV ไปแล้ว
};

// 2. สร้างฟังก์ชันหลักสำหรับตรวจสอบสถานะทั้งหมด
async function checkAllStationStatus() {
  try {
    // ยิง API เพื่อขอสถานะของ Lift และ AGV พร้อมกัน
    const [liftRes, agvRes] = await Promise.all([
      fetch(`/api/lift/status?station=${currentStation}`),
      fetch(`/api/agv/status?station=${currentStation}`)
    ]);

    const liftStatus = await liftRes.json();
    const agvStatus = await agvRes.json();

    // --- ตรรกะการแจ้งเตือนสำหรับ LIFT ---
    if (liftStatus.emergency && !systemAlerts.lift) {
      // ถ้าลิฟต์มีปัญหา (emergency) และยังไม่เคยแจ้งเตือน
      showNotification('🚨 LIFT EMERGENCY: ระบบลิฟต์หยุดฉุกเฉิน!', 'error');
      systemAlerts.lift = true; // ตั้งค่าว่าแจ้งเตือนแล้ว
    } else if (!liftStatus.emergency && systemAlerts.lift) {
      // ถ้าลิฟต์กลับมาปกติแล้ว และเคยแจ้งเตือนไป
      systemAlerts.lift = false; // รีเซ็ตสถานะ เพื่อให้แจ้งเตือนใหม่ได้ในครั้งหน้า
    }

    // --- ตรรกะการแจ้งเตือนสำหรับ AGV ---
    if (agvStatus.status === 'error' && !systemAlerts.agv) {
      // ถ้า AGV มีสถานะเป็น 'error' และยังไม่เคยแจ้งเตือน
      showNotification('❌ AGV ERROR: ระบบ RGV เกิดข้อผิดพลาด!', 'error');
      systemAlerts.agv = true; // ตั้งค่าว่าแจ้งเตือนแล้ว
    } else if (agvStatus.status !== 'error' && systemAlerts.agv) {
      // ถ้า AGV กลับมาปกติแล้ว และเคยแจ้งเตือนไป
      systemAlerts.agv = false; // รีเซ็ตสถานะ
    }

  } catch (err) {
    console.error("Global Status Check Error:", err);
    // อาจจะเพิ่มการแจ้งเตือนว่าไม่สามารถเชื่อมต่อได้ที่นี่
  }
}

// 3. สร้างฟังก์ชันสำหรับเริ่มการตรวจสอบแบบวนลูป
function startGlobalStatusMonitor() {
  // ตรวจสอบทันทีครั้งแรก
  checkAllStationStatus();
  
  // ตั้งเวลาให้ตรวจสอบทุกๆ 5 วินาที
  setInterval(checkAllStationStatus, 5000); 
  console.log('🚀 Global Status Monitor Started (5s interval).');
}




function register() {
  const regUsername = document.getElementById("regUsername").value;
  const regPassword = document.getElementById("regPassword").value;
  const regRole = document.getElementById("regRole").value;

  fetch("/api/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: regUsername, password: regPassword, role: regRole })
  })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        showToast("❌ " + data.error);
      } else {
        showToast("✅ " + data.message + " กรุณา Login");
        showPage("login");
      }
    })
    .catch(err => showToast("เกิดข้อผิดพลาดในการเชื่อมต่อ"));
}

function showToast(message, success = true) {
  const toast = document.getElementById("toast");
  toast.innerText = message;

  // สีพื้นหลัง / ข้อความตาม success
  toast.style.backgroundColor = success ? "#d1fae5" : "#fee2e2";
  toast.style.color = success ? "#065f46" : "#991b1b";

  toast.classList.add("show");

  // หายไปใน 3 วินาที
  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}









function showOutput(text) {
  const output = document.getElementById("output") || document.createElement("div");
  output.id = "output";
  output.innerText = typeof text === "object" ? JSON.stringify(text, null, 2) : text;
  output.style.background = "#eee";
  output.style.padding = "10px";
  document.body.appendChild(output);
}




function showChangePassword() {
  document.getElementById("changeBox").style.display = "flex";
}

function closeChangePassword() {
  document.getElementById("changeBox").style.display = "none";

  // 🧼 ล้าง input และข้อความแจ้งเตือน
  document.getElementById("changeUser").value = "";
  document.getElementById("oldPass").value = "";
  document.getElementById("newPass").value = "";
  const msg = document.getElementById("changeMsg");
  msg.style.display = "none";
  msg.textContent = "";
  msg.className = "message";
}



  // ✅ ฟังก์ชันกลับไปหน้าล็อกอิน
  function backToLogin() {
  document.getElementById("registerPage").style.display = "none";

  const loginPage = document.getElementById("loginPage");
  loginPage.style.display = "flex";
  loginPage.style.flexDirection = "column";
  loginPage.style.justifyContent = "center";
  loginPage.style.alignItems = "center";
  loginPage.style.height = "100vh";
}

  
  function showRegister() {
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("registerPage").style.display = "block";
}

function goToRegister() {
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("registerPage").style.display = "block";
}

function goToChangePassword() {
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("changePasswordPage").style.display = "block";
}



//ลบบัญชี
function deleteAccount() {
  const inputUser = document.getElementById('deleteUser').value.trim();
  const inputPass = document.getElementById('deletePass').value.trim();
  const currentUser = localStorage.getItem('currentUser');
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  const msg = document.getElementById('deleteMsg');

  // Reset message
  msg.style.display = "none";
  msg.style.color = "#991b1b";

  // 1️⃣ ตรวจสอบว่าผู้ใช้กรอกครบไหม
  if (!inputUser || !inputPass) {
    msg.innerText = "กรุณากรอกชื่อผู้ใช้และรหัสผ่าน";
    msg.style.display = "block";
    return;
  }

  // 2️⃣ ตรวจสอบว่า inputUser ตรงกับ currentUser
  if (inputUser !== currentUser) {
    msg.innerText = "ชื่อผู้ใช้ไม่ตรงกับบัญชีที่เข้าสู่ระบบ";
    msg.style.display = "block";
    return;
  }

  // 3️⃣ ตรวจสอบรหัสผ่าน
  if (users[currentUser] !== inputPass) {
    msg.innerText = "รหัสผ่านไม่ถูกต้อง";
    msg.style.display = "block";
    return;
  }

  // 4️⃣ ยืนยันและลบบัญชี
  delete users[currentUser];

  // ถ้ายังอยากให้มี admin อยู่เสมอ
  if (!users["admin"]) {
    users["admin"] = "1234";
  }

  localStorage.setItem("users", JSON.stringify(users));
  msg.style.color = "#065f46";
  msg.innerText = "บัญชีถูกลบเรียบร้อยแล้ว";
  msg.style.display = "block";

  // 5️⃣ ออกจากระบบหลังจากลบ
  setTimeout(() => {
    logout();
  }, 1500);
}

function closeDeleteBox() {
  document.getElementById("deleteBox").style.display = "none";
  document.getElementById("deleteMsg").style.display = "none";
}

function showDeleteBox() {
  document.getElementById("deleteUser").value = "";
  document.getElementById("deletePass").value = "";
  document.getElementById("deleteMsg").style.display = "none";
  document.getElementById("deleteBox").style.display = "flex";
}

function showLogoutBox() {
  document.getElementById("logoutBox").style.display = "flex";
}

function closeLogoutBox() {
  document.getElementById("logoutBox").style.display = "none";
}

// ✅✅✅ [ใช้โค้ดนี้แทนที่ฟังก์ชัน confirmLogout เดิม] ✅✅✅
function confirmLogout() {
    // หยุดการ Ping ทันทีที่ออกจากระบบ
    if (sessionPingInterval) {
        clearInterval(sessionPingInterval);
        sessionPingInterval = null; // ล้างค่าตัวแปร
        console.log("🔴 Online status pinging STOPPED.");
    }

    // ล้างข้อมูลใน localStorage
    localStorage.removeItem("loggedIn");
    localStorage.removeItem("username");
    localStorage.removeItem("userId");

    location.reload(); // รีโหลดหน้าเพื่อกลับไปหน้า Login
}



  function logout() {
  // ล้างข้อมูลการเข้าสู่ระบบ
  localStorage.removeItem("loggedIn");
  localStorage.removeItem("currentUser");
  
  window.onload = function () {
  const loggedIn = localStorage.getItem("loggedIn");

  if (loggedIn === "true") {
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("dashboardPage").style.display = "block";
  } else {
    document.getElementById("loginPage").style.display = "block";
    document.getElementById("dashboardPage").style.display = "none";
  }
}




  // รีโหลดหน้าเว็บ เพื่อให้กลับไป loginPage (ใน index.html)
  location.reload();
}
function changePassword() {
  const user = document.getElementById("changeUser").value.trim();
  const oldPass = document.getElementById("oldPass").value.trim();
  const newPass = document.getElementById("newPass").value.trim();
  const msg = document.getElementById("changeMsg");

  msg.className = "message";
  msg.style.display = "none";

  if (!user || !oldPass || !newPass) {
    msg.textContent = "⚠️ กรุณากรอกข้อมูลให้ครบ";
    msg.classList.add("error");
    msg.style.display = "block";
    return;
  }

  const users = JSON.parse(localStorage.getItem("users") || "{}");

  if (!users[user]) {
  msg.textContent = "❌ ไม่พบชื่อผู้ใช้นี้";
  msg.classList.add("error");
} else if (users[user].password !== oldPass) {
  msg.textContent = "❌ รหัสผ่านเดิมไม่ถูกต้อง";
  msg.classList.add("error");
} else {
  users[user].password = newPass;  // ✅ update password ที่ถูกต้อง
  localStorage.setItem("users", JSON.stringify(users));
  msg.textContent = "✅ เปลี่ยนรหัสผ่านสำเร็จ";
  msg.classList.add("success");
}

  msg.style.display = "block";
}


document.addEventListener('DOMContentLoaded', () => {
  const userWrapper = document.getElementById("userWrapper");
  const dropdown = document.getElementById("userDropdown");
  const hamburgerBtn = document.getElementById('hamburger-menu');
    const sidebar = document.querySelector('.sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const mainContent = document.querySelector('.main');
    const pageLinks = document.querySelectorAll('.sidebar a');

    if (hamburgerBtn && sidebar && mainContent) {
        // เมื่อกดปุ่ม Hamburger ให้สลับ class 'show'
        hamburgerBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // ป้องกันการคลิกทะลุไปที่อื่น
            sidebar.classList.toggle('show');
            if (sidebarOverlay) {
                sidebarOverlay.classList.toggle('show');
            }
        });

        // เมื่อคลิกที่ overlay ให้ซ่อน sidebar
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('show');
                sidebarOverlay.classList.remove('show');
            });
        }

        // เมื่อคลิกที่เนื้อหาหลัก ให้ซ่อน sidebar (เฉพาะบนมือถือ)
        mainContent.addEventListener('click', () => {
            if (window.innerWidth <= 768 && sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                if (sidebarOverlay) {
                    sidebarOverlay.classList.remove('show');
                }
            }
        });

        // เมื่อคลิกที่ลิงก์เมนู ให้ซ่อน sidebar
        pageLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (sidebar.classList.contains('show')) {
                    sidebar.classList.remove('show');
                    if (sidebarOverlay) {
                        sidebarOverlay.classList.remove('show');
                    }
                }
            });
        });

        // เมื่อหมุนหน้าจอ ให้ซ่อน sidebar
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                if (sidebar.classList.contains('show')) {
                    sidebar.classList.remove('show');
                    if (sidebarOverlay) {
                        sidebarOverlay.classList.remove('show');
                    }
                }
            }, 100);
        });
    }
  let isHovering = false;
  let hideTimeout;

  userWrapper.addEventListener("mouseenter", () => {
    clearTimeout(hideTimeout);
    dropdown.style.display = "block";
  });

  userWrapper.addEventListener("mouseleave", () => {
    hideTimeout = setTimeout(() => {
      dropdown.style.display = "none";
    }, 200); // รอ 200ms ก่อนซ่อน
  });
});
// ✅ [อัปเดต] ฟังก์ชันวาดตาราง Inventory ให้ส่ง Tray ID ไปยัง Popup
function renderTrayGrid() {
  const grid = document.querySelector(".tray-grid");
  if (!grid) {
    console.warn("⚠️ ยังไม่มี .tray-grid บนหน้า – renderTrayGrid() ถูกเรียกก่อน DOM พร้อม");
    return;
  }
  grid.innerHTML = "";

  for (let floor = 9; floor >= 1; floor--) {
    for (let slot = 1; slot <= 18; slot++) { // ❗️ ปรับจำนวนช่องเป็น 18
      const key = `${floor}-${slot}`;
      const info = trayInventory[key];

      const isFilled = info && (info.status === 'on_shelf' || info.status === 'IN_STORAGE');

      const div = document.createElement("div");
      div.className = "tray-slot fade-in";
      div.style.padding = "12px";
      div.style.border = "1px solid #ccc";
      div.style.borderRadius = "6px";
      div.style.fontSize = "0.8em";
      div.style.textAlign = "center";
      
      if (isFilled) {
        div.style.background = "#52b788";
        div.style.color = "#fff";
        div.title = `${info.veg_type} \nเวลา: ${info.time_in}`;
        div.classList.add("filled");
      } else {
        div.style.background = "#e2e8f0";
        div.style.color = "#555";
        div.title = `ว่าง`;
        div.classList.add("empty");
      }
      
      div.textContent = `ชั้น ${floor} / ${slot}`;

      div.onclick = () => {
        if (isFilled && info) {
          const placedTime = new Date(info.time_in);
          const now = new Date();
          const diffMs = now - placedTime;
          const diffMins = Math.floor(diffMs / 1000 / 60);
          const hours = Math.floor(diffMins / 60);
          const minutes = diffMins % 60;
          const days = Math.floor(hours / 24);
          const remainHours = hours % 24;

          let ageStr = "";
          if (days > 0) ageStr += `${days} วัน `;
          if (remainHours > 0 || days > 0) ageStr += `${remainHours} ชม. `;
          ageStr += `${minutes} นาที`;

          // ✅ [แก้ไขจุดนี้] เพิ่ม trayId เข้าไป
          showTrayInfoPopup({
            trayId: info.tray_id, 
            username: info.username || "ไม่ระบุ",
            veg: info.veg_type,
            floor: info.floor,
            slot: info.slot,
            timestamp: new Date(info.time_in).toLocaleString("th-TH"),
            age: ageStr
          });
        }
      };
      grid.appendChild(div);
    }
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const userMenu = document.getElementById("currentUser");
  const userDropdown = document.getElementById("userDropdown");
  const toggleButton = document.getElementById("toggleTheme");

  // 👉 กดที่ user menu เพื่อโชว์/ซ่อน dropdown
  userMenu.addEventListener("click", () => {
    const isVisible = userDropdown.style.display === "block";
    userDropdown.style.display = isVisible ? "none" : "block";
  });

  // 👉 คลิกที่อื่น ซ่อน dropdown
  window.addEventListener("click", (e) => {
    if (!userMenu.contains(e.target) && !userDropdown.contains(e.target)) {
      userDropdown.style.display = "none";
    }
  });

  // 🌙 โหลดธีมจาก localStorage ถ้ามี
  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
    if (toggleButton) toggleButton.textContent = "☀️ Light Mode";
  }

  // 🌗 ปุ่ม toggle theme
  if (toggleButton) {
    toggleButton.addEventListener("click", () => {
      const isDark = document.body.classList.toggle("dark-mode");
      toggleButton.textContent = isDark ? "☀️ Light Mode" : "🌙 Dark Mode";
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });
  }
});


const hourlyCtx = document.getElementById('hourlyChart')?.getContext('2d');
if (hourlyCtx) {
  const hourlyChart = new Chart(hourlyCtx, {
    type: 'line',
    data: {
      labels: [...Array(24).keys()].map(h => `${String(h).padStart(2, '0')}:00`),
      datasets: [
        {
          label: 'Inbound',
          data: [1, 0, 2, 1, 3, 4, 6, 9, 12, 10, 8, 7, 5, 6, 7, 9, 8, 7, 5, 4, 3, 2, 1, 0],
          borderColor: '#40916c',
          backgroundColor: 'rgba(64,145,108,0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 3
        },
        {
          label: 'Outbound',
          data: [0, 1, 1, 0, 2, 3, 5, 8, 9, 11, 9, 6, 4, 4, 6, 8, 7, 6, 4, 3, 2, 1, 0, 0],
          borderColor: '#74c69d',
          backgroundColor: 'rgba(116,198,157,0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 3
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'สถิติถาดเข้า/ออก รายชั่วโมง (00:00 - 23:00)',
          font: {
            size: 18
          },
          color: '#1b4332'
        },
        legend: {
          labels: {
            font: { size: 14 },
            color: '#1b4332'
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 2,
            color: '#1b4332'
          },
          title: {
            display: true,
            text: 'จำนวนถาด',
            color: '#1b4332',
            font: {
              size: 14
            }
          }
        },
        x: {
          ticks: {
            color: '#1b4332'
          },
          title: {
            display: true,
            text: 'ช่วงเวลา (ชั่วโมง)',
            color: '#1b4332',
            font: {
              size: 14
            }
          }
        }
      }
    }
  });
}


//การเชื่อมค่อ esp32 จำลอง
function simulateMQTTHeartbeat(topic) {
  // จำลองว่ามี message เข้ามา
  for (const [name, dev] of Object.entries(devices)) {
    if (dev.topic === topic) {
      dev.lastSeen = Date.now();
      dev.status = "online";
    }
  }
}



// ✅ อัปเดต UI ทุก 2 วินาที
function updateSystemUI() {
  const container = document.getElementById("systemStatus");
  if (!container) return; // ✅ ถ้าไม่มี element นี้อยู่ → หยุดทำงานเลย

  container.innerHTML = "";

  const now = Date.now();
  for (const [name, dev] of Object.entries(devices)) {
    const diff = now - dev.lastSeen;
    const isOnline = diff < 10000;
    dev.status = isOnline ? "online" : "offline";

    const card = document.createElement("div");
    card.style = `
      padding: 20px;
      border-radius: 16px;
      background: ${isOnline ? '#d8f3dc' : '#f8d7da'};
      border-left: 8px solid ${isOnline ? '#2d6a4f' : '#c82333'};
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      min-width: 220px;
      font-family: 'Prompt', sans-serif;
    `;

    card.innerHTML = `
      <h3 style="margin: 0 0 10px 0;">${name}</h3>
      <p>Status: <strong style="color: ${isOnline ? '#2d6a4f' : '#c82333'}">${dev.status.toUpperCase()}</strong></p>
      <p>Last Seen: ${isOnline ? (Math.floor(diff / 1000) + 's ago') : '❌ Offline'}</p>
    `;
    container.appendChild(card);
  }
}

// ✅ ฟังก์ชันจำลองการ heartbeat จากแต่ละ ESP32
function simulateMQTTHeartbeat(topic) {
  for (const dev of Object.values(devices)) {
    if (dev.topic === topic) {
      dev.lastSeen = Date.now();
    }
  }
}

let co2Chart, tempChart, humidityChart;
let currentDay = new Date().getDate(); // 🔁 ใช้ตรวจจับวันใหม่

function setupEnvironmentCharts() {
  const co2Ctx = document.getElementById('co2Chart')?.getContext('2d');
  const tempCtx = document.getElementById('tempChart')?.getContext('2d');
  const humidityCtx = document.getElementById('humidityChart')?.getContext('2d');
  const timeNow = () => new Date().toLocaleTimeString('th-TH', { hour12: false });

  co2Chart = new Chart(co2Ctx, {
    type: 'line',
    data: {
      labels: [timeNow()],
      datasets: [{
        label: 'CO2 (ppm)',
        data: [getRandom(440, 520)],
        borderColor: '#ef476f',
        backgroundColor: 'rgba(239, 71, 111, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: { responsive: true }
  });

  tempChart = new Chart(tempCtx, {
    type: 'line',
    data: {
      labels: [timeNow()],
      datasets: [{
        label: 'Temperature (°C)',
        data: [getRandom(24, 30)],
        borderColor: '#ffd166',
        backgroundColor: 'rgba(255, 209, 102, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: { responsive: true }
  });

  humidityChart = new Chart(humidityCtx, {
    type: 'line',
    data: {
      labels: [timeNow()],
      datasets: [{
        label: 'Humidity (%)',
        data: [getRandom(60, 80)],
        borderColor: '#06d6a0',
        backgroundColor: 'rgba(6, 214, 160, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: { responsive: true }
  });
}

function updateEnvironmentCharts() {
  const now = new Date();
  const timeNow = now.toLocaleTimeString('th-TH', { hour12: false });

  // 🔄 รีเซ็ตกราฟตอนข้ามวัน
  if (now.getDate() !== currentDay) {
    currentDay = now.getDate();     // อัปเดตวันใหม่
    resetEnvironmentCharts();       // เคลียร์ข้อมูลเก่าออกจากกราฟ
  }

  const co2Val = getRandom(440, 520);
  const tempVal = getRandom(24, 30);
  const humidVal = getRandom(60, 80);

  function update(chart, value) {
    chart.data.labels.push(timeNow);
    chart.data.datasets[0].data.push(value);
    chart.update();
  }

  update(co2Chart, co2Val);
  update(tempChart, tempVal);
  update(humidityChart, humidVal);
}

function resetEnvironmentCharts() {
  co2Chart.data.labels = [];
  co2Chart.data.datasets[0].data = [];
  co2Chart.update();

  tempChart.data.labels = [];
  tempChart.data.datasets[0].data = [];
  tempChart.update();

  humidityChart.data.labels = [];
  humidityChart.data.datasets[0].data = [];
  humidityChart.update();
}

function getRandom(min, max) {
  return +(Math.random() * (max - min) + min).toFixed(1);
}

// ฟังก์ชัน popup tray inventory (ฉบับแก้ไขสมบูรณ์)
function showTrayInfoPopup({ trayId, username, veg, floor, slot, timestamp, age }) {
  // ป้องกันการสร้าง popup ซ้ำซ้อน
  const existingPopup = document.getElementById("trayInfoPopup");
  if (existingPopup) {
    existingPopup.remove();
  }

  // สร้างโครงสร้าง HTML ของ popup ดีไซน์ใหม่ (โค้ดส่วนนี้เหมือนเดิม)
  const contentHTML = `
    <div class="popup-header-premium">
      <i class="fas fa-boxes"></i>
      <h3>ข้อมูลถาด</h3>
    </div>
    <div class="info-list">
      <div class="info-item">
        <span class="info-label"><i class="fas fa-tag"></i> Tray ID</span>
        <span class="info-value highlight">${trayId || 'ไม่ระบุ'}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-leaf"></i> ชนิดผัก</span>
        <span class="info-value">${veg}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-layer-group"></i> ตำแหน่ง</span>
        <span class="info-value">ชั้น ${floor}, ช่อง ${slot}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-calendar-alt"></i> วางเมื่อ</span>
        <span class="info-value">${timestamp}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-hourglass-half"></i> อายุถาด</span>
        <span class="info-value">${age}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-user-circle"></i> ผู้ใช้</span>
        <span class="info-value">${username || 'ไม่ระบุ'}</span>
      </div>
    </div>
    <div class="close-button-wrapper">
      <button class="close-button" onclick="closeTrayInfoPopup()">
        <i class="fas fa-times"></i> ปิด
      </button>
    </div>
  `;

  // สร้าง Element ของ Popup และเพิ่มเข้าไปในหน้าเว็บ
  const popupBackdrop = document.createElement('div');
  popupBackdrop.id = 'trayInfoPopup';
  popupBackdrop.className = 'tray-popup-backdrop';

  const popupCard = document.createElement('div');
  popupCard.className = 'tray-popup-card';
  popupCard.innerHTML = contentHTML;

  popupBackdrop.appendChild(popupCard);

  // --- ✨ [จุดที่แก้ไข] เพิ่ม Event Listener ให้กดที่พื้นหลังสีเทาเพื่อปิดได้ ---
  popupBackdrop.addEventListener('click', function(event) {
      // เช็คว่าส่วนที่ถูกคลิกคือตัวพื้นหลังเอง (ไม่ใช่กล่องข้อมูล)
      if (event.target === popupBackdrop) {
          closeTrayInfoPopup();
      }
  });
  // --- จบส่วนที่แก้ไข ---

  document.body.appendChild(popupBackdrop);
}

function closeTrayInfoPopup() {
  const popupBackdrop = document.getElementById("trayInfoPopup");
  if (popupBackdrop) {
    // เพิ่ม class เพื่อเริ่ม animation การปิด
    popupBackdrop.classList.add('closing');
    popupBackdrop.querySelector('.tray-popup-card').classList.add('closing');

    // หน่วงเวลาก่อนลบ Element ออกจาก DOM เพื่อให้ animation เล่นจบ
    setTimeout(() => {
      if (popupBackdrop) {
          popupBackdrop.remove();
      }
    }, 300); // ระยะเวลาควรตรงกับ animation-duration ใน CSS
  }
}






function showTrayPopup(message) {
  const popup = document.getElementById('trayPopup');
  popup.textContent = message || "✅ สำเร็จ";
  popup.style.display = 'block';

  setTimeout(() => {
    popup.style.display = 'none';
  }, 5000); // 5 วินาที
}





function showLiftToast(message) {
  const toast = document.getElementById("liftToast");
  const msg = document.getElementById("liftToastMessage");
  if (!toast || !msg) return;

  msg.textContent = message;
  toast.style.display = "block";

  setTimeout(() => {
    toast.style.display = "none";
  }, 4000);
}






function onStationChange() {
  const select = document.getElementById("stationSelect");
  const selected = parseInt(select.value);
  if (!isNaN(selected)) {
    currentStation = selected;
  } else {
    currentStation = 1; // fallback เผื่อ dropdown ไม่โหลด
  }
  showPage(currentPage); // ✅ reload หน้าเดิม
}




function loadOverviewCharts(stationId) {
  fetch(`/api/overview?station=${stationId}`)
    .then(res => res.json())
    .then(data => {
      renderPie(data.total);
      renderBar(data.daily);
      renderHourly(data.hourly);
    });
}
// ✅ เปลี่ยนชื่อ currentPage เป็น logCurrentPage
let userLogs = []; // เก็บข้อมูล log ที่โหลดมาจาก backend
let logCurrentPage = 1;
const logsPerPage = 10;

// ✅ โหลด log จาก backend
async function fetchUserLogs() {
  const res = await fetch("/api/logs"); // ไม่ต้องใช้ token ในระบบนี้

  if (res.ok) {
    userLogs = await res.json();
    renderUserLogs(); // แสดงผลเมื่อโหลดเสร็จ
  } else {
    alert("โหลดข้อมูล Log ไม่สำเร็จ");
  }
}
// ✅ ฟังก์ชันแปลงประเภทกิจกรรมให้แสดงผลสวยงาม
function mapCategory(log) {
  const act = (log.activity || "").toLowerCase();
  const cat = (log.category || "").toLowerCase();

  if (cat === "tray") {
    if (act.includes("วาง")) return "ถาดเข้า";
    if (act.includes("นำ") && act.includes("ออก")) return "ถาดออก";
    return "จัดการถาด";
  }
  if (cat === "inbound") return "ถาดเข้า";
  if (cat === "outbound") return "ถาดออก";
  if (cat === "lift") return "ลิฟต์";
  if (cat === "agv") return "AGV";
  if (cat === "login") return "เข้าสู่ระบบ";

  if (act.includes("เข้าสู่ระบบ")) return "เข้าสู่ระบบ";
  if (act.includes("วาง")) return "ถาดเข้า";
  if (act.includes("นำ") && act.includes("ออก")) return "ถาดออก";
  if (act.includes("ลิฟ")) return "ลิฟต์";
  if (act.includes("agv")) return "AGV";

  return "-";
}



// 🔧 แก้ปัญหา: เพิ่มฟังก์ชัน goToLogPage ที่หายไป
function goToLogPage(page) {
    if (page < 1) return;
    
    logCurrentPage = page;
    renderUserLogs(); // วาดหน้าใหม่
    
    // เลื่อนขึ้นไปด้านบนเพื่อดู logs ใหม่
    document.getElementById("logCardsContainer").scrollIntoView({
        behavior: 'smooth',
        block: 'start'
    });
}
// ✅ ปรับปรุงฟังก์ชัน renderUserLogs ให้ทำงานได้ดีขึ้น
function renderUserLogs() {
    const container = document.getElementById("logCardsContainer");
    const searchInput = document.getElementById("logSearchInput");
    const categoryFilter = document.getElementById("logCategoryFilter");
    const pagination = document.getElementById("pagination");
    const logsPerPage = 20; // เพิ่มจำนวนต่อหน้า

    if (!container || !searchInput || !categoryFilter || !pagination) {
        console.error("❌ ไม่พบ elements ที่จำเป็นสำหรับหน้า logs");
        return;
    }
    
    // กรองข้อมูล
    const query = searchInput.value.toLowerCase();
    const selectedCategory = categoryFilter.value.trim();

    const filtered = userLogs.filter(log =>
        (!selectedCategory || mapCategory(log) === selectedCategory) &&
        (
            (log.username?.toLowerCase().includes(query)) ||
            (log.activity?.toLowerCase().includes(query)) ||
            (log.timestamp && new Date(log.timestamp).toLocaleString().toLowerCase().includes(query))
        )
    );

    const totalPages = Math.ceil(filtered.length / logsPerPage);
    
    // ตรวจสอบว่าหน้าปัจจุบันไม่เกินจำนวนหน้าทั้งหมด
    if (logCurrentPage > totalPages && totalPages > 0) {
        logCurrentPage = totalPages;
    }
    
    const start = (logCurrentPage - 1) * logsPerPage;
    const pageLogs = filtered.slice(start, start + logsPerPage);
    
    // เคลียร์ container
    container.innerHTML = "";

    // แสดงผลลัพธ์การค้นหา
    if (filtered.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-search" style="font-size: 3em; margin-bottom: 16px; opacity: 0.3;"></i>
                <p style="font-size: 1.1em;">ไม่พบข้อมูล logs ที่ตรงกับการค้นหา</p>
            </div>
        `;
        pagination.innerHTML = "";
        return;
    }

    // สร้าง log cards
    pageLogs.forEach(log => {
        const card = document.createElement("div");
        card.className = "log-card";
        card.innerHTML = `
            <div><strong>ผู้ใช้:</strong> ${log.username || "-"}</div>
            <div><strong>กิจกรรม:</strong> ${log.activity || "-"}</div>
            <div><strong>เวลา:</strong> ${log.timestamp ? new Date(log.timestamp).toLocaleString('th-TH', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            }) : "-"}</div>
            <button class="expand-btn" onclick="toggleDetails(this)">แสดงรายละเอียด</button>
            <div class="log-details" style="display: none; margin-top: 10px;">
                <div><strong>ประเภท:</strong> ${mapCategory(log)}</div>
                <div><strong>ชั้น:</strong> ${log.floor ?? "-"}</div>
                <div><strong>ช่อง:</strong> ${log.slot ?? "-"}</div>
                <div><strong>ผัก:</strong> ${log.veg_type || "-"}</div>
                <div><strong>สถานี:</strong> ${log.station || "-"}</div>
            </div>
        `;
        container.appendChild(card);
    });

    // สร้าง pagination
    pagination.innerHTML = "";
    
    // แสดงข้อมูลสถิติ
    const statsDiv = document.createElement("div");
    statsDiv.style.cssText = "text-align: center; margin-bottom: 16px; color: #666; font-size: 0.9em;";
    statsDiv.innerHTML = `แสดง ${start + 1}-${Math.min(start + logsPerPage, filtered.length)} จาก ${filtered.length} รายการ`;
    pagination.appendChild(statsDiv);

    // สร้างปุ่ม pagination
    const buttonContainer = document.createElement("div");
  buttonContainer.style.cssText = "display: flex; justify-content: center; align-items: center; flex-wrap: nowrap; gap: 8px; overflow-x: auto; padding: 0 10px;";
    
    // ปุ่มก่อนหน้า
    if (logCurrentPage > 1) {
        const prevBtn = document.createElement("button");
        prevBtn.innerHTML = `<i class="fas fa-chevron-left"></i> ก่อนหน้า`;
        prevBtn.onclick = () => goToLogPage(logCurrentPage - 1);
        prevBtn.style.cssText = "padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; background: #e9f5ec; color: #1b4332; font-weight: bold;";
        buttonContainer.appendChild(prevBtn);
    }

    // ปุ่มหมายเลขหน้า (แสดงแค่ 5 หน้าใกล้เคียง)
    const startPage = Math.max(1, logCurrentPage - 2);
    const endPage = Math.min(totalPages, logCurrentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.onclick = () => goToLogPage(i);
        
        const isActive = i === logCurrentPage;
        btn.style.cssText = `
            width: 40px; height: 40px; border-radius: 8px; border: none; cursor: pointer; 
            font-weight: bold; transition: all 0.3s ease;
            ${isActive ? 'background: #40916c; color: white;' : 'background: #e9f5ec; color: #1b4332;'}
        `;
        
        buttonContainer.appendChild(btn);
    }

    // ปุ่มถัดไป
    if (logCurrentPage < totalPages) {
        const nextBtn = document.createElement("button");
        nextBtn.innerHTML = `ถัดไป <i class="fas fa-chevron-right"></i>`;
        nextBtn.onclick = () => goToLogPage(logCurrentPage + 1);
        nextBtn.style.cssText = "padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; background: #e9f5ec; color: #1b4332; font-weight: bold;";
        buttonContainer.appendChild(nextBtn);
    }
    
    pagination.appendChild(buttonContainer);
}
// ✅ ปรับปรุง Event Listeners เพื่อให้ pagination ทำงานได้ดี
function setupLogsEventListeners() {
    const searchInput = document.getElementById("logSearchInput");
    const categoryFilter = document.getElementById("logCategoryFilter");
    
    if (searchInput) {
        // ใช้ debounce เพื่อลดการเรียก API บ่อยเกินไป
        let searchTimeout;
        searchInput.addEventListener("input", () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                logCurrentPage = 1; // รีเซ็ตไปหน้าแรก
                renderUserLogs();
            }, 300);
        });
    }
    
    if (categoryFilter) {
        categoryFilter.addEventListener("change", () => {
            logCurrentPage = 1; // รีเซ็ตไปหน้าแรก
            renderUserLogs();
        });
    }
}

// ✅ เรียกใช้เมื่อโหลดหน้า logs
function initUserLogsPage() {
    fetchUserLogs().then(() => {
        setupLogsEventListeners();
    });
}
function toggleDetails(button) {
  const detailsDiv = button.nextElementSibling;
  if (detailsDiv.style.display === "none") {
    detailsDiv.style.display = "block";
    button.innerText = "ซ่อนรายละเอียด";
  } else {
    detailsDiv.style.display = "none";
    button.innerText = "แสดงรายละเอียด";
  }
}



// ✅ เรียกเมื่อเปิดหน้านี้
fetchUserLogs();

// ✅ ฟังก์ชันส่ง log แบบใช้ username (frontend → /api/log)
function logAction(username, activity, action_type, category, station = "", floor = "", slot = "", veg_type = "", description = "") {
    if (!username) {
        username = localStorage.getItem("username");
    }
    if (!username) return; // ถ้ายังหา username ไม่ได้ ก็ไม่ต้องทำอะไรต่อ

    fetch("/api/log", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, activity, action_type, category, station, floor, slot, veg_type, description })
    })
    .then(res => {
        // ✅ เพิ่มการตรวจสอบสถานะตรงนี้
        if (!res.ok) {
            // ถ้าเกิด Error ให้โยนไปที่ .catch
            return res.json().then(errData => { throw new Error(errData.error || 'Server responded with an error'); });
        }
        return res.json();
    })
    .then(data => {
        console.log("✅ Log saved:", data.message); // แสดงข้อความจาก Backend
    })
    .catch(err => {
        // .catch จะทำงานเมื่อเกิด Error จริงๆ เท่านั้น
        console.error("❌ logAction error:", err.message);
    });
}
function exportLogsToExcelWithLogo() {
  if (!userLogs || userLogs.length === 0) {
    alert("ไม่มีข้อมูลให้ส่งออก");
    return;
  }

  const exportData = userLogs.map((log, index) => [
    index + 1,
    new Date(log.timestamp).toLocaleString('th-TH', { hour12: false }),
    log.username,
    log.role || "-",
    log.activity,
    log.type,
    log.floor || "-",
    log.slot || "-",
    log.veg_type || "-",
    log.station || "-"
  ]);

  const headers = [
    "ลำดับ", "เวลา", "ผู้ใช้", "บทบาท", "การกระทำ", "ประเภท",
    "ชั้น", "ช่อง", "ชนิดผัก", "สถานี"
  ];

  XlsxPopulate.fromBlankAsync().then(workbook => {
    const sheet = workbook.sheet(0).name("User Logs");

    // ✅ โลโก้เป็นข้อความสวย
    sheet.cell("A1").value("AGROTECH WMS").style({
      bold: true,
      fontSize: 18,
      fontColor: "2d6a4f"
    });

    // ✅ หัวตาราง
    headers.forEach((header, i) => {
      sheet.cell(3, i + 1).value(header).style({
        bold: true,
        fill: "2d6a4f",
        fontColor: "ffffff",
        horizontalAlignment: "center"
      });
      sheet.column(i + 1).width(16);
    });

    // ✅ ข้อมูล
    exportData.forEach((row, r) => {
      row.forEach((val, c) => {
        sheet.cell(r + 4, c + 1).value(val);
      });
    });

    // ✅ ✅ ✅ FIX: ใช้ .range().autoFilter() แทน
    sheet.range("A3:J3").autoFilter();

    // ✅ freeze row
    sheet.freezePanes(4, 1);

    return workbook.outputAsync();
  }).then(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `user_logs_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.xlsx`;
    a.click();
    URL.revokeObjectURL(url);
  }).catch(err => {
    console.error("❌ Export Error:", err);
    alert("เกิดข้อผิดพลาดในการส่งออก Excel");
  });
}








function calculateTrayAge(time_in_string) {
  if (!time_in_string) return "ไม่ระบุ";
  
  const startTime = new Date(time_in_string);
  const now = new Date();
  let diff = (now.getTime() - startTime.getTime()) / 1000; // ได้ผลต่างเป็นวินาที

  const days = Math.floor(diff / (24 * 3600));
  diff -= days * 24 * 3600;
  const hours = Math.floor(diff / 3600);
  diff -= hours * 3600;
  const minutes = Math.floor(diff / 60);

  let age = "";
  if (days > 0) age += `${days} วัน `;
  if (hours > 0) age += `${hours} ชม. `;
  age += `${minutes} นาที`;
  
  return age;
}


function showTrayDetails(floor, slot) {
  const key = `${floor}-${slot}`;
  const info = trayInventory[key];

  if (!info) {
    alert(`❌ ไม่มีข้อมูลถาดในตำแหน่งนี้\nชั้น ${floor}, ช่อง ${slot}`);
    return;
  }

  const veg = info.veg_type || "ไม่ทราบ";          // ✅ ต้องใช้ veg_type
  const timeText = info.time_in
    ? new Date(info.time_in).toLocaleString("th-TH") // ✅ ต้องใช้ time_in
    : "ไม่พบเวลา";

  let ageStr = "ไม่สามารถคำนวณอายุได้";
  if (info.time_in) {
    const placed = new Date(info.time_in);
    const now = new Date();
    const diff = now - placed;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    ageStr = days > 0 ? `${days} วัน ${hours} ชม.` : `${hours} ชม.`;
  }

  alert(`🔍 ถาด: ${veg}\nชั้น ${floor}, ช่อง ${slot}\nวางเมื่อ: ${timeText}\nอายุ: ${ageStr}`);
}


// ✅ โหลดข้อมูลแสดงในตาราง
function loadRealPlanMock(page = 1) {
  currentPage = page;
  const today = new Date().toISOString().split("T")[0];
  const tbody = document.getElementById("realPlanTableBody");
  tbody.innerHTML = "";

  const start = (page - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const displayTrays = trays.slice(start, end);

  displayTrays.forEach(tray => {
    const isDue = tray.harvest_date <= today;
 const statusHTML = isDue
  ? `<span class="status status-due blink"><i class="fas fa-bell"></i> ถึงวันเก็บเกี่ยว</span>`
  : `<span class="status status-growing"><i class="fas fa-leaf"></i> กำลังเติบโต</span>`;

    const actionHTML = `
      <div class="action-buttons">
        <button onclick="sendRefill(${tray.floor}, ${tray.slot})">เติมน้ำ</button>
        <button onclick="toggleWater(${tray.floor}, ${tray.slot})">เก็บผลผลิต</button>
      </div>
    `;

    const row = document.createElement("tr");
    row.className = isDue ? "harvest-due" : "";
    row.innerHTML = `
      <td>${tray.veg_type}</td>
      <td>ชั้น ${tray.floor}</td>
      <td>ช่อง ${tray.slot}</td>
      <td>${tray.start_date}</td>
      <td>${tray.harvest_date}</td>
      <td>${statusHTML}</td>
      <td>${actionHTML}</td>
    `;
    tbody.appendChild(row);
    // เพิ่มแถวสำหรับแสดงประวัติ (ซ่อนไว้ก่อน)
const historyRow = document.createElement('tr');
historyRow.className = 'history-row';
historyRow.id = `history-${tray.tray_id}`;
historyRow.style.display = 'none';
historyRow.innerHTML = `<td colspan="10"></td>`; // Colspan ต้องเท่ากับจำนวนคอลัมน์ทั้งหมด
tbody.appendChild(historyRow);
  });

  renderPagination();
}

// ✅ [แก้ไข] ฟังก์ชันสำหรับแสดง/ซ่อนประวัติของถาด (ปรับปรุงการแสดงผลอายุ)
async function toggleTrayHistory(trayId, button) {
    const historyRow = document.getElementById(`history-${trayId}`);
    const historyCell = historyRow.querySelector('td');

    const isVisible = historyRow.style.display !== 'none';

    if (isVisible) {
        historyRow.style.display = 'none';
        button.innerText = 'ประวัติ';
        button.style.backgroundColor = '#64748b';
        return;
    }

    historyRow.style.display = 'table-row';
    button.innerText = 'โหลด...';
    button.disabled = true;
    historyCell.innerHTML = '<p style="text-align:center; padding: 10px;">กำลังโหลดประวัติ...</p>';

    try {
        const response = await fetch(`/api/tray/history/${trayId}`);
        const historyData = await response.json();
        
        button.innerText = 'ซ่อน';
        button.style.backgroundColor = '#1f2937';
        button.disabled = false;

        if (!historyData || historyData.length === 0) {
            historyCell.innerHTML = '<p style="text-align:center; font-weight: 500; padding: 10px;">ไม่พบประวัติสำหรับถาดนี้</p>';
            return;
        }

        let historyHtml = `
            <table class="history-table">
                <thead>
                    <tr>
                        <th>เวลา</th>
                        <th>ประเภท</th>
                        <th>ตำแหน่ง</th>
                        <th>อายุถาด (ณ เวลานั้น)</th>
                        <th>จำนวนต้น</th>
                        <th>เหตุผล</th>
                        <th>ผู้ใช้</th>
                    </tr>
                </thead>
                <tbody>
        `;

        historyData.forEach(log => {
            const actionClass = log.action_type === 'inbound' ? 'action-inbound' : 'action-outbound';
            const actionText = log.action_type === 'inbound' ? 'นำเข้า' : 'นำออก';
            
            // --- [ปรับปรุง] ส่วนคำนวณอายุถาด ---
            let ageDisplay = '-';
            // ถ้าไม่ใช่ 'inbound' ค่อยคำนวณอายุ
            if (log.action_type !== 'inbound' && log.birth_time && log.created_at) {
    const actionTime = new Date(log.created_at);
    const birthTime = new Date(log.birth_time); // <-- ✅ เปลี่ยนมาใช้ log.birth_time
    const diffMs = actionTime.getTime() - birthTime.getTime();
    
    if (diffMs >= 0) {
        const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diffMs / (1000 * 60 * 60)) % 24);
        ageDisplay = `${days} วัน ${hours} ชม.`;
    }
}

            historyHtml += `
                <tr>
                    <td>${log.timestamp_th}</td>
                    <td class="${actionClass}">${actionText}</td>
                    <td>ชั้น ${log.floor} / ช่อง ${log.slot}</td>
                    <td>${ageDisplay}</td>
                    <td>${log.plant_quantity || '-'}</td>
                    <td>${log.reason || '-'}</td>
                    <td>${log.username || '-'}</td>
                </tr>
            `;
        });

        historyHtml += '</tbody></table>';
        historyCell.innerHTML = historyHtml;

    } catch (error) {
        console.error('Failed to load tray history:', error);
        historyCell.innerHTML = '<p style="text-align:center; color: red; padding: 10px;">เกิดข้อผิดพลาดในการโหลดประวัติ</p>';
        button.innerText = 'ลองใหม่';
        button.disabled = false;
    }
}




// ✅ สร้างปุ่มเปลี่ยนหน้า
function renderPagination() {
  const totalPages = Math.ceil(trays.length / rowsPerPage);
  const pagination = document.getElementById("plantingPagination");
  pagination.innerHTML = "";

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.className = i === currentPage ? "active" : "";
    btn.onclick = () => loadRealPlanMock(i);
    pagination.appendChild(btn);
  }
}

// ✅ ปุ่มคำสั่ง (mock)
function sendRefill(floor, slot) {
  alert(`💧 เติมน้ำที่ ชั้น ${floor} / ช่อง ${slot}`);
}

function toggleWater(floor, slot) {
  alert(`✅ เก็บผลผลิตที่ ชั้น ${floor} / ช่อง ${slot}`);
}



async function loadTaskMonitor() {
  try {
    const response = await fetch('/api/task-monitor');
    const tasks = await response.json();
    renderTaskTable(tasks);
  } catch (err) {
    console.error('❌ ดึงข้อมูล Task Monitor ล้มเหลว:', err);
  }
}
// แก้ไขใน index.html
function renderTaskTable(tasks) {
  const tbody = document.getElementById("taskTableBody");
  tbody.innerHTML = "";

  // นับจำนวนสถานะแต่ละประเภท
  const statusCount = {
    pending: 0,
    working: 0,
    success: 0,
    at_workstation: 0,
    error: 0
  };

  tasks.forEach((task, index) => {
    const tr = document.createElement("tr");
    tr.style.animationDelay = `${index * 0.1}s`;
    tr.classList.add('fade-in-row');

    // นับสถานะ
    statusCount[task.status] = (statusCount[task.status] || 0) + 1;

    const statusClass = `status-enhanced ${task.status}`;
    const endTime = task.completed_at ? formatDate(task.completed_at) : '-';
    
    // เพิ่ม badge สำหรับประเภทงาน
    const actionBadge = task.action_type === 'inbound' ? 
      '<span class="action-badge inbound"><i class="fas fa-arrow-down"></i> นำเข้า</span>' :
      '<span class="action-badge outbound"><i class="fas fa-arrow-up"></i> นำออก</span>';

    tr.innerHTML = `
      <td><strong>${task.tray_id}</strong></td>
      <td><span class="floor-badge">ชั้น ${task.floor || '-'}</span></td>
      <td><span class="slot-badge">ช่อง ${task.slot || '-'}</span></td>
      <td><span class="${statusClass}">${convertStatusLabel(task.status)}</span></td>
      <td>${formatDate(task.created_at)}</td>
      <td>${endTime}</td>
      <td>${actionBadge}</td>
      <td><span class="user-badge"><i class="fas fa-user-circle"></i> ${task.username || '-'}</span></td>
    `;

    tbody.appendChild(tr);
  });

  // อัพเดทตัวเลขสถิติ
  updateTaskStats(statusCount);
}

// เพิ่ม function ใหม่
function updateTaskStats(statusCount) {
  document.getElementById('pendingCount').textContent = statusCount.pending || 0;
  document.getElementById('workingCount').textContent = statusCount.working || 0;
  document.getElementById('successCount').textContent = statusCount.success || 0;
}
// ในไฟล์ index.html (ส่วน <script>)

function convertStatusLabel(status) {
  if (status === 'pending') return '⏳ รอดำเนินการ';
  if (status === 'working') return '🚚 กำลังทำงาน';
  if (status === 'at_workstation') return '📦 รอที่ Workstation'; // ✅ เพิ่มบรรทัดนี้
  if (status === 'success') return '✅ สำเร็จ'; // ✅ แก้ไขจาก 'done' เป็น 'success' ให้ตรงกับ Backend
  if (status === 'error') return '❌ ผิดพลาด';
  return status; // สำหรับสถานะอื่นๆ ที่อาจมีในอนาคต
}
function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleString("th-TH", { hour12: false });
}


//จำลองประวัติการเคลื่อนที่
function loadTaskHistory() {
  const historyTasks = [
    {
      task_id: "T001",
      floor: 4,
      slot: 8,
      status: "success",
      start_time: "2025-05-21T08:15:00",
      end_time: "2025-05-21T08:16:30",
      type: "tray_inbound",
      username: "admin"
    },
    {
      task_id: "T004",
      floor: 2,
      slot: 5,
      status: "success",
      start_time: "2025-05-21T07:00:00",
      end_time: "2025-05-21T07:01:45",
      type: "agv_move",
      username: "staff02"
    }
  ];

  renderTaskHistoryTable(historyTasks);
}
function renderTaskHistoryTable(tasks) {
  const tbody = document.getElementById("taskHistoryTableBody");
  if (!tbody) {
    console.error('❌ Element taskHistoryTableBody not found!');
    return;
  }

  tbody.innerHTML = "";

  if (!tasks || tasks.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">ไม่พบประวัติงานที่ตรงกับเงื่อนไข</td></tr>';
    return;
  }

  tasks.forEach(task => {
    const tr = document.createElement("tr");
    tr.className = 'fade-in-row';

    const statusClass = `status-enhanced ${task.status}`;
    const endTime = task.completed_at ? new Date(task.completed_at).toLocaleString("th-TH") : '-';
    const actionBadge = task.action_type === 'inbound'
      ? '<span class="action-badge inbound"><i class="fas fa-arrow-down"></i> นำเข้า</span>'
      : '<span class="action-badge outbound"><i class="fas fa-arrow-up"></i> นำออก</span>';

    tr.innerHTML = `
      <td><strong>${task.tray_id}</strong></td>
      <td><span class="floor-badge">ชั้น ${task.floor || '-'}</span></td>
      <td><span class="slot-badge">ช่อง ${task.slot || '-'}</span></td>
      <td><span class="${statusClass}">${convertStatusLabel(task.status)}</span></td>
      <td>${new Date(task.created_at).toLocaleString("th-TH")}</td>
      <td>${endTime}</td>
      <td>${actionBadge}</td>
      <td><span class="user-badge"><i class="fas fa-user-circle"></i> ${task.username || '-'}</span></td>
    `;
    tbody.appendChild(tr);
  });
}

// 5. ฟังก์ชันสำหรับผูก Event Listener กับปุ่มและช่องค้นหา (ฟังก์ชันใหม่)
function setupHistoryEventListeners() {
    const searchInput = document.getElementById('historySearch');
    const filterSelect = document.getElementById('historyFilter');

    if (searchInput) {
        searchInput.addEventListener('input', filterAndRenderHistory);
    }
    if (filterSelect) {
        filterSelect.addEventListener('change', filterAndRenderHistory);
    }
}



// ✅ ปรับปรุงฟังก์ชันโหลดกราฟให้มี Error Handling
async function loadOverviewCharts() {
  try {
    const station = currentStation || 1;

    // เพิ่ม error handling สำหรับแต่ละ API
    const [summaryRes, weeklyRes, hourlyRes] = await Promise.allSettled([
      fetch(`/api/stats/summary?station=${station}`),
      fetch(`/api/stats/weekly?station=${station}`),
      fetch(`/api/stats/hourly?station=${station}`)
    ]);

    // ✅ จัดการ Pie Chart
    if (summaryRes.status === 'fulfilled' && summaryRes.value.ok) {
      const summary = await summaryRes.value.json();
      renderPieChart(summary);
    } else {
      console.warn('Summary API failed, using mock data');
      renderPieChart({ inbound: 15, outbound: 12 });
    }

    // ✅ จัดการ Bar Chart
    if (weeklyRes.status === 'fulfilled' && weeklyRes.value.ok) {
      const weekly = await weeklyRes.value.json();
      renderBarChart(weekly);
    } else {
      console.warn('Weekly API failed, using mock data');
      const mockWeekly = generateMockWeeklyData();
      renderBarChart(mockWeekly);
    }

    // ✅ จัดการ Hourly Chart
    if (hourlyRes.status === 'fulfilled' && hourlyRes.value.ok) {
      const hourly = await hourlyRes.value.json();
      renderHourlyChart(hourly);
    } else {
      console.warn('Hourly API failed, using mock data');
      const mockHourly = generateMockHourlyData();
      renderHourlyChart(mockHourly);
    }

  } catch (err) {
    console.error("❌ โหลดข้อมูล overview ไม่สำเร็จ:", err);
    // แสดงกราฟเปล่าหรือข้อมูลสำรอง
    renderPieChart({ inbound: 0, outbound: 0 });
    renderBarChart([]);
    renderHourlyChart([]);
  }
}

// ✅ ฟังก์ชันสร้างข้อมูลสำรอง
function generateMockWeeklyData() {
  const data = [];
  const labels = getLast7Days();
  
  labels.forEach(date => {
    data.push({
      date: date,
      inbound: Math.floor(Math.random() * 20) + 5,
      outbound: Math.floor(Math.random() * 15) + 3
    });
  });
  
  return data;
}

function generateMockHourlyData() {
  const data = [];
  
  for (let hour = 0; hour < 24; hour++) {
    data.push({
      hour: hour,
      inbound: Math.floor(Math.random() * 10),
      outbound: Math.floor(Math.random() * 8)
    });
  }
  
  return data;
}

function renderPieChart(data) {
  if (pieChartInstance) pieChartInstance.destroy();
  
  const ctx = document.getElementById('pieChart');
  if (!ctx) {
    console.error('❌ ไม่พบ element pieChart');
    return;
  }
  
  pieChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Inbound (เข้า)', 'Outbound (ออก)'],
      datasets: [{
        data: [data.inbound || 0, data.outbound || 0],
        backgroundColor: [
          '#b7e4c7', 
          '#52b788'
        ],
        borderColor: [
          '#ffffff', 
          '#ffffff'
        ],
        borderWidth: 4, // 🎨 เพิ่มความหนาของขอบให้ดูชัดขึ้น
        cutout: '50%',  // 🎨 ทำให้รูตรงกลางใหญ่ขึ้นเล็กน้อย
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right', // ✅✅✅ ย้ายคำอธิบายมาด้านขวา
          align: 'center',   // ✅✅✅ จัดให้อยู่กึ่งกลางแนวตั้ง
          labels: {
            padding: 25,     // 🎨 ปรับระยะห่าง
            font: {
              family: 'Prompt',
              size: 14,      // 🎨 ลดขนาดฟอนต์ให้พอดี
              weight: '500'
            },
            usePointStyle: true,
            pointStyle: 'circle',
            boxWidth: 12,    // 🎨 ปรับขนาดจุดสี
            boxHeight: 12,
            color: '#1f2937',
            generateLabels: function(chart) {
              const data = chart.data;
              if (data.labels.length && data.datasets.length) {
                return data.labels.map((label, i) => {
                  const value = data.datasets[0].data[i];
                  const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return {
                    text: `${label}: ${value} (${percentage}%)`,
                    fillStyle: data.datasets[0].backgroundColor[i],
                    strokeStyle: data.datasets[0].borderColor[i],
                    lineWidth: data.datasets[0].borderWidth,
                    hidden: false,
                    index: i
                  };
                });
              }
              return [];
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(17, 24, 39, 0.95)',
          titleColor: '#f9fafb',
          bodyColor: '#f3f4f6',
          borderColor: 'rgba(52, 183, 136, 0.5)',
          borderWidth: 2,
          cornerRadius: 12,
          padding: 12,
          titleFont: { family: 'Prompt', size: 14, weight: '600' },
          bodyFont: { family: 'Prompt', size: 13 },
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
              return `${context.label}: ${context.parsed} รายการ (${percentage}%)`;
            }
          }
        }
      },
      layout: {
        padding: 20 // ✅ ปรับ padding ให้สมดุลรอบด้าน
      },
      animation: {
        duration: 1500,
        easing: 'easeInOutCubic'
      }
    }
  });
}
// ✅✅✅ [แก้ไข] ฟังก์ชันโหลดข้อมูลกราฟที่ถูกต้อง ✅✅✅
async function loadOverviewCharts(stationId) {
  try {
    const station = currentStation || 1;

    const [summaryRes, weeklyRes, hourlyRes] = await Promise.all([
      fetch(`/api/stats/summary?station=${station}`),
      fetch(`/api/stats/weekly?station=${station}`),
      fetch(`/api/stats/hourly?station=${station}`)
    ]);

    const summary = await summaryRes.json();
    const weekly = await weeklyRes.json();
    const hourly = await hourlyRes.json();

    renderPieChart(summary);    // ✅ ถูกต้อง
    renderBarChart(weekly);     // ✅ ถูกต้อง
    renderHourlyChart(hourly);  // ✅ ถูกต้อง
  } catch (err) {
    console.error("❌ โหลดข้อมูล overview ไม่สำเร็จ:", err);
  }
}
// ✅✅✅ [เพิ่มฟังก์ชันนี้ที่หายไป] ✅✅✅
function getLast7Days() {
  const days = [];
  const today = new Date();
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(today.getDate() - i);
    
    // --- จุดสำคัญที่แก้ไข ---
    // จัดรูปแบบวันที่ด้วยตัวเองให้เป็น 'DD/MM'
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0'); // เดือนใน JavaScript เริ่มที่ 0
    days.push(`${day}/${month}`);
  }
  
  return days;
}


function getHourlyLabels() {
  const hours = [];
  for (let i = 0; i < 24; i++) {
    const label = i.toString().padStart(2, '0') + ':00';
    hours.push(label);
  }
  return hours;
}


function renderHourlyChart(data) {
  if (hourlyChartInstance) hourlyChartInstance.destroy();

  const inboundMap = {};
  const outboundMap = {};

  // ⏱ API ส่ง hour เป็นตัวเลข เช่น 9, 10
  data.forEach(row => {
    const hourLabel = row.hour.toString().padStart(2, '0') + ':00';
    inboundMap[hourLabel] = row.inbound;
    outboundMap[hourLabel] = row.outbound;
  });

  const labels = getHourlyLabels(); // ['00:00', ..., '23:00']

  const inboundData = labels.map(h => inboundMap[h] || 0);
  const outboundData = labels.map(h => outboundMap[h] || 0);

  hourlyChartInstance = new Chart(document.getElementById('hourlyChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Inbound',
                    data: inboundData,
                    borderColor: '#40916c', // ✅ สีเขียวเข้ม
                    backgroundColor: 'rgba(64, 145, 108, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Outbound',
                    data: outboundData,
                    borderColor: '#74c69d', // ✅ สีเขียวกลาง
                    backgroundColor: 'rgba(116, 198, 157, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function renderBarChart(data, type = 'weekly') {
  if (barChartInstance) {
    barChartInstance.destroy();
  }

  // ✅ เช็คให้แน่ใจว่า element มีอยู่
  const ctx = document.getElementById('barChart')?.getContext('2d');
  if (!ctx) {
    console.error('❌ ไม่พบ element barChart');
    return;
  }

  let labels, inboundData, outboundData;

  if (type === 'monthly') {
    // สำหรับกราฟ 30 วัน
    labels = getLast30Days();
    const dataMap = new Map(data.map(item => [item.date, { inbound: item.inbound, outbound: item.outbound }]));
    inboundData = labels.map(date => dataMap.get(date)?.inbound || 0);
    outboundData = labels.map(date => dataMap.get(date)?.outbound || 0);
  } else {
    // สำหรับกราฟ 7 วัน
    const dataMap = new Map(data.map(item => [item.date, { inbound: item.inbound, outbound: item.outbound }]));
    labels = getLast7Days();
    inboundData = labels.map(date => dataMap.get(date)?.inbound || 0);
    outboundData = labels.map(date => dataMap.get(date)?.outbound || 0);
  }

  // ✅ สร้างกราฟ
  barChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Inbound (เข้า)',
          data: inboundData,
          backgroundColor: 'rgba(16, 185, 129, 0.8)',
          borderColor: 'rgba(16, 185, 129, 1)',
          borderWidth: 2,
          borderRadius: 6,
          borderSkipped: false,
        },
        {
          label: 'Outbound (ออก)',
          data: outboundData,
          backgroundColor: 'rgba(245, 158, 11, 0.8)',
          borderColor: 'rgba(245, 158, 11, 1)',
          borderWidth: 2,
          borderRadius: 6,
          borderSkipped: false,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: {
        legend: {
          position: 'top',
          labels: {
            usePointStyle: true,
            font: {
              family: 'Prompt',
              weight: '600'
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          titleColor: '#f8fafc',
          bodyColor: '#e2e8f0',
          borderColor: 'rgba(16, 185, 129, 0.3)',
          borderWidth: 1,
          cornerRadius: 12,
          titleFont: {
            family: 'Prompt',
            weight: '600'
          },
          bodyFont: {
            family: 'Prompt'
          }
        }
      },
      scales: {
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              family: 'Prompt'
            }
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(226, 232, 240, 0.5)',
            drawBorder: false
          },
          ticks: {
            font: {
              family: 'Prompt'
            }
          }
        }
      }
    }
  });
}

// ✅ เพิ่มฟังก์ชันที่หายไป
function getLast7Days() {
  const days = [];
  const today = new Date();
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(today.getDate() - i);
    
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    days.push(`${day}/${month}`);
  }
  
  return days;
}



function getLast30Days() {
  const days = [];
  const today = new Date();
  
  for (let i = 29; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(today.getDate() - i);
    
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    days.push(`${day}/${month}`);
  }
  
  return days;
}
// ✅ ฟังก์ชัน Event Listeners
function setupOverviewEventListeners() {
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (currentPage !== 'overview') return;
    
    switch(e.key) {
      case 'r':
      case 'R':
        if (e.ctrlKey || e.metaKey) {
          e.preventDefault();
          refreshAllData();
        }
        break;
      case 'Escape':
        // ปิด tooltips หรือ modals
        document.querySelectorAll('.tooltip').forEach(el => {
          el.classList.remove('show');
        });
        break;
    }
  });

  // Click outside to close tooltips
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.tooltip')) {
      document.querySelectorAll('.tooltip').forEach(el => {
        el.classList.remove('show');
      });
    }
  });
}

// ✅ ฟังก์ชันรีเฟรชข้อมูลทั้งหมด
function refreshAllData() {
  showNotification('กำลังรีเฟรชข้อมูลทั้งหมด...', 'info');
  showOverviewLoading();
  loadFullOverviewData(currentStation);
}

// ✅ ฟังก์ชันรีเฟรชสถานะระบบ
function refreshSystemStatus() {
  showNotification('กำลังตรวจสอบสถานะระบบ...', 'info');
  loadSystemStatus();
}

// ✅ ฟังก์ชันรีเฟรชกิจกรรม
function refreshActivityFeed() {
  const feedContainer = document.getElementById('activityFeed');
  if (feedContainer) {
    feedContainer.innerHTML = `
      <div class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>กำลังโหลดกิจกรรม...</p>
      </div>
    `;
  }
  loadRecentActivity();
}

// ✅ ฟังก์ชันรีเซ็ตข้อมูลสภาพแวดล้อม
function resetEnvironmentalData() {
  // แสดง loading ใน environmental cards
  ['tempValue', 'humidityValue', 'co2Value', 'lightValue'].forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
  });
  
  // โหลดข้อมูลใหม่หลังจาก 1 วินาที
  setTimeout(() => {
    loadEnvironmentalData();
    showNotification('ข้อมูลสภาพแวดล้อมถูกรีเซ็ตแล้ว', 'success');
  }, 1000);
}

// ✅ ฟังก์ชันแสดงการตั้งค่า Overview
function showOverviewSettings() {
  const settings = [
    'รีเฟรชอัตโนมัติ: 30 วินาที',
    'แสดงข้อมูลแบบ Real-time',
    'เก็บประวัติกิจกรรม: 100 รายการ',
    'การแจ้งเตือน: เปิดใช้งาน'
  ];
  
  const settingsText = settings.join('\n');
  showNotification(`ตั้งค่าปัจจุบัน:\n${settingsText}`, 'info');
}

// ✅ ฟังก์ชันแสดงการแจ้งเตือน
function showNotification(message, type = 'info') {
  // สร้าง notification element
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  
  const iconMap = {
    'success': 'fas fa-check-circle',
    'error': 'fas fa-exclamation-triangle',
    'warning': 'fas fa-exclamation-circle',
    'info': 'fas fa-info-circle'
  };
  
  notification.innerHTML = `
    <div style="display: flex; align-items: center; gap: 0.75rem;">
      <i class="${iconMap[type] || iconMap.info}"></i>
      <span style="white-space: pre-line;">${message}</span>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // แสดง notification
  setTimeout(() => notification.classList.add('show'), 100);
  
  // ซ่อน notification หลังจาก 4 วินาที
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 400);
  }, 4000);
}

// ✅ Auto refresh ทุก 30 วินาที (ใช้ตัวแปรเดิม)
function startOverviewAutoRefresh() {
  // เคลียร์ interval เก่า
  if (window.overviewRefreshInterval) {
    clearInterval(window.overviewRefreshInterval);
  }
  
  window.overviewRefreshInterval = setInterval(() => {
    if (currentPage === 'overview') {
      // โหลดเฉพาะข้อมูลที่จำเป็น (ไม่รวมกราฟเพื่อไม่ให้กระพริบ)
      loadSummaryCards();
      loadUsersAndTasks();
      loadSystemStatus();
      loadRecentActivity();
      // Environmental data มี interval ของตัวเองแล้ว
    }
  }, 30000); // 30 วินาที
  
  console.log('📊 Overview auto-refresh started (30s interval)');
}

// ✅ หยุด auto refresh เมื่อออกจากหน้า overview
function stopOverviewAutoRefresh() {
  if (window.overviewRefreshInterval) {
    clearInterval(window.overviewRefreshInterval);
    window.overviewRefreshInterval = null;
    console.log('📊 Overview auto-refresh stopped');
  }
  
  if (window.envUpdateInterval) {
    clearInterval(window.envUpdateInterval);
    window.envUpdateInterval = null;
    console.log('🌡️ Environmental data update stopped');
  }
}

// ✅ เพิ่มใน activeTimers เพื่อให้ clearActiveTimers() ล้างได้
function addToActiveTimers() {
  if (window.overviewRefreshInterval) {
    activeTimers.push(window.overviewRefreshInterval);
  }
  if (window.envUpdateInterval) {
    activeTimers.push(window.envUpdateInterval);
  }
}



// ✅ ปรับปรุงฟังก์ชัน renderPie (ถ้าต้องการใช้แทนที่เดิม)
function renderPieEnhanced(data) {
  if (pieChartInstance) {
    pieChartInstance.destroy();
  }

  const ctx = document.getElementById('pieChart').getContext('2d');
  pieChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Inbound (เข้า)', 'Outbound (ออก)'],
      datasets: [{
        data: [data.inbound || 0, data.outbound || 0],
        backgroundColor: [
          'rgba(16, 185, 129, 0.8)',
          'rgba(245, 158, 11, 0.8)'
        ],
        borderColor: [
          'rgba(16, 185, 129, 1)',
          'rgba(245, 158, 11, 1)'
        ],
        borderWidth: 3,
        cutout: '60%',
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: {
        duration: 1500,
        easing: 'easeInOutCubic'
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            font: {
              family: 'Prompt',
              size: 12,
              weight: '600'
            },
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          titleColor: '#f8fafc',
          bodyColor: '#e2e8f0',
          borderColor: 'rgba(16, 185, 129, 0.3)',
          borderWidth: 1,
          cornerRadius: 12,
          titleFont: {
            family: 'Prompt',
            weight: '600'
          },
          bodyFont: {
            family: 'Prompt'
          },
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
              return `${context.label}: ${context.parsed} (${percentage}%)`;
            }
          }
        }
      },
      interaction: {
        intersect: false
      }
    }
  });
}

// ✅ ปรับปรุงฟังก์ชัน renderHourly สำหรับกราฟรายชั่วโมง
function renderHourlyEnhanced(data) {
  if (hourlyChartInstance) {
    hourlyChartInstance.destroy();
  }

  const labels = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
  const chartData = labels.map((_, hour) => {
    const hourData = data.find(item => item.hour === hour);
    return hourData ? hourData.total : Math.floor(Math.random() * 10); // Mock data ถ้าไม่มี
  });

  const ctx = document.getElementById('hourlyChart').getContext('2d');
  hourlyChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'กิจกรรมรายชั่วโมง',
        data: chartData,
        borderColor: 'rgba(59, 130, 246, 1)',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        fill: true,
        tension: 0.4,
        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
        pointBorderColor: '#ffffff',
        pointBorderWidth: 3,
        pointRadius: 5,
        pointHoverRadius: 8,
        borderWidth: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: {
        duration: 1200,
        easing: 'easeInOutCubic'
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          titleColor: '#f8fafc',
          bodyColor: '#e2e8f0',
          borderColor: 'rgba(59, 130, 246, 0.3)',
          borderWidth: 1,
          cornerRadius: 12,
          titleFont: {
            family: 'Prompt',
            weight: '600'
          },
          bodyFont: {
            family: 'Prompt'
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(226, 232, 240, 0.5)',
            drawBorder: false
          },
          ticks: {
            font: {
              family: 'Prompt',
              size: 11
            },
            color: '#64748b'
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              family: 'Prompt',
              size: 10
            },
            color: '#64748b',
            maxTicksLimit: 12
          }
        }
      },
      interaction: {
        intersect: false,
        mode: 'index'
      }
    }
  });
}

// ✅ ฟังก์ชันตรวจสอบสถานะการเชื่อมต่อ
function checkConnectionStatus() {
  return navigator.onLine;
}

// ✅ ฟังก์ชันจัดการเมื่อออนไลน์/ออฟไลน์
function setupConnectionHandlers() {
  window.addEventListener('online', () => {
    showNotification('กลับมาออนไลน์แล้ว กำลังซิงค์ข้อมูล...', 'success');
    
    // ✅ รีสตาร์ท Light Control Scheduler เมื่อเน็ตกลับมา
    setTimeout(() => {
      console.log('🔄 Network recovered, restarting light scheduler...');
      
      // รีโหลดข้อมูล overview หากอยู่ในหน้านั้น
      if (currentPage === 'overview') {
        loadFullOverviewData(currentStation);
      }
      
      // รีสตาร์ท light control scheduler
      if (currentPage === 'light-control' || typeof startLightControlPolling === 'function') {
        restartLightControlSystem();
      }
      
      // ตรวจสอบและรีสตาร์ท WebSocket หากจำเป็น
      if (typeof initSensorWebSocket === 'function') {
        initSensorWebSocket();
      }
      
    }, 2000); // รอ 2 วินาทีให้เชื่อมต่อเสถียร
  });

  window.addEventListener('offline', () => {
    showNotification('การเชื่อมต่ออินเทอร์เน็ตขาดหาย', 'warning');
    console.log('📡 Network lost, light scheduler may be affected');
  });
}

// ✅ ฟังก์ชันรีสตาร์ท Light Control System หลังเน็ตกลับมา
function restartLightControlSystem() {
  try {
    console.log('🔄 Restarting Light Control System...');
    
    // รีโหลดสถานะ light control จาก backend
    if (typeof updateLightControlUIStateFromBackend === 'function') {
      updateLightControlUIStateFromBackend();
    }
    
    // รีสตาร์ท polling timer หากจำเป็น
    if (typeof startLightControlPolling === 'function') {
      startLightControlPolling();
    }
    
    // ตรวจสอบและรีโหลด schedule ใหม่
    if (typeof loadSchedulesFromDB === 'function') {
      loadSchedulesFromDB().then(() => {
        console.log('✅ Light schedules reloaded successfully');
      }).catch(err => {
        console.error('❌ Failed to reload schedules:', err);
      });
    }
    
    showToast('🔄 รีสตาร์ท Light Control สำเร็จ', true);
    
  } catch (error) {
    console.error('❌ Failed to restart light control system:', error);
    showToast('⚠️ รีสตาร์ท Light Control ล้มเหลว', false);
  }
}

// ✅ ฟังก์ชันตรวจสอบสถานะ network แบบ periodic
let networkCheckInterval = null;

function startNetworkMonitoring() {
  // หยุด interval เก่าก่อน
  if (networkCheckInterval) {
    clearInterval(networkCheckInterval);
  }
  
  networkCheckInterval = setInterval(() => {
    if (!navigator.onLine) {
      console.log('📡 Network is offline, systems may be affected');
    } else {
      // ตรวจสอบการเชื่อมต่อจริงด้วยการ ping backend
      fetch('/api/health', { 
        method: 'GET',
        timeout: 5000 
      })
      .then(response => {
        if (!response.ok) {
          console.log('⚠️ Backend connection issue detected');
        }
      })
      .catch(error => {
        console.log('❌ Backend unreachable, may need system restart');
        // ลองรีสตาร์ท light control อัตโนมัติ
        restartLightControlSystem();
      });
    }
  }, 30000); // ตรวจสอบทุก 30 วินาที
}

// ✅ ฟังก์ชันหยุด network monitoring
function stopNetworkMonitoring() {
  if (networkCheckInterval) {
    clearInterval(networkCheckInterval);
    networkCheckInterval = null;
    console.log('📡 Network monitoring stopped');
  }
}

// ✅ Cleanup เมื่อออกจากหน้า
window.addEventListener('beforeunload', () => {
  stopNetworkMonitoring();
});

// ✅ ฟังก์ชันสำหรับ Performance Monitoring
function logPerformance(action, startTime) {
  const endTime = performance.now();
  const duration = endTime - startTime;
  console.log(`⚡ Performance: ${action} took ${duration.toFixed(2)}ms`);
  
  // ถ้าใช้เวลานานเกิน 2 วินาที แสดงการแจ้งเตือน
  if (duration > 2000) {
    console.warn(`⚠️ Slow performance detected: ${action} took ${duration.toFixed(2)}ms`);
  }
}

// ✅ ฟังก์ชันสำหรับจัดการ Memory
function cleanupOverviewResources() {
  // ทำลาย Chart instances
  if (pieChartInstance) {
    pieChartInstance.destroy();
    pieChartInstance = null;
  }
  if (barChartInstance) {
    barChartInstance.destroy();
    barChartInstance = null;
  }
  if (hourlyChartInstance) {
    hourlyChartInstance.destroy();
    hourlyChartInstance = null;
  }
  
  // ล้าง intervals
  stopOverviewAutoRefresh();
  
  console.log('🧹 Overview resources cleaned up');
}

// ✅ เพิ่มฟังก์ชันในการ override showPage เพื่อจัดการ cleanup
const originalShowPage = window.showPage;
if (originalShowPage) {
  window.showPage = function(page, event) {
    // ถ้าออกจากหน้า overview ให้ cleanup
    if (currentPage === 'overview' && page !== 'overview') {
      cleanupOverviewResources();
    }
    
    // เรียกฟังก์ชันเดิม
    return originalShowPage.call(this, page, event);
  };
}

// ✅ เริ่มต้น Connection Handlers เมื่อโหลด
if (typeof document !== 'undefined') {
  document.addEventListener('DOMContentLoaded', () => {
    setupConnectionHandlers();
    startNetworkMonitoring(); // เริ่มต้นการตรวจสอบ network
    
    // ตรวจสอบสถานะเริ่มต้น
    if (!navigator.onLine) {
      showNotification('ไม่มีการเชื่อมต่ออินเทอร์เน็ต', 'warning');
    }
  });
}

// ✅ Export functions สำหรับการใช้งาน
window.overviewFunctions = {
  renderOverviewPage,
  initOverviewPage,
  loadFullOverviewData,
  switchTimeRange,
  refreshAllData,
  refreshSystemStatus,
  refreshActivityFeed,
  resetEnvironmentalData,
  showOverviewSettings,
  stopOverviewAutoRefresh,
  cleanupOverviewResources
};

console.log('🎨 Enhanced Overview JavaScript loaded successfully!');


// ✅ Global State
let currentFloor = 1;
let liftAnimation = null;
let isEmergency = false;
let liftStatusTimer = null;
let currentUser = JSON.parse(localStorage.getItem("loggedInUser") || "{}");

// ✅ Map ชั้น → ตำแหน่ง %
const levelTop = {
  1: 70, 2: 60, 3: 50, 4: 39, 5: 30,
  6: 20, 7: 12, 8: 5, 9: -1
};

// ✅ แสดงผลตำแหน่งลิฟต์ + จุด sensor
function updateLiftDisplay(floor) {
  const liftCart = document.getElementById("liftCart");
  if (!liftCart) return;

  animateLiftTo(levelTop[floor] ?? 60);

  const floorDisplay = document.getElementById("currentFloor");
  if (floorDisplay) floorDisplay.innerText = floor;

  for (let i = 1; i <= 9; i++) {
    const dot = document.querySelector(`#floor-${i} [data-light]`);
    if (dot) {
      dot.style.background = (i === floor) ? '#52b788' : '#ccc';
      dot.style.boxShadow = (i === floor) ? '0 0 8px #52b788' : 'none';
    }
  }
}

// ✅ เคลื่อน lift อย่างนุ่มนวล
function animateLiftTo(targetPercent) {
  const liftCart = document.getElementById("liftCart");
  if (!liftCart) return;

  cancelAnimationFrame(liftAnimation);
  let currentTop = parseFloat(liftCart.style.top?.replace('%', '')) || targetPercent;
  const duration = 800;
  const startTime = performance.now();

  function step(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 0.5 * (1 - Math.cos(Math.PI * progress));
    const newTop = currentTop + (targetPercent - currentTop) * eased;
    liftCart.style.top = `${newTop}%`;
    if (progress < 1) liftAnimation = requestAnimationFrame(step);
  }

  requestAnimationFrame(step);
}

// ✅ สั่งให้ลิฟต์ไปยังชั้นที่เลือกผ่าน REST
async function moveLift() {
  const targetFloor = parseInt(document.getElementById("floorSelect").value);
  if (!targetFloor || isNaN(targetFloor)) {
    alert("❌ กรุณาเลือกชั้นให้ถูกต้อง");
    return;
  }

  try {
    const res = await fetch("/api/lift/move", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: currentUser.id,
        fromFloor: currentFloor,
        toFloor: targetFloor,
        station: currentStation
      })
    });

    const result = await res.json();
    showToast(`📤 ${result.message}`);
    logLiftAction(currentUser.id, `สั่งลิฟต์ไปชั้น ${targetFloor}`, currentStation, targetFloor);
  } catch (err) {
    showToast("❌ สั่งลิฟต์ล้มเหลว");
    console.error("Move Lift Error:", err.message);
  }
}

// ✅ Jog Up / Down (REST)
function startLiftMove(direction) {
  const action = direction === "up" ? "jogUp" : "jogDown";
  fetch("/api/lift/jog", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId: currentUser.id,
      station: currentStation,
      action: action
    })
  });

  logLiftAction(currentUser.id, `สั่ง Jog ${direction === 'up' ? 'ขึ้น' : 'ลง'}`, currentStation, null);
}

// ✅ หยุด Jog
function stopLiftMove() {
  fetch("/api/lift/stop", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId: currentUser.id,
      station: currentStation
    })
  });

  logLiftAction(currentUser.id, "หยุดลิฟต์ (Jog)", currentStation, null);
}

// ✅ ปุ่ม EMERGENCY (REST)
function toggleEmergency() {
  isEmergency = !isEmergency;

  fetch("/api/lift/emergency", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId: currentUser.id,
      station: currentStation
    })
  });

  const emBtn = document.getElementById("emButton");
  const statusBox = document.getElementById("liftStatusBox");

  if (isEmergency) {
    emBtn.innerText = "✅ กลับสู่สถานะปกติ";
    emBtn.style.background = "#444";
    if (statusBox) statusBox.innerText = "🚨 ลิฟต์ทำงานผิดปกติ";
  } else {
    emBtn.innerText = "⛔ หยุดลิฟต์ทันที";
    emBtn.style.background = "#c1121f";
    if (statusBox) statusBox.innerText = "🟢 ระบบทำงานปกติ";
  }

  logLiftAction(currentUser.id, `EMERGENCY: ${isEmergency ? 'ON' : 'OFF'}`, currentStation, null);
}
function startLiftStatusPolling() {
  if (liftStatusTimer) clearInterval(liftStatusTimer);

  liftStatusTimer = setInterval(async () => {
    try {
      const res = await fetch(`/api/lift/status?station=${currentStation}`);
      const data = await res.json();

      // ✅ Debug log: ดูค่าจริงที่ได้จาก backend
      console.log("[Lift Polling]", data);

      if (!data || typeof data.floor !== "number") return;

      // ✅ อัปเดตตำแหน่งลิฟต์จาก floor sensor จริง
      currentFloor = data.floor;
      updateLiftDisplay(data.floor);

      // ✅ แสดงสถานะการเคลื่อนที่ (ข้อความเล็ก)
      const movingStatus = document.getElementById("movingStatus");
      if (movingStatus) {
        movingStatus.innerText = data.moving ? "กำลังเคลื่อนที่..." : "หยุดนิ่ง";
      }

      // ✅ กล่องแสดงสถานะลิฟต์แบบพรีเมียม
      const statusBox = document.getElementById("liftStatusBox");
      if (statusBox) {
        // ล้าง class เดิม
        statusBox.classList.remove("success", "emergency", "recovery", "working");

        if (Boolean(data.emergency)) {
          // 🟥 หยุดฉุกเฉิน
          statusBox.classList.add("emergency");
          statusBox.innerHTML = `
            <i class="lucide lucide-alert-triangle" style="margin-right: 6px;"></i>
            ลิฟต์หยุดฉุกเฉิน (Emergency Stop)
          `;

        } else if (Boolean(data.recovery)) {
          // 🟧 Recovery กลับตำแหน่งปลอดภัย
          statusBox.classList.add("recovery");
          statusBox.innerHTML = `
            <i class="lucide lucide-rotate-cw" style="margin-right: 6px;"></i>
            กำลังนำลิฟต์กลับสู่ตำแหน่งปลอดภัย...
          `;

        } else if (Boolean(data.moving)) {
          // 🟦 กำลังทำงาน
          statusBox.classList.add("working");
          statusBox.innerHTML = `
            <i class="lucide lucide-truck" style="margin-right: 6px;"></i>
            ลิฟต์กำลังทำงาน
          `;
        } else {
          // 🟢 ปกติ
          statusBox.classList.add("success");
          statusBox.innerHTML = `
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="margin-right: 12px;">
              <circle cx="12" cy="12" r="10" fill="#2dcc6f"/>
              <path d="M9 12.5l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            ระบบทำงานปกติ
          `;
        }
      }

      // ✅ บันทึกสถานะ EM ทั่วระบบ
      isEmergency = Boolean(data.emergency);

    } catch (err) {
      console.warn("❌ โหลดสถานะลิฟต์ล้มเหลว:", err.message);
    }
  }, 500); // polling ทุก 0.5 วินาที
}




// ✅ Log ไป backend
function logLiftAction(userId, activity, station, floor) {
  fetch("/api/log", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId,
      activity,
      action_type: "lift",
      category: "ลิฟต์",
      station,
      floor
    })
  });
}

// ✅ Toast
function showToast(msg) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.innerText = msg;
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    z-index: 9999;
    font-size: 14px;
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ✅ Init ตอนโหลดหน้า
function initLiftPage() {
  const liftCart = document.getElementById("liftCart");
  if (liftCart && levelTop[currentFloor]) {
    liftCart.style.top = `${levelTop[currentFloor]}%`;
  }

  const select = document.getElementById("floorSelect");
  if (select) select.value = currentFloor;

  const display = document.getElementById("currentFloor");
  if (display) display.innerText = currentFloor;

  startLiftStatusPolling();
}

//agv
function handleSlotSelection(slot) {
  if (slot) {
    sendAgvCommandUI(`go_slot${slot}`);
  }
}


// ✅ WebSocket connection for real-time sensor updates
let sensorWebSocket;
let sensorFallbackTimer;
let isWebSocketConnected = false;

function initSensorWebSocket() {
  const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${wsProtocol}//${window.location.host}`;
  
  sensorWebSocket = new WebSocket(wsUrl);
  
  sensorWebSocket.onopen = () => {
    console.log('🔗 Sensor WebSocket connected');
    isWebSocketConnected = true;
    // หยุด fallback polling เมื่อ WebSocket เชื่อมต่อสำเร็จ
    if (sensorFallbackTimer) {
      clearInterval(sensorFallbackTimer);
      sensorFallbackTimer = null;
    }
  };
  
  sensorWebSocket.onmessage = (event) => {
    try {
      const message = JSON.parse(event.data);
      if (message.type === 'sensor_update') {
        updateSensorDisplay(message.data);
        console.log('📡 Real-time sensor update received:', message.data);
      }
    } catch (err) {
      console.error('WebSocket message parse error:', err);
    }
  };
  
  sensorWebSocket.onclose = () => {
    console.log('❌ Sensor WebSocket disconnected, using fallback polling...');
    isWebSocketConnected = false;
    startSensorFallback();
    setTimeout(initSensorWebSocket, 3000);
  };
  
  sensorWebSocket.onerror = (error) => {
    console.error('WebSocket error:', error);
    isWebSocketConnected = false;
    startSensorFallback();
  };
}

function startSensorFallback() {
  if (sensorFallbackTimer) return; // ป้องกันการสร้าง timer ซ้ำ
  console.log('🔄 Starting sensor fallback polling (500ms interval)');
  sensorFallbackTimer = setInterval(() => {
    if (!isWebSocketConnected) {
      fetchAgvSensorStatus();
    }
  }, 500); // polling ทุก 0.5 วินาที เมื่อ WebSocket ไม่ทำงาน
}

function updateSensorDisplay(data) {
  document.querySelector('#sensorTray span').textContent = data.tray_sensor ? "✅ มีถาด" : "❌ ไม่มีถาด";
  document.querySelector('#sensorPos1 span').textContent = data.pos_sensor_1 ? "ถึงตำแหน่ง" : "ปกติ";
  document.querySelector('#sensorPos2 span').textContent = data.pos_sensor_2 ? "ถึงตำแหน่ง" : "ปกติ";
}

//  status  sensor (fallback function)
async function fetchAgvSensorStatus() {
  try {
    const res = await fetch('/api/sensors');
    if (!res.ok) throw new Error("โหลดข้อมูลไม่สำเร็จ");
    const data = await res.json();

    updateSensorDisplay(data);
  } catch (err) {
    console.error("[AGV Sensor] ⚠️ โหลดข้อมูลผิดพลาด:", err);
    document.querySelector('#sensorTray span').textContent = "⚠️";
    document.querySelector('#sensorPos1 span').textContent = "⚠️";
    document.querySelector('#sensorPos2 span').textContent = "⚠️";
  }
}

async function sendAgvCommand(command) {
  try {
    const res = await fetch('/api/agv/manual', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id,
        station: currentStation, // ✅ [แก้ไข] ใช้ตัวแปร currentStation
        command
      })
    });
    const data = await res.json();
    console.log('✅ AGV command sent:', data.message);
  } catch (err) {
    console.error('❌ AGV Command Error:', err);
    alert('ส่งคำสั่ง AGV ไม่สำเร็จ');
  }
}

function handleSlotManual() {
  const slot = document.getElementById("slotSelectManual").value;
  if (!slot) {
    alert("กรุณาเลือกช่องก่อน");
    return;
  }
  const cmd = `go_slot${slot}`;
  sendAgvCommand(cmd);
}


async function sendTrayCommand(command) {
  try {
    const res = await fetch('/api/tray/manual', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id,
       station: currentStation, // ✅ [แก้ไข] ใช้ตัวแปร currentStation
        command  // เช่น tray_up, tray_down
      })
    });
    const data = await res.json();
    console.log('✅ TRAY command sent:', data.message);
  } catch (err) {
    console.error('❌ Tray Command Error:', err);
    alert('ส่งคำสั่ง TRAY ไม่สำเร็จ');
  }
}
let allTaskHistoryData = [];
let taskHistoryCurrentPage = 1;
const taskHistoryRowsPerPage = 20; // 🟢 แสดงผลหน้าละ 20 รายการ

// 1. ฟังก์ชันเริ่มต้น (เหมือนเดิม แต่เรียกฟังก์ชันที่ถูกต้อง)
async function initTaskHistoryPage() {
    try {
        const station = currentStation || 1;
        const res = await fetch(`/api/task/history?station=${station}`);
        if (!res.ok) throw new Error(`API Error: ${res.status}`);
        
        allTaskHistoryData = await res.json();
        
        // ✅ [เพิ่มบรรทัดนี้] เพื่อเรียกใชฟังก์ชันอัปเดตการ์ดสรุป
        updateTaskHistoryStats(allTaskHistoryData); 
        
        setupHistoryEventListeners(); 
        filterAndRenderHistoryTable(); 
    } catch (err) {
        console.error("❌ Failed to load task history:", err);
        const tbody = document.getElementById("taskHistoryTableBody");
        if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:red;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
    }
}
// 2. ฟังก์ชันผูก Event Listener (เหมือนเดิม)
function setupHistoryEventListeners() {
    const searchInput = document.getElementById('historySearch');
    const filterSelect = document.getElementById('historyFilter');

    if (searchInput) searchInput.addEventListener('input', () => {
        taskHistoryCurrentPage = 1;
        filterAndRenderHistoryTable();
    });
    if (filterSelect) filterSelect.addEventListener('change', () => {
        taskHistoryCurrentPage = 1;
        filterAndRenderHistoryTable();
    });
}

// 3. ฟังก์ชันหลักสำหรับกรองและแสดงผลทั้งหมด
function filterAndRenderHistoryTable() {
    const searchInput = document.getElementById('historySearch');
    const filterSelect = document.getElementById('historyFilter');

    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    const filterType = filterSelect ? filterSelect.value : '';

    const filteredData = allTaskHistoryData.filter(task => {
        const matchesSearch = !searchTerm ||
            (task.tray_id && task.tray_id.toLowerCase().includes(searchTerm)) ||
            (task.username && task.username.toLowerCase().includes(searchTerm));
        const matchesFilter = !filterType || task.action_type === filterType;
        return matchesSearch && matchesFilter;
    });

    const totalPages = Math.ceil(filteredData.length / taskHistoryRowsPerPage);
    if(taskHistoryCurrentPage > totalPages && totalPages > 0) taskHistoryCurrentPage = totalPages;

    const start = (taskHistoryCurrentPage - 1) * taskHistoryRowsPerPage;
    const pageTasks = filteredData.slice(start, start + taskHistoryRowsPerPage);

    renderTaskHistoryTable(pageTasks); // วาดเฉพาะข้อมูลในตาราง
    renderTaskHistoryPagination(filteredData.length, totalPages); // วาดปุ่ม Pagination
}

// 4. ฟังก์ชันสำหรับวาดข้อมูลลงในตาราง (tbody)
function renderTaskHistoryTable(tasks) {
    const tbody = document.getElementById("taskHistoryTableBody");
    if (!tbody) return;

    tbody.innerHTML = "";
    if (!tasks || tasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">ไม่พบประวัติงาน</td></tr>';
        return;
    }

    tasks.forEach(task => {
        const tr = document.createElement("tr");
        tr.className = 'fade-in-row';
        // (โค้ดสร้าง <tr> เหมือนเดิม ไม่ต้องเปลี่ยน)
        const statusClass = `status-enhanced ${task.status}`;
        const endTime = task.completed_at ? new Date(task.completed_at).toLocaleString("th-TH") : '-';
        const actionBadge = task.action_type === 'inbound'
          ? '<span class="action-badge inbound"><i class="fas fa-arrow-down"></i> นำเข้า</span>'
          : '<span class="action-badge outbound"><i class="fas fa-arrow-up"></i> นำออก</span>';
        tr.innerHTML = `
          <td><strong>${task.tray_id}</strong></td>
          <td><span class="floor-badge">ชั้น ${task.floor || '-'}</span></td>
          <td><span class="slot-badge">ช่อง ${task.slot || '-'}</span></td>
          <td><span class="${statusClass}">${convertStatusLabel(task.status)}</span></td>
          <td>${new Date(task.created_at).toLocaleString("th-TH")}</td>
          <td>${endTime}</td>
          <td>${actionBadge}</td>
          <td><span class="user-badge"><i class="fas fa-user-circle"></i> ${task.username || '-'}</span></td>
        `;
        tbody.appendChild(tr);
    });
}

// 5. 🟢 [เพิ่มใหม่] ฟังก์ชันสำหรับวาด Pagination
function renderTaskHistoryPagination(totalItems, totalPages) {
    const paginationContainer = document.getElementById('taskHistoryPagination');
    if (!paginationContainer) return;

    if (totalItems === 0) {
        paginationContainer.innerHTML = '';
        return;
    }

    const startItem = (taskHistoryCurrentPage - 1) * taskHistoryRowsPerPage + 1;
    const endItem = Math.min(startItem + taskHistoryRowsPerPage - 1, totalItems);

    let buttonsHtml = '';
    // ปุ่ม Previous
    buttonsHtml += `<button onclick="goToTaskHistoryPage(${taskHistoryCurrentPage - 1})" ${taskHistoryCurrentPage === 1 ? 'disabled' : ''}>&laquo; ก่อนหน้า</button>`;

    // ปุ่มตัวเลข (แสดงแค่ 5 หน้า)
    const startPage = Math.max(1, taskHistoryCurrentPage - 2);
    const endPage = Math.min(totalPages, startPage + 4);

    for (let i = startPage; i <= endPage; i++) {
        buttonsHtml += `<button onclick="goToTaskHistoryPage(${i})" class="${i === taskHistoryCurrentPage ? 'active' : ''}">${i}</button>`;
    }

    // ปุ่ม Next
    buttonsHtml += `<button onclick="goToTaskHistoryPage(${taskHistoryCurrentPage + 1})" ${taskHistoryCurrentPage === totalPages ? 'disabled' : ''}>ถัดไป &raquo;</button>`;

    paginationContainer.innerHTML = `
        <div class="pagination-summary">
            แสดง ${startItem}-${endItem} จาก ${totalItems} รายการ
        </div>
        <div class="pagination-buttons">
            ${buttonsHtml}
        </div>
    `;
}

// 6. 🟢 [เพิ่มใหม่] ฟังก์ชันสำหรับเปลี่ยนหน้า
function goToTaskHistoryPage(page) {
    if (page < 1) return;
    const totalPages = Math.ceil(allTaskHistoryData.length / taskHistoryRowsPerPage);
    if (page > totalPages && totalPages > 0) return;
    
    taskHistoryCurrentPage = page;
    filterAndRenderHistoryTable();
    document.querySelector('.table-responsive-wrapper').scrollIntoView({ behavior: 'smooth' });
}
function openExportModal() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;
    document.querySelector('input[name="exportRange"][value="all"]').checked = true;
    toggleDateInputs();
    document.getElementById('exportDateModal').style.display = 'flex';
}

function closeExportModal() {
    document.getElementById('exportDateModal').style.display = 'none';
}

function toggleDateInputs() {
    const selectedRange = document.querySelector('input[name="exportRange"]:checked').value;
    document.getElementById('dateRangePicker').style.display = selectedRange === 'range' ? 'grid' : 'none';
}

// 2. ฟังก์ชันที่ถูกเรียกเมื่อกดยืนยันใน Pop-up
function initiateExport() {
    const filterType = document.querySelector('input[name="exportRange"]:checked').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    closeExportModal(); // ปิด Pop-up ก่อนเริ่มโหลด
    exportTaskHistoryToExcel(filterType, startDate, endDate);
}

function exportTaskHistoryToExcel(filterType, startDate, endDate) {
    let dataToExport = allTaskHistoryData;
    let reportTitle = 'Task History (All Data)';
    let fileName = `task_history_all_${new Date().toISOString().split('T')[0]}.xlsx`;

    // --- 🟢 ส่วนที่อัปเกรด: กรองข้อมูลตามเงื่อนไขที่ซับซ้อนขึ้น ---
    if (filterType === 'today') {
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        const todayEnd = new Date();
        todayEnd.setHours(23, 59, 59, 999);

        dataToExport = allTaskHistoryData.filter(task => {
            const taskDate = new Date(task.completed_at || task.created_at);
            return taskDate >= todayStart && taskDate <= todayEnd;
        });
        reportTitle = `Task History (Today: ${new Date().toLocaleDateString('th-TH')})`;
        fileName = `task_history_today_${new Date().toISOString().split('T')[0]}.xlsx`;

    } else if (filterType === 'range') {
        if (!startDate || !endDate) {
            alert("กรุณาเลือกวันที่เริ่มต้นและสิ้นสุดให้ครบถ้วน");
            return;
        }
        const start = new Date(startDate);
        start.setHours(0, 0, 0, 0);
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);

        dataToExport = allTaskHistoryData.filter(task => {
            const taskDate = new Date(task.completed_at || task.created_at);
            return taskDate >= start && taskDate <= end;
        });
        reportTitle = `Task History (${startDate} to ${endDate})`;
        fileName = `task_history_range_${startDate}_to_${endDate}.xlsx`;
    }

    if (!dataToExport || dataToExport.length === 0) {
        showToast("ไม่พบข้อมูลสำหรับส่งออกตามเงื่อนไขที่เลือก", false);
        return;
    }
    
    showToast(`กำลังสร้างไฟล์ Excel... (${dataToExport.length} รายการ)`, true);

    // --- ส่วนที่เหลือของโค้ด XlsxPopulate เหมือนเดิม ---
    const exportDataFormatted = dataToExport.map((task, index) => [
        index + 1, task.tray_id, task.action_type === 'inbound' ? 'นำเข้า' : 'นำออก',
        `ชั้น ${task.floor}, ช่อง ${task.slot}`, task.status === 'success' ? 'สำเร็จ' : task.status,
        new Date(task.created_at).toLocaleString('th-TH'),
        task.completed_at ? new Date(task.completed_at).toLocaleString('th-TH') : '-',
        task.username
    ]);
    const headers = ["ลำดับ", "Tray ID", "ประเภท", "ตำแหน่ง", "สถานะ", "เวลาเริ่ม", "เวลาสำเร็จ", "ผู้ใช้"];

    XlsxPopulate.fromBlankAsync().then(workbook => {
        const sheet = workbook.sheet(0).name("Task History");
        sheet.cell("A1").value(`AGROTECH WMS - ${reportTitle}`).style({ bold: true, fontSize: 18, fontColor: "059669" });
        headers.forEach((header, i) => { sheet.cell(3, i + 1).value(header).style({ bold: true, fill: "10b981", fontColor: "ffffff", horizontalAlignment: "center", verticalAlignment: "center" }); });
        exportDataFormatted.forEach((row, r) => { row.forEach((val, c) => { sheet.cell(r + 4, c + 1).value(val); }); });
        sheet.column("A").width(8); sheet.column("B").width(15); sheet.column("C").width(12); sheet.column("D").width(20);
        sheet.column("E").width(12); sheet.column("F").width(22); sheet.column("G").width(22); sheet.column("H").width(18);
        sheet.row(3).height(25); sheet.range("A3:H3").autoFilter(); sheet.freezePanes(4, 1);
        return workbook.outputAsync();
    }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = fileName; a.click(); URL.revokeObjectURL(url);
    }).catch(err => {
        console.error("❌ Export Error:", err);
        showToast("เกิดข้อผิดพลาดในการส่งออก Excel", false);
    });
}

function toggleExcelDropdown(event) {
    event.stopPropagation();
    document.getElementById("excelDropdown").classList.toggle("show-menu");
}

// ปิดเมนูเมื่อคลิกที่อื่น
window.onclick = function(event) {
    if (!event.target.matches('.filter-btn')) {
        var dropdowns = document.getElementsByClassName("excel-dropdown-menu");
        for (var i = 0; i < dropdowns.length; i++) {
            var openDropdown = dropdowns[i];
            if (openDropdown.classList.contains('show-menu')) {
                openDropdown.classList.remove('show-menu');
            }
        }
    }
}

function formatStatus(status) {
  const statusMap = {
    'pending': '⏳ รอดำเนินการ',
    'working': '🚚 กำลังทำงาน',
    'at_workstation': '📦 รอที่ Workstation',
    'success': '✅ สำเร็จ',
    'error': '❌ ผิดพลาด'
  };
  return statusMap[status] || status;
}

async function loadTrayMasterData() {
    try {
        // ✅ [แก้ไข] เพิ่มการส่ง currentStation ไปยัง API
        const res = await fetch(`/api/tray-inventory?station=${currentStation}`);
        const trays = await res.json();
        const tbody = document.getElementById('trayMasterTableBody');

        if (!tbody) return;
        tbody.innerHTML = '';

        const searchQuery = document.getElementById('traySearchInput').value.toLowerCase();
        const statusFilter = document.getElementById('trayStatusFilter').value;
        const vegFilter = document.getElementById('trayVegFilter').value;

        // ✅ [แก้ไข] Backend จะกรองข้อมูลมาให้แล้ว แต่ยังคงการกรองฝั่ง Frontend ไว้สำหรับช่องค้นหา
        const filteredTrays = trays.filter(tray => {
            const searchMatch = (
                tray.tray_id.toLowerCase().includes(searchQuery) ||
                (tray.batch_id || '').toLowerCase().includes(searchQuery) ||
                tray.veg_type.toLowerCase().includes(searchQuery)
            );
            const statusMatch = !statusFilter || tray.status === statusFilter;
            const vegMatch = !vegFilter || tray.veg_type === vegFilter;
            return searchMatch && statusMatch && vegMatch;
        });

        if (filteredTrays.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding: 20px;">ไม่พบข้อมูลตามที่กรอง</td></tr>';
            return;
        }

        filteredTrays.forEach((tray, index) => {
            const age = calculateTrayAge(tray.time_in);
            const row = document.createElement('tr');

            // ✅ เพิ่มอนิเมชั่น
            row.className = 'fade-in-row';
            row.style.animationDelay = `${index * 50}ms`;

            // ✅ ใช้ดีไซน์ใหม่
            row.innerHTML = `
                <td>${tray.tray_id}</td>
                <td>${tray.batch_id || '-'}</td>
                <td>${tray.veg_type}</td>
                <td>ชั้น ${tray.floor} / ช่อง ${tray.slot}</td>
                <td>${tray.plant_quantity || '-'}</td>
                <td>${tray.seeding_date ? new Date(tray.seeding_date).toLocaleDateString('th-TH') : '-'}</td>
                <td>${age}</td>
                <td>${renderTrayStatusLabel(tray.status)}</td>
                <td>${tray.notes || '-'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn edit" onclick="editTray('${tray.tray_id}')">
                            <i class="fas fa-pencil-alt"></i> แก้ไข
                        </button>
                        <button class="action-btn history" onclick="toggleTrayHistory('${tray.tray_id}', this)">
                            <i class="fas fa-history"></i> ประวัติ
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);

            const historyRow = document.createElement('tr');
            historyRow.className = 'history-row';
            historyRow.id = `history-${tray.tray_id}`;
            historyRow.style.display = 'none';
            historyRow.innerHTML = `<td colspan="10"></td>`;
            tbody.appendChild(historyRow);
        });

    } catch (err) {
        console.error("❌ โหลดข้อมูล Tray Master ไม่สำเร็จ:", err);
        const tbody = document.getElementById('trayMasterTableBody');
        if(tbody) tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding: 20px;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
    }
}



function calculateTrayAgeInDays(time_in_string) {
    if (!time_in_string) return null;
    const startTime = new Date(time_in_string);
    const now = new Date();
    const diffMs = now.getTime() - startTime.getTime();
    if (diffMs < 0) return 0;
    return Math.floor(diffMs / (1000 * 60 * 60 * 24));
}

/**
 * Corrected function to export filtered Tray Master data to an Excel file.
 */
async function exportTrayMasterToExcel() {
    showToast('🚀 กำลังสร้างรายงาน Excel...', true);

    try {
        // 1. Fetch the latest full tray inventory data.
        const res = await fetch(`/api/tray-inventory?station=${currentStation}`);
        const allTrays = await res.json();

        // 2. Correctly get filter values from the existing HTML elements.
        const searchQuery = document.getElementById('traySearchInput').value.toLowerCase();
        const statusFilter = document.getElementById('trayStatusFilter').value;
        const vegFilter = document.getElementById('trayVegFilter').value;

        // 3. Filter the data based on the available filters.
        const filteredTrays = allTrays.filter(tray => {
            const searchMatch = !searchQuery || (
                tray.tray_id.toLowerCase().includes(searchQuery) ||
                (tray.batch_id || '').toLowerCase().includes(searchQuery) ||
                tray.veg_type.toLowerCase().includes(searchQuery)
            );
            const statusMatch = !statusFilter || tray.status === statusFilter;
            const vegMatch = !vegFilter || tray.veg_type === vegFilter;

            return searchMatch && statusMatch && vegMatch;
        });

        if (filteredTrays.length === 0) {
            showToast('⚠️ ไม่พบข้อมูลที่จะ Export ตามเงื่อนไขที่เลือก', false);
            return;
        }

        // 4. Create the workbook and worksheet.
        const workbook = await XlsxPopulate.fromBlankAsync();
        const sheet = workbook.sheet(0).name("Tray Master Report");

        // 5. Add report headers and information.
        sheet.range("A1:I1").merged(true).value("รายงานข้อมูลถาด (Tray Master Report)")
            .style({ bold: true, fontSize: 18, horizontalAlignment: "center", fontColor: "1b4332" });
        const reportDate = new Date().toLocaleString('th-TH');
        sheet.cell("A2").value("วันที่ออกรายงาน:").style({ bold: true });
        sheet.cell("B2").value(reportDate);
        sheet.cell("A3").value("สถานี (Station):").style({ bold: true });
        sheet.cell("B3").value(currentStation);

        // 6. Add table headers.
        const headers = ['Tray ID', 'Batch ID', 'ชนิดผัก', 'ตำแหน่ง', 'จำนวนต้น', 'วันที่เพาะ', 'อายุ (วัน)', 'สถานะ', 'หมายเหตุ'];
        headers.forEach((header, index) => {
            sheet.cell(5, index + 1).value(header)
                .style({ bold: true, fill: "2d6a4f", fontColor: "ffffff", horizontalAlignment: "center" });
        });

        // 7. Populate data into the sheet.
        filteredTrays.forEach((tray, rowIndex) => {
            const r = rowIndex + 6;
            sheet.cell(r, 1).value(tray.tray_id);
            sheet.cell(r, 2).value(tray.batch_id || '-');
            sheet.cell(r, 3).value(tray.veg_type);
            sheet.cell(r, 4).value(`ชั้น ${tray.floor} / ช่อง ${tray.slot}`);
            sheet.cell(r, 5).value(tray.plant_quantity || '-').style({ horizontalAlignment: "center" });
            sheet.cell(r, 6).value(tray.seeding_date ? new Date(tray.seeding_date).toLocaleDateString('th-TH') : '-');
            sheet.cell(r, 7).value(calculateTrayAgeInDays(tray.time_in)).style({ horizontalAlignment: "center" });
            sheet.cell(r, 8).value(tray.status === 'on_shelf' ? 'ในคลัง' : 'ที่ Workstation');
            sheet.cell(r, 9).value(tray.notes || '-');
        });
        
        // 8. Style and finalize the worksheet.
        sheet.column("A").width(15); sheet.column("B").width(20); sheet.column("C").width(22);
        sheet.column("D").width(18); sheet.column("E").width(12); sheet.column("F").width(15);
        sheet.column("G").width(12); sheet.column("H").width(18); sheet.column("I").width(35);
        sheet.range("A5:I5").autoFilter();
        sheet.freezePanes(6, 1); // Freeze rows above the data.

        // 9. Generate and trigger the download.
        const blob = await workbook.outputAsync();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `TrayMaster_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast(`✅ สร้างรายงาน Excel สำเร็จ! (${filteredTrays.length} รายการ)`, true);

    } catch (error) {
        console.error("Export to Excel failed:", error);
        showToast('❌ เกิดข้อผิดพลาดในการสร้างไฟล์ Excel', false);
    }
}


// [แก้ไข] ฟังก์ชันสร้างป้ายสถานะให้สวยงาม
function renderTrayStatusLabel(status) {
    if (status === 'on_shelf' || status === 'IN_STORAGE') {
        return `<span class="status-badge on-shelf"><i class="fas fa-warehouse"></i> ในคลัง</span>`;
    }
    if (status === 'AT_WORKSTATION') {
        return `<span class="status-badge at-workstation"><i class="fas fa-wrench"></i> ที่ Workstation</span>`;
    }
    return status || 'ไม่ระบุ';
}
// Function ที่จะถูกเรียกเมื่อกดปุ่มแก้ไข (ตัวอย่างเบื้องต้น)
function editTray(trayId) {
    alert(`คุณกำลังจะแก้ไขถาด ID: ${trayId}`);
    // ในขั้นต่อไป คุณสามารถสร้าง Modal popup เพื่อให้ผู้ใช้กรอกข้อมูลใหม่
    // แล้วส่ง request ไปที่ API ที่เราสร้างไว้ด้านบน
}


let workstationTimer = null; // ตัวแปรสำหรับเก็บ interval
let currentWorkstationState = null; // ✅ [เพิ่มใหม่] ใช้สำหรับจำสถานะ Workstation
// ✅✅✅ [แก้ไขใหม่] ฟังก์ชันตรวจสอบสถานะ Workstation แบบอัจฉริยะ ✅✅✅
async function checkWorkstationStatus() {
    try {
        const res = await fetch(`/api/workstation/current?station=${currentStation}`);
        const waitingTray = await res.json();
        const displayDiv = document.getElementById('workstationDisplay');

        if (!displayDiv) return;

        // 1. ตรวจสอบสถานะปัจจุบันของถาด (มี ID หรือเป็น null)
        const newState = waitingTray ? waitingTray.tray_id : null;

        // 2. เปรียบเทียบสถานะใหม่กับสถานะเดิมที่จำไว้
        if (newState === currentWorkstationState) {
            // 3. ถ้าสถานะเหมือนเดิม -> ไม่ต้องทำอะไรเลย ออกจากฟังก์ชันทันที
            return; 
        }

        // 4. ถ้าสถานะเปลี่ยน -> อัปเดตหน้าจอ และจำสถานะใหม่ไว้
        currentWorkstationState = newState;

        // --- ส่วนของการวาดหน้าจอ (จะทำงานเฉพาะตอนที่สถานะเปลี่ยนเท่านั้น) ---
        if (waitingTray) {
            const reason = waitingTray.reason || 'ทั่วไป';
            let actionHTML = '';

            switch (reason.toLowerCase()) {
                case 'กำจัดทิ้ง':
                    actionHTML = `<button class="form-button-action danger" onclick="disposeTray('${waitingTray.tray_id}')"><i class="fas fa-trash-alt"></i> ยืนยันการกำจัดทิ้ง</button>`;
                    break;
                case 'ย้ายตำแหน่งถาด':
                    actionHTML = `<button class="form-button-action" style="background: linear-gradient(135deg, #60A5FA, #3B82F6);" onclick="returnTrayToStorage('relocate')"><i class="fas fa-random"></i> ย้ายไปยังตำแหน่งใหม่</button>`;
                    break;
                default:
                    actionHTML = `
                        <div class="popup-actions">
                            <button class="popup-button cancel" onclick="disposeTray('${waitingTray.tray_id}')"><i class="fas fa-check-circle"></i> เสร็จสิ้น (นำออก)</button>
                            <button class="popup-button confirm" onclick="returnTrayToStorage('return')"><i class="fas fa-arrow-left"></i> ส่งกลับเข้าคลัง</button>
                        </div>`;
                    break;
            }

            displayDiv.innerHTML = `
                <div class="popup-container" style="max-width: 700px; margin: 20px auto; animation: popIn 0.4s ease-out;">
                    <div class="popup-header">
                        <i class="fas fa-box-open icon" style="color: #FBBF24;"></i>
                        <h2 class="popup-title">มีถาดรอการจัดการ</h2>
                        <p class="popup-subtitle">กรุณาเลือกคำสั่งสำหรับถาดด้านล่างนี้</p>
                    </div>
                    <div class="popup-summary">
                        <div class="summary-item"><span class="summary-label">Tray ID</span><span class="summary-value">${waitingTray.tray_id}</span></div>
                        <div class="summary-item"><span class="summary-label">ชนิดผัก</span><span class="summary-value highlight">${waitingTray.veg_type || 'N/A'}</span></div>
                        <div class="summary-item"><span class="summary-label">เหตุผลนำออก</span><span class="summary-value" style="font-weight: 700;">${reason}</span></div>
                    </div>
                    <div class="popup-actions" style="grid-template-columns: 1fr; margin-top: 25px;">${actionHTML}</div>
                </div>
            `;
        } else {
            displayDiv.innerHTML = `
                <div class="agv-status-box" style="--boxColor: #6c757d; margin-top: 20px;">
                    <div class="agv-status-title"><i class="fas fa-pause-circle"></i> ไม่มีถาดรอการจัดการ</div>
                    <div class="agv-status-desc">เมื่อมีถาดถูกนำออกมาที่ Home สถานะจะแสดงที่นี่</div>
                </div>
            `;
        }

    } catch(err) {
        console.error("❌ ไม่สามารถเช็คสถานะ Workstation ได้", err);
        // เมื่อเกิด error ก็ควรจะหยุดการทำงานเช่นกัน
        currentWorkstationState = 'error'; // ตั้งสถานะเป็น error เพื่อไม่ให้วนซ้ำถ้า error ตลอด
    }
}





// ✅✅✅ [แก้ไข] ให้ฟังก์ชันรับ tray_id เป็น parameter โดยตรง ✅✅✅
async function disposeTray(tray_id) {
    if (!tray_id) {
        showToast('❌ ไม่พบ Tray ID', false);
        return;
    }

    showConfirmationPopup({
        title: 'ยืนยันการกำจัดถาด',
        subtitle: `คุณต้องการนำถาด ID: ${tray_id} ออกจากระบบใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้`,
        icon: 'fa-trash-alt', // ไอคอนถังขยะ
        details: [
            { label: 'Tray ID ที่จะลบ', value: tray_id, highlight: true },
            { label: 'สถานะ', value: 'จะถูกนำออกจากระบบถาวร' }
        ],
        onConfirm: async () => {
            try {
                await fetch('/api/workstation/dispose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tray_id: tray_id, station_id: currentStation })
                });
                showToast(`✅ นำถาด ID: ${tray_id} ออกแล้ว`, true);
                checkWorkstationStatus(); // รีเฟรชสถานะทันที
            } catch(err) {
                showToast('❌ เกิดข้อผิดพลาดในการนำถาดออก', false);
            }
        }
    });
}

// ✅ [แก้ไข] ฟังก์ชัน editTray เดิมให้ทำงานได้จริง
async function editTray(trayId) {
    // หาข้อมูลถาดจาก trayInventory ที่เรามีอยู่แล้ว
    const tray = Object.values(trayInventory).find(t => t.tray_id === trayId);
    if (!tray) {
        showToast("❌ ไม่พบข้อมูลถาด", false);
        return;
    }

    // นำข้อมูลไปใส่ในฟอร์มของ Modal
    document.getElementById("editTrayId").value = tray.tray_id;
    document.getElementById("editVegType").value = tray.veg_type || '';
    document.getElementById("editPlantQuantity").value = tray.plant_quantity || '';
    document.getElementById("editBatchId").value = tray.batch_id || '';
    // จัดรูปแบบวันที่ให้ input type="date" รับได้ (YYYY-MM-DD)
    document.getElementById("editSeedingDate").value = tray.seeding_date ? new Date(tray.seeding_date).toISOString().split('T')[0] : '';
    document.getElementById("editNotes").value = tray.notes || '';

    // แสดง Modal
    document.getElementById("editTrayModal").style.display = 'flex';
}

// ✅ [เพิ่มใหม่] ฟังก์ชันปิด Modal
function closeEditModal() {
    document.getElementById("editTrayModal").style.display = 'none';
}

// ✅ [เพิ่มใหม่] ฟังก์ชันส่งข้อมูลที่แก้ไขแล้วไป Backend
async function handleUpdateTray() {
    const trayId = document.getElementById("editTrayId").value;
    const updatedData = {
        veg_type: document.getElementById("editVegType").value,
        plant_quantity: document.getElementById("editPlantQuantity").value,
        batch_id: document.getElementById("editBatchId").value,
        seeding_date: document.getElementById("editSeedingDate").value,
        notes: document.getElementById("editNotes").value
    };

    try {
        const res = await fetch(`/api/tray-inventory/${trayId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData)
        });
        const result = await res.json();

        if (result.error) {
            showToast(`❌ ${result.error}`, false);
        } else {
            showToast(`✅ อัปเดตข้อมูลสำเร็จ`, true);
            closeEditModal();
            loadTrayMasterData(); // โหลดข้อมูลใหม่เพื่ออัปเดตตาราง
            loadTrayInventory();  // อัปเดตข้อมูลใน Grid View ด้วย
        }
    } catch(err) {
        showToast("❌ เกิดข้อผิดพลาดในการอัปเดต", false);
    }
}




let returnTrayData = null; // ตัวแปรเก็บข้อมูลถาดที่จะส่งคืน
async function returnTrayToStorage(mode = 'return') {
    const res = await fetch(`/api/workstation/current?station=${currentStation}`);
    const waitingTray = await res.json();
    
    if (!waitingTray) {
        showToast("❌ ไม่พบข้อมูลถาดที่ Workstation", false);
        return;
    }

    const modal = document.getElementById('returnTrayModal');
    const titleElement = modal.querySelector('.popup-title');
    const confirmButton = modal.querySelector('.popup-button.confirm');

    const qtyInput = document.getElementById("returnPlantQuantity");
    const dateInput = document.getElementById("returnSeedingDate");
    const notesInput = document.getElementById("returnNotes");

    // กำหนด Title และปุ่มตามโหมด
    if (mode === 'relocate') {
        titleElement.innerHTML = `<i class="fas fa-random icon" style="color:#60A5FA;"></i> ย้ายตำแหน่งถาด`;
        confirmButton.innerHTML = `<i class="fas fa-check-circle"></i> ยืนยันและย้ายตำแหน่ง`;
        // ปิดการแก้ไขข้อมูล
        [qtyInput, dateInput, notesInput].forEach(el => {
            el.disabled = true;
            el.style.backgroundColor = '#e9ecef';
            el.style.cursor = 'not-allowed';
        });
    } else { 
        titleElement.innerHTML = `<i class="fas fa-arrow-left icon"></i> ส่งกลับเข้าคลัง`;
        confirmButton.innerHTML = `<i class="fas fa-check-circle"></i> ยืนยันและส่งกลับ`;
        // เปิดให้แก้ไข
        [qtyInput, dateInput, notesInput].forEach(el => {
            el.disabled = false;
            el.style.backgroundColor = '';
            el.style.cursor = '';
        });
    }

    // ใส่ข้อมูลเดิมลงในฟอร์ม
    document.getElementById("returnVegType").value = waitingTray.veg_type || '';
    qtyInput.value = waitingTray.plant_quantity || '';
    document.getElementById("returnBatchId").value = waitingTray.batch_id || '';
    dateInput.value = waitingTray.seeding_date ? new Date(waitingTray.seeding_date).toISOString().split('T')[0] : '';
    notesInput.value = waitingTray.notes || '';
    
    // ตั้งค่า onclick ของปุ่มยืนยัน
    confirmButton.setAttribute('onclick', `handleReturnToStorage('${waitingTray.tray_id}', ${waitingTray.station_id})`);
    
    modal.style.display = 'flex';
}

async function handleReturnToStorage(tray_id, station_id) {
    if (!tray_id) {
        showToast('❌ ไม่พบ Tray ID ที่จะส่งกลับ', false);
        return;
    }

    // 1. รวบรวมข้อมูลจากฟอร์มสำหรับส่งกลับทั้งหมดก่อน
    const newFloor = document.getElementById('returnFloor').value;
    const newSlot = document.getElementById('returnSlot').value;
    const dataToSend = {
        tray_id: tray_id,
        veg_type: document.getElementById("returnVegType").value,
        quantity: document.getElementById("returnPlantQuantity").value,
        batch_id: document.getElementById("returnBatchId").value,
        seeding_date: document.getElementById("returnSeedingDate").value,
        notes: document.getElementById("returnNotes").value,
        floor: newFloor,
        slot: newSlot,
        username: localStorage.getItem("username"),
        station: currentStation,
    };
    
    try {
        // 2. ✅ [สำคัญ] เคลียร์งานที่ Workstation ก่อน เพื่อให้ Flow State กลับเป็น 'idle'
        const completeRes = await fetch('/api/workstation/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                tray_id: tray_id, 
                station_id: station_id || currentStation 
            })
        });

        if (!completeRes.ok) {
            const errData = await completeRes.json();
            throw new Error(errData.error || 'ไม่สามารถเคลียร์งานที่ Workstation ได้');
        }
        
        // เพิ่ม Delay เล็กน้อยเพื่อให้ Server มีเวลาอัปเดต State
        await new Promise(resolve => setTimeout(resolve, 200));

        // 3. ✅ [สำคัญ] หลังจากระบบ idle แล้ว จึงเริ่ม Flow การนำถาดกลับ (Inbound)
        const inboundRes = await fetch("/api/tray/inbound", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dataToSend)
        });
        const result = await inboundRes.json();
        
        if (result.error) {
           showToast(`❌ ${result.error}`, false);
        } else {
           showToast(`✅ รับคำสั่งส่งถาดกลับคลังแล้ว...`, true);
           closeReturnModal();
           refreshDataAndViews();
           checkWorkstationStatus(); // รีเฟรชสถานะ Workstation
           loadTrayInventory();    // รีเฟรชข้อมูลคลัง
        }
    } catch (err) {
        console.error("❌ Error during return to storage:", err);
        showToast(`❌ ไม่สามารถส่งถาดกลับได้: ${err.message}`, false);
    }
}

function closeReturnModal() {
    document.getElementById('returnTrayModal').style.display = 'none';
}



async function refreshDataAndViews() {
  console.log("🔄 Refreshing data and relevant views...");
  
  // 1. โหลดข้อมูลหลัก 2 อย่างนี้ใหม่เสมอ
  await Promise.all([
    loadTrayInventory(),
    loadTrayMasterData() // โหลดข้อมูลสำหรับหน้า Tray Master ด้วย
  ]);

  // 2. ตรวจสอบหน้าปัจจุบัน แล้ววาดซ้ำเฉพาะหน้าที่จำเป็น
  if (currentPage === 'tray-map') {
    renderTrayGrid();
  } else if (currentPage === 'tray-master') {
    // ไม่ต้องทำอะไร เพราะ loadTrayMasterData() วาดตารางใหม่ให้แล้ว
  } else if (currentPage === 'workstation') {
    checkWorkstationStatus();
  } else if (currentPage === 'tray-outbound') {
    // อัปเดตสถานะของช่องที่อาจจะว่างลงแล้ว
    checkOutboundSlot(); 
  }
  
  console.log("✅ Refresh complete.");
}




// ✅ [เพิ่มใหม่] ตัวแปรสำหรับเก็บข้อมูลถาดที่จะนำออก
let selectedOutboundTray = null;
// ✅ [เพิ่มใหม่] ฟังก์ชันสำหรับตรวจสอบสถานะช่องที่เลือกในหน้า Inbound
function validateInboundSlot() {
    const floor = document.getElementById("inFloor").value;
    const slot = document.getElementById("inSlot").value;
    const statusDiv = document.getElementById("inboundSlotStatus");
    const confirmBtn = document.getElementById("inboundConfirmBtn");

    if (!floor || !slot) {
        statusDiv.innerHTML = "";
        confirmBtn.disabled = true; // ปิดปุ่มถ้ายังเลือกไม่ครบ
        return;
    }

    const key = `${floor}-${slot}`;
    if (trayInventory[key] && trayInventory[key].status === 'on_shelf') {
        // --- กรณีช่องไม่ว่าง ---
        statusDiv.innerHTML = `
            <div style="padding: 14px; background: #fffbeb; color: #b45309; border-left: 5px solid #facc15; border-radius: 8px; font-weight: 600;">
                ⚠️ ช่องนี้มีถาดวางอยู่แล้ว กรุณาเลือกตำแหน่งใหม่
            </div>`;
        confirmBtn.disabled = true;
    } else {
        // --- กรณีช่องว่าง ---
        statusDiv.innerHTML = `
            <div style="padding: 14px; background: #f0fdf4; color: #166534; border-left: 5px solid #4ade80; border-radius: 8px; font-weight: 600;">
                ✅ ช่องนี้ว่าง สามารถวางถาดได้
            </div>`;
        confirmBtn.disabled = false;
    }
}
// ✅ [เพิ่มใหม่] ฟังก์ชันสำหรับตรวจสอบและแสดงผลถาดที่อยู่หน้าสุดของชั้น
function validateOutboundFloor() {
    const selectedFloor = document.getElementById("outFloor").value;
    const validationBox = document.getElementById("outboundValidationBox");
    const confirmBtn = document.getElementById("outboundConfirmBtn");
    const reasonSelect = document.getElementById("outReason");
    const destinationInput = document.getElementById("outDestination");

    // รีเซ็ตสถานะทุกครั้งที่เปลี่ยนชั้น
    selectedOutboundTray = null;
    validationBox.style.display = 'none';
    validationBox.innerHTML = '';
    confirmBtn.disabled = true;
    reasonSelect.disabled = true;
    destinationInput.disabled = true;

    if (!selectedFloor) return; // ถ้าไม่ได้เลือกชั้น ก็ไม่ต้องทำอะไรต่อ

    // ค้นหาถาดทั้งหมดในชั้นที่เลือก และมีสถานะ 'on_shelf'
    const traysOnFloor = Object.values(trayInventory).filter(
        tray => tray.floor == selectedFloor && tray.status === 'on_shelf'
    );

    validationBox.style.display = 'block';

    if (traysOnFloor.length === 0) {
        // ---- กรณีไม่เจอถาดในชั้นนั้น ----
        validationBox.innerHTML = `
            <div class="warning-message" style="background: #fffbeb; color: #b45309; border-left-color: #fde68a;">
                <i class="fas fa-info-circle"></i> ไม่พบถาดที่พร้อมใช้งานในชั้น ${selectedFloor}
            </div>
        `;
        return;
    }

    // ---- กรณีเจอถาด -> หาช่องที่เลขน้อยที่สุด (หน้าสุด) ----
    const frontTray = traysOnFloor.reduce((prev, curr) => (prev.slot < curr.slot ? prev : curr));
    selectedOutboundTray = frontTray; // เก็บข้อมูลถาดที่เลือกไว้

    const formattedDate = new Date(frontTray.time_in).toLocaleDateString('th-TH');
    validationBox.innerHTML = `
        <div style="background-color: #f0fdf4; padding: 15px; border-radius: 12px; border: 1px solid #bbf7d0; color: #166534; font-weight: 600;">
            <i class="fas fa-check-circle"></i> พบถาดหน้าสุด: <strong>${frontTray.veg_type}</strong> (ช่อง ${frontTray.slot})<br>
            <small>วางเมื่อ: ${formattedDate}</small>
        </div>
    `;

    // เปิดให้กรอกข้อมูลและกดยืนยันได้
    confirmBtn.disabled = false;
    reasonSelect.disabled = false;
    destinationInput.disabled = false;
}





// =======================================================================
// ✨ [FINAL & CORRECTED] LIGHT CONTROL JAVASCRIPT ✨
// =======================================================================

/**
 * 💡 [REBUILT] วาดหน้า Light Control ใหม่ทั้งหมด
 * สร้าง UI และผูก Event ทั้งหมดสำหรับการควบคุมไฟ
 */
function renderLightControlPage() {
    let html = `
        <div class="light-control-container light-control-page-theme">
            <div class="light-control-header-new">
    <div class="header-content-new">
        <div class="header-icon-new">
            <i class="fas fa-lightbulb"></i>
            <div class="icon-glow-new"></div>
        </div>
        <div class="header-text-new">
            <h1>ระบบควบคุมแสงสว่าง</h1>
            <p>Light & Fan Control System</p>
        </div>
    </div>
    <div class="status-badge-new">
        <div class="status-dot-new"></div>
        <span>Real-time</span>
    </div>
</div>
            <div class="global-control-card">
                 <div class="card-title"><i class="fas fa-globe-asia"></i>ควบคุมทั้งหมด</div>
                <div class="global-actions">
                    <button class="global-power-btn on" onclick="openBatchScheduleModal()"><i class="fas fa-calendar-alt"></i><span>ตั้งเวลาทั้งหมด</span></button>
                    <button class="global-power-btn off" onclick="turnEverythingOff()"><i class="fas fa-power-off"></i><span>ปิดทั้งหมด</span></button>
                    <button class="global-power-btn" style="background: #64748b; color: white;" onclick="clearAllSchedules()"><i class="fas fa-trash-alt"></i><span>ล้างตั้งเวลา</span></button>
                </div>
            </div>
            <div class="floor-grid">
    `;

    for (let i = 1; i <= 5; i++) {
        html += `
            <div class="floor-card" id="floor-card-${i}">
                <div class="floor-title">
                    <h3><i class="fas fa-layer-group"></i>ชั้นที่ ${i}</h3>
                    <div class="floor-title-actions">
                        <label class="toggle-switch">
                            <input type="checkbox" id="floor-power-${i}" onchange="handleMasterToggleChange(${i}, this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="floor-controls">
                    ${createControlRow('light-white', i, 'fa-sun', '#f59e0b')}
                    ${createControlRow('light-red', i, 'fa-atom', 'var(--lc-accent-red)')}
                    ${createControlRow('fan', i, 'fa-fan', 'var(--lc-accent-blue)')}
                </div>
                <div style="padding-top: 15px; margin-top: 15px; border-top: 1px solid rgba(13, 148, 136, 0.1);">
                    <button class="global-power-btn on" id="floor-confirm-btn-${i}" onclick="confirmFloorChanges(${i})" disabled>
                        <i class="fas fa-check-circle"></i>
                        <span>ยืนยันการตั้งค่าชั้น ${i}</span>
                    </button>
                </div>
            </div>
        `;
    }

    html += `</div></div>`;
    document.getElementById("mainContent").innerHTML = html;
    startLightControlPolling();
}

/**
 * 💡 Helper สร้างแถวควบคุม, onchange จะเรียก markFloorAsChanged
 */
function createControlRow(type, floor, icon, color) {
    return `
        <div class="control-row">
            <i class="fas ${icon} control-icon" style="color: ${color};"></i>
            <div class="slider-container">
                <input type="range" min="0" max="100" value="0" class="premium-slider device-slider"
                       onchange="markFloorAsChanged(${floor})"
                       oninput="updateSliderVisual(this, '${type}', ${floor})"
                       data-floor="${floor}" data-type="${type}" style="--fill-color: ${color};">
            </div>
            <span class="control-value" id="${type}-value-${floor}">0%</span>
            <button class="control-timer-btn" onclick="openIndividualTimerModal('${type}', ${floor})">
                <i class="fas fa-clock"></i>
            </button>
        </div>
    `;
}

/**
 * 💡 อัปเดตการแสดงผลของ Slider ขณะที่ผู้ใช้กำลังลาก (Visual Only)
 */
function updateSliderVisual(slider, type, floor) {
    const valueDisplay = document.getElementById(`${type}-value-${floor}`);
    if (valueDisplay) {
        const percentage = slider.value + '%';
        valueDisplay.textContent = percentage;
        slider.style.setProperty('--value', percentage);
    }
}

/**
 * 💡 จัดการเมื่อ Master Toggle ถูกกด
 */
function handleMasterToggleChange(floorIndex, isChecked) {
    const intensity = isChecked ? 75 : 0;
    ['light-white', 'light-red', 'fan'].forEach(type => {
        const slider = document.querySelector(`input[data-floor="${floorIndex}"][data-type="${type}"]`);
        if (slider) {
            slider.value = intensity;
            updateSliderVisual(slider, type, floorIndex);
        }
    });
    markFloorAsChanged(floorIndex);
}

/**
 * 💡 ฟังก์ชันติดตามการเปลี่ยนแปลงและเปิด/ปิดปุ่มยืนยัน
 */
function markFloorAsChanged(floorIndex) {
    const confirmBtn = document.getElementById(`floor-confirm-btn-${floorIndex}`);
    if (confirmBtn) {
        // ✨ จุดแก้ไข: เปลี่ยน disabled เป็น false เพื่อ "เปิดใช้งาน" ปุ่ม
        confirmBtn.disabled = false;
        confirmBtn.style.background = '#f97316'; // เปลี่ยนเป็นสีส้มเพื่อบอกว่ามี pending changes
        confirmBtn.querySelector('span').textContent = `ยืนยันการเปลี่ยนแปลง`;
    }
}

/**
 * 💡 ฟังก์ชันหลักเมื่อกดปุ่ม "ยืนยันการตั้งค่า" ของชั้น
 */
function confirmFloorChanges(floorIndex) {
    const whiteValue = document.querySelector(`input[data-floor="${floorIndex}"][data-type="light-white"]`).value;
    const redValue = document.querySelector(`input[data-floor="${floorIndex}"][data-type="light-red"]`).value;
    const fanValue = document.querySelector(`input[data-floor="${floorIndex}"][data-type="fan"]`).value;

    showConfirmationPopup({
        title: `ยืนยันการตั้งค่าชั้น ${floorIndex}`,
        subtitle: 'โปรดตรวจสอบความถูกต้องของค่าทั้งหมด',
        icon: 'fa-cogs',
        details: [
            { label: '💡 ไฟขาว (White LED)', value: `${whiteValue}%`, highlight: true },
            { label: '💡 ไฟแดง (Red LED)', value: `${redValue}%`, highlight: true },
            { label: '💨 พัดลม (Fan)', value: `${fanValue}%`, highlight: true },
        ],
        onConfirm: () => executeFloorChanges(floorIndex, { whiteValue, redValue, fanValue })
    });
}

/**
 * 💡 ฟังก์ชันที่ทำงานหลังกดยืนยันใน Pop-up เพื่อส่งคำสั่ง
 */
async function executeFloorChanges(floorIndex, values) {
    showToast(`กำลังบันทึกการตั้งค่าชั้น ${floorIndex}...`, true);
    clearActiveTimers();

    // --- ✨ [จุดที่แก้ไข] เพิ่มการเรียกใช้ฟังก์ชันนี้เพื่อส่งคำสั่งผ่านคิว ✨ ---
    const commands = [
        sendLightCommand(floorIndex, 'light-white', values.whiteValue),
        sendLightCommand(floorIndex, 'light-red', values.redValue),
        sendLightCommand(floorIndex, 'fan', values.fanValue)
    ];

    try {
        // Promise.all จะยิง API ทั้ง 3 พร้อมกัน แต่ Backend จะรับไปเข้าคิวเอง
        await Promise.all(commands);
        showToast(`✅ บันทึกการตั้งค่าชั้น ${floorIndex} เรียบร้อย!`, true);

        // รีเซ็ตสถานะปุ่ม
        const confirmBtn = document.getElementById(`floor-confirm-btn-${floorIndex}`);
        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.style.background = '';
            confirmBtn.querySelector('span').textContent = `ยืนยันการตั้งค่าชั้น ${floorIndex}`;
        }
    } catch (error) {
        console.error("❌ Error sending commands:", error);
        showToast(`❌ เกิดข้อผิดพลาดในการส่งคำสั่งชั้น ${floorIndex}`, false);
    }

    // เริ่ม Polling ใหม่หลังจากทำงานเสร็จ
    await new Promise(resolve => setTimeout(resolve, 500));
    startLightControlPolling();
}
/**
 * 💡 ฟังก์ชันสำหรับส่งคำสั่งไฟไปที่ Backend (ต้องมีฟังก์ชันนี้)
 */
async function sendLightCommand(floor, type, value) {
    const commandPayload = {
        floor: parseInt(floor),
        type: type,
        distance: parseInt(value)
    };
    try {
        await fetch('/api/lights/control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(commandPayload)
        });
    } catch (error) {
        console.error('❌ Send command error:', error);
        showToast('❌ ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้', false);
    }
}

/**
 * 💡 เริ่มการดึงข้อมูลสถานะจาก Backend มาอัปเดต UI อัตโนมัติ
 */
function startLightControlPolling() {
    updateLightControlUIStateFromBackend();
    const lightTimer = setInterval(updateLightControlUIStateFromBackend, 3000);
    activeTimers.push(lightTimer);
}

/**
 * 💡 [CORRECTED] ฟังก์ชันดึงสถานะจาก Backend และซิงค์กับ UI ที่ถูกต้อง
 */
// ✅ [CORRECTED] ฟังก์ชันดึงสถานะจาก Backend และซิงค์กับ UI ที่ถูกต้อง
async function updateLightControlUIStateFromBackend() {
    try {
        const [statusRes, scheduleRes] = await Promise.all([
            fetch('/api/lights/status'),
            fetch('/api/lights/schedule')
        ]);

        if (!statusRes.ok || !scheduleRes.ok) {
            console.warn('ไม่สามารถดึงข้อมูลสถานะไฟได้จากเซิร์ฟเวอร์');
            return;
        }

        const currentStates = await statusRes.json();
        const schedules = await scheduleRes.json();

        for (let floor = 1; floor <= 5; floor++) {
            const confirmBtn = document.getElementById(`floor-confirm-btn-${floor}`);

            // --- ✨ จุดแก้ไข ✨ ---
            // ถ้าปุ่ม "ยืนยัน" ของชั้นนี้ถูกเปิดใช้งานอยู่ (ผู้ใช้ปรับค่าแต่ยังไม่กด)
            // ให้ข้ามการอัปเดต UI ของชั้นนี้ไปเลย เพื่อไม่ให้ค่าดีดกลับ
            if (confirmBtn && !confirmBtn.disabled) {
                continue; // ข้ามไปทำชั้นถัดไป
            }

            let isAnyDeviceOnInFloor = false;
            ['light-white', 'light-red', 'fan'].forEach(type => {
                const key = `${floor}-${type}`;
                const state = currentStates[key] || { intensity: 0, isManuallyOverridden: false };
                const schedule = schedules[key] || { enabled: false };

                if (state.intensity > 0) isAnyDeviceOnInFloor = true;

                const slider = document.querySelector(`input[data-floor="${floor}"][data-type="${type}"]`);
                const timerBtn = document.querySelector(`#floor-card-${floor} button[onclick*="'${type}', ${floor}"]`);

                if (slider) {
                    slider.value = state.intensity;
                    updateSliderVisual(slider, type, floor);
                    slider.disabled = schedule.enabled && !state.isManuallyOverridden;
                }
                if (timerBtn) {
                    // เพิ่ม class 'scheduled' ถ้ามีการตั้งเวลา
                    timerBtn.classList.toggle('scheduled', schedule.enabled);
                }
            });

            const masterToggle = document.getElementById(`floor-power-${floor}`);
            if (masterToggle) masterToggle.checked = isAnyDeviceOnInFloor;
        }
    } catch (err) {
        console.error("Error polling light status:", err);
    }
}


// --- ฟังก์ชันสำหรับ Modal และ Global Actions (สมบูรณ์แล้ว ไม่ต้องแก้ไข) ---

let activeTimerModalContext = { floor: null, type: null };
async function openBatchScheduleModal() {
    const modal = document.getElementById('batchScheduleModal');
    const formContainer = document.getElementById('batchScheduleForm');
    formContainer.innerHTML = '<div><i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...</div>';
    modal.classList.add('show');
    
    const modalContent = modal.querySelector('.timer-modal-content');
    if (modalContent) {
        modalContent.style.maxHeight = '85vh';
        modalContent.style.overflowY = 'auto';
        modalContent.style.paddingRight = '15px';
    }

    try {
        const res = await fetch('/api/lights/schedule');
        const schedules = await res.json(); 

        let formHtml = `
            <div style="grid-column: 1 / -1; background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.1em; color: #166534; cursor: pointer;">
                    <input type="checkbox" id="master-schedule-toggle" onchange="toggleAllSchedules(this.checked)" style="width: 22px; height: 22px;">
                    เปิด/ปิด ตารางเวลาทั้งหมด
                </label>
            </div>
        `;

        // ✅✅✅ สีของตัวอักษรหัวข้อ ถูกกำหนดที่นี่ ✅✅✅
        const deviceTypes = [
            { id: 'light-white', name: '💡 ไฟขาว (White LED)', color: '#f59e0b' },      // <-- นี่คือ "สีเหลือง" สำหรับไฟขาว
            { id: 'light-red',   name: '💡 ไฟแดง (Red LED)',   color: '#ef4444' },      // <-- นี่คือ "สีแดง" สำหรับไฟแดง
            { id: 'fan',         name: '💨 พัดลม (Fan)',       color: '#3b82f6' }       // <-- นี่คือ "สีฟ้า" สำหรับพัดลม
        ];

        for (let floor = 1; floor <= 5; floor++) {
            formHtml += `
                <div style="background: #f8fafc; border-radius: 16px; padding: 20px; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                    <h3 style="margin: 0 0 20px 0; color: #1b4332; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-layer-group" style="color: #52b788;"></i> ชั้นที่ ${floor}
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 20px;">
            `;

            deviceTypes.forEach(device => {
                const key = `${floor}-${device.id}`;
                const schedule = schedules[key] || { enabled: false, on: '08:00', off: '18:00', intensity: 75 };

                // บรรทัด h4 ด้านล่างนี้ จะดึงค่าสีจาก deviceTypes มาใช้โดยอัตโนมัติ
                formHtml += `
                    <div style="background: #ffffff; border-radius: 10px; padding: 15px; border: 1px solid #eef2f7;">
                        <h4 style="margin: 0 0 15px 0; color: ${device.color};">${device.name}</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                <input type="checkbox" class="schedule-toggle" id="batch-enabled-${floor}-${device.id}" ${schedule.enabled ? 'checked' : ''}>
                                เปิดใช้งานตารางเวลา
                            </label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label for="batch-on-${floor}-${device.id}" style="font-size: 0.8rem;">เวลาเปิด</label>
                                    <input type="time" id="batch-on-${floor}-${device.id}" class="timer-input" value="${schedule.on}">
                                </div>
                                <div>
                                    <label for="batch-off-${floor}-${device.id}" style="font-size: 0.8rem;">เวลาปิด</label>
                                    <input type="time" id="batch-off-${floor}-${device.id}" class="timer-input" value="${schedule.off}">
                                </div>
                            </div>
                            <div>
                                <label for="batch-intensity-input-${floor}-${device.id}" style="font-size: 0.8rem;">ความสว่าง/แรงลม</label>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <input type="range" id="batch-intensity-slider-${floor}-${device.id}" min="0" max="100" value="${schedule.intensity}" class="premium-slider" style="flex-grow: 1; --fill-color: ${device.color};"
                                           oninput="syncInputs('slider', '${floor}', '${device.id}')">
                                    <input type="number" id="batch-intensity-input-${floor}-${device.id}" min="0" max="100" value="${schedule.intensity}" style="width: 70px; text-align: center;" class="timer-input"
                                           oninput="syncInputs('input', '${floor}', '${device.id}')">
                                    <span style="font-weight: 600;">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            formHtml += `</div></div>`;
        }
        formContainer.innerHTML = formHtml;
    } catch (err) {
        formContainer.innerHTML = '<div style="color: red;">ไม่สามารถโหลดข้อมูลตารางเวลาได้</div>';
    }
}

function toggleAllSchedules(isChecked) {
    const allToggles = document.querySelectorAll('.schedule-toggle');
    allToggles.forEach(toggle => {
        toggle.checked = isChecked;
    });
}

/**
 * 💡 [NEW HELPER] ฟังก์ชันสำหรับซิงค์ค่าระหว่าง Slider และ Input ตัวเลข
 */
function syncInputs(source, floor, type) {
    const slider = document.getElementById(`batch-intensity-slider-${floor}-${type}`);
    const input = document.getElementById(`batch-intensity-input-${floor}-${type}`);
    
    if (source === 'slider') {
        input.value = slider.value;
    } else {
        // จำกัดค่าไม่ให้เกิน 100
        if (parseInt(input.value) > 100) {
            input.value = 100;
        }
        slider.value = input.value;
    }
    // อัปเดตสีของ slider visual
    slider.style.setProperty('--value', slider.value + '%');
}
// ✅ [CORRECTED] รวบรวมข้อมูลทั้งหมดแล้วส่งในครั้งเดียว
async function saveBatchSchedules() {
    showToast('กำลังบันทึกตารางเวลาทั้งหมด...', true);
    const deviceTypes = ['light-white', 'light-red', 'fan'];
    const allSchedules = [];

    for (let floor = 1; floor <= 5; floor++) {
        deviceTypes.forEach(type => {
            const enabled = document.getElementById(`batch-enabled-${floor}-${type}`).checked;
            const onTime = document.getElementById(`batch-on-${floor}-${type}`).value;
            const offTime = document.getElementById(`batch-off-${floor}-${type}`).value;
            
            // --- ✨ THIS IS THE CORRECTED LINE ✨ ---
            const intensity = document.getElementById(`batch-intensity-slider-${floor}-${type}`).value;

            allSchedules.push({
                floor,
                type,
                enabled,
                onTime,
                offTime,
                intensity: parseInt(intensity)
            });
        });
    }

    try {
        const response = await fetch('/api/lights/schedule/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(allSchedules)
        });

        if (!response.ok) {
            throw new Error('Server responded with an error');
        }

        showToast('✅ บันทึกตารางเวลาทั้งหมดเรียบร้อย!', true);
        closeBatchScheduleModal();
        updateLightControlUIStateFromBackend();
    } catch (err) {
        showToast('❌ เกิดข้อผิดพลาดในการบันทึกตารางเวลา', false);
        console.error("Save Batch Schedules Error:", err);
    }
}

async function openIndividualTimerModal(type, floor) {
    const modal = document.getElementById('timerModal');
    if (!modal) return;
    activeTimerModalContext = { type, floor };
    modal.querySelector('.modal-title').textContent = `ตั้งเวลาสำหรับชั้น ${floor} (${type})`;
    modal.classList.add('show');
    try {
        const res = await fetch('/api/lights/schedule');
        const schedules = await res.json();
        const key = `${floor}-${type}`;
        const schedule = schedules[key] || { enabled: false, on: '08:00', off: '18:00', intensity: 75 };
        modal.querySelector('#individual-enabled').checked = schedule.enabled;
        modal.querySelector('#individual-on-time').value = schedule.on;
        modal.querySelector('#individual-off-time').value = schedule.off;
        const intensitySlider = modal.querySelector('#individual-intensity');
        const intensityValue = modal.querySelector('#individual-intensity-val');
        intensitySlider.value = schedule.intensity;
        intensityValue.textContent = `${schedule.intensity}%`;
    } catch (err) { showToast('❌ ไม่สามารถโหลดข้อมูลตารางเวลาได้', false); }
}

async function saveIndividualSchedule() {
    const { floor, type } = activeTimerModalContext;
    if (!floor || !type) return;
    const modal = document.getElementById('timerModal');
    const payload = {
        floor: floor,
        type: type,
        enabled: modal.querySelector('#individual-enabled').checked,
        onTime: modal.querySelector('#individual-on-time').value,
        offTime: modal.querySelector('#individual-off-time').value,
        intensity: parseInt(modal.querySelector('#individual-intensity').value)
    };
    showToast('กำลังบันทึก...', true);
    try {
        await fetch('/api/lights/schedule', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        showToast('✅ บันทึกสำเร็จ!', true);
        closeTimerModal();
        updateLightControlUIStateFromBackend();
    } catch (err) { showToast('❌ บันทึกล้มเหลว', false); }
}

function closeTimerModal() { const modal = document.getElementById('timerModal'); if(modal) modal.classList.remove('show'); }
function closeBatchScheduleModal() { const modal = document.getElementById('batchScheduleModal'); if (modal) modal.classList.remove('show'); }

async function turnEverythingOff(){
    showConfirmationPopup({
        title: 'ยืนยันการปิดทั้งหมด',
        subtitle: 'คุณต้องการส่งคำสั่งปิด LED และพัดลมทุกชั้นใช่หรือไม่?',
        icon: 'fa-power-off',
        details: [{ label: 'คำสั่ง', value: 'ปิดอุปกรณ์ทั้งหมด', highlight: true }],
        onConfirm: async () => {
            showToast('กำลังส่งคำสั่งปิดทั้งหมด...', true);
            try { 
                await fetch('/api/lights/off/all', { method: 'POST' }); 
                showToast('✅ ส่งคำสั่งปิดทั้งหมดเรียบร้อย!', true); 
                updateLightControlUIStateFromBackend(); // ✅ เพิ่มบรรทัดนี้
            } catch(err) { 
                showToast('❌ เกิดข้อผิดพลาดในการส่งคำสั่ง', false); 
            }
        }
    });
}

async function clearAllSchedules(){
    showConfirmationPopup({
        title: 'ยืนยันการล้างตารางเวลา',
        subtitle: 'คุณต้องการลบการตั้งเวลาทั้งหมดในระบบใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้',
        icon: 'fa-trash-alt',
        details: [{ label: 'คำสั่ง', value: 'ลบข้อมูลการตั้งเวลาทั้งหมด', highlight: true }],
        onConfirm: async () => {
            showToast('กำลังล้างข้อมูลการตั้งเวลา...', true);
            try { 
                await fetch('/api/lights/schedule/all', { method: 'DELETE' }); 
                showToast('✅ ล้างการตั้งเวลาทั้งหมดแล้ว!', true); 
                updateLightControlUIStateFromBackend(); // ✅ เพิ่มบรรทัดนี้
            } catch(err) { 
                showToast('❌ เกิดข้อผิดพลาดในการล้างข้อมูล', false); 
            }
        }
    });
}


let currentRoleFilter = 'all';
let searchQuery = '';
let allUsers = [];
let sessionPingInterval = null; // ✅ เปลี่ยนชื่อและกำหนดค่าเริ่มต้นเป็น null
// โหลดข้อมูลผู้ใช้พร้อมคำนวณสถิติ
async function loadUsers() {
    const gridContainer = document.getElementById('userGridContainer');
    
    try {
        const response = await fetch('/api/users');
        const users = await response.json();
        allUsers = users;
        
        // Update stats
        updateUserStats(users);
        
        // Filter and display users
        displayUsers(filterUsers(users));
        
    } catch (error) {
        console.error('Error loading users:', error);
        gridContainer.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>เกิดข้อผิดพลาด</h3>
                <p>ไม่สามารถโหลดข้อมูลผู้ใช้ได้</p>
                <button class="btn-add-user" onclick="loadUsers()">
                    <i class="fas fa-redo"></i> ลองใหม่
                </button>
            </div>
        `;
    }
}
function getAvatarColor(username) {
    if (!username) return '#64748b'; // สีเทาสำหรับกรณีฉุกเฉิน
    let hash = 0;
    for (let i = 0; i < username.length; i++) {
        hash = username.charCodeAt(i) + ((hash << 5) - hash);
    }
    const colors = [
        '#ef4444', '#f97316', '#f59e0b', '#84cc16',
        '#22c55e', '#10b981', '#06b6d4', '#3b82f6',
        '#6366f1', '#8b5cf6', '#d946ef', '#ec4899'
    ];
    const index = Math.abs(hash % colors.length);
    return colors[index];
}
// อัพเดทสถิติผู้ใช้
function updateUserStats(users) {
    document.getElementById('totalUsers').textContent = users.length;
    
    // นับผู้ดูแลระบบ (IT และ หัวหน้างาน)
    const adminCount = users.filter(u => u.role === 'it' || u.role === 'หัวหน้างาน').length;
    document.getElementById('adminUsers').textContent = adminCount;
    
    // สถานะผู้ใช้งานออนไลน์
   const onlineCount = users.filter(u => u.is_online === true).length;
document.getElementById('onlineUsers').textContent = onlineCount;
    
    // นับผู้ใช้ที่สร้างวันนี้
    const today = new Date().toDateString();
    const newToday = users.filter(u => {
        const userDate = new Date(u.created_at).toDateString();
        return userDate === today;
    }).length;
    document.getElementById('newUsers').textContent = newToday;
}

// กรองผู้ใช้ตามเงื่อนไข
function filterUsers(users) {
    return users.filter(user => {
       const matchesRole = currentRoleFilter === 'all' || user.role.toLowerCase() === currentRoleFilter;
        const matchesSearch = user.username.toLowerCase().includes(searchQuery.toLowerCase());
        return matchesRole && matchesSearch;
    });
}

function displayUsers(users) {
    const tableBody = document.getElementById('userTableBody');
    const container = document.querySelector('.user-table-container');

    if (!tableBody) return; // ป้องกัน error ถ้าหา tbody ไม่เจอ

    if (users.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-users-slash"></i>
                <h3>ไม่พบผู้ใช้</h3>
                <p>ไม่มีผู้ใช้ที่ตรงกับเงื่อนไขการค้นหา</p>
            </div>
        `;
        return;
    }

    // ถ้ามีข้อมูล ให้แน่ใจว่าแสดงตาราง
    if (!document.querySelector('.user-table')) {
        container.innerHTML = `
            <table class="user-table">
                <thead>
                    <tr>
                        <th>ผู้ใช้งาน</th>
                        <th>บทบาท</th>
                        <th>วันที่เข้าร่วม</th>
                        <th>สถานะ</th>
                        <th>คำสั่ง</th>
                    </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>
        `;
    }
    
    const finalTableBody = document.getElementById('userTableBody');
    finalTableBody.innerHTML = ''; // เคลียร์ข้อมูลเก่า

    users.forEach(user => {
        const createdAt = new Date(user.created_at).toLocaleDateString('th-TH', {
            year: 'numeric', month: 'short', day: 'numeric'
        });
        const avatarColor = getAvatarColor(user.username);
        const userInitial = user.username.charAt(0).toUpperCase();
      const isOnline = user.is_online;

        const row = document.createElement('tr');
        row.className = 'user-row';
        row.innerHTML = `
            <td class="user-info-cell">
                <div class="user-avatar" style="background-color: ${avatarColor};">${userInitial}</div>
                <span>${user.username}</span>
            </td>
            <td>${getRoleBadge(user.role)}</td>
            <td>${createdAt}</td>
            <td>
                <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                ${isOnline ? 'ออนไลน์' : 'ออฟไลน์'}
            </td>
            <td>
                <div class="user-card-actions">
                    <button class="action-btn edit" onclick="showEditUserModal(${user.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete" onclick="confirmDeleteUser(${user.id}, '${user.username}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        finalTableBody.appendChild(row);
    });
}

// ฟังก์ชันค้นหา
function handleSearch(event) {
    searchQuery = event.target.value;
    displayUsers(filterUsers(allUsers));
}

// ฟังก์ชันกรองตาม role
function filterByRole(role) {
    currentRoleFilter = role;
    
    // Update active button
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    if (role === 'all') {
        document.getElementById('filter-all').classList.add('active');
    } else if (role === 'it') {
        document.getElementById('filter-it').classList.add('active');
    } else if (role === 'engineer') {
        document.getElementById('filter-engineer').classList.add('active');
    } else if (role === 'หัวหน้างาน') {
        document.getElementById('filter-supervisor').classList.add('active');
    } else if (role === 'พนักงาน') {
        document.getElementById('filter-employee').classList.add('active');
    }
    
    displayUsers(filterUsers(allUsers));
}

// ตรวจสอบความแข็งแรงของรหัสผ่าน
function checkPasswordStrength(password) {
    const strengthDiv = document.getElementById('passwordStrength');
    
    if (password.length === 0) {
        strengthDiv.style.display = 'none';
        return;
    }
    
    strengthDiv.style.display = 'flex';
    
    let strength = 0;
    if (password.length >= 8) strength++;
    if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
    if (password.match(/[0-9]/)) strength++;
    if (password.match(/[^a-zA-Z0-9]/)) strength++;
    
    // Reset all bars
    for (let i = 1; i <= 4; i++) {
        const bar = document.getElementById(`strength${i}`);
        bar.classList.remove('active', 'weak', 'strong');
    }
    
    // Fill bars based on strength
    for (let i = 1; i <= strength; i++) {
        const bar = document.getElementById(`strength${i}`);
        bar.classList.add('active');
        if (strength <= 2) {
            bar.classList.add('weak');
        } else {
            bar.classList.add('strong');
        }
    }
}

// สร้าง Role Badge
function getRoleBadge(role) {
    const icons = {
        'it': 'fa-laptop-code',
        'engineer': 'fa-hard-hat', 
        'หัวหน้างาน': 'fa-user-tie',
        'พนักงาน': 'fa-user'
    };
    
    const icon = icons[role] || 'fa-user';
    const roleClass = `role-${role.replace(/\s+/g, '-')}`;
    
    return `<span class="role-badge ${roleClass}">
        <i class="fas ${icon}"></i> ${role}
    </span>`;
}

// แสดง Modal เพิ่มผู้ใช้
function showAddUserModal() {
    document.getElementById('userId').value = '';
    document.getElementById('userUsername').value = '';
    document.getElementById('userPassword').value = '';
    document.getElementById('userRole').value = 'พนักงาน';
    document.getElementById('userUsername').disabled = false;
    document.getElementById('userPassword').placeholder = 'กรอกรหัสผ่านที่ปลอดภัย';
    document.getElementById('userModalTitle').innerText = 'เพิ่มผู้ใช้ใหม่';
    document.getElementById('userModalSubtitle').innerText = 'สร้างบัญชีสำหรับสมาชิกในทีมของคุณ';
    
    // Show modal with animation
    const modal = document.getElementById('userModal');
    modal.classList.add('show');
    
    // Reset password strength
    document.getElementById('passwordStrength').style.display = 'none';
}

// แสดง Modal แก้ไขผู้ใช้
async function showEditUserModal(id) {
    try {
        const response = await fetch(`/api/users/${id}`);
        const user = await response.json();

        document.getElementById('userId').value = user.id;
        document.getElementById('userUsername').value = user.username;
        document.getElementById('userPassword').value = ''; 
        document.getElementById('userRole').value = user.role;
        document.getElementById('userUsername').disabled = true;
        document.getElementById('userPassword').placeholder = 'เว้นว่างไว้หากไม่ต้องการเปลี่ยน';
        document.getElementById('userModalTitle').innerText = 'แก้ไขข้อมูลผู้ใช้';
        document.getElementById('userModalSubtitle').innerText = `คุณกำลังแก้ไขข้อมูลของ ${user.username}`;
        
        // Show modal
        const modal = document.getElementById('userModal');
        modal.classList.add('show');
        
        // Reset password strength
        document.getElementById('passwordStrength').style.display = 'none';
        
    } catch (error) {
        showToast('❌ ไม่สามารถโหลดข้อมูลผู้ใช้ได้', false);
    }
}

// ปิด Modal
function closeUserModal() {
    const modal = document.getElementById('userModal');
    modal.classList.remove('show');
    
    // Reset form after animation
    setTimeout(() => {
        document.getElementById('userForm').reset();
        document.getElementById('passwordStrength').style.display = 'none';
    }, 300);
}

// จัดการบันทึกผู้ใช้ (ป้องกัน form submit)
function handleSaveUser(event) {
    event.preventDefault();
    saveUser();
}

// 7. ฟังก์ชันสำหรับบันทึก (ทั้งเพิ่มและแก้ไข)
async function saveUser() {
    const id = document.getElementById('userId').value;
    const username = document.getElementById('userUsername').value;
    const password = document.getElementById('userPassword').value;
    const role = document.getElementById('userRole').value;

    const isEditing = !!id;
    const url = isEditing ? `/api/users/${id}` : '/api/users';
    const method = isEditing ? 'PUT' : 'POST';

    const body = { role };
    if (!isEditing) { body.username = username; }
    if (password) { body.password = password; }
    
    if (!username || (!password && !isEditing) || !role) {
        showToast('⚠️ กรุณากรอกข้อมูลให้ครบถ้วน', false);
        return;
    }

    try {
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const result = await response.json();

        if (response.ok) {
            showToast(`✅ ${isEditing ? 'อัปเดต' : 'เพิ่ม'}ผู้ใช้สำเร็จ!`, true);
            closeUserModal();
            loadUsers();
        } else {
            showToast(`❌ ${result.error}`, false);
        }
    } catch (error) {
        showToast('❌ เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์', false);
    }
}

// ✅ ฟังก์ชันสำหรับ WMS Dashboard
function updateDashboardStats() {
    // จำลองการอัพเดทสถิติ
    setTimeout(async () => {
        try {
            const [plansRes, ordersRes] = await Promise.all([
                fetch('/api/planting-plans'),
                fetch('/api/work-orders')
            ]);
            
            const plansData = await plansRes.json();
            const ordersData = await ordersRes.json();
            
            const totalPlans = plansData.success ? plansData.planting_plans.length : 0;
            const activeTasks = ordersData.success ? 
                ordersData.work_orders.filter(wo => wo.status === 'in_progress').length : 0;
            const completedTasks = ordersData.success ? 
                ordersData.work_orders.filter(wo => wo.status === 'completed').length : 0;
            const totalTasks = ordersData.success ? ordersData.work_orders.length : 0;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('totalPlans').textContent = totalPlans;
            document.getElementById('activeTasks').textContent = activeTasks;
            document.getElementById('completionRate').textContent = completionRate + '%';
            
        } catch (error) {
            console.error('Error updating dashboard stats:', error);
            document.getElementById('totalPlans').textContent = '0';
            document.getElementById('activeTasks').textContent = '0';
            document.getElementById('completionRate').textContent = '0%';
        }
    }, 500);
}

function updateLastSyncTime() {
    const now = new Date().toLocaleString('th-TH');
    document.getElementById('lastSyncTime').textContent = now;
}

function showAddPlanModal() {
    document.getElementById('addPlanModal').style.display = 'block';
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    const nextMonth = new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0];
    document.getElementById('plantingDate').value = today;
    document.getElementById('harvestDate').value = nextMonth;
}

function closeAddPlanModal() {
    document.getElementById('addPlanModal').style.display = 'none';
    document.getElementById('addPlanForm').reset();
}

async function submitPlan(event) {
    event.preventDefault();
    
    const formData = {
        vegetable_name: document.getElementById('vegetableName').value,
        level: parseInt(document.getElementById('level').value),
        planting_date: document.getElementById('plantingDate').value,
        harvest_date: document.getElementById('harvestDate').value,
        plant_count: parseInt(document.getElementById('plantCount').value),
        variety: document.getElementById('variety').value,
        source_system: 'Manual Entry',
        external_plan_id: 'MAN-' + Date.now()
    };
    
    try {
        const response = await fetch('/api/planting-plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showToast('✅ สร้างแผนการผลิตสำเร็จ!', true);
            closeAddPlanModal();
            loadPlantingPlans();
            loadWorkOrders();
            updateDashboardStats();
            updateLastSyncTime();
        } else {
            showToast(`❌ ${result.error}`, false);
        }
    } catch (error) {
        showToast('❌ เกิดข้อผิดพลาดในการเชื่อมต่อ', false);
    }
}

async function createWorkOrdersFromPlans() {
    if (!confirm('สร้างใบงานสำหรับแผนการผลิตที่รอดำเนินการทั้งหมด?')) return;
    
    try {
        // ดึงแผนการปลูกที่ยังไม่มีใบงาน
        const response = await fetch('/api/planting-plans');
        const result = await response.json();
        
        if (result.success) {
            let created = 0;
            for (const plan of result.planting_plans) {
                if (plan.status === 'received') {
                    // สร้างใบงานสำหรับแผนนี้
                    const createRes = await fetch('/api/planting-plan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ...plan,
                            external_plan_id: plan.external_plan_id || `AUTO-${plan.id}`
                        })
                    });
                    if (createRes.ok) created++;
                }
            }
            
            if (created > 0) {
                showToast(`✅ สร้างใบงาน ${created} รายการสำเร็จ!`, true);
                loadWorkOrders();
                updateDashboardStats();
            } else {
                showToast('ℹ️ ไม่มีแผนที่รอดำเนินการเพื่อสร้างใบงาน', false);
            }
        }
    } catch (error) {
        showToast('❌ เกิดข้อผิดพลาดในการสร้างใบงาน', false);
    }
}

function showCreateWorkOrderModal() {
    // สำหรับสร้างใบงานแบบ manual โดยไม่ต้องมีแผนการปลูก
    showToast('ℹ️ การสร้างใบงานแบบ manual - ฟีเจอร์นี้จะมาเร็วๆ นี้', false);
}

async function exportPlans() {
    try {
        const response = await fetch('/api/planting-plans');
        const result = await response.json();
        
        if (result.success) {
            // สร้าง CSV data
            const csvData = [
                ['รหัสแผน', 'ผลิตภัณฑ์', 'ชั้น', 'วันที่ปลูก', 'วันเก็บเกี่ยว', 'จำนวน', 'พันธุ์', 'สถานะ', 'วันที่ได้รับ'],
                ...result.planting_plans.map(plan => [
                    plan.id,
                    plan.vegetable_name,
                    plan.level,
                    plan.planting_date,
                    plan.harvest_date,
                    plan.plant_count,
                    plan.variety || '',
                    plan.status,
                    plan.received_at
                ])
            ];
            
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `แผนการผลิต-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('✅ ส่งออกข้อมูลสำเร็จ!', true);
        }
    } catch (error) {
        showToast('❌ การส่งออกล้มเหลว', false);
    }
}

function filterData() {
    // ฟังก์ชันสำหรับกรองข้อมูลตาม filter ต่างๆ
    loadPlantingPlans();
}

// ✅ ฟังก์ชันสำหรับโหลดข้อมูลแผนการปลูก (WMS-style)
async function loadPlantingPlans() {
    try {
        const response = await fetch('/api/planting-plans');
        const result = await response.json();
        
        if (response.ok && result.success) {
            const tbody = document.getElementById('plantingPlanTableBody');
            if (!tbody) return;
            
            if (result.planting_plans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-data">ไม่มีแผนการผลิต - ตรวจสอบการเชื่อมต่อ ERP</td></tr>';
                return;
            }
            
            tbody.innerHTML = result.planting_plans.map(plan => `
                <tr>
                    <td><strong>P${String(plan.id).padStart(4, '0')}</strong></td>
                    <td>${plan.vegetable_name}</td>
                    <td><span class="level-badge">ชั้น ${plan.level}</span></td>
                    <td>${formatDate(plan.planting_date)}</td>
                    <td>${formatDate(plan.harvest_date)}</td>
                    <td><span class="quantity-badge">${plan.plant_count} ต้น</span></td>
                    <td>${plan.variety || '-'}</td>
                    <td><span class="status-badge ${getStatusClass(plan.status)}">${getERPStatusText(plan.status)}</span></td>
                    <td>${formatDateTime(plan.received_at)}</td>
                    <td>
                        <button onclick="viewPlanDetails(${plan.id})" class="btn btn-sm btn-info" title="ดูรายละเอียด">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="createWorkOrderFromPlan(${plan.id})" class="btn btn-sm btn-success" title="สร้างใบงาน">
                            <i class="fas fa-plus"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            updateLastSyncTime();
        } else {
            document.getElementById('plantingPlanTableBody').innerHTML = 
                '<tr><td colspan="10" class="no-data error">เกิดข้อผิดพลาดในการโหลดข้อมูล - ตรวจสอบการเชื่อมต่อ API</td></tr>';
        }
    } catch (error) {
        console.error('Error loading planting plans:', error);
        document.getElementById('plantingPlanTableBody').innerHTML = 
            '<tr><td colspan="10" class="no-data error">เกิดข้อผิดพลาดในการเชื่อมต่อ - ตรวจสอบสถานะเซิร์ฟเวอร์</td></tr>';
    }
}

// ✅ ฟังก์ชันสำหรับโหลดข้อมูลใบงาน
async function loadWorkOrders() {
    try {
        const taskType = document.getElementById('taskTypeFilter')?.value || '';
        const status = document.getElementById('statusFilter')?.value || '';
        
        let url = '/api/work-orders?';
        if (taskType) url += `task_type=${taskType}&`;
        if (status) url += `status=${status}&`;
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (response.ok && result.success) {
            const tbody = document.getElementById('workOrderTableBody');
            if (!tbody) return;
            
            if (result.work_orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="no-data">ไม่มีใบงาน</td></tr>';
                return;
            }
            
            tbody.innerHTML = result.work_orders.map(order => `
                <tr>
                    <td><strong>${order.work_order_number}</strong></td>
                    <td><span class="task-type-badge ${getTaskTypeClass(order.task_type)}">${getTaskTypeText(order.task_type)}</span></td>
                    <td>${order.vegetable_name}</td>
                    <td><span class="level-badge">ชั้น ${order.level}</span></td>
                    <td>${formatDate(order.target_date)}</td>
                    <td><span class="quantity-badge">${order.plant_count} ต้น</span></td>
                    <td>${order.assigned_to || 'ยังไม่ได้มอบหมาย'}</td>
                    <td><span class="priority-badge ${getPriorityClass(order.priority)}">${getPriorityText(order.priority)}</span></td>
                    <td><span class="status-badge ${getStatusClass(order.status)}">${getStatusText(order.status)}</span></td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${order.progress || 0}%"></div>
                            <span class="progress-text">${order.progress || 0}%</span>
                        </div>
                    </td>
                    <td>
                        <button onclick="updateWorkOrderStatus(${order.id}, '${order.status}')" class="btn btn-sm btn-primary" title="แก้ไขสถานะ">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            document.getElementById('workOrderTableBody').innerHTML = 
                '<tr><td colspan="11" class="no-data error">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
        }
    } catch (error) {
        console.error('Error loading work orders:', error);
        document.getElementById('workOrderTableBody').innerHTML = 
            '<tr><td colspan="11" class="no-data error">เกิดข้อผิดพลาดในการเชื่อมต่อ</td></tr>';
    }
}

// ✅ ฟังก์ชันสำหรับอัพเดทสถานะใบงาน
async function updateWorkOrderStatus(orderId, currentStatus) {
    const newStatus = prompt(`อัพเดทสถานะใบงาน:\n\npending = รอดำเนินการ\nin_progress = กำลังทำ\ncompleted = เสร็จแล้ว\ncancelled = ยกเลิก\n\nสถานะปัจจุบัน: ${currentStatus}\nใส่สถานะใหม่:`, currentStatus);
    
    if (!newStatus || newStatus === currentStatus) return;
    
    if (!['pending', 'in_progress', 'completed', 'cancelled'].includes(newStatus)) {
        alert('สถานะไม่ถูกต้อง');
        return;
    }
    
    const progress = newStatus === 'completed' ? 100 : (newStatus === 'in_progress' ? 50 : 0);
    const assignedTo = newStatus === 'in_progress' ? prompt('กำหนดผู้รับผิดชอบ:', '') : null;
    
    try {
        const body = { status: newStatus, progress };
        if (assignedTo) body.assigned_to = assignedTo;
        
        const response = await fetch(`/api/work-orders/${orderId}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showToast('✅ อัพเดทสถานะสำเร็จ!', true);
            loadWorkOrders();
        } else {
            showToast(`❌ ${result.error}`, false);
        }
    } catch (error) {
        showToast('❌ เกิดข้อผิดพลาดในการเชื่อมต่อ', false);
    }
}

// ✅ ฟังก์ชันช่วยเหลือสำหรับแสดงผล
function formatDate(dateString) {
    if (!dateString) return '-';
    return new Date(dateString).toLocaleDateString('th-TH');
}

function formatDateTime(dateString) {
    if (!dateString) return '-';
    return new Date(dateString).toLocaleString('th-TH');
}

function getStatusClass(status) {
    const classes = {
        'received': 'status-info',
        'pending': 'status-warning', 
        'in_progress': 'status-primary',
        'completed': 'status-success',
        'cancelled': 'status-danger'
    };
    return classes[status] || 'status-secondary';
}

function getStatusText(status) {
    const texts = {
        'received': 'ได้รับแล้ว',
        'pending': 'รอดำเนินการ',
        'in_progress': 'กำลังทำ', 
        'completed': 'เสร็จแล้ว',
        'cancelled': 'ยกเลิก'
    };
    return texts[status] || status;
}

function getTaskTypeClass(taskType) {
    const classes = {
        'planting': 'task-planting',
        'harvest': 'task-harvest',
        'maintenance': 'task-maintenance'
    };
    return classes[taskType] || 'task-default';
}

function getTaskTypeText(taskType) {
    const texts = {
        'planting': 'งานปลูก',
        'harvest': 'งานเก็บเกี่ยว',
        'maintenance': 'งานบำรุงรักษา'
    };
    return texts[taskType] || taskType;
}

function getPriorityClass(priority) {
    const classes = {
        'low': 'priority-low',
        'normal': 'priority-normal',
        'high': 'priority-high',
        'urgent': 'priority-urgent'
    };
    return classes[priority] || 'priority-normal';
}

function getPriorityText(priority) {
    const texts = {
        'low': 'ต่ำ',
        'normal': 'ปกติ',
        'high': 'สูง',
        'urgent': 'เร่งด่วน'
    };
    return texts[priority] || priority;
}

function getERPStatusText(status) {
    const texts = {
        'received': 'ซิงค์แล้ว',
        'pending': 'รอดำเนินการ',
        'in_progress': 'กำลังประมวลผล', 
        'completed': 'เสร็จสิ้น',
        'cancelled': 'ยกเลิก'
    };
    return texts[status] || status;
}

async function viewPlanDetails(planId) {
    showToast(`ℹ️ ดูรายละเอียดแผน P${String(planId).padStart(4, '0')}`, false);
}

async function createWorkOrderFromPlan(planId) {
    if (!confirm(`สร้างใบงานจากแผน P${String(planId).padStart(4, '0')}?`)) return;
    
    showToast('ℹ️ กำลังสร้างใบงาน...', false);
    // ฟังก์ชันนี้จะถูกเพิ่มในอนาคต
}

// ฟังก์ชันสำหรับเปิด Modal ยืนยันการลบ
function confirmDeleteUser(id, username) {
    const modal = document.getElementById('deleteConfirmModal');
    const textElement = document.getElementById('deleteConfirmText');
    const confirmBtn = document.getElementById('confirmDeleteBtn');

    if (!modal || !textElement || !confirmBtn) {
        console.error("Delete modal elements not found!");
        return;
    }

    // ใส่ข้อความยืนยันแบบไดนามิก
    textElement.innerHTML = `คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้ <strong>"${username}"</strong> ?<br>การกระทำนี้ไม่สามารถย้อนกลับได้`;
    
    // เก็บ id ของผู้ใช้ที่จะลบไว้กับปุ่ม
    confirmBtn.dataset.userId = id;
    
    // แสดง Modal (คุณมี class 'show' ใน CSS อยู่แล้ว)
    modal.classList.add('show');
}

// ฟังก์ชันสำหรับปิด Modal
function closeDeleteConfirmModal() {
    const modal = document.getElementById('deleteConfirmModal');
    if(modal) {
        modal.classList.remove('show');
    }
}

// ฟังก์ชันที่ทำงานเมื่อกดยืนยันการลบใน Modal
function handleConfirmDelete() {
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const userId = confirmBtn.dataset.userId; // ดึง id ที่เก็บไว้ออกมา

    if (userId) {
        deleteUser(userId); // เรียกฟังก์ชันลบผู้ใช้เดิม
    }
    closeDeleteConfirmModal(); // ปิด Modal
}

// ฟังก์ชันสำหรับส่งคำสั่งลบไปยัง API (ฟังก์ชันนี้ยังคงเหมือนเดิม)
async function deleteUser(id) {
    try {
        const response = await fetch(`/api/users/${id}`, {
            method: 'DELETE'
        });
        const result = await response.json();

        if (response.ok) {
            showToast('✅ ลบผู้ใช้สำเร็จ!', true);
            loadUsers(); // โหลดรายชื่อผู้ใช้ใหม่เพื่ออัปเดตหน้าจอ
        } else {
            showToast(`❌ ${result.error}`, false);
        }
    } catch (error) {
        showToast('❌ เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์', false);
    }
}
//  [ใช้โค้ดนี้แทนที่ฟังก์ชัน startPinging เดิม] ✅✅✅
function startPinging() {
    // ถ้ามี Timer ทำงานอยู่แล้ว ไม่ต้องทำอะไรเลย
    if (sessionPingInterval) {
        console.log("Ping is already running.");
        return;
    }

    const userId = localStorage.getItem("userId");
    if (!userId) return;

    const ping = () => {
        fetch('/api/users/ping', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: userId })
        }).catch(err => console.error("Ping failed:", err));
    };

    ping(); // Ping ทันทีครั้งแรก
    // สร้าง Timer และเก็บ ID ไว้ในตัวแปร sessionPingInterval
    sessionPingInterval = setInterval(ping, 30 * 1000); // Ping ทุก 30 วินาที
    console.log("🟢 Online status pinging STARTED. Interval ID:", sessionPingInterval);
}

function updateTaskHistoryStats(data) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const todayTasks = data.filter(task => {
    const taskDate = new Date(task.completed_at || task.created_at);
    taskDate.setHours(0, 0, 0, 0);
    return taskDate.getTime() === today.getTime();
  });
  
  const inboundTasks = data.filter(task => task.action_type === 'inbound');
  const outboundTasks = data.filter(task => task.action_type === 'outbound');
  const successTasks = data.filter(task => task.status === 'success');
  const pendingTasks = data.filter(task => task.status === 'pending');
  
  document.getElementById('todayTaskCount').textContent = todayTasks.length;
  document.getElementById('inboundCount').textContent = inboundTasks.length;
  document.getElementById('outboundCount').textContent = outboundTasks.length;
  document.getElementById('successCount').textContent = successTasks.length;
  document.getElementById('pendingCount').textContent = pendingTasks.length;
}
</script>



</body>


</html>
