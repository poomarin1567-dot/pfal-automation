<!DOCTYPE html> 
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AGROTECH WMS - Login</title>
  
  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
  <!-- Task Status Helpers -->
  <script src="task-status-helpers.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'thai': ['Prompt', 'sans-serif'],
          },
          colors: {
            'agrotech': {
              50: '#f0f9f4',
              100: '#dcf2e4',
              200: '#bbe5cd',
              300: '#8dd1ab',
              400: '#56b382',
              500: '#40916c',
              600: '#2d6a4f',
              700: '#1b4332',
              800: '#081c15',
            }
          },
          animation: {
            'float': 'float 6s ease-in-out infinite',
            'pulse-soft': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'slide-up': 'slide-up 0.3s ease-out',
            'fade-in': 'fade-in 0.2s ease-out',
            'bounce-soft': 'bounce 2s infinite',
          },
          keyframes: {
            'float': {
              '0%, 100%': { transform: 'translateY(0px)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            'slide-up': {
              '0%': { transform: 'translateY(10px)', opacity: '0' },
              '100%': { transform: 'translateY(0px)', opacity: '1' },
            },
            'fade-in': {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            }
          }
        }
      }
    }
  </script>

  <style>
/* ===============================================================================
   üé® CSS STYLES - WAREHOUSE MANAGEMENT SYSTEM
   =============================================================================== */
/* ======================================================= */
/* === ‚ú® FIX: ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Popup ‡πÄ‡∏ö‡∏•‡∏≠‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ transform: scale ‚ú® === */
/* ======================================================= */

.modal-content-deluxe,
.popup-container,
.form-container-deluxe,
.modal-content,
.timer-modal-content,
.session-popup,
.tray-popup-card {
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden; /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Safari */
  transform: translateZ(0);
  -webkit-transform: translateZ(0); /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Safari */
}




/* ===== 1. GLOBAL FIXES & RESETS ===== */
/* ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á Pop-up ‡∏ã‡∏π‡∏°‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î ‚ú® */
.modal-content, .modal-content-deluxe {
  transform: scale(1) !important;
  zoom: 1 !important;

}

/* ===== 2. ANIMATIONS & KEYFRAMES ===== */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

@keyframes slideUp {
  from { 
    opacity: 0; 
    transform: translateY(20px) scale(0.95); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
  }
}

/* ===== 3. COMPONENT STYLES ===== */

/* === üåø PLANTING PLAN COMPONENTS === */
.planting-plan-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding: 1.5rem 2rem;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(240, 253, 244, 0.95) 100%);
    backdrop-filter: blur(16px);
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.4);
    position: relative;
    overflow: hidden;
}

.planting-plan-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #10b981 0%, #22c55e 50%, #84cc16 100%);
    background-size: 200% 100%;
    animation: headerGradientFlow 4s ease-in-out infinite;
}

/* Keyframes for the gradient flow animation */
@keyframes headerGradientFlow {
    0%, 100% { background-position: 200% center; }
    50% { background-position: 0% center; }
}

/* === üì¶ HEADER & ICON COMPONENTS === */
.header-icon-wrapper {
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border-radius: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.8rem;
  box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
  flex-shrink: 0;
}

.header-text h1 {
  margin: 0 0 0.25rem 0;
  font-size: 2rem;
  font-weight: 700;
  background: linear-gradient(135deg, #1b4332, #2d6a4f);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.header-text p {
  margin: 0;
  color: #64748b;
  font-weight: 500;
  letter-spacing: 0.5px;
}

/* === üìä HISTORY & STATS COMPONENTS === */

.history-container {
    animation: fadeIn 0.5s ease-out;
}

/* --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô) --- */
.history-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
    padding: 25px;
    background: linear-gradient(135deg, #fdfdff, #f8fafc);
    border-radius: 20px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.04);
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 15px;
}

.stat-item i {
    font-size: 1.8em;
    color: #10b981;
    background: linear-gradient(135deg, #e6f7f2, #dcfce7);
    padding: 16px;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(16,185,129,0.1);
}

.stat-item .stat-info .stat-label {
    color: #64748b;
    font-size: 0.9em;
    margin-bottom: 4px;
    font-weight: 500;
}

.stat-item .stat-info .stat-value {
    color: #1f2937;
    font-size: 1.5em;
    font-weight: 700;
}

/* --- [DELUXE] ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --- */
.history-list {
    display: flex;
    flex-direction: column;
    gap: 18px;
}

.history-card-deluxe {
    background: white;
    border-radius: 16px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    transition: all 0.3s ease;
    overflow: hidden;
}

.history-card-deluxe:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 28px rgba(0,0,0,0.1);
    border-color: #10b981;
}

.history-card-main {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    gap: 20px;
    flex-wrap: wrap;
}

.history-card-info {
    display: flex;
    align-items: center;
    gap: 20px;
    flex: 1;
    min-width: 300px;
}

.history-card-icon i {
    font-size: 2.2em;
    color: #10b981;
}

.history-card-title h4 {
    margin: 0 0 4px 0;
    font-size: 1.2em;
    font-weight: 600;
    color: #1f2937;
}

.history-card-title p {
    margin: 0;
    font-size: 0.9em;
    color: #6b7280;
}

.history-card-details {
    display: flex;
    gap: 25px;
    margin-left: auto; /* ‡∏î‡∏±‡∏ô‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ */
    flex-wrap: wrap;
    color: #4b5563;
    font-size: 0.9em;
}

.history-detail-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.history-detail-item i {
    color: #9ca3af;
}

.history-card-actions {
    padding: 20px 25px;
    background-color: #f9fafb;
    border-top: 1px solid #e5e7eb;
}

/* === ü™ü MODAL COMPONENTS === */

.modal-backdrop {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(17, 24, 39, 0.75); 
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    display: flex; justify-content: center; align-items: center;
    padding: 20px; z-index: 9999; animation: fadeIn 0.3s ease;
}

.modal-content-deluxe {
    background: #f8fafc; border-radius: 20px;
    box-shadow: 0 20px 45px rgba(0,0,0,0.25);
    width: 100%; max-width: 900px;
    animation: popIn 0.4s ease-out;
    display: flex; flex-direction: column;
    max-height: 90vh; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏ô‡∏à‡∏≠‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
    
}

.modal-header-deluxe {
    display: flex; justify-content: space-between; align-items: center;
    padding: 1.5rem 2rem; border-bottom: 1px solid #e2e8f0;
    background: white; border-radius: 20px 20px 0 0;
}
.modal-header-deluxe h2 { 
    margin: 0; font-size: 1.5rem; color: #1f2937; 
    display: flex; align-items: center; gap: 1rem;
}
.modal-header-deluxe h2 i { color: #10b981; }

.modal-close-btn {
    background: #e2e8f0; color: #64748b; border: none;
    width: 36px; height: 36px; border-radius: 50%;
    font-size: 1.2rem; cursor: pointer; transition: all 0.2s ease;
    display: flex; align-items: center; justify-content: center;
}
.modal-close-btn:hover { background: #cbd5e1; transform: rotate(90deg); }

.modal-body-deluxe { 
    padding: 2rem; 
    overflow-y: auto; /* ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ scroll ‡πÑ‡∏î‡πâ */
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.modal-section {
    background: white; border-radius: 16px; padding: 1.5rem;
    border: 1px solid #e2e8f0;
}
.modal-section h3 {
    margin: 0 0 1.25rem 0; color: #3b82f6; font-size: 1.2rem;
    display: flex; align-items: center; gap: 0.75rem;
    padding-bottom: 1rem; border-bottom: 1px solid #f1f5f9;
}

.info-grid, .stats-grid {
    display: grid; gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}
.stats-grid .stat-item { text-align: left; }

.trays-grid {
    display: grid; gap: 1rem;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
}
.tray-card, .work-order-card {
    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1rem;
}
.tray-header, .wo-header { 
    display: flex; justify-content: space-between; align-items: center; 
    margin-bottom: 0.75rem; font-weight: 600; color: #334155;
}
.tray-info, .wo-info { display: flex; flex-direction: column; gap: 0.375rem; font-size: 0.9rem; color: #475569; }

.modal-footer-deluxe {
    padding: 1.5rem 2rem; background: white; border-top: 1px solid #e2e8f0;
    display: flex; justify-content: flex-end; gap: 0.75rem;
    border-radius: 0 0 20px 20px;
}
    /* --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å --- */

/* 1. ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î */
.task-card.status-overdue {
  border-left-color: #ef4444; /* ‡πÅ‡∏î‡∏á */
  background-color: #fef2f2;
}
.task-card.status-urgent {
  border-left-color: #f97316; /* ‡∏™‡πâ‡∏° */
  background-color: #fff7ed;
}
.task-card.status-new {
  border-left-color: #3b82f6; /* ‡∏ü‡πâ‡∏≤ */
  background-color: #eff6ff;
}
.task-card.status-growing {
  border-left-color: #22c55e; /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
  background-color: #f0fdf4;
}

/* 2. ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Badge) ‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô */
.task-card-status-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    padding: 5px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
    border: 1px solid;
}

.task-card-status-badge.status-overdue {
    background-color: #ef4444;
    color: white;
    border-color: #b91c1c;
    animation: pulse 1.5s infinite;
}
.task-card-status-badge.status-urgent {
    background-color: #f97316;
    color: white;
    border-color: #c2410c;
    animation: pulse 2s infinite;
}
.task-card-status-badge.status-new {
    background-color: #3b82f6;
    color: white;
    border-color: #1d4ed8;
}
.task-card-status-badge.status-growing {
    background-color: #22c55e;
    color: white;
    border-color: #15803d;
}

/* 3. Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô */
@keyframes pulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.8;
    transform: scale(1.02);
  }
}
    /* ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥" */
/* ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥" ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏±‡∏ß‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
.task-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    border-top: 1px solid #f3f4f6;
    padding-top: 15px;
    flex-wrap: nowrap; /* <-- ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ */
}

.task-btn.btn-primary {
    background: #2563eb;
    color: white;
}
.task-btn.btn-primary:hover {
    background: #1d4ed8;
}

.task-btn.btn-secondary {
    background: #f3f4f6;
    color: #4b5563;
    border: 1px solid #e5e7eb;
}
.task-btn.btn-secondary:hover {
    background: #e5e7eb;
}
    /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö popup animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

@keyframes slideInUp {
  from { 
    opacity: 0; 
    transform: translateY(50px) scale(0.9); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
  }
}
    /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡πÉ‡∏´‡∏°‡πà */
.tab-navigation {
  display: flex;
  gap: 10px;
  background: #f8fafc;
  padding: 8px;
  border-radius: 12px;
  margin-bottom: 25px;
}

.tab-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  border: none;
  background: transparent;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
  color: #6b7280;
}

.tab-btn.active {
  background: #2563eb;
  color: white;
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
}

.tab-badge {
  background: rgba(255,255,255,0.2);
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  min-width: 20px;
  text-align: center;
}

.tab-btn.active .tab-badge {
  background: rgba(255,255,255,0.3);
}

.tasks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 20px;
}

.task-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  border-left: 4px solid #e5e7eb;
}

.task-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.pending-task { border-left-color: #f59e0b; }
.in-progress-task { border-left-color: #06b6d4; }
.alert-normal { border-left-color: #10b981; }
.alert-warning { border-left-color: #f59e0b; }
.alert-overdue { border-left-color: #ef4444; }

.task-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
}

.task-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: #1f2937;
  font-size: 16px;
}

.task-id, .task-location {
  font-size: 12px;
  color: #6b7280;
  background: #f3f4f6;
  padding: 4px 8px;
  border-radius: 6px;
}

.alert-icon.warning, .alert-icon.overdue {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.empty-state, .error-state {
  text-align: center;
  padding: 60px 20px;
  color: #6b7280;
}

.empty-state i, .error-state i {
  margin-bottom: 20px;
  opacity: 0.5;
  color: #9ca3af;
}

.empty-state h3, .error-state h3 {
  margin-bottom: 10px;
  color: #374151;
}

.task-btn {
  flex: 1;
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s ease;
}

#loadingOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading-content {
  text-align: center;
  color: white;
}

.loading-content i {
  margin-bottom: 15px;
}
/* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Tab System */
.tab-navigation {
  display: flex;
  gap: 10px;
  background: #f8fafc;
  padding: 8px;
  border-radius: 12px;
}

.tab-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  border: none;
  background: transparent;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
  color: #6b7280;
}

.tab-btn.active {
  background: #2563eb;
  color: white;
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
}

.tab-badge {
  background: rgba(255,255,255,0.2);
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.tab-btn.active .tab-badge {
  background: rgba(255,255,255,0.3);
}

.tasks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 20px;
}

.task-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  border-left: 4px solid #e5e7eb;
}

.task-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.pending-task {
  border-left-color: #f59e0b;
}

.in-progress-task {
  border-left-color: #06b6d4;
}

.task-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
}

.task-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: #1f2937;
  font-size: 16px;
}

.task-id, .task-location {
  font-size: 12px;
  color: #6b7280;
  background: #f3f4f6;
  padding: 4px 8px;
  border-radius: 6px;
}

.task-details {
  margin-bottom: 20px;
}

.detail-item {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
  font-size: 14px;
  color: #4b5563;
}

.detail-item i {
  width: 16px;
  color: #6b7280;
}

.task-actions {
  display: flex;
  gap: 10px;
}

.task-btn {
  flex: 1;
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s ease;
}

/* Alert Colors */
.alert-normal { border-left-color: #10b981; }
.alert-warning { border-left-color: #f59e0b; }
.alert-overdue { border-left-color: #ef4444; }

.alert-icon.normal { color: #10b981; }
.alert-icon.warning { color: #f59e0b; }
.alert-icon.overdue { color: #ef4444; }

.alert-detail .alert-icon.warning,
.alert-detail .alert-icon.overdue {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Empty States */
.empty-state, .error-state {
  text-align: center;
  padding: 60px 20px;
  color: #6b7280;
}

.empty-state i, .error-state i {
  margin-bottom: 20px;
  opacity: 0.5;
}

.empty-state h3, .error-state h3 {
  margin-bottom: 10px;
  color: #374151;
}

/* History Styles */
.history-stats {
  display: flex;
  gap: 30px;
  margin-bottom: 25px;
  padding: 20px;
  background: #f8fafc;
  border-radius: 12px;
}

.stat-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
  color: #374151;
}

.history-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.history-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.history-main {
  display: flex;
  align-items: center;
  gap: 20px;
}

.history-vegetable {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: #1f2937;
}

.history-details {
  display: flex;
  gap: 20px;
  font-size: 14px;
  color: #6b7280;
}

.history-details span {
  display: flex;
  align-items: center;
  gap: 5px;
}

/* Loading Overlay */
#loadingOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading-content {
  text-align: center;
  color: white;
}

.loading-content i {
  margin-bottom: 15px;
}

.loading-content p {
  font-size: 16px;
  margin: 0;
}

/* ================================================================================================
   üé® AGROTECH WMS STYLESHEET
   ================================================================================================
   
   üìã TABLE OF CONTENTS:
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   1. üöÄ PERFORMANCE & RESET STYLES
   2. üì± UTILITY & DROPDOWN COMPONENTS  
   3. üìÑ PAGINATION COMPONENTS
   4. üîß FORM & INPUT COMPONENTS
   5. üìä DASHBOARD & OVERVIEW COMPONENTS
   6. üèóÔ∏è LAYOUT & NAVIGATION
   7. üìπ CAMERA & MEDIA COMPONENTS
   8. üéõÔ∏è CONTROL & MONITORING COMPONENTS
   9. üìà CHART & VISUALIZATION COMPONENTS
   10. üì± RESPONSIVE DESIGN
   ================================================================================================ */

/* ================================================================================================
   1. üöÄ PERFORMANCE & RESET STYLES
   ================================================================================================ */
    
    /* CSS Performance Optimizations */
    * {
      box-sizing: border-box;
    }
    
    /* GPU acceleration for smooth animations */
    .animated, .btn, .card, .modal {
      transform: translateZ(0);
      will-change: transform, opacity;
    }
    
    /* Reduce layout thrashing */
    img, video {
      max-width: 100%;
      height: auto;
    }

/* ================================================================================================
   2. üì± UTILITY & DROPDOWN COMPONENTS
   ================================================================================================ */
    
    /*‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Excel Dropdown task history */
.excel-dropdown-container {
    position: relative;
    display: inline-block;
}

.excel-dropdown-menu {
    display: none;
    position: absolute;
    background-color: #ffffff;
    min-width: 180px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    z-index: 100;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #e2e8f0;
    margin-top: 8px;
}

.excel-dropdown-menu a {
    color: #334155;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    font-weight: 500;
    transition: background-color 0.2s ease;
}

.excel-dropdown-menu a:hover {
    background-color: #f1f5f9;
}

.excel-dropdown-menu.show-menu {
    display: block;
}

/* ================================================================================================
   3. üìÑ PAGINATION COMPONENTS
   ================================================================================================ */
   
/* ‚úÖ  Pagination task history */
.pagination-container {
   display: flex;
   justify-content: space-between;
   align-items: center;
   padding: 25px 30px;
   margin-top: 0;
   background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
   border-top: 1px solid #e2e8f0;
   flex-wrap: wrap;
   gap: 1rem;
}

.pagination-summary {
   color: #475569;
   font-weight: 600;
   font-size: 0.95rem;
}

.pagination-buttons {
   display: flex;
   gap: 8px;
}

.pagination-buttons button {
   min-width: 45px;
   padding: 10px 16px;
   border: 2px solid #e2e8f0;
   background: white;
   border-radius: 10px;
   font-weight: 600;
   color: #475569;
   cursor: pointer;
   transition: all 0.3s ease;
}

.pagination-buttons button:hover:not(:disabled) {
   border-color: #4f46e5;
   color: #4f46e5;
   transform: translateY(-2px);
   box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
}

.pagination-buttons button.active {
   background: linear-gradient(135deg, #4f46e5, #7c3aed);
   color: white;
   border-color: #4f46e5;
   box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
}

.pagination-buttons button:disabled {
   opacity: 0.5;
   cursor: not-allowed;
   transform: none !important;
}

.pagination-summary {
    color: #475569;
    font-weight: 500;
}

.pagination-buttons {
    display: flex;
    gap: 8px;
}

.pagination-buttons button {
    min-width: 40px;
    padding: 8px 16px;
    border: 1px solid #e2e8f0;
    background-color: #ffffff;
    border-radius: 8px;
    font-weight: 600;
    color: #475569;
    cursor: pointer;
    transition: all 0.2s ease;
}

.pagination-buttons button:hover {
    border-color: #4f46e5;
    color: #4f46e5;
}

.pagination-buttons button.active {
    background-color: #4f46e5;
    color: #ffffff;
    border-color: #4f46e5;
}

.pagination-buttons button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* üéØ PROFESSIONAL MODERN TASK HISTORY */
.task-monitor-enhanced {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 20px;
  padding: 32px 40px;
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.08),
    0 8px 24px rgba(0, 0, 0, 0.04);
  margin-bottom: 32px;
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.8);
}

/* ‚ú® Elegant top border */
.task-monitor-enhanced::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, 
    #6366f1 0%, 
    #8b5cf6 25%, 
    #ec4899 50%, 
    #06b6d4 75%, 
    #10b981 100%);
  border-radius: 20px 20px 0 0;
}

/* üé® Subtle floating decoration */
.task-monitor-enhanced::after {
  content: '';
  position: absolute;
  top: -80px;
  right: -80px;
  width: 160px;
  height: 160px;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.04));
  border-radius: 50%;
  filter: blur(30px);
  z-index: 0;
}

/* üìù Modern header */
.task-monitor-enhanced h2 {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 28px;
  position: relative;
  z-index: 1;
  background: linear-gradient(135deg, #1f2937 0%, #6366f1 100%);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.task-monitor-enhanced h2 i {
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 2.2rem;
  animation: gentlePulse 4s ease-in-out infinite;
}

@keyframes gentlePulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* üéõÔ∏è Clean controls */
.history-controls {
  display: flex;
  gap: 20px;
  align-items: center;
  margin-bottom: 28px;
  flex-wrap: wrap;
  background: rgba(255, 255, 255, 0.8);
  padding: 24px;
  border-radius: 16px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.6);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
  position: relative;
  z-index: 1;
}

/* üîç Clean search box */
.search-box {
  position: relative;
  flex: 1;
  min-width: 300px;
}

.search-box input {
  width: 100%;
  padding: 14px 50px 14px 18px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 500;
  transition: all 0.3s ease;
  background: #ffffff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.search-box input:focus {
  outline: none;
  border-color: #6366f1;
  box-shadow: 
    0 0 0 3px rgba(99, 102, 241, 0.1),
    0 4px 16px rgba(99, 102, 241, 0.15);
  transform: translateY(-1px);
}

.search-box i {
  position: absolute;
  right: 18px;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  font-size: 1.1rem;
  transition: all 0.3s ease;
}

.search-box input:focus + i {
  color: #6366f1;
  transform: translateY(-50%) scale(1.1);
}

/* üìã Clean filter */
#historyFilter {
  padding: 14px 20px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  background: #ffffff;
  color: #374151;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  transition: all 0.3s ease;
  min-width: 140px;
  appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 12px center;
  background-repeat: no-repeat;
  background-size: 16px;
  padding-right: 40px;
}

#historyFilter:hover {
  border-color: #6366f1;
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(99, 102, 241, 0.15);
}

/* üìä Clean export button */
.filter-btn {
  padding: 14px 24px;
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 
    0 4px 16px rgba(16, 185, 129, 0.25),
    0 2px 8px rgba(0, 0, 0, 0.08);
}

.filter-btn:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 8px 24px rgba(16, 185, 129, 0.35),
    0 4px 16px rgba(0, 0, 0, 0.12);
}

/* üìä Clean table */
.table-responsive-wrapper {
  background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.08),
    0 4px 16px rgba(0, 0, 0, 0.04),
    inset 0 1px 0 rgba(255, 255, 255, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(16px);
  transition: all 0.4s ease;
  position: relative;
}

.table-responsive-wrapper:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 12px 40px rgba(0, 0, 0, 0.1),
    0 6px 20px rgba(16, 185, 129, 0.08),
    inset 0 2px 0 rgba(255, 255, 255, 0.7);
}

.table-responsive-wrapper::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(16, 185, 129, 0.05), 
    transparent);
  animation: tableShimmer 3s infinite;
  z-index: 1;
  pointer-events: none;
}

.task-table-enhanced {
  width: 100%;
  border-collapse: collapse;
  background: white;
  margin: 0;
}

.task-table-enhanced thead th {
  background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
  color: white;
  padding: 18px 16px;
  font-weight: 700;
  font-size: 0.9rem;
  text-align: left;
  border: none;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  position: relative;
}

.task-table-enhanced tbody tr {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border-bottom: 1px solid rgba(243, 244, 246, 0.8);
  cursor: pointer;
}

.task-table-enhanced tbody tr:nth-child(even) {
  background: rgba(248, 250, 252, 0.3);
}

.task-table-enhanced tbody tr:hover {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.03) 100%);
  transform: translateX(4px) translateY(-1px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
  border-color: rgba(16, 185, 129, 0.2);
}

.task-table-enhanced tbody td {
  padding: 16px;
  font-size: 0.9rem;
  color: #374151;
  border: none;
  vertical-align: middle;
  transition: all 0.3s ease;
}

.task-table-enhanced tbody td strong {
  color: #1f2937;
  font-weight: 700;
}

/* üè∑Ô∏è Clean badges */
.status-enhanced, .floor-badge, .slot-badge, .action-badge, .user-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  font-weight: 600;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border: 1px solid transparent;
}

.status-enhanced.pending {
  background: #fef3c7;
  color: #92400e;
  border-color: #fbbf24;
}

.status-enhanced.working {
  background: #dbeafe;
  color: #1e40af;
  border-color: #3b82f6;
}

.status-enhanced.success {
  background: #d1fae5;
  color: #065f46;
  border-color: #10b981;
}

.action-badge.inbound {
  background: #d1fae5;
  color: #047857;
  border-color: #059669;
}

.action-badge.outbound {
  background: #fed7aa;
  color: #c2410c;
  border-color: #ea580c;
}

.action-badge.harvest {
  background: #dcfce7;
  color: #15803d;
  border-color: #22c55e;
}

.action-badge.move {
  background: #f3e8ff;
  color: #7c2d12;
  border-color: #8b5cf6;
}

.action-badge.transfer {
  background: #e0f2fe;
  color: #0c4a6e;
  border-color: #06b6d4;
}

.action-badge.relocate {
  background: #fed7aa;
  color: #c2410c;
  border-color: #f97316;
}

.floor-badge, .slot-badge {
  background: #e0e7ff;
  color: #3730a3;
  border-color: #6366f1;
}

.user-badge {
  background: #f3e8ff;
  color: #6b21a8;
  border-color: #8b5cf6;
}

/* üì± Responsive */
@media (max-width: 768px) {
  .task-monitor-enhanced {
    padding: 24px 20px;
  }
  
  .task-monitor-enhanced h2 {
    font-size: 1.6rem;
  }
  
  .history-controls {
    flex-direction: column;
    align-items: stretch;
  }
  
  .search-box {
    min-width: auto;
  }
}
/* üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏ß‡∏¢‡πÜ */
.task-stats-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card-mini {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  padding: 18px 20px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
  border: 1px solid #f1f5f9;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.stat-card-mini::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #6366f1, #8b5cf6, #ec4899);
  border-radius: 12px 12px 0 0;
}

.stat-card-mini:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.stat-card-mini .stat-number {
  font-size: 1.8rem;
  font-weight: 800;
  color: #6366f1;
  margin-bottom: 4px;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.stat-card-mini .stat-label {
  font-size: 0.85rem;
  color: #64748b;
  font-weight: 600;
}

.stat-card-mini .stat-icon {
  font-size: 1.2rem;
  color: #8b5cf6;
  margin-bottom: 8px;
}

    /* ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö container */

/* ===== CHART CONTAINERS - ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà ===== */
#pieChartContainer-new, .chart-container-new {
  position: relative;
  height: 400px;
  padding: 1rem;
  background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 
    0 8px 24px rgba(0, 0, 0, 0.06),
    inset 0 1px 0 rgba(255, 255, 255, 0.5);
  backdrop-filter: blur(12px);
  transition: all 0.4s ease;
  overflow: hidden;
}

.chart-container-new:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 12px 32px rgba(0, 0, 0, 0.08),
    0 4px 16px rgba(16, 185, 129, 0.1),
    inset 0 2px 0 rgba(255, 255, 255, 0.6);
}

/* ‚úÖ Chart loading animation overlay */
.chart-container-new::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(16, 185, 129, 0.1), 
    transparent);
  animation: chartShimmer 2s infinite;
  z-index: 1;
  pointer-events: none;
}

/* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î pie chart container ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© */
#pieChartContainer-new {
  height: 420px;
  padding: 1rem;
}

/* ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö hourly chart ‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ */
.chart-container-new.hourly {
  height: 280px; /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 220px ‡πÄ‡∏õ‡πá‡∏ô 280px */
}

/* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà */
#pieChart, #barChart, #hourlyChart {
  width: 100% !important;
  height: 100% !important;
  max-width: none !important;
  max-height: none !important;
}

/* ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö Chart.js options ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î */
.chart-container-new canvas {
  width: 100% !important;
  height: 100% !important;
  position: relative;
  z-index: 2;
  transition: all 0.3s ease;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.05));
}

.chart-container-new:hover canvas {
  filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.08));
}


    /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô <style>) */
.user-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
}

.user-table th, .user-table td {
    padding: 1.5rem;
    text-align: left;
    border: none;
    border-bottom: 1px solid rgba(241, 245, 249, 0.8);
    transition: all 0.3s ease;
    background: transparent;
}

.user-table thead {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 12px;
}

.user-table th {
    color: #334155;
    font-weight: 800;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 1px;
    position: relative;
    padding: 1.25rem 1.5rem;
}

.user-table th i {
    color: #10b981;
    margin-right: 0.5rem;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.user-table th:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
}

.user-table th:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
}

.user-table tbody tr {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
}

.user-table tbody tr:hover {
    background: linear-gradient(135deg, rgba(240, 253, 244, 0.8) 0%, rgba(220, 252, 231, 0.6) 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(16, 185, 129, 0.1);
}

.user-table tbody tr:hover td {
    border-color: rgba(16, 185, 129, 0.2);
}

.user-table tbody tr:hover th i {
    color: #059669;
    transform: scale(1.1);
}

.user-info-cell {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-weight: 600;
    color: #1e293b;
}

.user-info-cell .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
}

.status-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 0.5rem;
}

.status-dot.online { background-color: #10b981; }
.status-dot.offline { background-color: #94a3b8; }

/* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
.user-table .action-btn {
    padding: 0.5rem;
    font-size: 0.8rem;
}
.user-table .user-card-actions {
    justify-content: flex-start;
}
/* === üéØ ENHANCED USER MANAGEMENT DESIGN === */

.user-management-page {
    background: #f8fafc;
    min-height: 100vh;
    padding: 2rem;
    position: relative;
    overflow: hidden;
}

/* Background decoration */
.user-management-page::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(16, 185, 129, 0.08) 0%, transparent 70%);
    
    pointer-events: none;
}

@keyframes float {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    50% { transform: translate(-50px, -50px) rotate(180deg); }
}

/* Header Section */
.user-management-header {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.header-title {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header-title h2 {
    font-size: 2.2rem;
    font-weight: 800;
    background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
    -webkit-background-clip: text;
    background-clip: text;
    background-clip: text;
  background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0;
    letter-spacing: -0.03em;
}

.header-title i {
    font-size: 2rem;
    color: #10b981;
}

/* üìä Enhanced Stats Grid */
.user-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.75rem;
    margin-top: 1rem;
}

/* üé™ Premium Stat Cards */
.stat-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(16px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    padding: 2rem 1.75rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    cursor: pointer;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6, #ec4899);
    background-size: 300% 100%;
    animation: gradientShift 4s ease-in-out infinite;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.stat-card:hover::before {
    opacity: 1;
}

@keyframes gradientShift {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 100% center; }
}

.stat-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.12),
        0 8px 16px rgba(0, 0, 0, 0.08);
    border-color: rgba(255, 255, 255, 0.5);
}

.stat-icon {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border: 2px solid #bbf7d0;
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: #10b981;
    box-shadow: 
        0 8px 16px rgba(16, 185, 129, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.stat-card:hover .stat-icon {
    transform: rotate(5deg) scale(1.1);
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border-color: #047857;
}

.stat-info {
    flex: 1;
}

.stat-info h4 {
    font-size: 0.9rem;
    color: #64748b;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    line-height: 1.2;
}

.stat-info p {
    font-size: 2.25rem;
    font-weight: 800;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    -webkit-background-clip: text;
    background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0;
    line-height: 1;
    transition: all 0.3s ease;
}

.stat-card:hover .stat-info p {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    -webkit-background-clip: text;
    background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* üîç Modern Search and Filter Section */
.search-filter-section {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 24px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 
        0 16px 32px rgba(0, 0, 0, 0.08),
        0 8px 16px rgba(0, 0, 0, 0.04);
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    align-items: center;
    position: relative;
    z-index: 10;
}

.search-filter-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
    background-size: 200% 100%;
    animation: searchGradientFlow 3s ease-in-out infinite;
}

@keyframes searchGradientFlow {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 100% center; }
}

/* üîç Enhanced Search Box */
.search-box {
    position: relative;
    flex: 1;
    min-width: 300px;
}

.search-box input {
    width: 100%;
    padding: 1rem 3rem 1rem 1.5rem;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    font-size: 1rem;
    font-weight: 500;
    background: rgba(255, 255, 255, 0.9);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
}

.search-box input::placeholder {
    color: #94a3b8;
    font-weight: 400;
}

.search-box input:focus {
    outline: none;
    border-color: #10b981;
    background: white;
    box-shadow: 
        0 0 0 4px rgba(16, 185, 129, 0.1),
        0 8px 16px rgba(16, 185, 129, 0.1);
    transform: translateY(-1px);
}

.search-box i {
    position: absolute;
    right: 1.25rem;
    top: 50%;
    transform: translateY(-50%);
    color: #64748b;
    font-size: 1.1rem;
    pointer-events: none;
    transition: all 0.3s ease;
}

.search-box input:focus + i {
    color: #10b981;
    transform: translateY(-50%) scale(1.1);
}

/* üéØ Premium Filter Buttons */
.filter-group {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 0.875rem 1.75rem;
    border: 2px solid rgba(226, 232, 240, 0.8);
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    font-size: 0.95rem;
    font-weight: 600;
    color: #64748b;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
    overflow: hidden;
}

.filter-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease;
}

.filter-btn:hover::before {
    left: 100%;
}

.filter-btn:hover {
    border-color: #10b981;
    color: #10b981;
    background: rgba(240, 253, 244, 0.9);
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(16, 185, 129, 0.15);
}

.filter-btn.active {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border-color: transparent;
    box-shadow: 
        0 8px 20px rgba(16, 185, 129, 0.25),
        0 4px 8px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
}

.filter-btn.active::before {
    display: none;
}

.filter-btn i {
    font-size: 1rem;
    transition: transform 0.3s ease;
}

.filter-btn:hover i,
.filter-btn.active i {
    transform: scale(1.1);
}

/* Add User Button */
.btn-add-user {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    padding: 1rem 2rem;
    border: none;
    border-radius: 12px;
    font-size: 1.05rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
    transition: all 0.3s ease;
}

.btn-add-user:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px rgba(59, 130, 246, 0.4);
}

/* User Grid */
.user-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

/* Enhanced User Card */
.user-card {
    background: white;
    border-radius: 20px;
    padding: 1.75rem;
    position: relative;
    transition: all 0.3s ease;
    border: 1px solid #f1f5f9;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
}

.user-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
    transform: translateX(-100%);
    transition: transform 0.5s ease;
}

.user-card:hover::before {
    transform: translateX(0);
}

.user-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
}

.user-card-header {
    display: flex;
    align-items: flex-start;
    gap: 1.25rem;
    margin-bottom: 1.25rem;
}

.user-avatar {
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    position: relative;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.user-status {
    position: absolute;
    bottom: -2px;
    right: -2px;
    width: 18px;
    height: 18px;
    background: #10b981;
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.user-status.offline {
    background: #94a3b8;
}

.user-info {
    flex: 1;
    min-width: 0;
}

.user-info .username {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.verified-badge {
    font-size: 1rem;
    color: #3b82f6;
}

/* Enhanced Role Badge */
.role-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.875rem;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.025em;
    text-transform: uppercase;
    gap: 0.375rem;
}

.role-badge i {
    font-size: 0.75rem;
}

/* üè∑Ô∏è Role-specific Badge Colors */
.role-badge.admin { 
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); 
    color: #dc2626; 
    border-color: #fecaca;
}

.role-badge.engineer { 
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); 
    color: #2563eb; 
    border-color: #bfdbfe;
}

.role-badge.supervisor { 
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); 
    color: #d97706; 
    border-color: #fed7aa;
}

.role-badge.employee { 
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); 
    color: #16a34a; 
    border-color: #bbf7d0;
}

/* User Details */
.user-details {
    display: grid;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 12px;
    font-size: 0.9rem;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #64748b;
}

.detail-item i {
    width: 16px;
    color: #94a3b8;
}

.detail-item strong {
    color: #475569;
}

/* üîß Modern Action Buttons */
.user-card-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.action-btn {
    padding: 0.75rem;
    border: 2px solid #e2e8f0;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    height: 44px;
    position: relative;
    overflow: hidden;
}

.action-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease;
}

.action-btn:hover::before {
    left: 100%;
}

.action-btn.edit {
    color: #3b82f6;
    border-color: rgba(59, 130, 246, 0.2);
}

.action-btn.edit:hover {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-color: #3b82f6;
    color: #1e40af;
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 20px rgba(59, 130, 246, 0.2);
}

.action-btn.delete {
    color: #ef4444;
    border-color: rgba(239, 68, 68, 0.2);
}

.action-btn.delete:hover {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    border-color: #ef4444;
    color: #dc2626;
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 20px rgba(239, 68, 68, 0.2);
}

.action-btn i {
    transition: transform 0.3s ease;
}

.action-btn:hover i {
    transform: scale(1.2);
}

/* üé® Premium Modal Design 2024 */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.8);
    backdrop-filter: blur(25px) saturate(200%);
    -webkit-backdrop-filter: blur(25px) saturate(200%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.modal-backdrop.show {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(30px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 32px;
    padding: 3rem;
    width: 90%;
    max-width: 560px;
    box-shadow: 
        0 32px 64px rgba(0, 0, 0, 0.15),
        0 16px 32px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
    transform: scale(0.85) translateY(40px) rotateX(15deg);
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
}

.modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6, #ec4899, #f59e0b);
    background-size: 400% 100%;
    animation: modalGradientFlow 6s ease-in-out infinite;
}

@keyframes modalGradientFlow {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 100% center; }
}

.modal-backdrop.show .modal-content {
    transform: scale(1) translateY(0) rotateX(0);
}

.modal-header {
    text-align: center;
    margin-bottom: 2.5rem;
    position: relative;
}

.modal-title {
    font-size: 2rem;
    font-weight: 800;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
    -webkit-background-clip: text;
    background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0 0 0.75rem 0;
    letter-spacing: -0.02em;
    line-height: 1.2;
}

.modal-subtitle {
    color: #64748b;
    font-size: 1.05rem;
    font-weight: 500;
    margin: 0;
    opacity: 0.8;
}

/* üìù Enhanced Form Styling */
.form-group {
    margin-bottom: 2rem;
    position: relative;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 700;
    color: #334155;
    margin-bottom: 0.75rem;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-group label i {
    font-size: 1.1rem;
    color: #10b981;
    transition: all 0.3s ease;
}

.form-group:focus-within label i {
    color: #059669;
    transform: scale(1.1);
}

/* ‚ú® Modern Form Inputs */
.form-input,
.form-select {
    width: 100%;
    padding: 1.25rem 1.5rem;
    border: 2px solid rgba(226, 232, 240, 0.8);
    border-radius: 16px;
    font-size: 1rem;
    font-weight: 500;
    background: rgba(248, 250, 252, 0.8);
    backdrop-filter: blur(10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.form-input::placeholder {
    color: #94a3b8;
    font-weight: 400;
    transition: all 0.3s ease;
}

.form-input:focus::placeholder {
    opacity: 0.5;
    transform: translateY(-2px);
}

.form-input:focus,
.form-select:focus {
    outline: none;
    border-color: #10b981;
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 
        0 0 0 4px rgba(16, 185, 129, 0.1),
        0 8px 16px rgba(16, 185, 129, 0.1);
    transform: translateY(-2px);
}

.form-input:disabled {
    background: rgba(241, 245, 249, 0.6);
    cursor: not-allowed;
    opacity: 0.6;
    transform: none;
}

.form-select {
    cursor: pointer;
    appearance: none;
    background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2364748b"><path d="M7 10l5 5 5-5z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1.5rem;
    padding-right: 3rem;
}

.form-select:focus {
    background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2310b981"><path d="M7 10l5 5 5-5z"/></svg>');
}

/* üîí Advanced Password Strength Indicator */
.password-strength {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    height: 6px;
    position: relative;
}

.password-strength::after {
    content: 'Password Strength';
    position: absolute;
    top: -1.5rem;
    left: 0;
    font-size: 0.8rem;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.strength-bar {
    flex: 1;
    background: rgba(226, 232, 240, 0.8);
    border-radius: 6px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.strength-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: strengthShimmer 1.5s ease-in-out infinite;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.strength-bar.active::after {
    opacity: 1;
}

@keyframes strengthShimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.strength-bar.active {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
}

.strength-bar.weak {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

.strength-bar.medium {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.strength-bar.strong {
    background: linear-gradient(135deg, #10b981 0%, #047857 100%);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
}

/* üöÄ Premium Modal Actions */
.modal-actions {
    display: flex;
    gap: 1.25rem;
    margin-top: 3rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(226, 232, 240, 0.6);
}

.modal-btn {
    flex: 1;
    padding: 1.25rem 2rem;
    border: 2px solid transparent;
    border-radius: 16px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    position: relative;
    overflow: hidden;
}

.modal-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.6s ease;
}

.modal-btn:hover::before {
    left: 100%;
}

.modal-btn i {
    font-size: 1.1rem;
    transition: transform 0.3s ease;
}

.modal-btn:hover i {
    transform: scale(1.1);
}

.modal-btn.primary {
    background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
    color: white;
    border-color: transparent;
    box-shadow: 
        0 8px 20px rgba(16, 185, 129, 0.25),
        0 4px 8px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.modal-btn.primary:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 
        0 16px 32px rgba(16, 185, 129, 0.35),
        0 8px 16px rgba(0, 0, 0, 0.15);
    background: linear-gradient(135deg, #059669 0%, #047857 50%, #065f46 100%);
}

.modal-btn.primary:active {
    transform: translateY(-2px) scale(0.98);
}

.modal-btn.secondary {
    background: rgba(248, 250, 252, 0.9);
    color: #64748b;
    border-color: rgba(226, 232, 240, 0.8);
    backdrop-filter: blur(10px);
}

.modal-btn.secondary:hover {
    background: rgba(226, 232, 240, 0.9);
    color: #475569;
    border-color: #cbd5e1;
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
}

.modal-btn.secondary:active {
    transform: translateY(-1px) scale(0.98);
}

/* Loading States */
.skeleton {
    background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* üôÉ Enhanced Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 24px;
    box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.08),
        0 8px 16px rgba(0, 0, 0, 0.04);
    position: relative;
    overflow: hidden;
}

.empty-state::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #94a3b8, #64748b, #475569);
    background-size: 200% 100%;
    animation: emptyStateGradient 3s ease-in-out infinite;
}

@keyframes emptyStateGradient {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 100% center; }
}

.empty-state i {
    font-size: 4rem;
    color: #cbd5e1;
    margin-bottom: 1.5rem;
    opacity: 0.6;
}

.empty-state h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #475569;
    margin: 0 0 0.5rem 0;
}

.empty-state p {
    color: #64748b;
    font-size: 1rem;
    margin: 0;
    opacity: 0.8;
}

.empty-state i {
    font-size: 4rem;
    color: #e2e8f0;
    margin-bottom: 1rem;
}

.empty-state h3 {
    font-size: 1.5rem;
    color: #64748b;
    margin: 0 0 0.5rem 0;
}

.empty-state p {
    color: #94a3b8;
    margin: 0 0 2rem 0;
}

/* Responsive Design */
@media (max-width: 768px) {
/* User Table Design */
.user-table-container {
    background: white;
    border-radius: 20px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow-x: auto;
}

.user-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
}

.user-table th, .user-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #f1f5f9;
}

.user-table th {
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
}

.user-table tbody tr:hover {
    background-color: #f8fafc;
}

.user-info-cell {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    font-size: 1rem;
    flex-shrink: 0;
}

    /* üì± Mobile Responsive Design for User Management */
    .user-management-page {
        padding: 1rem;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    .user-management-header {
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-radius: 20px;
    }
    
    .header-top {
        flex-direction: column;
        align-items: stretch;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .header-title h2 {
        font-size: 1.8rem;
        text-align: center;
    }
    
    .btn-add-user {
        padding: 0.875rem 1.5rem;
        font-size: 0.9rem;
        align-self: stretch;
    }
    
    .user-stats {
        grid-template-columns: 1fr;
        gap: 1.25rem;
        margin-top: 0;
    }
    
    .stat-card {
        padding: 1.5rem;
        gap: 1.25rem;
    }
    
    .stat-icon {
        width: 56px;
        height: 56px;
        font-size: 1.3rem;
    }
    
    .stat-info p {
        font-size: 2rem;
    }
    
    /* Search and Filter Responsive */
    .search-filter-section {
        padding: 1.5rem;
        border-radius: 20px;
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-box {
        min-width: unset;
        width: 100%;
    }
    
    .search-box input {
        padding: 0.875rem 2.5rem 0.875rem 1.25rem;
    }
    
    .filter-group {
        justify-content: center;
    }
    
    .filter-btn {
        padding: 0.75rem 1.25rem;
        font-size: 0.85rem;
    }
    
    /* User Table Responsive */
    .user-table-container {
        padding: 1.5rem;
        border-radius: 20px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .user-table {
        min-width: 600px;
    }
    
    .user-table td {
        padding: 1rem;
    }
    
    .action-btn {
        min-width: 40px;
        height: 40px;
        padding: 0.625rem;
    }
    
    /* Modal Responsive */
    .modal-content {
        width: 95%;
        max-width: 90vw;
        padding: 2rem;
        border-radius: 24px;
        margin: 1rem;
    }
    
    .modal-title {
        font-size: 1.75rem;
    }
    
    .form-input,
    .form-select {
        padding: 1rem 1.25rem;
    }
    
    .modal-actions {
        flex-direction: column;
        gap: 1rem;
    }
    
    .modal-btn {
        padding: 1rem 1.5rem;
    }
    
    .search-filter-section {
        flex-direction: column;
    }
    
    .user-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .modal-content {
        padding: 1.5rem;
    }
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.user-card {
    animation: fadeIn 0.5s ease-out;
    animation-fill-mode: both;
}

.user-card:nth-child(1) { animation-delay: 0.1s; }
.user-card:nth-child(2) { animation-delay: 0.2s; }
.user-card:nth-child(3) { animation-delay: 0.3s; }
.user-card:nth-child(4) { animation-delay: 0.4s; }
.user-card:nth-child(5) { animation-delay: 0.5s; }
.user-card:nth-child(6) { animation-delay: 0.6s; }





/* popup ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ */
@keyframes modal-pulse-green {
  0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
  70% { box-shadow: 0 0 0 12px rgba(16, 185, 129, 0); }
  100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}
@keyframes modal-pulse-red {
  0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
  70% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
  100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
}

.timer-modal-backdrop {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(9, 30, 27, 0.65);
    backdrop-filter: blur(20px) saturate(180%); 
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    display: none; align-items: center; justify-content: center;
    z-index: 1000; opacity: 0; transition: opacity 0.3s ease;
}
.timer-modal-backdrop.show { display: flex; opacity: 1; }

.timer-modal-backdrop .timer-modal-content {
    position: relative; background: #ffffff;
    border-radius: 20px; padding: 35px 30px 30px 30px;
    width: 90%; max-width: 400px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    text-align: center;
    transform: scale(0.95); opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
    border-top: 4px solid transparent;
}

/* ‚úÖ Special styling for batch schedule modal */
#batchScheduleModal .timer-modal-content {
    max-width: 1200px !important;
    text-align: left;
    padding: 40px;
}
.timer-modal-backdrop.show .timer-modal-content { transform: scale(1); opacity: 1; }

.timer-modal-backdrop .modal-status-indicator {
    position: absolute; top: -11px; left: 50%;
    transform: translateX(-50%); width: 20px; height: 20px;
    border-radius: 50%; border: 4px solid #ffffff;
}
.timer-modal-backdrop .timer-modal-content.is-on .modal-status-indicator {
    background-color: #10b981; animation: modal-pulse-green 2s infinite;
}
.timer-modal-backdrop .timer-modal-content.is-off .modal-status-indicator {
    background-color: #ef4444; animation: modal-pulse-red 2s infinite;
}
.timer-modal-backdrop .timer-modal-content.is-on { border-top-color: #10b981; }
.timer-modal-backdrop .timer-modal-content.is-off { border-top-color: #ef4444; }

.timer-modal-backdrop .modal-title {
    font-size: 1.5rem; font-weight: 600;
    color: var(--global-text-bright); margin: 10px 0 30px 0;
}
.timer-modal-backdrop .timer-group { margin-bottom: 20px; text-align: left; }
.timer-modal-backdrop .timer-group label { display: block; font-weight: 600; color: var(--global-text-normal); margin-bottom: 10px; }
.timer-modal-backdrop .timer-input {
    width: 100%; padding: 14px; border: 1px solid var(--global-border);
    background-color: var(--global-bg-main); border-radius: 12px;
    font-size: 1.1rem; color: var(--global-text-bright);
}
.timer-modal-backdrop .timer-modal-actions { margin-top: 30px; display: flex; gap: 15px; }
.timer-modal-backdrop .modal-btn {
    flex-grow: 1; padding: 14px; border-radius: 14px;
    font-size: 1rem; font-weight: 700;
    border: none; cursor: pointer; transition: all 0.2s ease;
}
.timer-modal-backdrop .modal-btn.cancel { background-color: #e5e7eb; color: #4b5563; }
.timer-modal-backdrop .modal-btn.cancel:hover { background-color: #d1d5db; }
.timer-modal-backdrop .modal-btn.save.is-on { background: #059669; color: white; }
.timer-modal-backdrop .modal-btn.save.is-on:hover { background: #047857; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3); }
.timer-modal-backdrop .modal-btn.save.is-off { background: #dc2626; color: white; }
.timer-modal-backdrop .modal-btn.save.is-off:hover { background: #b91c1c; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(220, 38, 38, 0.3); }

/* ‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á light control  --- */
.light-control-header-new {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.9));
    backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    border: 1px solid rgba(255,255,255,0.3);
    position: relative;
    overflow: hidden;
}

.light-control-header-new::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #f59e0b, #ef4444, #10b981);
    background-size: 300% 100%;
    animation: headerFlow 4s ease-in-out infinite;
}

@keyframes headerFlow {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 300% center; }
}

.header-content-new {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.header-icon-new {
    position: relative;
    width: 60px; height: 60px;
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 25px rgba(59,130,246,0.3);
}

.header-icon-new i {
    font-size: 1.8rem;
    color: white;
    z-index: 2;
}

.icon-glow-new {
    position: absolute;
    width: 100%; height: 100%;
    background: rgba(255,255,255,0.3);
    border-radius: 18px;
    animation: iconPulse 2s ease-in-out infinite;
}

@keyframes iconPulse {
    0%, 100% { transform: scale(1); opacity: 0.3; }
    50% { transform: scale(1.1); opacity: 0.1; }
}

.header-text-new h1 {
    font-size: 2rem;
    font-weight: 800;
    margin: 0;
    background: linear-gradient(135deg, #1e293b, #3b82f6, #8b5cf6);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    background-clip: text;
    background-clip: text;
  background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: titleShift 3s ease-in-out infinite;
}

.header-text-new p {
    color: #64748b;
    font-weight: 500;
    margin: 0.5rem 0 0 0;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.9rem;
}

@keyframes titleShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.status-badge-new {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: rgba(16,185,129,0.1);
    border: 1px solid rgba(16,185,129,0.3);
    border-radius: 12px;
    color: #10b981;
    font-weight: 600;
}

.status-dot-new {
    width: 8px; height: 8px;
    background: #10b981;
    border-radius: 50%;
    animation: statusPulse 2s ease-in-out infinite;
}

@keyframes statusPulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.2); }
}

/* ‡πÄ‡∏û‡∏¥‡πà‡∏° hover effects ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏° */
.global-power-btn {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.global-power-btn::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.6s ease;
}

.global-power-btn:hover::before {
    left: 100%;
}

.global-power-btn:hover {
    transform: translateY(-3px);
}

/* ‡πÄ‡∏û‡∏¥‡πà‡∏° hover effects ‡πÉ‡∏´‡πâ floor cards ‡πÄ‡∏î‡∏¥‡∏° */
.floor-card {
    position: relative;
    overflow: hidden;
    transition: all 0.4s ease;
}

.floor-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
}

.floor-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #f59e0b, #ef4444);
    transform: scaleX(0);
    transition: transform 0.4s ease;
}

.floor-card:hover::before {
    transform: scaleX(1);
}

/* ‡πÄ‡∏û‡∏¥‡πà‡∏° animation ‡πÉ‡∏´‡πâ control rows ‡πÄ‡∏î‡∏¥‡∏° */
.control-row {
    transition: all 0.2s ease;
    border-radius: 8px;
    padding: 0.5rem;
    margin: 0.25rem 0;
}

.control-row:hover {
    background: rgba(59, 130, 246, 0.05);
    transform: translateX(5px);
}

.control-timer-btn:hover {
    transform: scale(1.1);
    background: #f3f4f6;
}

.premium-slider:hover {
    transform: scaleY(1.2);
}

/* Responsive */
@media (max-width: 768px) {
    .light-control-header-new {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .header-content-new {
        flex-direction: column;
        gap: 1rem;
    }
    
    .header-text-new h1 {
        font-size: 1.5rem;
    }
}


/* Light Control Page  --- */


.light-control-page-theme {
  --lc-bg: linear-gradient(120deg, #f3f9ff 0%, #e6f7f4 100%);
  --lc-card-bg: rgba(255, 255, 255, 0.7);
  --lc-card-border: rgba(255, 255, 255, 0.9);
  --lc-shadow: rgba(45, 212, 191, 0.1);
  --lc-text-header: #0a3d34;
  --lc-text-primary: #115e59;
  --lc-text-secondary: #526a82;
  --lc-accent-green: #2dd4bf;
  --lc-accent-red: #f43f5e;
  --lc-accent-blue: #3b82f6;
  --lc-slider-track: #e0f2fe;
}
.light-control-page-theme .light-control-container {
  background: var(--lc-bg); padding: 30px;
}
.light-control-page-theme .light-control-header {
  font-size: 2.2rem; font-weight: 700; color: var(--lc-text-header);
  display: flex; align-items: center; gap: 16px; margin-bottom: 24px;
}
.light-control-page-theme .light-control-header i { color: var(--lc-accent-green); }
.light-control-page-theme .global-control-card,
.light-control-page-theme .floor-card {
  background: var(--lc-card-bg);
  backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
  border-radius: 24px; padding: 28px;
  border: 1px solid var(--lc-card-border);
  box-shadow: 0 10px 30px var(--lc-shadow);
  margin-bottom: 28px;
}
.light-control-page-theme .card-title,
.light-control-page-theme .floor-title h3 {
  font-size: 1.4rem; font-weight: 600; color: var(--lc-text-primary);
  display: flex; align-items: center; gap: 12px; margin: 0;
  padding-bottom: 20px; border-bottom: 1px solid rgba(13, 148, 136, 0.1);
}
.light-control-page-theme .floor-title h3 { padding-bottom: 0; border-bottom: none; }
.light-control-page-theme .global-actions { display: flex; gap: 20px; margin-top: 24px; }
.light-control-page-theme .global-power-btn {
  flex-grow: 1; display: flex; align-items: center; justify-content: center;
  gap: 12px; padding: 18px; border: 1px solid transparent; border-radius: 18px;
  cursor: pointer; transition: all 0.3s ease; font-size: 1.1rem; font-weight: 700;
}
.light-control-page-theme .global-power-btn.on { background: var(--lc-accent-green); color: white; box-shadow: 0 8px 20px rgba(45, 212, 191, 0.3); }
.light-control-page-theme .global-power-btn.on:hover { transform: translateY(-3px); }
.light-control-page-theme .global-power-btn.off { background: #e7eef7; color: var(--lc-text-secondary); border: 1px solid #dbe2ef; }
.light-control-page-theme .global-power-btn.off:hover { background-color: #dbe2ef; }
.light-control-page-theme .global-timer-section { margin-top: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.light-control-page-theme .timer-group label { font-weight: 600; color: var(--lc-text-secondary); margin-bottom: 8px; display: block; }
.light-control-page-theme .timer-input {
  width: 100%; background-color: #f3f7fe; border: 1px solid #e0e9f8;
  border-radius: 12px; padding: 12px; font-size: 1rem; color: var(--lc-text-primary);
}
.light-control-page-theme .timer-input:focus { outline: none; border-color: var(--lc-accent-green); box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.2); }
.light-control-page-theme .floor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap: 28px; }
.light-control-page-theme .floor-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.light-control-page-theme .floor-title-actions { display: flex; align-items: center; gap: 12px; }
.light-control-page-theme .floor-timer-btn {
  background: transparent; border: 1px solid #cedbe7; color: var(--lc-text-secondary);
  font-weight: 600; font-size: 0.9rem; padding: 8px 16px;
  border-radius: 12px; cursor: pointer; display: flex;
  align-items: center; gap: 8px; transition: all 0.2s ease;
}
.light-control-page-theme .floor-timer-btn:hover { background-color: rgba(255,255,255,0.5); border-color: #a8b9d0; }
.light-control-page-theme .control-row { display: flex; align-items: center; gap: 16px; padding: 10px 0; }
.light-control-page-theme .control-icon { font-size: 1.4rem; width: 30px; text-align: center; }
.light-control-page-theme .control-value { font-size: 1.1rem; font-weight: 700; color: var(--lc-text-primary); min-width: 55px; text-align: right; }
.light-control-page-theme .control-timer-btn {
  background: transparent; border: 1px solid #dbe2ef; color: #8397b0;
  cursor: pointer; font-size: 1.1rem; width: 38px; height: 38px;
  border-radius: 50%; transition: all 0.2s ease;
}
.light-control-page-theme .control-timer-btn:hover { background: #e7eef7; color: var(--lc-text-secondary); }
.light-control-page-theme .slider-container { flex-grow: 1; }
.light-control-page-theme input[type="range"].premium-slider {
  -webkit-appearance: none; appearance: none;
  width: 100%; height: 6px; background: var(--lc-slider-track);
  border-radius: 3px; outline: none;
  background-image: linear-gradient(var(--fill-color, var(--lc-accent-green)), var(--fill-color, var(--lc-accent-green)));
  background-size: var(--value, 50%) 100%;
  background-repeat: no-repeat;
}
.light-control-page-theme input[type="range"].premium-slider::-webkit-slider-thumb {
  -webkit-appearance: none; appearance: none;
  width: 22px; height: 22px; background: #ffffff;
  cursor: pointer; border-radius: 50%;
  border: 3px solid var(--fill-color, var(--lc-accent-green));
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.light-control-page-theme input[type="range"].premium-slider:disabled { opacity: 0.4; }








/* ‚ú® FINAL: XL Header & All Elements Enlarged ‚ú® *

/* ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏™‡∏á‡∏Å‡∏ß‡∏≤‡∏î (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
@keyframes gradient-sweep {
  0% { background-position: 200% center; }
  100% { background-position: -200% center; }
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 30px; 
  background: #ffffff;
  border-bottom: 1px solid #e2e8f0;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  position: relative;  /* <-- ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ */
  z-index: 1000;       /* <-- ‚ú® ‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ */
}
/* --- ‡∏™‡πà‡∏ß‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ --- */
.header-left {
    display: flex;
    align-items: center;
    gap: 30px; /* üîº ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á */
    flex: 1; /* ‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
    min-width: 0; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô flex item overflow */
}

.dashboard-title {
    display: flex;
    align-items: center;
    gap: 18px;
}

.dashboard-title h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* ‡πÅ‡∏™‡∏î‡∏á ... ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô */
    /* ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á */
    background: linear-gradient(90deg, #1b4332, var(--overview-accent-green), #b7e4c7, var(--overview-accent-green), #1b4332);
    background-size: 200% auto;
    color: #000;
    background-clip: text;
    -webkit-background-clip: text;
    background-clip: text;
    background-clip: text;
  background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: gradient-sweep 10s linear infinite;
}
.dashboard-icon {
    height: 60px; /* üîºüîºüîº ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô */
    width: 60px;
}

.station-dropdown {
    padding: 12px 20px; /* üîº ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î Dropdown */
    font-size: 1rem;    /* üîº ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå */
    font-weight: 600;
    border-radius: 12px;
}

/* --- ‡∏™‡πà‡∏ß‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ --- */
.header-right {
    position: relative;
}

.user-menu {
  padding: 12px 18px; /* üîº ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ */
  font-size: 1rem;    /* üîº ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå */
  border-radius: 12px;
}

/* ===== 4. CSS VARIABLES ===== */

:root {
  /* Enhanced Color Palette */
  --overview-primary: #0f766e;
  --overview-primary-light: #14b8a6;
  --overview-accent-green: #10b981;
  --overview-accent-blue: #0ea5e9;
  --overview-accent-purple: #8b5cf6;
  --overview-accent-orange: #f59e0b;
  --overview-accent-red: #ef4444;
  --overview-accent-cyan: #06b6d4;
  
  /* Background & Surface */
  --overview-bg-main: #f1f5f9;
  --overview-bg-card: #ffffff;
  --overview-bg-glass: rgba(255, 255, 255, 0.95);
  
  /* Text Colors */
  --overview-text-primary: #0f172a;
  --overview-text-secondary: #475569;
  --overview-text-muted: #64748b;
  
  /* Border & Effects */
  --overview-border: #e2e8f0;
  --overview-border-light: #f1f5f9;
  --overview-shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
  --overview-shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
  --overview-shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
  --overview-shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
  
  /* Gradients */
  --overview-gradient-primary: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
  --overview-gradient-green: linear-gradient(135deg, #10b981 0%, #34d399 100%);
  --overview-gradient-blue: linear-gradient(135deg, #0ea5e9 0%, #60a5fa 100%);
  --overview-gradient-purple: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
  --overview-gradient-orange: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
  --overview-gradient-red: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
  --overview-gradient-cyan: linear-gradient(135deg, #06b6d4 0%, #67e8f9 100%);
}

/* ===== 5. OVERVIEW PAGE STYLES ===== */

/* === MAIN CONTAINERS === */
.enhanced-overview {
  padding: 0;
  margin: 0;
  background: none;
  font-family: 'Prompt', sans-serif;
  position: relative;
  z-index: auto;
}

.overview-content-wrapper {
  padding: 1.5rem;
  margin: 0;
  background: none;
  position: relative;
  z-index: auto;
}

/* === SUMMARY CARDS === */
.summary-cards-new {
  display: grid;
  grid-template-columns: repeat(6, 1fr); /* ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô 6 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏™‡∏°‡∏≠ */
  gap: 1.5rem; /* üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏•‡∏î gap ‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
  margin-bottom: 3rem;
}

.summary-card-new {
  background: var(--overview-bg-glass);
  backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 24px;
  padding: 2.5rem 2rem;
  box-shadow: var(--overview-shadow-lg);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  cursor: pointer;
  z-index: 1;
}

.summary-card-new::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
  transition: height 0.4s ease;
}

.summary-card-new.inbound::before { background: var(--overview-gradient-green); }
.summary-card-new.outbound::before { background: var(--overview-gradient-orange); }
.summary-card-new.total::before { background: var(--overview-gradient-blue); }
.summary-card-new.ontime::before { background: var(--overview-gradient-purple); }
.summary-card-new.users::before { background: var(--overview-gradient-cyan); }
.summary-card-new.tasks::before { background: var(--overview-gradient-red); }

.summary-card-new:hover {
  transform: translateY(-12px) scale(1.02);
  box-shadow: var(--overview-shadow-xl);
}

.summary-card-new:hover::before {
  height: 8px;
}

.summary-card-new::after {
  content: '';
  position: absolute;
  top: 50%;
  right: -50%;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
  transform: translateY(-50%);
  transition: right 0.6s ease;
  pointer-events: none;
}

.summary-card-new:hover::after {
  right: -10%;
}

/* Card Animation Delays */
.summary-card-new:nth-child(1) { animation: slideInUp 0.6s ease-out 0.1s backwards; }
.summary-card-new:nth-child(2) { animation: slideInUp 0.6s ease-out 0.2s backwards; }
.summary-card-new:nth-child(3) { animation: slideInUp 0.6s ease-out 0.3s backwards; }
.summary-card-new:nth-child(4) { animation: slideInUp 0.6s ease-out 0.4s backwards; }
.summary-card-new:nth-child(5) { animation: slideInUp 0.6s ease-out 0.5s backwards; }
.summary-card-new:nth-child(6) { animation: slideInUp 0.6s ease-out 0.6s backwards; }

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.card-header-new {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2rem;
}

.card-icon-new {
  width: 70px;
  height: 70px;
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  color: white;
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
  position: relative;
  overflow: hidden;
}

.card-icon-new::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
}

.card-icon-new.inbound { background: var(--overview-gradient-green); }
.card-icon-new.outbound { background: var(--overview-gradient-orange); }
.card-icon-new.total { background: var(--overview-gradient-blue); }
.card-icon-new.ontime { background: var(--overview-gradient-purple); }
.card-icon-new.users { background: var(--overview-gradient-cyan); }
.card-icon-new.tasks { background: var(--overview-gradient-red); }

.card-trend-new {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  font-weight: 600;
  padding: 0.5rem 1rem;
  border-radius: 12px;
  backdrop-filter: blur(8px);
  transition: all 0.3s ease;
}

.card-trend-new.up {
  background: rgba(16, 185, 129, 0.15);
  color: var(--overview-accent-green);
  border: 1px solid rgba(16, 185, 129, 0.2);
}

.card-trend-new.down {
  background: rgba(239, 68, 68, 0.15);
  color: var(--overview-accent-red);
  border: 1px solid rgba(239, 68, 68, 0.2);
}

.card-trend-new.neutral {
  background: rgba(100, 116, 139, 0.15);
  color: var(--overview-text-muted);
  border: 1px solid rgba(100, 116, 139, 0.2);
}

.card-content-new {
  margin-top: 1.5rem;
}

.card-value-new {
  font-size: 3.5rem;
  font-weight: 900;
  background: linear-gradient(135deg, #10b981, #059669, #047857);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 0.5rem;
  line-height: 1;
  text-shadow: 0 2px 4px rgba(16, 185, 129, 0.1);
  animation: countUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  letter-spacing: -0.02em;
}

.card-label-new {
  font-size: 1rem;
  color: var(--overview-text-muted);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* ===== OVERVIEW GRID LAYOUT ===== */
.overview-grid-new {
  display: grid;
  grid-template-columns: 2fr 1fr;
  grid-template-rows: auto auto auto;
  gap: 2rem;
  margin-bottom: 2rem;
}

.overview-card-new {
  background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 28px;
  padding: 2.5rem;
  box-shadow: 
    0 20px 40px rgba(0, 0, 0, 0.08),
    0 8px 24px rgba(0, 0, 0, 0.05),
    inset 0 1px 0 rgba(255, 255, 255, 0.6);
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  position: relative;
  overflow: hidden;
  z-index: 1;
  transform: translateZ(0);
}

.overview-card-new::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #10b981, #059669, #047857);
  transform: scaleX(0);
  transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  border-radius: 28px 28px 0 0;
}

.overview-card-new::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, 
    rgba(16, 185, 129, 0.1) 0%, 
    rgba(5, 150, 105, 0.05) 50%, 
    rgba(4, 120, 87, 0.02) 100%);
  opacity: 0;
  transition: opacity 0.5s ease;
  border-radius: 28px;
  z-index: -1;
}

.overview-card-new:hover {
  transform: translateY(-12px) scale(1.02);
  box-shadow: 
    0 32px 64px rgba(0, 0, 0, 0.12),
    0 16px 32px rgba(16, 185, 129, 0.15),
    inset 0 2px 0 rgba(255, 255, 255, 0.8);
  border-color: rgba(16, 185, 129, 0.3);
}

.overview-card-new:hover::before {
  transform: scaleX(1);
}

.overview-card-new:hover::after {
  opacity: 1;
}

.overview-card-new.full-width {
  grid-column: span 2;
}

/* ===== CARD HEADERS ===== */
.card-header-overview {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid rgba(226, 232, 240, 0.8);
  position: relative;
}

.card-header-overview::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 60px;
  height: 2px;
  background: var(--overview-gradient-primary);
  border-radius: 1px;
}

.card-title-new {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.card-title-new h3 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--overview-text-primary);
  margin: 0;
  letter-spacing: -0.01em;
   white-space: nowrap; /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥ */
}

.card-title-new i {
  font-size: 1.8rem;
  background: linear-gradient(135deg, #10b981, #059669);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: iconFloat 3s ease-in-out infinite;
  text-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
  background-clip: text;
}

/* ‚ú® Dashboard Card Animations */
@keyframes countUp {
  0% {
    opacity: 0;
    transform: translateY(20px) scale(0.8);
  }
  60% {
    transform: translateY(-5px) scale(1.1);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes iconFloat {
  0%, 100% {
    transform: translateY(0) rotate(0deg);
  }
  25% {
    transform: translateY(-3px) rotate(1deg);
  }
  50% {
    transform: translateY(-6px) rotate(0deg);
  }
  75% {
    transform: translateY(-3px) rotate(-1deg);
  }
}

@keyframes cardShimmer {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
}

@keyframes chartShimmer {
  0% {
    left: -100%;
  }
  50% {
    left: 100%;
  }
  100% {
    left: 100%;
  }
}

@keyframes tableShimmer {
  0% {
    left: -100%;
    opacity: 0;
  }
  50% {
    left: 100%;
    opacity: 1;
  }
  100% {
    left: 100%;
    opacity: 0;
  }
}

/* ===== CONTROL BUTTONS ===== */
.card-controls {
  display: flex;
  gap: 0.75rem;
}

.control-btn {
  padding: 0.75rem 1.5rem;
  border: 1px solid var(--overview-border);
  border-radius: 12px;
  background: var(--overview-bg-card);
  color: var(--overview-text-muted);
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.control-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: var(--overview-gradient-primary);
  transition: left 0.3s ease;
  z-index: -1;
}

.control-btn:hover, .control-btn.active {
  color: white;
  border-color: var(--overview-accent-green);
  transform: translateY(-2px);
  box-shadow: var(--overview-shadow-md);
}

.control-btn:hover::before, .control-btn.active::before {
  left: 0;
}

/* ===== STATUS SYSTEM ===== */
.status-grid-new {
  display: grid;
  gap: 1.5rem;
}

.status-item-new {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.25rem 1.5rem;
  background: rgba(248, 250, 252, 0.5);
  border: 1px solid var(--overview-border-light);
  border-radius: 16px;
  transition: all 0.3s ease;
}

.status-item-new:hover {
  background: rgba(248, 250, 252, 0.8);
  transform: translateX(4px);
  box-shadow: var(--overview-shadow-sm);
}

.status-label-new {
  font-size: 1rem;
  color: var(--overview-text-secondary);
  font-weight: 600;
}

.status-value-new {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-weight: 700;
  color: var(--overview-text-primary);
  font-size: 0.95rem;
}

.status-indicator-new {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  position: relative;
}

.status-indicator-new::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  animation: pulse-glow 2s ease-in-out infinite;
}

.status-indicator-new.success {
  background: var(--overview-accent-green);
}

.status-indicator-new.success::before {
  background: var(--overview-accent-green);
}

.status-indicator-new.warning {
  background: var(--overview-accent-orange);
}

.status-indicator-new.warning::before {
  background: var(--overview-accent-orange);
}

.status-indicator-new.error {
  background: var(--overview-accent-red);
}

.status-indicator-new.error::before {
  background: var(--overview-accent-red);
}

.status-indicator-new.offline {
  background: #94a3b8;
}

.status-indicator-new.offline::before {
  background: #94a3b8;
}

@keyframes pulse-glow {
  0%, 100% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
  50% {
    opacity: 0.3;
    transform: translate(-50%, -50%) scale(1.5);
  }
}

/* ===== ACTIVITY FEED ===== */
.activity-feed-new {
  max-height: 450px;
  overflow-y: auto;
  padding-right: 1rem;
  margin-right: -1rem;
}

.activity-feed-new::-webkit-scrollbar {
  width: 6px;
}

.activity-feed-new::-webkit-scrollbar-track {
  background: var(--overview-border-light);
  border-radius: 3px;
}

.activity-feed-new::-webkit-scrollbar-thumb {
  background: var(--overview-border);
  border-radius: 3px;
}

.activity-feed-new::-webkit-scrollbar-thumb:hover {
  background: var(--overview-text-muted);
}

.activity-item-new {
  display: flex;
  align-items: center;
  gap: 1.25rem;
  padding: 1.25rem 0;
  border-bottom: 1px solid var(--overview-border-light);
  transition: all 0.3s ease;
  border-radius: 12px;
}

.activity-item-new:hover {
  background: rgba(248, 250, 252, 0.6);
  padding-left: 1rem;
  padding-right: 1rem;
  margin-left: -1rem;
  margin-right: -1rem;
  transform: translateX(4px);
}

.activity-item-new:last-child {
  border-bottom: none;
}

.activity-icon-new {
  width: 48px;
  height: 48px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  color: white;
  flex-shrink: 0;
  position: relative;
  overflow: hidden;
}

.activity-icon-new::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
}

.activity-icon-new.inbound { background: var(--overview-gradient-green); }
.activity-icon-new.outbound { background: var(--overview-gradient-orange); }
.activity-icon-new.system { background: var(--overview-gradient-blue); }
.activity-icon-new.user { background: var(--overview-gradient-purple); }

.activity-content-new {
  flex: 1;
  min-width: 0;
}

.activity-text-new {
  font-size: 1rem;
  color: var(--overview-text-primary);
  margin-bottom: 0.25rem;
  font-weight: 500;
  line-height: 1.4;
}

.activity-time-new {
  font-size: 0.85rem;
  color: var(--overview-text-muted);
  font-weight: 500;
}

/* ===== ENVIRONMENTAL CARDS ===== */
.env-grid-new {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.5rem;
}

.env-card-new {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 80%, #bae6fd 100%);
  border: 1px solid rgba(6, 182, 212, 0.2);
  border-radius: 20px;
  padding: 2rem 1.5rem;
  text-align: center;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.env-card-new::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(6, 182, 212, 0.1) 0%, transparent 70%);
  transform: rotate(45deg);
  transition: transform 0.6s ease;
}

.env-card-new:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 20px 40px rgba(6, 182, 212, 0.15);
  border-color: rgba(6, 182, 212, 0.3);
}

.env-card-new:hover::before {
  transform: rotate(225deg);
}

.env-value-new {
  font-size: 2.5rem;
  font-weight: 800;
  color: var(--overview-text-primary);
  margin-bottom: 0.75rem;
  line-height: 1;
  background: linear-gradient(135deg, var(--overview-accent-cyan) 0%, var(--overview-accent-blue) 100%);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  position: relative;
  z-index: 1;
}

.env-label-new {
  font-size: 1rem;
  color: var(--overview-text-secondary);
  margin-bottom: 0.5rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  position: relative;
  z-index: 1;
}

.env-range-new {
  font-size: 0.9rem;
  color: var(--overview-accent-cyan);
  font-weight: 700;
  background: rgba(6, 182, 212, 0.1);
  padding: 0.25rem 0.75rem;
  border-radius: 8px;
  display: inline-block;
  position: relative;
  z-index: 1;
}

/* ===== CHART CONTAINERS ===== */
#pieChartContainer-new, .chart-container-new {
  position: relative;
  /* height: 420px; */ /* ‚ùå ‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å */
  min-height: 400px;  /* ‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÅ‡∏ó‡∏ô */
  padding: 1rem;
  background: rgba(248, 250, 252, 0.3);
  border-radius: 16px;
  border: 1px solid var(--overview-border-light);
  display: flex;
  align-items: center;
  justify-content: center;
}

#pieChartContainer-new {
  height: 280px;
}

.chart-container-new.hourly {
  height: 220px;
}

/* ===== LOADING & ERROR STATES ===== */
.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: var(--overview-text-muted);
  text-align: center;
}

.loading-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  background: var(--overview-gradient-primary);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: spin-loading 2s linear infinite;
}

.loading-state p {
  font-size: 1.1rem;
  font-weight: 500;
  margin: 0;
}

@keyframes spin-loading {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.error-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: var(--overview-text-muted);
  text-align: center;
  padding: 2rem;
}

.error-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  color: var(--overview-accent-red);
  animation: shake 0.5s ease-in-out;
}

.error-state p {
  font-size: 1.1rem;
  font-weight: 500;
  margin: 0 0 1rem 0;
}

.error-state button {
  padding: 0.75rem 1.5rem;
  background: var(--overview-gradient-primary);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.error-state button:hover {
  transform: translateY(-2px);
  box-shadow: var(--overview-shadow-md);
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

/* ===== SPECIAL EFFECTS ===== */
.card-glow {
  position: relative;
}

.card-glow::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: var(--overview-gradient-primary);
  border-radius: 26px;
  z-index: -1;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.card-glow:hover::before {
  opacity: 0.7;
}

/* ===== TOOLTIP STYLES ===== */
.tooltip {
  position: relative;
  cursor: help;
}

.tooltip::before {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--overview-text-primary);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 500;
  white-space: nowrap;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  z-index: 1000;
}

.tooltip::after {
  content: '';
  position: absolute;
  bottom: 115%;
  left: 50%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-top-color: var(--overview-text-primary);
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  z-index: 1000;
}

.tooltip:hover::before,
.tooltip:hover::after {
  opacity: 1;
  visibility: visible;
}

/* ===== BADGE STYLES ===== */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap; /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ */
}

.status-badge.success {
  background: rgba(16, 185, 129, 0.15);
  color: var(--overview-accent-green);
  border: 1px solid rgba(16, 185, 129, 0.2);
}

.status-badge.warning {
  background: rgba(245, 158, 11, 0.15);
  color: var(--overview-accent-orange);
  border: 1px solid rgba(245, 158, 11, 0.2);
}

.status-badge.error {
  background: rgba(239, 68, 68, 0.15);
  color: var(--overview-accent-red);
  border: 1px solid rgba(239, 68, 68, 0.2);
}

.status-badge.info {
  background: rgba(14, 165, 233, 0.15);
  color: var(--overview-accent-blue);
  border: 1px solid rgba(14, 165, 233, 0.2);
}

/* ===== FLOATING ACTION BUTTON ===== */
.fab {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  width: 64px;
  height: 64px;
  background: var(--overview-gradient-primary);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  box-shadow: var(--overview-shadow-lg);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 100;
}

.fab:hover {
  transform: scale(1.1) translateY(-4px);
  box-shadow: var(--overview-shadow-xl);
}

.fab:active {
  transform: scale(0.95);
}

/* ===== NOTIFICATION STYLES (Bottom-Right) ===== */
.notification {
  position: fixed;
  bottom: 2rem;   /* ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å top ‡πÄ‡∏õ‡πá‡∏ô bottom */
  right: 2rem;    /* ‚úÖ ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ */
  background: var(--overview-bg-glass);
  backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 16px;
  padding: 1.5rem;
  box-shadow: var(--overview-shadow-xl);
  z-index: 9999;
  max-width: 400px;
  
  /* ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏™‡πÑ‡∏•‡∏î‡πå‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
  transform: translateY(100%);
  opacity: 0;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.notification.show {
  /* ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏™‡πÑ‡∏•‡∏î‡πå‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á 0 */
  transform: translateY(0);
  opacity: 1;
}

.notification.success {
  border-left: 4px solid var(--overview-accent-green);
}

.notification.warning {
  border-left: 4px solid var(--overview-accent-orange);
}

.notification.error {
  border-left: 4px solid var(--overview-accent-red);
}

.notification.info {
  border-left: 4px solid var(--overview-accent-blue);
}

/* ===== ANIMATION UTILITIES ===== */
.fade-in {
  animation: fadeIn 0.6s ease-out;
}

.slide-in-left {
  animation: slideInLeft 0.6s ease-out;
}

.slide-in-right {
  animation: slideInRight 0.6s ease-out;
}

.scale-in {
  animation: scaleIn 0.4s ease-out;
}

.bounce-in {
  animation: bounceIn 0.6s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-50px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(50px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes bounceIn {
  0% {
    opacity: 0;
    transform: scale(0.3);
  }
  50% {
    opacity: 1;
    transform: scale(1.05);
  }
  70% {
    transform: scale(0.9);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 1400px) {
  .overview-grid-new {
    grid-template-columns: 1fr;
  }
  
  .overview-card-new.full-width {
    grid-column: span 1;
  }
}

@media (max-width: 1024px) {
  .overview-content-wrapper {
    padding: 1rem;
  }
  
  .summary-cards-new {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }
}

@media (max-width: 768px) {
  .overview-content-wrapper {
    padding: 0.75rem;
  }
  
  .summary-cards-new {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  
  .summary-card-new {
    padding: 1.5rem;
  }
  
  .overview-card-new {
    padding: 1.5rem;
  }
  
  .env-grid-new {
    grid-template-columns: 1fr;
  }
  
  .card-header-overview {
    flex-direction: column;
    gap: 1rem;
    align-items: flex-start;
  }
}

@media (max-width: 480px) {
  .overview-content-wrapper {
    padding: 0.5rem;
  }
  
  .summary-card-new {
    padding: 1.25rem;
    border-radius: 16px;
  }
  
  .card-value-new {
    font-size: 2.25rem;
  }
  
  .overview-card-new {
    padding: 1rem;
    border-radius: 16px;
  }
  
  .fab {
    width: 56px;
    height: 56px;
    bottom: 1rem;
    right: 1rem;
  }
}

/* ===== UTILITY CLASSES ===== */
.text-gradient {
  background: var(--overview-gradient-primary);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.bg-gradient {
  background: var(--overview-gradient-primary);
}

.shadow-soft {
  box-shadow: var(--overview-shadow-md);
}

.shadow-strong {
  box-shadow: var(--overview-shadow-lg);
}

.border-gradient {
  border: 2px solid transparent;
  background: linear-gradient(white, white), var(--overview-gradient-primary);
  background-clip: padding-box, border-box;
}

.backdrop-blur {
  backdrop-filter: blur(16px);
}

.glass-effect {
  background: var(--overview-bg-glass);
  backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

/* ===== ACCESSIBILITY ===== */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* ===== HIGH CONTRAST MODE ===== */
@media (prefers-contrast: high) {
  :root {
    --overview-border: #000000;
    --overview-border-light: #333333;
    --overview-text-muted: #000000;
  }
  
  .summary-card-new,
  .overview-card-new {
    border: 2px solid #000000 !important;
  }
}

/* ===== FOCUS STYLES FOR ACCESSIBILITY ===== */
.control-btn:focus,
.fab:focus,
button:focus {
  outline: 2px solid var(--overview-accent-blue);
  outline-offset: 2px;
}

.control-btn:focus-visible,
.fab:focus-visible,
button:focus-visible {
  outline: 2px solid var(--overview-accent-blue);
  outline-offset: 2px;
}

/* ===== PERFORMANCE OPTIMIZATIONS ===== */
.summary-card-new,
.overview-card-new,
.activity-item-new {
  will-change: transform;
}

.summary-card-new:hover,
.overview-card-new:hover {
  will-change: auto;
}

/* ===== ‡πÄ‡∏ö‡∏•‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ popup ‡πÄ‡∏õ‡∏¥‡∏î ===== */
/* ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ popup ‡πÉ‡∏î‡πÜ ‡πÅ‡∏™‡∏î‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏•‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ */
body:has(.modal-backdrop.show) .main,
body:has(.modal-backdrop.show) .sidebar,
body:has(.popup-overlay[style*="display: block"]) .main,
body:has(.popup-overlay[style*="display: block"]) .sidebar,
body:has(.popup-overlay[style*="display: flex"]) .main,
body:has(.popup-overlay[style*="display: flex"]) .sidebar,
body:has(.premium-modal-overlay[style*="display: flex"]) .main,
body:has(.premium-modal-overlay[style*="display: flex"]) .sidebar,
body:has(.timer-modal-backdrop.show) .main,
body:has(.timer-modal-backdrop.show) .sidebar,
body:has(.confirm-backdrop[style*="display: flex"]) .main,
body:has(.confirm-backdrop[style*="display: flex"]) .sidebar,
body:has(#batchScheduleModal.show) .main,
body:has(#batchScheduleModal.show) .sidebar,
body:has(.tray-popup-backdrop[style*="display: flex"]) .main,
body:has(.tray-popup-backdrop[style*="display: flex"]) .sidebar,
body:has(.session-popup-backdrop.show) .main,
body:has(.session-popup-backdrop.show) .sidebar {
  filter: blur(6px) !important;
  transition: filter 0.3s ease;
  pointer-events: none !important;
}

/* ===== SESSION TIMEOUT POPUP ===== */
.session-popup-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(25px) saturate(180%);
  -webkit-backdrop-filter: blur(25px) saturate(180%);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  opacity: 0;
  transition: all 0.3s ease;
}

.session-popup-backdrop.show {
  opacity: 1;
}

.session-popup {
  background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 24px;
  padding: 40px 35px;
  max-width: 450px;
  width: 90%;
  box-shadow: 
    0 25px 50px rgba(0, 0, 0, 0.25),
    0 0 0 1px rgba(255, 255, 255, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transform: scale(0.8);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.session-popup-backdrop.show .session-popup {
  transform: scale(1);
}

.session-popup::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #ef4444, #f97316, #eab308, #22c55e, #3b82f6, #8b5cf6);
  background-size: 200% 100%;
  animation: rainbowShift 3s linear infinite;
}

@keyframes rainbowShift {
  0% { background-position: 0% 0%; }
  100% { background-position: 200% 0%; }
}

.session-popup-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 24px;
  background: linear-gradient(135deg, #ef4444, #f97316);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.5rem;
  color: white;
  box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
  animation: pulse 2s ease-in-out infinite;
}

.session-popup-icon.warning {
  background: linear-gradient(135deg, #f59e0b, #eab308);
  box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.session-popup-title {
  font-size: 1.75rem;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 16px;
  background: linear-gradient(135deg, #1e293b, #475569);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.session-popup-message {
  font-size: 1.1rem;
  color: #64748b;
  margin-bottom: 32px;
  line-height: 1.6;
}

.session-popup-buttons {
  display: flex;
  gap: 16px;
  justify-content: center;
}

.session-popup-btn {
  padding: 14px 28px;
  border: none;
  border-radius: 16px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  position: relative;
  overflow: hidden;
}

.session-popup-btn:hover {
  transform: translateY(-2px);
}

.session-popup-btn.primary {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
  box-shadow: 0 8px 16px rgba(34, 197, 94, 0.3);
}

.session-popup-btn.primary:hover {
  box-shadow: 0 12px 24px rgba(34, 197, 94, 0.4);
}

.session-popup-btn.secondary {
  background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
  color: #475569;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}

.session-popup-btn.secondary:hover {
  background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
}

.session-popup-btn.danger {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3);
}

.session-popup-btn.danger:hover {
  box-shadow: 0 12px 24px rgba(239, 68, 68, 0.4);
}

/* ===== FINAL TOUCHES ===== */
.enhanced-overview * {
  box-sizing: border-box;
}

.enhanced-overview ::-moz-selection {
  background: rgba(16, 185, 129, 0.2);
}

.enhanced-overview ::selection {
  background: rgba(16, 185, 129, 0.2);
}

/* ‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á overview */
.overview-header-enhanced {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding: 1.5rem 2rem;
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.95) 0%, 
        rgba(248, 250, 252, 0.9) 100%);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.08),
        0 1px 0 rgba(255, 255, 255, 0.5) inset;
    border: 1px solid rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
}

.overview-header-enhanced::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, 
        var(--overview-accent-green) 0%,
        var(--overview-accent-blue) 50%,
        var(--overview-accent-green) 100%);
    background-size: 200% 100%;
    animation: headerGradientFlow 3s ease-in-out infinite;
}

@keyframes headerGradientFlow {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 200% center; }
}

@keyframes iconShine {
    0%, 100% { transform: translateX(-200%) translateY(-200%) rotate(45deg); }
    50% { transform: translateX(200%) translateY(200%) rotate(45deg); }
}

/* ‚ú® PREMIUM LOGS STYLES */
.premium-logs-container {
    padding: 2rem;
    max-width: 1600px;
    margin: 0 auto;
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f8fafc 100%);
    min-height: 100vh;
    position: relative;
    overflow: hidden;
}

.premium-logs-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 200px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    z-index: -1;
    opacity: 0.1;
}

/* ‚ú® Enhanced Header */
.logs-header-enhanced {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 24px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
}

.logs-header-enhanced::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.icon-wrapper-premium {
    position: relative;
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 25px rgba(102,126,234,0.3);
}

.icon-wrapper-premium i {
    font-size: 2rem;
    color: white;
}

.icon-glow {
    position: absolute;
    top: -5px;
    left: -5px;
    right: -5px;
    bottom: -5px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 25px;
    z-index: -1;
    filter: blur(15px);
    opacity: 0.6;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.6; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.05); }
}

.header-text h1.gradient-text {
    font-size: 2.5rem;
    font-weight: 800;
    margin: 0 0 0.5rem 0;
    background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
    -webkit-background-clip: text;
    background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.02em;
}

.subtitle {
    font-size: 1rem;
    color: #475569;
    margin: 0 0 1rem 0;
    font-weight: 500;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: #10b981;
    font-weight: 600;
}

.status-dot {
    width: 8px;
    height: 8px;
    background: #10b981;
    border-radius: 50%;
    animation: blink 2s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

.header-actions-enhanced {
    display: flex;
    gap: 1rem;
}

.premium-btn {
    position: relative;
    padding: 1rem 1.5rem;
    border: none;
    border-radius: 16px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
    overflow: hidden;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.export-btn {
    background: linear-gradient(135deg, #10b981, #059669, #047857);
    color: white;
    position: relative;
    overflow: hidden;
}

.export-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.6s ease;
}

.export-btn:hover::before {
    left: 100%;
}

.refresh-btn {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8, #1e40af);
    color: white;
    position: relative;
    overflow: hidden;
}

.refresh-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.6s ease;
}

.refresh-btn:hover::before {
    left: 100%;
}

.premium-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.btn-shine {
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s;
}

.premium-btn:hover .btn-shine {
    left: 100%;
}

/* ‚ú® Header Stats */
.header-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.premium-logs-container .stat-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 24px;
    padding: 2.5rem 2rem;
    box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    cursor: pointer;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.premium-logs-container .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    transition: height 0.4s ease;
}

.premium-logs-container .stat-card::after {
    content: '';
    position: absolute;
    top: 50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    transform: translateY(-50%);
    transition: right 0.6s ease;
    pointer-events: none;
}

.premium-logs-container .stat-card:hover {
    transform: translateY(-12px) scale(1.02);
    box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1);
}

.premium-logs-container .stat-card:hover::before {
    height: 8px;
}

.premium-logs-container .stat-card:hover::after {
    right: -10%;
}

/* Users Card - Cyan */
.premium-logs-container .stat-card:nth-child(1)::before { 
    background: linear-gradient(135deg, #06b6d4 0%, #67e8f9 100%); 
}

.premium-logs-container .stat-card:nth-child(1) {
    animation: slideInUp 0.6s ease-out 0.1s backwards;
}

/* Total Logs Card - Blue */
.premium-logs-container .stat-card:nth-child(2)::before { 
    background: linear-gradient(135deg, #0ea5e9 0%, #60a5fa 100%); 
}

.premium-logs-container .stat-card:nth-child(2) {
    animation: slideInUp 0.6s ease-out 0.2s backwards;
}

/* Today Card - Orange */
.premium-logs-container .stat-card:nth-child(3)::before { 
    background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); 
}

.premium-logs-container .stat-card:nth-child(3) {
    animation: slideInUp 0.6s ease-out 0.3s backwards;
}

.premium-logs-container .stat-card i {
    width: 56px;
    height: 56px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    transition: all 0.3s ease;
}

/* Icon backgrounds */
.premium-logs-container .stat-card:nth-child(1) i { 
    background: linear-gradient(135deg, #06b6d4 0%, #67e8f9 100%); 
}

.premium-logs-container .stat-card:nth-child(2) i { 
    background: linear-gradient(135deg, #0ea5e9 0%, #60a5fa 100%); 
}

.premium-logs-container .stat-card:nth-child(3) i { 
    background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); 
}

.stat-number {
    font-size: 3rem;
    font-weight: 800;
    color: #0f172a;
    margin-bottom: 0.5rem;
    line-height: 1;
    letter-spacing: -0.02em;
}

.stat-label {
    font-size: 0.875rem;
    color: #64748b;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* ‚ú® Advanced Filters Premium */
.advanced-filters {
    background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 24px;
    margin-bottom: 2rem;
    box-shadow: 
        0 20px 40px rgba(0,0,0,0.08),
        0 8px 16px rgba(0,0,0,0.04),
        inset 0 1px 0 rgba(255,255,255,0.8);
    overflow: hidden;
    position: relative;
}

.advanced-filters::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.filters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2rem 2.5rem;
    background: linear-gradient(135deg, rgba(248,250,252,0.8), rgba(255,255,255,0.9));
    border-bottom: 1px solid rgba(226,232,240,0.3);
    position: relative;
}

.filters-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 2.5rem;
    right: 2.5rem;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(102,126,234,0.3), transparent);
}

.filters-header h3 {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 800;
    background: linear-gradient(135deg, #1e293b, #475569, #667eea);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.filters-header h3 i {
    font-size: 1.1rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.filter-toggle {
    background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));
    border: 1px solid rgba(102,126,234,0.2);
    padding: 0.75rem;
    cursor: pointer;
    border-radius: 12px;
    transition: all 0.3s ease;
    backdrop-filter: blur(8px);
}

.filter-toggle:hover {
    background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2));
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102,126,234,0.2);
}

.filter-toggle i {
    color: #667eea;
    font-size: 1.1rem;
    transition: transform 0.3s ease;
}

.filters-content {
    padding: 2.5rem;
    max-height: 600px;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    background: linear-gradient(135deg, rgba(248,250,252,0.3), rgba(255,255,255,0.5));
}

.filters-content.collapsed {
    max-height: 0;
    padding: 0 2.5rem;
}

.filter-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    position: relative;
}

.filter-group label {
    font-weight: 700;
    background: linear-gradient(135deg, #374151, #4b5563);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.search-input-wrapper {
    position: relative;
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
    border-radius: 16px;
    padding: 0.25rem;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(102,126,234,0.1);
    transition: all 0.3s ease;
}

.search-input-wrapper:focus-within {
    border-color: rgba(102,126,234,0.3);
    box-shadow: 0 0 0 4px rgba(102,126,234,0.1);
    transform: translateY(-2px);
}

.search-input-wrapper i {
    position: absolute;
    left: 1.25rem;
    top: 50%;
    transform: translateY(-50%);
    color: #667eea;
    font-size: 1.1rem;
    z-index: 2;
}

.search-input-wrapper input {
    width: 100%;
    padding: 1.25rem 1.25rem 1.25rem 3.5rem;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 500;
    background: transparent;
    color: #1e293b;
    transition: all 0.3s ease;
}

.search-input-wrapper input::placeholder {
    color: #94a3b8;
    font-weight: 400;
}

.search-input-wrapper input:focus {
    outline: none;
}

.modern-select {
    padding: 1.25rem 1.5rem;
    border: 1px solid rgba(102,126,234,0.1);
    border-radius: 16px;
    font-size: 1rem;
    font-weight: 500;
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
    backdrop-filter: blur(8px);
    color: #1e293b;
    cursor: pointer;
    transition: all 0.3s ease;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23667eea' d='M1 1l5 5 5-5'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 3rem;
}

.modern-select:focus {
    outline: none;
    border-color: rgba(102,126,234,0.3);
    box-shadow: 0 0 0 4px rgba(102,126,234,0.1);
    transform: translateY(-2px);
}

.modern-select:hover {
    border-color: rgba(102,126,234,0.2);
    transform: translateY(-1px);
}

/* ‚ú® Timeline Enhanced */
.logs-timeline-enhanced {
    margin-bottom: 2rem;
}

.timeline-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f4f6;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.timeline-loading p {
    color: #64748b;
    font-size: 1rem;
    margin: 0;
}

.log-card-premium {
    background: white;
    border-radius: 24px;
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow: 
        0 20px 40px rgba(0,0,0,0.08),
        0 8px 16px rgba(0,0,0,0.04),
        inset 0 1px 0 rgba(255,255,255,0.8);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    z-index: 1;
    border-left: 6px solid transparent;
}

.log-card-premium::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    transform: scaleX(0);
    transition: transform 0.4s ease;
}

.log-card-premium::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.8s ease;
}

.log-card-premium:hover {
    transform: translateY(-8px);
    box-shadow: 
        0 25px 50px rgba(0,0,0,0.15),
        0 12px 24px rgba(0,0,0,0.08),
        inset 0 1px 0 rgba(255,255,255,0.9);
}

.log-card-premium:hover::before {
    transform: scaleX(1);
}

.log-card-premium:hover::after {
    left: 100%;
}

/* ‚ú® ‡∏™‡∏µ‡∏™‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö log cards ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó */
.log-card-login {
    border-left-color: #10b981;
    background: linear-gradient(135deg, rgba(16,185,129,0.02), rgba(5,150,105,0.02));
}

.log-card-login:hover {
    background: linear-gradient(135deg, rgba(16,185,129,0.05), rgba(5,150,105,0.05));
    box-shadow: 
        0 25px 50px rgba(16,185,129,0.15),
        0 12px 24px rgba(16,185,129,0.08);
}

.log-card-inbound {
    border-left-color: #3b82f6;
    background: linear-gradient(135deg, rgba(59,130,246,0.02), rgba(29,78,216,0.02));
}

.log-card-inbound:hover {
    background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(29,78,216,0.05));
    box-shadow: 
        0 25px 50px rgba(59,130,246,0.15),
        0 12px 24px rgba(59,130,246,0.08);
}

.log-card-outbound {
    border-left-color: #f59e0b;
    background: linear-gradient(135deg, rgba(245,158,11,0.02), rgba(217,119,6,0.02));
}

.log-card-outbound:hover {
    background: linear-gradient(135deg, rgba(245,158,11,0.05), rgba(217,119,6,0.05));
    box-shadow: 
        0 25px 50px rgba(245,158,11,0.15),
        0 12px 24px rgba(245,158,11,0.08);
}

.log-card-system {
    border-left-color: #8b5cf6;
    background: linear-gradient(135deg, rgba(139,92,246,0.02), rgba(124,58,237,0.02));
}

.log-card-system:hover {
    background: linear-gradient(135deg, rgba(139,92,246,0.05), rgba(124,58,237,0.05));
    box-shadow: 
        0 25px 50px rgba(139,92,246,0.15),
        0 12px 24px rgba(139,92,246,0.08);
}

.log-card-user {
    border-left-color: #ef4444;
    background: linear-gradient(135deg, rgba(239,68,68,0.02), rgba(220,38,38,0.02));
}

.log-card-user:hover {
    background: linear-gradient(135deg, rgba(239,68,68,0.05), rgba(220,38,38,0.05));
    box-shadow: 
        0 25px 50px rgba(239,68,68,0.15),
        0 12px 24px rgba(239,68,68,0.08);
}

.log-header-premium {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.log-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.log-icon {
    width: 64px;
    height: 64px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    position: relative;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
}

.log-icon::before {
    content: '';
    position: absolute;
    top: -4px;
    left: -4px;
    right: -4px;
    bottom: -4px;
    border-radius: 24px;
    z-index: -1;
    filter: blur(12px);
    opacity: 0.6;
    transition: opacity 0.3s ease;
}

.log-card-premium:hover .log-icon::before {
    opacity: 0.8;
}

.log-icon.login { 
    background: linear-gradient(135deg, #10b981, #059669);
}
.log-icon.login::before {
    background: linear-gradient(135deg, #10b981, #059669);
}

.log-icon.inbound { 
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
}
.log-icon.inbound::before {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
}

.log-icon.outbound { 
    background: linear-gradient(135deg, #f59e0b, #d97706);
}
.log-icon.outbound::before {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.log-icon.system { 
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}
.log-icon.system::before {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.log-icon.user { 
    background: linear-gradient(135deg, #ef4444, #dc2626);
}
.log-icon.user::before {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.log-details h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1.2rem;
    font-weight: 700;
    color: #1e293b;
    background: linear-gradient(135deg, #1e293b, #475569);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.log-details p {
    margin: 0;
    color: #64748b;
    font-size: 0.95rem;
    font-weight: 500;
    line-height: 1.4;
}

.log-timestamp {
    font-size: 0.9rem;
    color: #64748b;
    font-weight: 600;
    padding: 0.75rem 1.25rem;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    transition: all 0.3s ease;
}

/* ‡∏™‡∏µ‡∏™‡∏±‡∏ô timestamp ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó log */
.log-card-login .log-timestamp {
    background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.1));
    border-color: rgba(16,185,129,0.2);
    color: #047857;
}

.log-card-inbound .log-timestamp {
    background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(29,78,216,0.1));
    border-color: rgba(59,130,246,0.2);
    color: #1d4ed8;
}

.log-card-outbound .log-timestamp {
    background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(217,119,6,0.1));
    border-color: rgba(245,158,11,0.2);
    color: #d97706;
}

.log-card-system .log-timestamp {
    background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(124,58,237,0.1));
    border-color: rgba(139,92,246,0.2);
    color: #7c3aed;
}

.log-card-user .log-timestamp {
    background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(220,38,38,0.1));
    border-color: rgba(239,68,68,0.2);
    color: #dc2626;
}

/* ‚ú® Premium Pagination */
.premium-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
}

.pagination-info {
    font-size: 0.9rem;
    color: #64748b;
    margin-right: 1rem;
}

.pagination-buttons {
    display: flex;
    gap: 0.5rem;
}

.page-btn-premium {
    min-width: 48px;
    height: 48px;
    border: 2px solid #e5e7eb;
    background: white;
    border-radius: 12px;
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.page-btn-premium:hover:not(:disabled) {
    border-color: #667eea;
    color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102,126,234,0.2);
}

.page-btn-premium.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-color: #667eea;
    color: white;
    box-shadow: 0 4px 15px rgba(102,126,234,0.3);
}

.page-btn-premium:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* ‚ú® Premium Modal */
.premium-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
}

.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(8px);
}

.modal-content-premium {
    position: relative;
    background: white;
    border-radius: 24px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0,0,0,0.25);
    animation: slideUp 0.3s ease;
}

.modal-header-premium {
    padding: 2rem;
    background: linear-gradient(135deg, #f8fafc, #ffffff);
    border-bottom: 1px solid rgba(226,232,240,0.5);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.modal-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
}

.modal-header-premium h3 {
    margin: 0 0 0.25rem 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
}

.modal-header-premium p {
    margin: 0;
    color: #64748b;
    font-size: 0.9rem;
}

.close-btn-premium {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 40px;
    height: 40px;
    border: none;
    background: rgba(156,163,175,0.1);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-btn-premium:hover {
    background: rgba(239,68,68,0.1);
    color: #ef4444;
}

.modal-body-premium {
    padding: 2rem;
    max-height: 60vh;
    overflow-y: auto;
}

.log-detail-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 12px;
    border-left: 4px solid #667eea;
}

.detail-row label {
    font-weight: 600;
    color: #374151;
    font-size: 0.95rem;
}

.detail-row span {
    color: #1e293b;
    font-weight: 500;
}

/* ‚ú® Responsive Design */
@media (max-width: 768px) {
    .premium-logs-container {
        padding: 1rem;
    }
    
    .header-content {
        flex-direction: column;
        gap: 1rem;
    }
    
    .header-actions-enhanced {
        width: 100%;
        justify-content: stretch;
    }
    
    .premium-btn {
        flex: 1;
        justify-content: center;
    }
    
    .filter-row {
        grid-template-columns: 1fr;
    }
    
    .header-stats {
        grid-template-columns: 1fr;
    }
    
    .modal-content-premium {
        width: 95%;
        margin: 1rem;
    }
}

.logs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #ffffff, #f8fafc);
    padding: 1.5rem;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255,255,255,0.2);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.icon-wrapper {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    box-shadow: 0 8px 25px rgba(102,126,234,0.3);
}

.logs-header h1 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    background: linear-gradient(135deg, #1e293b, #475569);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.logs-header p {
    margin: 0;
    color: #64748b;
    font-size: 0.9rem;
}

.header-actions {
    display: flex;
    gap: 0.75rem;
}

.modern-btn {
    padding: 0.75rem 1.25rem;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.modern-btn.export {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    box-shadow: 0 4px 15px rgba(16,185,129,0.3);
}

.modern-btn.refresh {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
    box-shadow: 0 4px 15px rgba(59,130,246,0.3);
}

.modern-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.logs-filters {
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 1.5rem;
}

.filter-group {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.search-box {
    position: relative;
    flex: 1;
    min-width: 250px;
}

.search-box i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
}

.search-box input {
    width: 100%;
    padding: 0.75rem 0.75rem 0.75rem 2.5rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.search-box input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
}

.filter-select {
    padding: 0.75rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    font-size: 0.9rem;
    min-width: 180px;
}

.logs-timeline {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.log-item {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border-left: 4px solid #e5e7eb;
    transition: all 0.3s ease;
    cursor: pointer;
}

.log-item:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
}

.log-item.login { border-left-color: #3b82f6; }
.log-item.tray { border-left-color: #10b981; }
.log-item.lift { border-left-color: #f59e0b; }
.log-item.agv { border-left-color: #8b5cf6; }
.log-item.water { border-left-color: #06b6d4; }
.log-item.light { border-left-color: #f97316; }

.log-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.log-main {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
}

.log-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    color: white;
}

.log-info {
    flex: 1;
}

.log-info h4 {
    margin: 0 0 0.25rem 0;
    font-size: 0.95rem;
    font-weight: 600;
    color: #1f2937;
}

.log-info p {
    margin: 0;
    font-size: 0.85rem;
    color: #6b7280;
}

.log-meta {
    text-align: right;
    font-size: 0.8rem;
    color: #9ca3af;
}

.log-time {
    font-weight: 600;
    color: #4b5563;
}
/* ========================================================== */
/* === ‚ú® [‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢] PREMIUM PAGINATION STYLES v5.0 ‚ú® === */
/* ========================================================== */

/* --- 1. ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏£‡∏≠‡∏ö Pagination ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --- */
.logs-pagination {
    display: flex !important;
    flex-direction: row !important;
    justify-content: space-between !important;
    align-items: center !important;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin-top: 2rem;
    padding: 1.25rem 2rem;
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    border: 1px solid #e2e8f0;
}

/* --- 2. ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ "‡πÅ‡∏™‡∏î‡∏á 1-15..." --- */
.pagination-summary {
    font-weight: 600;
    color: #4b5563;
    font-size: 0.95rem;
    white-space: nowrap;
}

/* --- 3. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î --- */
.pagination-buttons {
    display: flex !important;
    flex-direction: row !important;
    align-items: center;
    gap: 0.75rem;
}

/* --- 4. ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è --- */
.logs-pagination .page-btn {
    width: auto !important; /* üëà ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 100% */
    min-width: 44px;
    height: 44px;
    padding: 0.5rem 1rem;
    margin-top: 0 !important; /* üëà ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å margin-top ‡∏à‡∏≤‡∏Å style ‡πÄ‡∏î‡∏¥‡∏° */
    border: 1px solid #d1d5db;
    background: white;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    font-size: 0.95rem;
    font-weight: 600;
    color: #374151;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* --- 5. ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ --- */
.logs-pagination .page-btn:hover:not(:disabled) {
    border-color: #a5b4fc;
    background-color: #f0f2ff;
    color: #4338ca;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.1);
}

/* --- 6. ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Active) --- */
.logs-pagination .page-btn.active {
    background: #4f46e5;
    color: white;
    border-color: #4f46e5;
    box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
}

/* --- 7. ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô --- */
.logs-pagination .page-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background-color: #f3f4f6;
}



/* ‚ú® BEAUTIFUL MODAL STYLES */
.log-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(30,41,59,0.8));
    backdrop-filter: blur(10px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: modalFadeIn 0.3s ease-out;
}

@keyframes modalFadeIn {
    from { opacity: 0; backdrop-filter: blur(0px); }
    to { opacity: 1; backdrop-filter: blur(10px); }
}

@keyframes modalSlideIn {
    from { 
        opacity: 0; 
        transform: translate(-50%, -50%) scale(0.9) translateY(20px); 
    }
    to { 
        opacity: 1; 
        transform: translate(-50%, -50%) scale(1) translateY(0px); 
    }
}

.modal-content {
    background: linear-gradient(145deg, #ffffff, #f8fafc);
    border-radius: 24px;
    width: 95%;
    max-width: 700px;
    max-height: 85vh;
    overflow: hidden;
    box-shadow: 
        0 32px 64px rgba(0,0,0,0.15),
        0 16px 32px rgba(0,0,0,0.1),
        inset 0 1px 0 rgba(255,255,255,0.8);
    border: 1px solid rgba(255,255,255,0.2);
    position: relative;
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 25%, #06b6d4 50%, #10b981 75%, #f59e0b 100%);
    background-size: 300% 100%;
    animation: headerGradientFlow 3s ease-in-out infinite;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2rem 2.5rem 1.5rem 2.5rem;
    background: linear-gradient(135deg, #f8fafc, #ffffff);
    position: relative;
}

.modal-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 2rem;
    right: 2rem;
    height: 1px;
    background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
}

.modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #1e293b, #475569);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.modal-header h3 i {
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 1.25rem;
}

.close-btn {
    background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
    border: 1px solid #cbd5e1;
    width: 44px;
    height: 44px;
    border-radius: 12px;
    cursor: pointer;
    color: #64748b;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.close-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s ease;
}

.close-btn:hover::before {
    left: 100%;
}

.close-btn:hover {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    border-color: #ef4444;
    transform: scale(1.05);
    box-shadow: 0 8px 25px rgba(239,68,68,0.3);
}

.modal-body {
    padding: 1.5rem 2.5rem 2.5rem 2.5rem;
    max-height: 65vh;
    overflow-y: auto;
    background: linear-gradient(145deg, #ffffff, #f8fafc);
}

.modal-body::-webkit-scrollbar {
    width: 8px;
}

.modal-body::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #cbd5e1, #94a3b8);
    border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #94a3b8, #64748b);
}

.header-icon-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, 
        var(--overview-accent-green) 0%, 
        var(--overview-accent-blue) 100%);
    border-radius: 18px;
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
}

.header-icon {
    font-size: 1.8rem;
    color: white;
    z-index: 2;
    position: relative;
}

.icon-pulse {
    display: none;
}

@keyframes iconPulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; }
    50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.1; }
}

.enhanced-title {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    margin: 0;
    font-weight: 700;
}

.title-gradient {
    font-size: 2.2rem;
    font-weight: 800;
    background: linear-gradient(135deg, 
        var(--overview-primary) 0%,
        var(--overview-accent-green) 50%,
        var(--overview-accent-blue) 100%);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    background-clip: text;
    background-clip: text;
  background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: titleGradientShift 3s ease-in-out infinite;
    line-height: 1.1;
}

.title-subtitle {
    font-size: 1.4rem;
    font-weight: 500;
    color: var(--overview-text-muted);
    opacity: 0.8;
}

@keyframes titleGradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.title-decoration {
    width: 50px;
    height: 3px;
    background: linear-gradient(90deg, 
        var(--overview-accent-green) 0%,
        var(--overview-accent-blue) 100%);
    border-radius: 2px;
    margin-left: auto;
    animation: decorationGlow 2s ease-in-out infinite;
}

@keyframes decorationGlow {
    0%, 100% { opacity: 0.6; transform: scaleX(1); }
    50% { opacity: 1; transform: scaleX(1.1); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .overview-header-enhanced {
        flex-direction: column;
        gap: 1rem;
        padding: 1.2rem;
        text-align: center;
    }
    
    .enhanced-title {
        flex-direction: column;
        gap: 0.3rem;
    }
    
    .title-gradient {
        font-size: 1.8rem;
    }
    
    .title-subtitle {
        font-size: 1.1rem;
    }
}
.station-dropdown {
  width: 180px; /* ‚≠ê [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á */
  -webkit-appearance: none;
  appearance: none;
  padding: 12px 40px 12px 20px;
  border-radius: 12px;
  border: 1px solid #b7e4c7;
  background-color: #ffffff;
  font-size: 1rem;
  font-weight: 600;
  color: #1b4332;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  transition: all 0.2s ease-in-out;

  /* ‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á */
  background-image: url("data:image/svg+xml,..."); /* (‡πÇ‡∏Ñ‡πâ‡∏î SVG ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
  background-repeat: no-repeat;
  background-position: right 14px center;
}

.station-dropdown:hover {
  border-color: #52b788;
  box-shadow: 0 4px 12px rgba(82, 183, 136, 0.15);
}

.station-dropdown:focus {
  outline: none;
  border-color: #40916c;
  box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.3);
}











/* ‚úÖ ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status Badge) traymaster */
/* ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á Tray Master ‚ú® */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-in-row {
  opacity: 0;
  animation: fadeInUp 0.5s ease-out forwards;
}

/* üé® [‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î] ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á üé® */
.status-badge {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 6px 14px; border-radius: 20px;
    font-weight: 600; font-size: 0.9em;
    border: 1px solid transparent;
}
.status-badge.on-shelf {
    background-color: #e6f4ea; color: #1b4332; border-color: #a7d7b9;
}
.status-badge.at-workstation {
    background-color: #fffbeb; color: #b45309; border-color: #fde68a;
}
.action-btn {
    display: inline-flex; align-items: center; justify-content: center;
    gap: 6px; padding: 9px 18px; border-radius: 10px;
    border: none; cursor: pointer; font-weight: 600;
    font-size: 0.9em; transition: all 0.2s ease-in-out;
    min-width: 90px;
}
.action-btn.edit { background-color: #f97316; color: white; }
.action-btn.edit:hover {
    background-color: #ea580c; transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
}
.action-btn.history { background-color: #4b5563; color: white; }
.action-btn.history:hover {
    background-color: #374151; transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(75, 85, 99, 0.3);
}/* ‚úÖ ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status Badge) traymaster */





/* ‚úÖ Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà */
.history-row td {
  background-color: #f8f9fa;
  padding: 20px !important;
  border-bottom: 2px solid #52b788;
}
.history-table {
  width: 100%;
  border-collapse: collapse;
  margin: 0 auto;
}
.history-table th, .history-table td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #e0e0e0;
}
.history-table th {
  background-color: #2d6a4f; /* üé® ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å */
  color: #ffffff; /* üé® ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
  font-weight: 600;
}
.history-row .action-inbound { 
    color: #1b4332; /* ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
    font-weight: bold; 
}
.history-row .action-outbound { color: #ef4444; font-weight: bold; }


/**
 * ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] CSS ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
 */
#outboundValidationBox {
  padding: 18px;
  border-radius: 12px;
  border-width: 1px;
  border-style: solid;
  transition: all 0.3s ease-in-out;
  animation: fadeIn 0.4s;
}

#outboundValidationBox p {
  margin: 0;
  font-size: 1.05em;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠‡∏ñ‡∏≤‡∏î (Success) */
#outboundValidationBox.success {
  background-color: #f0fdf4; /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô */
  border-color: #bbf7d0;
  color: #166534;
}

/* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ñ‡∏≤‡∏î (Warning) */
#outboundValidationBox.warning {
  background-color: #fffbeb; /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô */
  border-color: #fde68a;
  color: #b45309;
}
/* ‚úÖ üíÖ CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pop-up ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î */
/* ‚úÖ Pop-up Styling (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå) */
.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(31, 41, 55, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  backdrop-filter: blur(25px) saturate(180%);
  -webkit-backdrop-filter: blur(25px) saturate(180%);
  opacity: 0;
  animation: fadeIn 0.3s ease-out forwards;
}

.popup-container {
  background: #ffffff;
  padding: 35px 40px;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  width: 90%;
  max-width: 520px;
  transform: scale(0.95);
  animation: popIn 0.3s ease-out forwards;
}

.popup-header {
  text-align: center;
  margin-bottom: 25px;
}

.popup-header .icon {
  font-size: 3rem;
  color: #10B981; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (Default) */
}

/* ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô Outbound */
.popup-header .icon.danger {
    color: #e63946;
}

.popup-title {
  font-size: 1.6em;
  font-weight: 700;
  color: #1F2937;
  margin-top: 15px;
  margin-bottom: 8px;
}

.popup-subtitle {
  font-size: 1.1em;
  color: #6B7280;
  margin: 0;
}

.popup-summary {
  background-color: #F9FAFB;
  border-radius: 12px;
  padding: 20px;
  border: 1px solid #E5E7EB;
  margin-top: 20px;
}

.summary-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  font-size: 1.05em;
  border-bottom: 1px solid #F3F4F6;
}

.summary-item:last-child {
  border-bottom: none;
}

.summary-label {
  color: #4B5563;
  font-weight: 500;
}

.summary-value {
  color: #111827;
  font-weight: 600;
  text-align: right;
  word-break: break-all;
}

.summary-value.highlight {
  color: #059669;
  font-weight: 700;
}

.popup-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-top: 30px;
}

.popup-button {
  padding: 14px;
  font-size: 1.1em;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.popup-button.cancel {
  background-color: #E5E7EB;
  color: #4B5563;
  border: 1px solid #D1D5DB;
}

.popup-button.cancel:hover {
  background-color: #D1D5DB;
}

/* -- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -- */
.popup-button.confirm {
  background: linear-gradient(135deg, #10B981, #059669);
  color: white;
}

.popup-button.confirm:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

/* ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á */
.popup-button.confirm.danger {
  background: linear-gradient(135deg, #e63946, #b91c1c);
}

.popup-button.confirm.danger:hover {
  background: linear-gradient(135deg, #b91c1c, #9a141a);
  box-shadow: 0 4px 15px rgba(229, 62, 77, 0.3);
}

/* === üíÖ Deluxe Form Styling + Beautiful Animations === */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');

body {
    background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);
    font-family: 'Prompt', sans-serif; /* ‚úÖ‚úÖ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô 'Prompt' */
    position: relative;
    overflow-x: hidden;
    transition: all 0.6s ease;
}

/* ‚ú® Animated Background */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 80%, rgba(45, 106, 79, 0.4) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(64, 145, 108, 0.3) 0%, transparent 50%);
    z-index: -1;
    animation: backgroundPulse 8s ease-in-out infinite;
}

@keyframes backgroundPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

/* üî¥ Outbound Background Animation */
.page-tray-outbound {
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%) !important;
}

.page-tray-outbound::before {
    background: 
        radial-gradient(circle at 20% 80%, rgba(220, 38, 38, 0.4) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(239, 68, 68, 0.3) 0%, transparent 50%) !important;
}

/* ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏π‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á */
.form-container-deluxe {
    max-width: 800px;
    width: 95%;
    margin: 40px auto;
    padding: 30px 40px;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    border: none;
    border-radius: 24px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
    overflow: hidden;
    position: relative;
    animation: slideInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    transform-origin: center;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* üåü Shimmer Effect */
.form-container-deluxe::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #2d6a4f, #40916c, #2d6a4f);
    background-size: 200% 100%;
    animation: shimmer 3s linear infinite;
}

.page-tray-outbound .form-container-deluxe::before {
    background: linear-gradient(90deg, #dc2626, #ef4444, #dc2626) !important;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(60px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö header ‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á */
.form-header {
    text-align: center;
    margin-bottom: 25px;
    position: relative;
    width: 100%;
}

/* ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö title ‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á */
.form-title {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    font-size: 2.2em;
    font-weight: 700;
    background: linear-gradient(135deg, #2d6a4f 0%, #40916c 50%, #2d6a4f 100%);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    background-clip: text;
    background-clip: text;
  background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0 0 8px 0;
    animation: titleGradient 4s ease-in-out infinite;
    letter-spacing: -0.5px;
    text-align: center;
}

.page-tray-outbound .form-title {
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 50%, #dc2626 100%) !important;
    background-size: 200% 200%;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
    animation: titleGradientRed 4s ease-in-out infinite;
}

@keyframes titleGradient {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

@keyframes titleGradientRed {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

/* üé™ Bouncing Icon */
.form-title i {
    font-size: 1.2em;
    background: linear-gradient(135deg, #40916c, #2d6a4f);
    -webkit-background-clip: text;
    background-clip: text;
    background-clip: text;
  background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 2px 4px rgba(64, 145, 108, 0.3));
    animation: iconBounce 2s ease-in-out infinite;
}

.page-tray-outbound .form-title i {
    background: linear-gradient(135deg, #ef4444, #dc2626) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
    filter: drop-shadow(0 2px 4px rgba(239, 68, 68, 0.3)) !important;
}

@keyframes iconBounce {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
}

/* ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö subtitle ‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á */
.form-subtitle {
    font-size: 1.1em;
    color: #6B7280;
    font-weight: 400;
    line-height: 1.4;
    max-width: 600px;
    margin: 0 auto 5px auto;
    text-align: center;
    animation: fadeInUp 0.8s ease-out 0.3s both;
}

/* ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö form-grid ‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 30px;
    width: 100%;
    max-width: 700px;
    margin: 0 auto;
}

.form-group {
    display: flex;
    flex-direction: column;
    position: relative;
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
}

/* üé≠ Staggered Animation */
.form-group:nth-child(1) { animation-delay: 0.1s; }
.form-group:nth-child(2) { animation-delay: 0.2s; }
.form-group:nth-child(3) { animation-delay: 0.3s; }
.form-group:nth-child(4) { animation-delay: 0.4s; }
.form-group:nth-child(5) { animation-delay: 0.5s; }
.form-group:nth-child(6) { animation-delay: 0.6s; }

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 12px;
    font-size: 1em;
    transition: color 0.3s ease;
}

/* üé® Animated Label Icons */
.form-group label i {
    color: #40916c;
    font-size: 1.2em;
    transition: all 0.3s ease;
}

.page-tray-outbound .form-group label i {
    color: #ef4444 !important;
}

.form-group:hover label i {
    transform: scale(1.2) rotate(5deg);
}

/* ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö input ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà */
.form-input-deluxe {
    width: 100%;
    padding: 16px 20px;
    border: 2px solid transparent;
    border-radius: 16px;
    font-size: 1.1em;
    font-family: 'Poppins', sans-serif;
    color: #1F2937;
    background: linear-gradient(white, white) padding-box,
                linear-gradient(135deg, #e5e7eb, #f3f4f6) border-box;
    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    position: relative;
}

.form-input-deluxe:focus {
    outline: none;
    background: linear-gradient(white, white) padding-box,
                linear-gradient(135deg, #2d6a4f, #40916c) border-box;
    transform: translateY(-3px);
    box-shadow: 0 12px 30px rgba(64, 145, 108, 0.25);
}

.page-tray-outbound .form-input-deluxe:focus {
    background: linear-gradient(white, white) padding-box,
                linear-gradient(135deg, #dc2626, #ef4444) border-box !important;
    box-shadow: 0 12px 30px rgba(239, 68, 68, 0.25) !important;
}

.form-input-deluxe::placeholder {
    color: #9CA3AF;
    font-style: italic;
}

textarea.form-input-deluxe {
    resize: vertical;
    padding-top: 16px;
    min-height: 100px;
}

/* ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö button ‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
.form-button-action {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    width: 100%;
    max-width: 500px;
    margin: 25px auto 0 auto;
    padding: 18px 40px;
    font-size: 1.2em;
    font-weight: 700;
    color: white;
    background: linear-gradient(135deg, #40916c 0%, #2d6a4f 50%, #40916c 100%);
    background-size: 200% 200%;
    border: none;
    border-radius: 16px;
    cursor: pointer;
    box-shadow: 
        0 10px 30px rgba(64, 145, 108, 0.35),
        0 0 0 1px rgba(255, 255, 255, 0.1) inset;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    text-transform: uppercase;
    letter-spacing: 1.2px;
    position: relative;
    overflow: hidden;
    animation: buttonGlow 3s ease-in-out infinite;
}

@keyframes buttonGlow {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

/* üåü Shimmer Effect on Button */
.form-button-action::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
    transition: left 0.8s ease;
}

.form-button-action:hover {
    transform: translateY(-6px) scale(1.02);
    box-shadow: 
        0 20px 50px rgba(64, 145, 108, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.2) inset;
}

.form-button-action:hover::before {
    left: 100%;
}

.form-button-action:active {
    transform: translateY(-3px) scale(1.01);
}

/* üî• Red Button for Outbound */
.form-button-action.danger {
    background: linear-gradient(135deg, #EF4444 0%, #DC2626 50%, #EF4444 100%);
    background-size: 200% 200%;
    box-shadow: 
        0 10px 30px rgba(239, 68, 68, 0.35),
        0 0 0 1px rgba(255, 255, 255, 0.1) inset;
    animation: dangerGlow 3s ease-in-out infinite;
}

@keyframes dangerGlow {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.form-button-action.danger:hover {
    transform: translateY(-6px) scale(1.02);
    box-shadow: 
        0 20px 50px rgba(239, 68, 68, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.2) inset;
}

/* ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö responsive */
@media (max-width: 768px) {
    .form-container-deluxe {
        width: 98%;
        margin: 20px auto;
        padding: 25px 20px;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
        gap: 20px;
        max-width: 100%;
    }
    
    .form-title {
        font-size: 1.8em;
    }
    
    .form-button-action {
        padding: 16px 30px;
        font-size: 1.1em;
        max-width: 100%;
    }
    
    .form-input-deluxe {
        padding: 14px 18px;
    }
}

/* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° smooth centering effect */
.form-container-deluxe:hover {
    transform: translateY(-3px) scale(1.01);
    box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.15),
        0 0 0 1px rgba(255, 255, 255, 0.2) inset;
}

/* Responsive adjustments for smaller screens */
@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    .form-container-deluxe {
        padding: 30px;
    }
    .form-title {
        font-size: 1.8em;
    }
}

/* ‚úÖ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° */
.camera-section {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  justify-content: center;
  align-items: stretch;
  margin-top: 30px;
  padding: 10px 0;
}

/* ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏∏‡∏î‡∏´‡∏£‡∏π */
.camera-box {
  position: relative;
  flex: 1 1 42%;
  max-width: 720px;
  aspect-ratio: 16 / 9;
  background: #000;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.06);
  backdrop-filter: blur(3px);
}


.camera-box:hover {
  transform: scale(1.015);
  box-shadow: 0 12px 36px rgba(0, 0, 0, 0.4);
}

/* ‚úÖ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô) */
.camera-box img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

/* ‚úÖ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô) */
.camera-box .camera-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* ‚úÖ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏°‡∏∏‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô RGV ‡∏ï‡∏¥‡∏î‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á) */
.camera-box .rotate-left {
  transform: rotate(-90deg);
  transform-origin: center center;
  position: absolute;
  top: 50%;
  left: 50%;
  width: 160%;      /* ‚úÖ ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á */
  height: auto;
  translate: -50% -50%;
  object-fit: cover;
}

/* ‚úÖ ‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏π‡∏´‡∏£‡∏≤ */
.camera-label {
  position: absolute;
  bottom: 12px;
  left: 16px;
  background: rgba(0, 0, 0, 0.6);
  color: #ffffff;
  padding: 6px 14px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 500;
  font-family: 'Segoe UI', 'Kanit', sans-serif;
  letter-spacing: 0.5px;
  backdrop-filter: blur(2px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  gap: 6px;
}

.camera-label i {
  color: #58d68d;
  font-size: 14px;
}
/* ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ AGV ‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á */
.agv-status-box {
  position: relative;
  background: linear-gradient(135deg, var(--boxColor, #1eb980), rgba(255, 255, 255, 0.05));
  border-radius: 20px;
  padding: 26px 36px;
  color: #ffffff;
  font-family: 'Segoe UI', sans-serif;
  width: 100%;
  max-width: 860px;
  margin: 36px auto;
  box-shadow:
    0 10px 24px rgba(0, 0, 0, 0.2),
    0 0 16px var(--boxColor);
  border: 1px solid rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  overflow: hidden;
  z-index: 1;
  text-align: center;
}

/* ‚úÖ ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÅ‡∏™‡∏á‡∏ô‡∏∏‡πà‡∏° (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ animation) */
.agv-status-box::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle at center, var(--boxColor, #1eb980) 0%, transparent 70%);
  opacity: 0.08;
  pointer-events: none;
  z-index: 0;
}

/* ‚úÖ ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏ö‡∏ö‡∏ö‡∏≤‡∏•‡∏≤‡∏ô‡∏ã‡πå */
.agv-status-title {
  font-size: 1.85rem;
  font-weight: 700;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 14px;
  color: #ffffff;
  text-shadow: 0 2px 5px rgba(0, 0, 0, 0.35);
  position: relative;
  z-index: 1;
}

.agv-status-title i {
  font-size: 2rem;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.25));
}

/* ‚úÖ ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏≠‡∏î‡∏µ‡∏™‡∏≤‡∏¢‡∏ï‡∏≤ */
.agv-status-desc {
  font-size: 1.1rem;
  font-weight: 400;
  opacity: 0.94;
  line-height: 1.6;
  color: #f8f9fa;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  position: relative;
  z-index: 1;
}

/* üî¥ Error Style ‡πÅ‡∏ö‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û */
.agv-status-box.error {
  background: linear-gradient(135deg, #dc3545, #6a1b1b);
  box-shadow:
    0 10px 28px rgba(220, 53, 69, 0.35),
    0 0 12px #dc3545;
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: #fff;
}



/* üî∑ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° */
.btn-premium {
  padding: 14px 26px;
  font-size: 1rem;
  font-weight: 600;
  border-radius: 14px;
  background: linear-gradient(135deg, #52b788, #2d6a4f);
  color: #ffffff;
  border: none;
  box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  cursor: pointer;
  transition: all 0.25s ease;
}

/* üîã ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà RGV ‡πÅ‡∏ö‡∏ö Premium */
.rgv-battery-container {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(240, 248, 255, 0.98) 100%);
  backdrop-filter: blur(20px);
  border-radius: 24px;
  padding: 28px 32px;
  margin: 24px auto;
  max-width: 860px;
  box-shadow: 
    0 12px 32px rgba(0, 0, 0, 0.08),
    0 4px 16px rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.6);
  position: relative;
  overflow: hidden;
}

.rgv-battery-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #10b981 0%, #3b82f6 50%, #8b5cf6 100%);
  background-size: 200% 100%;
  animation: batteryGradientFlow 3s ease-in-out infinite;
}

@keyframes batteryGradientFlow {
  0%, 100% { background-position: 200% center; }
  50% { background-position: 0% center; }
}

.battery-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
}

.battery-icon-wrapper {
  width: 56px;
  height: 56px;
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.6rem;
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
  position: relative;
  overflow: hidden;
}

.battery-icon-wrapper::before {
  content: '';
  position: absolute;
  top: -2px;
  right: -2px;
  width: 8px;
  height: 16px;
  background: linear-gradient(135deg, #60a5fa, #3b82f6);
  border-radius: 2px;
}

.battery-header h3 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 700;
  background: linear-gradient(135deg, #1e40af, #3730a3);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.battery-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}

.battery-stat-item {
  background: rgba(255, 255, 255, 0.7);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  border: 1px solid rgba(59, 130, 246, 0.1);
  position: relative;
  overflow: hidden;
}

.battery-stat-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--stat-color, #3b82f6);
  opacity: 0.8;
}

.battery-percentage {
  --stat-color: #10b981;
}

.battery-time-remaining {
  --stat-color: #f59e0b;
}

.stat-value {
  font-size: 2.2rem;
  font-weight: 800;
  color: var(--stat-color, #3b82f6);
  margin-bottom: 8px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.stat-label {
  font-size: 0.95rem;
  color: #64748b;
  font-weight: 500;
  margin-bottom: 12px;
}

.battery-level-bar {
  width: 100%;
  height: 8px;
  background: rgba(148, 163, 184, 0.2);
  border-radius: 4px;
  overflow: hidden;
  margin-top: 12px;
  position: relative;
}

.battery-level-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--battery-color, #10b981), var(--battery-color-light, #34d399));
  border-radius: 4px;
  transition: width 0.8s ease, background 0.3s ease;
  position: relative;
}

.battery-level-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  animation: batteryShimmer 2s ease-in-out infinite;
}

@keyframes batteryShimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* ‡∏™‡∏µ‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö */
.battery-high {
  --battery-color: #10b981;
  --battery-color-light: #34d399;
  --stat-color: #10b981;
}

.battery-medium {
  --battery-color: #f59e0b;
  --battery-color-light: #fbbf24;
  --stat-color: #f59e0b;
}

.battery-low {
  --battery-color: #ef4444;
  --battery-color-light: #f87171;
  --stat-color: #ef4444;
}

.battery-critical {
  --battery-color: #dc2626;
  --battery-color-light: #ef4444;
  --stat-color: #dc2626;
  animation: batteryPulse 1.5s ease-in-out infinite;
}

@keyframes batteryPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.battery-status-text {
  font-size: 0.85rem;
  margin-top: 8px;
  padding: 4px 12px;
  border-radius: 12px;
  background: rgba(var(--stat-color-rgb, 59, 130, 246), 0.1);
  color: var(--stat-color, #3b82f6);
  font-weight: 500;
  display: inline-block;
}

/* üì∏ ‡∏£‡∏∞‡∏ö‡∏ö Image Processing ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏ú‡∏±‡∏Å */
.image-processing-container {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.98) 100%);
  backdrop-filter: blur(20px);
  border-radius: 24px;
  padding: 32px;
  margin: 24px auto;
  max-width: 1200px;
  box-shadow: 
    0 12px 32px rgba(0, 0, 0, 0.08),
    0 4px 16px rgba(99, 102, 241, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.6);
  position: relative;
  overflow: hidden;
}

.image-processing-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #059669 0%, #0ea5e9 50%, #8b5cf6 100%);
  background-size: 200% 100%;
  animation: processingGradientFlow 4s ease-in-out infinite;
}

@keyframes processingGradientFlow {
  0%, 100% { background-position: 200% center; }
  50% { background-position: 0% center; }
}

.processing-header {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 32px;
}

.processing-icon-wrapper {
  width: 64px;
  height: 64px;
  background: linear-gradient(135deg, #0ea5e9, #0369a1);
  border-radius: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.8rem;
  box-shadow: 0 8px 24px rgba(14, 165, 233, 0.3);
  position: relative;
  overflow: hidden;
}

.processing-icon-wrapper::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
  animation: iconPulse 3s ease-in-out infinite;
}

@keyframes iconPulse {
  0%, 100% { transform: scale(1); opacity: 0.8; }
  50% { transform: scale(1.1); opacity: 1; }
}

.processing-header h2 {
  margin: 0;
  font-size: 2rem;
  font-weight: 700;
  background: linear-gradient(135deg, #0f172a, #1e40af);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.camera-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 24px;
  margin-bottom: 32px;
}

.camera-processing-box {
  background: rgba(255, 255, 255, 0.8);
  border-radius: 20px;
  padding: 24px;
  border: 1px solid rgba(14, 165, 233, 0.1);
  position: relative;
  overflow: hidden;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.camera-processing-box:hover {
  transform: translateY(-4px);
  box-shadow: 0 16px 40px rgba(0, 0, 0, 0.1);
}

.camera-processing-box::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--camera-color, #0ea5e9);
  opacity: 0.8;
}

.camera-box-1 { --camera-color: #059669; }
.camera-box-2 { --camera-color: #0ea5e9; }
.camera-box-3 { --camera-color: #8b5cf6; }
.camera-box-4 { --camera-color: #f59e0b; }

.camera-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.camera-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #1f2937;
  display: flex;
  align-items: center;
  gap: 8px;
}

.camera-status {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
  text-transform: uppercase;
}

.camera-status.active {
  background: rgba(5, 150, 105, 0.1);
  color: #059669;
}

.camera-status.processing {
  background: rgba(14, 165, 233, 0.1);
  color: #0ea5e9;
  animation: statusPulse 2s ease-in-out infinite;
}

.camera-status.error {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
}

@keyframes statusPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.camera-feed {
  width: 100%;
  height: 200px;
  background: #f8fafc;
  border-radius: 12px;
  border: 2px dashed #cbd5e1;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 16px;
  position: relative;
  overflow: hidden;
}

.camera-feed img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 10px;
}

.camera-placeholder {
  text-align: center;
  color: #64748b;
}

.camera-placeholder i {
  font-size: 2rem;
  margin-bottom: 8px;
  display: block;
}

.scan-results {
  background: rgba(248, 250, 252, 0.7);
  border-radius: 12px;
  padding: 16px;
  min-height: 100px;
}

.scan-results h4 {
  margin: 0 0 12px 0;
  font-size: 0.95rem;
  font-weight: 600;
  color: #374151;
  display: flex;
  align-items: center;
  gap: 8px;
}

.vegetable-detected {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 12px;
  background: rgba(5, 150, 105, 0.1);
  border-radius: 8px;
  margin-bottom: 8px;
}

.vegetable-info {
  flex: 1;
}

.vegetable-name {
  font-weight: 600;
  color: #059669;
  font-size: 0.9rem;
}

.confidence-score {
  font-size: 0.8rem;
  color: #6b7280;
}

.processing-controls {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-top: 32px;
}

.control-button {
  padding: 16px 24px;
  border-radius: 16px;
  border: none;
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.control-button.primary {
  background: linear-gradient(135deg, #0ea5e9, #0369a1);
  color: white;
  box-shadow: 0 6px 20px rgba(14, 165, 233, 0.3);
}

.control-button.primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(14, 165, 233, 0.4);
}

.control-button.secondary {
  background: rgba(148, 163, 184, 0.1);
  color: #64748b;
  border: 1px solid rgba(148, 163, 184, 0.3);
}

.control-button.secondary:hover {
  background: rgba(148, 163, 184, 0.2);
  color: #475569;
}

.control-button.success {
  background: linear-gradient(135deg, #059669, #047857);
  color: white;
  box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
}

.control-button.success:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(5, 150, 105, 0.4);
}

.processing-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 16px;
  margin-top: 24px;
}

.stat-card {
  background: rgba(255, 255, 255, 0.9);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  border: 1px solid rgba(14, 165, 233, 0.1);
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--stat-card-color, #0ea5e9);
}

.stat-card-1 { --stat-card-color: #059669; }
.stat-card-2 { --stat-card-color: #0ea5e9; }
.stat-card-3 { --stat-card-color: #8b5cf6; }
.stat-card-4 { --stat-card-color: #f59e0b; }

.stat-number {
  font-size: 1.8rem;
  font-weight: 800;
  color: var(--stat-card-color, #0ea5e9);
  margin-bottom: 4px;
}

.stat-label {
  font-size: 0.85rem;
  color: #64748b;
  font-weight: 500;
}

.btn-premium:hover {
  transform: translateY(-2px);
  background: linear-gradient(135deg, #2d6a4f, #1b4332);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
}

/* üî∑ ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏ß‡∏¢‡∏´‡∏£‡∏π */
.main-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin: 30px 0;
}

/* üî∑ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° */
.camera-section {
  display: flex;
  flex-wrap: wrap;
  gap: 36px;
  justify-content: center;
  margin: 40px 0;
}
.camera-box {
  flex: 1 1 48%;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
  overflow: hidden;
  position: relative;
  border: 1px solid #e2e8f0;
  height: auto;
}

/* üî∑ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ AGV ‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° */
.lift-status {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  margin: 24px auto;
  padding: 14px 28px;
  font-size: 1.1rem;
  font-weight: 600;
  border-radius: 16px;
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.15);
  border: 2px solid transparent;
  background: linear-gradient(to right, #06b6d4, #0ea5e9);
  color: #ffffff;
  transition: all 0.4s ease;
}
.lift-status.working {
  background: linear-gradient(to right, #06b6d4, #0ea5e9);
  border-color: #0ea5e9;
}
.lift-status.working i {
  margin-right: 6px;
}

/* üî∑ ‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå */
.sensor-status {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
  margin-bottom: 30px;
}
.sensor-tag {
  background: #e6f4ea;
  color: #1b4332;
  border: 1px solid #52b788;
  border-radius: 20px;
  padding: 8px 18px;
  font-size: 0.95em;
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
}

/* üî∑ Dropdown ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á */
.dropdown {
  text-align: center;
  margin-top: 40px;
}
select.dropdown-select {
  padding: 12px 20px;
  font-size: 1em;
  font-weight: 500;
  border-radius: 14px;
  border: 1px solid #cbd5e1;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
  width: 280px;
  margin-top: 10px;
  background-color: #ffffff;
  color: #1b4332;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg fill='none' stroke='%232d6a4f' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  background-size: 16px 16px;
  transition: all 0.3s ease;
}
select.dropdown-select:focus {
  border-color: #40916c;
  box-shadow: 0 0 0 3px rgba(64, 145, 108, 0.25);
}



/* ‚úÖ liftstatus */

.lift-status.working {
  background: linear-gradient(to right, #0284c7, #0ea5e9); /* üíô ‡∏ü‡πâ‡∏≤‡∏™‡∏î */
  color: white;
  border: 2px solid #0ea5e9;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: all 0.4s ease;
}


.lift-status {
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 24px auto;
  padding: 14px 24px;
  font-size: 1.1rem;
  font-weight: 600;
  border-radius: 14px;
  width: fit-content;
  box-shadow: 0 6px 14px rgba(0,0,0,0.15);
  border: 2px solid;
  transition: all 0.4s ease;
}

.lift-status.success {
  background: linear-gradient(to right, #38b000, #70e000);
  color: white;
  border-color: #28a745;
}

.lift-status.recovery {
  background: linear-gradient(to right, #f59e0b, #fbbf24);
  color: white;
  border-color: #f59e0b;
  animation: pulse 1.5s infinite;
}

.lift-status.emergency {
  background: linear-gradient(to right, #dc2626, #ef4444);
  color: white;
  border-color: #dc2626;
  animation: blink 1s infinite;
}

/* ‚úÖ ‡∏´‡∏ô‡πâ‡∏≤ task */
.styled-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  .styled-table th, .styled-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
  }
  .status.success {
    color: #fff;
    background: #4CAF50;
    padding: 4px 8px;
    border-radius: 12px;
  }
  .status.error {
    color: #fff;
    background: #e53935;
    padding: 4px 8px;
    border-radius: 12px;
  }/* ‚úÖ ‡∏´‡∏ô‡πâ‡∏≤ task */
  .blink {
    animation: blinker 1s linear infinite;
  }





/* ========================================================== */
/* === ‚ú® [FINAL FIX v2] TRAY INFO POPUP STYLES ‚ú® === */
/* ========================================================== */

/* --- üé¨ Animations (‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) --- */
@keyframes popIn {
  from { transform: translateY(20px) scale(0.95); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}
@keyframes popOut {
  from { transform: scale(1); opacity: 1; }
  to { transform: scale(0.95); opacity: 0; }
}
@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(15px); }
  to { opacity: 1; transform: translateY(0); }
}

/* --- 1. ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (Backdrop) --- */
.tray-popup-backdrop {
  position: fixed; top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(17, 24, 39, 0.85);
  backdrop-filter: blur(30px) saturate(200%); 
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
  z-index: 9999;
  opacity: 0;
  animation: fadeIn 0.3s ease-out forwards;
}
.tray-popup-backdrop.closing {
  animation: fadeOut 0.3s ease-in forwards;
}

/* --- 2. ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á Popup ‡∏´‡∏•‡∏±‡∏Å (Card) --- */
.tray-popup-card {
  background: #ffffff;
  border-radius: 24px;
  box-shadow: 0 20px 45px rgba(0,0,0,0.25);
  width: 90%;
  max-width: 450px;
  font-family: 'Prompt', sans-serif;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  max-height: 85vh;
  /* üé¨ Animation ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
  transform: scale(0.95);
  opacity: 0;
  animation: popIn 0.4s 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
}
.tray-popup-card.closing {
  animation: popOut 0.3s ease-in forwards;
}

/* --- 3. ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (Header) [‡πÑ‡∏°‡πà scroll] --- */
.tray-popup-card .popup-header-premium {
  background: linear-gradient(145deg, #3b82f6, #2563eb);
  color: white;
  padding: 20px 25px;
  text-align: center;
  flex-shrink: 0; /* ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ï‡∏£‡∏∂‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÑ‡∏ß‡πâ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏î */
}
.tray-popup-card .popup-header-premium i {
  font-size: 2rem; margin-bottom: 10px; display: block;
}
.tray-popup-card .popup-header-premium h3 {
  font-size: 1.5em; font-weight: 600; margin: 0;
}

/* --- 4. ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Info List) [‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞ Scroll] --- */
.tray-popup-card .info-list {
  padding: 20px 30px;
  display: flex;
  flex-direction: column;
  gap: 14px;
  overflow-y: auto;   /* ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ scroll ‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß */
  flex-grow: 1;     /* ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ */
}

/* --- 5. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞ Animation (‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) --- */
.tray-popup-card .info-item {
  display: flex; justify-content: space-between; align-items: center;
  font-size: 1em; padding-bottom: 14px; border-bottom: 1px solid #f3f4f6;
  opacity: 0;
  animation: fadeInUp 0.5s ease-out forwards; /* üé¨ Animation ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
}
.tray-popup-card .info-item:last-child { border-bottom: none; padding-bottom: 0; }
/* üé¨ Staggered Animation ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô */
.tray-popup-card .info-item:nth-child(1) { animation-delay: 0.1s; }
.tray-popup-card .info-item:nth-child(2) { animation-delay: 0.13s; }
.tray-popup-card .info-item:nth-child(3) { animation-delay: 0.16s; }
.tray-popup-card .info-item:nth-child(4) { animation-delay: 0.19s; }
.tray-popup-card .info-item:nth-child(5) { animation-delay: 0.22s; }
.tray-popup-card .info-item:nth-child(6) { animation-delay: 0.25s; }
.tray-popup-card .info-item:nth-child(7) { animation-delay: 0.28s; }
.tray-popup-card .info-item:nth-child(8) { animation-delay: 0.31s; }
.tray-popup-card .info-item:nth-child(9) { animation-delay: 0.34s; }
.tray-popup-card .info-item:nth-child(10) { animation-delay: 0.37s; }

.tray-popup-card .info-label {
  color: #4b5563; font-weight: 500; display: flex; align-items: center; gap: 10px;
}
.tray-popup-card .info-value {
  color: #111827; font-weight: 600; text-align: right;
}
.tray-popup-card .info-value.highlight {
  background: #e0f2fe; color: #0c4a6e; padding: 4px 10px; border-radius: 8px; font-weight: 700;
}

/* --- 6. ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î (Footer) [‡πÑ‡∏°‡πà scroll] --- */
.tray-popup-card .close-button-wrapper {
  padding: 15px 30px;
  background-color: #f9fafb;
  border-top: 1px solid #e5e7eb;
  flex-shrink: 0; /* ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ï‡∏£‡∏∂‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ß‡πâ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏î */
}
.tray-popup-card .close-button {
  width: 100%; background: #4b5563; color: white;
  padding: 12px; font-size: 1em; font-weight: 600;
  border: none; border-radius: 12px; cursor: pointer;
  transition: all 0.3s ease; display: flex; align-items: center;
  justify-content: center; gap: 8px;
}
.tray-popup-card .close-button:hover {
  background: #374151; transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(75, 85, 99, 0.2);
}








/* ‚úÖ ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° */
.status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  font-size: 0.95em;
  padding: 4px 12px;
  border-radius: 20px;
  transition: 0.3s ease;
}
.status-due {
  background-color: #fff0f0;
  color: #e63946;
  border: 1px solid #e63946;
}
.status-due.blink {
  animation: blinkEffect 1s infinite;
}
.status-growing {
  background-color: #e9f5ec;
  color: #2d6a4f;
  border: 1px solid #2d6a4f;
}
.status i {
  font-size: 0.9em;
}

/* ‚úÖ ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß */
.harvest-due {
  background-color: #fff0f0 !important;
  transition: background-color 0.3s ease;
}

/* ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å */
.card {
  background: linear-gradient(135deg, #ffffff, #f0fdf4);
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
  margin: 24px auto;
  max-width: 95%;
  font-family: 'Prompt', sans-serif;
  animation: fadeIn 0.5s ease-in-out;
}

h2 {
  font-size: 1.8rem;
  color: #1b4332;
  margin-bottom: 24px;
  display: flex;
  align-items: center;
  font-weight: 600;
}
h2 i {
  color: #40916c;
  margin-right: 10px;
  font-size: 1.4em;
}

/* ‚úÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
.styled-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.08),
    0 4px 16px rgba(0, 0, 0, 0.04),
    inset 0 1px 0 rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(16px);
  transition: all 0.4s ease;
}

.styled-table thead {
  background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
}

.styled-table th,
.styled-table td {
  text-align: center;
  padding: 18px 16px;
  font-size: 0.95em;
  transition: all 0.3s ease;
}

.styled-table th {
  color: #ffffff;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  border: none;
}

.styled-table td {
  color: #374151;
  border-bottom: 1px solid rgba(243, 244, 246, 0.6);
}

.styled-table tbody tr {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
}

.styled-table tbody tr:nth-child(even) {
  background: rgba(248, 250, 252, 0.3);
}

.styled-table tbody tr:hover {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.03) 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(16, 185, 129, 0.1);
}

.styled-table tbody tr:hover td {
  border-color: rgba(16, 185, 129, 0.2);
  color: #1f2937;
}

.styled-table tr:last-child td {
  border-bottom: none;
}

/* ‚úÖ ‡∏à‡∏∏‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏µ */
.status-green::before,
.status-red::before {
  content: '\f111';
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  margin-right: 6px;
  font-size: 0.75em;
}
.status-green::before { color: #2d6a4f; }
.status-red::before { color: #e63946; }

/* ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö Super Dev */
#plantingPagination {
  display: flex !important;
  flex-direction: row !important;
  justify-content: center !important;
  align-items: center;
  gap: 8px;
  margin-top: 24px;
  flex-wrap: wrap;
}

.pagination button {
  background: #e9f5ec;
  border: 1px solid #2d6a4f;
  border-radius: 10px;
  padding: 8px 16px;
  font-size: 0.9em;
  font-weight: 500;
  color: #2d6a4f;
  cursor: pointer;
  transition: 0.3s;
  min-width: 44px;

  /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ */
  width: auto;
  flex: 0 0 auto;
}

.pagination button.active,
.pagination button:hover {
  background: #2d6a4f;
  color: white;
  transform: scale(1.05);
}

/* ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á */
.action-buttons {
  display: flex;
  gap: 8px;
  justify-content: center;
  flex-wrap: wrap;
}

.action-buttons button {
  background-color: #52b788;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 10px;
  font-size: 0.85em;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  font-weight: 500;
}

.action-buttons button:hover {
  background-color: #40916c;
  transform: scale(1.04);
}




.toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #d1fae5; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô */
  color: #065f46;
  padding: 16px 24px;
  border-radius: 12px;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  opacity: 0;
  transition: opacity 0.5s ease;
  z-index: 9999;
  pointer-events: none;
}

.toast.show {
  opacity: 1;
}
/* üçø Premium Log Cards Style */

.log-cards-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 24px;
  max-width: 1400px;
  margin: auto;
  margin-top: 30px;
}

.log-card {
  width: 320px;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  padding: 20px;
  font-family: 'Prompt', sans-serif;
  color: #1b4332;
  border: 1px solid #dde;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.log-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 28px rgba(0,0,0,0.15);
}

.log-card strong {
  color: #40916c;
}

.log-card .expand-btn {
  margin-top: 14px;
  padding: 10px 20px;
  border: none;
  background: linear-gradient(to right, #52b788, #40916c);
  color: white;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
  font-size: 0.95em;
  transition: 0.3s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.log-card .expand-btn:hover {
  background: linear-gradient(to right, #40916c, #2d6a4f);
  transform: translateY(-1px);
}

/* CSS ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ modern-logs-container ‡πÅ‡∏ó‡∏ô */




.manual-btn { /* ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏µ‡πâ‡∏ô‡∏•‡∏á */
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  font-size: 1rem;
  font-family: 'Prompt', sans-serif;
  background: linear-gradient(145deg, #2d6a4f, #40916c);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

 /* ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏µ‡πâ‡∏ô‡∏•‡∏á */
.manual-btn:hover {
  background: linear-gradient(145deg, #1b4332, #2d6a4f);
  transform: translateY(-2px);
}

 /* ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏µ‡πâ‡∏ô‡∏•‡∏á */
.manual-btn i {
  font-size: 1.2rem;
}

lift-container {
  position: relative;
  width: 200px;
  height: 600px;
  margin: 20px auto;
  border: 1px solid #ccc;
}

.lift-bg {
  width: 100%;
  height: 100%;
  display: block;
}

.lift-cart {
  position: absolute;
  left: 0;
  width: 100%;
  height: 60px;
  transition: top 1s ease;
  z-index: 10;
}

.sensor {
  position: absolute;
  left: 90%;
  width: 12px;
  height: 12px;
  background-color: gray;
  border-radius: 50%;
  z-index: 5;
  animation: blinkOff 1s infinite;
}







.video-overlay {
  background: none;
}

#loginVideo {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  z-index: -2;
  filter: brightness(1) blur(0.7px); /* ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô (brightness 1) */
}






.sidebar-header,
.sidebar-brand {
  padding: 10px 10px !important; /* üîΩ ‡∏•‡∏î padding ‡∏ö‡∏ô‡∏•‡∏á */
  text-align: center;
}





.footer-illustration {
  width: 200px;           /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å 140px ‚Üí 200px */
  max-width: 90%;
  height: auto;
  display: block;
  margin: 30px auto 0;    /* ‡∏Ç‡∏¢‡∏±‡∏ö‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡πÉ‡∏´‡πâ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏• */
}

.logo {
  width: 120px;
  height: auto;
  display: block;
  margin: 0 auto 20px;
  filter: drop-shadow(0 0 8px rgba(0,255,170,0.2)); /* ‡πÅ‡∏™‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏ô‡∏¥‡∏î‡πÜ */
}
.logo:hover {
  transform: scale(1.05);
}

.sidebar {
  width: 260px !important;
  height: 100vh;              /* ‚úÖ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
  overflow-y: auto;           /* ‚úÖ ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô */
  scroll-behavior: smooth;    /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ scroll */
  padding-bottom: 30px;       /* ‚úÖ ‡∏Å‡∏±‡∏ô footer ‡∏ó‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ */
}

.sidebar-logo {
  width: 140px;
  max-width: 100%;
  height: auto;
  margin: 10px auto;
  display: block;
  transition: transform 0.3s ease;
}
.sidebar-logo:hover {
  transform: scale(1.05);
}

.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal-box {
  background: white;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
  text-align: center;
  width: 300px;
  font-family: 'Prompt', sans-serif;
}

.modal-buttons {
  margin-top: 20px;
  display: flex;
  justify-content: space-around;
}

.modal-buttons button {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1em;
}

.modal-buttons button:first-child {
  background: #2d6a4f;
  color: white;
}

.modal-buttons button:last-child {
  background: #ccc;
  color: #333;
}
/* ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏™ login ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ */
.login-container {
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 20px;
  padding: 40px;
  width: 320px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.08);

  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;

  height: auto !important;      /* ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏à‡∏î‡∏à‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏Å‡πà‡∏≤ */
  min-height: 400px;            /* ‚úÖ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤ Login */
  max-height: 100vh;            /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≠ */
  transition: height 0.2s ease; /* ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ */
}


/* ‚úÖ ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î */
.login-container img {
  width: 140px;
  margin-bottom: 28px;
  filter: drop-shadow(0 0 10px rgba(0, 255, 170, 0.25));
  transition: transform 0.3s ease;
}
.login-container img:hover {
  transform: scale(1.05);
}

/* ‚úÖ Input + icon */
.input-group {
  position: relative;
  margin-bottom: 20px;
}

.input-group i {
  position: absolute;
  top: 50%;
  left: 16px;
  transform: translateY(-50%);
  color: #52b788; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô */
}

.input-group input {
  width: 100%;
  padding: 14px 14px 14px 44px;
  border-radius: 10px;
  border: none;
  background: rgba(255, 255, 255, 0.1);
  color: #52b788; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô */
}

.input-group input::placeholder {
  color: #95d5b2; /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô‡∏≠‡πà‡∏≠‡∏ô */
}

.input-group input:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(64, 145, 108, 0.4);
}

/* ‚úÖ ‡∏õ‡∏∏‡πà‡∏° Sign In */
.login-container button {
  background: linear-gradient(to right, #52b788, #40916c);
  border: none;
  padding: 14px;
  border-radius: 10px;
  color: white;
  font-weight: bold;
  width: 100%;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.login-container button:hover {
  transform: translateY(-2px);
}

/* ‚úÖ ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å */
.login-container a {
  color: white;
  font-size: 0.9em;
  display: block;
  margin-top: 20px;
  text-decoration: none;
}

.login-container a:hover {
  text-decoration: underline;
}
/* üíé Polished & Animated Grid Style üíé */

@keyframes grid-shimmer {
  0% { transform: translateX(-100%) skewX(-20deg); }
  100% { transform: translateX(2500px) skewX(-20deg); } /* 2500px ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏á‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏•‡∏¢‡∏Ç‡∏≠‡∏ö‡πÑ‡∏õ‡πÑ‡∏Å‡∏•‡πÜ */
}

/* --- ‡∏Å‡∏£‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --- */
.tray-grid {
  display: grid;
  gap: 12px;
  padding: 24px;
  background-color: #f8fafc; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ï‡∏≤ */
  border-radius: 18px;
  border: 1px solid #e2e8f0;
  position: relative;
  overflow: hidden; /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Animation */
}

/* --- ‡πÅ‡∏™‡∏á‡∏™‡πÅ‡∏Å‡∏ô (Animation) --- */
.tray-grid::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 10%;
  height: 120%;
  background: linear-gradient(
    to right,
    transparent 0%,
    rgba(255, 255, 255, 0.5) 50%,
    transparent 100%
  );
  animation: grid-shimmer 15s linear infinite;
  pointer-events: none; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏î‡πâ */
}

/* --- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡∏ä‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏±‡πâ‡∏ô) --- */
.tray-header-cell {
  font-weight: 600;
  text-align: center;
  padding: 10px 5px;
  font-size: 0.85em;
  color: #94a3b8; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô */
}

/* --- ‡∏™‡∏•‡πá‡∏≠‡∏ï (‡∏ó‡∏±‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏ñ‡∏≤‡∏î) --- */
.tray-slot {
  border-radius: 10px;
  transition: all 0.25s ease-in-out;
  min-height: 70px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 8px;
  position: relative;
}

/* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á animation */
.tray-slot * {
  opacity: 1 !important;
  visibility: visible !important;
}

/* --- ‡∏™‡∏•‡πá‡∏≠‡∏ï‡∏ß‡πà‡∏≤‡∏á --- */
.tray-slot.empty {
  background-color: #ffffff;
  border: 1px dashed #dce4f2; /* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞ */
  cursor: default;
}
.empty-slot-coords {
    font-size: 0.9em;
    font-weight: 500;
    color: #e2e8f0;
}

/* --- ‡∏™‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ñ‡∏≤‡∏î --- */
.tray-slot.filled {
  background: linear-gradient(145deg, #3b82f6, #2563eb); /* ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô */
  color: white;
  border: 1px solid #1d4ed8;
  box-shadow: 0 6px 16px rgba(59, 130, 246, 0.2);
  cursor: pointer;
}

/* --- ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ --- */
.tray-slot:hover {
  transform: translateY(-4px) scale(1.03);
  box-shadow: 0 10px 25px rgba(148, 163, 184, 0.2);
}
.tray-slot.filled:hover {
  box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
}

/* --- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡∏≠‡∏á Text ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏™‡∏•‡πá‡∏≠‡∏ï --- */
.filled-tray-icon {
  font-size: 1.4em;
  opacity: 0.8;
  margin-bottom: 4px;
}
.filled-tray-veg-name {
    font-size: 0.9em;
    font-weight: 600;
}
.filled-tray-id {
    font-size: 0.75em;
    font-weight: 400;
    background-color: rgba(255, 255, 255, 0.15);
    padding: 1px 5px;
    border-radius: 4px;
    margin-top: 2px;
}
.filled-tray-plants {
    font-size: 0.75em;
    opacity: 1;
    font-weight: 700;
    color: #fff3cd;
    background-color: rgba(255, 193, 7, 0.3);
    padding: 2px 6px;
    border-radius: 6px;
    margin-top: 2px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: block;
    text-align: center;
}



body {
    font-family: 'Prompt', sans-serif;
    background: linear-gradient(to bottom right, #e9f5ec, #ffffff);
  }

.header {
  position: relative; /* ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ absolute ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á */
}

.user-wrapper {
  position: relative;
  display: inline-block;
  font-family: 'Poppins', sans-serif;
}

.user-dropdown {
  display: none;
  position: absolute;
  right: 0;
  top: 110%;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
  padding: 8px 0;
  min-width: 220px;
  z-index: 9999;
  font-family: 'Poppins', sans-serif;
  border: 1px solid #e0e0e0;
}

.user-menu {
  background-color: #f0f0f0;
  padding: 8px 12px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  color: #1b4332;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.user-dropdown .dropdown-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 20px;
  font-size: 1em;
  font-weight: 500;
  color: #1b4332;
  transition: all 0.2s ease;
  border-left: 4px solid transparent;
  cursor: pointer;
}

.user-dropdown .dropdown-item:hover {
  background-color: #e9f5ec;
  border-left: 4px solid #52b788;
  color: #1b4332;
}

.dropdown-item {
  padding: 8px 10px;
  cursor: pointer;
  border-radius: 8px;
  transition: background 0.2s ease;
}

.dropdown-item:hover {
  background-color: #f0f0f0;
}



.theme-toggle {
  padding: 10px 18px;
  background: linear-gradient(to right, #74c69d, #52b788);
  color: white;
  font-weight: bold;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-size: 1em;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
.theme-toggle:hover {
  background: linear-gradient(to right, #52b788, #40916c);
  transform: translateY(-1px);
}


.dropdown-item:hover {
  background: #e9f5ec;
}

#loginPage,
#dashboardPage {
  display: none;
}


#loginPage {
  background: none;
}



.link {
  margin-top: 16px;
  display: block;
  color: #1b4332;
  font-size: 0.9em;
  text-decoration: underline;
  cursor: pointer;
}

    #dashboardPage {
  display: flex;
  flex-direction: row;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
}

.footer-faint p {
  font-weight: 500;
  color: #333;         /* ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å #6c757d */
}

.content {
  padding: 40px;
  overflow-y: auto;
  background: linear-gradient(to bottom, #e9f5ec, #ffffff);
  flex: 1; /* ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ */
}
.footer-faint {
  margin-top: 60px;
  padding-top: 30px;
  text-align: center;
  opacity: 0.95;
  animation: fadeIn 0.8s ease;
  font-size: 1.1em;  /* üî∫ ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏° 0.9em */
  line-height: 1.7;  /* üîÅ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
}

.footer-agrotech {
  max-width: 220px;       /* üî∫ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î */
  margin-top: 25px;
  opacity: 1;
  transition: transform 0.3s ease;
}
.footer-agrotech:hover {
  transform: scale(1.05);  /* ‡πÄ‡∏û‡∏¥‡πà‡∏° interaction ‡∏ï‡∏≠‡∏ô hover */
}




/* ‚úÖ ‡πÅ‡∏ï‡πà‡∏á dropdown menu ‡∏´‡∏ô‡πâ‡∏≤ Inbound */
.tray-form select {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #2d6a4f;              /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° */
  border-radius: 12px;
  font-size: 1.05em;
  font-family: 'Prompt', sans-serif;
  background-color: #ffffff;              /* ‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
  color: #1b4332;                         /* ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏° ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
  appearance: none;                       /* ‡∏ã‡πà‡∏≠‡∏ô dropdown ‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÅ‡∏ö‡∏ö‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏° */
  background-image: url("data:image/svg+xml,%3Csvg fill='none' stroke='%232d6a4f' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  background-size: 16px 16px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); /* ‡πÄ‡∏á‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÜ */
  transition: all 0.3s ease;
}

.tray-form select:focus {
  border-color: #40916c;
  box-shadow: 0 0 0 3px rgba(64, 145, 108, 0.2);
  background-color: #f8fff8;
}

/* ‚úÖ label ‡∏Ç‡πâ‡∏≤‡∏á dropdown */
.tray-form label {
  font-weight: 600;
  margin-bottom: 8px;
  display: block;
  color: #1b4332;
  font-size: 0.95em;
  margin-top: 16px;
}

/* ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î layout ‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° */
.tray-form {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  margin-top: 20px;
}

/* ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á input dropdown */
.tray-form > div {
  flex: 1 1 30%;
  min-width: 240px;
}
/* ‚úÖ ‡πÄ‡πÄ‡∏ï‡πà‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâinborund */
.logo-top {
  text-align: center;
  margin-bottom: 20px;
}
/* ‚úÖ ‡πÄ‡πÄ‡∏ï‡πà‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâoutborun */
.logo-top img {
  max-width: 160px;
  height: auto;
  opacity: 0.9;
  filter: drop-shadow(0 0 3px rgba(0,0,0,0.1));
}




.inbound-btn {
  background: linear-gradient(to right, #95d5b2, #74c69d);
  color: white;
  font-size: 1.2em;
  font-weight: 600;
  padding: 16px 28px;
  border-radius: 20px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 600px;
  display: block;
  margin: 30px auto 10px auto;
}
.inbound-btn:hover {
  transform: translateY(-3px);
  background: linear-gradient(to right, #74c69d, #52b788);
}

.outbound-btn {
  background: linear-gradient(to right, #f87171, #ef4444);
  color: white;
  font-size: 1.2em;
  font-weight: 600;
  padding: 16px 28px;
  border-radius: 20px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 600px;
  display: block;
  margin: 30px auto 10px auto;
}
.outbound-btn:hover {
  transform: translateY(-3px);
  background: linear-gradient(to right, #ef4444, #dc2626);
}

.inbound-title,
.outbound-title {
  text-align: center;
  font-size: 2em;
  font-weight: bold;
  margin-bottom: 10px;
  color: #1b4332;
}

.inbound-desc {
  color: #6c757d;
  text-align: center;
  margin-bottom: 30px;
  font-size: 1em;
}

/* ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÇ‡∏ú‡∏•‡πà */
html, body, #app {
  height: 100%;
  margin: 0;
  padding: 0;
}

/* ‚úÖ ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤ inbound/outbound ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á */
.inbound-page, .outbound-page {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-height: 100vh;
  padding: 40px 20px;
  background: linear-gradient(to bottom, #e9f5ee, #fefefe);
}




/* ‚úÖ ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î */
.warning-message {
  background: #fff5f5;
  color: #dc2626;
  border-left: 6px solid #dc2626;
  padding: 12px 20px;
  font-weight: bold;
  font-size: 0.95em;
  margin-top: 20px;
  border-radius: 12px;
  text-align: center;
  max-width: 700px;
  margin-left: auto;
  margin-right: auto;
}


    * {
      box-sizing: border-box;
      transition: 0.3s ease;
    }
    /* üí° Default: Light Mode */
    body {
  margin: 0;
  padding: 0;
  font-family: 'Prompt', sans-serif;
  background-size: cover;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
.sidebar {
  width: 260px;
  background: #ffffff;
  border-right: 1px solid #cce3d1;
  display: flex;
  flex-direction: column;
  padding: 25px 0;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.04);
  animation: slideInLeft 0.5s ease-out;
}

.sidebar img {
  width: 120px;
  margin: 0 auto 10px;
  transition: transform 0.3s ease;
}
.sidebar img:hover {
  transform: scale(1.1);
}

.sidebar h2 {
  text-align: center;
  color: #2d6a4f;
  margin: 10px 0 0;
  font-weight: 700;
}
.sidebar small {
  color: #6c757d;
  text-align: center;
  display: block;
}
.sidebar a {
  padding: 14px 30px;
  color: #1b4332;
  text-decoration: none;
  font-size: 1.1em;
  display: flex;
  align-items: center;
  border-left: 4px solid transparent;
}
.sidebar a:hover,
.sidebar a.active {
  background: #e9f5ec;
  border-left: 4px solid #52b788;
}
.sidebar a i {
  margin-right: 12px;
  font-size: 1.3em;
}

.main {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 100vh;
}



.content {
  padding: 40px;
  overflow-y: auto;
  background: linear-gradient(to bottom, #e9f5ec, #ffffff);
}

.section {
  background: #ffffff;
  padding: 35px;
  border-radius: 18px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
  margin-bottom: 40px;
  animation: fadeInUp 0.5s ease;
}
.section h2 {
  color: #1b4332;
  margin-bottom: 20px;
  font-size: 1.4em;
}

select,
button {
  padding: 14px;
  font-size: 1em;
  border-radius: 12px;
  border: 1px solid #ccc;
  margin-bottom: 18px;
  width: 100%;
  background-color: #f8f9fa;
  color: #1b4332;
}

button {
  width: 100%;
  padding: 12px;
  background: #52b788;
  color: white;
  font-weight: bold;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  margin-top: 10px;
  transition: background 0.3s ease;
}

button:hover {
  background: #40916c;
}

.message {
  display: none;
  padding: 14px;
  border-radius: 10px;
  margin-top: 10px;
  font-weight: 600;
  text-align: center;
}
.success {
  background: #d1fae5;
  color: #065f46;
}
.error {
  background: #fee2e2;
  color: #991b1b;
}
/* ‚úÖ Confirm Modal Styling */
.confirm-backdrop {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.8);
  backdrop-filter: blur(25px) saturate(180%);
  -webkit-backdrop-filter: blur(25px) saturate(180%);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  animation: fadeIn 0.3s ease;
}

.confirm-box {
  background: #ffffff;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
  text-align: center;
  width: 300px;
  animation: fadeInUp 0.3s ease;
}

.confirm-box h3 {
  margin-bottom: 20px;
  color: #1b4332;
}

.button-group {
  display: flex;
  justify-content: space-between;
}

.confirm-box button {
  padding: 10px 20px;
  font-size: 1em;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  transition: 0.3s;
}

.confirm-box button:first-child {
  background: #52b788;
  color: white;
}
.confirm-box button:first-child:hover {
  background: #40916c;
}
.confirm-box button:last-child {
  background: #ccc;
  color: black;
}
.confirm-box button:last-child:hover {
  background: #aaa;
}

/* üåô Dark Mode Overrides */
body.dark-mode {
  background: linear-gradient(135deg, #121212, #1e1e1e);
  color: #f1f1f1;
}
body.dark-mode .sidebar {
  background: #1f1f1f;
  border-right: 1px solid #333;
  color: #e0e0e0;
}
body.dark-mode .sidebar h2 {
  color: #90ee90;
}
body.dark-mode .sidebar small {
  color: #aaa;
}
body.dark-mode .sidebar a {
  color: #e0e0e0;
}
body.dark-mode .sidebar a:hover,
body.dark-mode .sidebar a.active {
  background: #2d2d2d;
  border-left: 4px solid #52b788;
  color: #90ee90;
}
body.dark-mode .header {
  background: #1c1c1c;
  color: #90ee90;
  border-bottom: 1px solid #2a2a2a;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}
body.dark-mode .content {
  background: #2a2a2a;
}
body.dark-mode .section {
  background: #333;
  color: #f1f1f1;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
}
body.dark-mode select,
body.dark-mode button {
  background-color: #1c1c1c;
  color: #f1f1f1;
  border: 1px solid #555;
}
body.dark-mode .success {
  background: #1d402c;
  color: #90ee90;
}
body.dark-mode .error {
  background: #402020;
  color: #ff6b6b;
}
/* ‚úÖ Dark mode override for Confirm Modal */
body.dark-mode .confirm-box {
  background: #2a2a2a;
  color: #f1f1f1;
}
body.dark-mode .confirm-box h3 {
  color: #f1f1f1;
}
body.dark-mode .confirm-box button:first-child {
  background: #40916c;
}
body.dark-mode .confirm-box button:last-child {
  background: #555;
  color: white;
}
.tab-button {
  background: transparent;
  border: none;
  font-size: 1.2em;
  padding: 12px 24px;
  cursor: pointer;
  color: #1b4332;
  border-bottom: 3px solid transparent;
  font-weight: bold;
  transition: 0.2s ease;
}
.tab-button.active {
  border-bottom: 3px solid #52b788;
  color: #52b788;
}
.tab-button:hover {
  background-color: #e9f5ec;
  border-radius: 8px 8px 0 0;
}


/* üåÄ Animations */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
@keyframes slideInLeft {
  from {
    transform: translateX(-100%);
  }
  to {
    transform: translateX(0);
  }
}

@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}
@media screen and (max-width: 768px) {
  .login-container {
    width: 90%;
  }
}


@keyframes blinkOn {
  0%, 100% { background-color: green; }
  50% { background-color: white; }
}

@keyframes blinkOff {
  0%, 100% { background-color: gray; }
}


@keyframes blinkEffect {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.2; }
}


  @keyframes blinker {
    50% { opacity: 0.4; }
  }



  @keyframes blink {
  0%, 100% { background-color: #b91c1c; }
  50% { background-color: #ef4444; }
}
@keyframes pulse {
  0%, 100% { background-color: #f59e0b; }
  50% { background-color: #fbbf24; }
  
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.03); }
}


/* ======================================================== */
/* === ‚ú® FINAL RESPONSIVE STYLES (for Mobile & Tablet) ‚ú® === */
/* ======================================================== */

/* --- 1. Universal Reset & Debug --- */
/* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏•‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß‡πÜ */
* {
    box-sizing: border-box;
    word-break: break-word; /* ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß‡πÜ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏ô‡∏à‡∏≠ */
}

/* --- 2. Hamburger Menu --- */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ô‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà */
#hamburger-menu {
    display: none;
    background: transparent;
    border: 1px solid #d1d5db;
    font-size: 1.1rem;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    color: #1b4332;
    margin-right: 1rem;
    z-index: 1002;
}

/* --- 3. Tablet View (<= 1024px) --- */
/* ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πà‡∏≠‡∏ô Sidebar */
@media (max-width: 1024px) {
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100%;
        transform: translateX(-100%);
        z-index: 1001;
        transition: transform 0.3s ease-out;
        box-shadow: 5px 0 25px rgba(0,0,0,0.1);
    }
    .sidebar.show {
        transform: translateX(0);
    }
    .main {
        margin-left: 0;
        width: 100%; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Main Content ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÄ‡∏™‡∏°‡∏≠ */
    }
    #hamburger-menu {
        display: block; /* ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π */
    }

    /* ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Header ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Tablet ‚ú® */
    .dashboard-title h1 {
        font-size: 1.8rem; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏•‡∏á */
    }
    .header-left {
        gap: 1rem; /* ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠ */
    }
}
/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô CSS ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ô‡∏≠‡∏Å @media query) */
.table-responsive-wrapper {
    width: 100%;
    overflow-x: auto; /* ‚≠êÔ∏è ‡∏ó‡∏≥‡πÉ‡∏´‡πâ scroll ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÑ‡∏î‡πâ */
    -webkit-overflow-scrolling: touch; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏•‡∏∑‡πà‡∏ô‡∏ö‡∏ô iOS */
    border: 1px solid #e2e8f0;
    border-radius: 16px; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡∏≠‡∏ö‡∏°‡∏ô‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
}

/* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô */
.table-responsive-wrapper .styled-table {
    min-width: 800px; /* ‚≠êÔ∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    border: none; /* ‡πÄ‡∏≠‡∏≤ border ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ wrapper ‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß */
}
/* --- 4. Mobile View (<= 768px) --- */
/* ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏±‡∏ö Layout ‡∏´‡∏•‡∏±‡∏Å‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
@media (max-width: 768px) {
    /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Header ‡πÑ‡∏°‡πà‡πÄ‡∏ö‡∏µ‡∏¢‡∏î‡∏Å‡∏±‡∏ô - ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏π‡πà layout ‡πÄ‡∏î‡∏¥‡∏° */
    .header {
        padding: 1rem;
        flex-wrap: wrap; /* ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
    }
    .header-left, .header-right {
        gap: 1rem;
    }
    .dashboard-title h1 {
        font-size: 1.5rem;
        white-space: normal; /* ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡πÑ‡∏î‡πâ */
    }

    /* ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á Cards ‡πÅ‡∏•‡∏∞ Grid ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
    .summary-cards-new,
    .overview-grid-new,
    .user-stats,
    .user-grid,
    .form-grid,
    .env-grid-new,
    .main-buttons,
    .camera-section {
        grid-template-columns: 1fr !important; /* ‚≠êÔ∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
    }
    /* Additional Mobile Adjustments */
    .search-filter-section, .header-top {
        flex-direction: column;
        align-items: stretch;
    }
    
    .user-stats {
        grid-template-columns: repeat(2, 1fr) !important;
    }
    
    @media (max-width: 480px) {
        .user-stats {
            grid-template-columns: 1fr !important;
        }
        
        .user-table {
            min-width: 500px;
        }
        
        .user-table th,
        .user-table td {
            padding: 0.75rem 0.5rem;
            font-size: 0.9rem;
        }
        
        .filter-group {
            flex-direction: column;
        }
        
        .filter-btn {
            justify-content: center;
        }
        
        .modal-content {
            padding: 1.5rem;
        }
        
        .header-title h2 {
            font-size: 1.5rem;
        }
        
        .stat-info p {
            font-size: 1.75rem;
        }
    }

    /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î Padding ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
    .content, .section, .overview-card-new, .form-container-deluxe, .user-management-page {
        padding: 1rem;
    }
    .summary-card-new {
        padding: 1.25rem;
    }

    /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏•‡πâ‡∏ô‡∏à‡∏≠ ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° scroll ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
    .user-table-container, .table-responsive, [style*="overflow-x:auto"] {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .styled-table {
        min-width: 600px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ scroll ‡πÑ‡∏î‡πâ */
    }
}

/* --- 5. Fine-tuning for Small Phones (<= 480px) --- */
/* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏Ñ‡∏ö‡∏°‡∏≤‡∏Å‡πÜ */
@media (max-width: 480px) {
    .header {
        padding: 0.75rem;
    }
    
    .dashboard-title h1 {
        font-size: 1.1rem;
        line-height: 1.2;
    }
    
    .dashboard-icon {
        width: 32px;
        height: 32px;
    }
    
    .station-dropdown, .user-menu {
        font-size: 0.85rem;
        padding: 8px 12px;
        min-width: 100px;
    }
    
    .header-left, .header-right {
        flex-wrap: wrap;
        justify-content: center;
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö Layout ‡∏Ç‡∏≠‡∏á Summary Card ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏™‡∏∏‡∏î‡πÜ */
    .summary-card-new {
        flex-direction: row;
        align-items: center;
    }
    .card-value-new {
        font-size: 1.8rem;
    }

    /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ */
    .card-title-new h3, .form-title {
        font-size: 1.2rem;
    }
}

/* ‚ú® === MODERN PROFESSIONAL TRAY MASTER STYLES === */
.premium-tray-master-container {
    padding: 1.5rem;
    max-width: 1800px;
    margin: 0 auto;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* ‚ú® Modern Professional Header */
.premium-header-section {
    background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow: 
        0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(226, 232, 240, 0.8);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
}

.premium-header-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 25%, #06b6d4 50%, #10b981 75%, #f59e0b 100%);
    background-size: 300% 100%;
    animation: headerGradientFlow 6s ease-in-out infinite;
}

.premium-header-content {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.premium-icon-wrapper {
    width: 70px;
    height: 70px;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.8rem;
    box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
    position: relative;
    overflow: hidden;
}

.premium-icon-wrapper::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: rotate(45deg);
    animation: iconShine 3s ease-in-out infinite;
}

.premium-header-text h1 {
    margin: 0 0 0.5rem 0;
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #1e293b, #475569);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* ‚ú® Custom Premium Dropdown Styles */
.custom-dropdown-wrapper {
    position: relative;
}

.custom-dropdown {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.dropdown-selected {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
}

.premium-icon {
    color: #3b82f6;
    font-size: 1.1rem;
    min-width: 20px;
    text-align: center;
}

.selected-text {
    flex: 1;
    font-weight: 500;
}

.dropdown-arrow {
    color: #6b7280;
    font-size: 0.9rem;
    transition: transform 0.3s ease;
}

.custom-dropdown.active .dropdown-arrow {
    transform: rotate(180deg);
}

.dropdown-menu {
    position: fixed !important;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    z-index: 10001 !important;
    margin-top: 8px;
    overflow: hidden;
    max-height: 300px;
    overflow-y: auto;
    min-width: 250px;
}

.dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 1px solid #f3f4f6;
}

.dropdown-item:last-child {
    border-bottom: none;
}

.dropdown-item:hover {
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    color: #3b82f6;
}

.dropdown-item:hover .premium-icon {
    color: #2563eb;
    transform: scale(1.1);
}

.dropdown-item span {
    font-weight: 500;
    color: #374151;
}

.dropdown-item:hover span {
    color: #1f2937;
}

.hidden {
    display: none !important;
}

.premium-header-text p {
    margin: 0;
    font-size: 1.1rem;
    color: #64748b;
    font-weight: 500;
}

/* ‚ú® Modern Stats Grid */
.premium-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.25rem;
}

.premium-stat-card {
    background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 12px;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 
        0 4px 6px -1px rgba(0, 0, 0, 0.1), 
        0 2px 4px -1px rgba(0, 0, 0, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(226, 232, 240, 0.6);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.premium-stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.6s ease;
}

.premium-stat-card:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 
        0 12px 25px -5px rgba(0, 0, 0, 0.15), 
        0 8px 15px -5px rgba(0, 0, 0, 0.08);
}

.premium-stat-card:hover::before {
    left: 100%;
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.stat-icon.green { background: linear-gradient(135deg, #10b981, #059669); }
.stat-icon.blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
.stat-icon.orange { background: linear-gradient(135deg, #f59e0b, #d97706); }
.stat-icon.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: #1e293b;
    line-height: 1;
}

.stat-label {
    font-size: 0.9rem;
    color: #64748b;
    font-weight: 500;
    margin-top: 0.25rem;
}

/* ‚ú® Premium Filter Section */
.premium-filter-section {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    border: 1px solid rgba(226, 232, 240, 0.8);
}

.premium-search-bar {
    margin-bottom: 1.5rem;
}

.search-input-wrapper {
    position: relative;
    max-width: 500px;
}

.search-input-wrapper i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    font-size: 1.1rem;
}

.search-input-wrapper input {
    width: 100%;
    padding: 1rem 1rem 1rem 3rem;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 1rem;
    background: #ffffff;
    transition: all 0.3s ease;
}

.search-input-wrapper input:focus {
    outline: none;
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.premium-filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    align-items: end;
}

.premium-filter-item label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #374151;
    font-size: 0.9rem;
}

.premium-select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.95rem;
    background: #ffffff;
    transition: all 0.3s ease;
}

.premium-select:focus {
    outline: none;
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.premium-export-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.premium-export-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

/* ‚ú® Premium Table Section */
.premium-table-container {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    border: 1px solid rgba(226, 232, 240, 0.8);
    overflow: hidden;
}

.premium-table-wrapper {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}

.premium-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

.premium-table thead {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
}

.premium-table th {
    padding: 1.25rem 1rem;
    text-align: left;
    border-bottom: 2px solid #e2e8f0;
    font-weight: 600;
    color: #374151;
    position: relative;
}

.th-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.th-content i {
    color: #10b981;
    font-size: 0.9rem;
}

.premium-table tbody tr {
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.2s ease;
}

.premium-table tbody tr:hover {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

.premium-table td {
    padding: 1rem;
    color: #374151;
}

/* ‚ú® Loading States */
.loading-row td {
    text-align: center;
    padding: 3rem 1rem;
}

.loading-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    color: #6b7280;
}

.loading-spinner {
    width: 24px;
    height: 24px;
    border: 3px solid #e5e7eb;
    border-top: 3px solid #10b981;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ‚ú® Premium Table Cell Styles */
.tray-id-cell, .vegetable-cell, .location-cell {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.tray-id-cell i {
    color: #10b981;
    font-size: 0.9rem;
}

.vegetable-cell i {
    color: #22c55e;
    font-size: 0.9rem;
}

.location-cell i {
    color: #3b82f6;
    font-size: 0.9rem;
}

.quantity-cell {
    font-weight: 600;
    color: #1e293b;
}

.age-cell {
    color: #64748b;
    font-weight: 500;
}

.notes-cell {
    color: #6b7280;
    font-style: italic;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* ‚ú® Premium Status Badge */
.premium-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.8rem;
    font-weight: 600;
    white-space: nowrap;
}

.premium-status-badge i {
    font-size: 0.75rem;
}

/* ‚ú® Action Buttons */
.action-buttons {
    display: flex;
    gap: 0.25rem;
}

.action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    padding: 0.5rem;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 36px;
    height: 36px;
}

.action-btn.edit {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.action-btn.edit:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
}

.action-btn.delete {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.action-btn.delete:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
}

.action-btn.history {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    color: white;
}

.action-btn.history:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
}

/* ‚ú® No Data State */
.no-data-row td {
    text-align: center;
    padding: 3rem 1rem;
}

.no-data-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    color: #6b7280;
}

.no-data-content i {
    font-size: 3rem;
    opacity: 0.5;
}

/* ‚ú® Fade-in Animation */
.fade-in-row {
    opacity: 0;
    animation: fadeInRow 0.5s ease-out forwards;
}

@keyframes fadeInRow {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ‚ú® Responsive Design */
@media (max-width: 768px) {
    .premium-tray-master-container {
        padding: 1rem;
    }
    
    .premium-header-content {
        flex-direction: column;
        text-align: center;
    }
    
    .premium-stats-grid {
        grid-template-columns: 1fr;
    }
    
    .premium-filters-grid {
        grid-template-columns: 1fr;
    }
    
    .premium-header-text h1 {
        font-size: 2rem;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .notes-cell {
        max-width: 100px;
    }
}

/* ‚ú® === PREMIUM SEARCHABLE SELECT === */
.premium-searchable-select {
    position: relative;
}

.dropdown-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #e5e7eb;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.suggestion-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.suggestion-item:hover {
    background: #f3f4f6;
}

.suggestion-item.selected {
    background: #10b981;
    color: white;
}

.suggestion-item i {
    color: #22c55e;
    font-size: 0.9rem;
}

/* ‚ú® === PREMIUM MODAL STYLES === */
.premium-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    animation: overlayFadeIn 0.3s ease-out;
    background: rgba(17, 24, 39, 0.85);
    backdrop-filter: blur(25px) saturate(180%);
    -webkit-backdrop-filter: blur(25px) saturate(180%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    z-index: 9999;
    animation: fadeIn 0.3s ease-out;
}

.premium-modal-container {
    background: white;
    border-radius: 24px;
    width: 100%;
    max-width: 600px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    animation: modalSlideIn 0.4s ease-out;
    overflow: hidden;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* ‚ú® Premium Modal Header */
.premium-modal-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 2rem 2.5rem;
    display: flex;
    align-items: center;
    gap: 2rem;
    border-bottom: 1px solid #e2e8f0;
    position: relative;
}

.premium-modal-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #10b981 0%, #22c55e 50%, #84cc16 100%);
}

.premium-modal-icon-wrapper {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #10b981, #059669);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    flex-shrink: 0;
}

.premium-modal-title-section {
    flex: 1;
    margin-left: 1rem;
}

.premium-modal-title-section h2 {
    margin: 0 0 0.25rem 0;
    font-size: 1.75rem;
    font-weight: 700;
    color: #1e293b;
}

.premium-modal-title-section p {
    margin: 0;
    color: #64748b;
    font-size: 0.95rem;
}

.premium-modal-close {
    width: 40px;
    height: 40px;
    border: none;
    background: #f1f5f9;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #64748b;
}

.premium-modal-close:hover {
    background: #e2e8f0;
    transform: rotate(90deg);
}

/* ‚ú® Premium Modal Body */
.premium-modal-body {
    padding: 2.5rem;
}

.premium-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.premium-form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.premium-form-group.full-width {
    grid-column: 1 / -1;
}

.premium-form-group label {
    font-weight: 600;
    color: #374151;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.premium-form-group label i {
    color: #10b981;
    font-size: 0.85rem;
}

/* ‚ú® Premium Input Wrapper */
.premium-input-wrapper, .premium-textarea-wrapper {
    position: relative;
}

.premium-input, .premium-textarea {
    width: 100%;
   padding: 0.875rem 1rem 0.875rem 4rem; 
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    background: #ffffff;
}

.premium-textarea {
    padding: 1rem;
    resize: vertical;
    min-height: 80px;
}

.premium-input:focus, .premium-textarea:focus {
    outline: none;
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.input-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    font-size: 1rem;
}

/* ‚ú® Premium Modal Footer */
.premium-modal-footer {
    background: #f8fafc;
    padding: 1.5rem 2.5rem;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    border-top: 1px solid #e2e8f0;
}

/* ‚ú® Premium Modal Actions (Base Style) */
.premium-modal-actions {
    background: #f8fafc;
    padding: 1.5rem 2.5rem;
    display: flex;
    justify-content: center;
    gap: 1rem;
    border-top: 1px solid #e2e8f0;
    border-radius: 0 0 24px 24px;
}

/* ‚ú® === PREMIUM PAGE STYLES === */
.premium-page-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
    min-height: 100vh;
}

.premium-page-header {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 24px;
    padding: 2.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    gap: 2rem;
    position: relative;
    overflow: hidden;
}

.premium-page-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #10b981 0%, #22c55e 50%, #84cc16 100%);
}

.premium-page-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #10b981, #059669);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2rem;
    box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
    flex-shrink: 0;
}

.premium-page-title-section {
    flex: 1;
}

.premium-page-title-section h1 {
    margin: 0 0 0.5rem 0;
    font-size: 2.5rem;
    font-weight: 700;
    color: #1e293b;
    background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.premium-page-title-section p {
    margin: 0;
    color: #64748b;
    font-size: 1.1rem;
    font-weight: 500;
}

.premium-page-stats {
    display: flex;
    gap: 2rem;
    flex-shrink: 0;
}

.stat-item {
    text-align: center;
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    border-radius: 16px;
    border: 1px solid #cbd5e1;
}

.stat-label {
    display: block;
    font-size: 0.9rem;
    color: #64748b;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.stat-value {
    display: block;
    font-size: 1.8rem;
    font-weight: 700;
    color: #10b981;
}

.premium-page-content {
    display: grid;
    gap: 2rem;
}

.premium-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 24px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
}

.premium-card-header {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e2e8f0;
}

.premium-card-header h3 {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.premium-card-header h3 i {
    color: #10b981;
}

.premium-card-body {
    padding: 2rem;
}

.loading-container {
    text-align: center;
    padding: 3rem;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e2e8f0;
    border-top: 4px solid #10b981;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-container p {
    color: #64748b;
    font-size: 1rem;
    margin: 0;
}

/* ‚ú® Responsive ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Premium Page */
@media (max-width: 768px) {
    .premium-page-container {
        padding: 1rem;
    }
    
    .premium-page-header {
        flex-direction: column;
        text-align: center;
        padding: 2rem;
    }
    
    .premium-page-stats {
        justify-content: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .stat-item {
        min-width: 120px;
    }
}

/* ‚ú® === TEST BUTTONS STYLES === */
.test-buttons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.btn-test {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    min-height: 60px;
}

.btn-test::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
}

.btn-test:hover::before {
    left: 100%;
}

.btn-test-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.btn-test-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
}

.btn-test-info {
    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
}

.btn-test-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(6, 182, 212, 0.4);
}

.btn-test-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.btn-test-warning:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
}

.btn-test-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-test-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
}

.btn-test:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

/* ‚ú® Test Status Display */
.test-status-display {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid #cbd5e1;
}

.test-progress {
    width: 100%;
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.test-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #10b981 0%, #22c55e 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
    width: 0%;
}

.test-log {
    background: #1e293b;
    color: #e2e8f0;
    padding: 1rem;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    max-height: 200px;
    overflow-y: auto;
    white-space: pre-wrap;
}

.test-log-entry {
    margin-bottom: 0.25rem;
    animation: fadeInUp 0.3s ease;
}

.test-log-success {
    color: #22c55e;
}

.test-log-error {
    color: #ef4444;
}

.test-log-info {
    color: #06b6d4;
}

.test-log-warning {
    color: #f59e0b;
}

/* ‚ú® Cycle Counter */
.cycle-counter {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    border-radius: 12px;
    border: 1px solid #cbd5e1;
}

.cycle-label {
    font-size: 0.9rem;
    color: #64748b;
    font-weight: 500;
}

.cycle-value {
    font-size: 2rem;
    font-weight: 700;
    color: #10b981;
    font-family: 'Courier New', monospace;
    min-width: 60px;
    text-align: center;
}

@media (max-width: 640px) {
    .test-buttons-grid {
        grid-template-columns: 1fr;
    }
    
    .btn-test {
        min-height: 50px;
        font-size: 0.9rem;
    }
    
    .cycle-counter {
        padding: 0.75rem 1rem;
    }
    
    .cycle-value {
        font-size: 1.5rem;
    }
}

/* ‚ú® Premium Buttons */
.premium-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.premium-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
}

.premium-btn:hover::before {
    left: 100%;
}

.premium-btn-primary {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.premium-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
}

.premium-btn-secondary {
    background: #f1f5f9;
    color: #64748b;
    border: 1px solid #e2e8f0;
}

.premium-btn-secondary:hover {
    background: #e2e8f0;
    transform: translateY(-1px);
}

/* ‚ú® Responsive Modal */
@media (max-width: 768px) {
    .premium-modal-container {
        margin: 1rem;
        max-width: none;
    }
    
    .premium-modal-header {
        padding: 1.5rem;
        flex-direction: column;
        text-align: center;
    }
    
    .premium-modal-body {
        padding: 1.5rem;
    }
    
    .premium-form-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .premium-modal-footer {
        padding: 1rem 1.5rem;
        flex-direction: column;
    }
}

/* ‚ú® === DELETE MODAL SPECIFIC STYLES === */
.delete-modal {
    max-width: 500px;
}

.delete-header {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
}

.delete-header::before {
    background: linear-gradient(90deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
}

.delete-icon {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
}

/* ‚ú® === LOGOUT MODAL SPECIFIC STYLES === */
.premium-modal-container.logout-modal {
    max-width: 750px !important;
    min-width: 600px !important;
    animation: logoutModalIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    transform-origin: center;
}

@media (max-width: 768px) {
    .premium-modal-container.logout-modal {
        min-width: auto !important;
        max-width: calc(100vw - 2rem) !important;
    }
}

.logout-header {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fbbf24 100%);
    border-radius: 24px 24px 0 0;
    position: relative;
    overflow: hidden;
}

.logout-header::before {
    background: linear-gradient(90deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
}

.logout-header h3 {
    color: #92400e;
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    text-shadow: 0 1px 2px rgba(146, 64, 14, 0.1);
}

.logout-icon {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
    border: 3px solid rgba(255, 255, 255, 0.2);
    animation: iconPulse 2s ease-in-out infinite;
}

.logout-icon i {
    color: white;
    font-size: 1.5rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    animation: iconRotate 0.6s ease-out 0.3s both;
}

.logout-message {
    text-align: center;
    padding: 1rem 0;
}

.logout-message p {
    font-size: 1.1rem;
    color: #1f2937;
    margin: 0 0 0.5rem 0;
    font-weight: 500;
    animation: fadeInUp 0.6s ease-out 0.2s both;
}

.logout-message small {
    color: #6b7280;
    font-size: 0.9rem;
    line-height: 1.4;
    animation: fadeInUp 0.6s ease-out 0.4s both;
}

/* ‚ú® Logout Modal Actions - Enhanced Button Layout */
.logout-modal .premium-modal-actions {
    padding: 1.5rem 2.5rem 2rem;
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    background: linear-gradient(135deg, #fefefe 0%, #f8fafc 100%);
    border-radius: 0 0 24px 24px;
    border-top: 1px solid rgba(226, 232, 240, 0.5);
}

.logout-modal .premium-btn {
    padding: 1rem 2rem;
    font-size: 1rem;
    font-weight: 600;
    min-width: 140px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.logout-modal .premium-btn-secondary {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    color: #475569;
    border: 1px solid #cbd5e1;
    box-shadow: 0 2px 8px rgba(148, 163, 184, 0.15);
}

.logout-modal .premium-btn-secondary:hover {
    background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(148, 163, 184, 0.25);
}

.logout-modal .premium-btn-danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    border: 1px solid #dc2626;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.logout-modal .premium-btn-danger:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
}

.export-modal .premium-modal-content {
    padding: 1.5rem 2rem;
    overflow-y: auto;
    flex: 1;
    max-height: calc(90vh - 200px);
}

.export-modal .premium-modal-actions {
    padding: 1rem 2rem 1.5rem;
    display: flex;
    gap: 1rem;
    justify-content: center;
    background: #f9fafb;
    border-radius: 0 0 24px 24px;
    flex-shrink: 0;
}

.premium-btn {
    padding: 0.875rem 1.75rem;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    min-width: 120px;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.premium-btn:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    animation: buttonBounce 0.4s ease-out;
}

.premium-btn:active {
    transform: translateY(0) scale(0.98);
    transition: all 0.1s ease;
}

.premium-btn-secondary {
    background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
    color: #475569;
    border: 1px solid #cbd5e1;
}

.premium-btn-secondary:hover {
    background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
    color: #334155;
}

.premium-btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.premium-btn-danger:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
}

@keyframes logoutModalIn {
    0% {
        opacity: 0;
        transform: scale(0.8) translateY(-30px) rotate(-5deg);
    }
    50% {
        transform: scale(1.05) translateY(5px) rotate(1deg);
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0) rotate(0deg);
    }
}

@keyframes iconPulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
    }
    50% {
        transform: scale(1.05);
        box-shadow: 0 12px 30px rgba(245, 158, 11, 0.5);
    }
}

@keyframes iconRotate {
    0% {
        transform: rotate(-10deg) scale(0.8);
        opacity: 0;
    }
    50% {
        transform: rotate(5deg) scale(1.1);
    }
    100% {
        transform: rotate(0deg) scale(1);
        opacity: 1;
    }
}

@keyframes fadeInUp {
    0% {
        opacity: 0;
        transform: translateY(20px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInUp {
    0% {
        opacity: 0;
        transform: translateY(30px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes buttonBounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(-2px) scale(1.02);
    }
    40% {
        transform: translateY(-4px) scale(1.05);
    }
    60% {
        transform: translateY(-1px) scale(1.03);
    }
}

@keyframes overlayFadeIn {
    0% {
        opacity: 0;
        backdrop-filter: blur(0px);
    }
    100% {
        opacity: 1;
        backdrop-filter: blur(8px);
    }
}

/* ‚ú® === EXPORT MODAL SPECIFIC STYLES === */
.export-modal {
    max-width: 700px;
    max-height: 90vh;
    animation: exportModalIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.export-header {
    background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
    border-radius: 24px 24px 0 0;
    position: relative;
    overflow: hidden;
}

.export-header::before {
    background: linear-gradient(90deg, #047857 0%, #059669 50%, #10b981 100%);
}

.export-header h3 {
    color: white;
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

.export-icon {
    background: linear-gradient(135deg, #047857, #059669);
    box-shadow: 0 8px 20px rgba(5, 150, 105, 0.3);
    border: 3px solid rgba(255, 255, 255, 0.2);
    animation: iconGlow 2s ease-in-out infinite;
}

.export-icon i {
    color: white;
    font-size: 1.5rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.export-form {
    padding: 0.5rem 0;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: #374151;
    font-size: 0.9rem;
}

.form-label i {
    color: #10b981;
    width: 16px;
}

.premium-input {
   padding: 0.875rem 1rem 0.875rem 4rem;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.8);
}

.premium-input:focus {
    outline: none;
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    background: white;
}

.export-options {
    background: linear-gradient(135deg, #f0fdfa 0%, #ecfdf5 100%);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid rgba(16, 185, 129, 0.1);
}

.export-options h4 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0 0 1rem 0;
    color: #065f46;
    font-size: 1rem;
    font-weight: 600;
}

.filter-section {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(16, 185, 129, 0.1);
}

.filter-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.section-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: #065f46;
    font-size: 0.95rem;
    margin-bottom: 0.75rem;
}

.section-label i {
    color: #10b981;
    width: 16px;
}

.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.5rem;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-weight: 500;
    color: #374151;
    transition: color 0.3s ease;
    font-size: 0.9rem;
}

.checkbox-item:hover {
    color: #10b981;
}

.checkbox-item input[type="checkbox"] {
    display: none;
}

.checkmark {
    width: 18px;
    height: 18px;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    position: relative;
    transition: all 0.3s ease;
    background: white;
    flex-shrink: 0;
}

.checkbox-item input:checked + .checkmark {
    background: linear-gradient(135deg, #10b981, #059669);
    border-color: #10b981;
}

.checkbox-item input:checked + .checkmark::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.export-preview {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-radius: 8px;
    padding: 0.75rem;
    border: 1px solid rgba(245, 158, 11, 0.2);
}

.preview-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #92400e;
    font-weight: 500;
    font-size: 0.9rem;
}

.preview-info i {
    color: #f59e0b;
}

.premium-btn-success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.premium-btn-success:hover {
    background: linear-gradient(135deg, #059669, #047857);
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
}

@keyframes exportModalIn {
    0% {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

@keyframes iconGlow {
    0%, 100% {
        box-shadow: 0 8px 20px rgba(5, 150, 105, 0.3);
    }
    50% {
        box-shadow: 0 12px 30px rgba(5, 150, 105, 0.5);
    }
}

/* ‚ú® Responsive ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export Modal */
@media (max-width: 1024px) {
    .export-modal {
        max-width: 90vw;
        max-height: 95vh;
    }
    
    .export-modal .premium-modal-content {
        max-height: calc(95vh - 180px);
    }
}

@media (max-width: 768px) {
    .export-modal {
        max-width: 95vw;
        margin: 0.5rem;
    }
    
    .checkbox-grid {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }
    
    .export-modal .premium-modal-content {
        padding: 1rem 1.5rem;
        max-height: calc(95vh - 160px);
    }
    
    .export-modal .premium-modal-actions {
        padding: 0.75rem 1.5rem 1rem;
    }
}

@media (max-width: 640px) {
    .export-modal {
        margin: 0.25rem;
        max-width: calc(100vw - 0.5rem);
    }
    
    .export-header {
        padding: 1rem;
        flex-direction: column;
        text-align: center;
        gap: 0.75rem;
    }
    
    .export-options {
        padding: 0.75rem;
    }
    
    .checkbox-grid {
        grid-template-columns: 1fr;
        gap: 0.5rem;
    }
    
    .export-modal .premium-modal-content {
        padding: 0.75rem 1rem;
        max-height: calc(95vh - 140px);
    }
    
    .filter-section {
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
    }
}

/* ‚ú® Responsive ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Logout Modal */
@media (max-width: 640px) {
    .logout-modal {
        margin: 1rem;
        max-width: none;
        min-width: auto;
    }
    
    .logout-header {
        padding: 1.5rem;
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .premium-modal-content {
        padding: 1.5rem;
    }
    
    .logout-modal .premium-modal-actions {
        padding: 1rem 1.5rem 1.5rem;
        flex-direction: column;
        gap: 1rem;
    }
    
    .logout-modal .premium-btn {
        width: 100%;
        min-width: auto;
        padding: 1.25rem 2rem;
        font-size: 1.05rem;
    }
}

.delete-warning-section {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
}

.warning-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #f59e0b, #d97706);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    flex-shrink: 0;
    animation: warningPulse 2s ease-in-out infinite;
}

@keyframes warningPulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
    }
    50% {
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
    }
}

.warning-content {
    flex: 1;
}

.warning-content h3 {
    margin: 0 0 1rem 0;
    color: #1f2937;
    font-size: 1.25rem;
    font-weight: 600;
}

.tray-info-display {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e5e7eb;
}

.info-item:last-child {
    border-bottom: none;
}

.info-item .label {
    font-weight: 600;
    color: #374151;
    font-size: 0.9rem;
}

.info-item .value {
    color: #1f2937;
    font-weight: 500;
    background: #ffffff;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    border: 1px solid #d1d5db;
}

.delete-consequences {
    background: linear-gradient(135deg, #fef7f0 0%, #fed7aa 100%);
    border: 1px solid #f59e0b;
    border-radius: 12px;
    padding: 1rem;
}

.consequence-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    color: #92400e;
    font-size: 0.9rem;
}

.consequence-item:last-child {
    margin-bottom: 0;
}

.consequence-item i {
    color: #f59e0b;
    font-size: 1rem;
    width: 20px;
    flex-shrink: 0;
}

/* ‚ú® Danger Button */
.premium-btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.premium-btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    background: linear-gradient(135deg, #dc2626, #b91c1c);
}

/* ‚ú® Responsive Delete Modal */
@media (max-width: 768px) {
    .delete-warning-section {
        flex-direction: column;
        text-align: center;
    }
    
    .warning-icon {
        align-self: center;
    }
}

/* ‚ú® === HISTORY MODAL SPECIFIC STYLES === */
.history-modal {
    max-width: 900px;
}

.history-header {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
}

.history-header::before {
    background: linear-gradient(90deg, #8b5cf6 0%, #7c3aed 50%, #6d28d9 100%);
}

.history-icon {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
}

.history-body {
    max-height: 70vh;
    overflow-y: auto;
    padding: 2rem;
}

/* ‚ú® Tray Summary Section */
.tray-summary-section {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.summary-header h3 {
    margin: 0 0 1rem 0;
    color: #1f2937;
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.summary-header h3 i {
    color: #8b5cf6;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.summary-item {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
}

.summary-item .label {
    font-size: 0.8rem;
    color: #6b7280;
    margin-bottom: 0.25rem;
    font-weight: 500;
}

.summary-item .value {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
}

/* ‚ú® Timeline Section */
.timeline-section {
    margin-bottom: 2rem;
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.timeline-header h3 {
    margin: 0;
    color: #1f2937;
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.timeline-header h3 i {
    color: #8b5cf6;
}

.timeline-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.9rem;
}

.timeline-stat {
    background: #f3f4f6;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    text-align: center;
}

.timeline-stat .number {
    font-weight: 600;
    color: #1f2937;
}

.timeline-stat .label {
    color: #6b7280;
    font-size: 0.8rem;
}

.timeline-container {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    max-height: 400px;
    overflow-y: auto;
}

.loading-timeline {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 2rem;
    color: #6b7280;
}

/* ‚ú® Timeline Items */
.timeline-item {
    display: flex;
    margin-bottom: 1.5rem;
    position: relative;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: 20px;
    top: 40px;
    bottom: -20px;
    width: 2px;
    background: #e5e7eb;
}

.timeline-item:last-child::before {
    display: none;
}

.timeline-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.9rem;
    flex-shrink: 0;
    z-index: 1;
    position: relative;
}

.timeline-icon.inbound {
    background: linear-gradient(135deg, #10b981, #059669);
}

.timeline-icon.outbound {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.timeline-icon.edit {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
}

.timeline-icon.system {
    background: linear-gradient(135deg, #6b7280, #4b5563);
}

.timeline-icon.harvest {
    background: linear-gradient(135deg, #22c55e, #16a34a);
}

.timeline-icon.move {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.timeline-icon.transfer {
    background: linear-gradient(135deg, #06b6d4, #0891b2);
}

.timeline-icon.relocate {
    background: linear-gradient(135deg, #f97316, #ea580c);
}

.timeline-content {
    flex: 1;
    margin-left: 1rem;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
}

.timeline-header-info {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.timeline-title {
    font-weight: 600;
    color: #1f2937;
    margin: 0;
}

.timeline-time {
    font-size: 0.8rem;
    color: #6b7280;
}

.timeline-description {
    color: #4b5563;
    font-size: 0.9rem;
    margin: 0;
}

.timeline-details {
    margin-top: 0.5rem;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.timeline-detail {
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    color: #374151;
}

/* ‚ú® Statistics Section */
.stats-section {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 1.5rem;
}

.stats-header h3 {
    margin: 0 0 1rem 0;
    color: #1f2937;
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.stats-header h3 i {
    color: #8b5cf6;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.stat-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    transition: all 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.stat-card .number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

.stat-card .label {
    font-size: 0.8rem;
    color: #6b7280;
    font-weight: 500;
}

/* ‚ú® Responsive History Modal */
@media (max-width: 768px) {
    .timeline-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .timeline-stats {
        width: 100%;
        justify-content: space-between;
    }
    
    .summary-grid, .stats-grid {
        grid-template-columns: 1fr;
    }
}

  </style>
  
</head>

<body>



<div class="timer-modal-backdrop" id="batchScheduleModal">
    <div class="timer-modal-content" style="max-width: 1200px;">
        <h3 class="modal-title">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î LED & FAN ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <p style="color: #64748b; margin-bottom: 20px;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô</p>
        <div id="batchScheduleForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            </div>
        <div class="timer-modal-actions" style="margin-top: 30px;">
            <button class="modal-btn cancel" onclick="closeBatchScheduleModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="modal-btn save is-on" onclick="saveBatchSchedules()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
    </div>
</div>





<!-- ‚úÖ Popup ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
<div id="trayPopup" style="
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: #52b788;
  color: white;
  padding: 16px 26px;
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  font-size: 1.1em;
  font-weight: 600;
  z-index: 9999;
  display: none;
  animation: fadeInUp 0.3s ease;
">
  ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
</div>


<!-- ‚úÖ Modern Excel Export Modal -->
<div id="exportDateModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 hidden" onclick="closeExportModal()">
  <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="exportModalContent" onclick="event.stopPropagation()">
    <!-- Header with Gradient -->
    <div class="bg-gradient-to-r from-green-500 via-emerald-500 to-teal-500 px-8 py-6 rounded-t-3xl">
      <div class="flex items-center space-x-4">
        <div class="bg-white/20 rounded-xl p-3 backdrop-blur-sm">
          <i class="fas fa-file-excel text-2xl text-white"></i>
        </div>
        <div>
          <h2 class="text-2xl font-bold text-white font-thai">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel</h2>
          <p class="text-green-100 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="p-8">
      <div class="space-y-4">
        <!-- All Data Option -->
        <label class="flex items-center p-4 rounded-2xl border-2 border-gray-200 hover:border-green-300 hover:bg-green-50 cursor-pointer transition-all duration-200 group">
          <input type="radio" name="exportRange" value="all" checked onchange="toggleDateInputs()" class="sr-only">
          <div class="flex-shrink-0 w-6 h-6 rounded-full border-2 border-gray-300 group-hover:border-green-500 flex items-center justify-center mr-4 relative">
            <div class="w-3 h-3 rounded-full bg-green-500 opacity-0 scale-0 transition-all duration-200"></div>
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-semibold text-gray-900 font-thai">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <p class="text-sm text-gray-500">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
              </div>
              <div class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm">
                <i class="fas fa-database mr-1"></i>All
              </div>
            </div>
          </div>
        </label>

        <!-- Today Data Option -->
        <label class="flex items-center p-4 rounded-2xl border-2 border-gray-200 hover:border-blue-300 hover:bg-blue-50 cursor-pointer transition-all duration-200 group">
          <input type="radio" name="exportRange" value="today" onchange="toggleDateInputs()" class="sr-only">
          <div class="flex-shrink-0 w-6 h-6 rounded-full border-2 border-gray-300 group-hover:border-blue-500 flex items-center justify-center mr-4 relative">
            <div class="w-3 h-3 rounded-full bg-blue-500 opacity-0 scale-0 transition-all duration-200"></div>
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-semibold text-gray-900 font-thai">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                <p class="text-sm text-gray-500" id="todayDateText">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
              </div>
              <div class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm">
                <i class="fas fa-calendar-day mr-1"></i>Today
              </div>
            </div>
          </div>
        </label>

        <!-- Date Range Option -->
        <label class="flex items-center p-4 rounded-2xl border-2 border-gray-200 hover:border-purple-300 hover:bg-purple-50 cursor-pointer transition-all duration-200 group">
          <input type="radio" name="exportRange" value="range" onchange="toggleDateInputs()" class="sr-only">
          <div class="flex-shrink-0 w-6 h-6 rounded-full border-2 border-gray-300 group-hover:border-purple-500 flex items-center justify-center mr-4 relative">
            <div class="w-3 h-3 rounded-full bg-purple-500 opacity-0 scale-0 transition-all duration-200"></div>
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-semibold text-gray-900 font-thai">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á</h3>
                <p class="text-sm text-gray-500">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
              </div>
              <div class="bg-purple-100 text-purple-600 px-3 py-1 rounded-full text-sm">
                <i class="fas fa-calendar-range mr-1"></i>Custom
              </div>
            </div>
          </div>
        </label>

        <!-- Date Range Picker -->
        <div id="dateRangePicker" class="hidden bg-gradient-to-br from-purple-50 to-indigo-50 rounded-2xl p-6 border border-purple-200 mt-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="startDate" class="block text-sm font-semibold text-gray-700 mb-2 font-thai">
                <i class="fas fa-calendar-alt mr-2 text-purple-600"></i>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
              </label>
              <input 
                type="date" 
                id="startDate" 
                class="w-full px-4 py-3 border border-purple-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 bg-white"
              >
            </div>
            <div>
              <label for="endDate" class="block text-sm font-semibold text-gray-700 mb-2 font-thai">
                <i class="fas fa-calendar-alt mr-2 text-purple-600"></i>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
              </label>
              <input 
                type="date" 
                id="endDate" 
                class="w-full px-4 py-3 border border-purple-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 bg-white"
              >
            </div>
          </div>
          <div class="mt-4 p-3 bg-white rounded-xl border border-purple-200">
            <div class="flex items-center text-sm text-purple-600">
              <i class="fas fa-info-circle mr-2"></i>
              <span class="font-thai">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer Actions -->
    <div class="bg-gray-50 px-8 py-6 rounded-b-3xl flex items-center justify-end space-x-4">
      <button 
        onclick="closeExportModal()" 
        class="px-6 py-3 text-gray-600 font-medium rounded-xl hover:bg-gray-200 transition-all duration-200 font-thai"
      >
        <i class="fas fa-times mr-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </button>
      <button 
        onclick="initiateExport()" 
        class="px-8 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-medium rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg font-thai"
      >
        <i class="fas fa-download mr-2"></i>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
      </button>
    </div>
  </div>
</div>







 <!-- ‚úÖ popup Returun Workstation  -->
<div class="popup-overlay" id="returnTrayModal" style="display: none;">
  <div class="popup-container" style="max-width: 650px;">
    <div class="popup-header">
      <h2 class="popup-title"><i class="fas fa-arrow-left icon"></i> ‡∏™‡πà‡∏á‡∏ñ‡∏≤‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</h2>
    </div>

    <div style="margin-top: 15px; margin-bottom: 25px;">
        <h3 style="font-weight: 600; color: #4B5563; border-bottom: 1px solid #E5E7EB; padding-bottom: 10px; margin-bottom: 20px;">
          <i class="fas fa-edit" style="margin-right: 8px; color: #6B7280;"></i>
          ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
        </h3>
        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="returnVegType">‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</label>
                <input type="text" id="returnVegType" class="form-input-deluxe" readonly style="background-color: #e9ecef; cursor: not-allowed;">
            </div>
            <div class="form-group">
                <label for="returnPlantQuantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô</label>
                <input type="number" id="returnPlantQuantity" class="form-input-deluxe" placeholder="‡πÄ‡∏ä‡πà‡∏ô 16">
            </div>
            <div class="form-group">
                <label for="returnBatchId">Batch ID (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</label>
                <input type="text" id="returnBatchId" class="form-input-deluxe" readonly style="background-color: #e9ecef; cursor: not-allowed;">
            </div>
             <div class="form-group">
                <label for="returnSeedingDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î</label>
                <input type="date" id="returnSeedingDate" class="form-input-deluxe">
            </div>
            <div class="form-group full-width">
                <label for="returnNotes">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <textarea id="returnNotes" class="form-input-deluxe" rows="2" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..."></textarea>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 25px;">
        <h3 style="font-weight: 600; color: #4B5563; border-bottom: 1px solid #E5E7EB; padding-bottom: 10px; margin-bottom: 20px;">
          <i class="fas fa-map-marker-alt" style="margin-right: 8px; color: #6B7280;"></i>
          ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
        </h3>
        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="returnFloor">‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                <select id="returnFloor" class="form-input-deluxe">
                    <option value="1">‡∏ä‡∏±‡πâ‡∏ô 1</option>
                    <option value="2">‡∏ä‡∏±‡πâ‡∏ô 2</option>
                    <option value="3">‡∏ä‡∏±‡πâ‡∏ô 3</option>
                    <option value="4">‡∏ä‡∏±‡πâ‡∏ô 4</option>
                    <option value="5">‡∏ä‡∏±‡πâ‡∏ô 5</option>
                    <option value="6">‡∏ä‡∏±‡πâ‡∏ô 6</option>
                    <option value="7">‡∏ä‡∏±‡πâ‡∏ô 7</option>
                    <option value="8">‡∏ä‡∏±‡πâ‡∏ô 8</option>
                    <option value="9">‡∏ä‡∏±‡πâ‡∏ô 9</option>
                </select>
            </div>
            <div class="form-group">
                <label for="returnSlot">‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</label>
                 <select id="returnSlot" class="form-input-deluxe">
                    <option value="1">‡∏ä‡πà‡∏≠‡∏á 1</option><option value="2">‡∏ä‡πà‡∏≠‡∏á 2</option><option value="3">‡∏ä‡πà‡∏≠‡∏á 3</option>
                    <option value="4">‡∏ä‡πà‡∏≠‡∏á 4</option><option value="5">‡∏ä‡πà‡∏≠‡∏á 5</option><option value="6">‡∏ä‡πà‡∏≠‡∏á 6</option>
                    <option value="7">‡∏ä‡πà‡∏≠‡∏á 7</option><option value="8">‡∏ä‡πà‡∏≠‡∏á 8</option><option value="9">‡∏ä‡πà‡∏≠‡∏á 9</option>
                    <option value="10">‡∏ä‡πà‡∏≠‡∏á 10</option><option value="11">‡∏ä‡πà‡∏≠‡∏á 11</option><option value="12">‡∏ä‡πà‡∏≠‡∏á 12</option>
                    <option value="13">‡∏ä‡πà‡∏≠‡∏á 13</option><option value="14">‡∏ä‡πà‡∏≠‡∏á 14</option><option value="15">‡∏ä‡πà‡∏≠‡∏á 15</option>
                    <option value="16">‡∏ä‡πà‡∏≠‡∏á 16</option><option value="17">‡∏ä‡πà‡∏≠‡∏á 17</option><option value="18">‡∏ä‡πà‡∏≠‡∏á 18</option>
                    <option value="19">‡∏ä‡πà‡∏≠‡∏á 19</option><option value="20">‡∏ä‡πà‡∏≠‡∏á 20</option>
                </select>
            </div>
        </div>
    </div>

    <div class="popup-actions">
        <button class="popup-button cancel" onclick="closeReturnModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="popup-button confirm" onclick="">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
    </div>
  </div>
</div>



 <!-- ‚úÖ popup Tray Master-->
<div class="premium-modal-overlay" id="editTrayModal" style="display: none;">
  <div class="premium-modal-container">
    <!-- ‚ú® Premium Header -->
    <div class="premium-modal-header">
      <div class="premium-modal-icon-wrapper">
        <i class="fas fa-edit"></i>
      </div>
      <div class="premium-modal-title-section">
        <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î</h2>
        <p>‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö WMS</p>
      </div>
      <button class="premium-modal-close" onclick="closeEditModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- ‚ú® Premium Body -->
    <div class="premium-modal-body">
      <input type="hidden" id="editTrayId">
      
      <div class="premium-form-grid">
        <!-- Row 1 -->
        <div class="premium-form-group">
          <label><i class="fas fa-leaf"></i> ‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</label>
          <div class="premium-input-wrapper">
            <input type="text" id="editVegType" class="premium-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å">
            <div class="input-icon"><i class="fas fa-seedling"></i></div>
          </div>
        </div>
        
        <div class="premium-form-group">
          <label><i class="fas fa-sort-numeric-up"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô</label>
          <div class="premium-input-wrapper">
            <input type="number" id="editPlantQuantity" class="premium-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô">
            <div class="input-icon"><i class="fas fa-calculator"></i></div>
          </div>
        </div>
        
        <!-- Row 2 -->
        <div class="premium-form-group">
          <label><i class="fas fa-barcode"></i> Batch ID</label>
          <div class="premium-input-wrapper">
            <input type="text" id="editBatchId" class="premium-input" placeholder="‡∏£‡∏´‡∏±‡∏™ Batch">
            <div class="input-icon"><i class="fas fa-tag"></i></div>
          </div>
        </div>
        
        <div class="premium-form-group">
          <label><i class="fas fa-calendar-alt"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î</label>
          <div class="premium-input-wrapper">
            <input type="date" id="editSeedingDate" class="premium-input">
            <div class="input-icon"><i class="fas fa-calendar"></i></div>
          </div>
        </div>
        
        <!-- Row 3 -->
        <div class="premium-form-group full-width">
          <label><i class="fas fa-sticky-note"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <div class="premium-textarea-wrapper">
            <textarea id="editNotes" class="premium-textarea" rows="3" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..."></textarea>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ‚ú® Premium Footer -->
    <div class="premium-modal-footer">
      <button class="premium-btn premium-btn-secondary" onclick="closeEditModal()">
        <i class="fas fa-times"></i>
        <span>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>
      </button>
      <button class="premium-btn premium-btn-primary" onclick="handleUpdateTray()">
        <i class="fas fa-save"></i>
        <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</span>
      </button>
    </div>
  </div>
</div>

<!-- ‚ú® Premium Delete Confirmation Modal -->
<div class="premium-modal-overlay" id="deleteTrayModal" style="display: none;">
  <div class="premium-modal-container delete-modal">
    <!-- ‚ú® Premium Header -->
    <div class="premium-modal-header delete-header">
      <div class="premium-modal-icon-wrapper delete-icon">
        <i class="fas fa-trash-alt"></i>
      </div>
      <div class="premium-modal-title-section">
        <h2>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ñ‡∏≤‡∏î</h2>
        <p>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
      </div>
      <button class="premium-modal-close" onclick="closeDeleteModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- ‚ú® Premium Body -->
    <div class="premium-modal-body">
      <div class="delete-warning-section">
        <div class="warning-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="warning-content">
          <h3>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ñ‡∏≤‡∏î‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</h3>
          <div class="tray-info-display">
            <div class="info-item">
              <span class="label">Tray ID:</span>
              <span class="value" id="deleteTrayId">-</span>
            </div>
            <div class="info-item">
              <span class="label">‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å:</span>
              <span class="value" id="deleteTrayVeg">-</span>
            </div>
            <div class="info-item">
              <span class="label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</span>
              <span class="value" id="deleteTrayLocation">-</span>
            </div>
          </div>
          <div class="delete-consequences">
            <div class="consequence-item">
              <i class="fas fa-database"></i>
              <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            </div>
            <div class="consequence-item">
              <i class="fas fa-history"></i>
              <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö</span>
            </div>
            <div class="consequence-item">
              <i class="fas fa-chart-line"></i>
              <span>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ‚ú® Premium Footer -->
    <div class="premium-modal-footer">
      <button class="premium-btn premium-btn-secondary" onclick="closeDeleteModal()">
        <i class="fas fa-times"></i>
        <span>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>
      </button>
      <button class="premium-btn premium-btn-danger" onclick="confirmDeleteTray()">
        <i class="fas fa-trash"></i>
        <span>‡∏•‡∏ö‡∏ñ‡∏≤‡∏î</span>
      </button>
    </div>
  </div>
</div>

<!-- ‚ú® Premium Tray History Modal -->
<div class="premium-modal-overlay" id="trayHistoryModal" style="display: none;">
  <div class="premium-modal-container history-modal">
    <!-- ‚ú® Premium Header -->
    <div class="premium-modal-header history-header">
      <div class="premium-modal-icon-wrapper history-icon">
        <i class="fas fa-history"></i>
      </div>
      <div class="premium-modal-title-section">
        <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ñ‡∏≤‡∏î</h2>
        <p id="historyTrayInfo">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÅ‡∏•‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
      </div>
      <button class="premium-modal-close" onclick="closeHistoryModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- ‚ú® Premium Body -->
    <div class="premium-modal-body history-body">
      <!-- Tray Summary Section -->
      <div class="tray-summary-section">
        <div class="summary-header">
          <h3><i class="fas fa-info-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î</h3>
        </div>
        <div class="summary-grid" id="traySummaryData">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
      
      <!-- Timeline Section -->
      <div class="timeline-section">
        <div class="timeline-header">
          <h3><i class="fas fa-clock"></i> ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
          <div class="timeline-stats" id="timelineStats">
            <!-- Stats will be populated -->
          </div>
        </div>
        <div class="timeline-container" id="historyTimeline">
          <div class="loading-timeline">
            <div class="loading-spinner"></div>
            <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</span>
          </div>
        </div>
      </div>
      
      <!-- Statistics Section -->
      <div class="stats-section">
        <div class="stats-header">
          <h3><i class="fas fa-chart-bar"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3>
        </div>
        <div class="stats-grid" id="trayStats">
          <!-- Will be populated -->
        </div>
      </div>
    </div>
    
    <!-- ‚ú® Premium Footer -->
    <div class="premium-modal-footer">
      <button class="premium-btn premium-btn-secondary" onclick="closeHistoryModal()">
        <i class="fas fa-times"></i>
        <span>‡∏õ‡∏¥‡∏î</span>
      </button>
      <button class="premium-btn premium-btn-primary" onclick="exportTrayHistory()">
        <i class="fas fa-download"></i>
        <span>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
      </button>
    </div>
  </div>
</div>

  <!-- ‚úÖ popup tray inventroy-->
  <div id="trayInfoPopup" class="tray-popup-backdrop" style="display: none;">
  <div class="tray-popup-card">
    <h3><i class="fas fa-boxes"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î</h3>
    <div id="trayInfoContent"></div>
    <button onclick="closeTrayInfoPopup()"><i class="fas fa-times-circle"></i> ‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

 
 <div id="toast" class="toast"></div>


 
  <!-- ‚úÖ ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ai -->
  <video autoplay muted loop id="loginVideo" playsinline>
    <source src="vidu-video-2763632902164823.mp4" type="video/mp4">
  </video>


  

<div id="loginPage" class="login-container">
  <img src="agrotech-logo.png" class="logo" />
  <div class="form-box">
    <div class="input-group">
      <i class="fas fa-user"></i>
      <input type="text" id="username" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" 
             aria-label="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" aria-required="true" autocomplete="username" tabindex="1" />
    </div>
    <div class="input-group">
      <i class="fas fa-key"></i>
      <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" 
             aria-label="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" aria-required="true" autocomplete="current-password" tabindex="2" />
    </div>
    <button onclick="login()" aria-describedby="loginMsg" tabindex="3">Sign In</button>
    <div id="loginMsg" class="message"></div>
  </div>
</div>

</div>


<!-- ‚úÖ Modal ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô -->
<div id="changeBox" class="confirm-backdrop" style="display: none;">
  <div class="confirm-box" style="
    max-width: 400px;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    background: #ffffff;
    text-align: center;
    font-family: 'Prompt', sans-serif;
  ">
    <h3 style="font-size: 1.6em; color: #1b4332; display: flex; justify-content: center; align-items: center; gap: 10px;">
      <i class="fa-solid fa-key"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
    </h3>

    <div style="display: flex; flex-direction: column; gap: 16px; margin-top: 25px;">
      <input id="changeUser" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏î‡∏¥‡∏°" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
      <input id="oldPass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
      <input id="newPass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
    </div>

    <div class="button-group" style="margin-top: 30px; display: flex; gap: 16px; justify-content: center;">
      <button onclick="changePassword()" style="
        padding: 12px 24px;
        background: #52b788;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#40916c'" onmouseout="this.style.background='#52b788'">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà
      </button>
      <button onclick="closeChangePassword()" style="
        padding: 12px 24px;
        background: #e2e8f0;
        color: #333;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#cbd5e1'" onmouseout="this.style.background='#e2e8f0'">
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </button>
    </div>

    <div id="changeMsg" class="message" style="
      margin-top: 20px;
      font-weight: 500;
      color: #991b1b;
      display: none;
    "></div>
  </div>
</div>


<!-- ‚úÖ Dete USENAME -->
<div id="deleteBox" class="confirm-backdrop" style="display: none;">
  <div class="confirm-box" style="
    max-width: 400px;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    background: #ffffff;
    text-align: center;
    font-family: 'Prompt', sans-serif;
  ">
    <h3 style="font-size: 1.6em; color: #1b4332; display: flex; justify-content: center; align-items: center; gap: 10px;">
      <i class="fa-solid fa-user-slash"></i> ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    </h3>

    <p style="margin: 18px 0 25px; color: #555; font-size: 0.95em;">
      ‡πÇ‡∏õ‡∏£‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ
    </p>

    <div style="display: flex; flex-direction: column; gap: 16px;">
      <input id="deleteUser" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
      <input id="deletePass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" style="
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1em;
      " />
    </div>

    <div class="button-group" style="margin-top: 30px; display: flex; gap: 16px; justify-content: center;">
      <button onclick="deleteAccount()" style="
        padding: 12px 24px;
        background: #e63946;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#e63946'">
        ‚ùå ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ
      </button>
      <button onclick="closeDeleteBox()" style="
        padding: 12px 24px;
        background: #e2e8f0;
        color: #333;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      " onmouseover="this.style.background='#cbd5e1'" onmouseout="this.style.background='#e2e8f0'">
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </button>
    </div>

    <div id="deleteMsg" class="message" style="
      margin-top: 20px;
      font-weight: 500;
      color: #991b1b;
      display: none;
    "></div>
  </div>
</div>


<!-- ‚ú® Export User Logs Modal -->
<div id="exportLogsModal" class="premium-modal-overlay" style="display: none;">
  <div class="premium-modal-container export-modal">
    <!-- ‚ú® Premium Header -->
    <div class="premium-modal-header export-header">
      <div class="premium-modal-icon-wrapper export-icon">
        <i class="fas fa-file-excel"></i>
      </div>
      <h3>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô User Logs</h3>
      <button class="premium-modal-close" onclick="closeExportLogsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- ‚ú® Premium Content -->
    <div class="premium-modal-content">
      <div class="export-form">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-calendar-alt"></i>
              ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            </label>
            <input type="date" id="exportStartDate" class="premium-input" />
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-calendar-check"></i>
              ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
            </label>
            <input type="date" id="exportEndDate" class="premium-input" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-clock"></i>
              ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            </label>
            <input type="time" id="exportStartTime" class="premium-input" value="00:00" />
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-clock"></i>
              ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
            </label>
            <input type="time" id="exportEndTime" class="premium-input" value="23:59" />
          </div>
        </div>
        
        <div class="export-options">
          <h4><i class="fas fa-filter"></i> ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á</h4>
          
          <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Log -->
          <div class="filter-section">
            <label class="section-label">
              <i class="fas fa-tags"></i>
              ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥
            </label>
            <div class="checkbox-grid">
              <label class="checkbox-item">
                <input type="checkbox" id="typeLogin" checked>
                <span class="checkmark"></span>
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
              </label>
              <label class="checkbox-item">
                <input type="checkbox" id="typeLogout" checked>
                <span class="checkmark"></span>
                ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
              </label>
              <label class="checkbox-item">
                <input type="checkbox" id="typeInbound" checked>
                <span class="checkmark"></span>
                ‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤
              </label>
              <label class="checkbox-item">
                <input type="checkbox" id="typeOutbound" checked>
                <span class="checkmark"></span>
                ‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å
              </label>
              <label class="checkbox-item">
                <input type="checkbox" id="typeManualControl" checked>
                <span class="checkmark"></span>
                ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
              </label>
              <label class="checkbox-item">
                <input type="checkbox" id="typeHarvest" checked>
                <span class="checkmark"></span>
                ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß
              </label>
              <label class="checkbox-item">
                <input type="checkbox" id="typeSystem" checked>
                <span class="checkmark"></span>
                ‡∏£‡∏∞‡∏ö‡∏ö
              </label>
              <label class="checkbox-item">
                <input type="checkbox" id="typeOther" checked>
                <span class="checkmark"></span>
                ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
              </label>
            </div>
          </div>
          
          <!-- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
          <div class="filter-section">
            <label class="section-label">
              <i class="fas fa-users"></i>
              ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            </label>
            <div class="checkbox-group">
              <label class="checkbox-item">
                <input type="checkbox" id="includeAllUsers" checked>
                <span class="checkmark"></span>
                ‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              </label>
              <label class="checkbox-item">
                <input type="checkbox" id="includeAdminOnly">
                <span class="checkmark"></span>
                ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin
              </label>
              <label class="checkbox-item">
                <input type="checkbox" id="includeUserOnly">
                <span class="checkmark"></span>
                ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ User ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
              </label>
            </div>
          </div>
          
          <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
          <div class="filter-section">
            <label class="section-label">
              <i class="fas fa-cog"></i>
              ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
            </label>
            <div class="checkbox-group">
              <label class="checkbox-item">
                <input type="checkbox" id="includeDetails" checked>
                <span class="checkmark"></span>
                ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ä‡∏±‡πâ‡∏ô, ‡∏ä‡πà‡∏≠‡∏á, ‡∏ú‡∏±‡∏Å)
              </label>
              <label class="checkbox-item">
                <input type="checkbox" id="groupByUser">
                <span class="checkmark"></span>
                ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
              </label>
            </div>
          </div>
        </div>
        
        <div class="export-preview">
          <div class="preview-info">
            <i class="fas fa-info-circle"></i>
            <span id="exportPreviewText">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ‚ú® Premium Actions -->
    <div class="premium-modal-actions">
      <button class="premium-btn premium-btn-secondary" onclick="closeExportLogsModal()">
        <i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </button>
      <button class="premium-btn premium-btn-success" onclick="executeExportLogs()">
        <i class="fas fa-download"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
      </button>
    </div>
  </div>
</div>

<!-- ‚ú® Premium Logout Confirmation Modal -->
<div id="logoutBox" class="premium-modal-overlay" style="display: none;">
  <div class="premium-modal-container logout-modal">
    <!-- ‚ú® Premium Header -->
    <div class="premium-modal-header logout-header">
      <div class="premium-modal-icon-wrapper logout-icon">
        <i class="fas fa-sign-out-alt"></i>
      </div>
      <h3>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</h3>
    </div>
    
    <!-- ‚ú® Premium Content -->
    <div class="premium-modal-content">
      <div class="logout-message">
        <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
        <small>‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</small>
      </div>
    </div>
    
    <!-- ‚ú® Premium Actions -->
    <div class="premium-modal-actions">
      <button class="premium-btn premium-btn-secondary" onclick="closeLogoutBox()">
        <i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </button>
      <button class="premium-btn premium-btn-danger" onclick="confirmLogout()">
        <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    </div>
  </div>
</div>





<!-- ‚úÖ CONFIRM MODAL -->
<div id="confirmModal" class="confirm-backdrop" style="display:none;">
  <div class="confirm-box">
    <h3 id="confirmText">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</h3>
    <div class="button-group">
      <button onclick="confirmAction(true)">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      <button onclick="confirmAction(false)">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>

<!-- ‚úÖ VALVE CONTROL CONFIRM MODAL -->
<div id="valveConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center" style="display:none;">
  <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="valveModalContent">
    <!-- Header -->
    <div class="relative overflow-hidden rounded-t-3xl">
      <div id="valveModalHeader" class="px-8 py-6 bg-gradient-to-r from-blue-500 to-cyan-500">
        <div class="flex items-center justify-center">
          <div id="valveModalIcon" class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4">
            <i class="fas fa-droplet text-3xl text-white"></i>
          </div>
          <div class="text-center">
            <h3 id="valveModalTitle" class="text-xl font-bold text-white">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ß‡∏≤‡∏•‡πå‡∏ß</h3>
            <p class="text-blue-100 text-sm mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Content -->
    <div class="px-8 py-6">
      <div class="text-center mb-6">
        <div id="valveModalDetails" class="bg-gray-50 rounded-2xl p-4 mb-4">
          <div class="flex items-center justify-center mb-2">
            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
              <i class="fas fa-map-marker-alt text-blue-600 text-sm"></i>
            </div>
            <span id="valveModalLocation" class="font-semibold text-gray-800">‡∏ä‡∏±‡πâ‡∏ô 1 ‡∏ß‡∏≤‡∏•‡πå‡∏ß 1</span>
          </div>
          <div class="flex items-center justify-center">
            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
              <i class="fas fa-info-circle text-green-600 text-sm"></i>
            </div>
            <span id="valveModalStatus" class="text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‡∏õ‡∏¥‡∏î</span>
          </div>
        </div>
        <p id="valveModalMessage" class="text-gray-700 text-lg">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
      </div>
    </div>
    
    <!-- Actions -->
    <div class="px-8 pb-6">
      <div class="flex space-x-3">
        <button 
          id="valveModalCancel" 
          class="flex-1 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-2xl transition-all duration-200 transform hover:scale-105"
          onclick="closeValveConfirmModal(false)">
          <i class="fas fa-times mr-2"></i>
          ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
        <button 
          id="valveModalConfirm" 
          class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-semibold rounded-2xl transition-all duration-200 transform hover:scale-105 shadow-lg"
          onclick="closeValveConfirmModal(true)">
          <i id="valveModalConfirmIcon" class="fas fa-check mr-2"></i>
          <span id="valveModalConfirmText">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î</span>
        </button>
      </div>
    </div>
  </div>
</div>






<!-- ‚úÖ DASHBOARD PAGE -->
<div id="dashboardPage" style="display: none; flex-direction: row; width: 100vw; height: 100vh;">

  <!-- Sidebar -->
  <div class="sidebar">
    
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="agrotech-logo.png" alt="Logo" class="sidebar-logo">
    </div>

    <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° data-page ‡πÅ‡∏•‡∏∞‡∏•‡∏ö class="active" ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å -->
    <a href="#" data-page="overview" class="active" onclick="showPage('overview', event)"><i class="fas fa-home"></i> Overview</a>
    <a href="#" data-page="planting-plan" onclick="showPage('planting-plan', event)"><i class="fas fa-seedling"></i> Planting Plan</a>
    <a href="#" data-page="lift" onclick="showPage('lift', event)"><i class="fas fa-arrow-up-wide-short"></i> Lift Control</a>
    <a href="#" data-page="agv" onclick="showPage('agv', event)"><i class="fas fa-truck-moving"></i> RGV Control</a>
    <a href="#" data-page="image-processing" onclick="showPage('image-processing', event)"><i class="fas fa-camera"></i> Image Processing</a>
    <a href="#" data-page="light-control" onclick="showPage('light-control', event)"><i class="fas fa-lightbulb"></i> Light Control </a>
    <a href="#" data-page="watering-system" onclick="showPage('watering-system', event)"><i class="fas fa-tint"></i> Watering System</a>
    <a href="#" data-page="tray-inbound" onclick="showPage('tray-inbound', event)"><i class="fas fa-arrow-down"></i> Tray Inbound</a>
    <a href="#" data-page="tray-outbound" onclick="showPage('tray-outbound', event)"><i class="fas fa-arrow-up"></i> Tray Outbound</a>
    <a href="#" data-page="workstation" onclick="showPage('workstation', event)"><i class="fas fa-dolly"></i> Workstation</a>
    <a href="#" data-page="tray-master" onclick="showPage('tray-master', event)"><i class="fas fa-database"></i> Tray Master</a>
    <a href="#" data-page="task" onclick="showPage('task', event)"><i class="fas fa-tasks"></i> Task Monitor</a>
    <a href="#" data-page="task-history" onclick="showPage('task-history', event)"><i class="fas fa-clipboard-list"></i> Task History</a>
    <a href="#" data-page="system" onclick="showPage('system', event)"><i class="fas fa-chart-line"></i> System Monitor</a>
    <a href="#" data-page="tray-map" onclick="showPage('tray-map', event)"><i class="fas fa-boxes"></i> Tray Inventory</a>
    <a href="#" data-page="environment" onclick="showPage('environment', event)"><i class="fas fa-chart-line"></i> Environmental</a>
  
    <a href="#" data-page="user-logs" onclick="showPage('user-logs', event)"><i class="fas fa-terminal"></i> User Logs</a>
    <a href="#" data-page="user-management" onclick="showPage('user-management', event)"><i class="fas fa-users-cog"></i> User Management</a>
   <a href="#" data-page="MonitorSensor" onclick="showPage('MonitorSensor', event)"><i class="fas fa-microchip"></i> MonitorSensor</a>

  </div>


  <!-- Main -->
<div class="main">
 <div class="header">
    <div class="header-left">
          <button id="hamburger-menu">
        <i class="fas fa-bars"></i>
    </button>
        <div class="dashboard-title">
            <img src="wms-dashboard-icon.png" alt="WMS Icon" class="dashboard-icon">
            <h1>PFAL WMS Dashboard</h1>
        </div>
        <select id="stationSelect" onchange="onStationChange()" class="station-dropdown">
            <option value="1">Station 1</option>
            <option value="2">Station 2</option>
            <option value="3">Station 3</option>
            <option value="4">Station 4</option>
            <option value="5">Station 5</option>
        </select>
    </div>

    <div class="header-right">
        <div class="user-wrapper" id="userWrapper">
            <div class="user-menu" id="currentUser">
                <i class="fas fa-user"></i>
                <span id="usernameDisplay">IT</span> <i class="fas fa-caret-down" style="font-size: 0.8em; margin-left: 4px;"></i>
            </div>
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-item" id="toggleTheme"><i class="fas fa-moon"></i> <span>Dark Mode</span></div>
                <div class="dropdown-item" onclick="showLogoutBox()"><i class="fas fa-sign-out-alt"></i> <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></div>
            </div>
        </div>
    </div>
</div>


  <!-- ‚úÖ Content Area for each page (loaded dynamically) -->
  <div class="content" id="mainContent"></div>
</div> <!-- ‚úÖ END of dashboardPage -->






<script>



/* ================================================================================================
   üíæ JAVASCRIPT - AGROTECH WMS APPLICATION
   ================================================================================================ */

// ‚úÖ Global Timer Management System ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Memory Leaks
let activeTimers = new Set();
let activeIntervals = new Set();

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á timeout ‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
function createTimeout(callback, delay) {
  const id = setTimeout(() => {
    activeTimers.delete(id);
    callback();
  }, delay);
  activeTimers.add(id);
  return id;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á interval ‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°  
function createInterval(callback, delay) {
  const id = setInterval(callback, delay);
  activeIntervals.add(id);
  return id;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö timer ‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏≤‡∏™‡∏°‡∏±‡∏¢
function cleanupExpiredTimers() {
  const cleanupCount = activeTimers.size + activeIntervals.size;
  if (cleanupCount > 50) { // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ timer ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 50 ‡∏ï‡∏±‡∏ß
    console.warn(`‚ö†Ô∏è Timer count is high: ${cleanupCount} - consider cleaning up`);
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î timer ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function stopAllTimers() {
  
  // ‡∏´‡∏¢‡∏∏‡∏î timeouts
  activeTimers.forEach(id => {
    clearTimeout(id);
  });
  activeTimers.clear();
  
  // ‡∏´‡∏¢‡∏∏‡∏î intervals
  activeIntervals.forEach(id => {
    clearInterval(id);
  });
  activeIntervals.clear();
  
  // ‡∏´‡∏¢‡∏∏‡∏î pollers (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  if (typeof stopAllPollers === 'function') {
    stopAllPollers();
  }
  
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î timer ‡πÄ‡∏â‡∏û‡∏≤‡∏∞
function stopTimer(id) {
  if (activeTimers.has(id)) {
    clearTimeout(id);
    activeTimers.delete(id);
  }
  if (activeIntervals.has(id)) {
    clearInterval(id);
    activeIntervals.delete(id);
  }
}

// ‚úÖ Session Management System
let sessionTimeout = null;
const SESSION_DURATION = 8 * 60 * 60 * 1000; // 8 hours
const WARNING_TIME = 10 * 60 * 1000; // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô 10 ‡∏ô‡∏≤‡∏ó‡∏µ

function startSessionTimer() {
  // ‡∏•‡πâ‡∏≤‡∏á timer ‡πÄ‡∏Å‡πà‡∏≤
  if (sessionTimeout) {
    clearTimeout(sessionTimeout);
  }
  
  // ‡∏ï‡∏±‡πâ‡∏á session timeout ‡πÉ‡∏´‡∏°‡πà
  sessionTimeout = createTimeout(() => {
    showSessionExpired();
  }, SESSION_DURATION);
  
  // ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ 10 ‡∏ô‡∏≤‡∏ó‡∏µ
  createTimeout(() => {
    const remaining = Math.floor(WARNING_TIME / 60000);
    showSessionWarning(remaining);
  }, SESSION_DURATION - WARNING_TIME);
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
  localStorage.setItem("sessionStart", Date.now().toString());
  
}

function renewSession() {
  startSessionTimer();
}

function checkSessionValidity() {
  const sessionStart = localStorage.getItem("sessionStart");
  const loggedIn = localStorage.getItem("loggedIn");
  
  if (loggedIn === "true" && sessionStart) {
    const elapsed = Date.now() - parseInt(sessionStart);
    
    if (elapsed > SESSION_DURATION) {
      logout();
      return false;
    } else {
      const remaining = SESSION_DURATION - elapsed;
      return true;
    }
  }
  
  return false;
}

// ‡∏ï‡πà‡∏≠ session ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥
function renewSessionOnActivity() {
  const loggedIn = localStorage.getItem("loggedIn");
  if (loggedIn === "true") {
    renewSession();
  }
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠ session
document.addEventListener("click", renewSessionOnActivity);
document.addEventListener("keypress", renewSessionOnActivity);

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö timer cleanup ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
createInterval(cleanupExpiredTimers, 30000);

// ===== INPUT VALIDATION FUNCTIONS =====
const ValidationUtils = {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö format ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
  isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  },
  
  isValidNumber(value, min = null, max = null) {
    const num = Number(value);
    if (isNaN(num)) return false;
    if (min !== null && num < min) return false;
    if (max !== null && num > max) return false;
    return true;
  },
  
  isValidString(value, minLength = 1, maxLength = 255) {
    if (typeof value !== 'string') return false;
    if (value.length < minLength || value.length > maxLength) return false;
    return true;
  },
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏∞‡∏ö‡∏ö WMS
  isValidFloor(floor) {
    return this.isValidNumber(floor, 1, 10); // ‡∏ä‡∏±‡πâ‡∏ô 1-10
  },
  
  isValidSlot(slot) {
    return this.isValidNumber(slot, 1, 100); // ‡∏ä‡πà‡∏≠‡∏á 1-100
  },
  
  isValidQuantity(quantity) {
    return this.isValidNumber(quantity, 1, 10000);
  },
  
  isValidBatchId(batchId) {
    const batchRegex = /^[A-Z0-9\-]{3,20}$/; // ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡∏ç‡πà ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÅ‡∏•‡∏∞ - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß 3-20
    return batchRegex.test(batchId);
  },
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö SQL injection
  isSafeInput(input) {
    const dangerousChars = /['";<>{}()]/;
    return !dangerousChars.test(input);
  },
  
  // Sanitize input
  sanitizeInput(input) {
    if (typeof input !== 'string') return input;
    return input.replace(/['";<>{}()]/g, '').trim();
  }
};

// ===== DOM UTILITY FUNCTIONS =====
function safeGetElementValue(id, defaultValue = '') {
  const element = document.getElementById(id);
  if (!element) {
    console.warn(`‚ö†Ô∏è Element with id '${id}' not found`);
    return defaultValue;
  }
  return element.value || defaultValue;
}

function safeGetElement(id) {
  const element = document.getElementById(id);
  if (!element) {
    console.warn(`‚ö†Ô∏è Element with id '${id}' not found`);
  }
  return element;
}

function safeSetElementValue(id, value) {
  const element = document.getElementById(id);
  if (element) {
    element.value = value;
  } else {
    console.warn(`‚ö†Ô∏è Cannot set value for element '${id}' - not found`);
  }
}

function sanitizeHTML(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function safeSetElementHTML(id, html, sanitize = true) {
  const element = document.getElementById(id);
  if (element) {
    element.innerHTML = sanitize ? sanitizeHTML(html) : html;
  } else {
    console.warn(`‚ö†Ô∏è Cannot set HTML for element '${id}' - not found`);
  }
}

function safeSetElementText(id, text) {
  const element = document.getElementById(id);
  if (element) {
    element.textContent = text;
  } else {
    console.warn(`‚ö†Ô∏è Cannot set text for element '${id}' - not found`);
  }
}

// ===== SESSION POPUP FUNCTIONS =====
function showSessionPopup(type, title, message, buttons) {
  // ‡∏•‡∏ö popup ‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  const existingPopup = document.querySelector('.session-popup-backdrop');
  if (existingPopup) {
    existingPopup.remove();
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á popup ‡πÉ‡∏´‡∏°‡πà
  const backdrop = document.createElement('div');
  backdrop.className = 'session-popup-backdrop';
  
  const iconClass = type === 'warning' ? 'fas fa-clock' : 'fas fa-exclamation-triangle';
  const iconType = type === 'warning' ? 'warning' : '';
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á elements ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
  const popup = document.createElement('div');
  popup.className = 'session-popup';
  
  const icon = document.createElement('div');
  icon.className = `session-popup-icon ${iconType}`;
  icon.innerHTML = `<i class="${iconClass}"></i>`;
  
  const titleEl = document.createElement('h2');
  titleEl.className = 'session-popup-title';
  titleEl.textContent = title;
  
  const messageEl = document.createElement('p');
  messageEl.className = 'session-popup-message';
  messageEl.textContent = message;
  
  const buttonsEl = document.createElement('div');
  buttonsEl.className = 'session-popup-buttons';
  buttonsEl.innerHTML = buttons; // buttons ‡∏°‡∏≤‡∏à‡∏≤‡∏Å function ‡πÄ‡∏≠‡∏á ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
  
  popup.appendChild(icon);
  popup.appendChild(titleEl);
  popup.appendChild(messageEl);
  popup.appendChild(buttonsEl);
  backdrop.appendChild(popup);

  document.body.appendChild(backdrop);
  
  // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô
  backdrop.style.display = 'flex';
  setTimeout(() => backdrop.classList.add('show'), 10);
  
  return backdrop;
}

function hideSessionPopup(backdrop) {
  backdrop.classList.remove('show');
  setTimeout(() => {
    if (backdrop.parentNode) {
      backdrop.parentNode.removeChild(backdrop);
    }
  }, 300);
}

function showSessionWarning(remainingMinutes) {
  const buttons = `
    <button class="session-popup-btn primary" onclick="handleSessionExtend(this)">
      <i class="fas fa-clock"></i> ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏ Session
    </button>
    <button class="session-popup-btn secondary" onclick="handleSessionCancel(this)">
      <i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  `;
  
  showSessionPopup(
    'warning',
    'Session ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏',
    `Session ‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô ${remainingMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠ session ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
    buttons
  );
}

function showSessionExpired() {
  const buttons = `
    <button class="session-popup-btn danger" onclick="handleSessionExpired(this)">
      <i class="fas fa-sign-out-alt"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
    </button>
  `;
  
  showSessionPopup(
    'expired',
    'Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß',
    '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠',
    buttons
  );
}

function handleSessionExtend(button) {
  const backdrop = button.closest('.session-popup-backdrop');
  hideSessionPopup(backdrop);
  renewSession();
}

function handleSessionCancel(button) {
  const backdrop = button.closest('.session-popup-backdrop');
  hideSessionPopup(backdrop);
}

function handleSessionExpired(button) {
  const backdrop = button.closest('.session-popup-backdrop');
  hideSessionPopup(backdrop);
  logout();
}

// ‚úÖ Enhanced Error Handling System
class WMSError extends Error {
  constructor(message, type = 'GENERAL', details = null) {
    super(message);
    this.name = 'WMSError';
    this.type = type;
    this.details = details;
    this.timestamp = new Date().toISOString();
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô fetch ‡∏ó‡∏µ‡πà‡∏°‡∏µ error handling ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°
async function safeFetch(url, options = {}) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout
  
  try {
    
    const response = await fetch(url, {
      ...options,
      signal: controller.signal,
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      }
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      const errorText = await response.text();
      throw new WMSError(
        `HTTP ${response.status}: ${response.statusText}`,
        'HTTP_ERROR',
        { url, status: response.status, response: errorText }
      );
    }

    const data = await response.json();
    return data;

  } catch (error) {
    clearTimeout(timeoutId);
    
    if (error.name === 'AbortError') {
      throw new WMSError('Request timeout', 'TIMEOUT', { url });
    }
    
    if (error instanceof WMSError) {
      throw error;
    }
    
    throw new WMSError(
      `Network error: ${error.message}`,
      'NETWORK_ERROR',
      { url, originalError: error.message }
    );
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á error ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
function showUserFriendlyError(error) {
  let userMessage = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ error ‡πÄ‡∏õ‡πá‡∏ô object ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (!error) {
    console.warn('‚ö†Ô∏è showUserFriendlyError called with null/undefined error');
    showNotification(userMessage, 'error');
    return;
  }
  
  if (error instanceof WMSError) {
    switch (error.type) {
      case 'TIMEOUT':
        userMessage = "‚è±Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
        break;
      case 'NETWORK_ERROR':
        userMessage = "üåê ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï";
        break;
      case 'HTTP_ERROR':
        if (error.details?.status === 401) {
          userMessage = "üîê Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà";
          setTimeout(logout, 2000);
        } else if (error.details?.status === 404) {
          userMessage = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£";
        } else if (error.details?.status >= 500) {
          userMessage = "üîß ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö";
        }
        break;
    }
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error
  showNotification(userMessage, 'error');
  
  // Log error ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debugging
  console.error('üö® WMS Error:', {
    message: error.message,
    type: error.type || 'UNKNOWN',
    details: error.details,
    timestamp: error.timestamp || new Date().toISOString(),
    stack: error.stack
  });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö async operations ‡∏ó‡∏µ‡πà‡∏°‡∏µ error handling
async function safeAsyncOperation(operation, errorContext = 'Unknown operation') {
  try {
    return await operation();
  } catch (error) {
    console.error(`‚ùå Error in ${errorContext}:`, error);
    showUserFriendlyError(error);
    throw error;
  }
}

// Global error handler ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö unhandled promises
window.addEventListener('unhandledrejection', (event) => {
  console.error('üö® Unhandled Promise Rejection:', event.reason);
  
  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á error ‡∏ã‡πâ‡∏≥‡πÜ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  if (event.reason && event.reason.name !== 'AbortError') {
    showUserFriendlyError(new WMSError(
      'Unhandled system error',
      'SYSTEM_ERROR',
      { originalError: event.reason }
    ));
  }
  event.preventDefault();
});

// Global error handler ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö JavaScript errors
window.addEventListener('error', (event) => {
  console.error('üö® JavaScript Error:', {
    message: event.message,
    filename: event.filename,
    lineno: event.lineno,
    colno: event.colno,
    error: event.error
  });
  
  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error ‡∏à‡∏≤‡∏Å script ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠ extension
  if (event.filename && event.filename.includes(window.location.origin)) {
    showUserFriendlyError(new WMSError(
      'JavaScript execution error',
      'SCRIPT_ERROR',
      {
        message: event.message,
        location: `${event.filename}:${event.lineno}:${event.colno}`
      }
    ));
  }
});

// ‚úÖ Smart Polling System ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î server load
class SmartPoller {
  constructor(name, fetchFunction, options = {}) {
    this.name = name;
    this.fetchFunction = fetchFunction;
    this.interval = null;
    this.isActive = false;
    this.consecutiveErrors = 0;
    this.lastDataHash = null;
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ default
    this.config = {
      baseInterval: options.baseInterval || 30000, // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏•‡∏î‡∏à‡∏≤‡∏Å 5-10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
      maxInterval: options.maxInterval || 300000,  // 5 ‡∏ô‡∏≤‡∏ó‡∏µ
      backoffMultiplier: options.backoffMultiplier || 1.5,
      maxErrors: options.maxErrors || 3,
      enableAdaptive: options.enableAdaptive !== false,
      ...options
    };
    
    this.currentInterval = this.config.baseInterval;
  }
  
  start() {
    if (this.isActive) return;
    
    this.isActive = true;
    this.poll(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    this.scheduleNext();
  }
  
  stop() {
    if (!this.isActive) return;
    
    this.isActive = false;
    if (this.interval) {
      stopTimer(this.interval);
      this.interval = null;
    }
  }
  
  async poll() {
    if (!this.isActive) return;
    
    try {
      const data = await this.fetchFunction();
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const dataHash = this.hashData(data);
      const hasChanged = dataHash !== this.lastDataHash;
      this.lastDataHash = dataHash;
      
      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï error count ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      this.consecutiveErrors = 0;
      
      // ‡∏õ‡∏£‡∏±‡∏ö interval ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      if (this.config.enableAdaptive) {
        if (hasChanged) {
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô = ‡∏•‡∏î interval (‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô)
          this.currentInterval = Math.max(
            this.config.baseInterval,
            this.currentInterval * 0.8
          );
        } else {
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô = ‡πÄ‡∏û‡∏¥‡πà‡∏° interval (‡∏ä‡πâ‡∏≤‡∏•‡∏á)
          this.currentInterval = Math.min(
            this.config.maxInterval,
            this.currentInterval * 1.2
          );
        }
      }
      
      
    } catch (error) {
      this.consecutiveErrors++;
      console.error(`‚ùå ${this.name} poll failed (${this.consecutiveErrors}/${this.config.maxErrors}):`, error);
      
      // ‡πÉ‡∏ä‡πâ exponential backoff ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ error
      this.currentInterval = Math.min(
        this.config.maxInterval,
        this.config.baseInterval * Math.pow(this.config.backoffMultiplier, this.consecutiveErrors)
      );
      
      // ‡∏´‡∏¢‡∏∏‡∏î polling ‡∏ñ‡πâ‡∏≤ error ‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
      if (this.consecutiveErrors >= this.config.maxErrors) {
        console.error(`üö® ${this.name} polling stopped due to excessive errors`);
        this.stop();
        return;
      }
    }
  }
  
  scheduleNext() {
    if (!this.isActive) return;
    
    this.interval = createTimeout(() => {
      this.poll();
      this.scheduleNext();
    }, this.currentInterval);
  }
  
  hashData(data) {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á hash ‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
    return JSON.stringify(data).length + JSON.stringify(data).slice(0, 100);
  }
  
  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô interval ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ active)
  boost(duration = 60000) {
    const originalInterval = this.currentInterval;
    this.currentInterval = this.config.baseInterval;
    
    createTimeout(() => {
      this.currentInterval = originalInterval;
    }, duration);
    
  }
}

// Global pollers registry
const activePollers = new Map();

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á poller
function createPoller(name, fetchFunction, options = {}) {
  // ‡∏´‡∏¢‡∏∏‡∏î poller ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  if (activePollers.has(name)) {
    activePollers.get(name).stop();
  }
  
  const poller = new SmartPoller(name, fetchFunction, options);
  activePollers.set(name, poller);
  return poller;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î poller ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function stopAllPollers() {
  activePollers.forEach(poller => poller.stop());
  activePollers.clear();
}

// Auto-boost pollers ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
let userActivityTimeout = null;
function boostPollersOnActivity() {
  // ‡∏•‡πâ‡∏≤‡∏á timeout ‡πÄ‡∏Å‡πà‡∏≤
  if (userActivityTimeout) {
    clearTimeout(userActivityTimeout);
  }
  
  // Boost pollers ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  activePollers.forEach(poller => {
    if (poller.isActive) {
      poller.boost(30000); // boost 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    }
  });
  
  // ‡∏ï‡∏±‡πâ‡∏á timeout ‡πÉ‡∏´‡∏°‡πà
  userActivityTimeout = setTimeout(() => {
  }, 30000);
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö boost on activity
document.addEventListener("click", boostPollersOnActivity);
document.addEventListener("keypress", boostPollersOnActivity);

// ‚úÖ Performance Optimization System
class PerformanceManager {
  constructor() {
    this.cache = new Map();
    this.cacheTimeout = 30000; // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    this.loadingStates = new Set();
    this.debounceTimers = new Map();
  }
  
  // Cache management
  setCache(key, data, ttl = this.cacheTimeout) {
    const expiry = Date.now() + ttl;
    this.cache.set(key, { data, expiry });
    
    // Auto cleanup
    createTimeout(() => {
      if (this.cache.has(key)) {
        const cached = this.cache.get(key);
        if (cached && cached.expiry <= Date.now()) {
          this.cache.delete(key);
        }
      }
    }, ttl);
  }
  
  getCache(key) {
    const cached = this.cache.get(key);
    if (cached && cached.expiry > Date.now()) {
      return cached.data;
    }
    
    if (cached) {
      this.cache.delete(key); // ‡∏•‡∏ö cache ‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
    }
    
    return null;
  }
  
  clearCache(pattern = null) {
    if (pattern) {
      const keys = Array.from(this.cache.keys()).filter(key => key.includes(pattern));
      keys.forEach(key => this.cache.delete(key));
    } else {
      this.cache.clear();
    }
  }
  
  // Loading state management
  setLoading(key, isLoading = true) {
    if (isLoading) {
      this.loadingStates.add(key);
      this.showLoadingIndicator(key);
    } else {
      this.loadingStates.delete(key);
      this.hideLoadingIndicator(key);
    }
  }
  
  isLoading(key) {
    return this.loadingStates.has(key);
  }
  
  showLoadingIndicator(key) {
    // ‡∏´‡∏≤ element ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
    const element = document.getElementById(key) || document.querySelector(`[data-loading="${key}"]`);
    if (element) {
      element.classList.add('loading');
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° spinner ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
      if (!element.querySelector('.loading-spinner')) {
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
        spinner.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        element.appendChild(spinner);
      }
    }
  }
  
  hideLoadingIndicator(key) {
    const element = document.getElementById(key) || document.querySelector(`[data-loading="${key}"]`);
    if (element) {
      element.classList.remove('loading');
      const spinner = element.querySelector('.loading-spinner');
      if (spinner) {
        spinner.remove();
      }
    }
  }
  
  // Debounce utility
  debounce(key, func, delay = 300) {
    // ‡∏•‡πâ‡∏≤‡∏á timer ‡πÄ‡∏Å‡πà‡∏≤
    if (this.debounceTimers.has(key)) {
      clearTimeout(this.debounceTimers.get(key));
    }
    
    // ‡∏ï‡∏±‡πâ‡∏á timer ‡πÉ‡∏´‡∏°‡πà
    const timerId = setTimeout(() => {
      this.debounceTimers.delete(key);
      func();
    }, delay);
    
    this.debounceTimers.set(key, timerId);
  }
  
  // Batch operations
  async batchOperations(operations, batchSize = 5) {
    const results = [];
    
    for (let i = 0; i < operations.length; i += batchSize) {
      const batch = operations.slice(i, i + batchSize);
      const batchResults = await Promise.allSettled(batch);
      results.push(...batchResults);
      
      // ‡∏û‡∏±‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á batch
      if (i + batchSize < operations.length) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
    }
    
    return results;
  }
  
  // Memory usage monitoring
  getMemoryUsage() {
    if (performance.memory) {
      return {
        used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
        total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
        limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
      };
    }
    return null;
  }
  
  logPerformanceMetrics() {
    const memory = this.getMemoryUsage();
    const cacheSize = this.cache.size;
    const loadingOperations = this.loadingStates.size;
  }
}

// Global performance manager
const performanceManager = new PerformanceManager();

// Enhanced fetch with caching
async function cachedFetch(url, options = {}) {
  const cacheKey = `fetch_${url}_${JSON.stringify(options)}`;
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö cache ‡∏Å‡πà‡∏≠‡∏ô
  const cached = performanceManager.getCache(cacheKey);
  if (cached && !options.bypassCache) {
    return cached;
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á loading
  performanceManager.setLoading(cacheKey, true);
  
  try {
    const data = await safeFetch(url, options);
    
    // ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô cache ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà error
    if (data && !options.noCache) {
      performanceManager.setCache(cacheKey, data, options.cacheTTL);
    }
    
    return data;
    
  } finally {
    performanceManager.setLoading(cacheKey, false);
  }
}

// Performance monitoring interval
createInterval(() => {
  performanceManager.logPerformanceMetrics();
}, 300000); // ‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ

// Memory cleanup on page visibility change
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    performanceManager.clearCache();
    
    // ‡∏´‡∏¢‡∏∏‡∏î pollers ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    activePollers.forEach(poller => {
      if (poller.isActive) {
        poller.stop();
        poller._wasActiveBeforeHide = true;
      }
    });
  } else {
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏° pollers ‡πÉ‡∏´‡∏°‡πà
    activePollers.forEach(poller => {
      if (poller._wasActiveBeforeHide) {
        poller.start();
        delete poller._wasActiveBeforeHide;
      }
    });
  }
});

/* ================================================================================================
   
   üìã TABLE OF CONTENTS:
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   1. üîß GLOBAL VARIABLES & CONFIGURATION
   2. üöÄ PERFORMANCE & OPTIMIZATION FUNCTIONS
   3. üìÑ PAGE RENDERING FUNCTIONS
   4. üìä DASHBOARD & OVERVIEW FUNCTIONS
   5. üéõÔ∏è CONTROL SYSTEM FUNCTIONS
   6. üìπ CAMERA & MONITORING FUNCTIONS
   7. üìà CHART & VISUALIZATION FUNCTIONS
   8. üîê AUTHENTICATION & USER MANAGEMENT
   9. üì± EVENT HANDLERS & UI INTERACTIONS
   10. üåê API & DATA MANAGEMENT
   ================================================================================================ */

/* ================================================================================================
   1. üîß GLOBAL VARIABLES & CONFIGURATION
   ================================================================================================ */

let currentStation = 1; // üü¢ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ default
let plantingRefreshInterval = null; 
let currentPage = 'overview'; // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö showPage()
let pieChartInstance = null;
let barChartInstance = null;
let hourlyChartInstance = null;
// activeTimers ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 7952 ‡πÄ‡∏õ‡πá‡∏ô Set()
let client = null; // MQTT client instance
let trayMasterTimer = null; // Timer for tray master page

// Performance optimization globals
const apiCache = new Map();
const domCache = new Map();
let requestQueue = new Map();

/* ================================================================================================
   2. üöÄ PERFORMANCE & OPTIMIZATION FUNCTIONS
   ================================================================================================ */

// üîí Security Functions - XSS Protection
const SecurityUtils = {
  // HTML Sanitization
  sanitizeHTML(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  },
  
  // Safe innerHTML replacement
  safeSetHTML(element, html) {
    if (!element) return;
    element.textContent = '';
    const sanitized = this.sanitizeHTML(html);
    element.innerHTML = sanitized;
  },
  
  // Input validation
  validateInput(input, type = 'text') {
    if (!input) return false;
    
    const patterns = {
      email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
      username: /^[a-zA-Z0-9_]{2,20}$/,  // ‡∏•‡∏î‡∏à‡∏≤‡∏Å 3 ‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
      number: /^\d+$/,
      text: /^[^<>\"'&]*$/
    };
    
    return patterns[type] ? patterns[type].test(input) : true;
  },
  
  // Generate CSRF token
  generateCSRFToken() {
    return 'csrf_' + Math.random().toString(36).substr(2, 15) + Date.now().toString(36);
  },
  
  // Get CSRF token
  getCSRFToken() {
    let token = sessionStorage.getItem('csrf_token');
    if (!token) {
      token = this.generateCSRFToken();
      sessionStorage.setItem('csrf_token', token);
    }
    return token;
  }
};

function clearActiveTimers() {
  activeTimers.forEach(timerId => clearInterval(timerId))
  activeTimers.clear(); // ‡∏•‡πâ‡∏≤‡∏á Set ‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á
  
  // Also close sensor WebSocket when clearing timers
  closeSensorWebSocket();
}

// Enhanced memory management
function addManagedTimer(timerId) {
  activeTimers.add(timerId);
  return timerId;
}

// API caching system
function getCachedData(key, maxAge = 30000) {
  const cached = apiCache.get(key);
  if (cached && Date.now() - cached.timestamp < maxAge) {
    return cached.data;
  }
  return null;
}

function setCachedData(key, data) {
  apiCache.set(key, { data, timestamp: Date.now() });
  if (apiCache.size > 100) {
    const firstKey = apiCache.keys().next().value;
    apiCache.delete(firstKey);
  }
}

// Debounced API calls
function debounceApiCall(key, fn, delay = 500) {
  if (requestQueue.has(key)) {
    clearTimeout(requestQueue.get(key));
  }
  
  const timeoutId = setTimeout(async () => {
    await fn();
    requestQueue.delete(key);
  }, delay);
  
  requestQueue.set(key, timeoutId);
}

// Optimized DOM updates with Security
function updateElementSafely(elementId, content, useCache = true) {
  if (useCache && domCache.get(elementId) === content) {
    return; // Skip if content hasn't changed
  }
  
  const element = document.getElementById(elementId);
  if (element) {
    // Use safe HTML setting instead of innerHTML
    SecurityUtils.safeSetHTML(element, content);
    if (useCache) domCache.set(elementId, content);
  }
}

// Enhanced API function with Security
async function secureApiCall(url, options = {}) {
  const headers = {
    'Content-Type': 'application/json',
    'X-CSRF-Token': SecurityUtils.getCSRFToken(),
    ...options.headers
  };

  const config = {
    ...options,
    headers
  };

  try {
    const response = await fetch(url, config);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error('API call failed:', error);
    showNotification(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, 'error');
    throw error;
  }
}

// Enhanced Performance monitoring
const perfMonitor = {
  apiCalls: 0,
  cacheHits: 0,
  domUpdates: 0,
  memoryUsage: 0,
  apiTimes: new Map(),
  errors: new Map(),
  
  logApiCall(endpoint, duration) { 
    this.apiCalls++; 
    
    if (!this.apiTimes.has(endpoint)) {
      this.apiTimes.set(endpoint, []);
    }
    this.apiTimes.get(endpoint).push(duration);
  },
  
  logCacheHit() { this.cacheHits++; },
  logDomUpdate() { this.domUpdates++; },
  
  logError(context, error) {
    const key = `${context}: ${error.message}`;
    this.errors.set(key, (this.errors.get(key) || 0) + 1);
  },
  
  getStats() {
    return {
      apiCalls: this.apiCalls,
      cacheHits: this.cacheHits,
      domUpdates: this.domUpdates,
      cacheHitRate: this.apiCalls ? (this.cacheHits / this.apiCalls * 100).toFixed(1) : 0,
      memoryUsage: performance.memory ? Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) : 'N/A',
      activeTimers: activeTimers.size,
      cacheSize: apiCache.size,
      requestQueueSize: requestQueue.size
    };
  },
  
  getSlowApiCalls() {
    const slow = [];
    this.apiTimes.forEach((times, endpoint) => {
      const avg = times.reduce((a, b) => a + b, 0) / times.length;
      if (avg > 2000) {
        slow.push({ endpoint, avgTime: Math.round(avg), callCount: times.length });
      }
    });
    return slow;
  },
  
  getTopErrors() {
    return Array.from(this.errors.entries())
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5)
      .map(([error, count]) => ({ error, count }));
  },
  
  reset() {
    this.apiCalls = 0;
    this.cacheHits = 0;
    this.domUpdates = 0;
    this.apiTimes.clear();
    this.errors.clear();
  }
};

// Auto-performance reporting (disabled in production)
// Uncomment for development monitoring:
/*
if (typeof console !== 'undefined') {
  setInterval(() => {
    const stats = perfMonitor.getStats();
    if (stats.apiCalls > 0) {
    }
  }, 60000);
}
*/

// Enhanced caching with monitoring
function getCachedDataWithMonitoring(key, maxAge = 30000) {
  const cached = apiCache.get(key);
  if (cached && Date.now() - cached.timestamp < maxAge) {
    perfMonitor.logCacheHit();
    return cached.data;
  }
  perfMonitor.logApiCall();
  return null;
}

// Loading State Management
const LoadingManager = {
  activeLoaders: new Set(),
  
  show(elementId, message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
    const element = document.getElementById(elementId);
    if (element) {
      element.innerHTML = `
        <div class="loading-state" role="status" aria-live="polite">
          <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
          <span>${SecurityUtils.sanitizeHTML(message)}</span>
        </div>
      `;
      this.activeLoaders.add(elementId);
    }
  },
  
  hide(elementId) {
    this.activeLoaders.delete(elementId);
  },
  
  hideAll() {
    this.activeLoaders.clear();
  }
};

// Enhanced Error Handling with Retry Logic
function handleError(error, context = '‡∏£‡∏∞‡∏ö‡∏ö') {
  console.error(`Error in ${context}:`, error);
  
  const errorMessage = error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
  
  showNotification(
    `‚ùå ${context}: ${SecurityUtils.sanitizeHTML(errorMessage)}`, 
    'error'
  );
  
  // Log error for monitoring
  if (typeof gtag !== 'undefined') {
    gtag('event', 'exception', {
      description: errorMessage,
      fatal: false
    });
  }
}

// Retry mechanism for failed API calls
async function retryApiCall(apiCall, maxRetries = 3, delay = 1000) {
  let lastError;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const result = await apiCall();
      return result;
    } catch (error) {
      lastError = error;
      console.warn(`‚ö†Ô∏è API attempt ${attempt} failed:`, error.message);
      
      if (attempt < maxRetries) {
        await new Promise(resolve => setTimeout(resolve, delay * attempt));
      }
    }
  }
  
  throw lastError;
}

// Network-aware API calling
async function resilientApiCall(url, options = {}) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
  
  try {
    const response = await fetch(url, {
      ...options,
      signal: controller.signal,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': SecurityUtils.getCSRFToken(),
        ...options.headers
      }
    });
    
    clearTimeout(timeoutId);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    return await response.json();
  } catch (error) {
    clearTimeout(timeoutId);
    
    if (error.name === 'AbortError') {
      throw new Error('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
    }
    
    throw error;
  }
}

// [index.html] - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
function cleanupCurrentPage() {

  // (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô cleanupCurrentPage() ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
  clearActiveTimers(); 
  destroyAllCharts();
}

// Dedicated chart cleanup function
function destroyAllCharts() {
  const charts = {
    pieChartInstance,
    barChartInstance, 
    hourlyChartInstance
  };
  
  Object.entries(charts).forEach(([name, instance]) => {
    if (instance) {
      try {
        instance.destroy();
      } catch (error) {
        console.warn(`‚ö†Ô∏è Error destroying ${name}:`, error);
      }
    }
  });
  
  // Reset global chart variables
  pieChartInstance = null;
  barChartInstance = null;
  hourlyChartInstance = null;
}

// Enhanced Keyboard Event Handlers
function setupLoginKeyboardHandlers() {
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  
  if (usernameInput && passwordInput) {
    [usernameInput, passwordInput].forEach(input => {
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          login();
        }
      });
    });
  }
}

/* ================================================================================================
   3. üìÑ PAGE RENDERING FUNCTIONS
   ================================================================================================ */

// üéØ ‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÑ‡∏õ
function renderOverviewPage() {
  const mainContent = document.getElementById("mainContent");
  const html = `
    <div class="enhanced-overview">
      <div class="overview-content-wrapper">
        <div class="overview-header-enhanced">
          <div class="header-icon-wrapper">
            <i class="fas fa-chart-pie header-icon"></i>
            <div class="icon-pulse"></div>
          </div>
          <h2 class="enhanced-title">
            <span class="title-gradient">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</span>
            <span class="title-subtitle">(Overview)</span>
          </h2>
          <div class="title-decoration"></div>
        </div>

        <div class="summary-cards-new">
        <div class="summary-card-new inbound card-glow">
          <div class="card-header-new">
            <div class="card-icon-new inbound">
              <i class="fas fa-arrow-down"></i>
            </div>
            <div class="card-trend-new up" id="inboundTrend">
              <i class="fas fa-arrow-up"></i>
              <span>+12%</span>
            </div>
          </div>
          <div class="card-content-new">
            <div class="card-value-new" id="totalInbound">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="card-label-new">Inbound ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
          </div>
        </div>

        <div class="summary-card-new outbound card-glow">
          <div class="card-header-new">
            <div class="card-icon-new outbound">
              <i class="fas fa-arrow-up"></i>
            </div>
            <div class="card-trend-new up" id="outboundTrend">
              <i class="fas fa-arrow-up"></i>
              <span>+8%</span>
            </div>
          </div>
          <div class="card-content-new">
            <div class="card-value-new" id="totalOutbound">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="card-label-new">Outbound ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
          </div>
        </div>

        <div class="summary-card-new total card-glow">
          <div class="card-header-new">
            <div class="card-icon-new total">
              <i class="fas fa-boxes"></i>
            </div>
            <div class="card-trend-new neutral" id="totalTraysTrend">
              <i class="fas fa-equals"></i>
              <span>Stable</span>
            </div>
          </div>
          <div class="card-content-new">
            <div class="card-value-new" id="totalTrays">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="card-label-new">‡∏ñ‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          </div>
        </div>

        <div class="summary-card-new ontime card-glow">
          <div class="card-header-new">
            <div class="card-icon-new ontime">
              <i class="fas fa-clock"></i>
            </div>
            <div class="card-trend-new up" id="ontimeTrend">
              <i class="fas fa-arrow-up"></i>
              <span>+5%</span>
            </div>
          </div>
          <div class="card-content-new">
            <div class="card-value-new" id="onTimeTasks">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="card-label-new">‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
          </div>
        </div>

        <div class="summary-card-new users card-glow">
          <div class="card-header-new">
            <div class="card-icon-new users">
              <i class="fas fa-users"></i>
            </div>
            <div class="card-trend-new neutral" id="usersTrend">
              <i class="fas fa-circle"></i>
              <span>Online</span>
            </div>
          </div>
          <div class="card-content-new">
            <div class="card-value-new" id="onlineUsers">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="card-label-new">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
          </div>
        </div>

        <div class="summary-card-new tasks card-glow">
          <div class="card-header-new">
            <div class="card-icon-new tasks">
              <i class="fas fa-tasks"></i>
            </div>
            <div class="card-trend-new neutral" id="tasksTrend">
              <i class="fas fa-clock"></i>
              <span>Active</span>
            </div>
          </div>
          <div class="card-content-new">
            <div class="card-value-new" id="activeTasks">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="card-label-new">‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
          </div>
        </div>
      </div>

      <div class="overview-grid-new">
        <div class="overview-card-new fade-in">
          <div class="card-header-overview">
            <div class="card-title-new">
              <i class="fas fa-calendar-alt"></i>
              <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å 7‡∏ß‡∏±‡∏ô</h3>
            </div>
            <div class="card-controls">
              <button class="control-btn active" onclick="switchTimeRange('week')" data-tooltip="‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î">
                <i class="fas fa-calendar-week"></i> 7 ‡∏ß‡∏±‡∏ô
              </button>
              <button class="control-btn" onclick="switchTimeRange('month')" data-tooltip="‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î">
                <i class="fas fa-calendar-alt"></i> 30 ‡∏ß‡∏±‡∏ô
              </button>
            </div>
          </div>
          <div class="chart-container-new">
            <canvas id="barChart"></canvas>
          </div>
        </div>

        <div class="overview-card-new slide-in-right">
          <div class="card-header-overview">
            <div class="card-title-new">
              <i class="fas fa-cogs"></i>
              <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</h3>
            </div>
            <button class="control-btn" onclick="refreshSystemStatus()" data-tooltip="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
          <div class="status-grid-new">
            <div class="status-item-new tooltip" data-tooltip="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏¥‡∏ü‡∏ï‡πå">
              <span class="status-label-new">
                <i class="fas fa-elevator"></i> Lift System
              </span>
              <div class="status-value-new">
                <div class="status-indicator-new success" id="liftStatus"></div>
                <span id="liftStatusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span>
              </div>
            </div>
            
            <div class="status-item-new tooltip" data-tooltip="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö AGV">
              <span class="status-label-new">
                <i class="fas fa-truck-moving"></i> AGV System
              </span>
              <div class="status-value-new">
                <div class="status-indicator-new success" id="agvStatus"></div>
                <span id="agvStatusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span>
              </div>
            </div>
            
            <div class="status-item-new tooltip" data-tooltip="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö">
              <span class="status-label-new">
                <i class="fas fa-microchip"></i> Sensors
              </span>
              <div class="status-value-new">
                <div class="status-indicator-new success" id="sensorStatus"></div>
                <span id="sensorStatusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span>
              </div>
            </div>
            
            <div class="status-item-new tooltip" data-tooltip="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
              <span class="status-label-new">
                <i class="fas fa-database"></i> Database
              </span>
              <div class="status-value-new">
                <div class="status-indicator-new success" id="dbStatus"></div>
                <span id="dbStatusText">Connected</span>
              </div>
            </div>
            
            <div class="status-item-new tooltip" data-tooltip="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MQTT Broker">
              <span class="status-label-new">
                <i class="fas fa-broadcast-tower"></i> MQTT Broker
              </span>
              <div class="status-value-new">
                <div class="status-indicator-new success" id="mqttStatus"></div>
                <span id="mqttStatusText">Connected</span>
              </div>
            </div>
          </div>
        </div>

        <div class="overview-card-new scale-in">
          <div class="card-header-overview">
            <div class="card-title-new">
              <i class="fas fa-chart-pie"></i>
              <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
            </div>
            <div class="status-badge success">
              <i class="fas fa-check-circle"></i>
              ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÅ‡∏•‡πâ‡∏ß
            </div>
          </div>
          <div id="pieChartContainer-new">
            <canvas id="pieChart"></canvas>
          </div>
        </div>

        <div class="overview-card-new slide-in-left">
          <div class="card-header-overview">
            <div class="card-title-new">
              <i class="fas fa-stream"></i>
              <h3>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            </div>
            <button class="control-btn" onclick="refreshActivityFeed()" data-tooltip="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î">
              <i class="fas fa-refresh"></i>
            </button>
          </div>
          <div class="activity-feed-new" id="activityFeed">
            <div class="loading-state">
              <i class="fas fa-spinner fa-spin"></i>
              <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...</p>
            </div>
          </div>
        </div>

        <div class="overview-card-new full-width bounce-in">
          <div class="card-header-overview">
            <div class="card-title-new">
              <i class="fas fa-clock"></i>
              <h3>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h3>
            </div>
            <div class="card-controls">
              <div class="status-badge info">
                <i class="fas fa-calendar-day"></i>
                ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
              </div>
            </div>
          </div>
          <div class="chart-container-new hourly">
            <canvas id="hourlyChart"></canvas>
          </div>
        </div>

        <div class="overview-card-new full-width fade-in">
          <div class="card-header-overview">
            <div class="card-title-new">
              <i class="fas fa-thermometer-half"></i>
              <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°</h3>
            </div>
            <div class="card-controls">
              <div class="status-badge success" id="envStatus">
                <i class="fas fa-broadcast-tower"></i>
                Real-time
              </div>
              <button class="control-btn" onclick="resetEnvironmentalData()" data-tooltip="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°">
                <i class="fas fa-redo"></i>
              </button>
            </div>
          </div>
          <div class="env-grid-new">
            <div class="env-card-new tooltip" data-tooltip="‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞‡∏õ‡∏•‡∏π‡∏Å">
              <div class="env-value-new" id="tempValue">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <div class="env-label-new">
                <i class="fas fa-thermometer-half"></i> ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥
              </div>
              <div class="env-range-new">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 23-28¬∞C</div>
            </div>
            
            <div class="env-card-new tooltip" data-tooltip="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ó‡∏ò‡πå‡πÉ‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®">
              <div class="env-value-new" id="humidityValue">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <div class="env-label-new">
                <i class="fas fa-tint"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô
              </div>
              <div class="env-range-new">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 60-80%</div>
            </div>
            
            <div class="env-card-new tooltip" data-tooltip="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô‡πÑ‡∏î‡∏≠‡∏≠‡∏Å‡πÑ‡∏ã‡∏î‡πå‡πÉ‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®">
              <div class="env-value-new" id="co2Value">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <div class="env-label-new">
                <i class="fas fa-smog"></i> CO‚ÇÇ
              </div>
              <div class="env-range-new">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 400-600ppm</div>
            </div>
            
            <div class="env-card-new tooltip" data-tooltip="‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏™‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï">
              <div class="env-value-new" id="lightValue">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <div class="env-label-new">
                <i class="fas fa-lightbulb"></i> ‡πÅ‡∏™‡∏á
              </div>
              <div class="env-range-new">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 7-10k lux</div>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>

    <button class="fab" onclick="showOverviewSettings()" data-tooltip="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°">
      <i class="fas fa-cog"></i>
    </button>
  `;
  
  if (!mainContent) {
    console.error('‚ùå mainContent element not found!');
    return;
  }
  
  mainContent.innerHTML = html;
  
  // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ setTimeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
  setTimeout(() => {
    initOverviewPage();
  }, 100); // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 100ms
}


/* ================================================================================================
   4. üìä DASHBOARD & OVERVIEW FUNCTIONS
   ================================================================================================ */

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Overview (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å)
function initOverviewPage() {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ canvas elements ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const pieChart = document.getElementById('pieChart');
  const barChart = document.getElementById('barChart');
  const hourlyChart = document.getElementById('hourlyChart');
  
  
  if (!pieChart || !barChart || !hourlyChart) {
    console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö canvas elements ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô');
    return;
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á Loading Animation
  showOverviewLoading();
  
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  loadFullOverviewData(currentStation);
  
  // ‡πÄ‡∏£‡∏¥‡πà‡∏° Auto Refresh
  startOverviewAutoRefresh();
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Loading State
function showOverviewLoading() {
  const loadingElements = ['totalInbound', 'totalOutbound', 'totalTrays', 'onTimeTasks', 'onlineUsers', 'activeTasks'];
  loadingElements.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
  });
}



/// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏î‡∏¥‡∏°)
async function loadFullOverviewData(stationId) {
  try {
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Parallel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
    const promises = [
      loadSummaryCards(),
      loadOverviewCharts(stationId), // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
      loadUsersAndTasks(),
      loadSystemStatus(),
      loadRecentActivity(),
      loadEnvironmentalData()
    ];

    await Promise.allSettled(promises);
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    showNotification('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
    
  } catch (error) {
    console.error('Error loading overview data:', error);
    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
  }
}

// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Summary Cards
async function loadSummaryCards() {
  try {
    const cacheKey = `summary-cards-${currentStation}`;
    let data = getCachedData(cacheKey, 15000); // Cache for 15 seconds
    
    if (!data) {
      data = await secureApiCall(`/api/overview/summary-cards?station=${currentStation}`);
      setCachedData(cacheKey, data);
    }
    
    updateSummaryCards(data);
    
  } catch (error) {
    console.error('Error loading summary cards:', error);
    // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 0 ‡πÄ‡∏°‡∏∑‡πà‡∏≠ error
    updateSummaryCards({
      today_inbound: 0,
      today_outbound: 0,
      total_trays: 0,
      ontime_percentage: 0,
      inbound_trend: 0,
      outbound_trend: 0,
      trays_trend: 0,
      ontime_trend: 0
    });
  }
}

// ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Summary Cards ‡∏û‡∏£‡πâ‡∏≠‡∏° Animation
function updateSummaryCards(data) {
  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
  animateCounter('totalInbound', data.today_inbound || 0);
  animateCounter('totalOutbound', data.today_outbound || 0);
  animateCounter('totalTrays', data.total_trays || 0);
  animateCounter('onTimeTasks', data.ontime_percentage || 0, '%');

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó trend
  updateTrendIndicator('inboundTrend', data.inbound_trend || 0);
  updateTrendIndicator('outboundTrend', data.outbound_trend || 0);
  updateTrendIndicator('totalTraysTrend', data.trays_trend || 0);
  updateTrendIndicator('ontimeTrend', data.ontime_trend || 0);
}


// ‚úÖ Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
function animateCounter(elementId, targetValue, suffix = '') {
  const element = document.getElementById(elementId);
  if (!element) return;

  const startValue = 0;
  const duration = 1500; // 1.5 
  const startTime = Date.now();

  function updateCounter() {
    const elapsed = Date.now() - startTime;
    const progress = Math.min(elapsed / duration, 1);
    
    // ‡πÉ‡∏ä‡πâ easing function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö smooth animation
    const easeOut = 1 - Math.pow(1 - progress, 3);
    const currentValue = Math.round(startValue + (targetValue - startValue) * easeOut);
    
    element.textContent = currentValue + suffix;
    
    if (progress < 1) {
      requestAnimationFrame(updateCounter);
    }
  }
  
  updateCounter();
}

// ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Trend Indicator
function updateTrendIndicator(elementId, value, direction) {
  const element = document.getElementById(elementId);
  if (!element) return;

  const icon = direction === 'up' ? 'fas fa-arrow-up' : 
               direction === 'down' ? 'fas fa-arrow-down' : 'fas fa-minus';
  
  const className = direction === 'up' ? 'up' : 
                   direction === 'down' ? 'down' : 'neutral';

  element.className = `card-trend-new ${className}`;
  element.innerHTML = `<i class="${icon}"></i><span>${value > 0 ? '+' : ''}${value}%</span>`;
}

// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô
async function loadUsersAndTasks() {
  try {
    const [usersResponse, tasksResponse] = await Promise.all([
      fetch('/api/users').catch(() => ({ ok: false })),
      fetch('/api/task-monitor').catch(() => ({ ok: false }))
    ]);

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
    if (usersResponse.ok) {
      const users = await usersResponse.json();
      const onlineCount = users.filter(user => user.is_online).length;
      animateCounter('onlineUsers', onlineCount);
      updateTrendIndicator('usersTrend', onlineCount, 'neutral');
      
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó trend text
      const usersTrendEl = document.getElementById('usersTrend');
      if (usersTrendEl) {
        usersTrendEl.innerHTML = `<i class="fas fa-circle"></i><span>${onlineCount} ‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>`;
      }
    } else {
      animateCounter('onlineUsers', 0);
    }

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
    if (tasksResponse.ok) {
      const tasks = await tasksResponse.json();
      const activeCount = tasks.filter(task => 
        task.status === 'pending' || task.status === 'processing' || task.status === 'at_workstation'
      ).length;
      animateCounter('activeTasks', activeCount);
      
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó trend text
      const tasksTrendEl = document.getElementById('tasksTrend');
      if (tasksTrendEl) {
        tasksTrendEl.innerHTML = `<i class="fas fa-clock"></i><span>${activeCount} ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Queue</span>`;
      }
    } else {
      animateCounter('activeTasks', 0);
    }

  } catch (error) {
    console.error('Error loading users and tasks:', error);
    animateCounter('onlineUsers', 0);
    animateCounter('activeTasks', 0);
  }
}

// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö
async function loadSystemStatus() {
  const statusChecks = [
    { name: 'lift', endpoint: `/api/lift/status?station=${currentStation}`, timeout: 5000 },
    { name: 'agv', endpoint: `/api/agv/status?station=${currentStation}`, timeout: 5000 },
    { name: 'sensor', endpoint: '/api/sensors', timeout: 3000 }
  ];

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö Parallel
  statusChecks.forEach(async (check) => {
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), check.timeout);

      const response = await fetch(check.endpoint, {
        signal: controller.signal,
        method: 'GET'
      });

      clearTimeout(timeoutId);

      if (response.ok) {
        if (check.name === 'sensor') {
          const sensorData = await response.json();
          const activeSensors = Object.values(sensorData).filter(Boolean).length;
          const totalSensors = Object.keys(sensorData).length;
          updateSystemStatus(check.name, `${activeSensors}/${totalSensors} Active`, 'success');
        } else {
          const data = await response.json();
          updateSystemStatus(check.name, data.status || 'Online', 'success');
        }
      } else {
        updateSystemStatus(check.name, 'Offline', 'error');
      }
    } catch (error) {
      if (error.name === 'AbortError') {
        updateSystemStatus(check.name, 'Timeout', 'warning');
      } else {
        updateSystemStatus(check.name, 'Error', 'error');
      }
    }
  });

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Database ‡πÅ‡∏•‡∏∞ MQTT ‡∏à‡∏£‡∏¥‡∏á‡∏ú‡πà‡∏≤‡∏ô health API
  try {
    const healthResponse = await fetch('/api/health');
    if (healthResponse.ok) {
      const healthData = await healthResponse.json();
      
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Database
      const dbStatus = healthData.database === 'connected' ? 'Connected' : 'Disconnected';
      const dbType = healthData.database === 'connected' ? 'success' : 'error';
      updateSystemStatus('db', dbStatus, dbType);
      
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ MQTT
      const mqttStatus = healthData.mqtt === 'connected' ? 'Connected' : 'Disconnected';
      const mqttType = healthData.mqtt === 'connected' ? 'success' : 'error';
      updateSystemStatus('mqtt', mqttStatus, mqttType);
      
    } else {
      // ‡∏ñ‡πâ‡∏≤ health API ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á
      updateSystemStatus('db', 'Unknown', 'warning');
      updateSystemStatus('mqtt', 'Unknown', 'warning');
    }
  } catch (error) {
    console.error('Error checking health status:', error);
    updateSystemStatus('db', 'Error', 'error');
    updateSystemStatus('mqtt', 'Error', 'error');
  }
}

// ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏° Animation
function updateSystemStatus(system, status, type) {
  const statusMap = {
    'lift': { indicator: 'liftStatus', text: 'liftStatusText' },
    'agv': { indicator: 'agvStatus', text: 'agvStatusText' },
    'sensor': { indicator: 'sensorStatus', text: 'sensorStatusText' },
    'db': { indicator: 'dbStatus', text: 'dbStatusText' },
    'mqtt': { indicator: 'mqttStatus', text: 'mqttStatusText' }
  };

  const elements = statusMap[system];
  if (!elements) return;

  const indicator = document.getElementById(elements.indicator);
  const text = document.getElementById(elements.text);
  
  if (indicator && text) {
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó indicator ‡∏û‡∏£‡πâ‡∏≠‡∏° animation
    indicator.className = `status-indicator-new ${type}`;
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° fade effect
    text.style.opacity = '0';
    setTimeout(() => {
      text.textContent = status;
      text.style.opacity = '1';
    }, 150);
  }
}

// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
async function loadRecentActivity() {
  try {
    const response = await fetch('/api/logs');
    if (response.ok) {
      const logs = await response.json();
      const recentLogs = logs.slice(0, 8); // ‡πÅ‡∏™‡∏î‡∏á 8 ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      renderActivityFeed(recentLogs);
    } else {
      renderActivityFeed([]);
    }
  } catch (error) {
    console.error('Error loading recent activity:', error);
    renderActivityFeed([]);
  }
}

// ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏° Animation
function renderActivityFeed(logs) {
  const feedContainer = document.getElementById('activityFeed');
  if (!feedContainer) return;
  
  if (!logs || logs.length === 0) {
    feedContainer.innerHTML = `
      <div class="error-state">
        <i class="fas fa-inbox"></i>
        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
        <button onclick="refreshActivityFeed()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      </div>
    `;
    return;
  }

  let activitiesHtml = '';
  logs.forEach((log, index) => {
    const activityType = getActivityType(log.category || log.action_type);
    const timeAgo = getTimeAgo(new Date(log.created_at || log.timestamp));
    const activityText = log.activity || log.description || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
    activitiesHtml += `
      <div class="activity-item-new" style="animation-delay: ${index * 0.1}s">
        <div class="activity-icon-new ${activityType}">
          <i class="${getActivityIcon(activityType)}"></i>
        </div>
        <div class="activity-content-new">
          <div class="activity-text-new">${activityText}</div>
          <div class="activity-time-new">
            <i class="fas fa-clock"></i> ${timeAgo}
          </div>
        </div>
      </div>
    `;
  });

  feedContainer.innerHTML = activitiesHtml;
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° fade-in animation
  feedContainer.classList.add('fade-in');
}

// ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
function getActivityType(category) {
  if (!category) return 'system';
  
  const cat = category.toLowerCase();
  if (cat.includes('inbound') || cat.includes('‡πÄ‡∏Ç‡πâ‡∏≤') || cat.includes('‡∏ß‡∏≤‡∏á')) return 'inbound';
  if (cat.includes('outbound') || cat.includes('‡∏≠‡∏≠‡∏Å') || cat.includes('‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å')) return 'outbound';
  if (cat.includes('user') || cat.includes('‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ') || cat.includes('login') || cat.includes('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö')) return 'user';
  return 'system';
}

// ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
function getActivityIcon(type) {
  const icons = {
    'inbound': 'fas fa-arrow-down',
    'outbound': 'fas fa-arrow-up',
    'user': 'fas fa-user-check',
    'system': 'fas fa-cogs'
  };
  return icons[type] || 'fas fa-info-circle';
}

// ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤
function getTimeAgo(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
  if (diffMins < 60) return `${diffMins} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
  if (diffHours < 24) return `${diffHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
  if (diffDays < 7) return `${diffDays} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
  return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
}



// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏° (Real-time)
function loadEnvironmentalData() {
  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°
  function updateEnvironmentalValues() {
    try {
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏Å‡∏ß‡πà‡∏≤ (‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡πâ‡∏≠‡∏¢)
      const temp = (Math.random() * 2 + 25).toFixed(1); // 25-27¬∞C
      const humidity = (Math.random() * 10 + 65).toFixed(0); // 65-75%
      const co2 = (Math.random() * 80 + 460).toFixed(0); // 460-540 ppm
      const light = (Math.random() * 2 + 8).toFixed(1); // 8-10k lux

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡πà‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏° animation
      updateEnvironmentalValue('tempValue', `${temp}¬∞C`);
      updateEnvironmentalValue('humidityValue', `${humidity}%`);
      updateEnvironmentalValue('co2Value', `${co2}ppm`);
      updateEnvironmentalValue('lightValue', `${light}k`);

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Environmental badge
      const envStatus = document.getElementById('envStatus');
      if (envStatus) {
        const now = new Date().toLocaleTimeString('th-TH', { 
          hour: '2-digit', 
          minute: '2-digit',
          second: '2-digit'
        });
        envStatus.innerHTML = `<i class="fas fa-broadcast-tower"></i> ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó ${now}`;
      }

    } catch (error) {
      console.error('Error updating environmental data:', error);
    }
  }

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÅ‡∏•‡∏∞‡∏ó‡∏∏‡∏Å 8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  updateEnvironmentalValues();
  
  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå interval ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  if (window.envUpdateInterval) {
    clearInterval(window.envUpdateInterval);
  }
  
  window.envUpdateInterval = addManagedTimer(setInterval(updateEnvironmentalValues, 15000));
}

// ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡πà‡∏≤‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° Animation
function updateEnvironmentalValue(elementId, newValue) {
  const element = document.getElementById(elementId);
  if (!element) return;

  // Fade out -> Change value -> Fade in
  element.style.transition = 'opacity 0.3s ease';
  element.style.opacity = '0.5';
  
  setTimeout(() => {
    element.textContent = newValue;
    element.style.opacity = '1';
  }, 150);
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
function switchTimeRange(range) {
  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
  document.querySelectorAll('.control-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // ‡πÅ‡∏™‡∏î‡∏á loading ‡∏Ç‡∏ì‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
  const chartContainer = document.querySelector('.chart-container-new canvas');
  if (chartContainer) {
    chartContainer.style.opacity = '0.5';
  }
  
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  if (range === 'week') {
    loadOverviewCharts(currentStation); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 7 ‡∏ß‡∏±‡∏ô
  } else if (range === 'month') {
    loadMonthlyCharts(currentStation); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 30 ‡∏ß‡∏±‡∏ô
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  showNotification(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${range === 'week' ? '7 ‡∏ß‡∏±‡∏ô' : '30 ‡∏ß‡∏±‡∏ô'} ‡πÅ‡∏•‡πâ‡∏ß`, 'info');
}

// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü 30 ‡∏ß‡∏±‡∏ô
async function loadMonthlyCharts(stationId) {
  try {
    // ‚ú® ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô endpoint ‡πÄ‡∏õ‡πá‡∏ô /api/stats/monthly
    const response = await fetch(`/api/stats/monthly?station=${stationId}`);
    if (response.ok) {
      const data = await response.json();
      renderBarChart(data, 'monthly'); // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
    } else {
      // ‡∏Å‡∏£‡∏ì‡∏µ API ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á (Mock Data) ‡πÅ‡∏ó‡∏ô
      console.warn('Monthly API failed, using mock data.');
      const mockData = generateMockMonthlyData();
      renderBarChart(mockData, 'monthly');
    }
  } catch (error) {
    console.error('Error loading monthly charts:', error);
    const mockData = generateMockMonthlyData();
    renderBarChart(mockData, 'monthly');
  }
}












// ü•¶ Global variable ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
let trayInventory = {};
async function loadTrayInventory() {
  trayInventory = {}; // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Object ‡∏ß‡πà‡∏≤‡∏á
  try {
    const response = await fetch(`/api/tray-inventory?station=${currentStation}&t=${Date.now()}`);
    if (!response.ok) {
      console.error("Fetch tray inventory failed!");
      return;
    }
    const data = await response.json();
    
    // Debug ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• batch_id ‡πÉ‡∏ô response
    data.forEach((tray, i) => {
    });
    
    const newInventory = {};
    data.forEach(tray => {
      const key = `${tray.floor}-${tray.slot}`;
      newInventory[key] = tray;
    });
    
    trayInventory = newInventory;

  } catch (error) {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô loadTrayInventory:", error);
  }
}

// Initialize MQTT client connection (disabled - using backend WebSocket instead)
function initializeMqttClient() {
}

// ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å "‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å" ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß
document.addEventListener('DOMContentLoaded', () => {
    // Initialize MQTT client
    initializeMqttClient();
    
    // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô DOMContentLoaded ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...
    // ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ login
    const loggedIn = localStorage.getItem("loggedIn");
    if (loggedIn === "true") {
        // ...
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        loadTrayInventory();
        
        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dashboard Cards ‡πÅ‡∏•‡∏∞ Tab Counts
        updateDashboardCards();
        updatePlantingTabCounts();
    } else {
        // ...
    }
});


let currentUsername = null;  // üåü ‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à



//  tabsidebar
function setActiveSidebar(page) {
  const links = document.querySelectorAll(".sidebar a");
  links.forEach(link => {
    const target = link.getAttribute("data-page");
    if (target === page) {
      link.classList.add("active");
    } else {
      link.classList.remove("active");
    }
  });
}




  

  function confirmTray() {
  const floorEl = document.getElementById("floorSelect");
  const slotEl = document.getElementById("slotSelect");
  const vegEl = document.getElementById("vegSelect");
  const msgEl = document.getElementById("trayMsg");

  if (!floorEl || !slotEl || !vegEl || !msgEl) {
    console.warn("‚ùå [confirmTray] Elements ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô DOM");
    return;
  }

  const floor = floorEl.value;
  const slot = slotEl.value;
  const veg = vegEl.value;

  msgEl.style.display = "none";
  msgEl.className = "message";

  if (!floor || !slot || !veg) {
    msgEl.textContent = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö";
    msgEl.classList.add("error");
    msgEl.style.display = "block";
    return;
  }

  const key = `${floor}-${slot}`;
  if (trayStatus[key]) {
    msgEl.textContent = `‚ùå ‡∏ä‡πà‡∏≠‡∏á ${slot} ‡∏ö‡∏ô‡∏ä‡∏±‡πâ‡∏ô ${floor} ‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!`;
    msgEl.classList.add("error");
  } else {
    msgEl.textContent = `‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏á \"${veg}\" ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô ${floor} ‡∏ä‡πà‡∏≠‡∏á ${slot} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`;
    msgEl.classList.add("success");
  }
  msgEl.style.display = "block";
}
/**
 * ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Pop-up ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ (Inbound/Outbound)
/**
 * ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™ .danger ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Icon ‡πÅ‡∏•‡∏∞ Button
 */
function showConfirmationPopup({ title, subtitle, icon, details, onConfirm }) {

  const isDanger = (icon === 'fa-dolly-flatbed');
  const confirmButtonClass = isDanger ? 'danger' : '';
  const iconClass = isDanger ? 'danger' : '';

  const popupHTML = `
    <div class="popup-overlay" id="confirmationPopup">
      <div class="popup-container">
        <div class="popup-header">
          <i class="fas ${icon} icon ${iconClass}"></i>
          <h2 class="popup-title">${title}</h2>
          <p class="popup-subtitle">${subtitle}</p>
        </div>
        <div class="popup-summary">
          ${details.map(item => `
            <div class="summary-item">
              <span class="label">${item.label}</span>
              <span class="value ${item.highlight ? 'highlight' : ''}">${item.value || '-'}</span>
            </div>
          `).join('')}
        </div>
        <div class="popup-actions">
          <button class="popup-button cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="popup-button confirm ${confirmButtonClass}">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', popupHTML);

  const popupElement = document.getElementById('confirmationPopup');
  const confirmBtn = popupElement.querySelector('.popup-button.confirm');
  const cancelBtn = popupElement.querySelector('.popup-button.cancel');

  const closePopup = () => {
    popupElement.remove();
  };

  confirmBtn.onclick = () => {
    onConfirm();
    closePopup();
  };

  cancelBtn.onclick = closePopup;
  popupElement.onclick = (e) => {
    if (e.target === popupElement) {
        closePopup();
    }
  };
}
// ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ slot ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
async function handleInbound() {
    // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å form
    const floor = safeGetElementValue("inFloor");
    const slot = safeGetElementValue("inSlot");
    const veg_type = safeGetElementValue("inVeg");
    const quantity = safeGetElementValue("inPlantQuantity");
    const batch_id = safeGetElementValue("inBatchId");
    const seeding_date = safeGetElementValue("inSeedingDate");
    const notes = safeGetElementValue("inNotes");
    
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Input Validation
    const validationErrors = [];
    
    if (!ValidationUtils.isValidFloor(floor)) {
        validationErrors.push("‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 1-10");
    }
    
    if (!ValidationUtils.isValidSlot(slot)) {
        validationErrors.push("‡∏ä‡πà‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 1-100");
    }
    
    if (!ValidationUtils.isValidString(veg_type, 1, 50)) {
        validationErrors.push("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏±‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }
    
    if (!ValidationUtils.isValidQuantity(quantity)) {
        validationErrors.push("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 1-10,000");
    }
    
    if (batch_id && !ValidationUtils.isValidBatchId(batch_id)) {
        validationErrors.push("‡∏£‡∏´‡∏±‡∏™ Batch ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô A-Z, 0-9, - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß 3-20 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£");
    }
    
    if (validationErrors.length > 0) {
        alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:\n" + validationErrors.join("\n"));
        return;
    }

    const data = {
        floor: ValidationUtils.sanitizeInput(floor),
        slot: ValidationUtils.sanitizeInput(slot),
        veg_type: ValidationUtils.sanitizeInput(veg_type),
        quantity: ValidationUtils.sanitizeInput(quantity),
        batch_id: ValidationUtils.sanitizeInput(batch_id),
        seeding_date: ValidationUtils.sanitizeInput(seeding_date),
        notes: ValidationUtils.sanitizeInput(notes),
        username: localStorage.getItem("username"),
        station: currentStation
    };

    if (!data.floor || !data.slot || !data.veg_type) {
        showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ä‡∏±‡πâ‡∏ô, ‡∏ä‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", false);
        return;
    }
  
    showConfirmationPopup({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà',
        subtitle: '‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        icon: 'fa-leaf',
        details: [
            { label: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', value: `‡∏ä‡∏±‡πâ‡∏ô ${data.floor} / ‡∏ä‡πà‡∏≠‡∏á ${data.slot}`, highlight: true },
            { label: '‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å', value: data.veg_type },
            { label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô', value: data.quantity },
            { label: 'Batch ID', value: data.batch_id },
            { label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î', value: data.seeding_date },
            { label: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', value: data.notes }
        ],
        onConfirm: async () => {
            try {
                const res = await fetch("/api/tray/inbound", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                if (result.error) {
                   showToast(`‚ùå ${result.error}`, false);
                } else {
                   showToast(`‚úÖ ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡πÅ‡∏•‡πâ‡∏ß...`, true);
                   refreshDataAndViews();
                }
            } catch (error) {
                console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î:", error);
                showToast("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", false);
            }
        }
    });
}
// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LIFO
async function handleOutbound() {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô validateOutboundFloor() ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!selectedOutboundTray) {
        showToast("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô", false);
        return;
    }

    const data = {
        floor: selectedOutboundTray.floor, // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ
        slot: selectedOutboundTray.slot,   // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ
        reason: safeGetElementValue("outReason"),
        destination: safeGetElementValue("outDestination"),
        username: localStorage.getItem("username"),
        station: currentStation
    };
    
    showConfirmationPopup({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å',
        subtitle: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤',
        icon: 'fa-dolly-flatbed', // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô
        details: [
            { label: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', value: `‡∏ä‡∏±‡πâ‡∏ô ${data.floor} / ‡∏ä‡πà‡∏≠‡∏á ${data.slot}`, highlight: true },
            { label: '‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å', value: selectedOutboundTray.veg_type },
            { label: '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•', value: data.reason },
            { label: '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á', value: data.destination }
        ],
        onConfirm: async () => {
            try {
                const res = await fetch("/api/tray/outbound", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                if (result.error) {
                    showToast(`‚ùå ${result.error}`, false);
                } else {
                    showToast(`‚úÖ ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß...`, true);
                    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    refreshDataAndViews();
                }
            } catch (error) {
                console.error("‚ùå ‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
                showToast("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", false);
            }
        }
    }); 
}
function checkOutboundSlot() {
  const floor = safeGetElementValue("outFloor");
  const slot = safeGetElementValue("outSlot");
  const key = `${floor}-${slot}`;

  // ‡∏î‡∏∂‡∏á element ‡∏ï‡πà‡∏≤‡∏á‡πÜ
  const validationBox = document.getElementById("outboundValidationBox");
  const detailsPreview = document.getElementById("trayDetailsPreview");
  const warning = document.getElementById("outboundWarning");
  const reasonSelect = document.getElementById("outReason");
  const destinationInput = document.getElementById("outDestination");
  const confirmBtn = document.getElementById("outboundConfirmBtn");

  const trayInfo = trayInventory[key];

  validationBox.style.display = "block"; // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏°‡∏≠

  if (trayInfo) {
    // ---- ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏à‡∏≠‡∏ñ‡∏≤‡∏î ----
    validationBox.classList.add("success");
    validationBox.classList.remove("warning");

    // ‚úÖ‚úÖ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY ‚úÖ‚úÖ‚úÖ
    const formattedDate = new Date(trayInfo.time_in).toLocaleDateString('th-TH', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric' // ‡πÉ‡∏ä‡πâ 'numeric' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏õ‡∏µ ‡∏Ñ.‡∏®.
    });

    detailsPreview.innerHTML = `<i class="fas fa-check-circle"></i> ‡∏û‡∏ö‡∏ñ‡∏≤‡∏î: ${trayInfo.veg_type} | ‡∏ß‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formattedDate}`;
    detailsPreview.style.display = "block";
    warning.style.display = "none";

    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    reasonSelect.disabled = false;
    destinationInput.disabled = false;
    confirmBtn.disabled = false;

  } else {
    // ---- ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ñ‡∏≤‡∏î (‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á) ----
    validationBox.classList.add("warning");
    validationBox.classList.remove("success");

    warning.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ñ‡∏≤‡∏î‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà`;
    warning.style.display = "block";
    detailsPreview.style.display = "none";

    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    reasonSelect.disabled = true;
    destinationInput.disabled = true;
    confirmBtn.disabled = true;
  }
}

function showTrayInboundPage() {
  const html = renderInboundPage();
  document.getElementById("mainContent").innerHTML = html;
}

function renderTrayManagement() {
  const html = `
    <div class="section" style="padding: 30px;">
      <h2 style="font-size: 1.8em; color: #1b4332; margin-bottom: 30px;">
        üß∫ Tray Management
      </h2>
      <div style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: space-between;">
        ${renderInboundSection()}
        ${renderOutboundSection()}
      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadTrayInventory(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    const trayTimer = addManagedTimer(setInterval(() => {
      debounceApiCall('trayInventory', loadTrayInventory, 200);
    }, 5000)); // ‡πÄ‡∏£‡∏¥‡πà‡∏° polling
    activeTimers.add(trayTimer); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Timer ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
}

function renderInboundPage() {
  return `
    <form id="inboundForm" onsubmit="event.preventDefault(); submitInboundForm();">
      <div class="form-container-deluxe">
        <div class="form-header">
            <h2 class="form-title">
              <i class="fas fa-seedling"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ñ‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà (Inbound)
            </h2>
            <p class="form-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ñ‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
        </div>

        <input type="hidden" id="inWorkOrderId" name="work_order_id">
        <input type="hidden" id="inPlantingPlanId" name="planting_plan_id">

        <div class="form-grid">
          <div class="form-group">
              <label for="inFloor"><i class="fas fa-layer-group"></i> ‡∏ä‡∏±‡πâ‡∏ô</label>
              <select id="inFloor" name="floor" class="form-input-deluxe">
                  ${[...Array(8)].map((_, i) => `<option value="${i + 1}">‡∏ä‡∏±‡πâ‡∏ô ${i + 1}</option>`).join('')}
              </select>
          </div>

          <div class="form-group">
              <label for="inSlot"><i class="fas fa-th-large"></i> ‡∏ä‡πà‡∏≠‡∏á</label>
              <select id="inSlot" name="slot" class="form-input-deluxe">
                  ${[...Array(18)].map((_, i) => `<option value="${i + 1}">‡∏ä‡πà‡∏≠‡∏á ${i + 1}</option>`).join('')}
              </select>
          </div>

          <div class="form-group">
              <label for="inVeg"><i class="fas fa-seedling"></i> ‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</label>
              <input type="text" id="inVeg" name="veg_type" class="form-input-deluxe" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏±‡∏Å...">
          </div>

          <div class="form-group">
              <label for="inPlantQuantity"><i class="fas fa-sort-numeric-up"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô</label>
              <input type="number" id="inPlantQuantity" name="quantity" class="form-input-deluxe" placeholder="‡πÄ‡∏ä‡πà‡∏ô 16">
          </div>

          <div class="form-group">
              <label for="inBatchId"><i class="fas fa-tag"></i> ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (Batch ID)</label>
              <input type="text" id="inBatchId" name="batch_id" class="form-input-deluxe" placeholder="‡πÄ‡∏ä‡πà‡∏ô BK-020725-A">
          </div>

          <div class="form-group">
              <label for="inSeedingDate"><i class="fas fa-calendar-check"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î</label>
              <input type="date" id="inSeedingDate" name="seeding_date" class="form-input-deluxe">
          </div>
          
          <div class="form-group">
            <label for="inHarvestDate"><i class="fas fa-tractor"></i>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</label>
            <input type="date" id="inHarvestDate" name="harvest_date" class="form-input-deluxe">
          </div>

          <div class="form-group full-width">
              <label for="inNotes"><i class="fas fa-edit"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <textarea id="inNotes" name="notes" class="form-input-deluxe" rows="4" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
          </div>
        </div>

        <button type="submit" class="form-button-action">
            <i class="fas fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î
        </button>
      </div>
    </form>
  `;
}


// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏´‡∏ô‡πâ‡∏≤ Outbound ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏±‡πâ‡∏ô
function renderOutboundPage() {
  return `
    <div class="form-container-deluxe">
      <div class="form-header">
        <h2 class="form-title">
          <i class="fas fa-dolly-flatbed" style="color: #e63946;"></i>
          ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å (Outbound)
        </h2>
        <p class="form-subtitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ä‡∏±‡πâ‡∏ô" ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
      </div>

      <div class="form-grid" style="grid-template-columns: 1fr;">
        <div class="form-group">
            <label for="outFloor"><i class="fas fa-layer-group"></i> <strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô (Lane)</strong></label>
            <select id="outFloor" class="form-input-deluxe" onchange="validateOutboundFloor()">
                <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô --</option>
                ${[...Array(9)].map((_, i) => `<option value="${i + 1}">‡∏ä‡∏±‡πâ‡∏ô ${i + 1}</option>`).join('')}
            </select>
        </div>

        <div id="outboundValidationBox" class="form-group full-width" style="display: none;">
             </div>

        <div class="form-group">
            <label for="outReason"><i class="fas fa-question-circle"></i> ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å</label>
            <select id="outReason" class="form-input-deluxe" disabled>
                <option>‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á / ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô</option>
                <option>‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤</option>
                <option>‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á</option>
                <option>‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡∏≤‡∏î</option>
            </select>
        </div>
        <div class="form-group">
            <label for="outDestination"><i class="fas fa-map-marked-alt"></i> ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
            <input type="text" id="outDestination" class="form-input-deluxe" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏•‡πâ‡∏≤‡∏á, ‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏û‡πá‡∏Ñ" disabled>
        </div>
      </div>

      <button id="outboundConfirmBtn" class="form-button-action danger" onclick="handleOutbound()" disabled>
          <i class="fas fa-cogs"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô
      </button>
    </div>
  `;
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á select box ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏´‡∏£‡∏π
function createSelectBox(label, id, options) {
  return `
    <div>
      <label style="font-weight: 600; color: #444; display: block; margin-bottom: 8px;">${label}</label>
      <select id="${id}" style="
        width: 100%;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid rgba(0,0,0,0.08);
        background: rgba(255, 255, 255, 0.9);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        font-size: 1em;
        transition: border 0.2s;
      " onfocus="this.style.border='1px solid #4ade80'" onblur="this.style.border='1px solid rgba(0,0,0,0.08)'">
        ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
      </select>
    </div>
  `;
}


function renderTrayMasterPage() {
  const html = `
    <div class="premium-tray-master-container">
      <!-- ‚ú® Premium Header Section -->
      <div class="premium-header-section">
        <div class="premium-header-content">
          <div class="premium-icon-wrapper">
            <i class="fas fa-layer-group"></i>
          </div>
          <div class="premium-header-text">
            <h1>Tray Master</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏î‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£</p>
          </div>
        </div>
        <div class="premium-stats-grid">
          <div class="premium-stat-card">
            <div class="stat-icon green">
              <i class="fas fa-boxes"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="totalTraysCount">-</div>
              <div class="stat-label">‡∏ñ‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
          </div>
          <div class="premium-stat-card">
            <div class="stat-icon blue">
              <i class="fas fa-warehouse"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="inStorageCount">-</div>
              <div class="stat-label">‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</div>
            </div>
          </div>
          <div class="premium-stat-card">
            <div class="stat-icon orange">
              <i class="fas fa-cogs"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="atWorkstationCount">-</div>
              <div class="stat-label">‡∏ó‡∏µ‡πà Workstation</div>
            </div>
          </div>
          <div class="premium-stat-card">
            <div class="stat-icon purple">
              <i class="fas fa-seedling"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="uniqueVegetableCount">-</div>
              <div class="stat-label">‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ú® Premium Filter Section -->
      <div class="premium-filter-section">
        <div class="premium-search-bar">
          <div class="search-input-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" id="traySearchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Tray ID, Batch ID, ‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å..." oninput="loadTrayMasterData()">
          </div>
        </div>
        
        <div class="premium-filters-grid">
          <div class="premium-filter-item">
            <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <select id="trayStatusFilter" class="premium-select" onchange="loadTrayMasterData()">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="on_shelf">‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</option>
              <option value="AT_WORKSTATION">‡∏ó‡∏µ‡πà Workstation</option>
            </select>
          </div>

          <div class="premium-filter-item">
            <label>‡∏ñ‡∏≤‡∏î</label>
            <div class="premium-searchable-select">
              <input type="text" id="trayVegFilter" class="premium-select" 
                     placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ñ‡∏≤‡∏î..." 
                     oninput="loadTrayMasterData(); filterVegetableOptions(this.value)">
              <div class="dropdown-suggestions" id="vegetableSuggestions"></div>
            </div>
          </div>
          
          <div class="premium-filter-item">
            <button class="premium-export-btn" onclick="exportTrayMasterToExcel()">
              <i class="fas fa-file-excel"></i>
              <span>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</span>
            </button>
          </div>
        </div>
      </div>

      <!-- ‚ú® Premium Table Section -->
      <div class="premium-table-container">
        <div class="premium-table-wrapper">
          <table class="premium-table">
            <thead>
              <tr>
                <th>
                  <div class="th-content">
                    <i class="fas fa-qrcode"></i>
                    <span>Tray ID</span>
                  </div>
                </th>
                <th>
                  <div class="th-content">
                    <i class="fas fa-barcode"></i>
                    <span>Batch ID</span>
                  </div>
                </th>
                <th>
                  <div class="th-content">
                    <i class="fas fa-leaf"></i>
                    <span>‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</span>
                  </div>
                </th>
                <th>
                  <div class="th-content">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
                  </div>
                </th>
                <th>
                  <div class="th-content">
                    <i class="fas fa-sort-numeric-up"></i>
                    <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>
                  </div>
                </th>
                <th>
                  <div class="th-content">
                    <i class="fas fa-calendar-alt"></i>
                    <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞</span>
                  </div>
                </th>
                <th>
                  <div class="th-content">
                    <i class="fas fa-clock"></i>
                    <span>‡∏≠‡∏≤‡∏¢‡∏∏</span>
                  </div>
                </th>
                <th>
                  <div class="th-content">
                    <i class="fas fa-info-circle"></i>
                    <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
                  </div>
                </th>
                <th>
                  <div class="th-content">
                    <i class="fas fa-sticky-note"></i>
                    <span>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</span>
                  </div>
                </th>
                <th>
                  <div class="th-content">
                    <i class="fas fa-cogs"></i>
                    <span>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</span>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="trayMasterTableBody">
              <tr class="loading-row">
                <td colspan="10">
                  <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
}

function renderWorkstationPage() {
  const html = `
    <!-- ‚ú® Premium Workstation Container -->
    <div class="premium-page-container">
      <!-- ‚ú® Premium Header -->
      <div class="premium-page-header">
        <div class="premium-page-icon">
          <i class="fas fa-dolly"></i>
        </div>
        <div class="premium-page-title-section">
          <h1>Workstation</h1>
          <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</p>
        </div>
        <div class="premium-page-stats">
          <div class="stat-item">
            <span class="stat-label">‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
            <span class="stat-value" id="pendingTasksCount">-</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
            <span class="stat-value" id="activeTasksCount">-</span>
          </div>
        </div>
      </div>

      <!-- ‚ú® Premium Content -->
      <div class="premium-page-content">
        <div class="premium-card">
          <div class="premium-card-header">
            <h3><i class="fas fa-tasks"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
          </div>
          <div class="premium-card-body">
            <div id="workstationDisplay">
              <div class="loading-container">
                <div class="loading-spinner"></div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;

  
}
// ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÅ‡∏•‡∏∞ scroll ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤ Login ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
function showLoginPage() {
  const container = document.querySelector('.login-container');
  if (container) {
    container.style.height = 'auto';
    container.scrollIntoView({ behavior: 'smooth' });
  }
}

function renderTrayGridView() {
  return `
    <div class="section">
      
      <h2 style="display: flex; align-items: center; gap: 14px; margin-bottom: 20px; color: #1b4332; font-weight: 600;">
        <i class="fas fa-boxes-stacked" style="font-size: 1.6em; color: #8d6e63; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); transform: translateY(-2px);"></i>
        <span>‡∏Ñ‡∏•‡∏±‡∏á‡∏ñ‡∏≤‡∏î - Tray Inventory</span>
      </h2>

      <div style="overflow-x: auto;">
        <div class="tray-grid" style="display: grid; grid-template-columns: auto repeat(18, 1fr); gap: 12px; padding: 20px;">
          ${generateTrayGridHTML()}
        </div>
      </div>
    </div>
  `;
}
// ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå index.html
// ‚úÖ [Polished & Animated Edition] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á Tray Inventory
function generateTrayGridHTML() {
  let html = "";
  const totalFloors = 8;
  const totalSlots = 18;

  html += `<div class="tray-header-cell"></div>`; 
  for (let slot = 1; slot <= totalSlots; slot++) {
    html += `<div class="tray-header-cell">‡∏ä‡πà‡∏≠‡∏á ${slot}</div>`;
  }

  for (let floor = totalFloors; floor >= 1; floor--) {
    html += `<div class="tray-header-cell">‡∏ä‡∏±‡πâ‡∏ô ${floor}</div>`;

    for (let slot = 1; slot <= totalSlots; slot++) {
      const key = `${floor}-${slot}`;
      const info = trayInventory[key];
      const isFilled = info && (info.status === 'on_shelf' || info.status === 'IN_STORAGE');
      
      const title = isFilled 
        ? `${info.veg_type} (ID: ${info.tray_id})\n‡∏ß‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(info.time_in).toLocaleString("th-TH")}` 
        : `‡∏ß‡πà‡∏≤‡∏á`;

      // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• harvest_date, batch_number, plan_notes, ‡πÅ‡∏•‡∏∞ seeding_date ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Popup
      const onclickAction = isFilled 
        ? `showTrayInfoPopup({ 
             trayId: '${info.tray_id}', 
             username: '${info.username}', 
             veg: '${info.veg_type}', 
             floor: ${floor}, 
             slot: ${slot}, 
             timestamp: '${new Date(info.time_in).toLocaleString("th-TH")}', 
            age: calculateTrayAge('${info.time_in}'),
             harvestDate: '${info.harvest_date ? new Date(info.harvest_date).toLocaleDateString("th-TH") : 'N/A'}',
             batchNumber: '${info.batch_id || info.batch_number || 'N/A'}',
             planNotes: '${(info.plan_notes || '').replace(/'/g, "\\'")}',
             seedingDate: '${info.seeding_date ? new Date(info.seeding_date).toLocaleDateString("th-TH") : 'N/A'}',
             plantCount: '${info.plant_quantity || info.plant_count || info.quantity || 0}'
           })`
        : '';
      
      let cellContent = '';
      if (isFilled) {
        cellContent = `
          <div class="filled-tray-icon"><i class="fas fa-leaf"></i></div>
          <div class="filled-tray-veg-name">${info.veg_type.substring(0, 12)}</div>
          <div class="filled-tray-id">${info.tray_id}</div>
        `;
      } else {
        cellContent = `<span class="empty-slot-coords">‡∏ä‡∏±‡πâ‡∏ô ${floor} / ${slot}</span>`;
      }

      html += `
        <div class="tray-slot ${isFilled ? 'filled' : 'empty'}"
             title="${title}"
             onclick="${onclickAction}">
          ${cellContent}
        </div>`;
    }
  }
  return html;
}
// ‚úÖ‚úÖ‚úÖ [FINAL VERSION] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤" ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Polling ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚úÖ‚úÖ‚úÖ
let trayInventoryInterval = null; // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÑ‡∏ß‡πâ‡∏ô‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
function showPage(pageName, event) {
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    const page = pageName;
  
  // ‚úÖ ‡∏´‡∏¢‡∏∏‡∏î timers ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô memory leaks
  stopAllTimers();
  
  // Cleanup before switching pages
  if (currentPage !== page) {
    cleanupCurrentPage();
  }
  
  currentPage = page;
  // Don't clear timers here - already done in cleanup
  setActiveSidebar(page);
 document.body.className = document.body.className.replace(/page-\w+/g, '');
    document.body.classList.add(`page-${page}`);
  
  const mainContent = document.getElementById("mainContent");
  mainContent.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
if (page === 'tray-map') {
    // 1. ‡∏ß‡∏≤‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ "‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß"
    const initialHTML = `
        <div class="section">
          <h2 style="display: flex; align-items: center; gap: 14px; margin-bottom: 20px; color: #1b4332; font-weight: 600;">
            <i class="fas fa-boxes-stacked" style="font-size: 1.6em; color: #8d6e63; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); transform: translateY(-2px);"></i>
            <span>‡∏Ñ‡∏•‡∏±‡∏á‡∏ñ‡∏≤‡∏î - Tray Inventory</span>
          </h2>
          <div style="overflow-x: auto;">
            <div class="tray-grid" style="display: grid; grid-template-columns: auto repeat(18, 1fr); gap: 12px; padding: 20px;">
              <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                  <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
              </div>
            </div>
          </div>
        </div>
    `;
    mainContent.innerHTML = initialHTML;

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á"
    const refreshGridOnly = () => {
        loadTrayInventory().then(() => {
            const gridContainer = document.querySelector(".tray-grid");
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ element '.tray-grid' ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
            if (gridContainer && currentPage === 'tray-map') {
                gridContainer.innerHTML = generateTrayGridHTML(); // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            }
        });
    };

    // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤
    refreshGridOnly();
    const trayTimer = setInterval(refreshGridOnly, 10000); // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ - optimized for performance
    activeTimers.add(trayTimer);

    return;
}

    if (page === 'tray-master') {
    renderTrayMasterPage();
    loadTrayInventory().then(() => {
        loadTrayMasterData();
    });
    // Auto-refresh disabled for better performance - reload manually if needed
    // trayMasterTimer = setInterval(loadTrayMasterData, 5000);
    // activeTimers.push(trayMasterTimer);
    return;
}

  if (page === 'light-control') {
    renderLightControlPage(); // ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö Light Control
    startLightControlPolling(); // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£ Polling ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ UI ‡∏à‡∏≤‡∏Å Backend
    return;
  }

  if (page === 'watering-system') {
    renderWateringSystemPage();
    loadWaterSystemData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å backend
    startWateringSystemPolling();
    return;
  }


/**
 * üí° [NEW] Helper ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°, onchange ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å markFloorAsChanged
 */
function createControlRow(type, floor, icon, color) {
    return `
        <div class="control-row">
            <i class="fas ${icon} control-icon" style="color: ${color};"></i>
            <div class="slider-container">
                <input type="range" min="0" max="100" value="0" class="premium-slider device-slider"
                       onchange="markFloorAsChanged(${floor})"
                       oninput="updateSliderVisual(this, '${type}', ${floor})"
                       data-floor="${floor}" data-type="${type}" style="--fill-color: ${color};">
            </div>
            <span class="control-value" id="${type}-value-${floor}">0%</span>
            <button class="control-timer-btn" onclick="openIndividualTimerModal('${type}', ${floor})">
                <i class="fas fa-clock"></i>
            </button>
        </div>
    `;
}
if (page === 'workstation') {
    renderWorkstationPage(); 

    currentWorkstationState = null; // ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ] ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡πà‡∏≤

    checkWorkstationStatus(); 
    const workstationTimer = setInterval(checkWorkstationStatus, 8000);
    activeTimers.add(workstationTimer);

    return;
}
if (page === 'overview') {
    renderOverviewPage();
    return;
}

    

  if (page === 'tray-outbound') {
    mainContent.innerHTML = renderOutboundPage();
    loadTrayInventory().then(() => {
      // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å checkOutboundSlot() ‡πÄ‡∏õ‡πá‡∏ô validateOutboundFloor()
      validateOutboundFloor(); 
    });
    const outboundTimer = setInterval(() => {
      loadTrayInventory().then(() => {
        if (currentPage === 'tray-outbound') {
          // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å checkOutboundSlot() ‡πÄ‡∏õ‡πá‡∏ô validateOutboundFloor()
          validateOutboundFloor();
        }
      });
    }, 5000);
    activeTimers.add(outboundTimer);
    return;
  }

  if (page === 'task') {
    renderTaskPage();
    loadTaskMonitor(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏° polling
    const taskTimer = setInterval(loadTaskMonitor, 5000);
    activeTimers.add(taskTimer);
    return;
  }

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô index.html
function renderTaskPage() {
  const html = `
    <div class="bg-gradient-to-br from-white via-gray-50 to-blue-50 rounded-3xl shadow-2xl border border-gray-100 overflow-hidden">
      <!-- Header Section with Gradient -->
      <div class="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 px-8 py-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div class="bg-white/20 rounded-xl p-3 backdrop-blur-sm">
              <i class="fas fa-tasks text-2xl text-white"></i>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-white font-thai">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h2>
              <p class="text-blue-100 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
            </div>
          </div>
          <div class="bg-white/10 backdrop-blur-md rounded-xl px-4 py-2 border border-white/20">
            <span class="text-white/90 text-sm">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
            <span class="text-white font-medium" id="lastUpdateTime">-</span>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="p-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl p-6 text-white shadow-lg transform hover:scale-105 transition-all duration-300">
            <div class="flex items-center justify-between">
              <div>
                <div class="bg-white/20 rounded-xl p-3 w-fit mb-3">
                  <i class="fas fa-clock text-2xl"></i>
                </div>
                <p class="text-white/90 text-sm font-medium">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                <p class="text-3xl font-bold font-thai" id="pendingCount">0</p>
              </div>
              <div class="text-white/30">
                <i class="fas fa-clock text-4xl"></i>
              </div>
            </div>
          </div>
          
          <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-6 text-white shadow-lg transform hover:scale-105 transition-all duration-300">
            <div class="flex items-center justify-between">
              <div>
                <div class="bg-white/20 rounded-xl p-3 w-fit mb-3">
                  <i class="fas fa-cogs text-2xl animate-spin"></i>
                </div>
                <p class="text-white/90 text-sm font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
                <p class="text-3xl font-bold font-thai" id="workingCount">0</p>
              </div>
              <div class="text-white/30">
                <i class="fas fa-cogs text-4xl"></i>
              </div>
            </div>
          </div>
          
          <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-6 text-white shadow-lg transform hover:scale-105 transition-all duration-300">
            <div class="flex items-center justify-between">
              <div>
                <div class="bg-white/20 rounded-xl p-3 w-fit mb-3">
                  <i class="fas fa-check-circle text-2xl"></i>
                </div>
                <p class="text-white/90 text-sm font-medium">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</p>
                <p class="text-3xl font-bold font-thai" id="successCount">0</p>
              </div>
              <div class="text-white/30">
                <i class="fas fa-check-circle text-4xl"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Modern Table -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
          <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 font-thai flex items-center">
              <i class="fas fa-list text-indigo-600 mr-3"></i>
              ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô
            </h3>
          </div>
          
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gradient-to-r from-indigo-50 to-purple-50">
                <tr>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-qrcode text-indigo-600 mr-2"></i>‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏≤‡∏î
                  </th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-layer-group text-indigo-600 mr-2"></i>‡∏ä‡∏±‡πâ‡∏ô
                  </th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-grip-vertical text-indigo-600 mr-2"></i>‡∏ä‡πà‡∏≠‡∏á
                  </th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-info-circle text-indigo-600 mr-2"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                  </th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-play text-indigo-600 mr-2"></i>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°
                  </th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-check text-indigo-600 mr-2"></i>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                  </th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-tag text-indigo-600 mr-2"></i>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                  </th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-user text-indigo-600 mr-2"></i>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                  </th>
                </tr>
              </thead>
              <tbody id="taskTableBody" class="divide-y divide-gray-100">
                <!-- Tasks will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  loadTaskMonitor();
}



 if (page === 'task-history') {
    renderTaskHistoryPage();
    loadTaskHistory(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    return;
  }
  
function renderTaskHistoryPage() {
  const html = `
    <div class="bg-gradient-to-br from-white via-gray-50 to-purple-50 rounded-3xl shadow-2xl border border-gray-100 overflow-hidden">
      <!-- Header Section with Gradient -->
      <div class="bg-gradient-to-r from-purple-600 via-pink-600 to-indigo-600 px-8 py-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div class="bg-white/20 rounded-xl p-3 backdrop-blur-sm">
              <i class="fas fa-history text-2xl text-white"></i>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-white font-thai">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
              <p class="text-purple-100 text-sm">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
            </div>
          </div>
          <div class="bg-white/10 backdrop-blur-md rounded-xl px-4 py-2 border border-white/20">
            <span class="text-white/90 text-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
            <span class="text-white font-medium" id="totalTaskCount">-</span>
          </div>
        </div>
      </div>

      <!-- Stats Overview -->
      <div class="p-8">
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
          <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-4 text-white shadow-lg transform hover:scale-105 transition-all duration-300">
            <div class="flex items-center justify-between">
              <div>
                <div class="bg-white/20 rounded-lg p-2 w-fit mb-2">
                  <i class="fas fa-calendar-day text-lg"></i>
                </div>
                <p class="text-white/90 text-xs font-medium">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                <p class="text-2xl font-bold font-thai" id="todayTaskCount">-</p>
              </div>
            </div>
          </div>
          
          <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-4 text-white shadow-lg transform hover:scale-105 transition-all duration-300">
            <div class="flex items-center justify-between">
              <div>
                <div class="bg-white/20 rounded-lg p-2 w-fit mb-2">
                  <i class="fas fa-arrow-down text-lg"></i>
                </div>
                <p class="text-white/90 text-xs font-medium">‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤</p>
                <p class="text-2xl font-bold font-thai" id="inboundCount">-</p>
              </div>
            </div>
          </div>
          
          <div class="bg-gradient-to-br from-orange-500 to-red-500 rounded-2xl p-4 text-white shadow-lg transform hover:scale-105 transition-all duration-300">
            <div class="flex items-center justify-between">
              <div>
                <div class="bg-white/20 rounded-lg p-2 w-fit mb-2">
                  <i class="fas fa-arrow-up text-lg"></i>
                </div>
                <p class="text-white/90 text-xs font-medium">‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å</p>
                <p class="text-2xl font-bold font-thai" id="outboundCount">-</p>
              </div>
            </div>
          </div>
          
          <div class="bg-gradient-to-br from-teal-500 to-cyan-600 rounded-2xl p-4 text-white shadow-lg transform hover:scale-105 transition-all duration-300">
            <div class="flex items-center justify-between">
              <div>
                <div class="bg-white/20 rounded-lg p-2 w-fit mb-2">
                  <i class="fas fa-check-circle text-lg"></i>
                </div>
                <p class="text-white/90 text-xs font-medium">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                <p class="text-2xl font-bold font-thai" id="successCount">-</p>
              </div>
            </div>
          </div>
          
          <div class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl p-4 text-white shadow-lg transform hover:scale-105 transition-all duration-300">
            <div class="flex items-center justify-between">
              <div>
                <div class="bg-white/20 rounded-lg p-2 w-fit mb-2">
                  <i class="fas fa-clock text-lg"></i>
                </div>
                <p class="text-white/90 text-xs font-medium">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                <p class="text-2xl font-bold font-thai" id="pendingCount">-</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Search and Filter Controls -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
          <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
            <div class="flex flex-col md:flex-row gap-4 items-center flex-1">
              <div class="relative flex-1 min-w-[250px]">
                <input 
                  type="text" 
                  id="historySearch" 
                  placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏≤‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ..." 
                  class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent font-thai"
                >
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
              </div>
              
              <select 
                id="historyFilter" 
                class="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent font-thai bg-white min-w-[150px]"
              >
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="inbound">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</option>
                <option value="outbound">‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å</option>
              </select>
            </div>
            
            <div class="relative">
              <button 
                onclick="openExportModal()" 
                class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center space-x-2"
              >
                <i class="fas fa-file-excel"></i>
                <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel</span>
              </button>
              
              <div class="excel-dropdown-menu absolute right-0 top-full mt-2 bg-white rounded-xl shadow-2xl border border-gray-100 py-2 min-w-[200px] hidden z-50" id="excelDropdown">
                <a href="#" onclick="exportTaskHistoryToExcel('today')" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 font-thai">
                  <i class="fas fa-calendar-day mr-2 text-blue-500"></i>‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                </a>
                <a href="#" onclick="exportTaskHistoryToExcel('all')" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 font-thai">
                  <i class="fas fa-database mr-2 text-green-500"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Modern Table -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
          <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 font-thai flex items-center">
              <i class="fas fa-list text-purple-600 mr-3"></i>
              ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            </h3>
          </div>
          
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gradient-to-r from-purple-50 to-pink-50">
                <tr>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-qrcode text-purple-600 mr-2"></i>‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏≤‡∏î
                  </th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-layer-group text-purple-600 mr-2"></i>‡∏ä‡∏±‡πâ‡∏ô
                  </th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-grip-vertical text-purple-600 mr-2"></i>‡∏ä‡πà‡∏≠‡∏á
                  </th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-info-circle text-purple-600 mr-2"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                  </th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-play text-purple-600 mr-2"></i>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°
                  </th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-check text-purple-600 mr-2"></i>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                  </th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-tag text-purple-600 mr-2"></i>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                  </th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 font-thai">
                    <i class="fas fa-user text-purple-600 mr-2"></i>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                  </th>
                </tr>
              </thead>
              <tbody id="taskHistoryTableBody" class="divide-y divide-gray-100">
                <tr>
                  <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                    <div class="flex flex-col items-center space-y-3">
                      <i class="fas fa-spinner fa-spin text-3xl text-purple-500"></i>
                      <p class="font-thai text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Pagination -->
        <div class="mt-6 flex justify-center">
          <div id="taskHistoryPagination" class="flex items-center space-x-2"></div>
        </div>
      </div>
    </div>
  `;
  document.getElementById("mainContent").innerHTML = html;
  
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
  initTaskHistoryPage();
  setupHistoryEventListeners();
}
 



  if (page === 'tray') {
    renderTrayManagement();
    return;
  }
if (page === 'lift') {
  const currentFloor = parseInt(localStorage.getItem('currentFloor')) || 1;

  html = `

<div id="liftStatusBox" class="lift-status success">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="margin-right: 12px;">
    <circle cx="12" cy="12" r="10" fill="#2dcc6f"/>
    <path d="M9 12.5l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
</div>




<div id="liftToast" style="position: fixed; top: 20px; right: 20px; background: #333; color: white; padding: 12px 20px; border-radius: 8px; font-weight: bold; z-index: 9999; display: none;">
  <span id="liftToastMessage"></span>
</div>


    <div class="section">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
        <i class="fas fa-elevator" style="font-size: 1.8rem; color: #2d6a4f;"></i>
        <h2 style="margin: 0; font-size: 1.8rem; font-weight: 600; color: #1b4332;">Lift Control</h2>
      </div>

      <div style="display: flex; align-items: flex-start; gap: 40px; max-width: 1100px; margin: auto;">

        <!-- üî≤ ‡∏£‡∏π‡∏õ‡∏•‡∏¥‡∏ü‡∏ï‡πå -->
        <div style="position: relative; width: 260px; height: 600px; border-radius: 12px; overflow: hidden;">
          <img src="lift_9levels.png.jpg" alt="Lift Structure"
               style="width: 100%; height: 100%; object-fit: contain;" />
          <img id="liftCart" src="lift_cart.png.png" alt="Lift Cart"
               style="position: absolute; left: 50%; transform: translateX(-50%);
                      width: 86%; transition: top 0.05s linear; z-index: 10;" />
        </div>

        <!-- üî¢ LEVEL INDICATOR -->
        <div style="height: 600px; display: flex; flex-direction: column; justify-content: space-around;
                    background: #e6f4ea; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <h4 style="text-align:center; margin-bottom: 12px; color: #2d6a4f;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏¥‡∏ü‡∏ï‡πå<br>(LEVEL)</h4>
          ${[...Array(9)].map((_, i) => {
            const level = 8 - i;
            return `<div id="floor-${level}" style="margin: 6px 0; display: flex; align-items: center;">
                      <span data-light style="display:inline-block; width: 16px; height: 16px; border-radius: 50%; 
                           background: #ccc; margin-right: 8px; transition: all 0.3s;"></span>
                      <span style="color: #2d6a4f; font-weight: 600;">‡∏ä‡∏±‡πâ‡∏ô ${level}</span>
                    </div>`;
          }).join('')}
        </div>

        <!-- üîò ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
        <div style="min-width: 180px;">
          <div id="currentFloorDisplay"
            style="margin-bottom: 16px; padding: 12px; background: #d8f3dc; color: #1b4332;
                   border: 2px solid #52b788; border-radius: 12px; font-size: 1.1rem; font-weight: bold;
                   text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
            ‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô: <span id="currentFloor">${currentFloor}</span>
          </div>

          <label for="floorSelect" style="font-weight: bold;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô:</label>
          <select id="floorSelect" style="padding: 8px; width: 100%; margin: 10px 0;">
            ${[...Array(8)].map((_, i) => `<option value="${i + 1}">‡∏ä‡∏±‡πâ‡∏ô ${i + 1}</option>`).join('')}
          </select>
          <button onclick="moveLift()" 
            style="padding: 10px 20px; background: #2d6a4f; color: white; border: none; border-radius: 6px; width: 100%; cursor: pointer;">
            ‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏¥‡∏ü‡∏ï‡πå
          </button>

          <div style="margin-top: 20px; padding: 16px; background: #f0fdf4; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <h4 style="color: #1b4332; margin-bottom: 16px;">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏ö‡∏ö Manual</h4>
            <button class="manual-btn"
              onmousedown="startLiftMove('up')"
              onmouseup="stopLiftMove()"
              onmouseleave="stopLiftMove()">
              <i class="fas fa-arrow-up"></i> ‡∏Ç‡∏∂‡πâ‡∏ô
            </button>
            <button class="manual-btn"
              onmousedown="startLiftMove('down')"
              onmouseup="stopLiftMove()"
              onmouseleave="stopLiftMove()">
              <i class="fas fa-arrow-down"></i> ‡∏•‡∏á
            </button>
             <!-- ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á EMERGENCY ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á Manual -->
<div style="margin-top: 20px; padding: 16px; background: #fff5f5;
            border-radius: 16px; width: 220px; text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #f5c2c7;">
  <h4 style="color: #c1121f; margin-bottom: 16px;">‡∏õ‡∏∏‡πà‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (EMERGENCY)</h4>
  <button id="emButton" onclick="toggleEmergency()"
    style="padding: 12px 20px; font-weight: bold; border: none; border-radius: 8px;
           background: #c1121f; color: white; font-size: 1rem; width: 100%; cursor: pointer;">
    ‚õî ‡∏´‡∏¢‡∏∏‡∏î‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  </button>
</div>
          </div>
        </div>
      </div>
    </div>
  `;

  document.getElementById("mainContent").innerHTML = html;

  // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
  initLiftPage();
    // connectMqttLift();     // ‚ùå ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡πÉ‡∏ä‡πâ WebSocket backend ‡πÅ‡∏ó‡∏ô
  return;
}
function connectMqttLift() {
  client.subscribe("automation/station1/lift/status", (err) => {
    if (err) {
      console.error("‚ùå MQTT subscribe failed:", err.message);
    } else {
    }
  });

  client.on("message", (topic, message) => {
    if (topic === "automation/station1/lift/status") {
      try {
        const data = JSON.parse(message.toString());
        currentLiftFloor = data.floor;
        isLiftMoving = data.moving;
        isEmergency = data.emergency || false;

        // ‚úÖ Sync UI
        updateLiftDisplay(currentLiftFloor);

        const floorDisplay = document.getElementById("currentFloor");
        if (floorDisplay) floorDisplay.innerText = currentLiftFloor;

        const movingStatus = document.getElementById("movingStatus");
        if (movingStatus) movingStatus.innerText = isLiftMoving ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà..." : "‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏¥‡πà‡∏á";

        const statusBox = document.getElementById("liftStatusBox");
        if (statusBox) {
          statusBox.innerText = isEmergency ? "üö® ‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥" : "üü¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥";
        }

      } catch (e) {
        console.error("MQTT parse error:", e);
      }
    }
  });
}
function renderAgvPage() {
  return `
    <div class="section">
      <!-- ‚ú® Premium Header Block -->
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3); position: relative; overflow: hidden;">
        <!-- Background Pattern -->
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('data:image/svg+xml,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 100 100&quot;><defs><pattern id=&quot;grain&quot; patternUnits=&quot;userSpaceOnUse&quot; width=&quot;100&quot; height=&quot;100&quot;><circle cx=&quot;25&quot; cy=&quot;25&quot; r=&quot;1&quot; fill=&quot;%23ffffff&quot; opacity=&quot;0.1&quot;/><circle cx=&quot;75&quot; cy=&quot;75&quot; r=&quot;1&quot; fill=&quot;%23ffffff&quot; opacity=&quot;0.1&quot;/></pattern></defs><rect width=&quot;100&quot; height=&quot;100&quot; fill=&quot;url(%23grain)&quot;/></svg>') repeat; opacity: 0.3;"></div>
        
        <div style="position: relative; z-index: 1; display: flex; align-items: center; gap: 20px;">
          <div style="background: rgba(255, 255, 255, 0.2); padding: 20px; border-radius: 15px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
            <i class="fas fa-truck-moving" style="color: white; font-size: 3rem; filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));"></i>
          </div>
          <div>
            <h1 style="color: white; font-size: 2.5rem; font-weight: 800; margin: 0; text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); letter-spacing: -0.5px;">RGV Control Center</h1>
            <p style="color: rgba(255, 255, 255, 0.9); font-size: 1.1rem; margin: 8px 0 0 0; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏Ç‡∏ô‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
          </div>
        </div>
        
        <!-- Floating Elements -->
        <div style="position: absolute; top: 20px; right: 30px; width: 60px; height: 60px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; animation: float 6s ease-in-out infinite;"></div>
        <div style="position: absolute; bottom: 20px; right: 60px; width: 40px; height: 40px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; animation: float 4s ease-in-out infinite reverse;"></div>
      </div>

      <!-- ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ AGV ‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° -->
      <div id="agvTaskStatus">
        <div class="agv-status-box" style="--boxColor: #0ea5e9;">
          <div class="agv-status-title">
            <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...
          </div>
          <div class="agv-status-desc">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö AGV
          </div>
        </div>
      </div>

      <!-- üîã RGV Battery Status -->
      <div class="rgv-battery-container" id="rgvBatteryContainer">
        <div class="battery-header">
          <div class="battery-icon-wrapper">
            <i class="fas fa-battery-three-quarters" id="batteryIcon"></i>
          </div>
          <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà RGV</h3>
        </div>
        <div class="battery-stats">
          <div class="battery-stat-item battery-percentage">
            <div class="stat-value" id="batteryPercentage">--</div>
            <div class="stat-label">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà</div>
            <div class="battery-level-bar">
              <div class="battery-level-fill" id="batteryLevelFill" style="width: 0%"></div>
            </div>
            <div class="battery-status-text" id="batteryStatusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
          </div>
          <div class="battery-stat-item battery-time-remaining">
            <div class="stat-value" id="batteryTimeRemaining">--</div>
            <div class="stat-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</div>
            <div style="font-size: 0.85rem; color: #64748b; margin-top: 8px;">
              <i class="fas fa-info-circle"></i> ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
            </div>
          </div>
        </div>
      </div>

      <!-- ‚úÖ Sensor Tags -->
      <div class="sensor-status" id="agvSensorStatus">
        <div class="sensor-tag" id="sensorTray">
          <i class="fas fa-eye"></i> ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ñ‡∏≤‡∏î: <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </div>
        <div class="sensor-tag" id="sensorPos1">
          <i class="fas fa-location-arrow"></i> ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á 1: <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </div>
        <div class="sensor-tag" id="sensorPos2">
          <i class="fas fa-location-arrow"></i> ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á 2: <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </div>
      </div>

      <!-- ‚úÖ ‡∏Å‡∏•‡πâ‡∏≠‡∏á RGV -->
      <h3><i class="fas fa-video"></i> ‡∏Å‡∏•‡πâ‡∏≠‡∏á RGV (Real-Time)</h3>
      <div class="camera-section">
        <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ RGV (‡∏´‡∏°‡∏∏‡∏ô‡∏ã‡πâ‡∏≤‡∏¢) -->
        <div class="camera-box">
          <img src="/api/camera/stream/CAM001" class="rotate-left" />
          <div class="camera-label">
            <i class="fas fa-video"></i> ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ RGV
          </div>
        </div>

        <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á RGV -->
        <div class="camera-box">
          <img src="/api/camera/stream/CAM002" class="camera-image" />
          <div class="camera-label">
            <i class="fas fa-video"></i> ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á RGV
          </div>
        </div>
      </div>

      <!-- ‚úÖ Manual RGV/AGV Control -->
      <h3 style="margin-top: 40px;"><i class="fas fa-tools"></i> Manual RGV/AGV Control (MQTT)</h3>
      
      <!-- ‚ú® RGV Test Section - Premium Design -->
      <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.8); position: relative; overflow: hidden;">
        <!-- Header with Icon -->
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
          <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 15px; border-radius: 12px; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);">
            <i class="fas fa-flask" style="color: white; font-size: 1.5rem; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));"></i>
          </div>
          <h4 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: #1e293b; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö RGV</h4>
        </div>
        
        <!-- Test Controls -->
        <div style="display: flex; align-items: center; justify-content: center; gap: 30px; margin-bottom: 25px; flex-wrap: wrap;">
          <!-- Premium Test Button -->
          <button onclick="runRgvTest()" style="
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
            position: relative;
            overflow: hidden;
            min-width: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
          " onmouseover="this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 15px 35px rgba(16, 185, 129, 0.5)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 10px 25px rgba(16, 185, 129, 0.4)'">
            <i class="fas fa-play" style="font-size: 1.1rem;"></i>
            <span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö</span>
          </button>
          
          <!-- Cycle Counter -->
          <div style="background: white; padding: 20px 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); border: 1px solid #e2e8f0;">
            <div style="text-align: center;">
              <div style="color: #64748b; font-size: 0.9rem; font-weight: 500; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px;">Cycle Count</div>
              <div style="color: #0f172a; font-size: 2rem; font-weight: 800; font-family: 'Segoe UI', monospace;" id="cycleCount">0</div>
            </div>
          </div>
        </div>
        
        <!-- Test Status Display -->
        <div id="testStatus" style="display: none;">
          <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); border: 1px solid #e2e8f0;">
            <!-- Progress Bar -->
            <div style="margin-bottom: 15px;">
              <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                <span style="color: #64748b; font-size: 0.9rem; font-weight: 500;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
              </div>
              <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 10px; overflow: hidden;">
                <div id="testProgressBar" style="height: 100%; background: linear-gradient(90deg, #10b981 0%, #059669 100%); border-radius: 10px; width: 0%; transition: width 0.5s ease-out;"></div>
              </div>
            </div>
            
            <!-- Test Log -->
            <div style="background: #f8fafc; border-radius: 8px; padding: 15px; max-height: 120px; overflow-y: auto; border: 1px solid #e2e8f0;">
              <div id="testLog" style="font-family: 'Courier New', monospace; font-size: 0.85rem; color: #475569; line-height: 1.5;"></div>
            </div>
          </div>
        </div>
        
        <!-- Decorative Elements -->
        <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; opacity: 0.1;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 120px; height: 120px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 50%; opacity: 0.05;"></div>
      </div>

      <!-- ‚úÖ Manual Control Buttons -->
      <div class="main-buttons">
        <button class="btn-premium" onclick="sendAgvCommand('go_lift')">Manual ‡πÑ‡∏õ Lift</button>
        <button class="btn-premium" onclick="sendAgvCommand('go_home')">Manual ‡∏Å‡∏•‡∏±‡∏ö Home</button>
        <button class="btn-premium" onclick="sendTrayCommand('tray_up')">Manual ‡∏¢‡∏Å‡∏ñ‡∏≤‡∏î</button>
        <button class="btn-premium" onclick="sendTrayCommand('tray_down')">Manual ‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î</button>
      </div>

      <div class="dropdown" style="margin-top: 20px;">
        <label for="slotSelectManual"><strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (Manual)</strong></label><br/>
        <select id="slotSelectManual" class="dropdown-select">
          <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á</option>
          ${[...Array(18)].map((_, i) => `<option value="${i + 1}">‡∏ä‡πà‡∏≠‡∏á ${i + 1}</option>`).join('')}
        </select>
        <button class="btn-premium" onclick="handleSlotManual()">‡∏™‡πà‡∏á Manual Slot</button>
      </div>
    </div>
  `;
}

// üì∏ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Image Processing
function renderImageProcessingPage() {
  return `
    <div class="section">
      <div class="image-processing-container">
        <div class="processing-header">
          <div class="processing-icon-wrapper">
            <i class="fas fa-camera"></i>
          </div>
          <h2>Image Processing - ‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏ú‡∏±‡∏Å</h2>
        </div>

        <!-- Grid ‡∏Å‡∏•‡πâ‡∏≠‡∏á 4 ‡∏ï‡∏±‡∏ß -->
        <div class="camera-grid">
          <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á 1: ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ö‡∏ô -->
          <div class="camera-processing-box camera-box-1">
            <div class="camera-header">
              <div class="camera-title">
                <i class="fas fa-camera"></i>
                ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ö‡∏ô (Top Camera)
              </div>
              <div class="camera-status active" id="camera1Status">ACTIVE</div>
            </div>
            <div class="camera-feed" id="camera1Feed">
              <div class="camera-placeholder">
                <i class="fas fa-video"></i>
                <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ö‡∏ô...</div>
              </div>
            </div>
            <div class="scan-results" id="camera1Results">
              <h4><i class="fas fa-leaf"></i> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</h4>
              <div id="camera1Vegetables">
                <div style="text-align: center; color: #64748b; padding: 20px;">
                  ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...
                </div>
              </div>
            </div>
          </div>

          <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á 2: ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏á -->
          <div class="camera-processing-box camera-box-2">
            <div class="camera-header">
              <div class="camera-title">
                <i class="fas fa-camera"></i>
                ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏á (Bottom Camera)
              </div>
              <div class="camera-status active" id="camera2Status">ACTIVE</div>
            </div>
            <div class="camera-feed" id="camera2Feed">
              <div class="camera-placeholder">
                <i class="fas fa-video"></i>
                <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏á...</div>
              </div>
            </div>
            <div class="scan-results" id="camera2Results">
              <h4><i class="fas fa-leaf"></i> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</h4>
              <div id="camera2Vegetables">
                <div style="text-align: center; color: #64748b; padding: 20px;">
                  ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...
                </div>
              </div>
            </div>
          </div>

          <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á 3: ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ã‡πâ‡∏≤‡∏¢ -->
          <div class="camera-processing-box camera-box-3">
            <div class="camera-header">
              <div class="camera-title">
                <i class="fas fa-camera"></i>
                ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ã‡πâ‡∏≤‡∏¢ (Left Camera)
              </div>
              <div class="camera-status active" id="camera3Status">ACTIVE</div>
            </div>
            <div class="camera-feed" id="camera3Feed">
              <div class="camera-placeholder">
                <i class="fas fa-video"></i>
                <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ã‡πâ‡∏≤‡∏¢...</div>
              </div>
            </div>
            <div class="scan-results" id="camera3Results">
              <h4><i class="fas fa-leaf"></i> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</h4>
              <div id="camera3Vegetables">
                <div style="text-align: center; color: #64748b; padding: 20px;">
                  ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...
                </div>
              </div>
            </div>
          </div>

          <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á 4: ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏ß‡∏≤ -->
          <div class="camera-processing-box camera-box-4">
            <div class="camera-header">
              <div class="camera-title">
                <i class="fas fa-camera"></i>
                ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏ß‡∏≤ (Right Camera)
              </div>
              <div class="camera-status active" id="camera4Status">ACTIVE</div>
            </div>
            <div class="camera-feed" id="camera4Feed">
              <div class="camera-placeholder">
                <i class="fas fa-video"></i>
                <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏ß‡∏≤...</div>
              </div>
            </div>
            <div class="scan-results" id="camera4Results">
              <h4><i class="fas fa-leaf"></i> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</h4>
              <div id="camera4Vegetables">
                <div style="text-align: center; color: #64748b; padding: 20px;">
                  ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ AGV ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
        <div class="agv-integration-status" style="background: rgba(255, 255, 255, 0.9); border-radius: 16px; padding: 20px; margin-bottom: 20px;">
          <h3 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-truck-moving" style="color: #0ea5e9;"></i>
            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö AGV
          </h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ AGV:</strong> <span id="agvStatusForCamera" style="color: #0ea5e9;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span>
            </div>
            <div>
              <strong>‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:</strong> <span id="autoScanStatus" style="color: #059669;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
            </div>
          </div>
        </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
        <div class="processing-controls">
          <button class="control-button success" onclick="captureAllCameras()">
            <i class="fas fa-camera"></i>
            ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          </button>
          <button class="control-button primary" onclick="toggleManualMode()">
            <i class="fas fa-cog"></i>
            <span id="manualModeText">‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î Manual</span>
          </button>
          <button class="control-button secondary" onclick="exportResults()">
            <i class="fas fa-download"></i>
            ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
          </button>
          <button class="control-button secondary" onclick="resetCameras()">
            <i class="fas fa-refresh"></i>
            ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á
          </button>
        </div>

        <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• -->
        <div class="processing-stats">
          <div class="stat-card stat-card-1">
            <div class="stat-number" id="totalScanned">0</div>
            <div class="stat-label">‡∏ú‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          </div>
          <div class="stat-card stat-card-2">
            <div class="stat-number" id="accuracyRate">0%</div>
            <div class="stat-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</div>
          </div>
          <div class="stat-card stat-card-3">
            <div class="stat-number" id="processingTime">0</div>
            <div class="stat-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (ms)</div>
          </div>
          <div class="stat-card stat-card-4">
            <div class="stat-number" id="activeCameras">4</div>
            <div class="stat-label">‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
          </div>
        </div>
      </div>
    </div>
  `;
}

if (page === 'agv') {
  const html = renderAgvPage();
  document.getElementById("mainContent").innerHTML = html;
  
  const agvStatusEl = document.getElementById('agvTaskStatus');

  // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderPrettyStatus ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  function renderPrettyStatus(status) {
    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Regular Expression ‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ç‡πâ‡∏≤‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô
    const match = status.match(/^(.*?)(?:_(\d+))?$/);
    const base = match?.[1] || status;
    const suffix = match?.[2] ? parseInt(match[2]) : null;

    switch (base) {
      // --- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ---
      case "idle":
        return { title: " ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Idle)", desc: "AGV ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà", color: "#28a745", icon: "fas fa-pause-circle" };
      case "unknown":
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...", desc: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö AGV", color: "#0ea5e9", icon: "fas fa-satellite-dish" };
      case "flow_done":
      case "done":
        return { title: " ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå", desc: "AGV ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Idle", color: "#198754", icon: "fas fa-check-circle" };
      case "error":
        return { title: " ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", desc: "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö", color: "#dc3545", icon: "fas fa-exclamation-circle" };

      // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Workstation ---
      case "at_workstation":
        return { title: "‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Workstation", desc: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏ï‡πä‡∏∞‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô", color: "#fd7e14", icon: "fas fa-box-open" };

      // --- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Flow State ---
      case "inbound_start_lift_tray":
      case "inbound_wait_for_tray_lift":
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡∏ñ‡∏≤‡∏î (Inbound)", desc: "AGV ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡∏ñ‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤", color: "#ffc107", icon: "fas fa-arrow-alt-circle-up" };
      case "start": // (Outbound)
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å (Outbound)", desc: `AGV ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${suffix || '...'}`, color: "#17a2b8", icon: "fas fa-route" };
      case "wait_agv_at_lift":
        return { title: "AGV ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏ü‡∏ï‡πå", desc: "‡∏£‡∏≠ AGV ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå", color: "#6610f2", icon: "fas fa-parking" };
      case "lift_moving_up":
        return { title: "‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏∂‡πâ‡∏ô", desc: "‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢", color: "#0dcaf0", icon: "fas fa-arrow-up" };
      case "lift_moving_down":
        return { title: "‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á", desc: "‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡∏±‡πâ‡∏ô 2", color: "#0d6efd", icon: "fas fa-arrow-down" };
      case "wait_agv_at_slot":
        return { title: "AGV ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö", desc: `‡∏£‡∏≠ AGV ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${suffix || '...'}`, color: "#198754", icon: "fas fa-map-marker-alt" };
      case "wait_tray_action_done":
        return { title: "AGV ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏ñ‡∏≤‡∏î", desc: "‡∏£‡∏≠ AGV ‡∏¢‡∏Å/‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢", color: "#fd7e14", icon: "fas fa-cogs" };
      case "wait_agv_return_to_lift":
        return { title: "AGV ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏ü‡∏ï‡πå", desc: "‡∏£‡∏≠ AGV ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏ü‡∏ï‡πå", color: "#007bff", icon: "fas fa-undo-alt" };
      case "wait_agv_home":
        return { title: "AGV ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ê‡∏≤‡∏ô", desc: "‡∏£‡∏≠ AGV ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Home)", color: "#6c757d", icon: "fas fa-home" };
      case "outbound_wait_for_final_place":
        return { title: "AGV ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà Workstation", desc: "‡∏£‡∏≠ AGV ‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Home ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö‡∏á‡∏≤‡∏ô Outbound", color: "#20c997", icon: "fas fa-box-open" };

      // --- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß AGV ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (Fallback) ---
      case "moving_to_lift":
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏•‡∏¥‡∏ü‡∏ï‡πå", desc: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å AGV: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏ü‡∏ï‡πå", color: "#6610f2", icon: "fas fa-parking" };
      case "arrived_at_lift": // [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ AGV ‡∏ñ‡∏∂‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
        return { title: "‡∏ñ‡∏∂‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß", desc: "AGV ‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", color: "#6f42c1", icon: "fas fa-check-circle" };
      case "moving_to_slot":
      case "agv_moving_to_slot":
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö", desc: suffix ? `AGV ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${suffix}` : "AGV ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö", color: "#17a2b8", icon: "fas fa-route" };
      case "arrived_at_slot":
      case "agv_arrived_at_slot":
        return { title: "‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß", desc: suffix ? `AGV ‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${suffix} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢` : "AGV ‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", color: "#198754", icon: "fas fa-check-circle" };
      case "arrived_at_home":
        return { title: "‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô (Home) ‡πÅ‡∏•‡πâ‡∏ß", desc: "AGV ‡∏Å‡∏•‡∏±‡∏ö‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ", color: "#28a745", icon: "fas fa-parking" };

      // --- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Default ---
      default:
        return { title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...", desc: `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${status}`, color: "#adb5bd", icon: "fas fa-spinner fa-spin" };
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á AGV (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  async function fetchAgvStatus() {
    try {
      const res = await fetch(`/api/agv/status?_t=${new Date().getTime()}`);
      const data = await res.json();
      const rawStatus = data.status || 'unknown';
      const pretty = renderPrettyStatus(rawStatus);

      const isGlowingStatus = [
        'working', 'moving', 'processing', 'moving_to_slot', 'moving_to_lift', 
        'lift_moving_up', 'lift_moving_down', 'pickup_tray', 'wait_agv_at_lift', 
        'wait_agv_at_slot', 'wait_tray_action_done', 'wait_agv_return_to_lift', 
        'wait_agv_home'
      ].includes(pretty.base || rawStatus);

      agvStatusEl.innerHTML = `
        <div class="agv-status-box ${isGlowingStatus ? 'glow' : ''}" style="--boxColor: ${pretty.color || '#999'}">
          <div class="agv-status-title">
            <i class="${pretty.icon || 'fas fa-question-circle'}"></i> ${pretty.title || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'}
          </div>
          <div class="agv-status-desc">${pretty.desc || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'}</div>
        </div>
      `;
    } catch (err) {
      agvStatusEl.innerHTML = `
        <div class="agv-status-box error">
          <div class="agv-status-title"><i class="fas fa-exclamation-triangle"></i> ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ</div>
          <div class="agv-status-desc">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö AGV</div>
        </div>
      `;
      console.error('[AGV Status Error]', err);
    }
  }

  // üîã ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà RGV
  async function fetchRgvBattery() {
    try {
      const res = await fetch(`/api/rgv/battery?_t=${new Date().getTime()}`);
      const data = await res.json();
      
      if (data.success && data.battery) {
        const battery = data.battery;
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà
        document.getElementById('batteryPercentage').textContent = `${battery.percentage}%`;
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        document.getElementById('batteryTimeRemaining').textContent = `${battery.estimatedHoursRemaining}`;
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Battery Level Bar
        const batteryFill = document.getElementById('batteryLevelFill');
        batteryFill.style.width = `${battery.percentage}%`;
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡∏µ
        const batteryContainer = document.getElementById('rgvBatteryContainer');
        const batteryStatusText = document.getElementById('batteryStatusText');
        const batteryIcon = document.getElementById('batteryIcon');
        
        // ‡∏•‡∏ö class ‡πÄ‡∏Å‡πà‡∏≤
        batteryContainer.classList.remove('battery-high', 'battery-medium', 'battery-low', 'battery-critical');
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà
        batteryContainer.classList.add(`battery-${battery.level}`);
        batteryStatusText.textContent = battery.status;
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Icon ‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö
        let iconClass = 'fas fa-battery-three-quarters';
        if (battery.percentage >= 80) {
          iconClass = 'fas fa-battery-full';
        } else if (battery.percentage >= 60) {
          iconClass = 'fas fa-battery-three-quarters';
        } else if (battery.percentage >= 40) {
          iconClass = 'fas fa-battery-half';
        } else if (battery.percentage >= 20) {
          iconClass = 'fas fa-battery-quarter';
        } else {
          iconClass = 'fas fa-battery-empty';
        }
        batteryIcon.className = iconClass;
        
        // ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏ï‡πà‡∏≥
        if (battery.percentage <= 20 && !window.batteryAlertShown) {
          showNotification(`‚ö†Ô∏è ‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà RGV ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${battery.percentage}% ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏î‡πà‡∏ß‡∏ô!`, 'warning');
          window.batteryAlertShown = true;
        } else if (battery.percentage <= 10 && !window.batteryCriticalAlertShown) {
          showNotification(`üö® ‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà RGV ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï! ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${battery.percentage}% - ‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!`, 'error');
          window.batteryCriticalAlertShown = true;
        } else if (battery.percentage > 30) {
          // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥
          window.batteryAlertShown = false;
          window.batteryCriticalAlertShown = false;
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô console ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug
        
      }
    } catch (err) {
      console.error('[RGV Battery Error]', err);
      document.getElementById('batteryPercentage').textContent = '--';
      document.getElementById('batteryTimeRemaining').textContent = '--';
      document.getElementById('batteryStatusText').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
    }
  }

  // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  fetchAgvStatus(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
  fetchRgvBattery(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
  const agvStatusTimer = setInterval(fetchAgvStatus, 5000);
  const batteryTimer = setInterval(fetchRgvBattery, 8000); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏ó‡∏∏‡∏Å 8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  activeTimers.add(agvStatusTimer);
  activeTimers.add(batteryTimer);

  // WebSocket connection for real-time sensor updates
  connectSensorWebSocket();

  return;
}

// üì∏ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤ Image Processing
if (page === 'image-processing') {
  const html = renderImageProcessingPage();
  document.getElementById("mainContent").innerHTML = html;
  
  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Image Processing
  initializeImageProcessing();
  return;
}

// üì∏ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Image Processing
let imageProcessingTimers = new Set();
let isProcessingActive = false;
let isManualMode = false;
let agvStatusTimer = null;

function initializeImageProcessing() {
  
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà Lift ‡∏à‡∏∞ ON ‡∏ï‡∏•‡∏≠‡∏î)
  loadAllCameras();
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
  updateProcessingStats();
  
  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ AGV
  startAgvStatusMonitoring();
  
  // ‡πÄ‡∏£‡∏¥‡πà‡∏° Auto-update ‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  const statsTimer = setInterval(updateProcessingStats, 5000);
  imageProcessingTimers.add(statsTimer);
  activeTimers.add(statsTimer);
  
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ AGV ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
function startAgvStatusMonitoring() {
  agvStatusTimer = setInterval(async () => {
    try {
      const res = await fetch('/api/agv/status');
      const data = await res.json();
      
      const agvStatus = data.status || 'unknown';
      document.getElementById('agvStatusForCamera').textContent = translateAgvStatus(agvStatus);
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ AGV ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Lift ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const isAgvAtLift = [
        'wait_agv_at_lift', 
        'arrived_at_lift',
        'lift_moving_up', 
        'lift_moving_down',
        'pickup_tray',
        'inbound_wait_for_tray_lift'
      ].some(status => agvStatus.includes(status));
      
      if (isAgvAtLift && !isProcessingActive && !isManualMode) {
        // AGV ‡∏°‡∏≤‡∏ñ‡∏∂‡∏á Lift - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        await startAutoScanning();
      } else if (!isAgvAtLift && isProcessingActive && !isManualMode) {
        // AGV ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Lift - ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        await stopAutoScanning();
      }
      
    } catch (err) {
      console.error('‚ùå Error monitoring AGV status:', err);
      document.getElementById('agvStatusForCamera').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ';
    }
  }, 2000); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  
  activeTimers.add(agvStatusTimer);
}

function translateAgvStatus(status) {
  const statusMap = {
    'idle': '‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
    'wait_agv_at_lift': 'üéØ AGV ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤‡∏ó‡∏µ‡πà Lift',
    'arrived_at_lift': '‚úÖ AGV ‡∏ñ‡∏∂‡∏á Lift ‡πÅ‡∏•‡πâ‡∏ß',
    'lift_moving_up': '‚¨ÜÔ∏è Lift ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏∂‡πâ‡∏ô',
    'lift_moving_down': '‚¨áÔ∏è Lift ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á',
    'pickup_tray': 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡∏ñ‡∏≤‡∏î',
    'inbound_wait_for_tray_lift': '‚è≥ ‡∏£‡∏≠‡∏¢‡∏Å‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà Lift'
  };
  
  return statusMap[status] || `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${status}`;
}

async function startAutoScanning() {
  if (isProcessingActive) return;
  
  isProcessingActive = true;
  document.getElementById('autoScanStatus').innerHTML = '<span style="color: #0ea5e9;">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>';
  
  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô Processing
  for (let i = 1; i <= 4; i++) {
    const statusElement = document.getElementById(`camera${i}Status`);
    statusElement.textContent = 'SCANNING';
    statusElement.className = 'camera-status processing';
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
    startContinuousScanning(i);
  }
  
}

async function stopAutoScanning() {
  if (!isProcessingActive || isManualMode) return;
  
  isProcessingActive = false;
  document.getElementById('autoScanStatus').innerHTML = '<span style="color: #059669;">‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>';
  
  // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  imageProcessingTimers.forEach(timer => {
    if (timer !== agvStatusTimer) { // ‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î AGV monitoring timer
      clearInterval(timer);
      activeTimers.delete(timer);
    }
  });
  imageProcessingTimers.clear();
  
  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Active (ON ‡∏ï‡∏•‡∏≠‡∏î)
  for (let i = 1; i <= 4; i++) {
    const statusElement = document.getElementById(`camera${i}Status`);
    statusElement.textContent = 'ACTIVE';
    statusElement.className = 'camera-status active';
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô
    const resultsElement = document.getElementById(`camera${i}Vegetables`);
    resultsElement.innerHTML = `
      <div style="text-align: center; color: #64748b; padding: 20px;">
        <i class="fas fa-video" style="font-size: 1.5rem; margin-bottom: 8px; display: block;"></i>
        ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô<br><small>‡∏£‡∏≠ AGV ‡∏°‡∏≤‡∏ó‡∏µ‡πà Lift</small>
      </div>
    `;
  }
  
}

async function loadAllCameras() {
  for (let i = 1; i <= 4; i++) {
    await loadCameraFeed(i);
  }
}

async function loadCameraFeed(cameraId) {
  try {
    const res = await fetch(`/api/image-processing/cameras/${cameraId}/stream`);
    const data = await res.json();
    
    if (data.success) {
      const feedElement = document.getElementById(`camera${cameraId}Feed`);
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÉ‡∏ä‡πâ placeholder ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
      feedElement.innerHTML = `
        <img src="/api/camera/stream/CAM00${cameraId}" 
             alt="Camera ${cameraId} Feed" 
             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
        <div class="camera-placeholder" style="display: none;">
          <i class="fas fa-video"></i>
          <div>‡∏Å‡∏•‡πâ‡∏≠‡∏á ${data.camera.name}</div>
          <small>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${data.camera.resolution}</small>
        </div>
      `;
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á
      const statusElement = document.getElementById(`camera${cameraId}Status`);
      statusElement.textContent = 'ACTIVE';
      statusElement.className = 'camera-status active';
      
    }
  } catch (err) {
    console.error(`‚ùå Error loading camera ${cameraId}:`, err);
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Error
    const statusElement = document.getElementById(`camera${cameraId}Status`);
    statusElement.textContent = 'ERROR';
    statusElement.className = 'camera-status error';
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î Manual
function toggleManualMode() {
  isManualMode = !isManualMode;
  const manualModeText = document.getElementById('manualModeText');
  
  if (isManualMode) {
    manualModeText.textContent = '‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î Manual';
    document.getElementById('autoScanStatus').innerHTML = '<span style="color: #f59e0b;">‚ö†Ô∏è ‡πÇ‡∏´‡∏°‡∏î Manual</span>';
    
    // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° AGV ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏ö‡∏ö Manual
    if (isProcessingActive) {
      stopAutoScanning();
    }
    startManualScanning();
    
    showNotification('üîß ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î Manual - ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á', 'info');
  } else {
    manualModeText.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î Manual';
    document.getElementById('autoScanStatus').innerHTML = '<span style="color: #059669;">‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>';
    
    // ‡∏´‡∏¢‡∏∏‡∏î Manual ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° AGV
    stopManualScanning();
    
    showNotification('ü§ñ ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ - ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° AGV ‡∏ó‡∏µ‡πà Lift', 'success');
  }
}

async function startManualScanning() {
  if (isProcessingActive) return;
  
  isProcessingActive = true;
  
  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô Manual Processing
  for (let i = 1; i <= 4; i++) {
    const statusElement = document.getElementById(`camera${i}Status`);
    statusElement.textContent = 'MANUAL';
    statusElement.className = 'camera-status processing';
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏ö‡∏ö Manual (‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥)
    startContinuousScanning(i, 5000); // 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  }
  
}

function stopManualScanning() {
  if (!isProcessingActive) return;
  
  isProcessingActive = false;
  
  // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô Manual
  imageProcessingTimers.forEach(timer => {
    if (timer !== agvStatusTimer) {
      clearInterval(timer);
      activeTimers.delete(timer);
    }
  });
  imageProcessingTimers.clear();
  
  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á
  for (let i = 1; i <= 4; i++) {
    const statusElement = document.getElementById(`camera${i}Status`);
    statusElement.textContent = 'ACTIVE';
    statusElement.className = 'camera-status active';
    
    const resultsElement = document.getElementById(`camera${i}Vegetables`);
    resultsElement.innerHTML = `
      <div style="text-align: center; color: #64748b; padding: 20px;">
        <i class="fas fa-video" style="font-size: 1.5rem; margin-bottom: 8px; display: block;"></i>
        ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô<br><small>‡∏£‡∏≠ AGV ‡∏°‡∏≤‡∏ó‡∏µ‡πà Lift</small>
      </div>
    `;
  }
  
}

function resetCameras() {
  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  loadAllCameras();
  showNotification('üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
}

function startContinuousScanning(cameraId, interval = 3000) {
  // ‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡∏≤‡∏° interval ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (default 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
  const scanTimer = setInterval(async () => {
    if (!isProcessingActive) {
      clearInterval(scanTimer);
      return;
    }
    
    await performVegetableScan(cameraId);
  }, interval);
  
  imageProcessingTimers.add(scanTimer);
  activeTimers.add(scanTimer);
}

async function performVegetableScan(cameraId) {
  try {
    const res = await fetch('/api/image-processing/scan', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        cameraId: cameraId,
        imageData: 'base64_placeholder' // ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á
      })
    });
    
    const data = await res.json();
    
    if (data.success) {
      displayScanResults(cameraId, data.results);
    }
  } catch (err) {
    console.error(`‚ùå Error scanning camera ${cameraId}:`, err);
  }
}

function displayScanResults(cameraId, results) {
  const resultsElement = document.getElementById(`camera${cameraId}Vegetables`);
  
  if (results.totalDetected === 0) {
    resultsElement.innerHTML = `
      <div style="text-align: center; color: #64748b; padding: 20px;">
        <i class="fas fa-search" style="font-size: 1.5rem; margin-bottom: 8px; display: block;"></i>
        ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏±‡∏Å‡πÉ‡∏ô‡∏†‡∏≤‡∏û
      </div>
    `;
    return;
  }
  
  let html = '';
  results.vegetables.forEach(veg => {
    const confidencePercent = Math.round(veg.confidence * 100);
    html += `
      <div class="vegetable-detected">
        <i class="fas fa-leaf" style="color: #059669; font-size: 1.2rem;"></i>
        <div class="vegetable-info">
          <div class="vegetable-name">${veg.name}</div>
          <div class="confidence-score">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${confidencePercent}%</div>
        </div>
      </div>
    `;
  });
  
  resultsElement.innerHTML = html;
}

async function captureAllCameras() {
  try {
    const res = await fetch('/api/image-processing/control', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'capture' })
    });
    
    const data = await res.json();
    
    if (data.success) {
      showNotification('üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
      
      // ‡∏™‡πÅ‡∏Å‡∏ô‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      for (let i = 1; i <= 4; i++) {
        await performVegetableScan(i);
      }
    }
  } catch (err) {
    console.error('‚ùå Error capturing images:', err);
    showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ', 'error');
  }
}

async function updateProcessingStats() {
  try {
    const res = await fetch('/api/image-processing/stats');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ response ‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const contentType = res.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      console.warn('‚ö†Ô∏è Stats API not ready, using mock data');
      // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
      document.getElementById('totalScanned').textContent = Math.floor(Math.random() * 50) + 100;
      document.getElementById('accuracyRate').textContent = `${(92 + Math.random() * 6).toFixed(1)}%`;
      document.getElementById('processingTime').textContent = Math.floor(Math.random() * 100) + 150;
      document.getElementById('activeCameras').textContent = '4';
      return;
    }
    
    const data = await res.json();
    
    if (data.success) {
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏Å
      document.getElementById('totalScanned').textContent = data.daily.totalScanned;
      document.getElementById('accuracyRate').textContent = `${data.daily.accuracyRate.toFixed(1)}%`;
      document.getElementById('processingTime').textContent = data.daily.averageProcessingTime;
      document.getElementById('activeCameras').textContent = data.daily.activeCameras;
      
    }
  } catch (err) {
    console.warn('‚ö†Ô∏è Stats API error, using mock data:', err.message);
    // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î error
    document.getElementById('totalScanned').textContent = Math.floor(Math.random() * 50) + 120;
    document.getElementById('accuracyRate').textContent = `${(90 + Math.random() * 8).toFixed(1)}%`;
    document.getElementById('processingTime').textContent = Math.floor(Math.random() * 100) + 160;
    document.getElementById('activeCameras').textContent = '4';
  }
}

async function exportResults() {
  try {
    showNotification('üì• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å...', 'info');
    
    // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    showNotification('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
  } catch (err) {
    console.error('‚ùå Error exporting results:', err);
    showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏î‡πâ', 'error');
  }
}


  if (page === 'system') {
    html = `
      <div class="section">
        <h2 style="margin-bottom: 20px; color:#2d6a4f;">üîß System Monitor</h2>
        <div id="systemStatus" style="display: flex; gap: 20px; flex-wrap: wrap;"></div>
      </div>
    `;
    document.getElementById("mainContent").innerHTML = html;
    return;
  }

  if (page === 'environment') {
    html = `
      <div class="section">
        <h2 style="color: #2d6a4f;">üìä Environmental Data (Real-Time)</h2>
        <canvas id="co2Chart" style="max-height: 300px;"></canvas>
        <canvas id="tempChart" style="max-height: 300px; margin-top: 30px;"></canvas>
        <canvas id="humidityChart" style="max-height: 300px; margin-top: 30px;"></canvas>
      </div>
    `;
    document.getElementById("mainContent").innerHTML = html;
    setupEnvironmentCharts();
    if (window.environmentInterval) clearInterval(window.environmentInterval);
    window.environmentInterval = setInterval(updateEnvironmentCharts, 10000);
    return;

  }if (page === 'planting-plan') {
  renderPlantingPlanPage();
  return;
}


if (page === 'user-logs') {
    renderUserLogsPage();
    return;
}

// ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderUserLogsPage ‡∏î‡πâ‡∏ß‡∏¢ Tailwind CSS ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
function renderUserLogsPage() {
    const html = `
        <div class="min-h-screen bg-gradient-to-br from-gray-50 via-white to-blue-50 font-thai">
            <!-- Header Section - Clean & Minimal -->
            <div class="relative bg-white shadow-sm border-b border-gray-100">
                <div class="max-w-7xl mx-auto px-6 py-12">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-8">
                        <!-- Title Section -->
                        <div class="flex items-center gap-6">
                            <div class="relative">
                                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-clipboard-list text-white text-3xl"></i>
                                </div>
                                <div class="absolute -top-2 -right-2 w-6 h-6 bg-green-400 rounded-full border-2 border-white flex items-center justify-center animate-pulse">
                                    <div class="w-2 h-2 bg-white rounded-full"></div>
                                </div>
                            </div>
                            <div>
                                <h1 class="text-4xl lg:text-5xl font-bold text-gray-800 mb-3">
                                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                                </h1>
                                <p class="text-gray-600 text-xl">
                                    ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
                                </p>
                                <div class="flex items-center gap-3 mt-3">
                                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                    <span class="text-gray-500 text-sm font-medium">‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-4">
                            <button onclick="openExportLogsModal()" 
                                class="flex items-center gap-3 px-6 py-4 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-2xl hover:from-emerald-600 hover:to-emerald-700 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl group">
                                <i class="fas fa-download group-hover:animate-bounce"></i>
                                <span class="font-semibold">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</span>
                            </button>
                            <button onclick="fetchUserLogs()" 
                                class="flex items-center gap-3 px-6 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl group">
                                <i class="fas fa-sync-alt group-hover:rotate-180 transition-transform duration-500"></i>
                                <span class="font-semibold">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span>
                            </button>
                        </div>
                    </div>

                    <!-- Beautiful Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-3xl p-8 border border-blue-200 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                            <div class="flex items-center gap-6">
                                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-users text-white text-2xl"></i>
                                </div>
                                <div>
                                    <p class="text-3xl font-bold text-blue-700" id="totalUsers">-</p>
                                    <p class="text-blue-600 font-medium">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-3xl p-8 border border-emerald-200 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                            <div class="flex items-center gap-6">
                                <div class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-chart-line text-white text-2xl"></i>
                                </div>
                                <div>
                                    <p class="text-3xl font-bold text-emerald-700" id="totalLogs">-</p>
                                    <p class="text-emerald-600 font-medium">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-3xl p-8 border border-amber-200 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                            <div class="flex items-center gap-6">
                                <div class="w-16 h-16 bg-gradient-to-br from-amber-500 to-amber-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-calendar-check text-white text-2xl"></i>
                                </div>
                                <div>
                                    <p class="text-3xl font-bold text-amber-700" id="todayLogs">-</p>
                                    <p class="text-amber-600 font-medium">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clean Filters Section -->
            <div class="max-w-7xl mx-auto px-6 py-8">
                <div class="bg-white rounded-3xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-gray-50 to-blue-50 p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-sliders-h text-white text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h3>
                                    <p class="text-gray-600 text-sm">‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
                                </div>
                            </div>
                            <button onclick="toggleAdvancedFilters()" 
                                class="w-10 h-10 bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center group">
                                <i class="fas fa-chevron-down text-gray-600 transition-transform duration-200 group-hover:text-blue-600" id="filterToggleIcon"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="filtersContent" class="p-8 transition-all duration-300">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Search Input -->
                            <div class="space-y-3">
                                <label class="flex items-center gap-3 text-sm font-semibold text-gray-700">
                                    <div class="w-6 h-6 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-search text-blue-600 text-xs"></i>
                                    </div>
                                    ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </label>
                                <div class="relative">
                                    <input type="text" id="logSearchInput" 
                                        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ, ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤..."
                                        class="w-full px-5 py-4 pl-12 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-all duration-300 text-gray-700 placeholder-gray-400">
                                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>

                            <!-- Category Filter -->
                            <div class="space-y-3">
                                <label class="flex items-center gap-3 text-sm font-semibold text-gray-700">
                                    <div class="w-6 h-6 bg-emerald-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-layer-group text-emerald-600 text-xs"></i>
                                    </div>
                                    ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
                                </label>
                                <!-- Custom Premium Dropdown -->
                                <div class="custom-dropdown-wrapper">
                                    <div id="logCategoryFilter" class="custom-dropdown w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-all duration-300 text-gray-700 cursor-pointer" onclick="toggleCategoryDropdown()">
                                        <div class="dropdown-selected">
                                            <i class="fas fa-layer-group premium-icon"></i>
                                            <span class="selected-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                                        </div>
                                    </div>
                                    <div id="categoryDropdownMenu" class="dropdown-menu hidden">
                                        <div class="dropdown-item" data-value="" onclick="selectCategory('', 'fas fa-layer-group', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')">
                                            <i class="fas fa-layer-group premium-icon"></i>
                                            <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                        </div>
                                        <div class="dropdown-item" data-value="login" onclick="selectCategory('login', 'fas fa-key', '‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö')">
                                            <i class="fas fa-key premium-icon"></i>
                                            <span>‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
                                        </div>
                                        <div class="dropdown-item" data-value="inbound" onclick="selectCategory('inbound', 'fas fa-arrow-down', '‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤')">
                                            <i class="fas fa-arrow-down premium-icon"></i>
                                            <span>‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤</span>
                                        </div>
                                        <div class="dropdown-item" data-value="outbound" onclick="selectCategory('outbound', 'fas fa-arrow-up', '‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å')">
                                            <i class="fas fa-arrow-up premium-icon"></i>
                                            <span>‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å</span>
                                        </div>
                                        <div class="dropdown-item" data-value="water" onclick="selectCategory('water', 'fas fa-tint', '‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥')">
                                            <i class="fas fa-tint premium-icon"></i>
                                            <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥</span>
                                        </div>
                                        <div class="dropdown-item" data-value="light" onclick="selectCategory('light', 'fas fa-lightbulb', '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü')">
                                            <i class="fas fa-lightbulb premium-icon"></i>
                                            <span>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü</span>
                                        </div>
                                        <div class="dropdown-item" data-value="lift" onclick="selectCategory('lift', 'fas fa-arrow-up-wide-short', '‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏¥‡∏ü‡∏ï‡πå')">
                                            <i class="fas fa-arrow-up-wide-short premium-icon"></i>
                                            <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏¥‡∏ü‡∏ï‡πå</span>
                                        </div>
                                        <div class="dropdown-item" data-value="rgv" onclick="selectCategory('rgv', 'fas fa-truck-moving', '‡∏£‡∏ñ RGV')">
                                            <i class="fas fa-truck-moving premium-icon"></i>
                                            <span>‡∏£‡∏ñ RGV</span>
                                        </div>
                                        <div class="dropdown-item" data-value="system" onclick="selectCategory('system', 'fas fa-chart-line', '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ')">
                                            <i class="fas fa-chart-line premium-icon"></i>
                                            <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span>
                                        </div>
                                        <div class="dropdown-item" data-value="user" onclick="selectCategory('user', 'fas fa-user', '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ')">
                                            <i class="fas fa-user premium-icon"></i>
                                            <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Time Range Filter -->
                            <div class="space-y-3">
                                <label class="flex items-center gap-3 text-sm font-semibold text-gray-700">
                                    <div class="w-6 h-6 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-calendar-alt text-purple-600 text-xs"></i>
                                    </div>
                                    ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
                                </label>
                                <select id="timeRangeFilter" 
                                    class="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-all duration-300 text-gray-700 cursor-pointer">
                                    <option value="">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="today">üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
                                    <option value="yesterday">üìÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</option>
                                    <option value="week">üìÜ ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option>
                                    <option value="month">üóìÔ∏è ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Beautiful Logs Timeline -->
            <div class="max-w-7xl mx-auto px-6 py-8">
                <div id="logCardsContainer" class="grid grid-cols-1 gap-6">
                    <!-- Loading State -->
                    <div id="timelineLoading" class="flex flex-col items-center justify-center py-20">
                        <div class="relative">
                            <div class="w-16 h-16 border-4 border-blue-200 rounded-full animate-spin border-t-blue-600"></div>
                            <div class="absolute inset-0 w-16 h-16 border-4 border-transparent rounded-full animate-ping border-t-blue-400"></div>
                        </div>
                        <div class="mt-6 text-center">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                            <p class="text-gray-500 text-sm">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
                        </div>
                    </div>
                </div>

                <!-- Beautiful Pagination -->
                <div id="pagination" class="flex justify-center mt-12">
                    <!-- Pagination will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Beautiful Modal Popup -->
        <div id="logDetailModal" class="fixed inset-0 z-[9999] hidden">
            <!-- Backdrop -->
            <div class="fixed inset-0 bg-gradient-to-br from-gray-900/50 via-blue-900/30 to-purple-900/50 backdrop-blur-md" onclick="closeLogModal()"></div>
            
            <!-- Modal Container -->
            <div class="fixed inset-0 flex items-center justify-center p-4">
                <div class="relative bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden animate-slide-up">
                    
                    <!-- Modal Header with Gradient -->
                    <div class="relative bg-gradient-to-r from-blue-600 via-purple-600 to-pink-500 p-8">
                        <!-- Background Pattern -->
                        <div class="absolute inset-0 opacity-10">
                            <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23ffffff" fill-opacity="0.1"%3E%3Ccircle cx="7" cy="7" r="1"/%3E%3Ccircle cx="37" cy="7" r="1"/%3E%3Ccircle cx="7" cy="37" r="1"/%3E%3Ccircle cx="37" cy="37" r="1"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')]"></div>
                        </div>
                        
                        <!-- Header Content -->
                        <div class="relative flex items-center justify-between">
                            <div class="flex items-center gap-6">
                                <div class="w-20 h-20 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-clipboard-list text-white text-3xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-3xl font-bold text-white mb-2">
                                        ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                                    </h3>
                                    <p class="text-white/80 text-lg">
                                        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Close Button -->
                            <button onclick="closeLogModal()" 
                                class="w-12 h-12 bg-white/20 backdrop-blur-sm text-white rounded-xl hover:bg-white/30 transition-all duration-300 transform hover:scale-110 flex items-center justify-center">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Modal Body -->
                    <div id="logDetailBody" class="p-8 bg-gradient-to-br from-gray-50 to-blue-50 overflow-y-auto max-h-[calc(90vh-160px)]">
                        <!-- Content will be inserted here -->
                    </div>
                    
                    <!-- Modal Footer -->
                    <div class="px-8 py-6 bg-white border-t border-gray-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 text-gray-500 text-sm">
                                <i class="fas fa-clock"></i>
                                <span id="modalTimestamp">‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏π</span>
                            </div>
                            <button onclick="closeLogModal()" 
                                class="px-6 py-3 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all duration-300 transform hover:scale-105 font-medium">
                                <i class="fas fa-times mr-2"></i>
                                ‡∏õ‡∏¥‡∏î
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById("mainContent").innerHTML = html;
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
    initUserLogsPage();
}

if (page === 'user-management') {
    renderUserManagementPage();
    return;
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö render ‡∏´‡∏ô‡πâ‡∏≤ User Management
function renderUserManagementPage() {
    const html = `
        <!-- User Management Page with Tailwind CSS -->
        <div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-100 p-4 lg:p-8">
            <!-- Header Section -->
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 mb-8 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                        <div class="flex items-center gap-4">
                            <div class="bg-white/20 p-3 rounded-xl">
                                <i class="fas fa-users-cog text-2xl"></i>
                            </div>
                            <div>
                                <h1 class="text-3xl font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h1>
                                <p class="text-blue-100 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</p>
                            </div>
                        </div>
                        <button onclick="showAddUserModal()" 
                                class="bg-white text-blue-600 hover:bg-blue-50 transition-all duration-300 
                                       px-6 py-3 rounded-xl font-semibold flex items-center gap-2 
                                       shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            <i class="fas fa-user-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6" id="userStats">
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-6 text-white relative overflow-hidden">
                            <div class="absolute top-0 right-0 transform translate-x-4 -translate-y-4">
                                <div class="bg-white/20 w-24 h-24 rounded-full"></div>
                            </div>
                            <div class="relative z-10">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="bg-white/20 p-3 rounded-lg">
                                        <i class="fas fa-users text-xl"></i>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-3xl font-bold" id="totalUsers">0</p>
                                        <p class="text-emerald-100">‡∏Ñ‡∏ô</p>
                                    </div>
                                </div>
                                <h3 class="font-semibold text-lg">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white relative overflow-hidden">
                            <div class="absolute top-0 right-0 transform translate-x-4 -translate-y-4">
                                <div class="bg-white/20 w-24 h-24 rounded-full"></div>
                            </div>
                            <div class="relative z-10">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="bg-white/20 p-3 rounded-lg">
                                        <i class="fas fa-user-check text-xl"></i>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-3xl font-bold" id="onlineUsers">0</p>
                                        <p class="text-blue-100">‡∏Ñ‡∏ô</p>
                                    </div>
                                </div>
                                <h3 class="font-semibold text-lg">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h3>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white relative overflow-hidden">
                            <div class="absolute top-0 right-0 transform translate-x-4 -translate-y-4">
                                <div class="bg-white/20 w-24 h-24 rounded-full"></div>
                            </div>
                            <div class="relative z-10">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="bg-white/20 p-3 rounded-lg">
                                        <i class="fas fa-user-shield text-xl"></i>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-3xl font-bold" id="adminUsers">0</p>
                                        <p class="text-purple-100">‡∏Ñ‡∏ô</p>
                                    </div>
                                </div>
                                <h3 class="font-semibold text-lg">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white relative overflow-hidden">
                            <div class="absolute top-0 right-0 transform translate-x-4 -translate-y-4">
                                <div class="bg-white/20 w-24 h-24 rounded-full"></div>
                            </div>
                            <div class="relative z-10">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="bg-white/20 p-3 rounded-lg">
                                        <i class="fas fa-user-clock text-xl"></i>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-3xl font-bold" id="newUsers">0</p>
                                        <p class="text-orange-100">‡∏Ñ‡∏ô</p>
                                    </div>
                                </div>
                                <h3 class="font-semibold text-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 mb-8 p-6">
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Search Box -->
                    <div class="flex-1">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" 
                                   id="userSearchInput"
                                   onkeyup="handleSearch(event)"
                                   class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-xl 
                                          focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                                          transition-all duration-300 text-gray-700 placeholder-gray-400"
                                   placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...">
                        </div>
                    </div>
                    
                    <!-- Filter Buttons -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterByRole('all')" id="filter-all"
                                class="filter-btn-tw active px-4 py-2 rounded-lg font-medium transition-all duration-300 
                                       bg-blue-500 text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                            <i class="fas fa-th mr-2"></i>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                        <button onclick="filterByRole('it')" id="filter-it"
                                class="filter-btn-tw px-4 py-2 rounded-lg font-medium transition-all duration-300 
                                       bg-gray-100 text-gray-700 hover:bg-blue-100 hover:text-blue-700 
                                       hover:shadow-md transform hover:-translate-y-0.5">
                            <i class="fas fa-laptop-code mr-2"></i>IT
                        </button>
                        <button onclick="filterByRole('engineer')" id="filter-engineer"
                                class="filter-btn-tw px-4 py-2 rounded-lg font-medium transition-all duration-300 
                                       bg-gray-100 text-gray-700 hover:bg-blue-100 hover:text-blue-700 
                                       hover:shadow-md transform hover:-translate-y-0.5">
                            <i class="fas fa-hard-hat mr-2"></i>Engineer
                        </button>
                        <button onclick="filterByRole('‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô')" id="filter-supervisor"
                                class="filter-btn-tw px-4 py-2 rounded-lg font-medium transition-all duration-300 
                                       bg-gray-100 text-gray-700 hover:bg-blue-100 hover:text-blue-700 
                                       hover:shadow-md transform hover:-translate-y-0.5">
                            <i class="fas fa-user-tie mr-2"></i>‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô
                        </button>
                        <button onclick="filterByRole('‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')" id="filter-employee"
                                class="filter-btn-tw px-4 py-2 rounded-lg font-medium transition-all duration-300 
                                       bg-gray-100 text-gray-700 hover:bg-blue-100 hover:text-blue-700 
                                       hover:shadow-md transform hover:-translate-y-0.5">
                            <i class="fas fa-user mr-2"></i>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                        </button>
                    </div>
                </div>
            </div>

            <!-- User Table Container -->
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
                                </th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- User rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Enhanced Modal with Tailwind -->
            <div id="userModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300">
                    <!-- Modal Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-2xl">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="bg-white/20 p-2 rounded-lg">
                                <i class="fas fa-user-plus text-lg"></i>
                            </div>
                            <h2 class="text-xl font-bold" id="userModalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h2>
                        </div>
                        <p class="text-blue-100 text-sm" id="userModalSubtitle">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                    </div>
                    
                    <!-- Modal Body -->
                    <form id="userForm" onsubmit="handleSaveUser(event)" class="p-6 space-y-6">
                        <input type="hidden" id="userId" />
                        
                        <!-- Username Field -->
                        <div class="space-y-2">
                            <label for="userUsername" class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                                <i class="fas fa-user text-blue-500"></i> ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                            </label>
                            <input type="text" 
                                   id="userUsername" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg 
                                          focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                                          transition-all duration-300 text-gray-700" 
                                   placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
                                   required>
                        </div>
                        
                        <!-- Password Field -->
                        <div class="space-y-2">
                            <label for="userPassword" class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                                <i class="fas fa-lock text-blue-500"></i> ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                            </label>
                            <input type="password" 
                                   id="userPassword" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg 
                                          focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                                          transition-all duration-300 text-gray-700" 
                                   placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢"
                                   onkeyup="checkPasswordStrength(this.value)">
                            <!-- Password Strength Indicator -->
                            <div id="passwordStrength" class="hidden mt-2">
                                <div class="flex gap-1">
                                    <div id="strength1" class="h-2 flex-1 rounded-full bg-gray-200 transition-all duration-300"></div>
                                    <div id="strength2" class="h-2 flex-1 rounded-full bg-gray-200 transition-all duration-300"></div>
                                    <div id="strength3" class="h-2 flex-1 rounded-full bg-gray-200 transition-all duration-300"></div>
                                    <div id="strength4" class="h-2 flex-1 rounded-full bg-gray-200 transition-all duration-300"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Role Field -->
                        <div class="space-y-2">
                            <label for="userRole" class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                                <i class="fas fa-user-tag text-blue-500"></i> ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
                            </label>
                            <select id="userRole" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg 
                                           focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                                           transition-all duration-300 text-gray-700 bg-white" 
                                    required>
                                <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>
                                <option value="‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</option>
                                <option value="engineer">Engineer</option>
                                <option value="it">IT</option>
                            </select>
                        </div>
                        
                        <!-- Modal Actions -->
                        <div class="flex gap-3 pt-4">
                            <button type="button" 
                                    onclick="closeUserModal()"
                                    class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 
                                           rounded-lg hover:bg-gray-50 transition-all duration-300 
                                           font-medium flex items-center justify-center gap-2">
                                <i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                            <button type="submit" 
                                    class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 
                                           text-white rounded-lg transition-all duration-300 
                                           font-medium flex items-center justify-center gap-2 
                                           shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
            <!-- Delete Confirmation Modal with Tailwind -->
            <div id="deleteConfirmModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all duration-300">
                    <!-- Modal Content -->
                    <div class="p-6 text-center">
                        <!-- Warning Icon -->
                        <div class="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                        </div>

                        <!-- Title and Message -->
                        <h2 class="text-xl font-bold text-gray-900 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h2>
                        <p id="deleteConfirmText" class="text-gray-600 mb-6">
                            ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
                        </p>
                        
                        <!-- Action Buttons -->
                        <div class="flex gap-3">
                            <button type="button" 
                                    onclick="closeDeleteConfirmModal()"
                                    class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 
                                           rounded-lg hover:bg-gray-50 transition-all duration-300 
                                           font-medium flex items-center justify-center gap-2">
                                <i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                            <button type="button" 
                                    id="confirmDeleteBtn"
                                    onclick="handleConfirmDelete()"
                                    class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 
                                           text-white rounded-lg transition-all duration-300 
                                           font-medium flex items-center justify-center gap-2 
                                           shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i class="fas fa-trash-alt"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                            </button>
                        </div>
                    </div>
                </div>
            </div>
    `;
    
    document.getElementById("mainContent").innerHTML = html;
    loadUsers();
}

function renderMonitorSensorPage() {
  const html = `
    <!-- Monitor Sensor Page with Tailwind CSS -->
    <div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-100 p-4 lg:p-8">
      <!-- Header Section -->
      <div class="bg-white rounded-2xl shadow-xl border border-gray-100 mb-8 overflow-hidden">
        <div class="bg-gradient-to-r from-emerald-600 to-teal-600 p-6 text-white">
          <div class="flex items-center gap-4">
            <div class="bg-white/20 p-3 rounded-xl">
              <i class="fas fa-microchip text-2xl"></i>
            </div>
            <div>
              <h1 class="text-3xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå</h1>
              <p class="text-emerald-100 mt-1">Real-time Sensor Monitoring System</p>
            </div>
          </div>
        </div>
        
        <!-- Control Panel -->
        <div class="p-6 bg-gray-50">
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div class="flex items-center gap-4">
              <button onclick="refreshAllSensors()" 
                      class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 
                             transition-colors flex items-center gap-2 shadow-md">
                <i class="fas fa-sync-alt"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
              </button>
              <button onclick="toggleAutoRefresh()" 
                      id="autoRefreshBtn"
                      class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 
                             transition-colors flex items-center gap-2 shadow-md">
                <i class="fas fa-play"></i> Auto Refresh
              </button>
            </div>
            <div class="flex items-center gap-4">
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                <span class="text-sm text-gray-600">‡∏õ‡∏Å‡∏ï‡∏¥</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                <span class="text-sm text-gray-600">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                <span class="text-sm text-gray-600">‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sensor Groups -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        
        <!-- Lift Sensors Group -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
          <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 text-white">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="bg-white/20 p-3 rounded-lg">
                  <i class="fas fa-arrow-up text-xl"></i>
                </div>
                <div>
                  <h3 class="text-xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏¥‡∏ü‡∏ï‡πå</h3>
                  <p class="text-blue-100">Lift System Sensors</p>
                </div>
              </div>
              <div class="text-right">
                <div class="text-2xl font-bold" id="liftSensorCount">8</div>
                <div class="text-blue-100 text-sm">‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå</div>
              </div>
            </div>
          </div>
          <div class="p-6">
            <div class="grid gap-3">
              <div class="sensor-card" data-sensor="gripper_f1">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="sensor-icon">
                      <i class="fas fa-hand-rock"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Gripper Floor 1</div>
                      <div class="text-sm text-gray-500">‡∏Å‡∏¥‡πä‡∏ö‡∏à‡∏±‡∏ö‡∏ñ‡∏≤‡∏î ‡∏ä‡∏±‡πâ‡∏ô 1</div>
                    </div>
                  </div>
                  <div class="sensor-status" id="gripper_f1">
                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">OFF</span>
                  </div>
                </div>
              </div>
              
              <div class="sensor-card" data-sensor="gripper_f2">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="sensor-icon">
                      <i class="fas fa-hand-rock"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Gripper Floor 2</div>
                      <div class="text-sm text-gray-500">‡∏Å‡∏¥‡πä‡∏ö‡∏à‡∏±‡∏ö‡∏ñ‡∏≤‡∏î ‡∏ä‡∏±‡πâ‡∏ô 2</div>
                    </div>
                  </div>
                  <div class="sensor-status" id="gripper_f2">
                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">OFF</span>
                  </div>
                </div>
              </div>
              
              <div class="sensor-card" data-sensor="gripper_f3">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="sensor-icon">
                      <i class="fas fa-hand-rock"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Gripper Floor 3</div>
                      <div class="text-sm text-gray-500">‡∏Å‡∏¥‡πä‡∏ö‡∏à‡∏±‡∏ö‡∏ñ‡∏≤‡∏î ‡∏ä‡∏±‡πâ‡∏ô 3</div>
                    </div>
                  </div>
                  <div class="sensor-status" id="gripper_f3">
                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">OFF</span>
                  </div>
                </div>
              </div>
              
              <div class="sensor-card" data-sensor="gripper_f4">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="sensor-icon">
                      <i class="fas fa-hand-rock"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Gripper Floor 4</div>
                      <div class="text-sm text-gray-500">‡∏Å‡∏¥‡πä‡∏ö‡∏à‡∏±‡∏ö‡∏ñ‡∏≤‡∏î ‡∏ä‡∏±‡πâ‡∏ô 4</div>
                    </div>
                  </div>
                  <div class="sensor-status" id="gripper_f4">
                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">OFF</span>
                  </div>
                </div>
              </div>
              
              <div class="sensor-card" data-sensor="gripper_f5">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="sensor-icon">
                      <i class="fas fa-hand-rock"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Gripper Floor 5</div>
                      <div class="text-sm text-gray-500">‡∏Å‡∏¥‡πä‡∏ö‡∏à‡∏±‡∏ö‡∏ñ‡∏≤‡∏î ‡∏ä‡∏±‡πâ‡∏ô 5</div>
                    </div>
                  </div>
                  <div class="sensor-status" id="gripper_f5">
                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">OFF</span>
                  </div>
                </div>
              </div>
              
              <div class="sensor-card" data-sensor="limit_top">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="sensor-icon">
                      <i class="fas fa-arrow-up"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Limit Top</div>
                      <div class="text-sm text-gray-500">‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>
                    </div>
                  </div>
                  <div class="sensor-status" id="limit_top">
                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">OFF</span>
                  </div>
                </div>
              </div>
              
              <div class="sensor-card" data-sensor="limit_bottom">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="sensor-icon">
                      <i class="fas fa-arrow-down"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Limit Bottom</div>
                      <div class="text-sm text-gray-500">‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</div>
                    </div>
                  </div>
                  <div class="sensor-status" id="limit_bottom">
                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">OFF</span>
                  </div>
                </div>
              </div>
              
              <div class="sensor-card emergency" data-sensor="emergency_btn">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="sensor-icon emergency">
                      <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Emergency</div>
                      <div class="text-sm text-gray-500">‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏¢‡∏∏‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</div>
                    </div>
                  </div>
                  <div class="sensor-status" id="emergency_btn">
                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">OFF</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- AGV Sensors Group -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
          <div class="bg-gradient-to-r from-orange-500 to-orange-600 p-6 text-white">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="bg-white/20 p-3 rounded-lg">
                  <i class="fas fa-truck-moving text-xl"></i>
                </div>
                <div>
                  <h3 class="text-xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö AGV</h3>
                  <p class="text-orange-100">AGV System Sensors</p>
                </div>
              </div>
              <div class="text-right">
                <div class="text-2xl font-bold" id="agvSensorCount">6</div>
                <div class="text-orange-100 text-sm">‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå</div>
              </div>
            </div>
          </div>
          <div class="p-6">
            <div class="grid gap-3">
              <div class="sensor-card" data-sensor="tray_sensor">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="sensor-icon">
                      <i class="fas fa-th-large"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Tray Sensor</div>
                      <div class="text-sm text-gray-500">‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ñ‡∏≤‡∏î</div>
                    </div>
                  </div>
                  <div class="sensor-status" id="tray_sensor">
                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">OFF</span>
                  </div>
                </div>
              </div>
              
              <div class="sensor-card" data-sensor="pos_sensor1">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="sensor-icon">
                      <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Position Sensor 1</div>
                      <div class="text-sm text-gray-500">‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á 1</div>
                    </div>
                  </div>
                  <div class="sensor-status" id="pos_sensor1">
                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">OFF</span>
                  </div>
                </div>
              </div>
              
              <div class="sensor-card" data-sensor="pos_sensor2">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="sensor-icon">
                      <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Position Sensor 2</div>
                      <div class="text-sm text-gray-500">‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á 2</div>
                    </div>
                  </div>
                  <div class="sensor-status" id="pos_sensor2">
                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">OFF</span>
                  </div>
                </div>
              </div>
              
              <div class="sensor-card" data-sensor="limit_agv_1">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="sensor-icon">
                      <i class="fas fa-stop-circle"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Limit AGV 1</div>
                      <div class="text-sm text-gray-500">‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏à‡∏≥‡∏Å‡∏±‡∏î AGV 1</div>
                    </div>
                  </div>
                  <div class="sensor-status" id="limit_agv_1">
                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">OFF</span>
                  </div>
                </div>
              </div>
              
              <div class="sensor-card" data-sensor="limit_agv_2">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="sensor-icon">
                      <i class="fas fa-stop-circle"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Limit AGV 2</div>
                      <div class="text-sm text-gray-500">‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏à‡∏≥‡∏Å‡∏±‡∏î AGV 2</div>
                    </div>
                  </div>
                  <div class="sensor-status" id="limit_agv_2">
                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">OFF</span>
                  </div>
                </div>
              </div>
              
              <div class="sensor-card" data-sensor="agv_on">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="sensor-icon">
                      <i class="fas fa-power-off"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Power ON</div>
                      <div class="text-sm text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
                    </div>
                  </div>
                  <div class="sensor-status" id="agv_on">
                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">OFF</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- System Status Summary -->
      <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-6 text-white">
          <div class="flex items-center gap-3">
            <div class="bg-white/20 p-3 rounded-lg">
              <i class="fas fa-chart-bar text-xl"></i>
            </div>
            <div>
              <h3 class="text-xl font-bold">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</h3>
              <p class="text-purple-100">System Status Summary</p>
            </div>
          </div>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            <div class="text-center">
              <div class="text-3xl font-bold text-green-600" id="activeSensors">0</div>
              <div class="text-sm text-gray-600">‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-red-600" id="errorSensors">0</div>
              <div class="text-sm text-gray-600">‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-gray-500" id="offlineSensors">14</div>
              <div class="text-sm text-gray-600">‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-blue-600" id="lastUpdate">--:--</div>
              <div class="text-sm text-gray-600">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <style>
      .sensor-card {
        @apply p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer;
      }
      
      .sensor-card.emergency {
        @apply border-red-200 bg-red-50;
      }
      
      .sensor-icon {
        @apply w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center;
      }
      
      .sensor-icon.emergency {
        @apply bg-red-100 text-red-600;
      }
      
      .sensor-status {
        @apply flex items-center gap-2;
      }
      
      .sensor-card:hover {
        @apply shadow-md;
      }
    </style>
  `;
  document.getElementById("mainContent").innerHTML = html;
  
  // Initialize sensor monitoring
  initSensorMonitoring();
}

// Sensor monitoring JavaScript functions
let sensorAutoRefresh = false;
let sensorRefreshInterval = null;
const sensorIds = [
  'gripper_f1', 'gripper_f2', 'gripper_f3', 'gripper_f4', 'gripper_f5',
  'limit_top', 'limit_bottom', 'emergency_btn',
  'tray_sensor', 'pos_sensor1', 'pos_sensor2', 'limit_agv_1', 'limit_agv_2', 'agv_on'
];

function initSensorMonitoring() {
  
  // Load initial sensor data
  refreshAllSensors();
  
  // Update timestamp
  updateLastUpdateTime();
  
}

async function refreshAllSensors() {
  
  try {
    // Show loading state
    sensorIds.forEach(sensorId => {
      updateSensorStatus(sensorId, 'loading', '‚ü≥');
    });
    
    // Fetch sensor data from API
    const response = await fetch('/api/sensors');
    
    if (response.ok) {
      const sensorData = await response.json();
      
      // Update each sensor
      sensorIds.forEach(sensorId => {
        const isActive = sensorData[sensorId] || false;
        const status = isActive ? 'on' : 'off';
        const text = isActive ? 'ON' : 'OFF';
        updateSensorStatus(sensorId, status, text);
      });
      
      // Update summary stats
      updateSensorSummary(sensorData);
      updateLastUpdateTime();
      
      
    } else {
      console.error('‚ùå Failed to fetch sensor data');
      
      // Show error state
      sensorIds.forEach(sensorId => {
        updateSensorStatus(sensorId, 'error', 'ERROR');
      });
    }
    
  } catch (error) {
    console.error('‚ùå Error refreshing sensors:', error);
    
    // Show offline state
    sensorIds.forEach(sensorId => {
      updateSensorStatus(sensorId, 'offline', 'OFFLINE');
    });
  }
}

function updateSensorStatus(sensorId, status, text) {
  const sensorElement = document.getElementById(sensorId);
  if (!sensorElement) return;
  
  const dot = sensorElement.querySelector('.w-3.h-3');
  const span = sensorElement.querySelector('span');
  
  if (!dot || !span) return;
  
  // Remove all status classes
  dot.classList.remove('bg-green-500', 'bg-red-500', 'bg-gray-400', 'bg-yellow-500', 'bg-blue-500');
  span.classList.remove('text-green-600', 'text-red-600', 'text-gray-500', 'text-yellow-600', 'text-blue-600');
  
  // Apply new status
  switch (status) {
    case 'on':
      dot.classList.add('bg-green-500');
      span.classList.add('text-green-600');
      span.textContent = text;
      break;
    case 'off':
      dot.classList.add('bg-gray-400');
      span.classList.add('text-gray-500');
      span.textContent = text;
      break;
    case 'error':
      dot.classList.add('bg-red-500');
      span.classList.add('text-red-600');
      span.textContent = text;
      break;
    case 'loading':
      dot.classList.add('bg-blue-500');
      span.classList.add('text-blue-600');
      span.textContent = text;
      break;
    case 'offline':
      dot.classList.add('bg-yellow-500');
      span.classList.add('text-yellow-600');
      span.textContent = text;
      break;
  }
  
  // Add pulse effect for active sensors
  if (status === 'on') {
    dot.classList.add('animate-pulse');
  } else {
    dot.classList.remove('animate-pulse');
  }
}

function updateSensorSummary(sensorData) {
  const sensors = Object.values(sensorData);
  const activeSensors = sensors.filter(Boolean).length;
  const totalSensors = sensors.length;
  const offlineSensors = totalSensors - sensors.filter(s => s !== null).length;
  const errorSensors = 0; // Add error detection logic if needed
  
  // Update summary numbers
  document.getElementById('activeSensors').textContent = activeSensors;
  document.getElementById('errorSensors').textContent = errorSensors;
  document.getElementById('offlineSensors').textContent = offlineSensors;
}

function updateLastUpdateTime() {
  const now = new Date();
  const timeString = now.toLocaleTimeString('th-TH', { 
    hour: '2-digit', 
    minute: '2-digit' 
  });
  
  const lastUpdateElement = document.getElementById('lastUpdate');
  if (lastUpdateElement) {
    lastUpdateElement.textContent = timeString;
  }
}

function toggleAutoRefresh() {
  const btn = document.getElementById('autoRefreshBtn');
  const icon = btn.querySelector('i');
  
  if (sensorAutoRefresh) {
    // Stop auto refresh
    clearInterval(sensorRefreshInterval);
    sensorRefreshInterval = null;
    sensorAutoRefresh = false;
    
    // Update button
    btn.classList.remove('bg-red-600', 'hover:bg-red-700');
    btn.classList.add('bg-green-600', 'hover:bg-green-700');
    icon.classList.remove('fa-stop');
    icon.classList.add('fa-play');
    btn.innerHTML = '<i class="fas fa-play"></i> Auto Refresh';
    
    
  } else {
    // Start auto refresh
    sensorRefreshInterval = setInterval(refreshAllSensors, 5000); // Every 5 seconds
    sensorAutoRefresh = true;
    
    // Update button
    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
    btn.classList.add('bg-red-600', 'hover:bg-red-700');
    icon.classList.remove('fa-play');
    icon.classList.add('fa-stop');
    btn.innerHTML = '<i class="fas fa-stop"></i> Stop Auto';
    
  }
}

// Cleanup function when leaving the page
function cleanupSensorMonitoring() {
  if (sensorRefreshInterval) {
    clearInterval(sensorRefreshInterval);
    sensorRefreshInterval = null;
    sensorAutoRefresh = false;
  }
}




if (page === 'tray-inbound') {
    showTrayInboundPage();
    
    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• auto navigate ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const inboundData = sessionStorage.getItem('inbound_data');
    if (inboundData) {
        try {
            const data = JSON.parse(inboundData);
            prefillInboundForm(data);
            sessionStorage.removeItem('inbound_data');
            showToast(`üìã ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏á‡∏≤‡∏ô ${data.vegetable_type}`, true);
        } catch (err) {
            console.error('Error parsing inbound data:', err);
        }
    }
    return;
}

if (page === "MonitorSensor") {
  renderMonitorSensorPage();
    return;
}

  // fallback: ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ
  document.getElementById("mainContent").innerHTML = "<div class='section'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</div>";
}




    

  let confirmCallback = null;

  function showConfirmDialog(message, callback) {
    document.getElementById('confirmText').innerText = message;
    document.getElementById('confirmModal').style.display = 'flex';
    confirmCallback = callback;
  }

  function confirmAction(result) {
    document.getElementById('confirmModal').style.display = 'none';
    if (confirmCallback) confirmCallback(result);
  }
  function switchTab(tab) {
  document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
  if (tab === 'in') {
    document.getElementById("inboundTab").style.display = 'block';
    document.getElementById("outboundTab").style.display = 'none';
    document.querySelector(".tab-button:nth-child(1)").classList.add("active");
  } else {
    document.getElementById("inboundTab").style.display = 'none';
    document.getElementById("outboundTab").style.display = 'block';
    document.querySelector(".tab-button:nth-child(2)").classList.add("active");
  }
}
// ‚úÖ Login function ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß (v2)
async function login() {
  // Login function called
  
  // 1. ‡∏î‡∏∂‡∏á Element ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const userEl = document.querySelector('input#username');
  const passEl = document.querySelector('input#password');
  const msgEl = document.querySelector('#loginMsg');
  const loginBtn = document.querySelector('#loginPage button'); // <-- ‡∏î‡∏∂‡∏á‡∏õ‡∏∏‡πà‡∏° Login

  if (!userEl || !passEl || !msgEl || !loginBtn) {
    console.warn("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Element ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Login");
    return;
  }

  // 2. Input Validation and basic checks
  const user = userEl.value.trim();
  const pass = passEl.value.trim();

  // Basic validation first
  if (!user || !pass) {
    msgEl.style.color = '#f59e0b';
    msgEl.textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô';
    msgEl.style.display = 'block';
    return;
  }

  // Skip detailed validation - ‡πÉ‡∏ä‡πâ basic check ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö username ‡πÄ‡∏î‡∏¥‡∏°

  // 3. ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Loading
  const originalBtnText = loginBtn.innerHTML;
  loginBtn.disabled = true;
  loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
  msgEl.style.display = 'none';

  try {
    // 4. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server
    const response = await fetch("/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: user, password: pass })
    });

    const data = await response.json();

    if (!response.ok) {
      // ‡∏ñ‡πâ‡∏≤ Server ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (status 4xx, 5xx)
      throw new Error(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á');
    }

    // 5. ‡∏Å‡∏£‡∏ì‡∏µ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    localStorage.setItem("loggedIn", "true");
    localStorage.setItem("username", data.username);
    localStorage.setItem("userId", data.id);
    startPinging();
    
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("dashboardPage").style.display = "flex";

    document.getElementById("currentUser").innerHTML =
      `<i class="fas fa-user" style="color:#40916c; margin-right: 6px;"></i> ${data.username} ‚è∑`;

    showPage('overview');

  } catch (err) {
    // 6. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error (‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏Å Network ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà Server ‡πÅ‡∏à‡πâ‡∏á‡∏°‡∏≤)
    console.error("‚ùå login error", err);
    msgEl.style.color = '#dc2626';
    msgEl.textContent = `‚ùå ${err.message}`;
    msgEl.style.display = 'block';

  } finally {
    // 7. ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏°‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß)
    loginBtn.disabled = false;
    loginBtn.innerHTML = originalBtnText;
  }
}



document.addEventListener("DOMContentLoaded", function () {
  const loggedIn = localStorage.getItem("loggedIn");
  const username = localStorage.getItem("username");

  if (loggedIn === "true" && username) {
    currentUsername = username;
startPinging();
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("dashboardPage").style.display = "flex";

    document.getElementById("currentUser").innerHTML =
      `<i class="fas fa-user" style="color:#40916c; margin-right: 6px;"></i> ${username} ‚è∑`;
 
    showPage("overview");
  } else {
    document.getElementById("loginPage").style.display = "flex";
    document.getElementById("dashboardPage").style.display = "none";
    
    // Setup keyboard handlers for login page
    setTimeout(() => {
      setupLoginKeyboardHandlers();
      SecurityUtils.getCSRFToken(); // Initialize CSRF token
    }, 100);
  }
});


let systemAlerts = {
  lift: false, // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô true ‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
  agv: false   // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô true ‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á AGV ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
};

// 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
async function checkAllStationStatus() {
  try {
    // ‡∏¢‡∏¥‡∏á API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á Lift ‡πÅ‡∏•‡∏∞ AGV ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
    const [liftRes, agvRes] = await Promise.all([
      fetch(`/api/lift/status?station=${currentStation}`),
      fetch(`/api/agv/status?station=${currentStation}`)
    ]);

    const liftStatus = await liftRes.json();
    const agvStatus = await agvRes.json();

    // --- ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LIFT ---
    if (liftStatus.emergency && !systemAlerts.lift) {
      // ‡∏ñ‡πâ‡∏≤‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (emergency) ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
      showNotification('üö® LIFT EMERGENCY: ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏´‡∏¢‡∏∏‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô!', 'error');
      systemAlerts.lift = true; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    } else if (!liftStatus.emergency && systemAlerts.lift) {
      // ‡∏ñ‡πâ‡∏≤‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ
      systemAlerts.lift = false; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤
    }

    // --- ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AGV ---
    if (agvStatus.status === 'error' && !systemAlerts.agv) {
      // ‡∏ñ‡πâ‡∏≤ AGV ‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô 'error' ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
      showNotification('‚ùå AGV ERROR: ‡∏£‡∏∞‡∏ö‡∏ö RGV ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', 'error');
      systemAlerts.agv = true; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    } else if (agvStatus.status !== 'error' && systemAlerts.agv) {
      // ‡∏ñ‡πâ‡∏≤ AGV ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ
      systemAlerts.agv = false; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    }

  } catch (err) {
    console.error("Global Status Check Error:", err);
    // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
  }
}

// 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏ß‡∏ô‡∏•‡∏π‡∏õ
function startGlobalStatusMonitor() {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
  checkAllStationStatus();
  
  // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡πÜ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  setInterval(checkAllStationStatus, 10000); 
}




function register() {
  const regUsername = document.getElementById("regUsername").value;
  const regPassword = document.getElementById("regPassword").value;
  const regRole = document.getElementById("regRole").value;

  fetch("/api/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: regUsername, password: regPassword, role: regRole })
  })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        showToast("‚ùå " + data.error);
      } else {
        showToast("‚úÖ " + data.message + " ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login");
        showPage("login");
      }
    })
    .catch(err => showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠"));
}

function showToast(message, isSuccess = true, duration = 3000) {
    // ‡∏•‡∏ö toast ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    const existingToast = document.querySelector('.enhanced-toast');
    if (existingToast) existingToast.remove();
    
    const toast = document.createElement('div');
    toast.className = `enhanced-toast ${isSuccess ? 'success' : 'error'}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas ${isSuccess ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° styles
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideInRight 0.5s ease;
        background: ${isSuccess ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'};
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.5s ease';
        setTimeout(() => toast.remove(), 500);
    }, duration);
}








function showOutput(text) {
  const output = document.getElementById("output") || document.createElement("div");
  output.id = "output";
  output.innerText = typeof text === "object" ? JSON.stringify(text, null, 2) : text;
  output.style.background = "#eee";
  output.style.padding = "10px";
  document.body.appendChild(output);
}




function showChangePassword() {
  document.getElementById("changeBox").style.display = "flex";
}

function closeChangePassword() {
  document.getElementById("changeBox").style.display = "none";

  // üßº ‡∏•‡πâ‡∏≤‡∏á input ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  document.getElementById("changeUser").value = "";
  document.getElementById("oldPass").value = "";
  document.getElementById("newPass").value = "";
  const msg = document.getElementById("changeMsg");
  msg.style.display = "none";
  msg.textContent = "";
  msg.className = "message";
}



  // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
  function backToLogin() {
  document.getElementById("registerPage").style.display = "none";

  const loginPage = document.getElementById("loginPage");
  loginPage.style.display = "flex";
  loginPage.style.flexDirection = "column";
  loginPage.style.justifyContent = "center";
  loginPage.style.alignItems = "center";
  loginPage.style.height = "100vh";
}

  
  function showRegister() {
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("registerPage").style.display = "block";
}

function goToRegister() {
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("registerPage").style.display = "block";
}

function goToChangePassword() {
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("changePasswordPage").style.display = "block";
}



//‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
function deleteAccount() {
  const inputUser = document.getElementById('deleteUser').value.trim();
  const inputPass = document.getElementById('deletePass').value.trim();
  const currentUser = localStorage.getItem('currentUser');
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  const msg = document.getElementById('deleteMsg');

  // Reset message
  msg.style.display = "none";
  msg.style.color = "#991b1b";

  // 1Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡πÑ‡∏´‡∏°
  if (!inputUser || !inputPass) {
    msg.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô";
    msg.style.display = "block";
    return;
  }

  // 2Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ inputUser ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö currentUser
  if (inputUser !== currentUser) {
    msg.innerText = "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
    msg.style.display = "block";
    return;
  }

  // 3Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
  if (users[currentUser] !== inputPass) {
    msg.innerText = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
    msg.style.display = "block";
    return;
  }

  // 4Ô∏è‚É£ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  delete users[currentUser];

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏°‡∏µ admin ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏™‡∏°‡∏≠
  if (!users["admin"]) {
    users["admin"] = "1234";
  }

  localStorage.setItem("users", JSON.stringify(users));
  msg.style.color = "#065f46";
  msg.innerText = "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
  msg.style.display = "block";

  // 5Ô∏è‚É£ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö
  setTimeout(() => {
    logout();
  }, 1500);
}

function closeDeleteBox() {
  document.getElementById("deleteBox").style.display = "none";
  document.getElementById("deleteMsg").style.display = "none";
}

function showDeleteBox() {
  document.getElementById("deleteUser").value = "";
  document.getElementById("deletePass").value = "";
  document.getElementById("deleteMsg").style.display = "none";
  document.getElementById("deleteBox").style.display = "flex";
}

function showLogoutBox() {
  document.getElementById("logoutBox").style.display = "flex";
}

function closeLogoutBox() {
  document.getElementById("logoutBox").style.display = "none";
}

// ‚úÖ‚úÖ‚úÖ [‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô confirmLogout ‡πÄ‡∏î‡∏¥‡∏°] ‚úÖ‚úÖ‚úÖ
async function confirmLogout() {
    // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£ Ping ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
    if (sessionPingInterval) {
        clearInterval(sessionPingInterval);
        sessionPingInterval = null; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API logout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö session ‡πÉ‡∏ô server ‡∏Å‡πà‡∏≠‡∏ô
    try {
      const userId = localStorage.getItem("userId");
      if (userId) {
        await fetch('/api/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userId: parseInt(userId) })
        });
        console.log('‚úÖ API logout called successfully');
      }
    } catch (error) {
      console.error('‚ùå Error during logout API call:', error);
    }

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage
    localStorage.removeItem("loggedIn");
    localStorage.removeItem("username");
    localStorage.removeItem("userId");

    location.reload(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
}



  async function logout() {
    
    // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô logout
    stopAllPollers();
    stopAllTimers();
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API logout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö session ‡πÉ‡∏ô server
    try {
      const userId = localStorage.getItem("userId");
      if (userId) {
        await fetch('/api/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userId: parseInt(userId) })
        });
      }
    } catch (error) {
      console.error('Error during logout:', error);
    }
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    localStorage.removeItem("loggedIn");
    localStorage.removeItem("currentUser");
    localStorage.removeItem("username");
    localStorage.removeItem("userId");
    localStorage.removeItem("userRole");
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
    currentUsername = null;
    
    // ‡∏ã‡πà‡∏≠‡∏ô dashboard ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á login page
    document.getElementById("dashboardPage").style.display = "none";
    document.getElementById("loginPage").style.display = "flex";
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const mainContent = document.getElementById("mainContent");
    if (mainContent) {
        mainContent.innerHTML = "";
    }
    
  }

  window.onload = function () {
  const loggedIn = localStorage.getItem("loggedIn");
  const username = localStorage.getItem("username");

  if (loggedIn === "true" && username) {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session validity ‡∏Å‡πà‡∏≠‡∏ô
    if (!checkSessionValidity()) {
      return;
    }
    
    currentUsername = username;
    startPinging();
    startSessionTimer(); // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏° session timer
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("dashboardPage").style.display = "flex";

    document.getElementById("currentUser").innerHTML =
      `<i class="fas fa-user" style="color:#40916c; margin-right: 6px;"></i> ${username} ‚è∑`;
 
    showPage("overview");
  } else {
    document.getElementById("loginPage").style.display = "flex";
    document.getElementById("dashboardPage").style.display = "none";
    
    // Setup keyboard handlers for login page
    setTimeout(() => {
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      if (usernameInput) usernameInput.focus();
    }, 100);
  }
}




function changePassword() {
  const user = document.getElementById("changeUser").value.trim();
  const oldPass = document.getElementById("oldPass").value.trim();
  const newPass = document.getElementById("newPass").value.trim();
  const msg = document.getElementById("changeMsg");

  msg.className = "message";
  msg.style.display = "none";

  if (!user || !oldPass || !newPass) {
    msg.textContent = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö";
    msg.classList.add("error");
    msg.style.display = "block";
    return;
  }

  const users = JSON.parse(localStorage.getItem("users") || "{}");

  if (!users[user]) {
  msg.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ";
  msg.classList.add("error");
} else if (users[user].password !== oldPass) {
  msg.textContent = "‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
  msg.classList.add("error");
} else {
  users[user].password = newPass;  // ‚úÖ update password ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  localStorage.setItem("users", JSON.stringify(users));
  msg.textContent = "‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  msg.classList.add("success");
}

  msg.style.display = "block";
}


document.addEventListener('DOMContentLoaded', () => {
  const userWrapper = document.getElementById("userWrapper");
  const dropdown = document.getElementById("userDropdown");
  const hamburgerBtn = document.getElementById('hamburger-menu');
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main');
    const pageLinks = document.querySelectorAll('.sidebar a');

    if (hamburgerBtn && sidebar && mainContent) {
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Hamburger ‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏±‡∏ö class 'show'
        hamburgerBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
            sidebar.classList.toggle('show');
            
            // ‚úÖ ‡∏õ‡∏¥‡∏î user dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î sidebar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
            const userDropdown = document.getElementById('userDropdown');
            if (userDropdown && userDropdown.style.display === 'block') {
                userDropdown.style.display = 'none';
            }
        });

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô sidebar
        mainContent.addEventListener('click', () => {
            if (sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
            }
        });

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏°‡∏ô‡∏π ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô sidebar
        pageLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (sidebar.classList.contains('show')) {
                    sidebar.classList.remove('show');
                }
            });
        });
    }
  let isHovering = false;
  let hideTimeout;

  userWrapper.addEventListener("mouseenter", () => {
    clearTimeout(hideTimeout);
    dropdown.style.display = "block";
  });

  userWrapper.addEventListener("mouseleave", () => {
    hideTimeout = setTimeout(() => {
      dropdown.style.display = "none";
    }, 200); // ‡∏£‡∏≠ 200ms ‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏ô
  });
});
// ‚úÖ [‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á Inventory ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á Tray ID ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Popup
function renderTrayGrid() {
  const grid = document.querySelector(".tray-grid");
  if (!grid) {
    console.warn("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ .tray-grid ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‚Äì renderTrayGrid() ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Å‡πà‡∏≠‡∏ô DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°");
    return;
  }
  grid.innerHTML = "";

  for (let floor = 9; floor >= 1; floor--) {
    for (let slot = 1; slot <= 18; slot++) { // ‚ùóÔ∏è ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 18
      const key = `${floor}-${slot}`;
      const info = trayInventory[key];

      const isFilled = info && (info.status === 'on_shelf' || info.status === 'IN_STORAGE');

      const div = document.createElement("div");
      div.className = "tray-slot";
      div.style.padding = "12px";
      div.style.border = "1px solid #ccc";
      div.style.borderRadius = "6px";
      div.style.fontSize = "0.8em";
      div.style.textAlign = "center";
      
      if (isFilled) {
        div.style.background = "#52b788";
        div.style.color = "#fff";
        div.title = `${info.veg_type} \n‡∏ï‡πâ‡∏ô: ${info.plant_quantity || 'N/A'} \n‡πÄ‡∏ß‡∏•‡∏≤: ${info.time_in}`;
        div.classList.add("filled");
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ñ‡∏≤‡∏î
        div.innerHTML = `
          <div class="filled-tray-veg-name">${info.veg_type}</div>
          <div class="filled-tray-id">ID: ${info.tray_id}</div>
        `;
      } else {
        div.style.background = "#e2e8f0";
        div.style.color = "#555";
        div.title = `‡∏ß‡πà‡∏≤‡∏á`;
        div.classList.add("empty");
        div.textContent = `‡∏ä‡∏±‡πâ‡∏ô ${floor} / ${slot}`;
      }

      div.onclick = () => {
        if (isFilled && info) {
          const placedTime = new Date(info.time_in);
          const now = new Date();
          const diffMs = now - placedTime;
          const diffMins = Math.floor(diffMs / 1000 / 60);
          const hours = Math.floor(diffMins / 60);
          const minutes = diffMins % 60;
          const days = Math.floor(hours / 24);
          const remainHours = hours % 24;

          let ageStr = "";
          if (days > 0) ageStr += `${days} ‡∏ß‡∏±‡∏ô `;
          if (remainHours > 0 || days > 0) ageStr += `${remainHours} ‡∏ä‡∏°. `;
          ageStr += `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;

          // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ] ‡πÄ‡∏û‡∏¥‡πà‡∏° trayId ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
          showTrayInfoPopup({
            trayId: info.tray_id, 
            username: info.username || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏",
            veg: info.veg_type,
            floor: info.floor,
            slot: info.slot,
            timestamp: new Date(info.time_in).toLocaleString("th-TH"),
            age: ageStr,
            harvestDate: info.harvest_date ? new Date(info.harvest_date).toLocaleDateString("th-TH") : 'N/A',
            batchNumber: info.batch_id || info.batch_number || 'N/A',
            planNotes: info.plan_notes || '',
            seedingDate: info.seeding_date ? new Date(info.seeding_date).toLocaleDateString("th-TH") : 'N/A',
            plantCount: info.plant_quantity || info.plant_count || info.quantity || 0
          });
        }
      };
      grid.appendChild(div);
    }
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const userMenu = document.getElementById("currentUser");
  const userDropdown = document.getElementById("userDropdown");
  const toggleButton = document.getElementById("toggleTheme");

  // üëâ ‡∏Å‡∏î‡∏ó‡∏µ‡πà user menu ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå/‡∏ã‡πà‡∏≠‡∏ô dropdown
  userMenu.addEventListener("click", () => {
    const isVisible = userDropdown.style.display === "block";
    userDropdown.style.display = isVisible ? "none" : "block";
    
    // ‚úÖ ‡∏õ‡∏¥‡∏î sidebar ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î user dropdown ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
    const sidebar = document.querySelector('.sidebar');
    if (sidebar && sidebar.classList.contains('show') && !isVisible) {
        sidebar.classList.remove('show');
    }
  });

  // üëâ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô ‡∏ã‡πà‡∏≠‡∏ô dropdown
  window.addEventListener("click", (e) => {
    if (!userMenu.contains(e.target) && !userDropdown.contains(e.target)) {
      userDropdown.style.display = "none";
    }
  });

  // üåô ‡πÇ‡∏´‡∏•‡∏î‡∏ò‡∏µ‡∏°‡∏à‡∏≤‡∏Å localStorage ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
    if (toggleButton) toggleButton.textContent = "‚òÄÔ∏è Light Mode";
  }

  // üåó ‡∏õ‡∏∏‡πà‡∏° toggle theme
  if (toggleButton) {
    toggleButton.addEventListener("click", () => {
      const isDark = document.body.classList.toggle("dark-mode");
      toggleButton.textContent = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });
  }
});


const hourlyCtx = document.getElementById('hourlyChart')?.getContext('2d');
if (hourlyCtx) {
  const hourlyChart = new Chart(hourlyCtx, {
    type: 'line',
    data: {
      labels: [...Array(24).keys()].map(h => `${String(h).padStart(2, '0')}:00`),
      datasets: [
        {
          label: 'Inbound',
          data: [1, 0, 2, 1, 3, 4, 6, 9, 12, 10, 8, 7, 5, 6, 7, 9, 8, 7, 5, 4, 3, 2, 1, 0],
          borderColor: '#40916c',
          backgroundColor: 'rgba(64,145,108,0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 3
        },
        {
          label: 'Outbound',
          data: [0, 1, 1, 0, 2, 3, 5, 8, 9, 11, 9, 6, 4, 4, 6, 8, 7, 6, 4, 3, 2, 1, 0, 0],
          borderColor: '#74c69d',
          backgroundColor: 'rgba(116,198,157,0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 3
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å ‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (00:00 - 23:00)',
          font: {
            size: 18
          },
          color: '#1b4332'
        },
        legend: {
          labels: {
            font: { size: 14 },
            color: '#1b4332'
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 2,
            color: '#1b4332'
          },
          title: {
            display: true,
            text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏≤‡∏î',
            color: '#1b4332',
            font: {
              size: 14
            }
          }
        },
        x: {
          ticks: {
            color: '#1b4332'
          },
          title: {
            display: true,
            text: '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)',
            color: '#1b4332',
            font: {
              size: 14
            }
          }
        }
      }
    }
  });
}


//‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ñ‡πà‡∏≠ esp32 ‡∏à‡∏≥‡∏•‡∏≠‡∏á
function simulateMQTTHeartbeat(topic) {
  // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏µ message ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
  for (const [name, dev] of Object.entries(devices)) {
    if (dev.topic === topic) {
      dev.lastSeen = Date.now();
      dev.status = "online";
    }
  }
}



// ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
function updateSystemUI() {
  const container = document.getElementById("systemStatus");
  if (!container) return; // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ element ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà ‚Üí ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢

  container.innerHTML = "";

  const now = Date.now();
  for (const [name, dev] of Object.entries(devices)) {
    const diff = now - dev.lastSeen;
    const isOnline = diff < 10000;
    dev.status = isOnline ? "online" : "offline";

    const card = document.createElement("div");
    card.style = `
      padding: 20px;
      border-radius: 16px;
      background: ${isOnline ? '#d8f3dc' : '#f8d7da'};
      border-left: 8px solid ${isOnline ? '#2d6a4f' : '#c82333'};
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      min-width: 220px;
      font-family: 'Prompt', sans-serif;
    `;

    card.innerHTML = `
      <h3 style="margin: 0 0 10px 0;">${name}</h3>
      <p>Status: <strong style="color: ${isOnline ? '#2d6a4f' : '#c82333'}">${dev.status.toUpperCase()}</strong></p>
      <p>Last Seen: ${isOnline ? (Math.floor(diff / 1000) + 's ago') : '‚ùå Offline'}</p>
    `;
    container.appendChild(card);
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£ heartbeat ‡∏à‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞ ESP32
function simulateMQTTHeartbeat(topic) {
  for (const dev of Object.values(devices)) {
    if (dev.topic === topic) {
      dev.lastSeen = Date.now();
    }
  }
}

let co2Chart, tempChart, humidityChart;
let currentDay = new Date().getDate(); // üîÅ ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà

function setupEnvironmentCharts() {
  const co2Ctx = document.getElementById('co2Chart')?.getContext('2d');
  const tempCtx = document.getElementById('tempChart')?.getContext('2d');
  const humidityCtx = document.getElementById('humidityChart')?.getContext('2d');
  const timeNow = () => new Date().toLocaleTimeString('th-TH', { hour12: false });

  co2Chart = new Chart(co2Ctx, {
    type: 'line',
    data: {
      labels: [timeNow()],
      datasets: [{
        label: 'CO2 (ppm)',
        data: [getRandom(440, 520)],
        borderColor: '#ef476f',
        backgroundColor: 'rgba(239, 71, 111, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: { responsive: true }
  });

  tempChart = new Chart(tempCtx, {
    type: 'line',
    data: {
      labels: [timeNow()],
      datasets: [{
        label: 'Temperature (¬∞C)',
        data: [getRandom(24, 30)],
        borderColor: '#ffd166',
        backgroundColor: 'rgba(255, 209, 102, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: { responsive: true }
  });

  humidityChart = new Chart(humidityCtx, {
    type: 'line',
    data: {
      labels: [timeNow()],
      datasets: [{
        label: 'Humidity (%)',
        data: [getRandom(60, 80)],
        borderColor: '#06d6a0',
        backgroundColor: 'rgba(6, 214, 160, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: { responsive: true }
  });
}

function updateEnvironmentCharts() {
  const now = new Date();
  const timeNow = now.toLocaleTimeString('th-TH', { hour12: false });

  // üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô
  if (now.getDate() !== currentDay) {
    currentDay = now.getDate();     // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
    resetEnvironmentCharts();       // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏≤‡∏ü
  }

  const co2Val = getRandom(440, 520);
  const tempVal = getRandom(24, 30);
  const humidVal = getRandom(60, 80);

  function update(chart, value) {
    chart.data.labels.push(timeNow);
    chart.data.datasets[0].data.push(value);
    chart.update();
  }

  update(co2Chart, co2Val);
  update(tempChart, tempVal);
  update(humidityChart, humidVal);
}

function resetEnvironmentCharts() {
  co2Chart.data.labels = [];
  co2Chart.data.datasets[0].data = [];
  co2Chart.update();

  tempChart.data.labels = [];
  tempChart.data.datasets[0].data = [];
  tempChart.update();

  humidityChart.data.labels = [];
  humidityChart.data.datasets[0].data = [];
  humidityChart.update();
}

function getRandom(min, max) {
  return +(Math.random() * (max - min) + min).toFixed(1);
}
// ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå index.html
// ‚úÖ [‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô popup tray inventory ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
function showTrayInfoPopup({ trayId, username, veg, floor, slot, timestamp, age, harvestDate, batchNumber, planNotes, seedingDate, plantCount }) {
  const existingPopup = document.getElementById("trayInfoPopup");
  if (existingPopup) {
    existingPopup.remove();
  }

  const contentHTML = `
    <div class="popup-header-premium">
      <i class="fas fa-boxes"></i>
      <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î</h3>
    </div>
    <div class="info-list">
      <div class="info-item">
        <span class="info-label"><i class="fas fa-tag"></i> Tray ID</span>
        <span class="info-value highlight">${trayId || 'N/A'}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-leaf"></i> ‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</span>
        <span class="info-value">${veg}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-map-marker-alt"></i> ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
        <span class="info-value">‡∏ä‡∏±‡πâ‡∏ô ${floor}, ‡∏ä‡πà‡∏≠‡∏á ${slot}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-barcode"></i> Batch ID</span>
        <span class="info-value">${batchNumber}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-calendar-alt"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞</span>
        <span class="info-value">${seedingDate}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-calendar-plus"></i> ‡∏ß‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</span>
        <span class="info-value">${timestamp}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-calendar-check"></i> ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</span>
        <span class="info-value">${harvestDate}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-hourglass-half"></i> ‡∏≠‡∏≤‡∏¢‡∏∏‡∏ñ‡∏≤‡∏î</span>
        <span class="info-value">${age}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-seedling"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô</span>
        <span class="info-value">${plantCount || 0} ‡∏ï‡πâ‡∏ô</span>
      </div>
       <div class="info-item">
        <span class="info-label"><i class="fas fa-sticky-note"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</span>
        <span class="info-value">${planNotes || '-'}</span>
      </div>
      <div class="info-item">
        <span class="info-label"><i class="fas fa-user-circle"></i> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
        <span class="info-value">${username || 'N/A'}</span>
      </div>
    </div>
    <div class="close-button-wrapper">
      <button class="close-button" onclick="closeTrayInfoPopup()">
        <i class="fas fa-times"></i> ‡∏õ‡∏¥‡∏î
      </button>
    </div>
  `;

  const popupBackdrop = document.createElement('div');
  popupBackdrop.id = 'trayInfoPopup';
  popupBackdrop.className = 'tray-popup-backdrop';

  const popupCard = document.createElement('div');
  popupCard.className = 'tray-popup-card';
  popupCard.innerHTML = contentHTML;

  popupBackdrop.appendChild(popupCard);
  popupBackdrop.addEventListener('click', function(event) {
      if (event.target === popupBackdrop) {
          closeTrayInfoPopup();
      }
  });
  document.body.appendChild(popupBackdrop);
}

function closeTrayInfoPopup() {
  const popupBackdrop = document.getElementById("trayInfoPopup");
  if (popupBackdrop) {
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° animation ‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î
    popupBackdrop.classList.add('closing');
    popupBackdrop.querySelector('.tray-popup-card').classList.add('closing');

    // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö Element ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DOM ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ animation ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏ö
    setTimeout(() => {
      if (popupBackdrop) {
          popupBackdrop.remove();
      }
    }, 300); // ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö animation-duration ‡πÉ‡∏ô CSS
  }
}






function showTrayPopup(message) {
  const popup = document.getElementById('trayPopup');
  popup.textContent = message || "‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  popup.style.display = 'block';

  setTimeout(() => {
    popup.style.display = 'none';
  }, 5000); // 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
}





function showLiftToast(message) {
  const toast = document.getElementById("liftToast");
  const msg = document.getElementById("liftToastMessage");
  if (!toast || !msg) return;

  msg.textContent = message;
  toast.style.display = "block";

  setTimeout(() => {
    toast.style.display = "none";
  }, 4000);
}






function onStationChange() {
  const select = document.getElementById("stationSelect");
  const selected = parseInt(select.value);
  if (!isNaN(selected)) {
    currentStation = selected;
  } else {
    currentStation = 1; // fallback ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ dropdown ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î
  }
  showPage(currentPage); // ‚úÖ reload ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°
}




function loadOverviewCharts(stationId) {
  fetch(`/api/overview?station=${stationId}`)
    .then(res => res.json())
    .then(data => {
      renderPie(data.total);
      renderBar(data.daily);
      renderHourly(data.hourly);
    });
}
// ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ currentPage ‡πÄ‡∏õ‡πá‡∏ô logCurrentPage
let userLogs = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• log ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å backend
let logCurrentPage = 1;
const logsPerPage = 10;

// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î log ‡∏à‡∏≤‡∏Å backend
async function fetchUserLogs() {
  try {
    const res = await fetch("/api/logs"); // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ token ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ

    if (res.ok) {
      userLogs = await res.json();
      renderUserLogs(); // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    } else {
      console.error("‚ùå API logs response error:", res.status, res.statusText);
      showNotification("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Log ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", 'error');
    }
  } catch (error) {
    console.error("‚ùå Fetch logs error:", error);
    showNotification("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠", 'error');
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á action_type ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
function translateActionType(actionType) {
  const translations = {
    // ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
    'login': '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
    'logout': '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
    
    // ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏î
    'tray_place': '‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤',
    'tray_remove': '‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å',
    'tray_move': '‡∏¢‡πâ‡∏≤‡∏¢‡∏ñ‡∏≤‡∏î',
    'inbound': '‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤',
    'outbound': '‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å',
    'harvest': '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß',
    
    // ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü
    'light_on': '‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü',
    'light_off': '‡∏õ‡∏¥‡∏î‡πÑ‡∏ü',
    'light_control': '‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏ü',
    'light_adjust': '‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÑ‡∏ü',
    'manual_control': '‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á',
    
    // ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥
    'water_fill': '‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥',
    'water_drain': '‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥',
    'water_check': '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡πâ‡∏≥',
    'water_control': '‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ô‡πâ‡∏≥',
    
    // ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
    'fan_on': '‡πÄ‡∏õ‡∏¥‡∏î‡∏û‡∏±‡∏î‡∏•‡∏°',
    'fan_off': '‡∏õ‡∏¥‡∏î‡∏û‡∏±‡∏î‡∏•‡∏°',
    'fan_control': '‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏û‡∏±‡∏î‡∏•‡∏°',
    'ventilation': '‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®',
    
    // ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤
    'check': '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
    'maintenance': '‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤',
    'calibration': '‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö',
    'inspection': '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û',
    
    // ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
    'schedule_set': '‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤',
    'schedule_clear': '‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤',
    'schedule_batch': '‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
    'system_config': '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö',
    
    // ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° AGV ‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
    'agv_command': '‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô AGV',
    'agv_move': '‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà AGV',
    'lift_up': '‡∏¢‡∏Å‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Ç‡∏∂‡πâ‡∏ô',
    'lift_down': '‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏•‡∏á',
    'tray_up': '‡∏¢‡∏Å‡∏ñ‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô',
    'tray_down': '‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡∏•‡∏á',
    
    // ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    'edit': '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
    'update': '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
    'delete': '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
    'create': '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
  };
  
  return translations[actionType] || actionType || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó';
}
// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
function mapCategory(log) {
  const act = (log.activity || "").toLowerCase();
  const cat = (log.category || "").toLowerCase();
  const actionType = (log.action_type || "").toLowerCase();

  // Check by category first
  if (cat.includes("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö") || cat.includes("login")) return "login";
  if (cat.includes("‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤") || cat.includes("inbound") || cat.includes("‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î")) return "inbound";
  if (cat.includes("‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å") || cat.includes("outbound") || cat.includes("‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å")) return "outbound";
  if (cat.includes("‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥") || cat.includes("water") || cat.includes("‡∏ô‡πâ‡∏≥")) return "water";
  if (cat.includes("‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü") || cat.includes("light") || cat.includes("‡πÑ‡∏ü") || cat.includes("led")) return "light";
  if (cat.includes("‡∏•‡∏¥‡∏ü‡∏ï‡πå") || cat.includes("lift")) return "lift";
  if (cat.includes("rgv") || cat.includes("‡∏£‡∏ñ")) return "rgv";
  if (cat.includes("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ") || cat.includes("user")) return "user";

  // Check by action_type (‡πÑ‡∏ü‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏¥‡∏ü‡∏ï‡πå)
  if (actionType.includes("login") || actionType.includes("logout")) return "login";
  if (actionType.includes("inbound") || actionType.includes("tray_place")) return "inbound";
  if (actionType.includes("outbound") || actionType.includes("tray_remove") || actionType.includes("harvest")) return "outbound";
  if (actionType.includes("water") || actionType.includes("‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥")) return "water";
  if (actionType.includes("light") || actionType.includes("‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü") || actionType.includes("‡∏õ‡∏¥‡∏î‡πÑ‡∏ü") || actionType.includes("‡πÑ‡∏ü") || actionType.includes("led") || actionType.includes("light-white") || actionType.includes("light-red")) return "light";
  if (actionType.includes("lift") || actionType.includes("‡∏•‡∏¥‡∏ü‡∏ï‡πå") || actionType.includes("elevator")) return "lift";
  if (actionType.includes("rgv") || actionType.includes("‡∏£‡∏ñ")) return "rgv";

  // Check by activity (‡πÑ‡∏ü‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏¥‡∏ü‡∏ï‡πå)
  if (act.includes("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö") || act.includes("login")) return "login";
  if (act.includes("‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤") || act.includes("‡∏ß‡∏≤‡∏á") || act.includes("inbound")) return "inbound";
  if (act.includes("‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å") || act.includes("‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß") || act.includes("outbound")) return "outbound";
  if (act.includes("‡∏ô‡πâ‡∏≥") || act.includes("‡πÄ‡∏ï‡∏¥‡∏°") || act.includes("water")) return "water";
  if (act.includes("‡πÑ‡∏ü") || act.includes("light") || act.includes("led") || act.includes("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πâ‡∏ô") || act.includes("light-white") || act.includes("light-red")) return "light";
  if (act.includes("‡∏•‡∏¥‡∏ü‡∏ï‡πå") || act.includes("lift") || act.includes("‡∏¢‡∏Å") || act.includes("‡∏•‡∏á") || act.includes("elevator")) return "lift";
  if (act.includes("rgv") || act.includes("‡∏£‡∏ñ") || act.includes("‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà")) return "rgv";
  if (act.includes("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ") || act.includes("user")) return "user";
  
  return "system";
}



// üîß ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô goToLogPage ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
function goToLogPage(page) {
    if (page < 1) return;
    
    logCurrentPage = page;
    renderUserLogs(); // ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
    
    // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π logs ‡πÉ‡∏´‡∏°‡πà
    document.getElementById("logCardsContainer").scrollIntoView({
        behavior: 'smooth',
        block: 'start'
    });
}
// ‚úÖ Enhanced renderUserLogs ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö premium design
function renderUserLogs() {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ userLogs ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!userLogs || userLogs.length === 0) {
        return;
    }

    const container = document.getElementById("logCardsContainer");
    const searchInput = document.getElementById("logSearchInput");
    const categoryFilter = document.getElementById("logCategoryFilter");
    const timeRangeFilter = document.getElementById("timeRangeFilter");
    const pagination = document.getElementById("pagination");
    const logsPerPage = 12; // ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö design ‡πÉ‡∏´‡∏°‡πà
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï stats
    updateLogStats();

    if (!container || !searchInput || !categoryFilter || !pagination) {
        console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö elements ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ logs - ‡∏≠‡∏≤‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏à");
        return;
    }
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const query = searchInput.value.toLowerCase();
    const selectedCategory = selectedCategoryValue.trim();
    const selectedTimeRange = timeRangeFilter ? timeRangeFilter.value.trim() : '';

    const filtered = userLogs.filter(log => {
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
        const categoryMatch = !selectedCategory || mapCategory(log) === selectedCategory;
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        const searchMatch = !query || (
            (log.username?.toLowerCase().includes(query)) ||
            (log.activity?.toLowerCase().includes(query)) ||
            (log.timestamp && new Date(log.timestamp).toLocaleString().toLowerCase().includes(query))
        );
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
        let timeMatch = true;
        if (selectedTimeRange && log.timestamp) {
            const logDate = new Date(log.timestamp);
            const today = new Date();
            
            switch(selectedTimeRange) {
                case 'today':
                    timeMatch = logDate.toDateString() === today.toDateString();
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    timeMatch = logDate.toDateString() === yesterday.toDateString();
                    break;
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    timeMatch = logDate >= weekAgo;
                    break;
                case 'month':
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    timeMatch = logDate >= monthAgo;
                    break;
            }
        }
        
        return categoryMatch && searchMatch && timeMatch;
    });

    const totalPages = Math.ceil(filtered.length / logsPerPage);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    if (logCurrentPage > totalPages && totalPages > 0) {
        logCurrentPage = totalPages;
    }
    
    const start = (logCurrentPage - 1) * logsPerPage;
    const pageLogs = filtered.slice(start, start + logsPerPage);
    
    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå container
    container.innerHTML = "";

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="bg-white rounded-3xl shadow-lg border border-gray-200 p-16 text-center">
                <div class="w-32 h-32 bg-gradient-to-br from-blue-100 to-blue-200 rounded-full flex items-center justify-center mx-auto mb-8">
                    <i class="fas fa-search text-5xl text-blue-400"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</h3>
                <p class="text-gray-600 text-lg mb-8 max-w-md mx-auto leading-relaxed">
                    ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤<br>
                    ‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà
                </p>
                <button onclick="clearAllFilters()" 
                    class="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl font-semibold">
                    <i class="fas fa-refresh"></i>
                    ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
        `;
        pagination.innerHTML = "";
        return;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á premium log cards
    if (pageLogs.length === 0) {
        container.innerHTML = `
            <div class="bg-white rounded-3xl shadow-lg border border-gray-200 p-16 text-center">
                <div class="w-32 h-32 bg-gradient-to-br from-amber-100 to-amber-200 rounded-full flex items-center justify-center mx-auto mb-8">
                    <i class="fas fa-exclamation-triangle text-5xl text-amber-400"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</h3>
                <p class="text-gray-600 text-lg leading-relaxed">
                    ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                </p>
            </div>
        `;
    } else {
        container.innerHTML = pageLogs.map((log, index) => {
            // ‡∏´‡∏≤ index ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô userLogs array
            const realIndex = userLogs.findIndex(originalLog => 
                originalLog.timestamp === log.timestamp && 
                originalLog.activity === log.activity && 
                originalLog.username === log.username
            );
            return createPremiumLogCard(log, realIndex);
        }).join('');
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á premium pagination
    pagination.innerHTML = createPremiumPagination(logCurrentPage, totalPages, filtered.length);
}

// ‚ú® Helper Functions for Modern Logs
function getCategoryClass(category) {
    const mapping = {
        '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö': 'login',
        '‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤': 'tray',
        '‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å': 'tray', 
        '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏î': 'tray',
        '‡∏•‡∏¥‡∏ü‡∏ï‡πå': 'lift',
        'AGV': 'agv',
        '‡∏ô‡πâ‡∏≥': 'water',
        '‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥': 'water',
        '‡πÑ‡∏ü': 'light',
        '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü': 'light'
    };
    return mapping[category] || 'tray';
}

function getCategoryIcon(category) {
    const mapping = {
        '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö': 'fas fa-sign-in-alt',
        '‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤': 'fas fa-arrow-down',
        '‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å': 'fas fa-arrow-up',
        '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏î': 'fas fa-boxes',
        '‡∏•‡∏¥‡∏ü‡∏ï‡πå': 'fas fa-elevator',
        'AGV': 'fas fa-robot',
        '‡∏ô‡πâ‡∏≥': 'fas fa-tint',
        '‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥': 'fas fa-tint',
        '‡πÑ‡∏ü': 'fas fa-lightbulb',
        '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü': 'fas fa-lightbulb'
    };
    return mapping[category] || 'fas fa-box';
}

function getCategoryIconBg(category) {
    const mapping = {
        '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö': 'linear-gradient(135deg, #3b82f6, #1d4ed8)',
        '‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤': 'linear-gradient(135deg, #10b981, #059669)',
        '‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å': 'linear-gradient(135deg, #10b981, #059669)',
        '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏î': 'linear-gradient(135deg, #10b981, #059669)',
        '‡∏•‡∏¥‡∏ü‡∏ï‡πå': 'linear-gradient(135deg, #f59e0b, #d97706)',
        'AGV': 'linear-gradient(135deg, #8b5cf6, #7c3aed)',
        '‡∏ô‡πâ‡∏≥': 'linear-gradient(135deg, #06b6d4, #0891b2)',
        '‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥': 'linear-gradient(135deg, #06b6d4, #0891b2)',
        '‡πÑ‡∏ü': 'linear-gradient(135deg, #f97316, #ea580c)',
        '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü': 'linear-gradient(135deg, #f97316, #ea580c)'
    };
    return mapping[category] || 'linear-gradient(135deg, #6b7280, #4b5563)';
}

function formatLogTime(timestamp) {
    if (!timestamp) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
    if (minutes < 60) return `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
    if (hours < 24) return `${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
    if (days < 7) return `${days} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
    
    return date.toLocaleDateString('th-TH', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showLogDetail(log) {
    const modal = document.getElementById('logDetailModal');
    const body = document.getElementById('logDetailBody');
    
    const category = mapCategory(log);
    const icon = getCategoryIcon(category);
    
    body.innerHTML = `
        <!-- ‚ú® User Profile Section -->
        <div style="
            display: flex; 
            align-items: center; 
            gap: 1.5rem; 
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
        ">
            <div style="
                width: 70px; 
                height: 70px; 
                background: ${getCategoryIconBg(category)}; 
                border-radius: 20px; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                color: white;
                box-shadow: 0 8px 32px rgba(0,0,0,0.15);
                position: relative;
                overflow: hidden;
            ">
                <i class="${icon}" style="font-size: 2rem; z-index: 1;"></i>
                <div style="
                    position: absolute;
                    top: -50%;
                    left: -50%;
                    width: 200%;
                    height: 200%;
                    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
                    animation: iconShine 2s ease-in-out infinite;
                "></div>
            </div>
            <div style="flex: 1;">
                <h4 style="
                    margin: 0 0 0.5rem 0; 
                    color: #1f2937; 
                    font-size: 1.25rem;
                    font-weight: 700;
                ">${log.username || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"}</h4>
                <div style="
                    display: inline-flex;
                    align-items: center;
                    gap: 0.5rem;
                    padding: 0.5rem 1rem;
                    background: ${getCategoryIconBg(category)};
                    color: white;
                    border-radius: 8px;
                    font-size: 0.875rem;
                    font-weight: 600;
                ">
                    <i class="${icon}" style="font-size: 0.875rem;"></i>
                    ${category}
                </div>
            </div>
            <div style="text-align: right; color: #64748b;">
                <div style="font-size: 0.75rem; opacity: 0.8;">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
                <div style="font-weight: 600; color: #374151;">${formatLogTime(log.timestamp)}</div>
            </div>
        </div>
        
        <!-- ‚ú® Activity Description -->
        <div style="
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-left: 4px solid #f59e0b;
            border-radius: 12px; 
            padding: 1.5rem; 
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(245,158,11,0.1);
        ">
            <h5 style="
                margin: 0 0 0.75rem 0; 
                color: #92400e;
                font-size: 1rem;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            ">
                <i class="fas fa-clipboard-list"></i>
                ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥
            </h5>
            <p style="
                margin: 0; 
                color: #78350f;
                font-size: 1rem;
                line-height: 1.6;
                font-weight: 500;
            ">${log.activity || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"}</p>
        </div>
        
        <!-- ‚ú® Details Grid -->
        <div style="
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 1.5rem;
        ">
            <div style="
                background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
                padding: 1.25rem;
                border-radius: 12px;
                border: 1px solid #bae6fd;
                transition: all 0.3s ease;
            ">
                <div style="
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    margin-bottom: 0.5rem;
                ">
                    <i class="fas fa-clock" style="color: #0ea5e9;"></i>
                    <strong style="color: #0c4a6e;">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡πá‡∏°</strong>
                </div>
                <span style="color: #075985; font-weight: 500;">${log.timestamp ? new Date(log.timestamp).toLocaleString('th-TH') : "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}</span>
            </div>
            
            <div style="
                background: linear-gradient(135deg, #f0fdf4, #dcfce7);
                padding: 1.25rem;
                border-radius: 12px;
                border: 1px solid #bbf7d0;
            ">
                <div style="
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    margin-bottom: 0.5rem;
                ">
                    <i class="fas fa-server" style="color: #16a34a;"></i>
                    <strong style="color: #14532d;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</strong>
                </div>
                <span style="color: #15803d; font-weight: 500;">${log.station || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}</span>
            </div>
            
            <div style="
                background: linear-gradient(135deg, #fef7ff, #fae8ff);
                padding: 1.25rem;
                border-radius: 12px;
                border: 1px solid #e9d5ff;
            ">
                <div style="
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    margin-bottom: 0.5rem;
                ">
                    <i class="fas fa-layer-group" style="color: #a855f7;"></i>
                    <strong style="color: #581c87;">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</strong>
                </div>
                <span style="color: #7c2d12; font-weight: 500;">‡∏ä‡∏±‡πâ‡∏ô ${log.floor ?? "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"} / ‡∏ä‡πà‡∏≠‡∏á ${log.slot ?? "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}</span>
            </div>
            
            <div style="
                background: linear-gradient(135deg, #fff7ed, #fed7aa);
                padding: 1.25rem;
                border-radius: 12px;
                border: 1px solid #fdba74;
            ">
                <div style="
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    margin-bottom: 0.5rem;
                ">
                    <i class="fas fa-seedling" style="color: #ea580c;"></i>
                    <strong style="color: #9a3412;">‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</strong>
                </div>
                <span style="color: #c2410c; font-weight: 500;">${log.veg_type || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}</span>
            </div>
            
            <div style="
                background: linear-gradient(135deg, #f8fafc, #e2e8f0);
                padding: 1.25rem;
                border-radius: 12px;
                border: 1px solid #cbd5e1;
                grid-column: 1 / -1;
            ">
                <div style="
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    margin-bottom: 0.5rem;
                ">
                    <i class="fas fa-sticky-note" style="color: #64748b;"></i>
                    <strong style="color: #334155;">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</strong>
                </div>
                <span style="color: #475569; font-weight: 500;">${log.description || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"}</span>
            </div>
        </div>
    `;
    
    modal.style.display = 'flex';
}

function closeLogModal() {
    document.getElementById('logDetailModal').style.display = 'none';
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('logDetailModal');
    if (e.target === modal) {
        closeLogModal();
    }
});
// ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Event Listeners ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ pagination ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ
function setupLogsEventListeners() {
    const searchInput = document.getElementById("logSearchInput");
    const categoryFilter = document.getElementById("logCategoryFilter");
    const timeRangeFilter = document.getElementById("timeRangeFilter");
    
    if (searchInput) {
        // ‡πÉ‡∏ä‡πâ debounce ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ö‡πà‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
        let searchTimeout;
        searchInput.addEventListener("input", () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                logCurrentPage = 1; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                renderUserLogs();
            }, 300);
        });
    }
    
    if (categoryFilter) {
        categoryFilter.addEventListener("change", () => {
            logCurrentPage = 1; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
            renderUserLogs();
        });
    }
    
    if (timeRangeFilter) {
        timeRangeFilter.addEventListener("change", () => {
            logCurrentPage = 1; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
            renderUserLogs();
        });
    }
}

// ‚úÖ Enhanced functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö premium design

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï stats numbers
function updateLogStats() {
    if (!userLogs || userLogs.length === 0) return;
    
    const totalUsers = new Set(userLogs.map(log => log.username)).size;
    const totalLogs = userLogs.length;
    const today = new Date().toDateString();
    const todayLogs = userLogs.filter(log => 
        new Date(log.timestamp).toDateString() === today
    ).length;
    
    const totalUsersEl = document.getElementById('totalUsers');
    const totalLogsEl = document.getElementById('totalLogs');
    const todayLogsEl = document.getElementById('todayLogs');
    
    if (totalUsersEl) totalUsersEl.textContent = totalUsers;
    if (totalLogsEl) totalLogsEl.textContent = totalLogs;
    if (todayLogsEl) todayLogsEl.textContent = todayLogs;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô toggle advanced filters
function toggleAdvancedFilters() {
    const content = document.getElementById('filtersContent');
    const toggle = document.querySelector('.filter-toggle i');
    
    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        toggle.style.transform = 'rotate(180deg)';
    } else {
        content.classList.add('collapsed');
        toggle.style.transform = 'rotate(0deg)';
    }
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á log card ‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö premium
function createPremiumLogCard(log, index) {
    const category = mapCategory(log);
    const icon = getLogIcon(category);
    const timestamp = formatLogTime(log.timestamp);
    const fullTimestamp = new Date(log.timestamp).toLocaleString('th-TH', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    
    // Define category colors for Tailwind
    const categoryColors = {
        'login': 'from-blue-500 to-blue-600',
        'inbound': 'from-emerald-500 to-emerald-600',
        'outbound': 'from-purple-500 to-purple-600',
        'water': 'from-cyan-500 to-cyan-600',
        'light': 'from-amber-500 to-amber-600',
        'lift': 'from-orange-500 to-orange-600',
        'rgv': 'from-indigo-500 to-indigo-600',
        'system': 'from-gray-500 to-gray-600',
        'user': 'from-red-500 to-red-600'
    };
    
    const categoryBgColors = {
        'login': 'from-blue-50 to-blue-100',
        'inbound': 'from-emerald-50 to-emerald-100',
        'outbound': 'from-purple-50 to-purple-100',
        'water': 'from-cyan-50 to-cyan-100',
        'light': 'from-amber-50 to-amber-100',
        'lift': 'from-orange-50 to-orange-100',
        'rgv': 'from-indigo-50 to-indigo-100',
        'system': 'from-gray-50 to-gray-100',
        'user': 'from-red-50 to-red-100'
    };

    const categoryTextColors = {
        'login': 'text-blue-700',
        'inbound': 'text-emerald-700',
        'outbound': 'text-purple-700',
        'water': 'text-cyan-700',
        'light': 'text-amber-700',
        'lift': 'text-orange-700',
        'rgv': 'text-indigo-700',
        'system': 'text-gray-700',
        'user': 'text-red-700'
    };
    
    const gradientColor = categoryColors[category] || 'from-gray-500 to-gray-600';
    const bgGradient = categoryBgColors[category] || 'from-gray-50 to-gray-100';
    const textColor = categoryTextColors[category] || 'text-gray-700';
    
    return `
        <div class="group bg-white rounded-3xl shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 border border-gray-200 overflow-hidden cursor-pointer animate-fade-in"
             onclick="showLogDetails(${index})">
            
            <!-- Clean Card Content -->
            <div class="p-8">
                <div class="flex items-start justify-between">
                    <div class="flex items-start gap-6 flex-1">
                        <!-- Clean Icon -->
                        <div class="relative flex-shrink-0">
                            <div class="w-16 h-16 bg-gradient-to-br ${gradientColor} rounded-2xl flex items-center justify-center shadow-lg group-hover:scale-105 transition-transform duration-300">
                                <i class="${icon} text-white text-2xl"></i>
                            </div>
                            <div class="absolute -top-2 -right-2 w-6 h-6 bg-green-400 rounded-full border-3 border-white flex items-center justify-center">
                                <div class="w-2 h-2 bg-white rounded-full"></div>
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-3 mb-3">
                                <h4 class="font-bold text-gray-800 text-xl">
                                    ${log.username || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}
                                </h4>
                                <span class="inline-flex items-center px-3 py-1 bg-gradient-to-r ${bgGradient} rounded-full text-xs font-medium ${textColor}">
                                    ${category}
                                </span>
                            </div>
                            
                            <p class="text-gray-700 text-lg leading-relaxed mb-4">
                                ${log.activity || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'}
                            </p>
                            
                            <!-- Meta Info -->
                            <div class="flex items-center gap-6 text-sm text-gray-500">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-clock"></i>
                                    <span>${timestamp}</span>
                                </div>
                                ${log.station ? `
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${log.station}</span>
                                </div>` : ''}
                                ${log.floor && log.slot ? `
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-layer-group"></i>
                                    <span>‡∏ä‡∏±‡πâ‡∏ô ${log.floor} ‡∏ä‡πà‡∏≠‡∏á ${log.slot}</span>
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Arrow -->
                    <div class="flex-shrink-0 ml-4">
                        <div class="w-10 h-10 bg-gray-50 rounded-xl flex items-center justify-center group-hover:bg-blue-50 transition-colors duration-300">
                            <i class="fas fa-chevron-right text-gray-400 group-hover:text-blue-600 group-hover:translate-x-1 transition-all duration-300"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Subtle Footer -->
            <div class="px-8 py-4 bg-gradient-to-r from-gray-50 to-blue-50 border-t border-gray-100">
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2 text-gray-600">
                        <i class="fas fa-info-circle"></i>
                        <span>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
                    </div>
                    <div class="text-xs text-gray-500" title="${fullTimestamp}">
                        ${fullTimestamp}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (Premium Icons)
function getLogIcon(category) {
    const icons = {
        'login': 'fas fa-key',
        'inbound': 'fas fa-arrow-down',
        'outbound': 'fas fa-arrow-up',
        'water': 'fas fa-tint',
        'light': 'fas fa-lightbulb',
        'lift': 'fas fa-arrow-up-wide-short',
        'rgv': 'fas fa-truck-moving',
        'system': 'fas fa-chart-line',
        'user': 'fas fa-user'
    };
    return icons[category] || 'fas fa-info-circle';
}

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô dropdown
let selectedCategoryValue = '';

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î custom dropdown
function toggleCategoryDropdown() {
    const dropdown = document.getElementById('logCategoryFilter');
    const menu = document.getElementById('categoryDropdownMenu');
    
    dropdown.classList.toggle('active');
    
    if (menu.classList.contains('hidden')) {
        // ‡πÄ‡∏õ‡∏¥‡∏î dropdown - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        const rect = dropdown.getBoundingClientRect();
        menu.style.top = (rect.bottom + window.scrollY + 8) + 'px';
        menu.style.left = rect.left + 'px';
        menu.style.width = rect.width + 'px';
        menu.classList.remove('hidden');
        
        // ‡∏õ‡∏¥‡∏î dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠ scroll
        document.addEventListener('click', closeCategoryDropdown);
        window.addEventListener('scroll', closeCategoryDropdown);
        window.addEventListener('resize', closeCategoryDropdown);
    } else {
        // ‡∏õ‡∏¥‡∏î dropdown
        menu.classList.add('hidden');
        document.removeEventListener('click', closeCategoryDropdown);
        window.removeEventListener('scroll', closeCategoryDropdown);
        window.removeEventListener('resize', closeCategoryDropdown);
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
function closeCategoryDropdown(event) {
    const wrapper = document.querySelector('.custom-dropdown-wrapper');
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£ scroll ‡∏´‡∏£‡∏∑‡∏≠ resize ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
    if (!event || event.type === 'scroll' || event.type === 'resize' || !wrapper.contains(event.target)) {
        const dropdown = document.getElementById('logCategoryFilter');
        const menu = document.getElementById('categoryDropdownMenu');
        
        dropdown.classList.remove('active');
        menu.classList.add('hidden');
        document.removeEventListener('click', closeCategoryDropdown);
        window.removeEventListener('scroll', closeCategoryDropdown);
        window.removeEventListener('resize', closeCategoryDropdown);
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
function selectCategory(value, iconClass, text) {
    const dropdown = document.getElementById('logCategoryFilter');
    const menu = document.getElementById('categoryDropdownMenu');
    const iconElement = dropdown.querySelector('.premium-icon');
    const textElement = dropdown.querySelector('.selected-text');
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    selectedCategoryValue = value;
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI
    iconElement.className = iconClass + ' premium-icon';
    textElement.textContent = text;
    
    // ‡∏õ‡∏¥‡∏î dropdown
    dropdown.classList.remove('active');
    menu.classList.add('hidden');
    document.removeEventListener('click', closeCategoryDropdown);
    window.removeEventListener('scroll', closeCategoryDropdown);
    window.removeEventListener('resize', closeCategoryDropdown);
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ filter
    renderUserLogs();
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö categoryFilter.value ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ selectedCategoryValue
Object.defineProperty(HTMLElement.prototype, 'categoryFilterValue', {
    get: function() {
        if (this.id === 'logCategoryFilter') {
            return selectedCategoryValue;
        }
        return this.value;
    },
    set: function(val) {
        if (this.id === 'logCategoryFilter') {
            selectedCategoryValue = val;
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï UI ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            if (val === '') {
                const iconElement = this.querySelector('.premium-icon');
                const textElement = this.querySelector('.selected-text');
                iconElement.className = 'fas fa-layer-group premium-icon';
                textElement.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            }
        } else {
            this.value = val;
        }
    }
});

// ‡∏™‡∏£‡πâ‡∏≤‡∏á premium pagination ‡∏î‡πâ‡∏ß‡∏¢ Tailwind CSS
function createPremiumPagination(currentPage, totalPages, totalItems) {
    if (totalPages <= 1) return '';
    
    const startItem = ((currentPage - 1) * 12) + 1;
    const endItem = Math.min(currentPage * 12, totalItems);
    
    let pagination = `
        <div class="bg-white rounded-3xl shadow-lg border border-gray-200 p-8">
            <!-- Info Section -->
            <div class="text-center mb-6">
                <p class="text-gray-600 text-lg">
                    ‡πÅ‡∏™‡∏î‡∏á <span class="font-bold text-blue-600">${startItem}-${endItem}</span> ‡∏à‡∏≤‡∏Å <span class="font-bold text-blue-600">${totalItems}</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </p>
            </div>
            
            <!-- Pagination Buttons -->
            <div class="flex items-center justify-center gap-3">
    `;
    
    // Previous button
    const prevDisabled = currentPage === 1;
    pagination += `
        <button onclick="goToLogPage(${currentPage - 1})" 
                ${prevDisabled ? 'disabled' : ''}
                class="flex items-center justify-center w-12 h-12 rounded-2xl transition-all duration-300 ${
                    prevDisabled 
                        ? 'bg-gray-100 text-gray-400 cursor-not-allowed' 
                        : 'bg-gradient-to-r from-gray-500 to-gray-600 text-white hover:from-gray-600 hover:to-gray-700 transform hover:scale-105 shadow-lg hover:shadow-xl'
                }">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        pagination += `
            <button onclick="goToLogPage(1)" 
                class="flex items-center justify-center w-12 h-12 rounded-2xl bg-white border border-gray-200 text-gray-700 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-600 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg font-semibold">
                1
            </button>
        `;
        if (startPage > 2) {
            pagination += `<span class="text-gray-400 px-3 font-medium">‚ãØ</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const isActive = i === currentPage;
        pagination += `
            <button onclick="goToLogPage(${i})" 
                class="flex items-center justify-center w-12 h-12 rounded-2xl font-bold transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg ${
                    isActive 
                        ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg' 
                        : 'bg-white border border-gray-200 text-gray-700 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-600'
                }">
                ${i}
            </button>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            pagination += `<span class="text-gray-400 px-3 font-medium">‚ãØ</span>`;
        }
        pagination += `
            <button onclick="goToLogPage(${totalPages})" 
                class="flex items-center justify-center w-12 h-12 rounded-2xl bg-white border border-gray-200 text-gray-700 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-600 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg font-semibold">
                ${totalPages}
            </button>
        `;
    }
    
    // Next button
    const nextDisabled = currentPage === totalPages;
    pagination += `
        <button onclick="goToLogPage(${currentPage + 1})" 
                ${nextDisabled ? 'disabled' : ''}
                class="flex items-center justify-center w-12 h-12 rounded-2xl transition-all duration-300 ${
                    nextDisabled 
                        ? 'bg-gray-100 text-gray-400 cursor-not-allowed' 
                        : 'bg-gradient-to-r from-gray-500 to-gray-600 text-white hover:from-gray-600 hover:to-gray-700 transform hover:scale-105 shadow-lg hover:shadow-xl'
                }">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    pagination += `
            </div>
        </div>
    `;
    return pagination;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function clearAllFilters() {
    const searchInput = document.getElementById("logSearchInput");
    const categoryFilter = document.getElementById("logCategoryFilter");
    const timeRangeFilter = document.getElementById("timeRangeFilter");
    
    if (searchInput) searchInput.value = "";
    if (categoryFilter) {
        selectedCategoryValue = "";
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï UI
        const iconElement = categoryFilter.querySelector('.premium-icon');
        const textElement = categoryFilter.querySelector('.selected-text');
        if (iconElement) iconElement.className = 'fas fa-layer-group premium-icon';
        if (textElement) textElement.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    }
    if (timeRangeFilter) timeRangeFilter.value = "";
    
    logCurrentPage = 1;
    renderUserLogs();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
function goToLogPage(page) {
    logCurrentPage = page;
    renderUserLogs();
    
    // Scroll ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á container
    const container = document.getElementById("logCardsContainer");
    if (container) {
        container.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö toggle filters
function toggleAdvancedFilters() {
    const filtersContent = document.getElementById("filtersContent");
    const toggleIcon = document.getElementById("filterToggleIcon");
    
    if (filtersContent && toggleIcon) {
        const isHidden = filtersContent.style.display === 'none';
        filtersContent.style.display = isHidden ? 'block' : 'none';
        toggleIcon.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(180deg)';
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î modal
function closeLogModal() {
    const modal = document.getElementById('logDetailModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// ‡πÅ‡∏™‡∏î‡∏á loading spinner ‡∏î‡πâ‡∏ß‡∏¢ Tailwind CSS
function showLoadingSpinner() {
    const container = document.getElementById("logCardsContainer");
    if (container) {
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center py-20">
                <div class="relative">
                    <div class="w-16 h-16 border-4 border-blue-200 rounded-full animate-spin border-t-blue-600"></div>
                    <div class="absolute inset-0 w-16 h-16 border-4 border-transparent rounded-full animate-ping border-t-blue-400"></div>
                </div>
                <div class="mt-6 text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                    <p class="text-gray-500 text-sm">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
                </div>
            </div>
        `;
    }
}

// ‡∏ã‡πà‡∏≠‡∏ô loading spinner
function hideLoadingSpinner() {
    const loading = document.querySelector('.timeline-loading');
    if (loading) {
        loading.remove();
    }
}

// ‡πÅ‡∏™‡∏î‡∏á log details ‡πÉ‡∏ô premium modal
function showLogDetails(logIndex) {
    const log = userLogs[logIndex];
    if (!log) return;
    
    const modal = document.getElementById('logDetailModal');
    const body = document.getElementById('logDetailBody');
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    const categoryThai = {
        'login': '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
        'inbound': '‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤',
        'outbound': '‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å',
        'water': '‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥',
        'light': '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü',
        'lift': '‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏¥‡∏ü‡∏ï‡πå',
        'rgv': '‡∏£‡∏ñ RGV',
        'system': '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
        'user': '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'
    };
    
    const category = mapCategory(log);
    const categoryText = categoryThai[category] || '‡∏£‡∏∞‡∏ö‡∏ö';
    const icon = getLogIcon(category);
    
    // Define category colors for modal
    const categoryColors = {
        'login': 'from-blue-500 to-blue-600',
        'inbound': 'from-emerald-500 to-emerald-600',
        'outbound': 'from-purple-500 to-purple-600',
        'water': 'from-cyan-500 to-cyan-600',
        'light': 'from-amber-500 to-amber-600',
        'lift': 'from-orange-500 to-orange-600',
        'rgv': 'from-indigo-500 to-indigo-600',
        'system': 'from-gray-500 to-gray-600',
        'user': 'from-red-500 to-red-600'
    };
    
    const gradientColor = categoryColors[category] || 'from-gray-500 to-gray-600';
    
    body.innerHTML = `
        <div class="space-y-8">
            <!-- User Profile Section -->
            <div class="relative">
                <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-gray-100">
                    <div class="bg-gradient-to-r ${gradientColor} p-6">
                        <div class="flex items-center gap-6">
                            <div class="relative">
                                <div class="w-20 h-20 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center">
                                    <i class="${icon} text-white text-3xl"></i>
                                </div>
                                <div class="absolute -bottom-2 -right-2 w-8 h-8 bg-green-400 rounded-full border-4 border-white flex items-center justify-center">
                                    <i class="fas fa-check text-white text-sm"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-3xl font-bold text-white mb-2">
                                    ${log.username || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}
                                </h4>
                                <div class="flex items-center gap-3">
                                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-white/20 backdrop-blur-sm text-white rounded-full text-sm font-medium">
                                        <i class="${icon}"></i>
                                        <span>${categoryText}</span>
                                    </div>
                                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-white/20 backdrop-blur-sm text-white rounded-full text-sm">
                                        <i class="fas fa-clock"></i>
                                        <span>${formatLogTime(log.timestamp)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Activity Card -->
            <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-gray-100">
                <div class="p-8">
                    <div class="flex items-start gap-4 mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center">
                            <i class="fas fa-bolt text-white text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <h5 class="text-xl font-bold text-gray-800 mb-2">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h5>
                            <p class="text-gray-600 text-lg leading-relaxed">${log.activity || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</p>
                        </div>
                    </div>
                    
                    <!-- Timeline -->
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-calendar-alt text-white"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                                <p class="text-lg font-bold text-gray-800">${new Date(log.timestamp).toLocaleString('th-TH', {
                                    year: 'numeric',
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit'
                                })}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Details Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-4">
                    <div class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 hover:shadow-lg transition-shadow duration-300">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-tag text-white"></i>
                            </div>
                            <h6 class="font-semibold text-gray-800">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</h6>
                        </div>
                        <p class="text-gray-700 font-medium text-lg">${translateActionType(log.action_type)}</p>
                    </div>

                    ${log.station ? `
                    <div class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 hover:shadow-lg transition-shadow duration-300">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-map-marker-alt text-white"></i>
                            </div>
                            <h6 class="font-semibold text-gray-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</h6>
                        </div>
                        <p class="text-gray-700 font-medium text-lg">${log.station}</p>
                    </div>` : ''}

                    ${log.veg_type ? `
                    <div class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 hover:shadow-lg transition-shadow duration-300">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-leaf text-white"></i>
                            </div>
                            <h6 class="font-semibold text-gray-800">‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</h6>
                        </div>
                        <p class="text-gray-700 font-medium text-lg">${log.veg_type}</p>
                    </div>` : ''}
                </div>

                <!-- Right Column -->
                <div class="space-y-4">
                    ${log.floor ? `
                    <div class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 hover:shadow-lg transition-shadow duration-300">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-layer-group text-white"></i>
                            </div>
                            <h6 class="font-semibold text-gray-800">‡∏ä‡∏±‡πâ‡∏ô</h6>
                        </div>
                        <p class="text-gray-700 font-medium text-lg">‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà ${log.floor}</p>
                    </div>` : ''}

                    ${log.slot ? `
                    <div class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 hover:shadow-lg transition-shadow duration-300">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-th-large text-white"></i>
                            </div>
                            <h6 class="font-semibold text-gray-800">‡∏ä‡πà‡∏≠‡∏á</h6>
                        </div>
                        <p class="text-gray-700 font-medium text-lg">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${log.slot}</p>
                    </div>` : ''}
                </div>
            </div>

            <!-- Description Section -->
            ${log.description ? `
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="bg-gradient-to-r from-gray-50 to-blue-50 p-6 border-b border-gray-100">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-gray-600 to-gray-700 rounded-2xl flex items-center justify-center">
                            <i class="fas fa-info-circle text-white text-xl"></i>
                        </div>
                        <div>
                            <h6 class="text-xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h6>
                            <p class="text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <p class="text-gray-700 leading-relaxed text-lg">${log.description}</p>
                </div>
            </div>` : ''}
        </div>
    `;
    
    // Update modal timestamp
    const modalTimestamp = document.getElementById('modalTimestamp');
    if (modalTimestamp) {
        modalTimestamp.textContent = `‡∏î‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${new Date().toLocaleTimeString('th-TH')}`;
    }
    
    modal.classList.remove('hidden');
}

// ‡∏õ‡∏¥‡∏î premium modal
function closeLogModal() {
    const modal = document.getElementById('logDetailModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ logs
function initUserLogsPage() {
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ loading
    showLoadingSpinner();
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    fetchUserLogs().then(() => {
        hideLoadingSpinner();
        setupLogsEventListeners();
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏° filter ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö collapsed
        setTimeout(() => {
            const content = document.getElementById('filtersContent');
            if (content) {
                content.classList.add('collapsed');
            }
        }, 100);
    });
}
function toggleDetails(button) {
  const detailsDiv = button.nextElementSibling;
  if (detailsDiv.style.display === "none") {
    detailsDiv.style.display = "block";
    button.innerText = "‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î";
  } else {
    detailsDiv.style.display = "none";
    button.innerText = "‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î";
  }
}



// ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
if (typeof userLogs === 'undefined' || userLogs.length === 0) {
    fetchUserLogs();
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á log ‡πÅ‡∏ö‡∏ö‡πÉ‡∏ä‡πâ username (frontend ‚Üí /api/log)
function logAction(username, activity, action_type, category, station = "", floor = "", slot = "", veg_type = "", description = "") {
    if (!username) {
        username = localStorage.getItem("username");
    }
    if (!username) return; // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏´‡∏≤ username ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠

    fetch("/api/log", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, activity, action_type, category, station, floor, slot, veg_type, description })
    })
    .then(res => {
        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        if (!res.ok) {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î Error ‡πÉ‡∏´‡πâ‡πÇ‡∏¢‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà .catch
            return res.json().then(errData => { throw new Error(errData.error || 'Server responded with an error'); });
        }
        return res.json();
    })
    .then(data => {
    })
    .catch(err => {
        // .catch ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î Error ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        console.error("‚ùå logAction error:", err.message);
    });
}
// ‚ú® Open Export Logs Modal
function openExportLogsModal() {
  // Set default dates (last 7 days)
  const today = new Date();
  const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
  
  document.getElementById('exportStartDate').value = weekAgo.toISOString().split('T')[0];
  document.getElementById('exportEndDate').value = today.toISOString().split('T')[0];
  
  // Update preview
  updateExportPreview();
  
  // Show modal
  document.getElementById('exportLogsModal').style.display = 'flex';
  
  // Add event listeners for date changes
  document.getElementById('exportStartDate').addEventListener('change', updateExportPreview);
  document.getElementById('exportEndDate').addEventListener('change', updateExportPreview);
  
  // Add event listeners for all filter checkboxes
  const filterIds = [
    'typeLogin', 'typeLogout', 'typeInbound', 'typeOutbound', 
    'typeManualControl', 'typeHarvest', 'typeSystem', 'typeOther',
    'includeAllUsers', 'includeAdminOnly', 'includeUserOnly'
  ];
  
  filterIds.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('change', updateExportPreview);
    }
  });
}

// ‚ú® Close Export Logs Modal
function closeExportLogsModal() {
  document.getElementById('exportLogsModal').style.display = 'none';
}

// ‚ú® Update Export Preview
function updateExportPreview() {
  const startDate = document.getElementById('exportStartDate').value;
  const endDate = document.getElementById('exportEndDate').value;
  const startTime = document.getElementById('exportStartTime').value;
  const endTime = document.getElementById('exportEndTime').value;
  
  if (startDate && endDate) {
    const start = new Date(`${startDate}T${startTime}`);
    const end = new Date(`${endDate}T${endTime}`);
    
    if (userLogs && userLogs.length > 0) {
      const filteredLogs = getFilteredLogs(userLogs, start, end);
      
      document.getElementById('exportPreviewText').textContent = 
        `‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${filteredLogs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏à‡∏≤‡∏Å ${start.toLocaleDateString('th-TH')} ‡∏ñ‡∏∂‡∏á ${end.toLocaleDateString('th-TH')}`;
    } else {
      document.getElementById('exportPreviewText').textContent = 
        `‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${start.toLocaleDateString('th-TH')} ‡∏ñ‡∏∂‡∏á ${end.toLocaleDateString('th-TH')}`;
    }
  }
}

// ‚ú® Get Filtered Logs by Date and Type
function getFilteredLogs(logs, startDate, endDate) {
  return logs.filter(log => {
    // Date filter
    const logDate = new Date(log.timestamp);
    if (logDate < startDate || logDate > endDate) return false;
    
    // Type filters
    const typeFilters = {
      'login': document.getElementById('typeLogin').checked,
      'logout': document.getElementById('typeLogout').checked,
      'inbound': document.getElementById('typeInbound').checked,
      'outbound': document.getElementById('typeOutbound').checked,
      'manual_control': document.getElementById('typeManualControl').checked,
      'harvest': document.getElementById('typeHarvest').checked,
      'system': document.getElementById('typeSystem').checked
    };
    
    // Check if log type matches selected filters
    const logType = log.type || 'other';
    if (typeFilters[logType] !== undefined) {
      if (!typeFilters[logType]) return false;
    } else {
      // For other/unknown types
      if (!document.getElementById('typeOther').checked) return false;
    }
    
    // User role filters
    const includeAllUsers = document.getElementById('includeAllUsers').checked;
    const includeAdminOnly = document.getElementById('includeAdminOnly').checked;
    const includeUserOnly = document.getElementById('includeUserOnly').checked;
    
    if (!includeAllUsers) {
      const userRole = log.role || 'user';
      if (includeAdminOnly && userRole !== 'admin') return false;
      if (includeUserOnly && userRole === 'admin') return false;
    }
    
    return true;
  });
}

// ‚ú® Execute Export with Date Filter
function executeExportLogs() {
  const startDate = document.getElementById('exportStartDate').value;
  const endDate = document.getElementById('exportEndDate').value;
  const startTime = document.getElementById('exportStartTime').value;
  const endTime = document.getElementById('exportEndTime').value;
  
  if (!startDate || !endDate) {
    showNotification("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î", 'warning');
    return;
  }
  
  const start = new Date(`${startDate}T${startTime}`);
  const end = new Date(`${endDate}T${endTime}`);
  
  if (start > end) {
    showNotification("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î", 'warning');
    return;
  }
  
  closeExportLogsModal();
  exportLogsToExcelWithLogo(start, end);
}

// ‚ú® Updated Export Function with Advanced Filters
function exportLogsToExcelWithLogo(startDate = null, endDate = null) {
  if (!userLogs || userLogs.length === 0) {
    showNotification("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å", 'warning');
    return;
  }
  
  // Filter logs with all criteria
  let filteredLogs = userLogs;
  if (startDate && endDate) {
    filteredLogs = getFilteredLogs(userLogs, startDate, endDate);
    
    if (filteredLogs.length === 0) {
      showNotification("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", 'warning');
      return;
    }
  }

  const exportData = filteredLogs.map((log, index) => [
    index + 1,
    new Date(log.timestamp).toLocaleString('th-TH', { hour12: false }),
    log.username,
    log.role || "-",
    log.activity,
    log.type,
    log.floor || "-",
    log.slot || "-",
    log.veg_type || "-",
    log.station || "-"
  ]);

  const headers = [
    "‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡πÄ‡∏ß‡∏•‡∏≤", "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", "‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó", "‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó",
    "‡∏ä‡∏±‡πâ‡∏ô", "‡∏ä‡πà‡∏≠‡∏á", "‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ"
  ];

  XlsxPopulate.fromBlankAsync().then(workbook => {
    const sheet = workbook.sheet(0).name("User Logs");

    // ‚úÖ ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢
    sheet.cell("A1").value("AGROTECH WMS").style({
      bold: true,
      fontSize: 18,
      fontColor: "2d6a4f"
    });

    // ‚úÖ ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    headers.forEach((header, i) => {
      sheet.cell(3, i + 1).value(header).style({
        bold: true,
        fill: "2d6a4f",
        fontColor: "ffffff",
        horizontalAlignment: "center"
      });
      sheet.column(i + 1).width(16);
    });

    // ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    exportData.forEach((row, r) => {
      row.forEach((val, c) => {
        sheet.cell(r + 4, c + 1).value(val);
      });
    });

    // ‚úÖ ‚úÖ ‚úÖ FIX: ‡πÉ‡∏ä‡πâ .range().autoFilter() ‡πÅ‡∏ó‡∏ô
    sheet.range("A3:J3").autoFilter();

    // ‚úÖ freeze row
    sheet.freezePanes(4, 1);

    return workbook.outputAsync();
  }).then(blob => {
    // ‡πÉ‡∏ä‡πâ data URL ‡πÅ‡∏ó‡∏ô blob URL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á HTTP warning
    const reader = new FileReader();
    const a = document.createElement("a");
    // Generate filename with date range
    let filename = 'user_logs';
    if (startDate && endDate) {
      const startStr = startDate.toISOString().split('T')[0];
      const endStr = endDate.toISOString().split('T')[0];
      filename = `user_logs_${startStr}_to_${endStr}`;
    } else {
      filename = `user_logs_${new Date().toISOString().split('T')[0]}`;
    }
    
    reader.onload = function() {
      // ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á URL
      const link = document.createElement('a');
      link.href = reader.result;
      link.download = `${filename}.xlsx`;
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô DOM ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      document.body.appendChild(link);
      link.click();
      
      // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DOM ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á click
      setTimeout(() => {
        document.body.removeChild(link);
      }, 100);
    };
    
    reader.readAsDataURL(blob);
  }).catch(err => {
    console.error("‚ùå Export Error:", err);
    showNotification("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel", 'error');
  });
}








function calculateTrayAge(time_in_string) {
  if (!time_in_string) return "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
  
  const startTime = new Date(time_in_string);
  const now = new Date();
  let diff = (now.getTime() - startTime.getTime()) / 1000; // ‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

  const days = Math.floor(diff / (24 * 3600));
  diff -= days * 24 * 3600;
  const hours = Math.floor(diff / 3600);
  diff -= hours * 3600;
  const minutes = Math.floor(diff / 60);

  let age = "";
  if (days > 0) age += `${days} ‡∏ß‡∏±‡∏ô `;
  if (hours > 0) age += `${hours} ‡∏ä‡∏°. `;
  age += `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
  
  return age;
}


function showTrayDetails(floor, slot) {
  const key = `${floor}-${slot}`;
  const info = trayInventory[key];

  if (!info) {
    showNotification(`‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ\n‡∏ä‡∏±‡πâ‡∏ô ${floor}, ‡∏ä‡πà‡∏≠‡∏á ${slot}`, 'warning');
    return;
  }

  const veg = info.veg_type || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";          // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ veg_type
  const timeText = info.time_in
    ? new Date(info.time_in).toLocaleString("th-TH") // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ time_in
    : "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ß‡∏•‡∏≤";

  let ageStr = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡πÑ‡∏î‡πâ";
  if (info.time_in) {
    const placed = new Date(info.time_in);
    const now = new Date();
    const diff = now - placed;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    ageStr = days > 0 ? `${days} ‡∏ß‡∏±‡∏ô ${hours} ‡∏ä‡∏°.` : `${hours} ‡∏ä‡∏°.`;
  }

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• batch_id
  const batchText = info.batch_id || 'N/A';
  
  showNotification(`üîç ‡∏ñ‡∏≤‡∏î: ${veg}\nBatch ID: ${batchText}\n‡∏ä‡∏±‡πâ‡∏ô ${floor}, ‡∏ä‡πà‡∏≠‡∏á ${slot}\n‡∏ß‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${timeText}\n‡∏≠‡∏≤‡∏¢‡∏∏: ${ageStr}`, 'info');
}


// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
function loadRealPlanMock(page = 1) {
  currentPage = page;
  const today = new Date().toISOString().split("T")[0];
  const tbody = document.getElementById("realPlanTableBody");
  tbody.innerHTML = "";

  const start = (page - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const displayTrays = trays.slice(start, end);

  displayTrays.forEach(tray => {
    const isDue = tray.harvest_date <= today;
 const statusHTML = isDue
  ? `<span class="status status-due blink"><i class="fas fa-bell"></i> ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</span>`
  : `<span class="status status-growing"><i class="fas fa-leaf"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</span>`;

    const actionHTML = `
      <div class="action-buttons">
        <button onclick="sendRefill(${tray.floor}, ${tray.slot})">‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥</button>
        <button onclick="toggleWater(${tray.floor}, ${tray.slot})">‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</button>
      </div>
    `;

    const row = document.createElement("tr");
    row.className = isDue ? "harvest-due" : "";
    row.innerHTML = `
      <td>${tray.veg_type}</td>
      <td>‡∏ä‡∏±‡πâ‡∏ô ${tray.floor}</td>
      <td>‡∏ä‡πà‡∏≠‡∏á ${tray.slot}</td>
      <td>${tray.start_date}</td>
      <td>${tray.harvest_date}</td>
      <td>${statusHTML}</td>
      <td>${actionHTML}</td>
    `;
    tbody.appendChild(row);
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô)
const historyRow = document.createElement('tr');
historyRow.className = 'history-row';
historyRow.id = `history-${tray.tray_id}`;
historyRow.style.display = 'none';
historyRow.innerHTML = `<td colspan="10"></td>`; // Colspan ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
tbody.appendChild(historyRow);
  });

  renderPagination();
}

// ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ñ‡∏≤‡∏î (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏≤‡∏¢‡∏∏)
async function toggleTrayHistory(trayId, button) {
    const historyRow = document.getElementById(`history-${trayId}`);
    const historyCell = historyRow.querySelector('td');

    const isVisible = historyRow.style.display !== 'none';

    if (isVisible) {
        historyRow.style.display = 'none';
        button.innerText = '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥';
        button.style.backgroundColor = '#64748b';
        return;
    }

    historyRow.style.display = 'table-row';
    button.innerText = '‡πÇ‡∏´‡∏•‡∏î...';
    button.disabled = true;
    historyCell.innerHTML = '<p style="text-align:center; padding: 10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</p>';

    try {
        const response = await fetch(`/api/tray/history/${trayId}`);
        const historyData = await response.json();
        
        button.innerText = '‡∏ã‡πà‡∏≠‡∏ô';
        button.style.backgroundColor = '#1f2937';
        button.disabled = false;

        if (!historyData || historyData.length === 0) {
            historyCell.innerHTML = '<p style="text-align:center; font-weight: 500; padding: 10px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ñ‡∏≤‡∏î‡∏ô‡∏µ‡πâ</p>';
            return;
        }

        let historyHtml = `
            <table class="history-table">
                <thead>
                    <tr>
                        <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                        <th>‡∏≠‡∏≤‡∏¢‡∏∏‡∏ñ‡∏≤‡∏î (‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</th>
                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô</th>
                        <th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
                        <th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                    </tr>
                </thead>
                <tbody>
        `;

        historyData.forEach(log => {
            const actionClass = log.action_type === 'inbound' ? 'action-inbound' : 'action-outbound';
            const actionText = log.action_type === 'inbound' ? '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å';
            
            // --- [‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á] ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏ñ‡∏≤‡∏î ---
            let ageDisplay = '-';
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 'inbound' ‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏
            if (log.action_type !== 'inbound' && log.birth_time && log.created_at) {
    const actionTime = new Date(log.created_at);
    const birthTime = new Date(log.birth_time); // <-- ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ log.birth_time
    const diffMs = actionTime.getTime() - birthTime.getTime();
    
    if (diffMs >= 0) {
        const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diffMs / (1000 * 60 * 60)) % 24);
        ageDisplay = `${days} ‡∏ß‡∏±‡∏ô ${hours} ‡∏ä‡∏°.`;
    }
}

            historyHtml += `
                <tr>
                    <td>${log.timestamp_th}</td>
                    <td class="${actionClass}">${actionText}</td>
                    <td>‡∏ä‡∏±‡πâ‡∏ô ${log.floor} / ‡∏ä‡πà‡∏≠‡∏á ${log.slot}</td>
                    <td>${ageDisplay}</td>
                    <td>${log.plant_quantity || '-'}</td>
                    <td>${log.reason || '-'}</td>
                    <td>${log.username || '-'}</td>
                </tr>
            `;
        });

        historyHtml += '</tbody></table>';
        historyCell.innerHTML = historyHtml;

    } catch (error) {
        console.error('Failed to load tray history:', error);
        historyCell.innerHTML = '<p style="text-align:center; color: red; padding: 10px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>';
        button.innerText = '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
        button.disabled = false;
    }
}




// ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
function renderPagination() {
  const totalPages = Math.ceil(trays.length / rowsPerPage);
  const pagination = document.getElementById("plantingPagination");
  pagination.innerHTML = "";

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.className = i === currentPage ? "active" : "";
    btn.onclick = () => loadRealPlanMock(i);
    pagination.appendChild(btn);
  }
}

// ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (mock)
function sendRefill(floor, slot) {
  showNotification(`üíß ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà ‡∏ä‡∏±‡πâ‡∏ô ${floor} / ‡∏ä‡πà‡∏≠‡∏á ${slot}`, 'success');
}

function toggleWater(floor, slot) {
  showNotification(`‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏ó‡∏µ‡πà ‡∏ä‡∏±‡πâ‡∏ô ${floor} / ‡∏ä‡πà‡∏≠‡∏á ${slot}`, 'success');
}



async function loadTaskMonitor() {
  try {
    const response = await fetch('/api/task-monitor');
    const tasks = await response.json();
    renderTaskTable(tasks);
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    const now = new Date();
    const timeStr = now.toLocaleTimeString('th-TH', { 
      hour: '2-digit', 
      minute: '2-digit', 
      second: '2-digit' 
    });
    const lastUpdateElement = document.getElementById('lastUpdateTime');
    if (lastUpdateElement) {
      lastUpdateElement.textContent = timeStr;
    }
  } catch (err) {
    console.error('‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Task Monitor ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', err);
  }
}
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô index.html
function renderTaskTable(tasks) {
  const tbody = document.getElementById("taskTableBody");
  tbody.innerHTML = "";

  // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
  const statusCount = {
    pending: 0,
    working: 0,
    success: 0,
    at_workstation: 0,
    error: 0
  };

  tasks.forEach((task, index) => {
    const tr = document.createElement("tr");
    tr.style.animationDelay = `${index * 0.1}s`;
    tr.classList.add('fade-in-row');

    // ‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    statusCount[task.status] = (statusCount[task.status] || 0) + 1;

    const statusClass = `status-enhanced ${task.status}`;
    const endTime = task.completed_at ? formatDate(task.completed_at) : '-';
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° badge ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô
    const actionBadge = task.action_type === 'inbound' ? 
      '<span class="action-badge inbound"><i class="fas fa-arrow-down"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</span>' :
      '<span class="action-badge outbound"><i class="fas fa-arrow-up"></i> ‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å</span>';

    tr.innerHTML = `
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="flex items-center">
          <div class="bg-indigo-100 text-indigo-800 text-xs font-medium px-3 py-1 rounded-full">
            ${task.tray_id}
          </div>
        </div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-800">
          <i class="fas fa-layer-group mr-1"></i>‡∏ä‡∏±‡πâ‡∏ô ${task.floor || '-'}
        </span>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-blue-100 text-blue-800">
          <i class="fas fa-grip-vertical mr-1"></i>‡∏ä‡πà‡∏≠‡∏á ${task.slot || '-'}
        </span>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${getStatusBadgeClass(task.status)}">
          ${getStatusIcon(task.status)} ${convertStatusLabel(task.status)}
        </span>
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-thai">
        ${formatDate(task.created_at)}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-thai">
        ${endTime}
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${task.action_type === 'inbound' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
          <i class="fas ${task.action_type === 'inbound' ? 'fa-arrow-down' : 'fa-arrow-up'} mr-1"></i>
          ${task.action_type === 'inbound' ? '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å'}
        </span>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="flex items-center">
          <div class="flex-shrink-0 h-8 w-8">
            <div class="h-8 w-8 rounded-full bg-purple-100 flex items-center justify-center">
              <i class="fas fa-user-circle text-purple-600"></i>
            </div>
          </div>
          <div class="ml-3">
            <p class="text-sm font-medium text-gray-900 font-thai">${task.username || '-'}</p>
          </div>
        </div>
      </td>
    `;

    tbody.appendChild(tr);
  });

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
  updateTaskStats(statusCount);
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° function ‡πÉ‡∏´‡∏°‡πà
function updateTaskStats(statusCount) {
  document.getElementById('pendingCount').textContent = statusCount.pending || 0;
  document.getElementById('workingCount').textContent = statusCount.working || 0;
  document.getElementById('successCount').textContent = statusCount.success || 0;
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dashboard Cards ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
async function updateDashboardCards() {
  try {
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å APIs ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö tab counts
    const promises = [
      fetch('/api/planting-plans?status=received').then(res => res.json()),
      fetch('/api/tray-inventory/planting-progress').then(res => res.json()),
      fetch('/api/planting-plans').then(res => res.json())
    ];
    
    const [pendingResult, inProgressResult, allPlansResult] = await Promise.all(promises);
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
    const pendingCount = (pendingResult.success && pendingResult.planting_plans) ? pendingResult.planting_plans.length : 0;
    const workingCount = Array.isArray(inProgressResult) ? inProgressResult.length : 0;
    const totalCount = (allPlansResult.success && allPlansResult.planting_plans) ? allPlansResult.planting_plans.length : 0;
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dashboard cards
    const elements = {
      pendingCount: document.getElementById('pendingCount'),
      workingCount: document.getElementById('workingCount'), 
      successCount: document.getElementById('successCount')
    };
    
    if (elements.pendingCount) elements.pendingCount.textContent = pendingCount;
    if (elements.workingCount) elements.workingCount.textContent = workingCount;
    if (elements.successCount) elements.successCount.textContent = totalCount;
    
    
  } catch (err) {
    console.error('‚ùå Error updating dashboard cards:', err);
  }
}
// ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå index.html (‡∏™‡πà‡∏ß‡∏ô <script>)

function convertStatusLabel(status) {
  if (status === 'pending') return '‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
  if (status === 'working') return 'üöö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
  if (status === 'at_workstation') return 'üì¶ ‡∏£‡∏≠‡∏ó‡∏µ‡πà Workstation'; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  if (status === 'success') return '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≤‡∏Å 'done' ‡πÄ‡∏õ‡πá‡∏ô 'success' ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend
  if (status === 'error') return '‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
  return status; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
}
function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleString("th-TH", { hour12: false });
}


//‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà
function loadTaskHistory() {
  const historyTasks = [
    {
      task_id: "T001",
      floor: 4,
      slot: 8,
      status: "success",
      start_time: "2025-05-21T08:15:00",
      end_time: "2025-05-21T08:16:30",
      type: "tray_inbound",
      username: "admin"
    },
    {
      task_id: "T004",
      floor: 2,
      slot: 5,
      status: "success",
      start_time: "2025-05-21T07:00:00",
      end_time: "2025-05-21T07:01:45",
      type: "agv_move",
      username: "staff02"
    }
  ];

  renderTaskHistoryTable(historyTasks);
}
function renderTaskHistoryTable(tasks) {
  const tbody = document.getElementById("taskHistoryTableBody");
  if (!tbody) {
    console.error('‚ùå Element taskHistoryTableBody not found!');
    return;
  }

  tbody.innerHTML = "";

  if (!tasks || tasks.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>';
    return;
  }

  tasks.forEach(task => {
    const tr = document.createElement("tr");
    tr.className = 'fade-in-row';

    const statusClass = `status-enhanced ${task.status}`;
    const endTime = task.completed_at ? new Date(task.completed_at).toLocaleString("th-TH") : '-';
    const actionBadge = task.action_type === 'inbound'
      ? '<span class="action-badge inbound"><i class="fas fa-arrow-down"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</span>'
      : '<span class="action-badge outbound"><i class="fas fa-arrow-up"></i> ‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å</span>';

    tr.innerHTML = `
      <td><strong>${task.tray_id}</strong></td>
      <td><span class="floor-badge">‡∏ä‡∏±‡πâ‡∏ô ${task.floor || '-'}</span></td>
      <td><span class="slot-badge">‡∏ä‡πà‡∏≠‡∏á ${task.slot || '-'}</span></td>
      <td><span class="${statusClass}">${convertStatusLabel(task.status)}</span></td>
      <td>${new Date(task.created_at).toLocaleString("th-TH")}</td>
      <td>${endTime}</td>
      <td>${actionBadge}</td>
      <td><span class="user-badge"><i class="fas fa-user-circle"></i> ${task.username || '-'}</span></td>
    `;
    tbody.appendChild(tr);
  });
}

// 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡∏Å Event Listener ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
function setupHistoryEventListeners() {
    const searchInput = document.getElementById('historySearch');
    const filterSelect = document.getElementById('historyFilter');

    if (searchInput) {
        searchInput.addEventListener('input', filterAndRenderHistory);
    }
    if (filterSelect) {
        filterSelect.addEventListener('change', filterAndRenderHistory);
    }
}



// ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡πâ‡∏°‡∏µ Error Handling
async function loadOverviewCharts() {
  try {
    const station = currentStation || 1;

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° error handling ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ API
    const [summaryRes, weeklyRes, hourlyRes] = await Promise.allSettled([
      fetch(`/api/stats/summary?station=${station}`),
      fetch(`/api/stats/weekly?station=${station}`),
      fetch(`/api/stats/hourly?station=${station}`)
    ]);

    // ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Pie Chart
    if (summaryRes.status === 'fulfilled' && summaryRes.value.ok) {
      const summary = await summaryRes.value.json();
      renderPieChart(summary);
    } else {
      console.warn('Summary API failed, using mock data');
      renderPieChart({ inbound: 15, outbound: 12 });
    }

    // ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Bar Chart
    if (weeklyRes.status === 'fulfilled' && weeklyRes.value.ok) {
      const weekly = await weeklyRes.value.json();
      renderBarChart(weekly);
    } else {
      console.warn('Weekly API failed, using mock data');
      const mockWeekly = generateMockWeeklyData();
      renderBarChart(mockWeekly);
    }

    // ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Hourly Chart
    if (hourlyRes.status === 'fulfilled' && hourlyRes.value.ok) {
      const hourly = await hourlyRes.value.json();
      renderHourlyChart(hourly);
    } else {
      console.warn('Hourly API failed, using mock data');
      const mockHourly = generateMockHourlyData();
      renderHourlyChart(mockHourly);
    }

  } catch (err) {
    console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• overview ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á
    renderPieChart({ inbound: 0, outbound: 0 });
    renderBarChart([]);
    renderHourlyChart([]);
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á
function generateMockWeeklyData() {
  const data = [];
  const labels = getLast7Days();
  
  labels.forEach(date => {
    data.push({
      date: date,
      inbound: Math.floor(Math.random() * 20) + 5,
      outbound: Math.floor(Math.random() * 15) + 3
    });
  });
  
  return data;
}

function generateMockHourlyData() {
  const data = [];
  
  for (let hour = 0; hour < 24; hour++) {
    data.push({
      hour: hour,
      inbound: Math.floor(Math.random() * 10),
      outbound: Math.floor(Math.random() * 8)
    });
  }
  
  return data;
}

function renderPieChart(data) {
  if (pieChartInstance) pieChartInstance.destroy();
  
  const ctx = document.getElementById('pieChart');
  if (!ctx) {
    console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö element pieChart');
    return;
  }
  
  pieChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Inbound (‡πÄ‡∏Ç‡πâ‡∏≤)', 'Outbound (‡∏≠‡∏≠‡∏Å)'],
      datasets: [{
        data: [data.inbound || 0, data.outbound || 0],
        backgroundColor: [
          'rgba(16, 185, 129, 0.8)', 
          'rgba(245, 158, 11, 0.8)'
        ],
        borderColor: [
          'rgba(255, 255, 255, 0.9)', 
          'rgba(255, 255, 255, 0.9)'
        ],
        borderWidth: 4, // üé® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
        cutout: '50%',  // üé® ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right', // ‚úÖ‚úÖ‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏°‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤
          align: 'center',   // ‚úÖ‚úÖ‚úÖ ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á
          labels: {
            padding: 25,     // üé® ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á
            font: {
              family: 'Prompt',
              size: 14,      // üé® ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ
              weight: '500'
            },
            usePointStyle: true,
            pointStyle: 'circle',
            boxWidth: 12,    // üé® ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏™‡∏µ
            boxHeight: 12,
            color: '#1f2937',
            generateLabels: function(chart) {
              const data = chart.data;
              if (data.labels.length && data.datasets.length) {
                return data.labels.map((label, i) => {
                  const value = data.datasets[0].data[i];
                  const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return {
                    text: `${label}: ${value} (${percentage}%)`,
                    fillStyle: data.datasets[0].backgroundColor[i],
                    strokeStyle: data.datasets[0].borderColor[i],
                    lineWidth: data.datasets[0].borderWidth,
                    hidden: false,
                    index: i
                  };
                });
              }
              return [];
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(17, 24, 39, 0.95)',
          titleColor: '#f9fafb',
          bodyColor: '#f3f4f6',
          borderColor: 'rgba(52, 183, 136, 0.5)',
          borderWidth: 2,
          cornerRadius: 12,
          padding: 12,
          titleFont: { family: 'Prompt', size: 14, weight: '600' },
          bodyFont: { family: 'Prompt', size: 13 },
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
              return `${context.label}: ${context.parsed} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (${percentage}%)`;
            }
          }
        }
      },
      layout: {
        padding: 20 // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö padding ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏£‡∏≠‡∏ö‡∏î‡πâ‡∏≤‡∏ô
      },
      animation: {
        duration: 1500,
        easing: 'easeInOutCubic'
      }
    }
  });
}
// ‚úÖ‚úÖ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚úÖ‚úÖ‚úÖ
async function loadOverviewCharts(stationId) {
  try {
    const station = currentStation || 1;

    const [summaryRes, weeklyRes, hourlyRes] = await Promise.all([
      fetch(`/api/stats/summary?station=${station}`),
      fetch(`/api/stats/weekly?station=${station}`),
      fetch(`/api/stats/hourly?station=${station}`)
    ]);

    const summary = await summaryRes.json();
    const weekly = await weeklyRes.json();
    const hourly = await hourlyRes.json();

    renderPieChart(summary);    // ‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    renderBarChart(weekly);     // ‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    renderHourlyChart(hourly);  // ‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  } catch (err) {
    console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• overview ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
  }
}
// ‚úÖ‚úÖ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ] ‚úÖ‚úÖ‚úÖ
function getLast7Days() {
  const days = [];
  const today = new Date();
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(today.getDate() - i);
    
    // --- ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
    // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 'DD/MM'
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0'); // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô JavaScript ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 0
    days.push(`${day}/${month}`);
  }
  
  return days;
}


function getHourlyLabels() {
  const hours = [];
  for (let i = 0; i < 24; i++) {
    const label = i.toString().padStart(2, '0') + ':00';
    hours.push(label);
  }
  return hours;
}


function renderHourlyChart(data) {
  if (hourlyChartInstance) hourlyChartInstance.destroy();

  const inboundMap = {};
  const outboundMap = {};

  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ data ‡πÄ‡∏õ‡πá‡∏ô array ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (!Array.isArray(data)) {
    console.warn('renderHourlyChart: data is not array, using empty array');
    data = [];
  }

  // ‚è± API ‡∏™‡πà‡∏á hour ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÄ‡∏ä‡πà‡∏ô 9, 10
  data.forEach(row => {
    const hourLabel = row.hour.toString().padStart(2, '0') + ':00';
    inboundMap[hourLabel] = row.inbound;
    outboundMap[hourLabel] = row.outbound;
  });

  const labels = getHourlyLabels(); // ['00:00', ..., '23:00']

  const inboundData = labels.map(h => inboundMap[h] || 0);
  const outboundData = labels.map(h => outboundMap[h] || 0);

  hourlyChartInstance = new Chart(document.getElementById('hourlyChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Inbound',
                    data: inboundData,
                    borderColor: '#40916c', // ‚úÖ ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°
                    backgroundColor: 'rgba(64, 145, 108, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Outbound',
                    data: outboundData,
                    borderColor: '#74c69d', // ‚úÖ ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏Å‡∏•‡∏≤‡∏á
                    backgroundColor: 'rgba(116, 198, 157, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function renderBarChart(data, type = 'weekly') {
  if (barChartInstance) {
    barChartInstance.destroy();
  }

  // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ element ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
  const ctx = document.getElementById('barChart')?.getContext('2d');
  if (!ctx) {
    console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö element barChart');
    return;
  }

  let labels, inboundData, outboundData;

  if (type === 'monthly') {
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü 30 ‡∏ß‡∏±‡∏ô
    labels = getLast30Days();
    const dataMap = new Map(data.map(item => [item.date, { inbound: item.inbound, outbound: item.outbound }]));
    inboundData = labels.map(date => dataMap.get(date)?.inbound || 0);
    outboundData = labels.map(date => dataMap.get(date)?.outbound || 0);
  } else {
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü 7 ‡∏ß‡∏±‡∏ô
    const dataMap = new Map(data.map(item => [item.date, { inbound: item.inbound, outbound: item.outbound }]));
    labels = getLast7Days();
    inboundData = labels.map(date => dataMap.get(date)?.inbound || 0);
    outboundData = labels.map(date => dataMap.get(date)?.outbound || 0);
  }

  // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
  barChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Inbound (‡πÄ‡∏Ç‡πâ‡∏≤)',
          data: inboundData,
          backgroundColor: 'rgba(16, 185, 129, 0.9)',
          borderColor: 'rgba(16, 185, 129, 1)',
          borderWidth: 0,
          borderRadius: 8,
          borderSkipped: false,
        },
        {
          label: 'Outbound (‡∏≠‡∏≠‡∏Å)',
          data: outboundData,
          backgroundColor: 'rgba(245, 158, 11, 0.9)',
          borderColor: 'rgba(245, 158, 11, 1)',
          borderWidth: 0,
          borderRadius: 8,
          borderSkipped: false,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: {
        legend: {
          position: 'top',
          labels: {
            usePointStyle: true,
            font: {
              family: 'Prompt',
              weight: '600'
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          titleColor: '#f8fafc',
          bodyColor: '#e2e8f0',
          borderColor: 'rgba(16, 185, 129, 0.3)',
          borderWidth: 1,
          cornerRadius: 12,
          titleFont: {
            family: 'Prompt',
            weight: '600'
          },
          bodyFont: {
            family: 'Prompt'
          }
        }
      },
      scales: {
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              family: 'Prompt'
            }
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(226, 232, 240, 0.5)',
            drawBorder: false
          },
          ticks: {
            font: {
              family: 'Prompt'
            }
          }
        }
      }
    }
  });
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
function getLast7Days() {
  const days = [];
  const today = new Date();
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(today.getDate() - i);
    
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    days.push(`${day}/${month}`);
  }
  
  return days;
}



function getLast30Days() {
  const days = [];
  const today = new Date();
  
  for (let i = 29; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(today.getDate() - i);
    
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    days.push(`${day}/${month}`);
  }
  
  return days;
}
// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Event Listeners
function setupOverviewEventListeners() {
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (currentPage !== 'overview') return;
    
    switch(e.key) {
      case 'r':
      case 'R':
        if (e.ctrlKey || e.metaKey) {
          e.preventDefault();
          refreshAllData();
        }
        break;
      case 'Escape':
        // ‡∏õ‡∏¥‡∏î tooltips ‡∏´‡∏£‡∏∑‡∏≠ modals
        document.querySelectorAll('.tooltip').forEach(el => {
          el.classList.remove('show');
        });
        break;
    }
  });

  // Click outside to close tooltips
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.tooltip')) {
      document.querySelectorAll('.tooltip').forEach(el => {
        el.classList.remove('show');
      });
    }
  });
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function refreshAllData() {
  showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...', 'info');
  showOverviewLoading();
  loadFullOverviewData(currentStation);
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö
function refreshSystemStatus() {
  showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö...', 'info');
  loadSystemStatus();
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
function refreshActivityFeed() {
  const feedContainer = document.getElementById('activityFeed');
  if (feedContainer) {
    feedContainer.innerHTML = `
      <div class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...</p>
      </div>
    `;
  }
  loadRecentActivity();
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°
function resetEnvironmentalData() {
  // ‡πÅ‡∏™‡∏î‡∏á loading ‡πÉ‡∏ô environmental cards
  ['tempValue', 'humidityValue', 'co2Value', 'lightValue'].forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
  });
  
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  setTimeout(() => {
    loadEnvironmentalData();
    showNotification('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success');
  }, 1000);
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Overview
function showOverviewSettings() {
  const settings = [
    '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ',
    '‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Real-time',
    '‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
    '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'
  ];
  
  const settingsText = settings.join('\n');
  showNotification(`‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:\n${settingsText}`, 'info');
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà confirm)
function showConfirmModal(message, onConfirm, onCancel = null) {
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á modal backdrop
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop';
  backdrop.id = 'confirmModal';
  
  backdrop.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-question-circle"></i>
          ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
        </h3>
      </div>
      <div style="padding: 1.5rem; font-size: 1.1rem; line-height: 1.6;">
        ${message}
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" onclick="closeConfirmModal(false)">
          <i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
        <button class="modal-btn primary" onclick="closeConfirmModal(true)">
          <i class="fas fa-check"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(backdrop);
  
  // ‡πÄ‡∏Å‡πá‡∏ö callback functions
  backdrop._onConfirm = onConfirm;
  backdrop._onCancel = onCancel;
  
  // ‡πÅ‡∏™‡∏î‡∏á modal
  setTimeout(() => backdrop.classList.add('show'), 100);
}

function closeConfirmModal(confirmed) {
  const modal = document.getElementById('confirmModal');
  if (modal) {
    if (confirmed && modal._onConfirm) {
      modal._onConfirm();
    } else if (!confirmed && modal._onCancel) {
      modal._onCancel();
    }
    
    modal.classList.remove('show');
    setTimeout(() => {
      if (modal.parentNode) {
        modal.parentNode.removeChild(modal);
      }
    }, 300);
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
function showNotification(message, type = 'info') {
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á notification element
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  
  const iconMap = {
    'success': 'fas fa-check-circle',
    'error': 'fas fa-exclamation-triangle',
    'warning': 'fas fa-exclamation-circle',
    'info': 'fas fa-info-circle'
  };
  
  notification.innerHTML = `
    <div style="display: flex; align-items: center; gap: 0.75rem;">
      <i class="${iconMap[type] || iconMap.info}"></i>
      <span style="white-space: pre-line;">${message}</span>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // ‡πÅ‡∏™‡∏î‡∏á notification
  setTimeout(() => notification.classList.add('show'), 100);
  
  // ‡∏ã‡πà‡∏≠‡∏ô notification ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 4 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 400);
  }, 4000);
}

// ‚úÖ Auto refresh ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏î‡∏¥‡∏°)
function startOverviewAutoRefresh() {
  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå interval ‡πÄ‡∏Å‡πà‡∏≤
  if (window.overviewRefreshInterval) {
    clearInterval(window.overviewRefreshInterval);
  }
  
  window.overviewRefreshInterval = setInterval(() => {
    if (currentPage === 'overview') {
      // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö)
      loadSummaryCards();
      loadUsersAndTasks();
      loadSystemStatus();
      loadRecentActivity();
      // Environmental data ‡∏°‡∏µ interval ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
    }
  }, 30000); // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  
}

// ‚úÖ ‡∏´‡∏¢‡∏∏‡∏î auto refresh ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ overview
function stopOverviewAutoRefresh() {
  if (window.overviewRefreshInterval) {
    clearInterval(window.overviewRefreshInterval);
    window.overviewRefreshInterval = null;
  }
  
  if (window.envUpdateInterval) {
    clearInterval(window.envUpdateInterval);
    window.envUpdateInterval = null;
  }
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô activeTimers ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ clearActiveTimers() ‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ
function addToActiveTimers() {
  if (window.overviewRefreshInterval) {
    activeTimers.add(window.overviewRefreshInterval);
  }
  if (window.envUpdateInterval) {
    activeTimers.add(window.envUpdateInterval);
  }
}



// ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderPie (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°)
function renderPieEnhanced(data) {
  if (pieChartInstance) {
    pieChartInstance.destroy();
  }

  const ctx = document.getElementById('pieChart').getContext('2d');
  pieChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Inbound (‡πÄ‡∏Ç‡πâ‡∏≤)', 'Outbound (‡∏≠‡∏≠‡∏Å)'],
      datasets: [{
        data: [data.inbound || 0, data.outbound || 0],
        backgroundColor: [
          'rgba(16, 185, 129, 0.8)',
          'rgba(245, 158, 11, 0.8)'
        ],
        borderColor: [
          'rgba(16, 185, 129, 1)',
          'rgba(245, 158, 11, 1)'
        ],
        borderWidth: 3,
        cutout: '60%',
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: {
        duration: 1500,
        easing: 'easeInOutCubic'
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            font: {
              family: 'Prompt',
              size: 12,
              weight: '600'
            },
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          titleColor: '#f8fafc',
          bodyColor: '#e2e8f0',
          borderColor: 'rgba(16, 185, 129, 0.3)',
          borderWidth: 1,
          cornerRadius: 12,
          titleFont: {
            family: 'Prompt',
            weight: '600'
          },
          bodyFont: {
            family: 'Prompt'
          },
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
              return `${context.label}: ${context.parsed} (${percentage}%)`;
            }
          }
        }
      },
      interaction: {
        intersect: false
      }
    }
  });
}

// ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderHourly ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
function renderHourlyEnhanced(data) {
  if (hourlyChartInstance) {
    hourlyChartInstance.destroy();
  }

  const labels = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
  const chartData = labels.map((_, hour) => {
    const hourData = data.find(item => item.hour === hour);
    return hourData ? hourData.total : Math.floor(Math.random() * 10); // Mock data ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
  });

  const ctx = document.getElementById('hourlyChart').getContext('2d');
  hourlyChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á',
        data: chartData,
        borderColor: 'rgba(59, 130, 246, 1)',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        fill: true,
        tension: 0.4,
        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
        pointBorderColor: '#ffffff',
        pointBorderWidth: 3,
        pointRadius: 5,
        pointHoverRadius: 8,
        borderWidth: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: {
        duration: 1200,
        easing: 'easeInOutCubic'
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          titleColor: '#f8fafc',
          bodyColor: '#e2e8f0',
          borderColor: 'rgba(59, 130, 246, 0.3)',
          borderWidth: 1,
          cornerRadius: 12,
          titleFont: {
            family: 'Prompt',
            weight: '600'
          },
          bodyFont: {
            family: 'Prompt'
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(226, 232, 240, 0.5)',
            drawBorder: false
          },
          ticks: {
            font: {
              family: 'Prompt',
              size: 11
            },
            color: '#64748b'
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              family: 'Prompt',
              size: 10
            },
            color: '#64748b',
            maxTicksLimit: 12
          }
        }
      },
      interaction: {
        intersect: false,
        mode: 'index'
      }
    }
  });
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
function checkConnectionStatus() {
  return navigator.onLine;
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå/‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå
function setupConnectionHandlers() {
  window.addEventListener('online', () => {
    showNotification('‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'success');
    if (currentPage === 'overview') {
      setTimeout(() => {
        loadFullOverviewData(currentStation);
      }, 1000);
    }
  });

  window.addEventListener('offline', () => {
    showNotification('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢', 'warning');
  });
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Performance Monitoring
function logPerformance(action, startTime) {
  const endTime = performance.now();
  const duration = endTime - startTime;
  
  // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  if (duration > 2000) {
    console.warn(`‚ö†Ô∏è Slow performance detected: ${action} took ${duration.toFixed(2)}ms`);
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Memory
function cleanupOverviewResources() {
  // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ Chart instances
  if (pieChartInstance) {
    pieChartInstance.destroy();
    pieChartInstance = null;
  }
  if (barChartInstance) {
    barChartInstance.destroy();
    barChartInstance = null;
  }
  if (hourlyChartInstance) {
    hourlyChartInstance.destroy();
    hourlyChartInstance = null;
  }
  
  // ‡∏•‡πâ‡∏≤‡∏á intervals
  stopOverviewAutoRefresh();
  
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ override showPage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ cleanup
const originalShowPage = window.showPage;
if (originalShowPage) {
  window.showPage = function(page, event) {
    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ overview ‡πÉ‡∏´‡πâ cleanup
    if (currentPage === 'overview' && page !== 'overview') {
      cleanupOverviewResources();
    }
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    return originalShowPage.call(this, page, event);
  };
}

// ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Connection Handlers ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î
if (typeof document !== 'undefined') {
  document.addEventListener('DOMContentLoaded', () => {
    setupConnectionHandlers();
  });
}

// ‚úÖ Export functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
window.overviewFunctions = {
  renderOverviewPage,
  initOverviewPage,
  loadFullOverviewData,
  switchTimeRange,
  refreshAllData,
  refreshSystemStatus,
  refreshActivityFeed,
  resetEnvironmentalData,
  showOverviewSettings,
  stopOverviewAutoRefresh,
  cleanupOverviewResources
};



// ‚úÖ Global State
let currentFloor = 1;
let liftAnimation = null;
let isEmergency = false;
let liftStatusTimer = null;
let currentUser = JSON.parse(localStorage.getItem("loggedInUser") || "{}");

// ‚úÖ Map ‡∏ä‡∏±‡πâ‡∏ô ‚Üí ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á %
const levelTop = {
  1: 70, 2: 60, 3: 50, 4: 39, 5: 30,
  6: 20, 7: 12, 8: 5, 9: -1
};

// ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå + ‡∏à‡∏∏‡∏î sensor
function updateLiftDisplay(floor) {
  const liftCart = document.getElementById("liftCart");
  if (!liftCart) return;

  animateLiftTo(levelTop[floor] ?? 60);

  const floorDisplay = document.getElementById("currentFloor");
  if (floorDisplay) floorDisplay.innerText = floor;

  for (let i = 1; i <= 9; i++) {
    const dot = document.querySelector(`#floor-${i} [data-light]`);
    if (dot) {
      dot.style.background = (i === floor) ? '#52b788' : '#ccc';
      dot.style.boxShadow = (i === floor) ? '0 0 8px #52b788' : 'none';
    }
  }
}

// ‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô lift ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•
function animateLiftTo(targetPercent) {
  const liftCart = document.getElementById("liftCart");
  if (!liftCart) return;

  cancelAnimationFrame(liftAnimation);
  let currentTop = parseFloat(liftCart.style.top?.replace('%', '')) || targetPercent;
  const duration = 800;
  const startTime = performance.now();

  function step(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 0.5 * (1 - Math.cos(Math.PI * progress));
    const newTop = currentTop + (targetPercent - currentTop) * eased;
    liftCart.style.top = `${newTop}%`;
    if (progress < 1) liftAnimation = requestAnimationFrame(step);
  }

  requestAnimationFrame(step);
}

// ‚úÖ ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡πà‡∏≤‡∏ô REST
async function moveLift() {
  const targetFloor = parseInt(document.getElementById("floorSelect").value);
  if (!targetFloor || isNaN(targetFloor)) {
    showNotification("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", 'warning');
    return;
  }

  try {
    const res = await fetch("/api/lift/move", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: currentUser.id,
        fromFloor: currentFloor,
        toFloor: targetFloor,
        station: currentStation
      })
    });

    const result = await res.json();
    showToast(`üì§ ${result.message}`);
    logLiftAction(currentUser.id, `‡∏™‡∏±‡πà‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÑ‡∏õ‡∏ä‡∏±‡πâ‡∏ô ${targetFloor}`, currentStation, targetFloor);
  } catch (err) {
    showToast("‚ùå ‡∏™‡∏±‡πà‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
    console.error("Move Lift Error:", err.message);
  }
}

// ‚úÖ Jog Up / Down (REST)
function startLiftMove(direction) {
  const action = direction === "up" ? "jogUp" : "jogDown";
  fetch("/api/lift/jog", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId: currentUser.id,
      station: currentStation,
      action: action
    })
  });

  logLiftAction(currentUser.id, `‡∏™‡∏±‡πà‡∏á Jog ${direction === 'up' ? '‡∏Ç‡∏∂‡πâ‡∏ô' : '‡∏•‡∏á'}`, currentStation, null);
}

// ‚úÖ ‡∏´‡∏¢‡∏∏‡∏î Jog
function stopLiftMove() {
  fetch("/api/lift/stop", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId: currentUser.id,
      station: currentStation
    })
  });

  logLiftAction(currentUser.id, "‡∏´‡∏¢‡∏∏‡∏î‡∏•‡∏¥‡∏ü‡∏ï‡πå (Jog)", currentStation, null);
}

// ‚úÖ ‡∏õ‡∏∏‡πà‡∏° EMERGENCY (REST)
function toggleEmergency() {
  isEmergency = !isEmergency;

  fetch("/api/lift/emergency", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId: currentUser.id,
      station: currentStation
    })
  });

  const emBtn = document.getElementById("emButton");
  const statusBox = document.getElementById("liftStatusBox");

  if (isEmergency) {
    emBtn.innerText = "‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥";
    emBtn.style.background = "#444";
    if (statusBox) statusBox.innerText = "üö® ‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥";
  } else {
    emBtn.innerText = "‚õî ‡∏´‡∏¢‡∏∏‡∏î‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ";
    emBtn.style.background = "#c1121f";
    if (statusBox) statusBox.innerText = "üü¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥";
  }

  logLiftAction(currentUser.id, `EMERGENCY: ${isEmergency ? 'ON' : 'OFF'}`, currentStation, null);
}
function startLiftStatusPolling() {
  if (liftStatusTimer) clearInterval(liftStatusTimer);

  liftStatusTimer = setInterval(async () => {
    try {
      const res = await fetch(`/api/lift/status?station=${currentStation}`);
      const data = await res.json();

      // ‚úÖ Debug log: ‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å backend

      if (!data || typeof data.floor !== "number") return;

      // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏à‡∏≤‡∏Å floor sensor ‡∏à‡∏£‡∏¥‡∏á
      currentFloor = data.floor;
      updateLiftDisplay(data.floor);

      // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏•‡πá‡∏Å)
      const movingStatus = document.getElementById("movingStatus");
      if (movingStatus) {
        movingStatus.innerText = data.moving ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà..." : "‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏¥‡πà‡∏á";
      }

      // ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°
      const statusBox = document.getElementById("liftStatusBox");
      if (statusBox) {
        // ‡∏•‡πâ‡∏≤‡∏á class ‡πÄ‡∏î‡∏¥‡∏°
        statusBox.classList.remove("success", "emergency", "recovery", "working");

        if (Boolean(data.emergency)) {
          // üü• ‡∏´‡∏¢‡∏∏‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
          statusBox.classList.add("emergency");
          statusBox.innerHTML = `
            <i class="lucide lucide-alert-triangle" style="margin-right: 6px;"></i>
            ‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏´‡∏¢‡∏∏‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (Emergency Stop)
          `;

        } else if (Boolean(data.recovery)) {
          // üüß Recovery ‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
          statusBox.classList.add("recovery");
          statusBox.innerHTML = `
            <i class="lucide lucide-rotate-cw" style="margin-right: 6px;"></i>
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢...
          `;

        } else if (Boolean(data.moving)) {
          // üü¶ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
          statusBox.classList.add("working");
          statusBox.innerHTML = `
            <i class="lucide lucide-truck" style="margin-right: 6px;"></i>
            ‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
          `;
        } else {
          // üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥
          statusBox.classList.add("success");
          statusBox.innerHTML = `
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="margin-right: 12px;">
              <circle cx="12" cy="12" r="10" fill="#2dcc6f"/>
              <path d="M9 12.5l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
          `;
        }
      }

      // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ EM ‡∏ó‡∏±‡πà‡∏ß‡∏£‡∏∞‡∏ö‡∏ö
      isEmergency = Boolean(data.emergency);

    } catch (err) {
      console.warn("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err.message);
    }
  }, 500); // polling ‡∏ó‡∏∏‡∏Å 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
}




// ‚úÖ Log ‡πÑ‡∏õ backend
function logLiftAction(userId, activity, station, floor) {
  fetch("/api/log", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId,
      activity,
      action_type: "lift",
      category: "‡∏•‡∏¥‡∏ü‡∏ï‡πå",
      station,
      floor
    })
  });
}

// ‚úÖ Toast
function showToast(msg) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.innerText = msg;
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    z-index: 9999;
    font-size: 14px;
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ‚úÖ Init ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
function initLiftPage() {
  const liftCart = document.getElementById("liftCart");
  if (liftCart && levelTop[currentFloor]) {
    liftCart.style.top = `${levelTop[currentFloor]}%`;
  }

  const select = document.getElementById("floorSelect");
  if (select) select.value = currentFloor;

  const display = document.getElementById("currentFloor");
  if (display) display.innerText = currentFloor;

  startLiftStatusPolling();
}

//agv
function handleSlotSelection(slot) {
  if (slot) {
    sendAgvCommand(`go_slot${slot}`);
  }
}


//  status  sensor
async function fetchAgvSensorStatus() {
  try {
    const res = await fetch('/api/sensors');
    if (!res.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    const data = await res.json();

    // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Key ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend
    document.querySelector('#sensorTray span').textContent = data.tray_sensor ? "‚úÖ ‡∏°‡∏µ‡∏ñ‡∏≤‡∏î" : "‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ñ‡∏≤‡∏î";
    document.querySelector('#sensorPos1 span').textContent = data.pos_sensor_1 ? "‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" : "‡∏õ‡∏Å‡∏ï‡∏¥";
    document.querySelector('#sensorPos2 span').textContent = data.pos_sensor_2 ? "‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" : "‡∏õ‡∏Å‡∏ï‡∏¥";
  } catch (err) {
    console.error("[AGV Sensor] ‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", err);
    document.querySelector('#sensorTray span').textContent = "‚ö†Ô∏è";
    document.querySelector('#sensorPos1 span').textContent = "‚ö†Ô∏è";
    document.querySelector('#sensorPos2 span').textContent = "‚ö†Ô∏è";
  }
}

// WebSocket connection for real-time sensor updates
let sensorWebSocket = null;
let sensorReconnectTimer = null;
let sensorReconnectAttempts = 0;
const maxSensorReconnectAttempts = 5;

function connectSensorWebSocket() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${window.location.host}`;
  
  try {
    sensorWebSocket = new WebSocket(wsUrl);
    
    sensorWebSocket.onopen = function() {
      sensorReconnectAttempts = 0;
      
      // Clear any existing reconnect timer
      if (sensorReconnectTimer) {
        clearTimeout(sensorReconnectTimer);
        sensorReconnectTimer = null;
      }
    };
    
    sensorWebSocket.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);
        
        // Handle sensor_update messages
        if (data.type === 'sensor_update') {
          updateSensorUI(data.data);
        }
        
        // Handle water_response messages
        if (data.type === 'water_response') {
          updateWaterStatus(data);
        }
      } catch (err) {
        console.error('‚ùå Error parsing sensor WebSocket message:', err);
      }
    };
    
    sensorWebSocket.onclose = function(event) {
      sensorWebSocket = null;
      
      // Attempt to reconnect if not intentionally closed
      if (event.code !== 1000 && sensorReconnectAttempts < maxSensorReconnectAttempts) {
        sensorReconnectAttempts++;
        const delay = Math.min(1000 * Math.pow(2, sensorReconnectAttempts - 1), 30000);
        
        
        sensorReconnectTimer = setTimeout(() => {
          connectSensorWebSocket();
        }, delay);
      } else if (sensorReconnectAttempts >= maxSensorReconnectAttempts) {
        console.error('‚ùå Max sensor WebSocket reconnection attempts reached');
        // Fallback to polling if WebSocket fails completely
        fallbackToSensorPolling();
      }
    };
    
    sensorWebSocket.onerror = function(error) {
      console.error('‚ùå Sensor WebSocket error:', error);
    };
    
  } catch (err) {
    console.error('‚ùå Error creating sensor WebSocket:', err);
    fallbackToSensorPolling();
  }
}

function updateSensorUI(sensorData) {
  try {
    // Update sensor UI elements based on received data
    const trayElement = document.querySelector('#sensorTray span');
    const pos1Element = document.querySelector('#sensorPos1 span');
    const pos2Element = document.querySelector('#sensorPos2 span');
    
    if (trayElement) {
      trayElement.textContent = sensorData.tray_sensor ? "‚úÖ ‡∏°‡∏µ‡∏ñ‡∏≤‡∏î" : "‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ñ‡∏≤‡∏î";
    }
    
    if (pos1Element) {
      pos1Element.textContent = sensorData.pos_sensor_1 ? "‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" : "‡∏õ‡∏Å‡∏ï‡∏¥";
    }
    
    if (pos2Element) {
      pos2Element.textContent = sensorData.pos_sensor_2 ? "‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" : "‡∏õ‡∏Å‡∏ï‡∏¥";
    }
    
    // Add timestamp for debugging
    
  } catch (err) {
    console.error('‚ùå Error updating sensor UI:', err);
  }
}

function fallbackToSensorPolling() {
  
  // Start polling as fallback
  fetchAgvSensorStatus(); // Initial call
  const fallbackTimer = setInterval(fetchAgvSensorStatus, 3000);
  activeTimers.add(fallbackTimer);
}

function closeSensorWebSocket() {
  if (sensorWebSocket) {
    sensorWebSocket.close(1000, 'Page unload');
    sensorWebSocket = null;
  }
  
  if (sensorReconnectTimer) {
    clearTimeout(sensorReconnectTimer);
    sensorReconnectTimer = null;
  }
  
  sensorReconnectAttempts = 0;
}

async function sendAgvCommand(command) {
  try {
    const res = await fetch('/api/agv/manual', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id,
        station: currentStation, // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ currentStation
        command
      })
    });
    const data = await res.json();
    
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° AGV ‡πÅ‡∏ö‡∏ö manual
    const commandDisplay = {
      'go_lift': '‡πÑ‡∏õ Lift',
      'go_home': '‡∏Å‡∏•‡∏±‡∏ö Home',
      'go_slot1': '‡πÑ‡∏õ‡∏ä‡πà‡∏≠‡∏á 1',
      'go_slot2': '‡πÑ‡∏õ‡∏ä‡πà‡∏≠‡∏á 2',
      'go_slot3': '‡πÑ‡∏õ‡∏ä‡πà‡∏≠‡∏á 3',
      'go_slot4': '‡πÑ‡∏õ‡∏ä‡πà‡∏≠‡∏á 4',
      'go_slot5': '‡πÑ‡∏õ‡∏ä‡πà‡∏≠‡∏á 5',
      'go_slot6': '‡πÑ‡∏õ‡∏ä‡πà‡∏≠‡∏á 6'
    };
    const displayText = commandDisplay[command] || command;
    logAction(currentUser.username, `‡∏™‡∏±‡πà‡∏á AGV Manual: ${displayText}`, 'manual_control', 'AGV', currentStation);
    
  } catch (err) {
    console.error('‚ùå AGV Command Error:', err);
    showNotification('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á AGV ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
  }
}

function handleSlotManual() {
  const slot = document.getElementById("slotSelectManual").value;
  if (!slot) {
    showNotification("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô", 'warning');
    return;
  }
  const cmd = `go_slot${slot}`;
  sendAgvCommand(cmd);
}


async function sendTrayCommand(command) {
  try {
    const res = await fetch('/api/tray/manual', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUser.id,
       station: currentStation, // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ currentStation
        command  // ‡πÄ‡∏ä‡πà‡∏ô tray_up, tray_down
      })
    });
    const data = await res.json();
    
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Tray ‡πÅ‡∏ö‡∏ö manual
    const trayCommandDisplay = {
      'tray_up': '‡∏¢‡∏Å‡∏ñ‡∏≤‡∏î',
      'tray_down': '‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î'
    };
    const displayText = trayCommandDisplay[command] || command;
    logAction(currentUser.username, `‡∏™‡∏±‡πà‡∏á Tray Manual: ${displayText}`, 'manual_control', 'Tray', currentStation);
  } catch (err) {
    console.error('‚ùå Tray Command Error:', err);
    showNotification('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á TRAY ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
  }
}
let allTaskHistoryData = [];
let taskHistoryCurrentPage = 1;
const taskHistoryRowsPerPage = 20; // üü¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏∞ 20 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
async function initTaskHistoryPage() {
    try {
        const station = currentStation || 1;
        const res = await fetch(`/api/task/history?station=${station}`);
        if (!res.ok) throw new Error(`API Error: ${res.status}`);
        
        allTaskHistoryData = await res.json();
        
        // ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ] ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ
        updateTaskHistoryStats(allTaskHistoryData); 
        
        setupHistoryEventListeners(); 
        filterAndRenderHistoryTable(); 
    } catch (err) {
        console.error("‚ùå Failed to load task history:", err);
        const tbody = document.getElementById("taskHistoryTableBody");
        if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
    }
}
// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ú‡∏π‡∏Å Event Listener (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
function setupHistoryEventListeners() {
    const searchInput = document.getElementById('historySearch');
    const filterSelect = document.getElementById('historyFilter');

    if (searchInput) searchInput.addEventListener('input', () => {
        taskHistoryCurrentPage = 1;
        filterAndRenderHistoryTable();
    });
    if (filterSelect) filterSelect.addEventListener('change', () => {
        taskHistoryCurrentPage = 1;
        filterAndRenderHistoryTable();
    });
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function filterAndRenderHistoryTable() {
    const searchInput = document.getElementById('historySearch');
    const filterSelect = document.getElementById('historyFilter');

    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    const filterType = filterSelect ? filterSelect.value : '';

    const filteredData = allTaskHistoryData.filter(task => {
        const matchesSearch = !searchTerm ||
            (task.tray_id && task.tray_id.toLowerCase().includes(searchTerm)) ||
            (task.username && task.username.toLowerCase().includes(searchTerm));
        const matchesFilter = !filterType || task.action_type === filterType;
        return matchesSearch && matchesFilter;
    });

    const totalPages = Math.ceil(filteredData.length / taskHistoryRowsPerPage);
    if(taskHistoryCurrentPage > totalPages && totalPages > 0) taskHistoryCurrentPage = totalPages;

    const start = (taskHistoryCurrentPage - 1) * taskHistoryRowsPerPage;
    const pageTasks = filteredData.slice(start, start + taskHistoryRowsPerPage);

    renderTaskHistoryTable(pageTasks); // ‡∏ß‡∏≤‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    renderTaskHistoryPagination(filteredData.length, totalPages); // ‡∏ß‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏° Pagination
}

// 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (tbody)
function renderTaskHistoryTable(tasks) {
    const tbody = document.getElementById("taskHistoryTableBody");
    if (!tbody) return;

    tbody.innerHTML = "";
    if (!tasks || tasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</td></tr>';
        return;
    }

    tasks.forEach(task => {
        const tr = document.createElement("tr");
        tr.className = 'fade-in-row';
        // (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á <tr> ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
        const statusClass = `status-enhanced ${task.status}`;
        const endTime = task.completed_at ? new Date(task.completed_at).toLocaleString("th-TH") : '-';
        const actionBadge = task.action_type === 'inbound'
          ? '<span class="action-badge inbound"><i class="fas fa-arrow-down"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</span>'
          : '<span class="action-badge outbound"><i class="fas fa-arrow-up"></i> ‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å</span>';
        tr.innerHTML = `
          <td><strong>${task.tray_id}</strong></td>
          <td><span class="floor-badge">‡∏ä‡∏±‡πâ‡∏ô ${task.floor || '-'}</span></td>
          <td><span class="slot-badge">‡∏ä‡πà‡∏≠‡∏á ${task.slot || '-'}</span></td>
          <td><span class="${statusClass}">${convertStatusLabel(task.status)}</span></td>
          <td>${new Date(task.created_at).toLocaleString("th-TH")}</td>
          <td>${endTime}</td>
          <td>${actionBadge}</td>
          <td><span class="user-badge"><i class="fas fa-user-circle"></i> ${task.username || '-'}</span></td>
        `;
        tbody.appendChild(tr);
    });
}

// 5. üü¢ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î Pagination
function renderTaskHistoryPagination(totalItems, totalPages) {
    const paginationContainer = document.getElementById('taskHistoryPagination');
    if (!paginationContainer) return;

    if (totalItems === 0) {
        paginationContainer.innerHTML = '';
        return;
    }

    const startItem = (taskHistoryCurrentPage - 1) * taskHistoryRowsPerPage + 1;
    const endItem = Math.min(startItem + taskHistoryRowsPerPage - 1, totalItems);

    let buttonsHtml = '';
    // ‡∏õ‡∏∏‡πà‡∏° Previous
    buttonsHtml += `<button onclick="goToTaskHistoryPage(${taskHistoryCurrentPage - 1})" ${taskHistoryCurrentPage === 1 ? 'disabled' : ''}>&laquo; ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>`;

    // ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 5 ‡∏´‡∏ô‡πâ‡∏≤)
    const startPage = Math.max(1, taskHistoryCurrentPage - 2);
    const endPage = Math.min(totalPages, startPage + 4);

    for (let i = startPage; i <= endPage; i++) {
        buttonsHtml += `<button onclick="goToTaskHistoryPage(${i})" class="${i === taskHistoryCurrentPage ? 'active' : ''}">${i}</button>`;
    }

    // ‡∏õ‡∏∏‡πà‡∏° Next
    buttonsHtml += `<button onclick="goToTaskHistoryPage(${taskHistoryCurrentPage + 1})" ${taskHistoryCurrentPage === totalPages ? 'disabled' : ''}>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ &raquo;</button>`;

    paginationContainer.innerHTML = `
        <div class="pagination-summary">
            ‡πÅ‡∏™‡∏î‡∏á ${startItem}-${endItem} ‡∏à‡∏≤‡∏Å ${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </div>
        <div class="pagination-buttons">
            ${buttonsHtml}
        </div>
    `;
}

// 6. üü¢ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
function goToTaskHistoryPage(page) {
    if (page < 1) return;
    const totalPages = Math.ceil(allTaskHistoryData.length / taskHistoryRowsPerPage);
    if (page > totalPages && totalPages > 0) return;
    
    taskHistoryCurrentPage = page;
    filterAndRenderHistoryTable();
    document.querySelector('.table-responsive-wrapper').scrollIntoView({ behavior: 'smooth' });
}
function openExportModal() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;
    document.querySelector('input[name="exportRange"][value="all"]').checked = true;
    
    // Update today's date text
    const todayFormatted = new Date().toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'long', 
        day: 'numeric'
    });
    const todayDateText = document.getElementById('todayDateText');
    if (todayDateText) {
        todayDateText.textContent = `‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${todayFormatted}`;
    }
    
    // Reset and show modal with animation
    const modal = document.getElementById('exportDateModal');
    const modalContent = document.getElementById('exportModalContent');
    
    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
    
    toggleDateInputs();
    updateRadioStates();
}

function closeExportModal() {
    const modal = document.getElementById('exportDateModal');
    const modalContent = document.getElementById('exportModalContent');
    
    // Animate out
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

function toggleDateInputs() {
    const selectedRange = document.querySelector('input[name="exportRange"]:checked').value;
    const dateRangePicker = document.getElementById('dateRangePicker');
    
    if (selectedRange === 'range') {
        dateRangePicker.classList.remove('hidden');
    } else {
        dateRangePicker.classList.add('hidden');
    }
    
    updateRadioStates();
}

function updateRadioStates() {
    // Update visual states of radio buttons
    const radios = document.querySelectorAll('input[name="exportRange"]');
    radios.forEach(radio => {
        const label = radio.closest('label');
        const circle = label.querySelector('.w-6.h-6 > div');
        
        if (radio.checked) {
            // Selected state
            label.classList.add('border-green-400', 'bg-green-50');
            label.classList.remove('border-gray-200');
            circle.classList.add('opacity-100', 'scale-100');
            circle.classList.remove('opacity-0', 'scale-0');
        } else {
            // Unselected state
            label.classList.remove('border-green-400', 'bg-green-50', 'border-blue-400', 'bg-blue-50', 'border-purple-400', 'bg-purple-50');
            label.classList.add('border-gray-200');
            circle.classList.add('opacity-0', 'scale-0');
            circle.classList.remove('opacity-100', 'scale-100');
        }
    });
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô Pop-up
function initiateExport() {
    const filterType = document.querySelector('input[name="exportRange"]:checked').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    closeExportModal(); // ‡∏õ‡∏¥‡∏î Pop-up ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î
    exportTaskHistoryToExcel(filterType, startDate, endDate);
}

function exportTaskHistoryToExcel(filterType, startDate, endDate) {
    let dataToExport = allTaskHistoryData;
    let reportTitle = 'Task History (All Data)';
    let fileName = `task_history_all_${new Date().toISOString().split('T')[0]}.xlsx`;

    // --- üü¢ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î: ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô ---
    if (filterType === 'today') {
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        const todayEnd = new Date();
        todayEnd.setHours(23, 59, 59, 999);

        dataToExport = allTaskHistoryData.filter(task => {
            const taskDate = new Date(task.completed_at || task.created_at);
            return taskDate >= todayStart && taskDate <= todayEnd;
        });
        reportTitle = `Task History (Today: ${new Date().toLocaleDateString('th-TH')})`;
        fileName = `task_history_today_${new Date().toISOString().split('T')[0]}.xlsx`;

    } else if (filterType === 'range') {
        if (!startDate || !endDate) {
            showNotification("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", 'warning');
            return;
        }
        const start = new Date(startDate);
        start.setHours(0, 0, 0, 0);
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);

        dataToExport = allTaskHistoryData.filter(task => {
            const taskDate = new Date(task.completed_at || task.created_at);
            return taskDate >= start && taskDate <= end;
        });
        reportTitle = `Task History (${startDate} to ${endDate})`;
        fileName = `task_history_range_${startDate}_to_${endDate}.xlsx`;
    }

    if (!dataToExport || dataToExport.length === 0) {
        showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", false);
        return;
    }
    
    showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel... (${dataToExport.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`, true);

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏î XlsxPopulate ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ---
    const exportDataFormatted = dataToExport.map((task, index) => [
        index + 1, task.tray_id, task.action_type === 'inbound' ? '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å',
        `‡∏ä‡∏±‡πâ‡∏ô ${task.floor}, ‡∏ä‡πà‡∏≠‡∏á ${task.slot}`, task.status === 'success' ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : task.status,
        new Date(task.created_at).toLocaleString('th-TH'),
        task.completed_at ? new Date(task.completed_at).toLocaleString('th-TH') : '-',
        task.username
    ]);
    const headers = ["‡∏•‡∏≥‡∏î‡∏±‡∏ö", "Tray ID", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°", "‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"];

    XlsxPopulate.fromBlankAsync().then(workbook => {
        const sheet = workbook.sheet(0).name("Task History");
        sheet.cell("A1").value(`AGROTECH WMS - ${reportTitle}`).style({ bold: true, fontSize: 18, fontColor: "059669" });
        headers.forEach((header, i) => { sheet.cell(3, i + 1).value(header).style({ bold: true, fill: "10b981", fontColor: "ffffff", horizontalAlignment: "center", verticalAlignment: "center" }); });
        exportDataFormatted.forEach((row, r) => { row.forEach((val, c) => { sheet.cell(r + 4, c + 1).value(val); }); });
        sheet.column("A").width(8); sheet.column("B").width(15); sheet.column("C").width(12); sheet.column("D").width(20);
        sheet.column("E").width(12); sheet.column("F").width(22); sheet.column("G").width(22); sheet.column("H").width(18);
        sheet.row(3).height(25); sheet.range("A3:H3").autoFilter(); sheet.freezePanes(4, 1);
        return workbook.outputAsync();
    }).then(blob => {
        // ‡πÉ‡∏ä‡πâ data URL ‡πÅ‡∏ó‡∏ô blob URL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á HTTP warning
        const reader = new FileReader();
        const a = document.createElement("a");
        reader.onload = function() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á temporary link ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏•‡∏á‡πÉ‡∏ô DOM
            a.href = reader.result;
            a.download = fileName;
            a.style.display = 'none';
            a.click();
        };
        reader.readAsDataURL(blob);
    }).catch(err => {
        console.error("‚ùå Export Error:", err);
        showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel", false);
    });
}

function toggleExcelDropdown(event) {
    event.stopPropagation();
    document.getElementById("excelDropdown").classList.toggle("show-menu");
}

// ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
window.onclick = function(event) {
    if (!event.target.matches('.filter-btn')) {
        var dropdowns = document.getElementsByClassName("excel-dropdown-menu");
        for (var i = 0; i < dropdowns.length; i++) {
            var openDropdown = dropdowns[i];
            if (openDropdown.classList.contains('show-menu')) {
                openDropdown.classList.remove('show-menu');
            }
        }
    }
}

function formatStatus(status) {
  const statusMap = {
    'pending': '‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
    'working': 'üöö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',
    'at_workstation': 'üì¶ ‡∏£‡∏≠‡∏ó‡∏µ‡πà Workstation',
    'success': '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
    'error': '‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'
  };
  return statusMap[status] || status;
}

async function loadTrayMasterData() {
    try {
        // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å trayInventory ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÉ‡∏´‡∏°‡πà
        
        // ‡πÅ‡∏õ‡∏•‡∏á trayInventory object ‡πÄ‡∏õ‡πá‡∏ô array
        const trays = Object.values(trayInventory);
        
        // Debug ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• batch_id
        trays.forEach((tray, i) => {
        });
        
        const tbody = document.getElementById('trayMasterTableBody');

        if (!tbody) return;

        const searchQuery = document.getElementById('traySearchInput')?.value.toLowerCase() || '';
        const statusFilter = document.getElementById('trayStatusFilter')?.value || '';
        const vegFilter = document.getElementById('trayVegFilter')?.value || '';

        // ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const filteredTrays = trays.filter(tray => {
            const searchMatch = (
                tray.tray_id.toLowerCase().includes(searchQuery) ||
                (tray.batch_id || '').toLowerCase().includes(searchQuery) ||
                tray.veg_type.toLowerCase().includes(searchQuery)
            );
            const statusMatch = !statusFilter || tray.status === statusFilter;
            const vegMatch = !vegFilter || 
                tray.veg_type.toLowerCase().includes(vegFilter.toLowerCase()) ||
                tray.tray_id.toLowerCase().includes(vegFilter.toLowerCase());
            return searchMatch && statusMatch && vegMatch;
        });

        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Stats
        updateTrayMasterStats(trays, filteredTrays);

        // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        tbody.innerHTML = '';
        
        if (filteredTrays.length === 0) {
            tbody.innerHTML = `
                <tr class="no-data-row">
                    <td colspan="10">
                        <div class="no-data-content">
                            <i class="fas fa-search"></i>
                            <span>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á</span>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        filteredTrays.forEach((tray, index) => {
            const age = tray.age ? tray.age + ' ‡∏ß‡∏±‡∏ô' : calculateTrayAge(tray.time_in);
            const row = document.createElement('tr');

            // ‚úÖ Debug ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô render

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô
            row.className = 'fade-in-row';
            row.style.animationDelay = `${index * 30}ms`;

            // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° status badge ‡∏™‡∏ß‡∏¢
            row.innerHTML = `
                <td>
                    <div class="tray-id-cell">
                        <i class="fas fa-qrcode"></i>
                        <span>${tray.tray_id}</span>
                    </div>
                </td>
                <td>${tray.batch_id || 'N/A'}</td>
                <td>
                    <div class="vegetable-cell">
                        <i class="fas fa-leaf"></i>
                        <span>${tray.veg_type}</span>
                    </div>
                </td>
                <td>
                    <div class="location-cell">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>‡∏ä‡∏±‡πâ‡∏ô ${tray.floor} / ‡∏ä‡πà‡∏≠‡∏á ${tray.slot}</span>
                    </div>
                </td>
                <td class="quantity-cell">${tray.plant_quantity || '-'}</td>
                <td>${tray.seeding_date ? new Date(tray.seeding_date).toLocaleDateString('th-TH') : '-'}</td>
                <td class="age-cell">${age}</td>
                <td>${renderPremiumTrayStatusLabel(tray.status)}</td>
                <td class="notes-cell">${tray.notes || '-'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn edit" onclick="editTray('${tray.tray_id}')">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="action-btn history" onclick="viewTrayHistory('${tray.tray_id}')">
                            <i class="fas fa-history"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteTray('${tray.tray_id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);

            const historyRow = document.createElement('tr');
            historyRow.className = 'history-row';
            historyRow.id = `history-${tray.tray_id}`;
            historyRow.style.display = 'none';
            historyRow.innerHTML = `<td colspan="10"></td>`;
            tbody.appendChild(historyRow);
        });

    } catch (err) {
        console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Tray Master ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
        const tbody = document.getElementById('trayMasterTableBody');
        if(tbody) tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding: 20px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
    }
}



function calculateTrayAgeInDays(time_in_string) {
    if (!time_in_string) return null;
    const startTime = new Date(time_in_string);
    const now = new Date();
    const diffMs = now.getTime() - startTime.getTime();
    if (diffMs < 0) return 0;
    return Math.floor(diffMs / (1000 * 60 * 60 * 24));
}

/**
 * Corrected function to export filtered Tray Master data to an Excel file.
 */
async function exportTrayMasterToExcel() {
    showToast('üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Excel...', true);

    try {
        // 1. Fetch the latest full tray inventory data.
        const res = await fetch(`/api/tray-inventory?station=${currentStation}`);
        const allTrays = await res.json();

        // 2. Correctly get filter values from the existing HTML elements.
        const searchQuery = document.getElementById('traySearchInput').value.toLowerCase();
        const statusFilter = document.getElementById('trayStatusFilter').value;
        const vegFilter = document.getElementById('trayVegFilter').value;

        // 3. Filter the data based on the available filters.
        const filteredTrays = allTrays.filter(tray => {
            const searchMatch = !searchQuery || (
                tray.tray_id.toLowerCase().includes(searchQuery) ||
                (tray.batch_id || '').toLowerCase().includes(searchQuery) ||
                tray.veg_type.toLowerCase().includes(searchQuery)
            );
            const statusMatch = !statusFilter || tray.status === statusFilter;
            const vegMatch = !vegFilter || 
                tray.veg_type.toLowerCase().includes(vegFilter.toLowerCase()) ||
                tray.tray_id.toLowerCase().includes(vegFilter.toLowerCase());

            return searchMatch && statusMatch && vegMatch;
        });

        if (filteredTrays.length === 0) {
            showToast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞ Export ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', false);
            return;
        }

        // 4. Check if XlsxPopulate is available
        if (typeof XlsxPopulate === 'undefined') {
            showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ Excel ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà', false);
            return;
        }

        // 5. Create the workbook and worksheet.
        const workbook = await XlsxPopulate.fromBlankAsync();
        const sheet = workbook.sheet(0).name("Tray Master Report");

        // 6. Add report headers and information.
        sheet.range("A1:I1").merged(true).value("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î (Tray Master Report)")
            .style({ bold: true, fontSize: 18, horizontalAlignment: "center", fontColor: "1b4332" });
        const reportDate = new Date().toLocaleString('th-TH');
        sheet.cell("A2").value("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:").style({ bold: true });
        sheet.cell("B2").value(reportDate);
        sheet.cell("A3").value("‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ (Station):").style({ bold: true });
        sheet.cell("B3").value(currentStation);

        // 7. Add table headers.
        const headers = ['Tray ID', 'Batch ID', '‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞', '‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏ß‡∏±‡∏ô)', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'];
        headers.forEach((header, index) => {
            sheet.cell(5, index + 1).value(header)
                .style({ bold: true, fill: "2d6a4f", fontColor: "ffffff", horizontalAlignment: "center" });
        });

        // 8. Populate data into the sheet.
        filteredTrays.forEach((tray, rowIndex) => {
            const r = rowIndex + 6;
            sheet.cell(r, 1).value(tray.tray_id);
            sheet.cell(r, 2).value(tray.batch_id || '-');
            sheet.cell(r, 3).value(tray.veg_type);
            sheet.cell(r, 4).value(`‡∏ä‡∏±‡πâ‡∏ô ${tray.floor} / ‡∏ä‡πà‡∏≠‡∏á ${tray.slot}`);
            sheet.cell(r, 5).value(tray.plant_quantity || '-').style({ horizontalAlignment: "center" });
            sheet.cell(r, 6).value(tray.seeding_date ? new Date(tray.seeding_date).toLocaleDateString('th-TH') : '-');
            sheet.cell(r, 7).value(tray.age || calculateTrayAgeInDays(tray.time_in)).style({ horizontalAlignment: "center" });
            sheet.cell(r, 8).value(tray.status === 'on_shelf' ? '‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á' : '‡∏ó‡∏µ‡πà Workstation');
            sheet.cell(r, 9).value(tray.notes || '-');
        });
        
        // 9. Style and finalize the worksheet.
        sheet.column("A").width(15); sheet.column("B").width(20); sheet.column("C").width(22);
        sheet.column("D").width(18); sheet.column("E").width(12); sheet.column("F").width(15);
        sheet.column("G").width(12); sheet.column("H").width(18); sheet.column("I").width(35);
        sheet.range("A5:I5").autoFilter();
        sheet.freezePanes(6, 1); // Freeze rows above the data.

        // 10. Generate and trigger the download (‡πÉ‡∏ä‡πâ data URL ‡πÅ‡∏ó‡∏ô blob URL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á HTTP warning)
        const blob = await workbook.outputAsync();
        const reader = new FileReader();
        const a = document.createElement("a");
        
        reader.onload = function() {
            a.href = reader.result; // data URL
            a.download = `TrayMaster_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
        
        reader.readAsDataURL(blob);
        showToast(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (${filteredTrays.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`, true);

    } catch (error) {
        console.error("Export to Excel failed:", error);
        showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel', false);
    }
}

// ‚ú® View Tray History Function
async function viewTrayHistory(trayId) {
    // Find tray data
    const tray = Object.values(trayInventory).find(t => t.tray_id === trayId);
    if (!tray) {
        showToast("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î", false);
        return;
    }

    // Update modal header info
    document.getElementById('historyTrayInfo').textContent = `${tray.tray_id} - ${tray.veg_type}`;
    
    // Show modal
    document.getElementById('trayHistoryModal').style.display = 'flex';
    
    // Load tray summary
    loadTraySummary(tray);
    
    // Load tray history
    await loadTrayHistoryData(trayId);
}

// ‚ú® Close History Modal
function closeHistoryModal() {
    document.getElementById('trayHistoryModal').style.display = 'none';
}

// ‚ú® Load Tray Summary
function loadTraySummary(tray) {
    const age = tray.age ? tray.age + ' ‡∏ß‡∏±‡∏ô' : calculateTrayAge(tray.time_in);
    const summaryData = document.getElementById('traySummaryData');
    
    summaryData.innerHTML = `
        <div class="summary-item">
            <div class="label">Tray ID</div>
            <div class="value">${tray.tray_id}</div>
        </div>
        <div class="summary-item">
            <div class="label">‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</div>
            <div class="value">${tray.veg_type}</div>
        </div>
        <div class="summary-item">
            <div class="label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
            <div class="value">‡∏ä‡∏±‡πâ‡∏ô ${tray.floor} / ‡∏ä‡πà‡∏≠‡∏á ${tray.slot}</div>
        </div>
        <div class="summary-item">
            <div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô</div>
            <div class="value">${tray.plant_quantity || '-'}</div>
        </div>
        <div class="summary-item">
            <div class="label">‡∏≠‡∏≤‡∏¢‡∏∏</div>
            <div class="value">${age}</div>
        </div>
        <div class="summary-item">
            <div class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="value">${getStatusText(tray.status)}</div>
        </div>
    `;
}

// ‚ú® Load Tray History Data
async function loadTrayHistoryData(trayId) {
    try {
        const response = await fetch(`/api/tray/history/${trayId}`);
        const data = await response.json();
        
        if (response.ok && data.length > 0) {
            renderTimeline(data);
            renderStats(data);
        } else {
            renderEmptyTimeline();
        }
    } catch (error) {
        console.error('Load history error:', error);
        renderErrorTimeline();
    }
}

// ‚ú® Render Timeline
function renderTimeline(historyData) {
    const timelineContainer = document.getElementById('historyTimeline');
    const timelineStats = document.getElementById('timelineStats');
    
    // Update stats - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å task_monitor
    const totalEvents = historyData.length;
    const inboundEvents = historyData.filter(h => h.action_type === 'inbound').length;
    const outboundEvents = historyData.filter(h => h.action_type === 'outbound').length;
    
    timelineStats.innerHTML = `
        <div class="timeline-stat">
            <div class="number">${totalEvents}</div>
            <div class="label">‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        </div>
        <div class="timeline-stat">
            <div class="number">${inboundEvents}</div>
            <div class="label">Inbound</div>
        </div>
        <div class="timeline-stat">
            <div class="number">${outboundEvents}</div>
            <div class="label">Outbound</div>
        </div>
    `;
    
    // Render timeline items - ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å task_monitor
    const timelineHTML = historyData.map((item, index) => {
        const actionType = item.action_type || 'system';
        const timelineClass = getTimelineClass(actionType);
        const icon = getTimelineIcon(actionType);
        const time = item.timestamp_th || new Date(item.created_at).toLocaleString('th-TH');
        
        return `
            <div class="timeline-item">
                <div class="timeline-icon ${timelineClass}">
                    <i class="${icon}"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-header-info">
                        <h4 class="timeline-title">${getActionTitle(actionType)}</h4>
                        <span class="timeline-time">${time}</span>
                    </div>
                   <p class="timeline-description">${item.notes || item.reason || getActionDescription(item)}</p>
                    <div class="timeline-details">
                        ${item.floor ? `<span class="timeline-detail">‡∏ä‡∏±‡πâ‡∏ô ${item.floor}</span>` : ''}
                        ${item.slot ? `<span class="timeline-detail">‡∏ä‡πà‡∏≠‡∏á ${item.slot}</span>` : ''}
                        ${item.station_id ? `<span class="timeline-detail">‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ ${item.station_id}</span>` : ''}
                        ${item.username ? `<span class="timeline-detail">‡πÇ‡∏î‡∏¢ ${item.username}</span>` : ''}
                        ${item.status ? `<span class="timeline-detail">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ${item.status}</span>` : ''}
                        ${item.veg_type ? `<span class="timeline-detail">‡∏ú‡∏±‡∏Å ${item.veg_type}</span>` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    timelineContainer.innerHTML = timelineHTML;
}

// ‚ú® Helper Functions
function getTimelineClass(actionType) {
    switch(actionType) {
        case 'inbound': return 'inbound';
        case 'outbound': return 'outbound';
        case 'tray_outbound': return 'outbound';
        case 'edit': return 'edit';
        case 'harvest': return 'harvest';
        case 'move': return 'move';
        case 'transfer': return 'move';
        case 'relocate': return 'move';
        default: return 'system';
    }
}

function getTimelineIcon(actionType) {
    switch(actionType) {
        case 'inbound': return 'fas fa-arrow-down';
        case 'outbound': return 'fas fa-arrow-up';
        case 'edit': return 'fas fa-edit';
        case 'harvest': return 'fas fa-cut';
        case 'move': return 'fas fa-arrows-alt';
        case 'transfer': return 'fas fa-exchange-alt';
        case 'relocate': return 'fas fa-location-arrow';
        default: return 'fas fa-cog';
    }
}

function getActionTitle(actionType) {
    switch(actionType) {
        case 'inbound': return '‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö';
        case 'outbound': return '‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö';
        case 'edit': return '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        case 'harvest': return '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß';
        case 'move': return '‡∏¢‡πâ‡∏≤‡∏¢‡∏ñ‡∏≤‡∏î';
        case 'transfer': return '‡πÇ‡∏≠‡∏ô‡∏ñ‡∏≤‡∏î';
        case 'relocate': return '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
        default: return '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏∞‡∏ö‡∏ö';
    }
}

function getActionDescription(item) {
    switch(item.action_type) {
        case 'inbound': 
            return `‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î ${item.veg_type || ''} ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô ${item.floor} ‡∏ä‡πà‡∏≠‡∏á ${item.slot}`;
        case 'outbound':
            return `‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡∏±‡πâ‡∏ô ${item.floor} ‡∏ä‡πà‡∏≠‡∏á ${item.slot}`;
        case 'harvest':
            return `‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß ${item.veg_type || '‡∏ú‡∏±‡∏Å'} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${item.quantity || ''} ‡∏Å.`;
        case 'move':
            return `‡∏¢‡πâ‡∏≤‡∏¢‡∏ñ‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏±‡πâ‡∏ô ${item.from_floor || item.floor} ‡∏ä‡πà‡∏≠‡∏á ${item.from_slot || item.slot} ‡πÑ‡∏õ‡∏ä‡∏±‡πâ‡∏ô ${item.to_floor || item.floor} ‡∏ä‡πà‡∏≠‡∏á ${item.to_slot || item.slot}`;
        case 'transfer':
            return `‡πÇ‡∏≠‡∏ô‡∏ñ‡∏≤‡∏î ${item.veg_type || ''} ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÇ‡∏ã‡∏ô ${item.zone || '‡∏≠‡∏∑‡πà‡∏ô'}`;
        case 'relocate':
            return `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡∏≤‡∏î‡πÑ‡∏õ ${item.new_location || '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà'}`;
        default:
            return '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
    }
}

function getStatusText(status) {
    switch(status) {
        case 'on_shelf': return '‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á';
        case 'AT_WORKSTATION': return '‡∏ó‡∏µ‡πà Workstation';
        case 'IN_STORAGE': return '‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á';
        default: return status;
    }
}

// ‚ú® Render Empty Timeline
function renderEmptyTimeline() {
    const timelineContainer = document.getElementById('historyTimeline');
    timelineContainer.innerHTML = `
        <div class="no-data-content">
            <i class="fas fa-history"></i>
            <span>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>
        </div>
    `;
    
    document.getElementById('timelineStats').innerHTML = `
        <div class="timeline-stat">
            <div class="number">0</div>
            <div class="label">‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        </div>
    `;
}

// ‚ú® Render Error Timeline
function renderErrorTimeline() {
    const timelineContainer = document.getElementById('historyTimeline');
    timelineContainer.innerHTML = `
        <div class="no-data-content">
            <i class="fas fa-exclamation-triangle"></i>
            <span>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
        </div>
    `;
}

// ‚ú® Render Stats
function renderStats(historyData) {
    const statsContainer = document.getElementById('trayStats');
    
    // Calculate stats
    const totalEvents = historyData.length;
    const firstEvent = historyData[historyData.length - 1];
    const lastEvent = historyData[0];
    const daysSinceFirst = firstEvent ? Math.floor((new Date() - new Date(firstEvent.created_at)) / (1000 * 60 * 60 * 24)) : 0;
    const uniqueLocations = [...new Set(historyData.filter(h => h.floor && h.slot).map(h => `${h.floor}-${h.slot}`))].length;
    
    statsContainer.innerHTML = `
        <div class="stat-card">
            <div class="number">${totalEvents}</div>
            <div class="label">‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        </div>
        <div class="stat-card">
            <div class="number">${daysSinceFirst}</div>
            <div class="label">‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
        </div>
        <div class="stat-card">
            <div class="number">${uniqueLocations}</div>
            <div class="label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô</div>
        </div>
        <div class="stat-card">
            <div class="number">${historyData.filter(h => h.username).length}</div>
            <div class="label">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏Ñ‡∏ô</div>
        </div>
    `;
}

// ‚ú® Export All Tray Master Data to Excel (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å)
async function exportAllTrayMaster() {
    try {
        showToast("üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...", true);
        
        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å trayInventory ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö filter ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
        const currentStation = localStorage.getItem('currentStation') || '1';
        const trays = Object.values(trayInventory);
        
        // ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ filter ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏ô loadTrayMasterData()
        const searchQuery = document.getElementById('traySearchInput')?.value.toLowerCase() || '';
        const statusFilter = document.getElementById('trayStatusFilter')?.value || '';
        const vegFilter = document.getElementById('trayVegFilter')?.value || '';
        
        const actualTrayData = trays.filter(tray => {
            const matchesSearch = !searchQuery || 
                tray.tray_id?.toLowerCase().includes(searchQuery) ||
                tray.batch_id?.toLowerCase().includes(searchQuery) ||
                tray.veg_type?.toLowerCase().includes(searchQuery);
            
            const matchesStatus = !statusFilter || tray.status === statusFilter;
            const matchesVeg = !vegFilter || tray.veg_type?.toLowerCase().includes(vegFilter.toLowerCase());
            
            return matchesSearch && matchesStatus && matchesVeg;
        });
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏≤‡∏Å API ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        const [tasksResponse, userLogsResponse] = await Promise.all([
            fetch('/api/task-monitor').catch(() => ({ ok: false, json: () => [] })),
            fetch('/api/logs').catch(() => ({ ok: false, json: () => [] }))
        ]);
        
        const tasksData = tasksResponse.ok ? await tasksResponse.json() : [];
        const userLogsData = userLogsResponse.ok ? await userLogsResponse.json() : [];
        
        if (!actualTrayData || actualTrayData.length === 0) {
            showToast("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å", false);
            return;
        }
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Workbook ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ SheetJS
        const wb = XLSX.utils.book_new();
        
        // Sheet 1: Tray Master Data (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏Å‡∏ï‡∏¥)
        const trayHeaders = [
            'Tray ID', 'Batch ID', '‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô', 
            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞', '‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏ß‡∏±‡∏ô)', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'
        ];
        
        const trayRows = actualTrayData.map(item => {
            const ageInDays = item.time_in ? 
                Math.floor((new Date() - new Date(item.time_in)) / (1000 * 60 * 60 * 24)) : '';
            
            return [
                item.tray_id || '',
                item.batch_id || '',
                item.veg_type || '',
                `‡∏ä‡∏±‡πâ‡∏ô ${item.floor || ''} / ‡∏ä‡πà‡∏≠‡∏á ${item.slot || ''}`,
                item.plant_quantity || '',
                item.seeding_date ? new Date(item.seeding_date).toLocaleDateString('th-TH') : '',
                ageInDays,
                item.status === 'on_shelf' ? '‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á' : '‡∏ó‡∏µ‡πà Workstation',
                item.notes || ''
            ];
        });
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ
        const reportTitle = "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î (Tray Master Report)";
        const reportDate = new Date().toLocaleString('th-TH');
        // ‡πÉ‡∏ä‡πâ currentStation ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
        
        const traySheetData = [
            [reportTitle], // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
            [`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${reportDate}`], // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            [`‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ (Station): ${currentStation}`], // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ
            [], // ‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á
            trayHeaders, // ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            ...trayRows // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        ];
        const ws1 = XLSX.utils.aoa_to_sheet(traySheetData);
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
        ws1['!cols'] = [
            { wch: 15 }, { wch: 20 }, { wch: 22 }, { wch: 18 }, { wch: 12 },
            { wch: 15 }, { wch: 12 }, { wch: 18 }, { wch: 35 }
        ];
        
        // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        if (ws1['A1']) {
            ws1['A1'].s = {
                font: { bold: true, sz: 16, color: { rgb: "1B4332" } },
                alignment: { horizontal: "center" }
            };
        }
        
        // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö header ‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 5)
        const headerRow = 5;
        trayHeaders.forEach((header, index) => {
            const cellRef = XLSX.utils.encode_cell({ r: headerRow - 1, c: index });
            if (ws1[cellRef]) {
                ws1[cellRef].s = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "2D6A4F" } },
                    alignment: { horizontal: "center" }
                };
            }
        });
        XLSX.utils.book_append_sheet(wb, ws1, 'Tray Master');
        
        // Sheet 2: Enhanced Statistics & Analytics  
        const totalTrays = actualTrayData.length;
        const inStorage = actualTrayData.filter(t => t.status === 'on_shelf').length;
        const atWorkstation = actualTrayData.filter(t => t.status === 'AT_WORKSTATION').length;
        const harvested = actualTrayData.filter(t => t.harvest_date).length;
        const vegetableTypes = [...new Set(actualTrayData.map(t => t.veg_type))].filter(v => v);
        
        // ‡∏£‡∏ß‡∏° Timeline Activities ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á
        let totalActivities = 0;
        const recentTasks = tasksData.filter(task => {
            const taskDate = new Date(task.created_at || task.updated_at);
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            return taskDate >= weekAgo;
        });
        const recentUserActions = userLogsData.filter(log => {
            const logDate = new Date(log.timestamp);
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            return logDate >= weekAgo;
        });
        totalActivities = recentTasks.length + recentUserActions.length;
        
        // ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å
        const vegStats = vegetableTypes.map(veg => {
            const vegTrays = actualTrayData.filter(t => t.veg_type === veg);
            const avgAge = vegTrays.reduce((sum, t) => {
                const age = t.time_in ? Math.floor((new Date() - new Date(t.time_in)) / (1000 * 60 * 60 * 24)) : 0;
                return sum + age;
            }, 0) / vegTrays.length || 0;
            
            return [
                veg,
                vegTrays.length,
                vegTrays.filter(t => t.status === 'on_shelf').length,
                vegTrays.filter(t => t.harvest_date).length,
                Math.round(vegTrays.reduce((sum, t) => sum + (t.plant_quantity || 0), 0)),
                Math.round(avgAge)
            ];
        });
        
        const statsSheetData = [
            ['üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏° Tray Master & Timeline Analytics', '', '', '', '', ''],
            ['‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠:', new Date().toLocaleString('th-TH'), '', '', '', ''],
            ['', '', '', '', '', ''],
            ['üéØ Key Performance Indicators', '', '', '', '', ''],
            ['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏´‡∏ô‡πà‡∏ß‡∏¢', '', '', ''],
            ['‡∏ñ‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', totalTrays, '‡∏ñ‡∏≤‡∏î', '', '', ''],
            ['‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á', inStorage, '‡∏ñ‡∏≤‡∏î', '', '', ''],
            ['‡∏ó‡∏µ‡πà Workstation', atWorkstation, '‡∏ñ‡∏≤‡∏î', '', '', ''],
            ['‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡πâ‡∏ß', harvested, '‡∏ñ‡∏≤‡∏î', '', '', ''],
            ['‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', vegetableTypes.length, '‡∏ä‡∏ô‡∏¥‡∏î', '', '', ''],
            ['', '', '', '', '', ''],
            ['üìà Activity Summary (7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)', '', '', '', '', ''],
            ['‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Tasks', recentTasks.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '', '', ''],
            ['User Actions', recentUserActions.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '', '', ''],
            ['‡∏£‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', totalActivities, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '', '', ''],
            ['', '', '', '', '', ''],
            ['üå± ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å', '', '', '', '', ''],
            ['‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏≤‡∏î', '‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á', '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡πâ‡∏ß', '‡∏ï‡πâ‡∏ô‡∏£‡∏ß‡∏°', '‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ß‡∏±‡∏ô)'],
            ...vegStats,
            ['', '', '', '', '', ''],
            ['üìã System Health', '', '', '', '', ''],
            ['API Tasks Status:', tasksResponse.ok ? '‚úÖ Connected' : '‚ùå Error', '', '', '', ''],
            ['API User Logs Status:', userLogsResponse.ok ? '‚úÖ Connected' : '‚ùå Error', '', '', '', ''],
            ['Data Completeness:', `${Math.round((actualTrayData.filter(t => t.veg_type && t.batch_id).length / totalTrays) * 100)}%`, '', '', '', '']
        ];
        
        const ws2 = XLSX.utils.aoa_to_sheet(statsSheetData);
        ws2['!cols'] = [
            { wch: 25 }, { wch: 15 }, { wch: 10 }, { wch: 12 }, { wch: 12 }, { wch: 15 }
        ];
        XLSX.utils.book_append_sheet(wb, ws2, 'Statistics & Analytics');
        
        // Sheet 3: Timeline & Activity Summary
        const timelineSheetData = [
            ['üïí Timeline & Activity Report', '', '', '', ''],
            ['Generated:', new Date().toLocaleString('th-TH'), '', '', ''],
            ['', '', '', '', ''],
            ['üìù Recent Tasks (7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)', '', '', '', ''],
            ['Task ID', 'Description', 'Tray ID', 'Status', 'Created'],
            ...recentTasks.slice(0, 20).map(task => [
                task.task_id || task.id || '',
                task.description || '',
                task.tray_id || '',
                task.status || '',
                task.created_at ? new Date(task.created_at).toLocaleString('th-TH') : ''
            ]),
            ['', '', '', '', ''],
            ['üë§ Recent User Activities (7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)', '', '', '', ''],
            ['User', 'Action', 'Description', 'Timestamp', 'IP'],
            ...recentUserActions.slice(0, 20).map(log => [
                log.username || log.user || '',
                log.action_type || '',
                log.description || '',
                log.timestamp ? new Date(log.timestamp).toLocaleString('th-TH') : '',
                log.ip_address || ''
            ])
        ];
        
        const ws3 = XLSX.utils.aoa_to_sheet(timelineSheetData);
        ws3['!cols'] = [
            { wch: 15 }, { wch: 30 }, { wch: 12 }, { wch: 12 }, { wch: 18 }
        ];
        XLSX.utils.book_append_sheet(wb, ws3, 'Timeline & Activities');
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel
        const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([excelBuffer], { 
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
        });
        
        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå (‡πÉ‡∏ä‡πâ data URL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á HTTP warning)
        const reader = new FileReader();
        const link = document.createElement('a');
        const fileName = `Tray_Master_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
        
        reader.onload = function() {
            // ‡πÉ‡∏ä‡πâ temporary window ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô data URL
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            const iframeDoc = iframe.contentDocument;
            const iframeLink = iframeDoc.createElement('a');
            iframeLink.href = reader.result;
            iframeLink.download = fileName;
            iframeDoc.body.appendChild(iframeLink);
            iframeLink.click();
            
            // ‡∏•‡∏ö iframe ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å download
            setTimeout(() => {
                document.body.removeChild(iframe);
            }, 100);
        };
        
        reader.readAsDataURL(blob);
        
        showToast("‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ 3 ‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î, ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå, Timeline ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", true);
        
    } catch (error) {
        console.error('Export Excel error:', error);
        console.log('actualTrayData structure:', actualTrayData);
        showToast(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, false);
    }
}

// ‚ú® Helper functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export
function getActionTypeIcon(actionType) {
    switch(actionType) {
        case 'inbound': return 'üì•';
        case 'outbound': return 'üì§'; 
        case 'move': return 'üîÑ';
        case 'edit': return '‚úèÔ∏è';
        case 'transfer': return 'üöö';
        case 'harvest': return 'üåæ';
        default: return '‚öôÔ∏è';
    }
}

function getActionTypeText(actionType) {
    switch(actionType) {
        case 'inbound': return '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö';
        case 'outbound': return '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö';
        case 'move': return '‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
        case 'edit': return '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        case 'transfer': return '‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢';
        case 'harvest': return '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß';
        default: return '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏∞‡∏ö‡∏ö';
    }
}

function generateActionDescription(item) {
    if (item.action_type === 'inbound') {
        return `‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î ${item.tray_id} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö - ‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å: ${item.veg_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${item.plant_quantity || 0} ‡∏ï‡πâ‡∏ô`;
    } else if (item.action_type === 'outbound') {
        return `‡πÄ‡∏ö‡∏¥‡∏Å‡∏ñ‡∏≤‡∏î ${item.tray_id} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö${item.reason ? ' - ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ' + item.reason : ''}`;
    } else if (item.action_type === 'move') {
        return `‡∏¢‡πâ‡∏≤‡∏¢‡∏ñ‡∏≤‡∏î ${item.tray_id} ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà`;
    } else if (item.action_type === 'edit') {
        return `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î ${item.tray_id}`;
    }
    return `‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ${item.action_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ñ‡∏≤‡∏î ${item.tray_id}`;
}

function calculateAge(createdAt, seedingDate) {
    if (!createdAt) return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
    
    const baseDate = seedingDate ? new Date(seedingDate) : new Date(createdAt);
    const eventDate = new Date(createdAt);
    const diffTime = Math.abs(eventDate - baseDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    return `${diffDays} ‡∏ß‡∏±‡∏ô`;
}

function getMostCommonActivity(userTimeline) {
    if (!userTimeline || userTimeline.length === 0) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    
    const activityCount = {};
    userTimeline.forEach(item => {
        const activity = item.action_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        activityCount[activity] = (activityCount[activity] || 0) + 1;
    });
    
    let mostCommon = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    let maxCount = 0;
    
    Object.keys(activityCount).forEach(activity => {
        if (activityCount[activity] > maxCount) {
            maxCount = activityCount[activity];
            mostCommon = activity;
        }
    });
    
    return getActionTypeText(mostCommon);
}

// ‚ú® Export Single Tray History to Excel (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ñ‡∏≤‡∏î)
async function exportTrayHistory() {
    try {
        // ‡∏î‡∏∂‡∏á tray ID ‡∏à‡∏≤‡∏Å modal ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
        const modalInfo = document.getElementById('historyTrayInfo');
        if (!modalInfo) {
            showToast("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", false);
            return;
        }
        
        const trayInfo = modalInfo.textContent;
        const trayId = trayInfo.split(' - ')[0]; // ‡∏î‡∏∂‡∏á tray ID ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        
        if (!trayId) {
            showToast("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Tray ID", false);
            return;
        }
        
        showToast(`üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ñ‡∏≤‡∏î ${trayId}...`, true);
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏à‡∏≤‡∏Å API ‡πÉ‡∏´‡∏°‡πà
        const response = await fetch(`/api/tray/history/${trayId}`);
        
        if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
        }
        
        const historyData = await response.json();
        console.log('Complete history data:', historyData); // Debug log
        console.log('Timeline length:', historyData.length);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å API 
        if (!historyData || historyData.length === 0) {
            showToast("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ñ‡∏≤‡∏î‡∏ô‡∏µ‡πâ", false);
            return;
        }
        
        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å task_monitor array
        const timeline = historyData;
        const currentTrayData = timeline[0] || {}; // ‡πÉ‡∏ä‡πâ record ‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á stats ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ
        const stats = {
            total_events: timeline.length,
            inbound_events: timeline.filter(t => t.action_type === 'inbound').length,
            outbound_events: timeline.filter(t => t.action_type === 'outbound').length,
            move_events: timeline.filter(t => t.action_type === 'move').length,
            edit_events: timeline.filter(t => t.action_type === 'edit').length,
            unique_operators: [...new Set(timeline.filter(t => t.username).map(t => t.username))]
        };
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Workbook ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
        const wb = XLSX.utils.book_new();
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏ñ‡∏≤‡∏î
        const ageInDays = currentTrayData.time_in ? 
            Math.floor((new Date() - new Date(currentTrayData.time_in)) / (1000 * 60 * 60 * 24)) : 0;
        
        // Sheet 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
        const trayInfoData = [
            ['üè∑Ô∏è ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ñ‡∏≤‡∏î - AGROTECH WMS', '', '', ''],
            ['', '', '', ''],
            ['üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î:', currentTrayData.tray_id || trayId, '', ''],
            ['üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:', new Date().toLocaleString('th-TH'), '', ''],
            ['‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:', `${timeline.length} ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå`, '', ''],
            ['', '', '', ''],
            ['üå± ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ñ‡∏≤‡∏î', '', '', ''],
            ['Tray ID:', currentTrayData.tray_id || '', '', ''],
            ['‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å:', currentTrayData.veg_type || '', '', ''],
            ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô:', currentTrayData.plant_quantity || '', '‡∏ï‡πâ‡∏ô', ''],
            ['Batch ID:', currentTrayData.batch_id || '', '', ''],
            ['Plan ID:', currentTrayData.plan_id || '', '', ''],
            ['', '', '', ''],
            ['üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '', '', ''],
            ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞:', currentTrayData.seeding_date ? new Date(currentTrayData.seeding_date).toLocaleDateString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', '', ''],
            ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á:', currentTrayData.time_in ? new Date(currentTrayData.time_in).toLocaleDateString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', '', ''],
            ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á:', currentTrayData.time_out ? new Date(currentTrayData.time_out).toLocaleDateString('th-TH') : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å', '', ''],
            ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß:', currentTrayData.harvest_date ? new Date(currentTrayData.harvest_date).toLocaleDateString('th-TH') : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö', '', ''],
            ['‡∏≠‡∏≤‡∏¢‡∏∏‡∏ñ‡∏≤‡∏î:', ageInDays > 0 ? `${ageInDays} ‡∏ß‡∏±‡∏ô` : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö', '', ''],
            ['', '', '', ''],
            ['üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô', '', '', ''],
            ['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:', currentTrayData.status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', '', ''],
            ['‡∏ä‡∏±‡πâ‡∏ô:', currentTrayData.floor || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', '', ''],
            ['‡∏ä‡πà‡∏≠‡∏á:', currentTrayData.slot || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', '', ''],
            ['‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ:', currentTrayData.station_id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', '', ''],
            ['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:', currentTrayData.notes || '‡πÑ‡∏°‡πà‡∏°‡∏µ', '', ''],
            ['', '', '', ''],
            ['üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏™‡∏£‡∏∏‡∏õ', '', '', ''],
            ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:', stats.total_events || 0, '‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå', ''],
            ['‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß:', stats.movement_events || 0, '‡∏Ñ‡∏£‡∏±‡πâ‡∏á', ''],
            ['‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á:', stats.task_events || 0, '‡∏á‡∏≤‡∏ô', ''],
            ['‡πÉ‡∏ö‡∏á‡∏≤‡∏ô:', stats.work_order_events || 0, '‡πÉ‡∏ö‡∏á‡∏≤‡∏ô', ''],
            ['‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:', stats.user_activity_events || 0, '‡∏Ñ‡∏£‡∏±‡πâ‡∏á', ''],
            ['‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:', stats.unique_operators ? stats.unique_operators.length : 0, '‡∏Ñ‡∏ô', '']
        ];
        
        const ws1 = XLSX.utils.aoa_to_sheet(trayInfoData);
        ws1['!cols'] = [{ wch: 25 }, { wch: 30 }, { wch: 12 }, { wch: 10 }];
        
        // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Header
        if (ws1['A1']) {
            ws1['A1'].s = { 
                font: { bold: true, sz: 16, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "2D6A4F" } },
                alignment: { horizontal: "center" }
            };
        }
        
        XLSX.utils.book_append_sheet(wb, ws1, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î');
        
        // Sheet 2: Timeline ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
        const timelineHeaders = [
            '‡πÄ‡∏ß‡∏•‡∏≤', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå', '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', 
            '‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡∏≠‡∏≤‡∏¢‡∏∏‡∏ñ‡∏≤‡∏î', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', '‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
        ];
        
        let timelineRows = [];
        
        if (timeline && timeline.length > 0) {
            timelineRows = timeline.map((item, index) => {
                const eventTime = item.created_at ? new Date(item.created_at) : new Date();
                const actionTypeIcon = getActionTypeIcon(item.action_type);
                const actionTypeText = getActionTypeText(item.action_type);
                const location = item.floor && item.slot ? `‡∏ä‡∏±‡πâ‡∏ô ${item.floor} ‡∏ä‡πà‡∏≠‡∏á ${item.slot}` : 
                                item.station_id ? `‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ ${item.station_id}` : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                return [
                    item.timestamp_th ? item.timestamp_th.split(' ')[1] : eventTime.toLocaleTimeString('th-TH'),
                    item.timestamp_th ? item.timestamp_th.split(' ')[0] : eventTime.toLocaleDateString('th-TH'),
                    actionTypeIcon + ' ' + actionTypeText,
                    item.notes || item.reason || generateActionDescription(item),
                    location,
                    item.username || '‡∏£‡∏∞‡∏ö‡∏ö',
                    item.status || '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                    calculateAge(item.created_at, currentTrayData.seeding_date),
                    item.veg_type ? `‡∏ú‡∏±‡∏Å: ${item.veg_type}` : (item.plant_quantity ? `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${item.plant_quantity} ‡∏ï‡πâ‡∏ô` : ''),
                    'Task Monitor System'
                ];
            });
        } else {
            timelineRows = [['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', '', '', '', '', '', '', '', '', '']];
        }
        
        const timelineSheetData = [
            ['‚è∞ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô - ‡∏ñ‡∏≤‡∏î ' + trayId, '', '', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', '', '', ''],
            ['üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Timeline', '', '', '', '', '', '', '', '', ''],
            ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:', stats.total_events || 0, '‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå', '', '', '', '', '', '', ''],
            ['‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Inbound:', stats.inbound_events || 0, '‡∏Ñ‡∏£‡∏±‡πâ‡∏á', '', '', '', '', '', '', ''],
            ['‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Outbound:', stats.outbound_events || 0, '‡∏Ñ‡∏£‡∏±‡πâ‡∏á', '', '', '', '', '', '', ''],
            ['‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:', stats.move_events || 0, '‡∏Ñ‡∏£‡∏±‡πâ‡∏á', '', '', '', '', '', '', ''],
            ['‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', stats.edit_events || 0, '‡∏Ñ‡∏£‡∏±‡πâ‡∏á', '', '', '', '', '', '', ''],
            ['‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:', stats.unique_operators.length || 0, '‡∏Ñ‡∏ô', '', '', '', '', '', '', ''],
            ['‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:', timeline.length > 0 ? 
                `${new Date(timeline[timeline.length-1].created_at).toLocaleDateString('th-TH')} - ${new Date(timeline[0].created_at).toLocaleDateString('th-TH')}` : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö', 
                '', '', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', '', '', ''],
            timelineHeaders,
            ...timelineRows
        ];
        
        const ws2 = XLSX.utils.aoa_to_sheet(timelineSheetData);
        ws2['!cols'] = [
            { wch: 10 }, { wch: 12 }, { wch: 18 }, { wch: 30 }, { wch: 15 },
            { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 25 }, { wch: 15 }
        ];
        
        // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Timeline Header
        if (ws2['A1']) {
            ws2['A1'].s = { 
                font: { bold: true, sz: 14, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "40916C" } },
                alignment: { horizontal: "center" }
            };
        }
        
        XLSX.utils.book_append_sheet(wb, ws2, 'Timeline ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        
        // Sheet 3: ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
        const totalActions = stats.total_events || 0;
        const totalHistory = stats.movement_events || 0;
        const totalTasks = stats.task_events || 0;
        const totalWorkOrders = stats.work_order_events || 0;
        const totalLogs = stats.user_activity_events || 0;
        
        const allOperators = stats.unique_operators || [];
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
        const avgTimePerAction = totalActions > 0 && ageInDays > 0 ? (ageInDays / totalActions).toFixed(2) : 'N/A';
        const activityFrequency = ageInDays > 0 ? (totalActions / ageInDays).toFixed(2) : '0';
        
        // ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô
        const activityByDay = {};
        timeline.forEach(item => {
            if (item.timestamp) {
                const day = new Date(item.timestamp).toLocaleDateString('th-TH', { weekday: 'long' });
                activityByDay[day] = (activityByDay[day] || 0) + 1;
            }
        });
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°
        const totalDuration = stats.first_event && stats.last_event ? 
            Math.floor((new Date(stats.last_event) - new Date(stats.first_event)) / (1000 * 60 * 60 * 24)) : 0;
        
        const analysisSheetData = [
            ['üìä ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô - ‡∏ñ‡∏≤‡∏î ' + trayId, '', '', ''],
            ['', '', '', ''],
            ['üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', '', '', ''],
            ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:', new Date().toLocaleString('th-TH'), '', ''],
            ['‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:', totalDuration > 0 ? `${totalDuration} ‡∏ß‡∏±‡∏ô` : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö', '', ''],
            ['‡∏≠‡∏≤‡∏¢‡∏∏‡∏ñ‡∏≤‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:', ageInDays > 0 ? `${ageInDays} ‡∏ß‡∏±‡∏ô` : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö', '', ''],
            ['', '', '', ''],
            ['üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°', '', '', ''],
            ['‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:', totalActions, '‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'],
            ['üöö ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß:', totalHistory, '‡∏Ñ‡∏£‡∏±‡πâ‡∏á', `${totalActions > 0 ? ((totalHistory/totalActions)*100).toFixed(1) : 0}%`],
            ['üìã ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢:', totalTasks, '‡∏á‡∏≤‡∏ô', `${totalActions > 0 ? ((totalTasks/totalActions)*100).toFixed(1) : 0}%`],
            ['üìÑ ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á:', totalWorkOrders, '‡πÉ‡∏ö‡∏á‡∏≤‡∏ô', `${totalActions > 0 ? ((totalWorkOrders/totalActions)*100).toFixed(1) : 0}%`],
            ['üë§ ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:', totalLogs, '‡∏Ñ‡∏£‡∏±‡πâ‡∏á', `${totalActions > 0 ? ((totalLogs/totalActions)*100).toFixed(1) : 0}%`],
            ['üë• ‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:', allOperators.length, '‡∏Ñ‡∏ô', ''],
            ['', '', '', ''],
            ['‚ö° ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û', '', '', ''],
            ['‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:', `${activityFrequency} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô`, '', ''],
            ['‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:', `${avgTimePerAction} ‡∏ß‡∏±‡∏ô`, '', ''],
            ['‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:', totalActions > (ageInDays * 0.5) ? 'üü¢ ‡∏™‡∏π‡∏á' : totalActions > (ageInDays * 0.2) ? 'üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : 'üî¥ ‡∏ï‡πà‡∏≥', '', ''],
            ['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:', currentTrayData.status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', '', ''],
            ['‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß:', currentTrayData.harvest_date ? '‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡πâ‡∏ß' : ageInDays > 30 ? 'üü° ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ß‡∏•‡∏≤' : '‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤', '', ''],
            ['', '', '', ''],
            ['üë• ‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '', '', ''],
            ['‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', '‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å'],
            ...allOperators.slice(0, 10).map(op => {
                const count = timeline.filter(item => item.operator === op).length;
                const percentage = totalActions > 0 ? ((count / totalActions) * 100).toFixed(1) : 0;
                const mainActivity = getMostCommonActivity(timeline.filter(item => item.operator === op));
                return [op, count, `${percentage}%`, mainActivity];
            }),
            ['', '', '', ''],
            ['üìÖ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', '', '', ''],
            ['‡∏ß‡∏±‡∏ô', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', '‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà'],
            ...Object.entries(activityByDay).map(([day, count]) => {
                const percentage = totalActions > 0 ? ((count / totalActions) * 100).toFixed(1) : 0;
                const frequency = count > (totalActions * 0.2) ? '‡∏™‡∏π‡∏á' : count > (totalActions * 0.1) ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '‡∏ï‡πà‡∏≥';
                return [day, count, `${percentage}%`, frequency];
            }),
            ['', '', '', ''],
            ['üéØ ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞', '', '', ''],
            ageInDays > 45 ? ['‚ö†Ô∏è ‡∏ñ‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', '', '', ''] : ['‚úÖ ‡∏ñ‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°', '', '', ''],
            !currentTrayData.harvest_date && ageInDays > 30 ? ['üîî ‡∏Ñ‡∏ß‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÉ‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ', '', '', ''] : ['', '', '', ''],
            totalActions === 0 ? ['üìù ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° - ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏≤‡∏î', '', '', ''] : ['', '', '', ''],
            activityFrequency < 0.1 ? ['‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡πà‡∏≥ - ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', '', '', ''] : ['', '', '', ''],
            allOperators.length > 5 ? ['üë• ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô - ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô', '', '', ''] : ['', '', '', ''],
            totalHistory === 0 ? ['üö® ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö', '', '', ''] : ['', '', '', ''],
            ['', '', '', ''],
            ['üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠', '', '', ''],
            ['‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:', 'tray_history', totalHistory > 0 ? '‚úÖ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', ''],
            ['‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô:', 'task_monitor', totalTasks > 0 ? '‚úÖ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', ''],
            ['‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô:', 'work_orders', totalWorkOrders > 0 ? '‚úÖ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', ''],
            ['‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:', 'user_logs', totalLogs > 0 ? '‚úÖ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', ''],
            ['‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', `${Math.round(((totalHistory + totalTasks + totalWorkOrders + totalLogs) / Math.max(1, 4)) * 100)}%`, '', ''],
            ['‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤:', stats.first_event && stats.last_event ? '‚úÖ ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' : '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå', '', '']
        ];
        
        // ‡∏ï‡∏±‡∏î‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô '‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel
        const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([excelBuffer], { 
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
        });
        
        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå (‡πÉ‡∏ä‡πâ data URL ‡πÅ‡∏ó‡∏ô blob URL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á HTTP warning)
        const link = document.createElement('a');
        const reader = new FileReader();
        const fileName = `Tray_${trayId}_FullReport_${new Date().toISOString().split('T')[0]}.xlsx`;
        
        reader.onload = function() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á temporary link ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏•‡∏á‡πÉ‡∏ô DOM
            link.href = reader.result; // data URL
            link.download = fileName;
            link.style.display = 'none';
            link.click();
        };
        
        reader.readAsDataURL(blob);
        
        showToast(`‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ñ‡∏≤‡∏î ${trayId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏°‡∏µ 2 ‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î, Timeline ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`, true);
        
    } catch (error) {
        console.error('Export tray history error:', error);
        showToast(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, false);
    }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß - ‡πÉ‡∏ä‡πâ SheetJS ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á

// ‚ú® Excel Formatting Functions
function formatTrayMasterSheet(ws, data) {
    // Set column widths
    ws['!cols'] = [
        { wch: 12 }, // Tray ID
        { wch: 15 }, // ‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å
        { wch: 10 }, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô
        { wch: 12 }, // Batch ID
        { wch: 12 }, // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞
        { wch: 10 }, // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        { wch: 8 },  // ‡∏ä‡∏±‡πâ‡∏ô
        { wch: 8 },  // ‡∏ä‡πà‡∏≠‡∏á
        { wch: 12 }, // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á
        { wch: 12 }, // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á
        { wch: 12 }, // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß
        { wch: 10 }, // ‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏ß‡∏±‡∏ô)
        { wch: 20 }, // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
        { wch: 12 }  // Plan ID
    ];
    
    // Header row styling (row 1)
    const headerCells = ['A1', 'B1', 'C1', 'D1', 'E1', 'F1', 'G1', 'H1', 'I1', 'J1', 'K1', 'L1', 'M1', 'N1'];
    headerCells.forEach(cell => {
        if (ws[cell]) {
            ws[cell].s = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "4472C4" } },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                    top: { style: "thin" },
                    bottom: { style: "thin" },
                    left: { style: "thin" },
                    right: { style: "thin" }
                }
            };
        }
    });
}

function formatStatisticsSheet(ws, data) {
    ws['!cols'] = [
        { wch: 25 }, // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        { wch: 15 }, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
        { wch: 15 }, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        { wch: 15 }, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        { wch: 15 }  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    ];
    
    // Title styling
    if (ws['A1']) {
        ws['A1'].s = {
            font: { bold: true, size: 16, color: { rgb: "1F4E79" } },
            alignment: { horizontal: "left" }
        };
    }
    
    // Section headers
    const sectionHeaders = ['A4', 'A12'];
    sectionHeaders.forEach(cell => {
        if (ws[cell]) {
            ws[cell].s = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "70AD47" } },
                alignment: { horizontal: "center" }
            };
        }
    });
}

function formatSummarySheet(ws, data) {
    ws['!cols'] = [
        { wch: 30 }, // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        { wch: 15 }, // ‡∏Ñ‡πà‡∏≤
        { wch: 10 }, // ‡∏´‡∏ô‡πà‡∏ß‡∏¢
        { wch: 15 }  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    ];
    
    // Dashboard title
    if (ws['A1']) {
        ws['A1'].s = {
            font: { bold: true, size: 18, color: { rgb: "C55A11" } },
            alignment: { horizontal: "left" }
        };
    }
    
    // KPI section
    if (ws['A4']) {
        ws['A4'].s = {
            font: { bold: true, size: 14, color: { rgb: "1F4E79" } },
            fill: { fgColor: { rgb: "E7E6E6" } }
        };
    }
}

function formatTimelineSheet(ws, data) {
    ws['!cols'] = [
        { wch: 10 }, // ‡πÄ‡∏ß‡∏•‡∏≤
        { wch: 12 }, // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        { wch: 20 }, // ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
        { wch: 15 }, // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á
        { wch: 15 }, // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
        { wch: 15 }, // ‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
        { wch: 12 }, // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        { wch: 25 }  // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
    ];
    
    // Timeline header
    if (ws['A1']) {
        ws['A1'].s = {
            font: { bold: true, size: 16, color: { rgb: "FFFFFF" } },
            fill: { fgColor: { rgb: "E74C3C" } },
            alignment: { horizontal: "center" }
        };
    }
    
    // Column headers (row 4)
    const timelineHeaders = ['A4', 'B4', 'C4', 'D4', 'E4', 'F4', 'G4', 'H4'];
    timelineHeaders.forEach(cell => {
        if (ws[cell]) {
            ws[cell].s = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "3498DB" } },
                alignment: { horizontal: "center" },
                border: {
                    top: { style: "thin" },
                    bottom: { style: "thin" },
                    left: { style: "thin" },
                    right: { style: "thin" }
                }
            };
        }
    });
}

function formatAnalysisSheet(ws, data) {
    ws['!cols'] = [
        { wch: 30 }, // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        { wch: 20 }, // ‡∏Ñ‡πà‡∏≤
        { wch: 15 }  // ‡∏´‡∏ô‡πà‡∏ß‡∏¢
    ];
    
    // Analysis title
    if (ws['A1']) {
        ws['A1'].s = {
            font: { bold: true, size: 16, color: { rgb: "FFFFFF" } },
            fill: { fgColor: { rgb: "9B59B6" } },
            alignment: { horizontal: "center" }
        };
    }
    
    // Section headers
    const analysisHeaders = ['A4', 'A9', 'A12', 'A17'];
    analysisHeaders.forEach(cell => {
        if (ws[cell]) {
            ws[cell].s = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "16A085" } },
                alignment: { horizontal: "left" }
            };
        }
    });
}


// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
function renderTrayStatusLabel(status) {
    if (status === 'on_shelf' || status === 'IN_STORAGE') {
        return `<span class="status-badge on-shelf"><i class="fas fa-warehouse"></i> ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</span>`;
    }
    if (status === 'AT_WORKSTATION') {
        return `<span class="status-badge at-workstation"><i class="fas fa-wrench"></i> ‡∏ó‡∏µ‡πà Workstation</span>`;
    }
    return status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
}

// ‚ú® Premium Stats Update Function
function updateTrayMasterStats(allTrays, filteredTrays) {
    const totalTrays = allTrays.length;
    const inStorage = allTrays.filter(t => t.status === 'on_shelf').length;
    const atWorkstation = allTrays.filter(t => t.status === 'AT_WORKSTATION').length;
    const uniqueVegetables = [...new Set(allTrays.map(t => t.veg_type))].length;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DOM elements
    const totalEl = document.getElementById('totalTraysCount');
    const storageEl = document.getElementById('inStorageCount');
    const workstationEl = document.getElementById('atWorkstationCount');
    const vegetableEl = document.getElementById('uniqueVegetableCount');

    if (totalEl) totalEl.textContent = totalTrays.toLocaleString();
    if (storageEl) storageEl.textContent = inStorage.toLocaleString();
    if (workstationEl) workstationEl.textContent = atWorkstation.toLocaleString();
    if (vegetableEl) vegetableEl.textContent = uniqueVegetables.toLocaleString();
}

// ‚ú® Premium Status Label Function
function renderPremiumTrayStatusLabel(status) {
    const statusConfig = {
        'on_shelf': { 
            color: '#10b981', 
            bg: '#d1fae5', 
            icon: 'fas fa-warehouse',
            text: '‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á'
        },
        'AT_WORKSTATION': { 
            color: '#f59e0b', 
            bg: '#fef3c7', 
            icon: 'fas fa-cogs',
            text: '‡∏ó‡∏µ‡πà Workstation'
        },
        'IN_STORAGE': { 
            color: '#3b82f6', 
            bg: '#dbeafe', 
            icon: 'fas fa-box',
            text: '‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á'
        }
    };

    const config = statusConfig[status] || { 
        color: '#6b7280', 
        bg: '#f3f4f6', 
        icon: 'fas fa-question',
        text: status 
    };

    return `
        <div class="premium-status-badge" style="
            color: ${config.color}; 
            background: ${config.bg}; 
            border: 1px solid ${config.color}20;
        ">
            <i class="${config.icon}"></i>
            <span>${config.text}</span>
        </div>
    `;
}

// ‚ú® Vegetable Options Data
const vegetableOptions = [
    'Baby Kale', 'Baby Spinach', 'Baby Red Oak', 'Baby Rocket', 'Baby Swiss Chard',
    '‡∏ö‡∏±‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏Æ‡∏î', '‡∏™‡∏•‡∏±‡∏î‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ', '‡∏ã‡∏≤‡∏•‡∏≤‡πÇ‡∏ô‡∏ß‡∏≤', '‡∏Å‡∏£‡∏µ‡∏ô‡∏Ñ‡∏≠‡∏™', '‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏≠‡πä‡∏Ñ',
    '‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏≠‡∏•', '‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ', '‡πÄ‡∏£‡∏î‡πÇ‡∏Ñ‡∏£‡∏≠‡∏•', '‡∏ü‡∏¥‡∏•‡πÑ‡∏≠‡∏ã‡πå', '‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏•', '‡πÄ‡∏Ñ‡∏•',
    '‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏≠‡πã', '‡∏™‡∏ß‡∏¥‡∏™‡∏ä‡∏≤‡∏£‡πå‡∏î', '‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡πÅ‡∏Å‡πâ‡∏ß', '‡∏ú‡∏±‡∏Å‡πÄ‡∏ö‡∏ã‡∏¥‡∏•', '‡∏™‡∏•‡∏±‡∏î‡∏ú‡∏™‡∏°'
];

// ‚ú® Filter Vegetable Options Function
function filterVegetableOptions(query) {
    const suggestionsEl = document.getElementById('vegetableSuggestions');
    if (!suggestionsEl) return;

    if (!query.trim()) {
        suggestionsEl.style.display = 'none';
        return;
    }

    // Get unique tray IDs and vegetable types from current data
    const allTrays = Object.values(trayInventory || {});
    const trayOptions = [...new Set([
        ...allTrays.map(tray => tray.tray_id),
        ...allTrays.map(tray => tray.veg_type)
    ])];

    const filtered = trayOptions.filter(option => 
        option && option.toLowerCase().includes(query.toLowerCase())
    );

    if (filtered.length === 0) {
        suggestionsEl.style.display = 'none';
        return;
    }

    suggestionsEl.innerHTML = filtered.map(option => `
        <div class="suggestion-item" onclick="selectVegetable('${option}')">
            <i class="fas ${option.startsWith('T') ? 'fa-box' : 'fa-leaf'}"></i>
            <span>${option}</span>
        </div>
    `).join('');

    suggestionsEl.style.display = 'block';
}

// ‚ú® Select Vegetable Function
function selectVegetable(vegetable) {
    const filterInput = document.getElementById('trayVegFilter');
    const suggestionsEl = document.getElementById('vegetableSuggestions');
    
    if (filterInput) {
        filterInput.value = vegetable;
        loadTrayMasterData();
    }
    
    if (suggestionsEl) {
        suggestionsEl.style.display = 'none';
    }
}

// ‚ú® Close suggestions when clicking outside
document.addEventListener('click', function(e) {
    const searchableSelect = e.target.closest('.premium-searchable-select');
    if (!searchableSelect) {
        const suggestions = document.getElementById('vegetableSuggestions');
        if (suggestions) {
            suggestions.style.display = 'none';
        }
    }
});

// ‚ú® Delete Tray Function - Show Premium Modal
async function deleteTray(trayId) {
    // Find tray data
    const tray = Object.values(trayInventory).find(t => t.tray_id === trayId);
    if (!tray) {
        showToast("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î", false);
        return;
    }

    // Populate modal with tray information
    document.getElementById('deleteTrayId').textContent = tray.tray_id;
    document.getElementById('deleteTrayVeg').textContent = tray.veg_type || '-';
    document.getElementById('deleteTrayLocation').textContent = `‡∏ä‡∏±‡πâ‡∏ô ${tray.floor} / ‡∏ä‡πà‡∏≠‡∏á ${tray.slot}`;
    
    // Store tray ID for confirmation
    window.currentDeleteTrayId = trayId;
    
    // Show modal
    document.getElementById('deleteTrayModal').style.display = 'flex';
}

// ‚ú® Close Delete Modal
function closeDeleteModal() {
    document.getElementById('deleteTrayModal').style.display = 'none';
    window.currentDeleteTrayId = null;
}

// ‚ú® Confirm Delete Tray
async function confirmDeleteTray() {
    const trayId = window.currentDeleteTrayId;
    if (!trayId) return;

    try {
        const response = await fetch(`/api/tray-inventory/${trayId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast("‚úÖ ‡∏•‡∏ö‡∏ñ‡∏≤‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", true);
            closeDeleteModal();
            loadTrayMasterData(); // Reload data
        } else {
            showToast(`‚ùå ${result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, false);
        }
    } catch (error) {
        showToast("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", false);
        console.error('Delete tray error:', error);
    }
}


let workstationTimer = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö interval
let currentWorkstationState = null; // ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Workstation
// ‚úÖ‚úÖ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Workstation ‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ ‚úÖ‚úÖ‚úÖ
async function checkWorkstationStatus() {
    try {
        const res = await fetch(`/api/workstation/current?station=${currentStation}`);
        const waitingTray = await res.json();
        const displayDiv = document.getElementById('workstationDisplay');

        if (!displayDiv) return;

        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ñ‡∏≤‡∏î (‡∏°‡∏µ ID ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô null)
        const newState = waitingTray ? waitingTray.tray_id : null;

        // 2. ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏ß‡πâ
        if (newState === currentWorkstationState) {
            // 3. ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° -> ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            return; 
        }

        // 4. ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô -> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏ß‡πâ
        currentWorkstationState = newState;

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) ---
        if (waitingTray) {
            const reason = waitingTray.reason || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
            let actionHTML = '';

            switch (reason.toLowerCase()) {
                case '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á':
                    actionHTML = `<button class="form-button-action danger" onclick="disposeTray('${waitingTray.tray_id}')"><i class="fas fa-trash-alt"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á</button>`;
                    break;
                case '‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡∏≤‡∏î':
                    actionHTML = `<button class="form-button-action" style="background: linear-gradient(135deg, #60A5FA, #3B82F6);" onclick="returnTrayToStorage('relocate')"><i class="fas fa-random"></i> ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</button>`;
                    break;
                default:
                    actionHTML = `
                        <div class="popup-actions">
                            <button class="popup-button cancel" onclick="disposeTray('${waitingTray.tray_id}')"><i class="fas fa-check-circle"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å)</button>
                            <button class="popup-button confirm" onclick="returnTrayToStorage('return')"><i class="fas fa-arrow-left"></i> ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</button>
                        </div>`;
                    break;
            }

            displayDiv.innerHTML = `
                <div class="popup-container" style="max-width: 700px; margin: 20px auto; animation: popIn 0.4s ease-out;">
                    <div class="popup-header">
                        <i class="fas fa-box-open icon" style="color: #FBBF24;"></i>
                        <h2 class="popup-title">‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h2>
                        <p class="popup-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ñ‡∏≤‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ</p>
                    </div>
                    <div class="popup-summary">
                        <div class="summary-item"><span class="summary-label">Tray ID</span><span class="summary-value">${waitingTray.tray_id}</span></div>
                        <div class="summary-item"><span class="summary-label">‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</span><span class="summary-value highlight">${waitingTray.veg_type || 'N/A'}</span></div>
                        <div class="summary-item"><span class="summary-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å</span><span class="summary-value" style="font-weight: 700;">${reason}</span></div>
                    </div>
                    <div class="popup-actions" style="grid-template-columns: 1fr; margin-top: 25px;">${actionHTML}</div>
                </div>
            `;
        } else {
            displayDiv.innerHTML = `
                <div class="agv-status-box" style="--boxColor: #6c757d; margin-top: 20px;">
                    <div class="agv-status-title"><i class="fas fa-pause-circle"></i> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>
                    <div class="agv-status-desc">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏µ‡πà Home ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
                </div>
            `;
        }

    } catch(err) {
        console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Workstation ‡πÑ‡∏î‡πâ", err);
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î error ‡∏Å‡πá‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô
        currentWorkstationState = 'error'; // ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ß‡∏ô‡∏ã‡πâ‡∏≥‡∏ñ‡πâ‡∏≤ error ‡∏ï‡∏•‡∏≠‡∏î
    }
}





// ‚úÖ‚úÖ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö tray_id ‡πÄ‡∏õ‡πá‡∏ô parameter ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‚úÖ‚úÖ‚úÖ
async function disposeTray(tray_id) {
    if (!tray_id) {
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Tray ID', false);
        return;
    }

    showConfirmationPopup({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ñ‡∏≤‡∏î',
        subtitle: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î ID: ${tray_id} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`,
        icon: 'fa-trash-alt', // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞
        details: [
            { label: 'Tray ID ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö', value: tray_id, highlight: true },
            { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', value: '‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£' }
        ],
        onConfirm: async () => {
            try {
                await fetch('/api/workstation/dispose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tray_id: tray_id, station_id: currentStation })
                });
                showToast(`‚úÖ ‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î ID: ${tray_id} ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß`, true);
                checkWorkstationStatus(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            } catch(err) {
                showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏≠‡∏≠‡∏Å', false);
            }
        }
    });
}

// ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô editTray ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
async function editTray(trayId) {
    // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏à‡∏≤‡∏Å trayInventory ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    const tray = Object.values(trayInventory).find(t => t.tray_id === trayId);
    if (!tray) {
        showToast("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î", false);
        return;
    }

    // ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏á Modal
    document.getElementById("editTrayId").value = tray.tray_id;
    document.getElementById("editVegType").value = tray.veg_type || '';
    document.getElementById("editPlantQuantity").value = tray.plant_quantity || '';
    document.getElementById("editBatchId").value = tray.batch_id || '';
    // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ input type="date" ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ (YYYY-MM-DD)
    document.getElementById("editSeedingDate").value = tray.seeding_date ? new Date(tray.seeding_date).toISOString().split('T')[0] : '';
    document.getElementById("editNotes").value = tray.notes || '';

    // ‡πÅ‡∏™‡∏î‡∏á Modal
    document.getElementById("editTrayModal").style.display = 'flex';
}

// ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal
function closeEditModal() {
    document.getElementById("editTrayModal").style.display = 'none';
}

// ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ Backend
async function handleUpdateTray() {
    const trayId = document.getElementById("editTrayId").value;
    const updatedData = {
        veg_type: document.getElementById("editVegType").value,
        plant_quantity: document.getElementById("editPlantQuantity").value,
        batch_id: document.getElementById("editBatchId").value,
        seeding_date: document.getElementById("editSeedingDate").value,
        notes: document.getElementById("editNotes").value
    };

    try {
        const res = await fetch(`/api/tray-inventory/${trayId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData)
        });
        const result = await res.json();

        if (result.error) {
            showToast(`‚ùå ${result.error}`, false);
        } else {
            showToast(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, true);
            
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î
            const changes = [];
            if (updatedData.veg_type) changes.push(`‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å: ${updatedData.veg_type}`);
            if (updatedData.plant_quantity) changes.push(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô: ${updatedData.plant_quantity}`);
            if (updatedData.batch_id) changes.push(`Batch: ${updatedData.batch_id}`);
            if (updatedData.seeding_date) changes.push(`‡∏ß‡∏±‡∏ô‡∏´‡∏ß‡πà‡∏≤‡∏ô: ${updatedData.seeding_date}`);
            const changeText = changes.length > 0 ? ` (${changes.join(', ')})` : '';
            
            logAction(currentUser.username, `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î ${trayId}${changeText}`, 'tray_edit', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            
            closeEditModal();
            loadTrayMasterData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            loadTrayInventory();  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Grid View ‡∏î‡πâ‡∏ß‡∏¢
        }
    } catch(err) {
        showToast("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï", false);
    }
}




let returnTrayData = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô
async function returnTrayToStorage(mode = 'return') {
    const res = await fetch(`/api/workstation/current?station=${currentStation}`);
    const waitingTray = await res.json();
    
    if (!waitingTray) {
        showToast("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà Workstation", false);
        return;
    }

    const modal = document.getElementById('returnTrayModal');
    const titleElement = modal.querySelector('.popup-title');
    const confirmButton = modal.querySelector('.popup-button.confirm');

    const qtyInput = document.getElementById("returnPlantQuantity");
    const dateInput = document.getElementById("returnSeedingDate");
    const notesInput = document.getElementById("returnNotes");

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Title ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
    if (mode === 'relocate') {
        titleElement.innerHTML = `<i class="fas fa-random icon" style="color:#60A5FA;"></i> ‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡∏≤‡∏î`;
        confirmButton.innerHTML = `<i class="fas fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á`;
        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        [qtyInput, dateInput, notesInput].forEach(el => {
            el.disabled = true;
            el.style.backgroundColor = '#e9ecef';
            el.style.cursor = 'not-allowed';
        });
    } else { 
        titleElement.innerHTML = `<i class="fas fa-arrow-left icon"></i> ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á`;
        confirmButton.innerHTML = `<i class="fas fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö`;
        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        [qtyInput, dateInput, notesInput].forEach(el => {
            el.disabled = false;
            el.style.backgroundColor = '';
            el.style.cursor = '';
        });
    }

    // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    document.getElementById("returnVegType").value = waitingTray.veg_type || '';
    qtyInput.value = waitingTray.plant_quantity || '';
    document.getElementById("returnBatchId").value = waitingTray.batch_id || '';
    dateInput.value = waitingTray.seeding_date ? new Date(waitingTray.seeding_date).toISOString().split('T')[0] : '';
    notesInput.value = waitingTray.notes || '';
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ onclick ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    confirmButton.setAttribute('onclick', `handleReturnToStorage('${waitingTray.tray_id}', ${waitingTray.station_id})`);
    
    modal.style.display = 'flex';
}

async function handleReturnToStorage(tray_id, station_id) {
    if (!tray_id) {
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Tray ID ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö', false);
        return;
    }

    // 1. ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
    const newFloor = document.getElementById('returnFloor').value;
    const newSlot = document.getElementById('returnSlot').value;
    const dataToSend = {
        tray_id: tray_id,
        veg_type: document.getElementById("returnVegType").value,
        quantity: document.getElementById("returnPlantQuantity").value,
        batch_id: document.getElementById("returnBatchId").value,
        seeding_date: document.getElementById("returnSeedingDate").value,
        notes: document.getElementById("returnNotes").value,
        floor: newFloor,
        slot: newSlot,
        username: localStorage.getItem("username"),
        station: currentStation,
    };
    
    try {
        // 2. ‚úÖ [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà Workstation ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Flow State ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 'idle'
        const completeRes = await fetch('/api/workstation/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                tray_id: tray_id, 
                station_id: station_id || currentStation 
            })
        });

        if (!completeRes.ok) {
            const errData = await completeRes.json();
            throw new Error(errData.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà Workstation ‡πÑ‡∏î‡πâ');
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Delay ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Server ‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï State
        await new Promise(resolve => setTimeout(resolve, 200));

        // 3. ‚úÖ [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö idle ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∂‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏° Flow ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏Å‡∏•‡∏±‡∏ö (Inbound)
        const inboundRes = await fetch("/api/tray/inbound", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dataToSend)
        });
        const result = await inboundRes.json();
        
        if (result.error) {
           showToast(`‚ùå ${result.error}`, false);
        } else {
           showToast(`‚úÖ ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡πà‡∏á‡∏ñ‡∏≤‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß...`, true);
           closeReturnModal();
           refreshDataAndViews();
           checkWorkstationStatus(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Workstation
           loadTrayInventory();    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á
        }
    } catch (err) {
        console.error("‚ùå Error during return to storage:", err);
        showToast(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ñ‡∏≤‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ: ${err.message}`, false);
    }
}

function closeReturnModal() {
    document.getElementById('returnTrayModal').style.display = 'none';
}



async function refreshDataAndViews() {

  try {
    // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÜ ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
    //    ‡πÉ‡∏ä‡πâ Promise.all ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
    await Promise.all([
      loadTrayInventory(),
      loadTrayMasterData() // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Tray Master ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏¢
    ]);

    // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÜ
    //    ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Error ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    if (currentPage === 'tray-map') {
      renderTrayGrid();
    } else if (currentPage === 'tray-master') {
      // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ loadTrayMasterData() ‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
    } else if (currentPage === 'workstation') {
      checkWorkstationStatus();
    } else if (currentPage === 'tray-outbound') {
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
      validateOutboundFloor();
    } else if (currentPage === 'planting-plan' && window.currentPlantingTab === 'in-progress') {
      // (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏°‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
      loadInProgressPlantingTasks();
    }


  } catch (err) {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", err);
    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
  }
}



// ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å
let selectedOutboundTray = null;
// ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Inbound
function validateInboundSlot() {
    const floor = safeGetElementValue("inFloor");
    const slot = safeGetElementValue("inSlot");
    const statusDiv = document.getElementById("inboundSlotStatus");
    const confirmBtn = document.getElementById("inboundConfirmBtn");

    if (!floor || !slot) {
        statusDiv.innerHTML = "";
        confirmBtn.disabled = true; // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
        return;
    }

    const key = `${floor}-${slot}`;
    if (trayInventory[key] && trayInventory[key].status === 'on_shelf') {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á ---
        statusDiv.innerHTML = `
            <div style="padding: 14px; background: #fffbeb; color: #b45309; border-left: 5px solid #facc15; border-radius: 8px; font-weight: 600;">
                ‚ö†Ô∏è ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏ß‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
            </div>`;
        confirmBtn.disabled = true;
    } else {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ---
        statusDiv.innerHTML = `
            <div style="padding: 14px; background: #f0fdf4; color: #166534; border-left: 5px solid #4ade80; border-radius: 8px; font-weight: 600;">
                ‚úÖ ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤‡∏á ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡πÑ‡∏î‡πâ
            </div>`;
        confirmBtn.disabled = false;
    }
}
// ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô
function validateOutboundFloor() {
    const selectedFloor = safeGetElementValue("outFloor");
    const validationBox = document.getElementById("outboundValidationBox");
    const confirmBtn = document.getElementById("outboundConfirmBtn");
    const reasonSelect = document.getElementById("outReason");
    const destinationInput = document.getElementById("outDestination");

    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏±‡πâ‡∏ô
    selectedOutboundTray = null;
    validationBox.style.display = 'none';
    validationBox.innerHTML = '';
    confirmBtn.disabled = true;
    reasonSelect.disabled = true;
    destinationInput.disabled = true;

    if (!selectedFloor) return; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ñ‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 'on_shelf'
    const traysOnFloor = Object.values(trayInventory).filter(
        tray => tray.floor == selectedFloor && tray.status === 'on_shelf'
    );

    validationBox.style.display = 'block';

    if (traysOnFloor.length === 0) {
        // ---- ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ñ‡∏≤‡∏î‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏±‡πâ‡∏ô ----
        validationBox.innerHTML = `
            <div class="warning-message" style="background: #fffbeb; color: #b45309; border-left-color: #fde68a;">
                <i class="fas fa-eye"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô ${selectedFloor}
            </div>
        `;
        return;
    }

    // ---- ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏à‡∏≠‡∏ñ‡∏≤‡∏î -> ‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏Ç‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î) ----
    const frontTray = traysOnFloor.reduce((prev, curr) => (prev.slot < curr.slot ? prev : curr));
    selectedOutboundTray = frontTray; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ

    const formattedDate = new Date(frontTray.time_in).toLocaleDateString('th-TH');
    validationBox.innerHTML = `
        <div style="background-color: #f0fdf4; padding: 15px; border-radius: 12px; border: 1px solid #bbf7d0; color: #166534; font-weight: 600;">
            <i class="fas fa-check-circle"></i> ‡∏û‡∏ö‡∏ñ‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î: <strong>${frontTray.veg_type}</strong> (‡∏ä‡πà‡∏≠‡∏á ${frontTray.slot})<br>
            <small>‡∏ß‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formattedDate}</small>
        </div>
    `;

    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏î‡πâ
    confirmBtn.disabled = false;
    reasonSelect.disabled = false;
    destinationInput.disabled = false;
}





// =======================================================================
// ‚ú® [FINAL & CORRECTED] LIGHT CONTROL JAVASCRIPT ‚ú®
// =======================================================================

/**
 * üí° [REBUILT] ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤ Light Control ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡∏Å Event ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏ü
 */
function renderLightControlPage() {
    let html = `
        <div class="light-control-container light-control-page-theme">
            <div class="light-control-header-new">
    <div class="header-content-new">
        <div class="header-icon-new">
            <i class="fas fa-lightbulb"></i>
            <div class="icon-glow-new"></div>
        </div>
        <div class="header-text-new">
            <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á</h1>
            <p>Light & Fan Control System</p>
        </div>
    </div>
    <div class="status-badge-new">
        <div class="status-dot-new"></div>
        <span>Real-time</span>
    </div>
</div>
            <div class="global-control-card">
                 <div class="card-title"><i class="fas fa-globe-asia"></i>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div class="global-actions">
                    <button class="global-power-btn on" onclick="openBatchScheduleModal()"><i class="fas fa-calendar-alt"></i><span>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span></button>
                    <button class="global-power-btn" style="background: #64748b; color: white;" onclick="clearAllSchedules()"><i class="fas fa-trash-alt"></i><span>‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span></button>
                </div>
            </div>
            <div class="floor-grid">
    `;

    for (let i = 1; i <= 5; i++) {
        html += `
            <div class="floor-card" id="floor-card-${i}">
                <div class="floor-title">
                    <h3><i class="fas fa-layer-group"></i>‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà ${i}</h3>
                    <div class="floor-title-actions">
                        <label class="toggle-switch">
                            <input type="checkbox" id="floor-power-${i}" onchange="handleMasterToggleChange(${i}, this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="floor-controls">
                    ${createControlRow('light-white', i, 'fa-sun', '#f59e0b')}
                    ${createControlRow('light-red', i, 'fa-atom', 'var(--lc-accent-red)')}
                    ${createControlRow('fan', i, 'fa-fan', 'var(--lc-accent-blue)')}
                </div>
                <div style="padding-top: 15px; margin-top: 15px; border-top: 1px solid rgba(13, 148, 136, 0.1);">
                    <button class="global-power-btn on" id="floor-confirm-btn-${i}" onclick="confirmFloorChanges(${i})" disabled>
                        <i class="fas fa-check-circle"></i>
                        <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πâ‡∏ô ${i}</span>
                    </button>
                </div>
            </div>
        `;
    }

    html += `</div></div>`;
    document.getElementById("mainContent").innerHTML = html;
    startLightControlPolling();
}

/**
 * üí° Helper ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°, onchange ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å markFloorAsChanged
 */
function createControlRow(type, floor, icon, color) {
    return `
        <div class="control-row">
            <i class="fas ${icon} control-icon" style="color: ${color};"></i>
            <div class="slider-container">
                <input type="range" min="0" max="100" value="0" class="premium-slider device-slider"
                       onchange="markFloorAsChanged(${floor})"
                       oninput="updateSliderVisual(this, '${type}', ${floor})"
                       data-floor="${floor}" data-type="${type}" style="--fill-color: ${color};">
            </div>
            <span class="control-value" id="${type}-value-${floor}">0%</span>
            <button class="control-timer-btn" onclick="openIndividualTimerModal('${type}', ${floor})">
                <i class="fas fa-clock"></i>
            </button>
        </div>
    `;
}

/**
 * üí° ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á Slider ‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏Å (Visual Only)
 */
function updateSliderVisual(slider, type, floor) {
    const valueDisplay = document.getElementById(`${type}-value-${floor}`);
    if (valueDisplay) {
        const percentage = slider.value + '%';
        valueDisplay.textContent = percentage;
        slider.style.setProperty('--value', percentage);
    }
}

/**
 * üí° ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠ Master Toggle ‡∏ñ‡∏π‡∏Å‡∏Å‡∏î
 */
function handleMasterToggleChange(floorIndex, isChecked) {
    const intensity = isChecked ? 75 : 0;
    ['light-white', 'light-red', 'fan'].forEach(type => {
        const slider = document.querySelector(`input[data-floor="${floorIndex}"][data-type="${type}"]`);
        if (slider) {
            slider.value = intensity;
            updateSliderVisual(slider, type, floorIndex);
        }
    });
    markFloorAsChanged(floorIndex);
}

/**
 * üí° ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
 */
function markFloorAsChanged(floorIndex) {
    const confirmBtn = document.getElementById(`floor-confirm-btn-${floorIndex}`);
    if (confirmBtn) {
        // ‚ú® ‡∏à‡∏∏‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô disabled ‡πÄ‡∏õ‡πá‡∏ô false ‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" ‡∏õ‡∏∏‡πà‡∏°
        confirmBtn.disabled = false;
        confirmBtn.style.background = '#f97316'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏™‡πâ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏µ pending changes
        confirmBtn.querySelector('span').textContent = `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á`;
    }
}

/**
 * üí° ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" ‡∏Ç‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô
 */
function confirmFloorChanges(floorIndex) {
    const whiteValue = document.querySelector(`input[data-floor="${floorIndex}"][data-type="light-white"]`).value;
    const redValue = document.querySelector(`input[data-floor="${floorIndex}"][data-type="light-red"]`).value;
    const fanValue = document.querySelector(`input[data-floor="${floorIndex}"][data-type="fan"]`).value;

    showConfirmationPopup({
        title: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πâ‡∏ô ${floorIndex}`,
        subtitle: '‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
        icon: 'fa-cogs',
        details: [
            { label: 'üí° ‡πÑ‡∏ü‡∏Ç‡∏≤‡∏ß (White LED)', value: `${whiteValue}%`, highlight: true },
            { label: 'üí° ‡πÑ‡∏ü‡πÅ‡∏î‡∏á (Red LED)', value: `${redValue}%`, highlight: true },
            { label: 'üí® ‡∏û‡∏±‡∏î‡∏•‡∏° (Fan)', value: `${fanValue}%`, highlight: true },
        ],
        onConfirm: () => executeFloorChanges(floorIndex, { whiteValue, redValue, fanValue })
    });
}

/**
 * üí° ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô Pop-up ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
 */
async function executeFloorChanges(floorIndex, values) {
    showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πâ‡∏ô ${floorIndex}...`, true);
    clearActiveTimers();

    // --- ‚ú® [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏¥‡∏ß ‚ú® ---
    const commands = [
        sendLightCommand(floorIndex, 'light-white', values.whiteValue),
        sendLightCommand(floorIndex, 'light-red', values.redValue),
        sendLightCommand(floorIndex, 'fan', values.fanValue)
    ];

    try {
        // Promise.all ‡∏à‡∏∞‡∏¢‡∏¥‡∏á API ‡∏ó‡∏±‡πâ‡∏á 3 ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà Backend ‡∏à‡∏∞‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏≠‡∏á
        await Promise.all(commands);
        showToast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πâ‡∏ô ${floorIndex} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`, true);
        
        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏ö‡∏ö manual
        logAction(currentUser.username, `‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πâ‡∏ô ${floorIndex}: ‡πÑ‡∏ü‡∏Ç‡∏≤‡∏ß ${values.whiteValue}%, ‡πÑ‡∏ü‡πÅ‡∏î‡∏á ${values.redValue}%, ‡∏û‡∏±‡∏î‡∏•‡∏° ${values.fanValue}%`, 'manual_control', '‡πÑ‡∏ü', currentStation, floorIndex);

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
        const confirmBtn = document.getElementById(`floor-confirm-btn-${floorIndex}`);
        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.style.background = '';
            confirmBtn.querySelector('span').textContent = `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πâ‡∏ô ${floorIndex}`;
        }
    } catch (error) {
        console.error("‚ùå Error sending commands:", error);
        showToast(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ä‡∏±‡πâ‡∏ô ${floorIndex}`, false);
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏° Polling ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
    await new Promise(resolve => setTimeout(resolve, 500));
    startLightControlPolling();
}
/**
 * üí° ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏ü‡πÑ‡∏õ‡∏ó‡∏µ‡πà Backend (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
 */
async function sendLightCommand(floor, type, value) {
    const commandPayload = {
        floor: parseInt(floor),
        type: type,
        distance: parseInt(value)
    };
    try {
        await fetch('/api/lights/control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(commandPayload)
        });
        
        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏ü‡πÅ‡∏ö‡∏ö manual
        const lightTypeDisplay = {
            'light-white': '‡πÑ‡∏ü‡∏Ç‡∏≤‡∏ß (White LED)',
            'light-red': '‡πÑ‡∏ü‡πÅ‡∏î‡∏á (Red LED)'
        };
        const displayType = lightTypeDisplay[type] || type;
        logAction(currentUser.username, `‡∏õ‡∏£‡∏±‡∏ö${displayType} ‡∏ä‡∏±‡πâ‡∏ô ${floor} ‡πÄ‡∏õ‡πá‡∏ô ${value}%`, 'manual_control', '‡πÑ‡∏ü', currentStation, floor);
        
    } catch (error) {
        console.error('‚ùå Send command error:', error);
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', false);
    }
}

/**
 * üí° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Backend ‡∏°‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
 */
function startLightControlPolling() {
    updateLightControlUIStateFromBackend();
    const lightTimer = setInterval(updateLightControlUIStateFromBackend, 8000);
    activeTimers.add(lightTimer);
}

/**
 * üí° [CORRECTED] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Backend ‡πÅ‡∏•‡∏∞‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏±‡∏ö UI ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
 */
// ‚úÖ [CORRECTED] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Backend ‡πÅ‡∏•‡∏∞‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏±‡∏ö UI ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
async function updateLightControlUIStateFromBackend() {
    try {
        const [statusRes, scheduleRes] = await Promise.all([
            fetch('/api/lights/status'),
            fetch('/api/lights/schedule')
        ]);

        if (!statusRes.ok || !scheduleRes.ok) {
            console.warn('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ü‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
            return;
        }

        const currentStates = await statusRes.json();
        const schedules = await scheduleRes.json();

        for (let floor = 1; floor <= 5; floor++) {
            const confirmBtn = document.getElementById(`floor-confirm-btn-${floor}`);

            // --- ‚ú® ‡∏à‡∏∏‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‚ú® ---
            // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô" ‡∏Ç‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏î)
            // ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏Ç‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡∏î‡∏µ‡∏î‡∏Å‡∏•‡∏±‡∏ö
            if (confirmBtn && !confirmBtn.disabled) {
                continue; // ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏ó‡∏≥‡∏ä‡∏±‡πâ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            }

            let isAnyDeviceOnInFloor = false;
            ['light-white', 'light-red', 'fan'].forEach(type => {
                const key = `${floor}-${type}`;
                const state = currentStates[key] || { intensity: 0, isManuallyOverridden: false };
                const schedule = schedules[key] || { enabled: false };

                if (state.intensity > 0) isAnyDeviceOnInFloor = true;

                const slider = document.querySelector(`input[data-floor="${floor}"][data-type="${type}"]`);
                const timerBtn = document.querySelector(`#floor-card-${floor} button[onclick*="'${type}', ${floor}"]`);

                if (slider) {
                    slider.value = state.intensity;
                    updateSliderVisual(slider, type, floor);
                    slider.disabled = schedule.enabled && !state.isManuallyOverridden;
                }
                if (timerBtn) {
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° class 'scheduled' ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤
                    timerBtn.classList.toggle('scheduled', schedule.enabled);
                }
            });

            const masterToggle = document.getElementById(`floor-power-${floor}`);
            if (masterToggle) masterToggle.checked = isAnyDeviceOnInFloor;
        }
    } catch (err) {
        console.error("Error polling light status:", err);
    }
}


// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡πÅ‡∏•‡∏∞ Global Actions (‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ---

let activeTimerModalContext = { floor: null, type: null };
async function openBatchScheduleModal() {
    const modal = document.getElementById('batchScheduleModal');
    const formContainer = document.getElementById('batchScheduleForm');
    formContainer.innerHTML = '<div><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
    modal.classList.add('show');
    
    const modalContent = modal.querySelector('.timer-modal-content');
    if (modalContent) {
        modalContent.style.maxHeight = '85vh';
        modalContent.style.overflowY = 'auto';
        modalContent.style.paddingRight = '15px';
    }

    try {
        const res = await fetch('/api/lights/schedule');
        const schedules = await res.json(); 

        let formHtml = `
            <div style="grid-column: 1 / -1; background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.1em; color: #166534; cursor: pointer;">
                    <input type="checkbox" id="master-schedule-toggle" onchange="toggleAllSchedules(this.checked)" style="width: 22px; height: 22px;">
                    ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </label>
            </div>
        `;

        // ‚úÖ‚úÖ‚úÖ ‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‚úÖ‚úÖ‚úÖ
        const deviceTypes = [
            { id: 'light-white', name: 'üí° ‡πÑ‡∏ü‡∏Ç‡∏≤‡∏ß (White LED)', color: '#f59e0b' },      // <-- ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ "‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏Ç‡∏≤‡∏ß
            { id: 'light-red',   name: 'üí° ‡πÑ‡∏ü‡πÅ‡∏î‡∏á (Red LED)',   color: '#ef4444' },      // <-- ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ "‡∏™‡∏µ‡πÅ‡∏î‡∏á" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡πÅ‡∏î‡∏á
            { id: 'fan',         name: 'üí® ‡∏û‡∏±‡∏î‡∏•‡∏° (Fan)',       color: '#3b82f6' }       // <-- ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ "‡∏™‡∏µ‡∏ü‡πâ‡∏≤" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏î‡∏•‡∏°
        ];

        for (let floor = 1; floor <= 5; floor++) {
            formHtml += `
                <div style="background: #f8fafc; border-radius: 16px; padding: 20px; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                    <h3 style="margin: 0 0 20px 0; color: #1b4332; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-layer-group" style="color: #52b788;"></i> ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà ${floor}
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 20px;">
            `;

            deviceTypes.forEach(device => {
                const key = `${floor}-${device.id}`;
                const schedule = schedules[key] || { enabled: false, on: '08:00', off: '18:00', intensity: 75 };

                // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î h4 ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ ‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏à‡∏≤‡∏Å deviceTypes ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                formHtml += `
                    <div style="background: #ffffff; border-radius: 10px; padding: 15px; border: 1px solid #eef2f7;">
                        <h4 style="margin: 0 0 15px 0; color: ${device.color};">${device.name}</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                <input type="checkbox" class="schedule-toggle" id="batch-enabled-${floor}-${device.id}" ${schedule.enabled ? 'checked' : ''}>
                                ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤
                            </label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label for="batch-on-${floor}-${device.id}" style="font-size: 0.8rem;">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î</label>
                                    <input type="text" id="batch-on-${floor}-${device.id}" class="timer-input" value="${schedule.on}" placeholder="08:00">
                                </div>
                                <div>
                                    <label for="batch-off-${floor}-${device.id}" style="font-size: 0.8rem;">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î</label>
                                    <input type="text" id="batch-off-${floor}-${device.id}" class="timer-input" value="${schedule.off}" placeholder="18:00">
                                </div>
                            </div>
                            <div>
                                <label for="batch-intensity-input-${floor}-${device.id}" style="font-size: 0.8rem;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô</label>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <input type="range" id="batch-intensity-slider-${floor}-${device.id}" min="0" max="100" value="${schedule.intensity}" class="premium-slider" style="flex-grow: 1; --fill-color: ${device.color};"
                                           oninput="syncInputs('slider', '${floor}', '${device.id}')">
                                    <input type="number" id="batch-intensity-input-${floor}-${device.id}" min="0" max="100" value="${schedule.intensity}" style="width: 70px; text-align: center;" class="timer-input"
                                           oninput="syncInputs('input', '${floor}', '${device.id}')">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            formHtml += `</div></div>`;
        }
        formContainer.innerHTML = formHtml;
    } catch (err) {
        formContainer.innerHTML = '<div style="color: red;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ</div>';
    }
}

function toggleAllSchedules(isChecked) {
    const allToggles = document.querySelectorAll('.schedule-toggle');
    allToggles.forEach(toggle => {
        toggle.checked = isChecked;
    });
}

/**
 * üí° [NEW HELPER] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Slider ‡πÅ‡∏•‡∏∞ Input ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
 */
function syncInputs(source, floor, type) {
    const slider = document.getElementById(`batch-intensity-slider-${floor}-${type}`);
    const input = document.getElementById(`batch-intensity-input-${floor}-${type}`);
    
    if (source === 'slider') {
        input.value = slider.value;
    } else {
        // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏ô 100
        if (parseInt(input.value) > 100) {
            input.value = 100;
        }
        slider.value = input.value;
    }
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏µ‡∏Ç‡∏≠‡∏á slider visual
    slider.style.setProperty('--value', slider.value + '%');
}
// ‚úÖ [CORRECTED] ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
async function saveBatchSchedules() {
    showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...', true);
    const deviceTypes = ['light-white', 'light-red', 'fan'];
    const allSchedules = [];

    for (let floor = 1; floor <= 5; floor++) {
        deviceTypes.forEach(type => {
            const enabled = document.getElementById(`batch-enabled-${floor}-${type}`).checked;
            const onTime = document.getElementById(`batch-on-${floor}-${type}`).value;
            const offTime = document.getElementById(`batch-off-${floor}-${type}`).value;
            
            // --- ‚ú® THIS IS THE CORRECTED LINE ‚ú® ---
            const intensity = document.getElementById(`batch-intensity-slider-${floor}-${type}`).value;

            allSchedules.push({
                floor,
                type,
                enabled,
                onTime,
                offTime,
                intensity: parseInt(intensity)
            });
        });
    }

    try {
        const response = await fetch('/api/lights/schedule/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(allSchedules)
        });

        if (!response.ok) {
            throw new Error('Server responded with an error');
        }

        showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', true);
        
        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ü‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const scheduleCount = allSchedules.filter(s => s.enabled).length;
        logAction(currentUser.username, `‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${scheduleCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`, 'schedule_batch', '‡πÑ‡∏ü', currentStation);
        
        closeBatchScheduleModal();
        updateLightControlUIStateFromBackend();
    } catch (err) {
        showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤', false);
        console.error("Save Batch Schedules Error:", err);
    }
}

async function openIndividualTimerModal(type, floor) {
    const modal = document.getElementById('timerModal');
    if (!modal) return;
    activeTimerModalContext = { type, floor };
    modal.querySelector('.modal-title').textContent = `‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô ${floor} (${type})`;
    modal.classList.add('show');
    try {
        const res = await fetch('/api/lights/schedule');
        const schedules = await res.json();
        const key = `${floor}-${type}`;
        const schedule = schedules[key] || { enabled: false, on: '08:00', off: '18:00', intensity: 75 };
        modal.querySelector('#individual-enabled').checked = schedule.enabled;
        modal.querySelector('#individual-on-time').value = schedule.on;
        modal.querySelector('#individual-off-time').value = schedule.off;
        const intensitySlider = modal.querySelector('#individual-intensity');
        const intensityValue = modal.querySelector('#individual-intensity-val');
        intensitySlider.value = schedule.intensity;
        intensityValue.textContent = `${schedule.intensity}%`;
    } catch (err) { showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ', false); }
}

async function saveIndividualSchedule() {
    const { floor, type } = activeTimerModalContext;
    if (!floor || !type) return;
    const modal = document.getElementById('timerModal');
    const payload = {
        floor: floor,
        type: type,
        enabled: modal.querySelector('#individual-enabled').checked,
        onTime: modal.querySelector('#individual-on-time').value,
        offTime: modal.querySelector('#individual-off-time').value,
        intensity: parseInt(modal.querySelector('#individual-intensity').value)
    };
    showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', true);
    try {
        await fetch('/api/lights/schedule', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', true);
        closeTimerModal();
        updateLightControlUIStateFromBackend();
    } catch (err) { showToast('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', false); }
}

function closeTimerModal() { const modal = document.getElementById('timerModal'); if(modal) modal.classList.remove('show'); }
function closeBatchScheduleModal() { const modal = document.getElementById('batchScheduleModal'); if (modal) modal.classList.remove('show'); }

async function turnEverythingOff(){
    showConfirmationPopup({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
        subtitle: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î LED ‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏î‡∏•‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        icon: 'fa-power-off',
        details: [{ label: '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á', value: '‡∏õ‡∏¥‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', highlight: true }],
        onConfirm: async () => {
            showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...', true);
            try { 
                await fetch('/api/lights/off/all', { method: 'POST' }); 
                showToast('‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', true); 
                updateLightControlUIStateFromBackend(); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö manual
                logAction(currentUser.username, '‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏î‡∏•‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'manual_control', '‡πÑ‡∏ü', currentStation);
            } catch(err) { 
                showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á', false); 
            }
        }
    });
}

async function clearAllSchedules(){
    showConfirmationPopup({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤',
        subtitle: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ',
        icon: 'fa-trash-alt',
        details: [{ label: '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á', value: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', highlight: true }],
        onConfirm: async () => {
            showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤...', true);
            try { 
                await fetch('/api/lights/schedule/all', { method: 'DELETE' }); 
                showToast('‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!', true); 
                
                // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ü
                logAction(currentUser.username, '‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'schedule_clear', '‡πÑ‡∏ü', currentStation);
                
                updateLightControlUIStateFromBackend(); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            } catch(err) { 
                showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', false); 
            }
        }
    });
}


// ===============================================
// üöø ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥
// ===============================================

// ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥
let waterSystemData = {
    homeSettings: {
        ecValue: 1.2,
        waterLevel: 75,
        isAutoMode: true,
        lastUpdate: new Date()
    },
    layers: [
        { id: 1, name: '‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1', isActive: false, waterFlow: 0, pumpStatus: '‡∏õ‡∏¥‡∏î', pumpInstalled: true },
        { id: 2, name: '‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2', isActive: false, waterFlow: 0, pumpStatus: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á', pumpInstalled: false },
        { id: 3, name: '‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3', isActive: false, waterFlow: 0, pumpStatus: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á', pumpInstalled: false },
        { id: 4, name: '‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 4', isActive: false, waterFlow: 0, pumpStatus: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á', pumpInstalled: false }
    ]
};

function renderWateringSystemPage() {
    const mainContent = document.getElementById('mainContent');
    
    const html = `
        <!-- Water System Page with Tailwind CSS -->
        <div class="min-h-screen bg-gradient-to-br from-blue-50 via-cyan-50 to-teal-50 p-4">
            <!-- Header Section -->
            <div class="bg-white/90 backdrop-blur-lg rounded-3xl shadow-xl border border-blue-100 p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center shadow-lg">
                            <i class="fas fa-tint text-white text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-4xl font-bold bg-gradient-to-r from-cyan-600 to-blue-600 bg-clip-text text-transparent mb-1">üíß ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h1>
                            <p class="text-gray-700 font-medium">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏ô‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 72 ‡∏ï‡∏±‡∏ß (4 ‡∏ä‡∏±‡πâ‡∏ô √ó 18 ‡∏ß‡∏≤‡∏•‡πå‡∏ß)</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 bg-green-50 px-4 py-2 rounded-full">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-green-700 font-semibold">‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                    </div>
                </div>
            </div>

            <!-- Home Control Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- EC Control -->
                <div class="bg-white/90 backdrop-blur-lg rounded-2xl shadow-lg border border-blue-100 p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-blue-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-flask text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">‡∏Ñ‡πà‡∏≤ EC</h3>
                            <p class="text-sm text-gray-600">‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</p>
                        </div>
                    </div>
                    <div class="text-center mb-4">
                        <span class="text-3xl font-bold text-blue-600" id="ecCurrentValue">${waterSystemData.homeSettings.ecValue}</span>
                        <span class="text-gray-500 ml-2">mS/cm</span>
                    </div>
                    <div class="mb-4">
                        <input type="range" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider" 
                               min="0.5" max="3.0" step="0.1" 
                               value="${waterSystemData.homeSettings.ecValue}"
                               onchange="updateECValue(this.value)"
                               oninput="updateECDisplay(this.value)">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>0.5</span>
                            <span>1.75</span>
                            <span>3.0</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-green-700">‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥</span>
                    </div>
                </div>

                <!-- Water Level Control -->
                <div class="bg-white/90 backdrop-blur-lg rounded-2xl shadow-lg border border-blue-100 p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-cyan-400 to-cyan-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-tint text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥</h3>
                            <p class="text-sm text-gray-600">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥</p>
                        </div>
                    </div>
                    <div class="text-center mb-4">
                        <span class="text-3xl font-bold text-cyan-600" id="waterLevelValue">${waterSystemData.homeSettings.waterLevel}</span>
                        <span class="text-gray-500 ml-2">%</span>
                    </div>
                    <div class="mb-4">
                        <input type="range" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider" 
                               min="0" max="100" step="5" 
                               value="${waterSystemData.homeSettings.waterLevel}"
                               onchange="updateWaterLevel(this.value)"
                               oninput="updateWaterLevelDisplay(this.value)">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>0%</span>
                            <span>50%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-gradient-to-r from-cyan-400 to-blue-500 h-3 rounded-full transition-all duration-300" 
                             id="waterLevelBar" style="width: ${waterSystemData.homeSettings.waterLevel}%"></div>
                    </div>
                </div>

                <!-- Confirm Water Button -->
                <div class="bg-white/90 backdrop-blur-lg rounded-2xl shadow-lg border border-blue-100 p-6">
                    <div class="text-center">
                        <div class="mb-4">
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p>EC: <span class="font-semibold text-blue-600" id="ecSummary">${waterSystemData.homeSettings.ecValue}</span> mS/cm</p>
                                <p>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: <span class="font-semibold text-cyan-600" id="waterLevelSummary">${waterSystemData.homeSettings.waterLevel}</span>%</p>
                            </div>
                        </div>
                        <button class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg" 
                                id="homeWaterBtn" onclick="confirmWatering()">
                            <i class="fas fa-check-circle mr-2"></i>
                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥
                        </button>
                        <div class="hidden mt-3 text-green-600 font-semibold" id="homeWaterStatus">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Floors Grid -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                ${generateFloorsGrid()}
            </div>

            <!-- Statistics Section -->
            <div class="mt-8 bg-white/90 backdrop-blur-lg rounded-2xl shadow-lg border border-blue-100 p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                    <i class="fas fa-chart-line text-blue-500"></i>
                    ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600" id="totalValvesWorking">0</div>
                        <div class="text-sm text-blue-800">‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-green-600">2,458</div>
                        <div class="text-sm text-green-800">‡∏•‡∏¥‡∏ï‡∏£‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-purple-600">98.5%</div>
                        <div class="text-sm text-purple-800">‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-orange-600">22.5¬∞C</div>
                        <div class="text-sm text-orange-800">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏ô‡πâ‡∏≥</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Using Tailwind CSS - No custom styles needed -->
        <style>
        .watering-system-container {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: calc(100vh - 40px);
            font-family: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .watering-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .header-icon {
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(79, 195, 247, 0.4);
        }

        .header-icon i {
            font-size: 2.5em;
            color: white;
        }

        .header-text h1 {
            margin: 0;
            font-size: 2.5em;
            background: linear-gradient(135deg, #1976d2, #1565c0);
            -webkit-background-clip: text;
    background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .header-text p {
            margin: 8px 0 0 0;
            color: #666;
            font-size: 1.1em;
        }

        .system-status {
            margin-left: auto;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .system-status {
            background: linear-gradient(135deg, #4caf50, #43a047);
            color: white;
        }

        .watering-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .control-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-header h2 {
            margin: 0;
            font-size: 1.8em;
            color: #333;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-header i {
            color: #4fc3f7;
        }


        .home-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .control-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .control-card:hover {
            border-color: #4fc3f7;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(79, 195, 247, 0.2);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .card-header i {
            font-size: 2em;
            color: #4fc3f7;
        }

        .card-title h3 {
            margin: 0;
            font-size: 1.3em;
            color: #333;
        }

        .card-title span {
            color: #666;
            font-size: 0.9em;
        }

        .value-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .current-value {
            font-size: 3em;
            font-weight: 700;
            color: #1976d2;
        }

        .unit {
            font-size: 1.2em;
            color: #666;
            margin-left: 5px;
        }

        .control-slider {
            margin-bottom: 15px;
        }

        .control-slider input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .control-slider input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(79, 195, 247, 0.4);
        }

        .ec-slider {
            background: linear-gradient(to right, #f44336 0%, #ff9800 25%, #4caf50 50%, #2196f3 75%, #9c27b0 100%);
        }

        .volume-slider {
            background: linear-gradient(to right, #f44336 0%, #ff9800 50%, #4caf50 100%);
        }

        .water-level-slider {
            background: linear-gradient(to right, #f44336 0%, #ff9800 50%, #4caf50 100%);
        }

        .confirm-water-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }

        .water-summary {
            margin-bottom: 20px;
        }

        .water-summary h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }

        .water-summary p {
            margin: 5px 0;
            color: #666;
            font-size: 0.95em;
        }

        .confirm-water-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(135deg, #4caf50, #43a047);
            color: white;
            font-weight: 600;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .confirm-water-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: 50px;
            font-weight: 600;
        }

        .status-indicator.optimal { background: #e8f5e8; color: #4caf50; }
        .status-indicator.warning { background: #fff3e0; color: #ff9800; }
        .status-indicator.danger { background: #ffebee; color: #f44336; }

        .volume-indicator {
            text-align: center;
        }

        .volume-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .volume-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #29b6f6);
            transition: width 0.3s ease;
        }

        .water-status {
            text-align: center;
            margin-bottom: 20px;
        }

        .status-icon {
            font-size: 3em;
            margin-bottom: 10px;
            color: #4fc3f7;
        }

        .status-icon.watering {
            color: #4caf50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .status-text {
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
        }

        .water-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .water-btn {
            padding: 15px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .water-btn.start-watering {
            background: linear-gradient(135deg, #4caf50, #43a047);
            color: white;
        }

        .water-btn.stop-watering {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .water-btn:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
        }

        .water-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .watering-progress {
            text-align: center;
        }

        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #43a047);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #666;
        }

        .agv-status {
            text-align: center;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .agv-status.ready {
            background: #e8f5e8;
            color: #4caf50;
        }

        .agv-status.not-ready {
            background: #fff3e0;
            color: #ff9800;
        }

        .layer-icon.agv-ready {
            background: linear-gradient(135deg, #2196f3, #1976d2);
        }

        .layer-icon.not-installed {
            background: linear-gradient(135deg, #9e9e9e, #757575);
        }

        .layer-item.not-installed {
            background: #f5f5f5;
            opacity: 0.7;
        }

        .not-installed-status {
            text-align: center;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8em;
            background: #eeeeee;
            color: #757575;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .install-placeholder {
            text-align: center;
            padding: 10px 15px;
            color: #ff9800;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .water-layer-btn {
            padding: 12px 18px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            color: white;
            min-width: 120px;
            justify-content: center;
            white-space: nowrap;
        }

        .water-layer-btn.disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
        }

        .water-layer-btn:not(.disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 195, 247, 0.3);
        }

        .water-status-indicator, .layer-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
            border-radius: 6px;
            font-size: 0.9em;
            color: #ff9800;
            margin-top: 8px;
        }

        .status-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-text {
            font-weight: 500;
        }

        .quick-actions {
            display: flex;
            gap: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn.emergency {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .action-btn.reset {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }

        .action-btn.calibrate {
            background: linear-gradient(135deg, #9c27b0, #7b1fa2);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .layer-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn-small {
            padding: 8px 15px;
            border: none;
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 195, 247, 0.3);
        }

        .layer-controls {
            display: grid;
            gap: 15px;
        }

        .layer-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .layer-item:hover {
            border-color: #4fc3f7;
            transform: translateX(5px);
        }

        .layer-item.active {
            background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
            border-color: #4caf50;
        }

        .layer-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .layer-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
        }

        .layer-icon.active {
            background: linear-gradient(135deg, #4caf50, #43a047);
        }

        .layer-icon.inactive {
            background: linear-gradient(135deg, #bdbdbd, #9e9e9e);
        }

        .layer-details h4 {
            margin: 0;
            color: #333;
            font-size: 1.2em;
        }

        .layer-details p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 0.9em;
        }

        .layer-controls-right {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: nowrap;
            min-width: 300px;
        }

        .pump-status {
            text-align: center;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8em;
            white-space: nowrap;
            min-width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pump-status.active {
            background: #e8f5e8;
            color: #4caf50;
        }

        .pump-status.inactive {
            background: #ffebee;
            color: #f44336;
        }

        .flow-indicator {
            text-align: center;
            color: #666;
            white-space: nowrap;
            min-width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .flow-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #4fc3f7;
            white-space: nowrap;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #4caf50, #43a047);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .status-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .status-item i {
            font-size: 1.5em;
            color: #4fc3f7;
        }

        .status-text span:first-child {
            display: block;
            color: #666;
            font-size: 0.9em;
        }

        .status-text span:last-child,
        .status-text time {
            font-weight: 600;
            color: #333;
        }

        .status-good {
            color: #4caf50 !important;
        }

        @media (max-width: 1200px) {
            .watering-grid {
                grid-template-columns: 1fr;
            }
            
            .home-controls {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .watering-system-container {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .system-status {
                margin-left: 0;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .status-panel {
                grid-template-columns: 1fr;
            }
        }
        </style>
    `;
    
    mainContent.innerHTML = html;
}

function generateLayerControls() {
    return waterSystemData.layers.map(layer => `
        <div class="layer-item ${layer.isActive ? 'active' : ''} ${!layer.pumpInstalled ? 'not-installed' : ''}" data-layer="${layer.id}">
            <div class="layer-info">
                <div class="layer-icon ${!layer.pumpInstalled ? 'not-installed' : (layer.isActive ? 'active' : 'inactive')}">
                    ${!layer.pumpInstalled ? `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" fill="currentColor" opacity="0.6"/>
                        </svg>
                    ` : `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2C8 7 6 10 6 14c0 3.31 2.69 6 6 6s6-2.69 6-6c0-4-2-7-6-12z" fill="currentColor" opacity="0.8"/>
                            <ellipse cx="12" cy="16" rx="2" ry="1" fill="rgba(255,255,255,0.6)"/>
                        </svg>
                    `}
                </div>
                <div class="layer-details">
                    <h4>${layer.name}</h4>
                    <p>${layer.pumpInstalled ? `‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥: ${layer.pumpStatus} ‚Ä¢ ‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•: ${layer.waterFlow}%` : '‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á'}</p>
                </div>
            </div>
            <div class="layer-controls-right">
                ${layer.pumpInstalled ? `
                    <div class="pump-status ${layer.isActive ? 'active' : 'inactive'}">
                        ${layer.pumpStatus}
                    </div>
                    <div class="flow-indicator">
                        <div class="flow-value">${layer.waterFlow}%</div>
                        <div>‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•</div>
                    </div>
                    <button class="water-layer-btn" id="layerWaterBtn${layer.id}" onclick="confirmLayerWatering(${layer.id})">
                        ${layer.isActive ? `
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="filter: drop-shadow(0 1px 2px rgba(255,255,255,0.3));">
                                <circle cx="12" cy="12" r="8" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
                                <rect x="9" y="9" width="6" height="6" rx="0.5" fill="white"/>
                            </svg>
                        ` : `
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="filter: drop-shadow(0 1px 2px rgba(255,255,255,0.3));">
                                <circle cx="12" cy="12" r="8" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
                                <path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        `}
                        ${layer.isActive ? '‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ï‡∏¥‡∏°' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°'}
                    </button>
                    <div class="layer-status-indicator" id="layerWaterStatus${layer.id}" style="display: none;">
                        <div class="status-icon">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <span class="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</span>
                    </div>
                ` : `
                    <div class="not-installed-status">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity: 0.7;">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" stroke="#666" stroke-width="1.5" fill="none"/>
                        </svg>
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
                    </div>
                    <div class="install-placeholder">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity: 0.7;">
                            <path d="M12 9v4M12 17h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" stroke="#ff9800" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                        </svg>
                        ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
                    </div>
                `}
            </div>
        </div>
    `).join('');
}

// Water System Data - 4 floors, 18 valves each (real data from backend)
let waterSystemFloors = [
    {
        id: 1,
        name: '‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1',
        valves: Array.from({length: 18}, (_, i) => ({
            id: i + 1,
            status: 'closed',
            usage: 0
        }))
    },
    {
        id: 2,
        name: '‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2',
        valves: Array.from({length: 18}, (_, i) => ({
            id: i + 1,
            status: 'closed',
            usage: 0
        }))
    },
    {
        id: 3,
        name: '‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3',
        valves: Array.from({length: 18}, (_, i) => ({
            id: i + 1,
            status: 'closed',
            usage: 0
        }))
    },
    {
        id: 4,
        name: '‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 4',
        valves: Array.from({length: 18}, (_, i) => ({
            id: i + 1,
            status: 'closed',
            usage: 0
        }))
    }
];

function generateFloorsGrid() {
    return waterSystemFloors.map(floor => `
        <div class="bg-white/90 backdrop-blur-lg rounded-2xl shadow-lg border border-blue-100 p-6">
            <!-- Floor Header -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <span class="text-white font-bold text-lg">${floor.id}</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">${floor.name}</h3>
                        <p class="text-sm text-gray-600">‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏ô‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 18 ‡∏ï‡∏±‡∏ß</p>
                    </div>
                </div>
            </div>

            <!-- Floor Stats -->
            <div class="grid grid-cols-4 gap-3 mb-6">
                <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl p-3 text-center border border-emerald-200">
                    <div class="text-2xl font-bold text-emerald-600">${floor.valves.filter(v => v.status === 'open').length}</div>
                    <div class="text-xs font-semibold text-emerald-800">‡πÄ‡∏õ‡∏¥‡∏î</div>
                </div>
                <div class="bg-gradient-to-br from-cyan-50 to-cyan-100 rounded-xl p-3 text-center border border-cyan-200">
                    <div class="text-2xl font-bold text-cyan-600">${floor.valves.filter(v => v.status === 'working').length}</div>
                    <div class="text-xs font-semibold text-cyan-800">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                </div>
                <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl p-3 text-center border border-slate-200">
                    <div class="text-2xl font-bold text-slate-600">${floor.valves.filter(v => v.status === 'closed').length}</div>
                    <div class="text-xs font-semibold text-slate-800">‡∏õ‡∏¥‡∏î</div>
                </div>
                <div class="bg-gradient-to-br from-violet-50 to-violet-100 rounded-xl p-3 text-center border border-violet-200">
                    <div class="text-2xl font-bold text-violet-600">${Math.round(floor.valves.reduce((sum, v) => sum + v.usage, 0) / floor.valves.length)}%</div>
                    <div class="text-xs font-semibold text-violet-800">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                </div>
            </div>

            <!-- Valves Grid -->
            <div class="grid grid-cols-6 gap-3 lg:gap-4">
                ${floor.valves.map(valve => `
                    <div class="group relative">
                        <button class="w-full aspect-square rounded-2xl transition-all duration-300 transform hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-blue-200 ${getValveButtonClass(valve.status)}" 
                                onclick="toggleValve(${floor.id}, ${valve.id})" 
                                id="valve-${floor.id}-${valve.id}">
                            <div class="flex flex-col items-center justify-center h-full">
                                <i class="fas ${getValveIcon(valve.status)} text-xl mb-1"></i>
                                <span class="text-sm font-bold">${valve.id}</span>
                                ${valve.status === 'open' ? '<div class="text-xs mt-1">ON</div>' : valve.status === 'working' ? '<div class="text-xs mt-1">...</div>' : '<div class="text-xs mt-1">OFF</div>'}
                            </div>
                        </button>
                        <!-- Enhanced Tooltip -->
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-3 px-3 py-2 bg-gray-900 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-all duration-300 whitespace-nowrap z-20 shadow-lg">
                            <div class="font-semibold">‡∏ß‡∏≤‡∏•‡πå‡∏ß ${floor.id}-${valve.id}</div>
                            <div class="text-xs text-gray-300">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${getValveStatusText(valve.status)}</div>
                            <div class="text-xs text-gray-300">‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${valve.usage}%</div>
                            <!-- Tooltip Arrow -->
                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"></div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
}

// Helper functions for valve display
function getValveButtonClass(status) {
    switch(status) {
        case 'open': return 'bg-gradient-to-br from-emerald-400 to-emerald-600 text-white shadow-lg shadow-emerald-200 border-2 border-emerald-300';
        case 'working': return 'bg-gradient-to-br from-amber-400 to-orange-500 text-white shadow-lg shadow-orange-200 border-2 border-orange-300';
        case 'closed': 
        default: return 'bg-gradient-to-br from-slate-100 to-slate-200 text-slate-700 hover:from-slate-200 hover:to-slate-300 border-2 border-slate-300 hover:border-slate-400 hover:shadow-md';
    }
}

function getValveIcon(status) {
    switch(status) {
        case 'open': return 'fa-droplet';
        case 'working': return 'fa-clock';
        case 'closed': 
        default: return 'fa-circle';
    }
}

function getValveStatusText(status) {
    switch(status) {
        case 'open': return '‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß';
        case 'working': return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
        case 'closed': 
        default: return '‡∏õ‡∏¥‡∏î';
    }
}

// Valve control functions
async function toggleValve(floorId, valveId) {
    
    const floor = waterSystemFloors.find(f => f.id === floorId);
    if (!floor) {
        console.error(`‚ùå Floor ${floorId} not found`);
        showNotification(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏±‡πâ‡∏ô ${floorId}`, 'error');
        return;
    }
    
    const valve = floor.valves.find(v => v.id === valveId);
    if (!valve) {
        console.error(`‚ùå Valve ${valveId} not found in floor ${floorId}`);
        showNotification(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏≤‡∏•‡πå‡∏ß ${floorId}-${valveId}`, 'error');
        return;
    }
    
    // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
    const originalStatus = valve.status;
    
    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥ ‡πÜ ‡∏Ç‡∏ì‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    if (valve.status === 'working') {
        showNotification(`‚ö†Ô∏è ‡∏ß‡∏≤‡∏•‡πå‡∏ß ${floorId}-${valveId} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà`, 'warning');
        return;
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    showValveConfirmModal(floorId, valveId, originalStatus, async () => {
        await performValveToggle(floorId, valveId, originalStatus);
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏¥‡∏î‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß
async function performValveToggle(floorId, valveId, originalStatus) {
    const floor = waterSystemFloors.find(f => f.id === floorId);
    const valve = floor.valves.find(v => v.id === valveId);
    
    // Toggle between closed and open
    let newStatus;
    if (originalStatus === 'open') {
        newStatus = 'closed';
    } else {
        newStatus = 'open';
    }
    
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    valve.status = 'working';
    updateValveDisplay(floorId, valveId, valve);
    showNotification(`üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏•‡πå‡∏ß ${floorId}-${valveId}...`, 'info');
    
    // Send command to backend
    const success = await sendValveCommand(floorId, valveId, newStatus);
    
    if (success) {
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà
        valve.status = newStatus;
        updateValveDisplay(floorId, valveId, valve);
        updateFloorStats(floorId);
        
        const statusIcon = newStatus === 'open' ? 'üíß' : '‚≠ï';
        const statusText = newStatus === 'open' ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß';
        const notifyType = newStatus === 'open' ? 'success' : 'info';
        
        showNotification(`${statusIcon} ‡∏ß‡∏≤‡∏•‡πå‡∏ß ${floorId}-${valveId} ${statusText}`, notifyType);
    } else {
        // ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°
        valve.status = originalStatus;
        updateValveDisplay(floorId, valveId, valve);
        showNotification(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ß‡∏≤‡∏•‡πå‡∏ß ${floorId}-${valveId} ‡πÑ‡∏î‡πâ`, 'error');
        console.error(`‚ùå Failed to control valve ${floorId}-${valveId}`);
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö reset ‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ working
function resetStuckValves() {
    let resetCount = 0;
    
    waterSystemFloors.forEach(floor => {
        floor.valves.forEach(valve => {
            if (valve.status === 'working') {
                valve.status = 'closed'; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô closed
                updateValveDisplay(floor.id, valve.id, valve);
                resetCount++;
            }
        });
    });
    
    if (resetCount > 0) {
        updateTotalStats();
        showNotification(`üîß ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏Ñ‡πâ‡∏≤‡∏á ${resetCount} ‡∏ï‡∏±‡∏ß`, 'info');
    } else {
    }
    
    return resetCount;
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° reset ‡∏ß‡∏≤‡∏•‡πå‡∏ß‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß
function resetValve(floorId, valveId) {
    
    const floor = waterSystemFloors.find(f => f.id === floorId);
    if (floor) {
        const valve = floor.valves.find(v => v.id === valveId);
        if (valve) {
            console.log(`üìä Current status: ${valve.status}`);
            valve.status = 'closed';
            updateValveDisplay(floorId, valveId, valve);
            updateFloorStats(floorId);
            showNotification(`üîß ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏≤‡∏•‡πå‡∏ß ${floorId}-${valveId} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
            console.log(`‚úÖ Valve ${floorId}-${valveId} reset to closed`);
            return true;
        } else {
            console.error(`‚ùå Valve ${valveId} not found in floor ${floorId}`);
        }
    } else {
        console.error(`‚ùå Floor ${floorId} not found`);
    }
    return false;
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏£‡πá‡∏ß ‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Console
window.quickReset = function() {
    console.log('üöÄ Quick Reset - ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏ä‡∏±‡πâ‡∏ô 1 ‡∏ä‡πà‡∏≠‡∏á 1');
    return resetValve(1, 1);
};

window.resetAll = function() {
    console.log('üöÄ Reset All - ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏Ñ‡πâ‡∏≤‡∏á');
    return resetStuckValves();
};

// ‚úÖ Valve Confirm Modal Functions
let valveConfirmData = null;

function showValveConfirmModal(floorId, valveId, currentStatus, onConfirm) {
    const modal = document.getElementById('valveConfirmModal');
    const modalContent = document.getElementById('valveModalContent');
    const header = document.getElementById('valveModalHeader');
    const icon = document.getElementById('valveModalIcon');
    const title = document.getElementById('valveModalTitle');
    const location = document.getElementById('valveModalLocation');
    const status = document.getElementById('valveModalStatus');
    const message = document.getElementById('valveModalMessage');
    const confirmBtn = document.getElementById('valveModalConfirm');
    const confirmIcon = document.getElementById('valveModalConfirmIcon');
    const confirmText = document.getElementById('valveModalConfirmText');
    
    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• callback
    valveConfirmData = { floorId, valveId, currentStatus, onConfirm };
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    if (currentStatus === 'closed') {
        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏ß‡∏≤‡∏•‡πå‡∏ß
        header.className = 'px-8 py-6 bg-gradient-to-r from-emerald-500 to-green-500';
        icon.innerHTML = '<i class="fas fa-droplet text-3xl text-white"></i>';
        title.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ß‡∏≤‡∏•‡πå‡∏ß';
        message.textContent = '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
        confirmBtn.className = 'flex-1 px-6 py-3 bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-600 hover:to-green-600 text-white font-semibold rounded-2xl transition-all duration-200 transform hover:scale-105 shadow-lg';
        confirmIcon.className = 'fas fa-play mr-2';
        confirmText.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î';
    } else {
        // ‡∏õ‡∏¥‡∏î‡∏ß‡∏≤‡∏•‡πå‡∏ß
        header.className = 'px-8 py-6 bg-gradient-to-r from-red-500 to-pink-500';
        icon.innerHTML = '<i class="fas fa-stop text-3xl text-white"></i>';
        title.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏ß‡∏≤‡∏•‡πå‡∏ß';
        message.textContent = '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
        confirmBtn.className = 'flex-1 px-6 py-3 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white font-semibold rounded-2xl transition-all duration-200 transform hover:scale-105 shadow-lg';
        confirmIcon.className = 'fas fa-stop mr-2';
        confirmText.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î';
    }
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    location.textContent = `‡∏ä‡∏±‡πâ‡∏ô ${floorId} ‡∏ß‡∏≤‡∏•‡πå‡∏ß ${valveId}`;
    
    let statusText = '';
    switch(currentStatus) {
        case 'open': statusText = '‡πÄ‡∏õ‡∏¥‡∏î'; break;
        case 'closed': statusText = '‡∏õ‡∏¥‡∏î'; break;
        case 'working': statusText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'; break;
        default: statusText = '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
    }
    status.textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${statusText}`;
    
    // ‡πÅ‡∏™‡∏î‡∏á modal ‡∏î‡πâ‡∏ß‡∏¢ animation
    modal.style.display = 'flex';
    setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
}

function closeValveConfirmModal(confirmed) {
    const modal = document.getElementById('valveConfirmModal');
    const modalContent = document.getElementById('valveModalContent');
    
    // Animation ‡∏ã‡πà‡∏≠‡∏ô
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
        modal.style.display = 'none';
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å callback ‡∏ñ‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
        if (confirmed && valveConfirmData && valveConfirmData.onConfirm) {
            valveConfirmData.onConfirm();
        }
        
        // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        valveConfirmData = null;
    }, 200);
}

async function toggleAllValvesInFloor(floorId, turnOn) {
    // Send command to backend first
    const success = await sendFloorWateringCommand(floorId, turnOn);
    
    if (success) {
        const floor = waterSystemFloors.find(f => f.id === floorId);
        floor.valves.forEach(valve => {
            valve.status = turnOn ? 'open' : 'closed';
            updateValveDisplay(floorId, valve.id, valve);
        });
        updateFloorStats(floorId);
        
        const action = turnOn ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î';
        showNotification(`${action}‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà ${floorId}`, 'success');
    } else {
        const action = turnOn ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î';
        showNotification(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ${action}‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà ${floorId} ‡πÑ‡∏î‡πâ`, 'error');
    }
}

function updateValveDisplay(floorId, valveId, valve) {
    const button = document.getElementById(`valve-${floorId}-${valveId}`);
    if (button) {
        // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡∏Ç‡∏∂‡πâ‡∏ô
        button.className = `w-full aspect-square rounded-2xl transition-all duration-300 transform hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-blue-200 ${getValveButtonClass(valve.status)}`;
        
        const icon = button.querySelector('i');
        if (icon) {
            icon.className = `fas ${getValveIcon(valve.status)} text-xl mb-1`;
        }
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const statusText = button.querySelector('.text-xs');
        if (statusText) {
            if (valve.status === 'open') {
                statusText.textContent = 'ON';
                statusText.className = 'text-xs mt-1 font-semibold';
            } else if (valve.status === 'working') {
                statusText.textContent = '...';
                statusText.className = 'text-xs mt-1 animate-pulse';
            } else {
                statusText.textContent = 'OFF';
                statusText.className = 'text-xs mt-1';
            }
        }
    }
}

function updateFloorStats(floorId) {
    // Update floor statistics display
    updateTotalStats();
    setTimeout(() => {
        const currentPage = document.getElementById('mainContent').innerHTML;
        if (currentPage.includes('generateFloorsGrid')) {
            // Re-render the floor stats only
            renderWateringSystemPage();
        }
    }, 100);
}

function updateTotalStats() {
    // Count total working valves across all floors
    let totalWorking = 0;
    waterSystemFloors.forEach(floor => {
        totalWorking += floor.valves.filter(v => v.status === 'open' || v.status === 'working').length;
    });
    
    const totalElement = document.getElementById('totalValvesWorking');
    if (totalElement) {
        totalElement.textContent = totalWorking;
    }
}

// Backend API functions - JSON Response Handlers
function handleWaterSystemResponse(data) {
    try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö key ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
        if (data.Key === "1097BD225248" || data.Key === "30C922FB6E90") {
            console.log('Received water system response:', data);
            
            // ‡πÅ‡∏õ‡∏•‡∏á Device ID ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Floor ‡πÅ‡∏•‡∏∞ Valve
            if (data.Device && data.Status) {
                const deviceId = parseInt(data.Device);
                
                if (deviceId >= 1 && deviceId <= 72) {
                    const floorId = Math.ceil(deviceId / 18);
                    const valveId = deviceId - ((floorId - 1) * 18);
                    
                    console.log(`Device ${deviceId} -> Floor ${floorId}, Valve ${valveId}, Status: ${data.Status}`);
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏≤‡∏•‡πå‡∏ß‡πÉ‡∏ô UI
                    updateValveStatusFromBackend(floorId, valveId, data.Status, data.Result);
                }
            }
            
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Layer response
            if (data.Layer) {
                console.log(`Layer ${data.Layer} response:`, data);
                handleLayerResponse(data);
            }
        }
    } catch (error) {
        console.error('Error handling water system response:', error);
    }
}

async function updateValveStatusFromBackend(floorId, valveId, status, result) {
    const floor = waterSystemFloors.find(f => f.id === floorId);
    if (floor) {
        const valve = floor.valves.find(v => v.id === valveId);
        if (valve) {
            // ‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å backend
            let newStatus = 'closed';
            if (status === 'Open') {
                newStatus = 'open';
            } else if (status === 'Working') {
                newStatus = 'working';
            }
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô UI
            valve.status = newStatus;
            updateValveDisplay(floorId, valveId, valve);
            updateFloorStats(floorId);
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const deviceId = ((floorId - 1) * 18) + valveId;
            try {
                await fetch('/api/water-valve-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deviceId: deviceId,
                        status: newStatus,
                        responseData: { status, result, floorId, valveId }
                    })
                });
                console.log(`‚úÖ Updated valve ${floorId}-${valveId} status in database: ${newStatus}`);
            } catch (error) {
                console.log('‚ö†Ô∏è Failed to update valve status in database:', error.message);
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            if (result === 'Success') {
                console.log(`‚úÖ Valve ${floorId}-${valveId} status updated: ${newStatus}`);
            } else {
                console.log(`‚ö†Ô∏è Valve ${floorId}-${valveId} command failed: ${result}`);
                showNotification(`‡∏ß‡∏≤‡∏•‡πå‡∏ß ${floorId}-${valveId}: ${result}`, 'error');
            }
        }
    }
}

function handleLayerResponse(data) {
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ response ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Layer commands
    if (data.Layer && data.Result) {
        const layer = data.Layer.replace('Layer_', '');
        const floorId = parseInt(layer);
        
        if (data.Result === 'Success') {
            showNotification(`‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà ${floorId}: ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        } else {
            showNotification(`‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà ${floorId}: ${data.Result}`, 'error');
        }
    }
}

// WebSocket connection for real-time updates
let waterSystemWebSocket = null;

function connectWaterSystemWebSocket() {
    try {
        // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• real-time
        waterSystemWebSocket = new WebSocket(`ws://${window.location.host}/ws/water-system`);
        
        waterSystemWebSocket.onopen = function() {
            console.log('‚úÖ Water System WebSocket connected');
        };
        
        waterSystemWebSocket.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                handleWaterSystemResponse(data);
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        };
        
        waterSystemWebSocket.onclose = function() {
            console.log('‚ö†Ô∏è Water System WebSocket disconnected, attempting to reconnect...');
            // ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setTimeout(connectWaterSystemWebSocket, 5000);
        };
        
        waterSystemWebSocket.onerror = function(error) {
            console.error('Water System WebSocket error:', error);
        };
    } catch (error) {
        console.error('Failed to connect WebSocket:', error);
        // Fallback ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ polling ‡πÅ‡∏ó‡∏ô
        startWaterSystemPolling();
    }
}

// Polling fallback for systems without WebSocket
function startWaterSystemDataPolling() {
    const pollingInterval = setInterval(async () => {
        try {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å backend
            const response = await fetch('/api/water-system/status');
            if (response.ok) {
                const data = await response.json();
                if (data.updates && data.updates.length > 0) {
                    data.updates.forEach(update => {
                        handleWaterSystemResponse(update);
                    });
                }
            }
        } catch (error) {
            console.log('Polling error:', error.message);
        }
    }, 2000); // ‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    
    return pollingInterval;
}

async function loadWaterSystemData() {
    try {
        const response = await fetch('/api/water-system');
        if (response.ok) {
            const data = await response.json();
            
            // Update EC and water level from database
            if (data.homeSettings) {
                waterSystemData.homeSettings.ecValue = data.homeSettings.ecValue || 1.5;
                waterSystemData.homeSettings.waterLevel = data.homeSettings.waterLevel || 75;
                waterSystemData.homeSettings.isActive = data.homeSettings.isActive || false;
                updateECDisplay(waterSystemData.homeSettings.ecValue);
                updateWaterLevelDisplay(waterSystemData.homeSettings.waterLevel);
            }
            
            // Update floors data from database
            if (data.floors && Array.isArray(data.floors)) {
                data.floors.forEach(floorData => {
                    const floor = waterSystemFloors.find(f => f.id === floorData.id);
                    if (floor && floorData.valves && Array.isArray(floorData.valves)) {
                        floorData.valves.forEach(valveData => {
                            const valve = floor.valves.find(v => v.id === valveData.id);
                            if (valve) {
                                valve.status = valveData.status || 'closed';
                                valve.usage = valveData.usage || 0;
                                valve.deviceId = valveData.deviceId;
                                valve.lastUpdated = valveData.lastUpdated;
                            }
                        });
                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏±‡πâ‡∏ô
                        updateFloorDisplay(floorData.id);
                    }
                });
            }
            
            // Update statistics from database
            if (data.stats && Array.isArray(data.stats)) {
                data.stats.forEach(stat => {
                    updateFloorStatsFromDB(stat.floor_id, stat);
                });
            }
            
            console.log('‚úÖ Water system data loaded from database');
        } else {
            console.log('‚ö†Ô∏è Database not available, using default values');
        }
    } catch (error) {
        console.log('‚ö†Ô∏è Failed to load water system data from database:', error.message);
    }
}

async function sendValveCommand(floorId, valveId, status) {
    try {
        console.log(`üì° Sending Valve Command: Floor ${floorId}, Valve ${valveId}, Status ${status}`);
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Device ID ‡∏à‡∏≤‡∏Å floor ‡πÅ‡∏•‡∏∞ valve
        const deviceId = ((floorId - 1) * 18) + valveId;
        console.log(`üî¢ Calculated Device ID: ${deviceId}`);
        
        const payload = {
            Key: "1097BD225248",
            Device: deviceId.toString(),
            Status: status === 'open' ? "Open" : "Close"
        };
        console.log(`üì¶ Payload:`, payload);
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° timeout controller
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            console.log('‚è∞ Request timeout after 10 seconds');
            controller.abort();
        }, 10000); // 10 seconds timeout
        
        try {
            // ‡πÉ‡∏ä‡πâ API ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ topic ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            const response = await fetch('/api/mqtt-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'layer',
                    topic: 'water/layer',
                    payload: payload
                }),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            console.log(`üì° Response status: ${response.status}`);
            
            if (response.ok) {
                const result = await response.json();
                console.log('‚úÖ Valve command sent successfully:', result);
                return true;
            } else {
                const errorText = await response.text();
                console.log(`‚ö†Ô∏è Failed to send valve command. Status: ${response.status}, Error: ${errorText}`);
                return false;
            }
        } catch (fetchError) {
            clearTimeout(timeoutId);
            if (fetchError.name === 'AbortError') {
                console.log('‚è∞ Request was aborted due to timeout');
            } else {
                console.log('‚ö†Ô∏è Fetch error:', fetchError.message);
            }
            return false;
        }
    } catch (error) {
        console.log('‚ö†Ô∏è General error in sendValveCommand:', error.message);
        return false;
    }
}

async function sendHomeWateringCommand(ecValue, waterLevel) {
    try {
        const payload = {
            Key: "1097BD225248",
            Profile: Math.floor(ecValue).toString(), // ‡πÅ‡∏õ‡∏•‡∏á EC ‡πÄ‡∏õ‡πá‡∏ô integer
            Device: "Open"
        };
        
        console.log('Sending Home Water Command:', JSON.stringify(payload));
        
        // ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô backend ‡πÑ‡∏õ‡∏¢‡∏±‡∏á ESP32 
        const response = await fetch('/api/mqtt-command', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: 'home',
                topic: 'water/home',
                payload: payload
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Home watering command sent successfully:', result);
            return true;
        } else {
            console.log('‚ö†Ô∏è Failed to send home watering command to backend');
            return false;
        }
    } catch (error) {
        console.log('‚ö†Ô∏è Error sending home watering command:', error.message);
        return false;
    }
}

async function sendFloorWateringCommand(floorId, turnOn) {
    try {
        // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏ó‡∏±‡πâ‡∏á 18 ‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏±‡πâ‡∏ô
        const promises = [];
        
        for (let valveId = 1; valveId <= 18; valveId++) {
            const deviceId = ((floorId - 1) * 18) + valveId;
            
            const payload = {
                Key: "1097BD225248",
                Device: deviceId.toString(),
                Status: turnOn ? "Open" : "Close"
            };
            
            const promise = fetch('/api/mqtt-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'valve',
                    topic: 'water/valve',
                    payload: payload
                })
            });
            
            promises.push(promise);
        }
        
        console.log(`Sending Floor ${floorId} Command: ${turnOn ? 'Open' : 'Close'} all 18 valves`);
        
        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
        const responses = await Promise.all(promises);
        const allSuccess = responses.every(response => response.ok);
        
        if (allSuccess) {
            console.log(`‚úÖ Floor ${floorId} watering command sent successfully`);
            return true;
        } else {
            console.log(`‚ö†Ô∏è Some valve commands failed for floor ${floorId}`);
            return false;
        }
    } catch (error) {
        console.log('‚ö†Ô∏è Error sending floor watering command:', error.message);
        return false;
    }
}


function updateECDisplay(value) {
    const currentValueElement = document.getElementById('ecCurrentValue');
    const summaryElement = document.getElementById('ecSummary');
    
    if (currentValueElement) currentValueElement.textContent = value;
    if (summaryElement) summaryElement.textContent = value;
}

function updateECValue(value) {
    waterSystemData.homeSettings.ecValue = parseFloat(value);
    updateECDisplay(value);
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà)
    
    showNotification(`üíß ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ EC ‡πÄ‡∏õ‡πá‡∏ô ${value} mS/cm`, 'success');
}

function updateVolumeDisplay(value) {
    document.getElementById('volumeCurrentValue').textContent = value;
    document.querySelector('.volume-fill').style.width = `${value}%`;
}

// Home watering functions
// Water level functions
function updateWaterLevelDisplay(value) {
    const currentValueElement = document.getElementById('waterLevelValue');
    const barElement = document.getElementById('waterLevelBar');
    const summaryElement = document.getElementById('waterLevelSummary');
    
    if (currentValueElement) currentValueElement.textContent = value;
    if (barElement) barElement.style.width = `${value}%`;
    if (summaryElement) summaryElement.textContent = value;
}

function updateWaterLevel(value) {
    waterSystemData.homeSettings.waterLevel = parseInt(value);
    updateWaterLevelDisplay(value);
    
    // Update volume status - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á element ‡∏Å‡πà‡∏≠‡∏ô
    const volumeStatus = document.querySelector('.volume-status');
    if (volumeStatus) {
        volumeStatus.innerHTML = `
            <i class="fas ${getVolumeIcon(value)}"></i>
            <span>${getVolumeStatus(value)}</span>
        `;
    }
}

// Home watering confirm function
async function confirmWatering() {
    const message = `‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ EC: ${waterSystemData.homeSettings.ecValue} mS/cm ‚Ä¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: ${waterSystemData.homeSettings.waterLevel}%`;
    const result = await showWaterConfirmDialog(message, '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏•‡∏±‡∏Å', '#4ecdc4', 'home');
    
    if (result) {
        // Send command using new API
        const success = await sendHomeWateringCommand(waterSystemData.homeSettings.ecValue, waterSystemData.homeSettings.waterLevel);
        if (success) {
            showNotification('üö∞ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ô‡πâ‡∏≥‡πÅ‡∏ö‡∏ö manual
            logAction(currentUser.username, `‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏•‡∏±‡∏Å (EC: ${waterSystemData.homeSettings.ecValue} mS/cm, ‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${waterSystemData.homeSettings.waterLevel}%)`, 'manual_control', '‡∏ô‡πâ‡∏≥', currentStation);
        }
    }
}

// MQTT Command functions
// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Home (Profile)
async function sendHomeWaterCommand(status) {
    try {
        const payload = {
            Key: "1097BD225248",
            Profile: Math.floor(waterSystemData.homeSettings.ecValue).toString(), // ‡πÅ‡∏õ‡∏•‡∏á EC ‡πÄ‡∏õ‡πá‡∏ô integer
            Device: status ? "Open" : "Close"
        };
        
        console.log('Sending Home Water Command:', JSON.stringify(payload));
        
        // ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô backend ‡πÑ‡∏õ‡∏¢‡∏±‡∏á ESP32 
        // ‡πÉ‡∏ä‡πâ existing endpoint ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
        const response = await fetch('/api/mqtt-command', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: 'home',
                topic: 'water/home',
                payload: payload
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            showNotification(`üè† ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å: ${status ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'} (EC: ${payload.Profile})`, 'success');
            return true;
        } else {
            throw new Error('Failed to send home command');
        }
        
    } catch (error) {
        console.error('Error sending home water command:', error);
        showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ', 'error');
        return false;
    }
}

// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Layer (Device)
async function sendLayerWaterCommand(deviceId, status) {
    try {
        const payload = {
            Key: "1097BD225248",
            Device: deviceId.toString(),
            Status: status ? "Open" : "Close"
        };
        
        console.log('Sending Layer Water Command:', JSON.stringify(payload));
        
        // ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô backend ‡πÑ‡∏õ‡∏¢‡∏±‡∏á ESP32
        const response = await fetch('/api/mqtt-command', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: 'layer',
                topic: 'water/layer',
                payload: payload
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            showNotification(`üè¢ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ä‡∏±‡πâ‡∏ô ${deviceId}: ${status ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}`, 'success');
            return true;
        } else {
            throw new Error('Failed to send layer command');
        }
        
    } catch (error) {
        console.error('Error sending layer water command:', error);
        showNotification(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ä‡∏±‡πâ‡∏ô ${deviceId} ‡πÑ‡∏î‡πâ`, 'error');
        return false;
    }
}

// Backward compatibility function
async function sendWaterCommand(device, status) {
    if (device === 0) {
        // Home system - ‡πÉ‡∏ä‡πâ Profile format
        return await sendHomeWaterCommand(status);
    } else {
        // Layer system - ‡πÉ‡∏ä‡πâ Device format
        return await sendLayerWaterCommand(device, status);
    }
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á popup ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°
function showWaterConfirmDialog(message, actionText, color = '#4caf50', type = 'layer') {
    return new Promise((resolve) => {
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á overlay
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.8));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(15px) saturate(180%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        `;

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á modal ‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°
        const modal = document.createElement('div');
        const isStop = color === '#f44336';
        const gradientColor = isStop ? 'linear-gradient(135deg, #ff6b6b, #ee5a52, #ff4757)' : 'linear-gradient(135deg, #4ecdc4, #44a08d, #096dd9)';
        
        modal.style.cssText = `
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9));
            backdrop-filter: blur(20px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            padding: 40px 35px;
            min-width: 480px;
            max-width: 520px;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.1),
                0 30px 60px rgba(0, 0, 0, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            text-align: center;
            transform: scale(0.8) translateY(-30px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        `;

        // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÅ‡∏™‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©
        const lightEffect = `
            <div style="
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: conic-gradient(from 0deg, transparent, ${color}15, transparent, ${color}10, transparent);
                animation: rotate-light 3s linear infinite;
                pointer-events: none;
            "></div>
            <style>
                @keyframes rotate-light {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                @keyframes float-icon {
                    0%, 100% { transform: translateY(0px) scale(1); }
                    50% { transform: translateY(-8px) scale(1.05); }
                }
                @keyframes glow-pulse {
                    0%, 100% { box-shadow: 0 0 20px ${color}30; }
                    50% { box-shadow: 0 0 35px ${color}50, 0 0 50px ${color}20; }
                }
                @keyframes shimmer {
                    0% { background-position: -200% center; }
                    100% { background-position: 200% center; }
                }
            </style>
        `;

        modal.innerHTML = `
            ${lightEffect}
            <div style="position: relative; z-index: 2;">
                <div style="
                    background: ${gradientColor};
                    border-radius: 50%;
                    width: 100px;
                    height: 100px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 25px auto;
                    font-size: 3rem;
                    box-shadow: 0 15px 35px ${color}30, inset 0 -3px 8px rgba(0,0,0,0.1);
                    animation: float-icon 2s ease-in-out infinite, glow-pulse 2s ease-in-out infinite;
                    position: relative;
                    overflow: hidden;
                ">
                    <div style="
                        position: absolute;
                        top: -50%;
                        left: -50%;
                        width: 200%;
                        height: 200%;
                        background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.3) 50%, transparent 70%);
                        animation: shimmer 2s infinite;
                    "></div>
                    <div style="position: relative; z-index: 1; display: flex; align-items: center; justify-content: center;">
                        ${isStop ? `
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="filter: drop-shadow(0 2px 8px rgba(255,255,255,0.3));">
                                <circle cx="12" cy="12" r="10" fill="url(#stopGradient)" stroke="rgba(255,255,255,0.4)" stroke-width="1"/>
                                <rect x="8" y="8" width="8" height="8" rx="1" fill="white"/>
                                <defs>
                                    <linearGradient id="stopGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#ff6b6b"/>
                                        <stop offset="100%" style="stop-color:#ff4757"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        ` : (type === 'home' ? `
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="filter: drop-shadow(0 2px 8px rgba(255,255,255,0.3));">
                                <path d="M12 2L2 12h3v8h14v-8h3L12 2z" fill="url(#homeGradient)" stroke="rgba(255,255,255,0.4)" stroke-width="0.5"/>
                                <circle cx="18" cy="6" r="4" fill="url(#waterGradient)" opacity="0.9"/>
                                <path d="M16 4c0-1.1.9-2 2-2s2 .9 2 2c0 1.1-.9 2-2 2s-2-.9-2-2z" fill="white" opacity="0.8"/>
                                <defs>
                                    <linearGradient id="homeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#4ecdc4"/>
                                        <stop offset="100%" style="stop-color:#44a08d"/>
                                    </linearGradient>
                                    <linearGradient id="waterGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#74b9ff"/>
                                        <stop offset="100%" style="stop-color:#0984e3"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        ` : `
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="filter: drop-shadow(0 2px 8px rgba(255,255,255,0.3));">
                                <path d="M12 2L8 6v2H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-2V6l-4-4z" fill="url(#layerGradient)" stroke="rgba(255,255,255,0.4)" stroke-width="0.5"/>
                                <path d="M8 14h8v2H8v-2z" fill="white" opacity="0.9"/>
                                <path d="M10 16v2h4v-2" fill="url(#flowGradient)"/>
                                <circle cx="12" cy="11" r="1.5" fill="white" opacity="0.8"/>
                                <defs>
                                    <linearGradient id="layerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#4ecdc4"/>
                                        <stop offset="50%" style="stop-color:#44a08d"/>
                                        <stop offset="100%" style="stop-color:#096dd9"/>
                                    </linearGradient>
                                    <linearGradient id="flowGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#74b9ff"/>
                                        <stop offset="100%" style="stop-color:#0984e3"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        `)}
                    </div>
                </div>
                
                <h2 style="
                    margin: 0 0 12px 0;
                    font-size: 1.8rem;
                    background: ${gradientColor};
                    -webkit-background-clip: text;
    background-clip: text;
                    background-clip: text;
                    -webkit-text-fill-color: transparent;
                    font-weight: 700;
                    letter-spacing: -0.5px;
                ">${type === 'home' ? 'üè† ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏•‡∏±‡∏Å' : 'üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏ä‡∏±‡πâ‡∏ô'}</h2>
                
                <h3 style="
                    margin: 0 0 8px 0;
                    font-size: 1.3rem;
                    color: #2d3748;
                    font-weight: 600;
                ">${message}</h3>
                
                <p style="
                    margin: 0 0 30px 0;
                    color: #718096;
                    line-height: 1.6;
                    font-size: 1rem;
                ">${isStop ? '‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ' : '‚ú® ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥'}</p>
                
                <div style="
                    display: flex;
                    gap: 16px;
                    justify-content: center;
                ">
                    <button id="cancelBtn" style="
                        padding: 16px 32px;
                        border: 2px solid rgba(113, 128, 150, 0.3);
                        background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
                        color: #4a5568;
                        border-radius: 16px;
                        font-weight: 600;
                        font-size: 1rem;
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        backdrop-filter: blur(10px);
                        position: relative;
                        overflow: hidden;
                    ">
                        <div style="position: relative; z-index: 1; display: flex; align-items: center; gap: 8px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.6"/>
                                <path d="M15 9l-6 6M9 9l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <span>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>
                        </div>
                    </button>
                    
                    <button id="confirmBtn" style="
                        padding: 16px 32px;
                        border: none;
                        background: ${gradientColor};
                        color: white;
                        border-radius: 16px;
                        font-weight: 700;
                        font-size: 1rem;
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        box-shadow: 0 8px 25px ${color}40, inset 0 1px 0 rgba(255,255,255,0.3);
                        position: relative;
                        overflow: hidden;
                        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                    ">
                        <div style="
                            position: absolute;
                            top: 0;
                            left: -100%;
                            width: 100%;
                            height: 100%;
                            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
                            transition: left 0.5s;
                        " class="shimmer-effect"></div>
                        <div style="position: relative; z-index: 1; display: flex; align-items: center; gap: 10px;">
                            ${isStop ? `
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="9" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
                                    <rect x="9" y="9" width="6" height="6" rx="0.5" fill="white"/>
                                </svg>
                                <span>‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥</span>
                            ` : `
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="9" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
                                    <path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>${actionText}</span>
                            `}
                        </div>
                    </button>
                </div>
            </div>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏õ‡∏¥‡∏î
        setTimeout(() => {
            overlay.style.opacity = '1';
            modal.style.transform = 'scale(1) translateY(0)';
        }, 10);

        // Event listeners
        const cancelBtn = modal.querySelector('#cancelBtn');
        const confirmBtn = modal.querySelector('#confirmBtn');

        const closeModal = (result) => {
            modal.style.transform = 'scale(0.8) translateY(-30px)';
            overlay.style.opacity = '0';
            setTimeout(() => {
                document.body.removeChild(overlay);
                resolve(result);
            }, 400);
        };

        cancelBtn.addEventListener('click', () => closeModal(false));
        confirmBtn.addEventListener('click', () => closeModal(true));
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closeModal(false);
        });

        // ‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° hover effects
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = 'linear-gradient(145deg, rgba(248, 250, 252, 0.95), rgba(237, 242, 247, 0.9))';
            cancelBtn.style.borderColor = 'rgba(113, 128, 150, 0.5)';
            cancelBtn.style.transform = 'translateY(-3px)';
            cancelBtn.style.boxShadow = '0 10px 25px rgba(113, 128, 150, 0.2)';
        });
        
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = 'linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8))';
            cancelBtn.style.borderColor = 'rgba(113, 128, 150, 0.3)';
            cancelBtn.style.transform = 'translateY(0)';
            cancelBtn.style.boxShadow = 'none';
        });

        confirmBtn.addEventListener('mouseenter', () => {
            confirmBtn.style.transform = 'translateY(-3px) scale(1.02)';
            confirmBtn.style.boxShadow = `0 15px 35px ${color}50, inset 0 1px 0 rgba(255,255,255,0.4)`;
            // ‡πÄ‡∏£‡∏¥‡πà‡∏° shimmer effect
            const shimmer = confirmBtn.querySelector('.shimmer-effect');
            shimmer.style.left = '100%';
        });
        
        confirmBtn.addEventListener('mouseleave', () => {
            confirmBtn.style.transform = 'translateY(0) scale(1)';
            confirmBtn.style.boxShadow = `0 8px 25px ${color}40, inset 0 1px 0 rgba(255,255,255,0.3)`;
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï shimmer effect
            const shimmer = confirmBtn.querySelector('.shimmer-effect');
            shimmer.style.left = '-100%';
        });

        // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î
        document.addEventListener('keydown', function keyHandler(e) {
            if (e.key === 'Enter') {
                confirmBtn.click();
                document.removeEventListener('keydown', keyHandler);
            } else if (e.key === 'Escape') {
                cancelBtn.click();
                document.removeEventListener('keydown', keyHandler);
            }
        });
    });
}

// Layer watering functions  
async function confirmLayerWatering(layerId) {
    const layer = waterSystemData.layers.find(l => l.id === layerId);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏±‡πä‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!layer || !layer.pumpInstalled) {
        showNotification('‚ùå ‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á', 'error');
        return;
    }
    
    if (layer.isActive) {
        // ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥
        const result = await showWaterConfirmDialog(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥ ${layer.name}?`, '‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥', '#f44336');
        if (result) {
            const success = await sendWaterCommand(layerId, false);
            if (success) {
                layer.isActive = false;
                layer.pumpStatus = '‡∏õ‡∏¥‡∏î';
                layer.waterFlow = 0;
                showNotification(`üõë ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥${layer.name}‡πÅ‡∏•‡πâ‡∏ß`, 'info');
                updateLayerDisplay(layerId);
                // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡πÅ‡∏ö‡∏ö manual
                logAction(currentUser.username, `‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥ ${layer.name}`, 'manual_control', '‡∏ô‡πâ‡∏≥', currentStation);
            }
        }
    } else {
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥
        const result = await showWaterConfirmDialog(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥ ${layer.name}?`, '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥', '#4caf50');
        if (result) {
            const success = await sendWaterCommand(layerId, true);
            if (success) {
                layer.isActive = true;
                layer.pumpStatus = '‡πÄ‡∏õ‡∏¥‡∏î';
                layer.waterFlow = Math.floor(Math.random() * 50) + 25; // ‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡∏™‡∏∏‡πà‡∏° 25-75%
                showNotification(`üö∞ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥${layer.name}‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                updateLayerDisplay(layerId);
                // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡πÅ‡∏ö‡∏ö manual
                logAction(currentUser.username, `‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥ ${layer.name}`, 'manual_control', '‡∏ô‡πâ‡∏≥', currentStation);
            }
        }
    }
}


function updateLayerDisplay(layerId) {
    const layer = waterSystemData.layers.find(l => l.id === layerId);
    const layerElement = document.querySelector(`[data-layer="${layerId}"]`);
    
    if (layerElement && layer) {
        layerElement.className = `layer-item ${layer.isActive ? 'active' : ''} ${!layer.pumpInstalled ? 'not-installed' : ''}`;
        
        const icon = layerElement.querySelector('.layer-icon');
        if (layer.pumpInstalled) {
            icon.className = `layer-icon ${layer.isActive ? 'active' : 'inactive'}`;
            icon.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2C8 7 6 10 6 14c0 3.31 2.69 6 6 6s6-2.69 6-6c0-4-2-7-6-12z" fill="currentColor" opacity="0.8"/>
                    <ellipse cx="12" cy="16" rx="2" ry="1" fill="rgba(255,255,255,0.6)"/>
                </svg>
            `;
        } else {
            icon.className = `layer-icon not-installed`;
            icon.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" fill="currentColor" opacity="0.6"/>
                </svg>
            `;
        }
        
        const details = layerElement.querySelector('.layer-details p');
        if (layer.pumpInstalled) {
            details.textContent = `‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥: ${layer.pumpStatus} ‚Ä¢ ‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•: ${layer.waterFlow}%`;
        } else {
            details.textContent = '‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á';
        }
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏±‡πä‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß
        if (layer.pumpInstalled) {
            const pumpStatus = layerElement.querySelector('.pump-status');
            if (pumpStatus) {
                pumpStatus.className = `pump-status ${layer.isActive ? 'active' : 'inactive'}`;
                pumpStatus.textContent = layer.pumpStatus;
            }
            
            const flowValue = layerElement.querySelector('.flow-value');
            if (flowValue) {
                flowValue.textContent = `${layer.waterFlow}%`;
            }
            
            const waterBtn = layerElement.querySelector('.water-layer-btn');
            if (waterBtn) {
                waterBtn.innerHTML = `
                    ${layer.isActive ? `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="filter: drop-shadow(0 1px 2px rgba(255,255,255,0.3));">
                            <circle cx="12" cy="12" r="8" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
                            <rect x="9" y="9" width="6" height="6" rx="0.5" fill="white"/>
                        </svg>
                    ` : `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="filter: drop-shadow(0 1px 2px rgba(255,255,255,0.3));">
                            <circle cx="12" cy="12" r="8" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
                            <path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    `}
                    ${layer.isActive ? '‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ï‡∏¥‡∏°' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°'}
                `;
            }
        }
    }
}

async function toggleAllLayers(activate) {
    if (activate) {
        const result = await showWaterConfirmDialog('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß?', '‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô', '#4caf50');
        if (result) {
            let actionCount = 0;
            waterSystemData.layers.forEach(layer => {
                if (layer.pumpInstalled && !layer.isActive) {
                    sendWaterCommand(layer.id, true);
                    layer.isActive = true;
                    layer.pumpStatus = '‡πÄ‡∏õ‡∏¥‡∏î';
                    layer.waterFlow = Math.floor(Math.random() * 50) + 25;
                    updateLayerDisplay(layer.id);
                    actionCount++;
                }
            });
            showNotification(actionCount > 0 ? `‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥ ${actionCount} ‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß` : '‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î', 'success');
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏ö‡∏ö manual
            if (actionCount > 0) {
                logAction(currentUser.username, `‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô (${actionCount} ‡∏ä‡∏±‡πâ‡∏ô)`, 'manual_control', '‡∏ô‡πâ‡∏≥', currentStation);
            }
        }
    } else {
        const result = await showWaterConfirmDialog('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô?', '‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô', '#f44336');
        if (result) {
            let actionCount = 0;
            waterSystemData.layers.forEach(layer => {
                if (layer.isActive) {
                    sendWaterCommand(layer.id, false);
                    layer.isActive = false;
                    layer.pumpStatus = '‡∏õ‡∏¥‡∏î';
                    layer.waterFlow = 0;
                    updateLayerDisplay(layer.id);
                    actionCount++;
                }
            });
            showNotification(actionCount > 0 ? `‚ùå ‡∏õ‡∏¥‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥ ${actionCount} ‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß` : '‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥', 'info');
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏ö‡∏ö manual
            if (actionCount > 0) {
                logAction(currentUser.username, `‡∏õ‡∏¥‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô (${actionCount} ‡∏ä‡∏±‡πâ‡∏ô)`, 'manual_control', '‡∏ô‡πâ‡∏≥', currentStation);
            }
        }
    }
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢
function getECStatus(value) {
    value = parseFloat(value);
    if (value >= 1.0 && value <= 2.0) return 'optimal';
    if (value >= 0.8 && value <= 2.5) return 'warning';
    return 'danger';
}

function getECStatusText(value) {
    value = parseFloat(value);
    if (value >= 1.0 && value <= 2.0) return '‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°';
    if (value >= 0.8 && value <= 2.5) return '‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ';
    return '‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ';
}

function getVolumeIcon(value) {
    value = parseInt(value);
    if (value >= 70) return 'fa-tint';
    if (value >= 30) return 'fa-tint-slash';
    return 'fa-exclamation-triangle';
}

function getVolumeStatus(value) {
    value = parseInt(value);
    if (value >= 70) return '‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠';
    if (value >= 30) return '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
    return '‡∏ï‡πà‡∏≥';
}

function formatTime(date) {
    return new Intl.DateTimeFormat('th-TH', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    }).format(date);
}

function startWateringSystemPolling() {
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    const updateTimer = setInterval(() => {
        if (currentPage === 'watering-system') {
            waterSystemData.homeSettings.lastUpdate = new Date();
            const timeElement = document.getElementById('lastUpdateTime');
            if (timeElement) {
                timeElement.textContent = formatTime(waterSystemData.homeSettings.lastUpdate);
            }
        }
    }, 1000);
    activeTimers.add(updateTimer);
}

// Water Status Update Function
function updateWaterStatus(data) {
    console.log('üö∞ Water Status Update:', data);
    
    const { topic, data: waterData, timestamp } = data;
    const { Key, Profile, Device, Status } = waterData;
    
    // Update system status
    const systemStatus = document.getElementById('waterSystemStatus');
    if (systemStatus) {
        const statusIcon = systemStatus.querySelector('i');
        const statusText = systemStatus.querySelector('span');
        
        if (Status === 'doing') {
            statusIcon.className = 'fas fa-spinner fa-spin';
            statusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...';
            systemStatus.style.color = '#ff9800';
        } else if (Status === 'Success') {
            statusIcon.className = 'fas fa-check-circle';
            statusText.textContent = '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            systemStatus.style.color = '#4caf50';
            
            // Reset to ready status after 3 seconds
            setTimeout(() => {
                statusIcon.className = 'fas fa-check-circle';
                statusText.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                systemStatus.style.color = '';
            }, 3000);
        }
    }
    
    // Handle Home Water System (water/home)
    if (topic === 'water/home') {
        const homeBtn = document.getElementById('homeWaterBtn');
        const homeStatus = document.getElementById('homeWaterStatus');
        
        if (homeBtn && homeStatus) {
            if (Status === 'doing') {
                homeBtn.style.display = 'none';
                homeStatus.style.display = 'flex';
                homeStatus.querySelector('.status-text').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥...';
                homeStatus.querySelector('.status-icon i').className = 'fas fa-spinner fa-spin';
            } else if (Status === 'Success') {
                homeStatus.querySelector('.status-text').textContent = '‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                homeStatus.querySelector('.status-icon i').className = 'fas fa-check-circle';
                
                // Reset after 2 seconds
                setTimeout(() => {
                    homeBtn.style.display = 'block';
                    homeStatus.style.display = 'none';
                }, 2000);
            }
        }
    }
    
    // Handle Layer Water System (water/layer)
    if (topic === 'water/layer' && Device) {
        const layerBtn = document.getElementById(`layerWaterBtn${Device}`);
        const layerStatus = document.getElementById(`layerWaterStatus${Device}`);
        
        if (layerBtn && layerStatus) {
            if (Status === 'doing') {
                layerBtn.style.display = 'none';
                layerStatus.style.display = 'flex';
                layerStatus.querySelector('.status-text').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...';
                layerStatus.querySelector('.status-icon i').className = 'fas fa-spinner fa-spin';
            } else if (Status === 'Success') {
                layerStatus.querySelector('.status-text').textContent = '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                layerStatus.querySelector('.status-icon i').className = 'fas fa-check-circle';
                
                // Reset after 2 seconds
                setTimeout(() => {
                    layerBtn.style.display = 'block';
                    layerStatus.style.display = 'none';
                }, 2000);
            }
        }
        
        // Update layer data if exists
        const layer = waterSystemData.layers.find(l => l.id === parseInt(Device));
        if (layer) {
            if (Status === 'doing') {
                layer.isActive = true;
                layer.pumpStatus = '‡πÄ‡∏õ‡∏¥‡∏î';
            } else if (Status === 'Success') {
                layer.isActive = false;
                layer.pumpStatus = '‡∏õ‡∏¥‡∏î';
                layer.waterFlow = 0;
            }
            updateLayerDisplay(parseInt(Device));
        }
    }
}

function startWateringSystemPolling() {
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    const updateTimer = setInterval(() => {
        if (currentPage === 'watering-system') {
            waterSystemData.homeSettings.lastUpdate = new Date();
            const timeElement = document.getElementById('lastUpdateTime');
            if (timeElement) {
                timeElement.textContent = formatTime(waterSystemData.homeSettings.lastUpdate);
            }
        }
    }, 1000);
    activeTimers.add(updateTimer);
    
    // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    const dataTimer = setInterval(() => {
        if (currentPage === 'watering-system') {
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°
            waterSystemData.layers.forEach(layer => {
                if (layer.isActive) {
                    const variation = (Math.random() - 0.5) * 10; // ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ¬±5%
                    layer.waterFlow = Math.max(0, Math.min(100, layer.waterFlow + variation));
                    updateLayerDisplay(layer.id);
                }
            });
        }
    }, 2000);
    activeTimers.add(dataTimer);
}

// ‚úÖ Helper functions for water system database integration
function logWaterSystemAction(type, target, action, response) {
    const logEntry = {
        timestamp: new Date().toISOString(),
        type: type,
        target: target,
        action: action,
        response: response
    };
    console.log('üíß Water System Log:', logEntry);
}

function updateFloorStatsFromDB(floorId, stats) {
    try {
        const statsElement = document.querySelector(`#water-floor-${floorId} .floor-stats`);
        if (statsElement) {
            statsElement.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                    <span class="stat-value">${stats.total_valves || 18}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">‡πÄ‡∏õ‡∏¥‡∏î:</span>
                    <span class="stat-value text-green-600">${stats.valves_open || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</span>
                    <span class="stat-value text-blue-600">${stats.valves_working || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">‡∏õ‡∏¥‡∏î:</span>
                    <span class="stat-value text-gray-600">${stats.valves_closed || 18}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</span>
                    <span class="stat-value">${parseFloat(stats.avg_usage_percent || 0).toFixed(1)}%</span>
                </div>
            `;
        }
    } catch (error) {
        console.log('‚ö†Ô∏è Error updating floor stats from DB:', error.message);
    }
}

function updateFloorDisplay(floorId) {
    const floor = waterSystemFloors.find(f => f.id === floorId);
    if (floor) {
        floor.valves.forEach(valve => {
            updateValveDisplay(floorId, valve.id, valve);
        });
        updateFloorStats(floorId);
    }
}

let currentRoleFilter = 'all';
let searchQuery = '';
let allUsers = [];
let sessionPingInterval = null; // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô null
// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
async function loadUsers() {
    const tableBody = document.getElementById('userTableBody');
    
    try {
        const response = await fetch('/api/users');
        const users = await response.json();
        allUsers = users;
        
        // Update stats
        updateUserStats(users);
        
        // Filter and display users
        displayUsers(filterUsers(users));
        
    } catch (error) {
        console.error('Error loading users:', error);
        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-12 text-center">
                        <div class="flex flex-col items-center gap-4">
                            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                            <p class="text-gray-600">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</p>
                            <button onclick="loadUsers()" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-redo mr-2"></i> ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
    }
}
function getAvatarColor(username) {
    if (!username) return '#64748b'; // ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
    let hash = 0;
    for (let i = 0; i < username.length; i++) {
        hash = username.charCodeAt(i) + ((hash << 5) - hash);
    }
    const colors = [
        '#ef4444', '#f97316', '#f59e0b', '#84cc16',
        '#22c55e', '#10b981', '#06b6d4', '#3b82f6',
        '#6366f1', '#8b5cf6', '#d946ef', '#ec4899'
    ];
    const index = Math.abs(hash % colors.length);
    return colors[index];
}
// ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
function updateUserStats(users) {
    document.getElementById('totalUsers').textContent = users.length;
    
    // ‡∏ô‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (IT ‡πÅ‡∏•‡∏∞ ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô)
    const adminCount = users.filter(u => u.role === 'it' || u.role === '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô').length;
    document.getElementById('adminUsers').textContent = adminCount;
    
    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
   const onlineCount = users.filter(u => u.is_online === true).length;
document.getElementById('onlineUsers').textContent = onlineCount;
    
    // ‡∏ô‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    const today = new Date().toDateString();
    const newToday = users.filter(u => {
        const userDate = new Date(u.created_at).toDateString();
        return userDate === today;
    }).length;
    document.getElementById('newUsers').textContent = newToday;
}

// ‡∏Å‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
function filterUsers(users) {
    return users.filter(user => {
       const matchesRole = currentRoleFilter === 'all' || user.role.toLowerCase() === currentRoleFilter;
        const matchesSearch = user.username.toLowerCase().includes(searchQuery.toLowerCase());
        return matchesRole && matchesSearch;
    });
}

function displayUsers(users) {
    const tableBody = document.getElementById('userTableBody');

    if (!tableBody) {
        console.error('userTableBody element not found!');
        return;
    }

    if (users.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-12 text-center">
                    <div class="flex flex-col items-center gap-4">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-users-slash text-gray-400 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
                        <p class="text-gray-600">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tableBody.innerHTML = '';

    users.forEach(user => {
        const createdAt = new Date(user.created_at).toLocaleDateString('th-TH', {
            year: 'numeric', month: 'short', day: 'numeric'
        });
        const avatarColor = getAvatarColor(user.username);
        const userInitial = user.username.charAt(0).toUpperCase();
        const isOnline = user.is_online;

        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold" 
                         style="background-color: ${avatarColor};">
                        ${userInitial}
                    </div>
                    <span class="font-medium text-gray-900">${user.username}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                ${getRoleBadgeTailwind(user.role)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-gray-600">
                ${createdAt}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
                    <span class="text-sm ${isOnline ? 'text-green-600' : 'text-gray-500'}">
                        ${isOnline ? '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå' : '‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå'}
                    </span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex gap-2">
                    <button onclick="showEditUserModal(${user.id})" 
                            class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors" 
                            title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="confirmDeleteUser(${user.id}, '${user.username}')" 
                            class="p-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors" 
                            title="‡∏•‡∏ö">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Helper function to darken colors for gradient
function darkenColor(hex, percent) {
    const num = parseInt(hex.replace("#", ""), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) - amt;
    const G = (num >> 8 & 0x00FF) - amt;
    const B = (num & 0x0000FF) - amt;
    return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
function handleSearch(event) {
    searchQuery = event.target.value;
    displayUsers(filterUsers(allUsers));
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° role
function filterByRole(role) {
    currentRoleFilter = role;
    
    // Update active button with Tailwind classes
    document.querySelectorAll('.filter-btn-tw').forEach(btn => {
        // Remove active state
        btn.classList.remove('bg-blue-500', 'text-white', 'shadow-lg');
        btn.classList.add('bg-gray-100', 'text-gray-700');
    });
    
    // Add active state to selected button
    const activeBtn = document.getElementById(`filter-${role === 'all' ? 'all' : 
        role === 'it' ? 'it' : 
        role === 'engineer' ? 'engineer' : 
        role === '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô' ? 'supervisor' : 'employee'}`);
    
    if (activeBtn) {
        activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
        activeBtn.classList.add('bg-blue-500', 'text-white', 'shadow-lg');
    }
    
    displayUsers(filterUsers(allUsers));
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
function checkPasswordStrength(password) {
    const strengthDiv = document.getElementById('passwordStrength');
    
    if (password.length === 0) {
        strengthDiv.classList.add('hidden');
        return;
    }
    
    strengthDiv.classList.remove('hidden');
    
    let strength = 0;
    if (password.length >= 8) strength++;
    if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
    if (password.match(/[0-9]/)) strength++;
    if (password.match(/[^a-zA-Z0-9]/)) strength++;
    
    // Reset all bars with Tailwind classes
    for (let i = 1; i <= 4; i++) {
        const bar = document.getElementById(`strength${i}`);
        bar.classList.remove('bg-red-500', 'bg-yellow-500', 'bg-green-500');
        bar.classList.add('bg-gray-200');
    }
    
    // Fill bars based on strength with Tailwind classes
    for (let i = 1; i <= strength; i++) {
        const bar = document.getElementById(`strength${i}`);
        bar.classList.remove('bg-gray-200');
        if (strength <= 2) {
            bar.classList.add('bg-red-500'); // Weak
        } else if (strength === 3) {
            bar.classList.add('bg-yellow-500'); // Medium
        } else {
            bar.classList.add('bg-green-500'); // Strong
        }
    }
}

// üè∑Ô∏è Enhanced Role Badge with Modern Design
function getRoleBadge(role) {
    const roleConfig = {
        'it': {
            icon: 'fa-laptop-code',
            class: 'admin',
            label: 'IT Admin'
        },
        'engineer': {
            icon: 'fa-hard-hat',
            class: 'engineer', 
            label: 'Engineer'
        },
        '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô': {
            icon: 'fa-user-tie',
            class: 'supervisor',
            label: '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô'
        },
        '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': {
            icon: 'fa-user',
            class: 'employee',
            label: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'
        }
    };
    
    const config = roleConfig[role] || {
        icon: 'fa-user',
        class: 'employee',
        label: role
    };
    
    return `<div class="role-badge ${config.class}">
        <i class="fas ${config.icon}"></i>
        <span>${config.label}</span>
    </div>`;
}

function getRoleBadgeTailwind(role) {
    const roleConfig = {
        'it': {
            icon: 'fa-laptop-code',
            bgColor: 'bg-blue-100',
            textColor: 'text-blue-800',
            label: 'IT Admin'
        },
        'engineer': {
            icon: 'fa-hard-hat',
            bgColor: 'bg-orange-100',
            textColor: 'text-orange-800', 
            label: 'Engineer'
        },
        '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô': {
            icon: 'fa-user-tie',
            bgColor: 'bg-purple-100',
            textColor: 'text-purple-800',
            label: '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô'
        },
        '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': {
            icon: 'fa-user',
            bgColor: 'bg-green-100',
            textColor: 'text-green-800',
            label: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'
        }
    };
    
    const config = roleConfig[role] || {
        icon: 'fa-user',
        bgColor: 'bg-gray-100',
        textColor: 'text-gray-800',
        label: role
    };
    
    return `<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium ${config.bgColor} ${config.textColor}">
        <i class="fas ${config.icon}"></i>
        ${config.label}
    </span>`;
}

// ‡πÅ‡∏™‡∏î‡∏á Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
function showAddUserModal() {
    document.getElementById('userId').value = '';
    document.getElementById('userUsername').value = '';
    document.getElementById('userPassword').value = '';
    document.getElementById('userRole').value = '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
    document.getElementById('userUsername').disabled = false;
    document.getElementById('userPassword').placeholder = '‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢';
    document.getElementById('userModalTitle').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà';
    document.getElementById('userModalSubtitle').innerText = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
    
    // Show modal with Tailwind classes
    const modal = document.getElementById('userModal');
    modal.classList.remove('hidden');
    
    // Reset password strength
    document.getElementById('passwordStrength').classList.add('hidden');
}

// ‡πÅ‡∏™‡∏î‡∏á Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
async function showEditUserModal(id) {
    try {
        const response = await fetch(`/api/users/${id}`);
        const user = await response.json();

        document.getElementById('userId').value = user.id;
        document.getElementById('userUsername').value = user.username;
        document.getElementById('userPassword').value = ''; 
        document.getElementById('userRole').value = user.role;
        document.getElementById('userUsername').disabled = true;
        document.getElementById('userPassword').placeholder = '‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô';
        document.getElementById('userModalTitle').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
        document.getElementById('userModalSubtitle').innerText = `‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á ${user.username}`;
        
        // Show modal with Tailwind classes
        const modal = document.getElementById('userModal');
        modal.classList.remove('hidden');
        
        // Reset password strength
        document.getElementById('passwordStrength').classList.add('hidden');
        
    } catch (error) {
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ', false);
    }
}

// ‡∏õ‡∏¥‡∏î Modal
function closeUserModal() {
    const modal = document.getElementById('userModal');
    modal.classList.add('hidden');
    
    // Reset form after animation
    setTimeout(() => {
        document.getElementById('userForm').reset();
        document.getElementById('passwordStrength').classList.add('hidden');
    }, 300);
}

// ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô form submit)
function handleSaveUser(event) {
    event.preventDefault();
    saveUser();
}

// 7. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
async function saveUser() {
    const id = document.getElementById('userId').value;
    const username = document.getElementById('userUsername').value;
    const password = document.getElementById('userPassword').value;
    const role = document.getElementById('userRole').value;

    const isEditing = !!id;
    const url = isEditing ? `/api/users/${id}` : '/api/users';
    const method = isEditing ? 'PUT' : 'POST';

    const body = { role };
    if (!isEditing) { body.username = username; }
    if (password) { body.password = password; }
    
    if (!username || (!password && !isEditing) || !role) {
        showToast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', false);
        return;
    }

    try {
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const result = await response.json();

        if (response.ok) {
            showToast(`‚úÖ ${isEditing ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï' : '‡πÄ‡∏û‡∏¥‡πà‡∏°'}‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, true);
            closeUserModal();
            loadUsers();
        } else {
            showToast(`‚ùå ${result.error}`, false);
        }
    } catch (error) {
        showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', false);
    }
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
function confirmDeleteUser(id, username) {
    const modal = document.getElementById('deleteConfirmModal');
    const textElement = document.getElementById('deleteConfirmText');
    const confirmBtn = document.getElementById('confirmDeleteBtn');

    if (!modal || !textElement || !confirmBtn) {
        console.error("Delete modal elements not found!");
        return;
    }

    // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å
    textElement.innerHTML = `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ <strong>"${username}"</strong> ?<br>‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`;
    
    // ‡πÄ‡∏Å‡πá‡∏ö id ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°
    confirmBtn.dataset.userId = id;
    
    // ‡πÅ‡∏™‡∏î‡∏á Modal with Tailwind classes
    modal.classList.remove('hidden');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î Modal
function closeDeleteConfirmModal() {
    const modal = document.getElementById('deleteConfirmModal');
    if(modal) {
        modal.classList.add('hidden');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÉ‡∏ô Modal
function handleConfirmDelete() {
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const userId = confirmBtn.dataset.userId; // ‡∏î‡∏∂‡∏á id ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤

    if (userId) {
        deleteUser(userId); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏î‡∏¥‡∏°
    }
    closeDeleteConfirmModal(); // ‡∏õ‡∏¥‡∏î Modal
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á API (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
async function deleteUser(id) {
    try {
        const response = await fetch(`/api/users/${id}`, {
            method: 'DELETE'
        });
        const result = await response.json();

        if (response.ok) {
            showToast('‚úÖ ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', true);
            loadUsers(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        } else {
            showToast(`‚ùå ${result.error}`, false);
        }
    } catch (error) {
        showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', false);
    }
}
//  [‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô startPinging ‡πÄ‡∏î‡∏¥‡∏°] ‚úÖ‚úÖ‚úÖ
function startPinging() {
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Timer ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢
    if (sessionPingInterval) {
        console.log("Ping is already running.");
        return;
    }

    const userId = localStorage.getItem("userId");
    if (!userId) return;

    const ping = () => {
        fetch('/api/users/ping', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: userId })
        }).catch(err => console.error("Ping failed:", err));
    };

    ping(); // Ping ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Timer ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö ID ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ sessionPingInterval
    sessionPingInterval = setInterval(ping, 30 * 1000); // Ping ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    console.log("üü¢ Online status pinging STARTED. Interval ID:", sessionPingInterval);
}

function updateTaskHistoryStats(data) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const todayTasks = data.filter(task => {
    const taskDate = new Date(task.completed_at || task.created_at);
    taskDate.setHours(0, 0, 0, 0);
    return taskDate.getTime() === today.getTime();
  });
  
  const inboundTasks = data.filter(task => task.action_type === 'inbound');
  const outboundTasks = data.filter(task => task.action_type === 'outbound');
  const successTasks = data.filter(task => task.status === 'success');
  const pendingTasks = data.filter(task => task.status === 'pending');
  
  document.getElementById('todayTaskCount').textContent = todayTasks.length;
  document.getElementById('inboundCount').textContent = inboundTasks.length;
  document.getElementById('outboundCount').textContent = outboundTasks.length;
  document.getElementById('successCount').textContent = successTasks.length;
  document.getElementById('pendingCount').textContent = pendingTasks.length;
}

// =============================================================================
// üå± ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Planting Plan - 3 Tabs System ‡∏ï‡∏≤‡∏° Flow ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
// =============================================================================
function renderPlantingPlanPage() {
  document.getElementById("mainContent").innerHTML = `
    <div class="section">
      <div class="planting-plan-header">
        <div class="header-icon-wrapper">
            <i class="fas fa-leaf"></i>
        </div>
        <div class="header-text">
            <h1>‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å</h1>
            <p>Planting Plans Management</p>
        </div>
      </div>
      
      <div class="tab-navigation" style="margin-bottom: 25px;">
        <button class="tab-btn active" onclick="switchPlantingTab('pending')" data-tab="pending">
          <i class="fas fa-clipboard-list"></i> ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥
          <span id="pendingCount" class="tab-badge">0</span>
        </button>
        <button class="tab-btn" onclick="switchPlantingTab('in-progress')" data-tab="in-progress">
          <i class="fas fa-seedling"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥
          <span id="inProgressCount" class="tab-badge">0</span>
        </button>
        <button class="tab-btn" onclick="switchPlantingTab('history')" data-tab="history">
          <i class="fas fa-clock-rotate-left"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô
          <span id="historyCount" class="tab-badge">0</span>
        </button>
      </div>

      <div id="tabContent" class="tab-content">
        </div>
    </div>
  `;

  // ‡πÇ‡∏´‡∏•‡∏î Tab ‡πÅ‡∏£‡∏Å
  switchPlantingTab('pending');
  
  // Auto refresh ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  if (window.plantingRefreshInterval) {
    clearInterval(window.plantingRefreshInterval);
  }
 window.plantingRefreshInterval = createInterval(() => { // ‚¨ÖÔ∏è‚¨ÖÔ∏è‚¨ÖÔ∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å setInterval ‡πÄ‡∏õ‡πá‡∏ô createInterval
    // ...
    // ‡∏•‡πâ‡∏≤‡∏á cache ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà auto-refresh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    cachedPendingPlans = null;
    cachedInProgressTrays = null;
    cachedHistoryPlans = null;
    refreshCurrentPlantingTab();
  }, 60000); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏õ‡πá‡∏ô 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  //startPlantingPlanAutoRefresh();
}

// ‚úÖ 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö Tab ‡∏û‡∏£‡πâ‡∏≠‡∏° Animation
function switchPlantingTab(tabName) {
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Tab Navigation
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

  // ‡πÄ‡∏Å‡πá‡∏ö current tab
  window.currentPlantingTab = tabName;

  // ‡πÅ‡∏™‡∏î‡∏á loading
  document.getElementById('tabContent').innerHTML = `
    <div style="text-align: center; padding: 60px;">
      <i class="fas fa-spinner fa-spin fa-2x" style="color: #6b7280;"></i>
      <p style="margin-top: 15px; color: #6b7280;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>
  `;

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° Tab (‡∏•‡∏ö setTimeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)
  switch(tabName) {
    case 'pending':
      loadPendingPlantingTasks();
      break;
    case 'in-progress':
      loadInProgressPlantingTasks();
      break;
    case 'history':
      loadPlantingHistory();
      break;
  }
}

// ‚úÖ 3. ‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô "‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥" (‡∏£‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô)
async function loadPendingPlantingTasks() {
  try {
    
    // ‚úÖ ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å planting-plans ‡∏Å‡πà‡∏≠‡∏ô
    const response = await fetch('/api/planting-plans?status=received');
    console.log('üì° Response status:', response.status);
    
    const data = await response.json();
    console.log('üìä Data received:', data);
    
    if (data.success && data.planting_plans && data.planting_plans.length > 0) {
      console.log(`‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${data.planting_plans.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å cache
      cachedPendingPlans = data.planting_plans;
      lastCacheTime.pending = Date.now();
      
      renderPendingTasks(data.planting_plans);
    } else {
      // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å tray-inventory ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
      console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö planting plans ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö pending, ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô...');
      
      try {
        const allPlansResponse = await fetch('/api/planting-plans');
        const allPlansData = await allPlansResponse.json();
        
        console.log('üìÑ All Plans Data:', allPlansData);
        
        if (allPlansData.success && allPlansData.planting_plans) {
          // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ status ‡πÄ‡∏õ‡πá‡∏ô pending, received, ‡∏´‡∏£‡∏∑‡∏≠ null
          const pendingPlans = allPlansData.planting_plans.filter(plan => 
            !plan.status || plan.status === 'pending' || plan.status === 'received' || plan.status === 'created'
          );
          
          if (pendingPlans.length > 0) {
            console.log(`‚úÖ ‡∏û‡∏ö Pending Plans: ${pendingPlans.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å cache
            cachedPendingPlans = pendingPlans;
            lastCacheTime.pending = Date.now();
            
            renderPendingTasks(pendingPlans);
          } else {
            showEmptyPendingState();
          }
        } else {
          showEmptyPendingState();
        }
      } catch (fallbackErr) {
        console.error('‚ùå Fallback error:', fallbackErr);
        showEmptyPendingState();
      }
    }
    
    updatePlantingTabCounts();
    
  } catch (err) {
    console.error('‚ùå Error loading pending tasks:', err);
    document.getElementById('tabContent').innerHTML = `
      <div class="error-state">
        <i class="fas fa-exclamation-triangle fa-3x"></i>
        <h3>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
        <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ</p>
        <p style="font-size: 12px; color: #666;">${err.message}</p>
        <button onclick="loadPendingPlantingTasks()" class="btn-primary">
          <i class="fas fa-redo"></i> ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
        </button>
      </div>
    `;
  }
}

function showEmptyPendingState() {
  document.getElementById('tabContent').innerHTML = `
    <div class="empty-state">
      <i class="fas fa-clipboard-list fa-3x" style="color: #6c757d; margin-bottom: 20px;"></i>
      <h3 style="color: #495057; margin-bottom: 12px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
      <p style="color: #6c757d;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</p>
      <div style="margin-top: 20px;">
        <button onclick="loadPendingPlantingTasks()" class="btn-primary" style="margin-right: 10px;">
          <i class="fas fa-sync"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
        </button>
        <button onclick="debugPlantingPlans()" class="btn-secondary">
          <i class="fas fa-bug"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
      </div>
    </div>
  `;
}

// ‚úÖ 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô debug ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
async function debugPlantingPlans() {
  try {
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤ status ‡∏≠‡∏∞‡πÑ‡∏£
    const allResponse = await fetch('/api/planting-plans?limit=100');
    const allData = await allResponse.json();
    
    console.log('üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:', allData);
    
    if (allData.success && allData.planting_plans) {
      const byStatus = {};
      allData.planting_plans.forEach(plan => {
        const status = plan.status || 'null';
        byStatus[status] = (byStatus[status] || 0) + 1;
      });
      
      console.log('üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏° Status:', byStatus);
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå debug
      document.getElementById('tabContent').innerHTML = `
        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <h4>üêõ Debug Results</h4>
          <p><strong>Total Plans:</strong> ${allData.planting_plans.length}</p>
          <p><strong>Status Summary:</strong></p>
          <ul>
            ${Object.entries(byStatus).map(([status, count]) => 
              `<li><code>${status}</code>: ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>`
            ).join('')}
          </ul>
          <hr>
          <h5>‡πÅ‡∏ú‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</h5>
          <div style="max-height: 300px; overflow-y: auto;">
            ${allData.planting_plans.slice(0, 5).map(plan => `
              <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
                <strong>ID:</strong> ${plan.id} | 
                <strong>Plan ID:</strong> ${plan.plan_id} | 
                <strong>Status:</strong> <code>${plan.status}</code><br>
                <strong>‡∏ú‡∏±‡∏Å:</strong> ${plan.vegetable_type} | 
                <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> ${plan.plant_count} ‡∏ï‡πâ‡∏ô<br>
                <strong>‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å:</strong> ${plan.plant_date} | 
                <strong>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö:</strong> ${plan.harvest_date}
              </div>
            `).join('')}
          </div>
          <button onclick="fixPlantingStatus()" class="btn-warning">
            <i class="fas fa-wrench"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Status ‡πÄ‡∏õ‡πá‡∏ô 'received'
          </button>
          <button onclick="loadPendingPlantingTasks()" class="btn-primary">
            <i class="fas fa-redo"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
          </button>
        </div>
      `;
      
    } else {
      console.log('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢');
    }
    
  } catch (err) {
    console.error('‚ùå Debug error:', err);
  }
}

// ‚úÖ 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç status ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
async function fixPlantingStatus() {
  try {
    console.log('üîß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Status...');
    
    const response = await fetch('/api/planting-plans/fix-status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const result = await response.json();
    console.log('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', result);
    
    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Status ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà...', 'success');
    loadPendingPlantingTasks();
    
  } catch (err) {
    console.error('‚ùå Fix error:', err);
    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
  }
}
// ‚úÖ 5. ‡πÇ‡∏´‡∏•‡∏î "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" (‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô) - (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
async function loadPlantingHistory() {
  try {
    console.log('üîÑ Loading planting history...');
    
    // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á cache ‡∏Å‡πà‡∏≠‡∏ô
    cachedHistoryPlans = null;
    lastCacheTime.history = 0;
    
    // ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ API planting-plans ‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡∏ù‡∏±‡πà‡∏á frontend
    const timestamp = Date.now();
    const response = await fetch(`/api/planting-plans?limit=200&_t=${timestamp}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô text ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ parse
    const responseText = await response.text();
    
    let data;
    try {
      data = JSON.parse(responseText);
      console.log('‚úÖ Raw API data:', data);
    } catch (parseError) {
      console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ parse JSON:', parseError);
      console.error('‚ùå Response text:', responseText);
      throw new Error('‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }
    
    
    
    if (data.success && data.planting_plans && data.planting_plans.length > 0) {
      
      // ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß 
      const completedPlans = data.planting_plans.filter(plan => 
        plan.status === 'completed' || 
        plan.status === 'finished' || 
        plan.status === 'done' ||
        plan.completed_at ||
        plan.actual_harvest_date
      );
      
      console.log('‚úÖ All plans:', data.planting_plans.length);
      console.log('‚úÖ Completed plans:', completedPlans.length);
      
      // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£ mapping ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
      const historyData = completedPlans.map(item => {
        const createdBy = item.created_by || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        const completedBy = item.completed_by || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        
        return {
          id: item.id,
          plan_id: item.plan_id,
          vegetable_type: item.vegetable_type,
          plant_count: item.plant_count,
          status: item.status,
          completed_at: item.completed_at || item.updated_at,
          created_at: item.created_at,
          plant_date: item.plant_date,
          harvest_date: item.harvest_date,
          actual_harvest_date: item.actual_harvest_date,
          harvest_notes: item.harvest_notes,
          level_required: item.level_required,
          priority: item.priority || 'normal',
          notes: item.notes || '',
          source_type: 'planting_plan', // ‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô planting_plan
          action_type: 'completed', // ‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô completed
          command_used: item.command_used || '',
          batch_number: item.plan_id,
          completed_by: completedBy,
          created_by: createdBy
        };
      });
      
      console.log('‚úÖ Final history data:', historyData);
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å cache (clear cache ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô)
      cachedHistoryPlans = null; // Clear old cache first
      cachedHistoryPlans = historyData;
      lastCacheTime.history = Date.now();
      
      
      if (historyData.length > 0) {
        console.log('üéØ ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å renderPlantingHistory ‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', historyData.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        renderPlantingHistory(historyData);
      } else {
        console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
        showEmptyHistoryState();
      }
      
    } else {
      console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ API ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      console.log('‚ö†Ô∏è data.success:', data.success);
      console.log('‚ö†Ô∏è data.planting_plans:', data.planting_plans);
      showEmptyHistoryState();
    }
    
    updatePlantingTabCounts();
  } catch (err) {
    console.error('‚ùå Error loading history:', err);
    console.error('‚ùå Error stack:', err.stack);
    showErrorContent('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ' + err.message);
    
    // ‡πÅ‡∏™‡∏î‡∏á fallback UI
    const tabContent = document.getElementById('tabContent');
    if (tabContent) {
      tabContent.innerHTML = `
        <div class="error-state" style="text-align: center; padding: 40px;">
          <i class="fas fa-exclamation-triangle fa-3x" style="color: #dc3545; margin-bottom: 20px;"></i>
          <h3 style="color: #dc3545;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
          <p style="color: #6c757d; margin-bottom: 20px;">${err.message}</p>
          <button onclick="loadPlantingHistory()" class="btn-primary">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
        </div>
      `;
    }
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ planting plan (‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°)
async function viewHistoryDetail(planId) {
  try {
    
    // ‡πÅ‡∏™‡∏î‡∏á loading
    showDetailModal({
      title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...',
      content: `
        <div style="text-align: center; padding: 40px;">
          <i class="fas fa-spinner fa-spin fa-2x" style="color: #6b7280; margin-bottom: 20px;"></i>
          <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...</p>
        </div>
      `
    });
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
    const response = await fetch(`/api/planting-plans/${planId}/details`);
    const responseText = await response.text();
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    let data;
    try {
      data = JSON.parse(responseText);
    } catch (parseError) {
      console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ parse JSON:', parseError);
      console.error('‚ùå Response text:', responseText);
      throw new Error('‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }
    
    
    if (data.success && (data.plan_details || data.plan)) {
      const plan = data.plan_details || data.plan;
      
      // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
      const planWithFullData = {
        ...plan,
        task_history: data.task_history || [],
        work_orders: data.work_orders || [],
        trays: data.trays || data.tray_inventory || [],
        stats: data.stats || {}
      };
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
      const detailContent = createPlanDetailContent(planWithFullData);
      
      showDetailModal({
        title: `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å: ${plan.vegetable_type}`,
        content: detailContent
      });
      
    } else {
      showDetailModal({
        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        content: `
          <div style="text-align: center; padding: 40px; color: #dc2626;">
            <i class="fas fa-exclamation-triangle fa-2x" style="margin-bottom: 20px;"></i>
            <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ: ${data.error || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}</p>
          </div>
        `
      });
    }
    
  } catch (err) {
    console.error('‚ùå Error loading plan details:', err);
    showDetailModal({
      title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      content: `
        <div style="text-align: center; padding: 40px; color: #dc2626;">
          <i class="fas fa-exclamation-triangle fa-2x" style="margin-bottom: 20px;"></i>
          <p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${err.message}</p>
        </div>
      `
    });
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
function createPlanDetailContent(plan) {
  const workOrders = plan.work_orders || [];
  const trayInventory = plan.tray_inventory || plan.trays || [];
  const taskHistory = plan.task_history || [];
  
  // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö format ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
  const stats = plan.stats || {};
  const actualYield = stats.total_plants || trayInventory.reduce((sum, tray) => sum + (tray.plant_quantity || 0), 0) || plan.plant_count;
  const yieldPercentage = plan.plant_count > 0 ? Math.round((actualYield / plan.plant_count) * 100) : 100;
  const completedTasks = stats.completed_work_orders || workOrders.filter(wo => wo.status === 'completed').length;
  const totalTasks = stats.work_orders_count || workOrders.length || (stats.estimated_activity ? Math.max(1, Math.floor(stats.estimated_activity / 3)) : 1);
  
  // ‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
  let harvestUsers = [
    // ‡∏à‡∏≤‡∏Å outbound work orders
    ...workOrders.filter(wo => wo.task_type === 'outbound' || wo.task_type === 'harvest').map(wo => wo.created_by).filter(Boolean),
    // ‡∏à‡∏≤‡∏Å outbound task history
    ...taskHistory.filter(task => task.action_type === 'outbound').map(th => th.username).filter(Boolean),
    // ‡∏à‡∏≤‡∏Å completed_by ‡πÉ‡∏ô planting plan
    plan.completed_by
  ].filter(Boolean);
  
  // fallback: ‡πÉ‡∏ä‡πâ created_by ‡∏à‡∏≤‡∏Å work orders ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ harvest users)
  if (harvestUsers.length === 0 && workOrders.length > 0) {
    harvestUsers = workOrders.map(wo => wo.created_by).filter(Boolean);
  }
  
  // fallback ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ‡πÉ‡∏ä‡πâ plan.created_by
  if (harvestUsers.length === 0) {
    harvestUsers = [plan.created_by || plan.completed_by].filter(Boolean);
  }
  
  const uniqueHarvestUsers = [...new Set(harvestUsers)];
  
  // ‡∏´‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å
  const outboundLocations = [
    // ‡∏à‡∏≤‡∏Å outbound task history (‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
    ...taskHistory.filter(task => task.action_type === 'outbound' && task.floor && task.slot)
      .map(task => `‡∏ä‡∏±‡πâ‡∏ô ${task.floor}, ‡∏ä‡πà‡∏≠‡∏á ${task.slot}`),
    // ‡∏à‡∏≤‡∏Å outbound work orders
    ...workOrders.filter(wo => (wo.task_type === 'outbound' || wo.task_type === 'harvest') && (wo.current_floor || wo.level))
      .map(wo => `‡∏ä‡∏±‡πâ‡∏ô ${wo.current_floor || wo.level}${wo.current_slot ? `, ‡∏ä‡πà‡∏≠‡∏á ${wo.current_slot}` : ''}`),
    // fallback: ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å tray inventory
    ...trayInventory.filter(tray => tray.floor && tray.slot)
      .map(tray => `‡∏ä‡∏±‡πâ‡∏ô ${tray.floor}, ‡∏ä‡πà‡∏≠‡∏á ${tray.slot}`)
  ];
  
  const uniqueOutboundLocations = [...new Set(outboundLocations)];
  
  return `
    <div class="plan-detail-content">
      
      <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
      <div class="detail-stats" style="
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
        gap: 15px; 
        margin-bottom: 25px;
      ">
        <div class="stat-box" style="
          background: linear-gradient(135deg, #28a745, #20c997);
          color: white; padding: 15px; border-radius: 12px; text-align: center;
        ">
          <i class="fas fa-tasks" style="font-size: 1.5em; margin-bottom: 8px; display: block;"></i>
          <div style="font-size: 1.5em; font-weight: bold;">${plan.status === 'completed' ? totalTasks || 1 : completedTasks}/${totalTasks || 1}</div>
          <div style="font-size: 0.9em; opacity: 0.9;">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div>
        </div>
        <div class="stat-box" style="
          background: linear-gradient(135deg, #007bff, #17a2b8);
          color: white; padding: 15px; border-radius: 12px; text-align: center;
        ">
          <i class="fas fa-chart-line" style="font-size: 1.5em; margin-bottom: 8px; display: block;"></i>
          <div style="font-size: 1.5em; font-weight: bold;">${plan.status === 'completed' ? '100' : yieldPercentage}%</div>
          <div style="font-size: 0.9em; opacity: 0.9;">‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</div>
        </div>
        <div class="stat-box" style="
          background: linear-gradient(135deg, #6f42c1, #563d7c);
          color: white; padding: 15px; border-radius: 12px; text-align: center;
        ">
          <i class="fas fa-seedling" style="font-size: 1.5em; margin-bottom: 8px; display: block;"></i>
          <div style="font-size: 1.5em; font-weight: bold;">${actualYield || plan.plant_count}</div>
          <div style="font-size: 0.9em; opacity: 0.9;">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</div>
        </div>
        <div class="stat-box" style="
          background: linear-gradient(135deg, #fd7e14, #ffc107);
          color: white; padding: 15px; border-radius: 12px; text-align: center;
        ">
          <i class="fas fa-user-check" style="font-size: 1.5em; margin-bottom: 8px; display: block;"></i>
          <div style="font-size: 1.5em; font-weight: bold;">${uniqueHarvestUsers.length || (plan.completed_by ? 1 : 0)}</div>
          <div style="font-size: 0.9em; opacity: 0.9;">‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</div>
        </div>
      </div>
      
      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
      <div class="detail-section" style="margin-bottom: 25px;">
        <h4 style="color: #1e293b; margin-bottom: 15px; display: flex; align-items: center;">
          <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 8px;"></i>
          ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        </h4>
        <div class="info-grid" style="
          display: grid; 
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
          gap: 15px;
        ">
          <div class="info-item" style="background: #f8fafc; padding: 12px; border-radius: 8px;">
            <strong>‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ú‡∏ô:</strong> ${plan.plan_id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
          </div>
          <div class="info-item" style="background: #f8fafc; padding: 12px; border-radius: 8px;">
            <strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏±‡∏Å:</strong> ${plan.vegetable_type}
          </div>
          <div class="info-item" style="background: #f8fafc; padding: 12px; border-radius: 8px;">
            <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:</strong> ${plan.plant_count} ‡∏ï‡πâ‡∏ô
          </div>
          <div class="info-item" style="background: #f8fafc; padding: 12px; border-radius: 8px;">
            <strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö:</strong> ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà ${plan.level_required}
          </div>
          <div class="info-item" style="background: #f8fafc; padding: 12px; border-radius: 8px;">
            <strong>‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å:</strong> ${formatDateThai(plan.plant_date)}
          </div>
          <div class="info-item" style="background: #f8fafc; padding: 12px; border-radius: 8px;">
            <strong>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß:</strong> ${formatDateThai(plan.harvest_date)}
          </div>
          <div class="info-item" style="background: #f8fafc; padding: 12px; border-radius: 8px;">
            <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="badge-${plan.status}">${plan.status}</span>
          </div>
          <div class="info-item" style="background: #f8fafc; padding: 12px; border-radius: 8px;">
            <strong>‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï:</strong> ${uniqueHarvestUsers.join(', ') || plan.completed_by || plan.created_by || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
          </div>
          <div class="info-item" style="background: #f8fafc; padding: 12px; border-radius: 8px;">
            <strong>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å:</strong> ${uniqueOutboundLocations.join('; ') || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
          </div>
        </div>
        ${plan.notes ? `
          <div style="margin-top: 15px; background: #fffbeb; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <strong><i class="fas fa-sticky-note" style="color: #f59e0b;"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong><br>
            ${plan.notes}
          </div>
        ` : ''}
      </div>
      
      <!-- Work Orders -->
      <div class="detail-section" style="margin-bottom: 25px;">
        <h4 style="color: #1e293b; margin-bottom: 15px; display: flex; align-items: center;">
          <i class="fas fa-clipboard-list" style="color: #10b981; margin-right: 8px;"></i>
          ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (${workOrders.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
        </h4>
        ${workOrders.length > 0 ? `
          <div class="work-orders-list" style="max-height: 250px; overflow-y: auto; margin-right: -10px; padding-right: 10px;">
            ${workOrders.map(wo => `
              <div class="work-order-item" style="
                background: white; 
                border: 1px solid #e5e7eb; 
                border-radius: 8px; 
                padding: 15px; 
                margin-bottom: 10px;
                border-left: 4px solid ${wo.status === 'completed' ? '#10b981' : wo.status === 'pending' ? '#f59e0b' : '#6b7280'};
              ">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                  <div>
                    <strong>${wo.work_order_number}</strong>
                    <span class="task-badge-${wo.task_type}" style="
                      background: ${wo.task_type === 'inbound' ? '#dbeafe' : '#dcfce7'}; 
                      color: ${wo.task_type === 'inbound' ? '#1e40af' : '#166534'}; 
                      padding: 2px 8px; 
                      border-radius: 12px; 
                      font-size: 0.8em; 
                      margin-left: 8px;
                    ">
                      ${wo.task_type === 'inbound' ? '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : wo.task_type === 'outbound' ? '‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å' : wo.task_type}
                    </span>
                  </div>
                  <span class="status-badge-${wo.status}" style="
                    background: ${wo.status === 'completed' ? '#dcfce7' : wo.status === 'pending' ? '#fef3c7' : '#f3f4f6'}; 
                    color: ${wo.status === 'completed' ? '#166534' : wo.status === 'pending' ? '#92400e' : '#6b7280'}; 
                    padding: 4px 8px; 
                    border-radius: 12px; 
                    font-size: 0.8em; 
                    font-weight: 600;
                  ">
                    ${wo.status === 'completed' ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : wo.status === 'pending' ? '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : wo.status}
                  </span>
                </div>
                <div class="work-order-details" style="font-size: 0.9em; color: #6b7280;">
                  <div><i class="fas fa-user"></i> ‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á: ${wo.created_by || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                  <div><i class="fas fa-calendar"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDateThai(wo.created_at)}</div>
                  ${wo.tray_id ? `<div><i class="fas fa-box"></i> Tray: ${wo.tray_id} (‡∏ä‡∏±‡πâ‡∏ô ${wo.current_floor}, ‡∏ä‡πà‡∏≠‡∏á ${wo.current_slot})</div>` : ''}
                  ${wo.completed_at ? `<div><i class="fas fa-check"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: ${formatDateThai(wo.completed_at)}</div>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        ` : '<p style="color: #6b7280; font-style: italic;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</p>'}
      </div>
      
      <!-- Tray Inventory -->
      <div class="detail-section" style="margin-bottom: 25px;">
        <h4 style="color: #1e293b; margin-bottom: 15px; display: flex; align-items: center;">
          <i class="fas fa-warehouse" style="color: #8b5cf6; margin-right: 8px;"></i>
          ‡∏ñ‡∏≤‡∏î‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á (${trayInventory.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
        </h4>
        ${trayInventory.length > 0 ? `
          <div class="tray-list" style="max-height: 200px; overflow-y: auto; margin-right: -10px; padding-right: 10px;">
            ${trayInventory.map(tray => `
              <div class="tray-item" style="
                background: white; 
                border: 1px solid #e5e7eb; 
                border-radius: 8px; 
                padding: 12px; 
                margin-bottom: 8px;
                display: flex; 
                justify-content: space-between; 
                align-items: center;
              ">
                <div>
                  <strong>${tray.tray_id}</strong>
                  <div style="font-size: 0.9em; color: #6b7280;">
                    ‡∏ä‡∏±‡πâ‡∏ô ${tray.floor}, ‡∏ä‡πà‡∏≠‡∏á ${tray.slot} | ${tray.plant_quantity || 0} ‡∏ï‡πâ‡∏ô
                  </div>
                  <div style="font-size: 0.8em; color: #6b7280;">
                    ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: ${tray.username || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                  </div>
                </div>
                <span class="status-${tray.status}" style="
                  background: ${tray.status === 'on_shelf' ? '#dcfce7' : '#f3f4f6'}; 
                  color: ${tray.status === 'on_shelf' ? '#166534' : '#6b7280'}; 
                  padding: 4px 8px; 
                  border-radius: 12px; 
                  font-size: 0.8em; 
                  font-weight: 600;
                ">
                  ${tray.status === 'on_shelf' ? '‡∏ö‡∏ô‡∏ä‡∏±‡πâ‡∏ô' : tray.status}
                </span>
              </div>
            `).join('')}
          </div>
        ` : '<p style="color: #6b7280; font-style: italic;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î</p>'}
      </div>
      
      <!-- Task History (‡∏¢‡πà‡∏≠) -->
      ${taskHistory.length > 0 ? `
        <div class="detail-section">
          <h4 style="color: #1e293b; margin-bottom: 15px; display: flex; align-items: center;">
            <i class="fas fa-history" style="color: #f59e0b; margin-right: 8px;"></i>
            ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (${taskHistory.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
          </h4>
          <div class="task-history-list" style="max-height: 150px; overflow-y: auto; margin-right: -10px; padding-right: 10px;">
            ${taskHistory.slice(0, 5).map(task => `
              <div class="task-item" style="
                background: #f9fafb; 
                padding: 8px 12px; 
                border-radius: 6px; 
                margin-bottom: 6px; 
                font-size: 0.9em;
              ">
                <div style="display: flex; justify-content: space-between;">
                  <span>
                    <i class="fas fa-${task.action_type === 'inbound' ? 'arrow-down' : 'arrow-up'}" 
                       style="color: ${task.action_type === 'inbound' ? '#10b981' : '#f59e0b'};"></i>
                    ${task.action_type === 'inbound' ? '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å'} ${task.tray_id}
                  </span>
                  <span style="color: #6b7280;">${formatDateThai(task.created_at)}</span>
                </div>
                <div style="color: #6b7280; font-size: 0.8em;">
                  ‡∏ä‡∏±‡πâ‡∏ô ${task.floor}, ‡∏ä‡πà‡∏≠‡∏á ${task.slot} | ${task.username || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                </div>
              </div>
            `).join('')}
            ${taskHistory.length > 5 ? `<p style="text-align: center; color: #6b7280; font-style: italic; margin-top: 10px;">‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${taskHistory.length - 5} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>` : ''}
          </div>
        </div>
      ` : ''}
      
    </div>
  `;
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î outbound action
function createOutboundActionDetailContent(actionData) {
  const actionDate = actionData.actual_harvest_date || actionData.created_at;
  const plantDate = actionData.plant_date;
  
  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏ñ‡∏≤‡∏î
  let trayAge = '';
  if (plantDate && actionDate) {
    const days = Math.floor((new Date(actionDate) - new Date(plantDate)) / (1000 * 60 * 60 * 24));
    trayAge = `${days} ‡∏ß‡∏±‡∏ô`;
  }
  
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
  const getActionStyle = (actionType) => {
    switch(actionType) {
      case '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î':
        return { color: '#28a745', icon: 'fa-leaf', bg: '#d4edda' };
      case '‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á / ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô':
        return { color: '#17a2b8', icon: 'fa-cut', bg: '#d1ecf1' };
      case '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á':
        return { color: '#dc3545', icon: 'fa-trash-alt', bg: '#f8d7da' };
      default:
        return { color: '#6c757d', icon: 'fa-cog', bg: '#e2e3e5' };
    }
  };
  
  const style = getActionStyle(actionData.action_type);
  
  return `
    <div class="outbound-action-detail-content" style="padding: 20px;">
      
      <!-- Header -->
      <div style="
        background: linear-gradient(135deg, ${style.bg}, #ffffff);
        border: 2px solid ${style.color};
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
      ">
        <i class="fas ${style.icon}" style="
          font-size: 3em; 
          color: ${style.color}; 
          margin-bottom: 15px;
        "></i>
        <h3 style="color: ${style.color}; margin: 0;">${actionData.action_type}</h3>
        <p style="margin: 5px 0 0 0; color: #6c757d;">${actionData.vegetable_type}</p>
      </div>
      
      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å -->
      <div style="
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      ">
        <div style="
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          border-left: 4px solid #007bff;
        ">
          <strong style="color: #495057;">üìã ‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô</strong><br>
          <span style="color: #007bff; font-weight: 600;">${actionData.plan_id}</span>
        </div>
        
        <div style="
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          border-left: 4px solid #28a745;
        ">
          <strong style="color: #495057;">üå± ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô</strong><br>
          <span style="color: #28a745; font-weight: 600;">${actionData.plant_count} ‡∏ï‡πâ‡∏ô</span>
        </div>
        
        ${plantDate ? `
        <div style="
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          border-left: 4px solid #17a2b8;
        ">
          <strong style="color: #495057;">üìÖ ‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å</strong><br>
          <span style="color: #17a2b8; font-weight: 600;">${formatDateThai(plantDate)}</span>
        </div>
        ` : ''}
        
        <div style="
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          border-left: 4px solid ${style.color};
        ">
          <strong style="color: #495057;">‚è∞ ‡∏ß‡∏±‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</strong><br>
          <span style="color: ${style.color}; font-weight: 600;">${formatDateThai(actionDate)}</span>
        </div>
        
        ${trayAge ? `
        <div style="
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          border-left: 4px solid #ffc107;
        ">
          <strong style="color: #495057;">üìè ‡∏≠‡∏≤‡∏¢‡∏∏‡∏ñ‡∏≤‡∏î</strong><br>
          <span style="color: #ffc107; font-weight: 600;">${trayAge}</span>
        </div>
        ` : ''}
        
        <div style="
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          border-left: 4px solid #6f42c1;
        ">
          <strong style="color: #495057;">üë§ ‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</strong><br>
          <span style="color: #6f42c1; font-weight: 600;">${actionData.created_by}</span>
        </div>
      </div>
      
      <!-- ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ -->
      ${actionData.command_used ? `
      <div style="
        background: linear-gradient(135deg, #fff3cd, #ffffff);
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      ">
        <strong style="color: #856404;">üíº ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</strong><br>
        <code style="
          background: #f1f3f4;
          padding: 5px 10px;
          border-radius: 4px;
          color: #495057;
          font-family: monospace;
        ">${actionData.command_used}</code>
      </div>
      ` : ''}
      
      <!-- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ -->
      ${actionData.harvest_notes ? `
      <div style="
        background: #e7f3ff;
        border: 1px solid #b8daff;
        border-radius: 8px;
        padding: 15px;
      ">
        <strong style="color: #004085;">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong><br>
        <p style="margin: 10px 0 0 0; color: #004085;">${actionData.harvest_notes}</p>
      </div>
      ` : ''}
      
    </div>
  `;
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
function showDetailModal({ title, content }) {
  // ‡∏•‡∏ö modal ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  const existingModal = document.getElementById('planDetailModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  const modal = document.createElement('div');
  modal.id = 'planDetailModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    animation: fadeIn 0.3s ease;
  `;
  
  modal.innerHTML = `
    <div class="modal-content" style="
      background: white;
      border-radius: 16px;
      max-width: 900px;
      max-height: 90vh;
      width: 100%;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
      animation: slideUp 0.3s ease;
      display: flex;
      flex-direction: column;
    ">
      <div class="modal-header" style="
        padding: 20px 25px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      ">
        <h3 style="margin: 0; color: #1e293b; font-size: 1.25rem;">${title}</h3>
        <button onclick="closePlanDetailModal()" style="
          background: none;
          border: none;
          font-size: 1.5rem;
          color: #6b7280;
          cursor: pointer;
          padding: 5px;
          border-radius: 6px;
          transition: all 0.2s;
        " onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" style="
        padding: 25px;
        overflow-y: auto;
        flex: 1;
      ">
        ${content}
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closePlanDetailModal();
    }
  });
  
  // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î ESC
  const handleKeyDown = (e) => {
    if (e.key === 'Escape') {
      closePlanDetailModal();
      document.removeEventListener('keydown', handleKeyDown);
    }
  };
  document.addEventListener('keydown', handleKeyDown);
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î modal
function closePlanDetailModal() {
  const modal = document.getElementById('planDetailModal');
  if (modal) {
    modal.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => modal.remove(), 300);
  }
}

function showEmptyHistoryState() {
  document.getElementById('tabContent').innerHTML = `
    <div class="empty-state">
      <i class="fas fa-clock-rotate-left fa-3x" style="color: #6c757d; margin-bottom: 20px;"></i>
      <h3 style="color: #495057; margin-bottom: 12px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h3>
      <p style="color: #6c757d;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p>
      <div style="margin-top: 20px;">
        <button onclick="loadPlantingHistory()" class="btn-primary" style="margin-right: 10px;">
          <i class="fas fa-sync"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
        </button>
      </div>
    </div>
  `;
}
// ‚úÖ 6. ‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô "‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥"
// Pagination variables for Planting Plan
let pendingCurrentPage = 1;
let inProgressCurrentPage = 1;  
let historyCurrentPage = 1;
const itemsPerPage = 8;

// Cache variables for better performance
let cachedPendingPlans = null;
let cachedInProgressTrays = null;
let cachedHistoryPlans = null;
let lastCacheTime = {
  pending: 0,
  inProgress: 0,
  history: 0
};
const CACHE_DURATION = 30000; // 30 seconds

function renderPendingTasks(plans) {
  console.log('üé® ‡∏Å‡∏≥‡∏•‡∏±‡∏á render tasks:', plans);
  
  if (!plans || plans.length === 0) {
    document.getElementById('tabContent').innerHTML = `
      <div class="empty-state">
        <i class="fas fa-clipboard-check fa-3x"></i>
        <h3>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</p>
      </div>
    `;
    return;
  }

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏•‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß > ‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á > ‡∏õ‡∏Å‡∏ï‡∏¥ > ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á
  const sortedPlans = [...plans].sort((a, b) => {
    const getPriority = (plan) => {
      if (!plan.plant_date) return 999; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î
      
      const today = new Date();
      const plant = new Date(plan.plant_date);
      const diffDays = Math.ceil((plant - today) / (1000 * 60 * 60 * 24));
      
      if (diffDays < 0) return 1;    // ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡πâ‡∏ß - ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
      if (diffDays <= 2) return 2;  // ‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô (0-2 ‡∏ß‡∏±‡∏ô) 
      if (diffDays <= 7) return 3;  // ‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á (3-7 ‡∏ß‡∏±‡∏ô)
      if (diffDays <= 14) return 4; // ‡∏õ‡∏Å‡∏ï‡∏¥ (8-14 ‡∏ß‡∏±‡∏ô)
      return 5;                     // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á (>14 ‡∏ß‡∏±‡∏ô)
    };
    
    const priorityA = getPriority(a);
    const priorityB = getPriority(b);
    
    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å (‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà)
    if (priorityA === priorityB) {
      const dateA = new Date(a.plant_date || 0);
      const dateB = new Date(b.plant_date || 0);
      return dateA - dateB;
    }
    
    return priorityA - priorityB;
  });

  // Pagination logic
  const totalPages = Math.ceil(sortedPlans.length / itemsPerPage);
  if (pendingCurrentPage > totalPages && totalPages > 0) {
    pendingCurrentPage = totalPages;
  }
  
  const start = (pendingCurrentPage - 1) * itemsPerPage;
  const paginatedPlans = sortedPlans.slice(start, start + itemsPerPage);

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å
  function getTaskUrgencyColor(plantDate) {
    if (!plantDate) return { color: '#6c757d', label: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' };
    
    const today = new Date();
    const plant = new Date(plantDate);
    const diffDays = Math.ceil((plant - today) / (1000 * 60 * 60 * 24));
    
    if (diffDays < 0) return { color: '#dc3545', label: '‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î' }; // ‡πÅ‡∏î‡∏á - ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡πâ‡∏ß
    if (diffDays <= 2) return { color: '#fd7e14', label: '‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô' }; // ‡∏™‡πâ‡∏° - 0-2 ‡∏ß‡∏±‡∏ô
    if (diffDays <= 7) return { color: '#ffc107', label: '‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á' }; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á - 3-7 ‡∏ß‡∏±‡∏ô
    if (diffDays <= 14) return { color: '#20c997', label: '‡∏õ‡∏Å‡∏ï‡∏¥' }; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô - 8-14 ‡∏ß‡∏±‡∏ô
    return { color: '#007bff', label: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô' }; // ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô - ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 14 ‡∏ß‡∏±‡∏ô
  }

  const html = `
    <div class="tasks-grid" style="
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); 
      gap: 20px; 
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
    ">
      ${paginatedPlans.map(plan => `
        <div class="task-card" style="
          background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%); 
          border-radius: 16px; 
          padding: 24px; 
          box-shadow: 0 8px 32px rgba(0,0,0,0.08);
          border-left: 6px solid ${getTaskUrgencyColor(plan.plant_date).color};
          border-top: 3px solid ${getTaskUrgencyColor(plan.plant_date).color};
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          word-wrap: break-word;
          overflow-wrap: break-word;
          hyphens: auto;
          line-height: 1.5;
        " onmouseover="this.style.boxShadow='0 12px 40px rgba(0,0,0,0.12)'; this.style.transform='translateY(-4px) scale(1.02)'" onmouseout="this.style.boxShadow='0 8px 32px rgba(0,0,0,0.08)'; this.style.transform='translateY(0) scale(1)'">
          <div class="task-header" style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 15px;">
              <div class="task-title" style="display: flex; align-items: flex-start; gap: 12px; flex: 1; min-width: 0; max-width: 70%;">
                <i class="fas fa-seedling" style="color: #28a745; font-size: 1.3em; margin-top: 2px; flex-shrink: 0;"></i>
                <span style="
                  font-weight: 700; 
                  font-size: 1.25em; 
                  color: #2d5aa0;
                  word-break: keep-all;
                  overflow-wrap: break-word;
                  white-space: nowrap;
                  overflow: hidden;
                  text-overflow: ellipsis;
                  line-height: 1.4;
                  flex: 1;
                " title="${plan.vegetable_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}">${plan.vegetable_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
              </div>
              <div class="urgency-badge" style="
                background: linear-gradient(135deg, ${getTaskUrgencyColor(plan.plant_date).color}, ${getTaskUrgencyColor(plan.plant_date).color}dd);
                color: white; 
                padding: 6px 12px; 
                border-radius: 18px; 
                font-size: 11px; 
                font-weight: 700;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                white-space: nowrap;
                flex-shrink: 0;
                min-width: fit-content;
                max-width: 30%;
              ">
                ${getTaskUrgencyColor(plan.plant_date).label}
              </div>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <div class="task-id" style="
                font-size: 11px; 
                color: #5a6c7d; 
                background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
                padding: 6px 10px; 
                border-radius: 8px;
                font-weight: 600;
                border: 1px solid #e0e6ed;
              ">
                üìã Plan ID: ${plan.plan_id || plan.id}
              </div>
              <div style="
                font-size: 11px; 
                color: #5a6c7d; 
                background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
                padding: 6px 10px; 
                border-radius: 8px;
                font-weight: 600;
                border: 1px solid #90caf9;
              ">
                ‚è∞ ‡∏™‡∏£‡πâ‡∏≤‡∏á: ${formatDateTimeThai(plan.created_at)}
              </div>
            </div>
          </div>
          
          <div class="task-details" style="margin-bottom: 20px;">
            <div class="detail-grid" style="
              display: grid; 
              grid-template-columns: 1fr 1fr; 
              gap: 16px; 
              margin-bottom: 16px;
            ">
              <div class="detail-item" style="
                background: linear-gradient(135deg, #f8f9ff, #fff);
                padding: 12px;
                border-radius: 12px;
                border: 1px solid #e3f2fd;
                box-shadow: 0 2px 8px rgba(0,123,255,0.08);
              ">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                  <i class="fas fa-calendar-plus" style="color: #007bff; font-size: 14px;"></i>
                  <span style="font-weight: 600; font-size: 12px; color: #495057;">‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å</span>
                </div>
                <div style="
                  font-weight: 700; 
                  font-size: 14px; 
                  color: #007bff;
                  word-break: break-word;
                  line-height: 1.4;
                ">${formatDateThai(plan.plant_date)}</div>
              </div>
              <div class="detail-item" style="
                background: linear-gradient(135deg, #f8fff9, #fff);
                padding: 12px;
                border-radius: 12px;
                border: 1px solid #c8e6c9;
                box-shadow: 0 2px 8px rgba(40,167,69,0.08);
              ">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                  <i class="fas fa-calendar-check" style="color: #28a745; font-size: 14px;"></i>
                  <span style="font-weight: 600; font-size: 12px; color: #495057;">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö</span>
                </div>
                <div style="
                  font-weight: 700; 
                  font-size: 14px; 
                  color: #28a745;
                  word-break: break-word;
                  line-height: 1.4;
                ">${formatDateThai(plan.harvest_date)}</div>
              </div>
            </div>
            <div class="detail-grid" style="
              display: flex; 
              justify-content: center;
              margin-bottom: 16px;
            ">
              <div class="detail-item" style="
                background: linear-gradient(135deg, #fffdf8, #fff);
                padding: 12px;
                border-radius: 12px;
                border: 1px solid #fff3cd;
                box-shadow: 0 2px 8px rgba(255,193,7,0.08);
                min-width: 200px;
                text-align: center;
              ">
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 6px;">
                  <i class="fas fa-sort-numeric-up" style="color: #ffc107; font-size: 14px;"></i>
                  <span style="font-weight: 600; font-size: 12px; color: #495057;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô</span>
                </div>
                <div style="
                  font-weight: 700; 
                  font-size: 14px; 
                  color: #e67e22;
                ">${plan.plant_count || 0} ‡∏ï‡πâ‡∏ô</div>
              </div>
            </div>
            <div class="additional-info" style="
              background: linear-gradient(135deg, #f8f9fa, #ffffff);
              padding: 16px; 
              border-radius: 12px; 
              border: 1px solid #e9ecef;
              box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            ">
              <div style="
                display: grid; 
                grid-template-columns: 1fr 1fr; 
                gap: 12px; 
                font-size: 12px;
                line-height: 1.6;
              ">
                <div style="word-break: break-word;"><strong><i class="fas fa-box" style="color: #6f42c1;"></i> Batch:</strong> ${plan.batch_number || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div style="word-break: break-word;"><strong><i class="fas fa-seed" style="color: #28a745;"></i> ‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå:</strong> ${plan.seed_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div><strong><i class="fas fa-info-circle" style="color: #17a2b8;"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span style="
                  background: linear-gradient(135deg, #007bff, #0056b3); 
                  color: white; 
                  padding: 3px 8px; 
                  border-radius: 6px;
                  font-weight: 600;
                ">${(() => {
                  const status = plan.status || 'pending';
                  const statusMap = {
                    'received': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
                    'pending': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', 
                    'created': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
                    'in_progress': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
                    'processing': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
                    'completed': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                    'finished': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                    'done': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                    'cancelled': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    'rejected': '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'
                  };
                  return statusMap[status] || status;
                })()}</span></div>
                <div style="word-break: break-word;"><strong><i class="fas fa-user-tie" style="color: #007bff;"></i> ‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á:</strong> ${plan.created_by || '‡∏£‡∏∞‡∏ö‡∏ö'}</div>
              </div>
              ${plan.notes ? `<div style="
                margin-top: 12px; 
                padding-top: 12px; 
                border-top: 1px solid #dee2e6;
                word-break: break-word;
                overflow-wrap: break-word;
                hyphens: auto;
              "><strong><i class="fas fa-sticky-note" style="color: #fd7e14;"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${plan.notes}</div>` : ''}
            </div>
          </div>
          
          <div class="task-actions">
            <button onclick="createInboundWorkOrder(${plan.id})" style="
              background: linear-gradient(135deg, #007bff, #0056b3);
              color: white;
              border: none;
              padding: 12px 20px;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              transition: all 0.2s;
              width: 100%;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
              <i class="fas fa-play"></i>
              ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Inbound
            </button>
          </div>
        </div>
      `).join('')}
    </div>
    
    <!-- Pagination -->
    ${totalPages > 1 ? `
      <div style="
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 30px;
        padding: 20px;
      ">
        <button onclick="goToPendingPage(${pendingCurrentPage - 1})" 
          ${pendingCurrentPage <= 1 ? 'disabled' : ''} style="
          padding: 8px 12px;
          border: 2px solid #007bff;
          background: ${pendingCurrentPage <= 1 ? '#f8f9fa' : 'white'};
          color: ${pendingCurrentPage <= 1 ? '#6c757d' : '#007bff'};
          border-radius: 8px;
          cursor: ${pendingCurrentPage <= 1 ? 'not-allowed' : 'pointer'};
          font-weight: 600;
          transition: all 0.2s;
        ">
          <i class="fas fa-arrow-left"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        </button>
        
        <div style="display: flex; gap: 5px;">
          ${Array.from({length: totalPages}, (_, i) => i + 1).map(page => `
            <button onclick="goToPendingPage(${page})" style="
              padding: 8px 12px;
              border: 2px solid ${page === pendingCurrentPage ? '#007bff' : '#dee2e6'};
              background: ${page === pendingCurrentPage ? '#007bff' : 'white'};
              color: ${page === pendingCurrentPage ? 'white' : '#007bff'};
              border-radius: 8px;
              cursor: pointer;
              font-weight: ${page === pendingCurrentPage ? '700' : '600'};
              min-width: 40px;
              transition: all 0.2s;
            " onmouseover="if(${page !== pendingCurrentPage}) { this.style.background='#f8f9fa'; }" 
               onmouseout="if(${page !== pendingCurrentPage}) { this.style.background='white'; }">
              ${page}
            </button>
          `).join('')}
        </div>
        
        <button onclick="goToPendingPage(${pendingCurrentPage + 1})" 
          ${pendingCurrentPage >= totalPages ? 'disabled' : ''} style="
          padding: 8px 12px;
          border: 2px solid #007bff;
          background: ${pendingCurrentPage >= totalPages ? '#f8f9fa' : 'white'};
          color: ${pendingCurrentPage >= totalPages ? '#6c757d' : '#007bff'};
          border-radius: 8px;
          cursor: ${pendingCurrentPage >= totalPages ? 'not-allowed' : 'pointer'};
          font-weight: 600;
          transition: all 0.2s;
        ">
          ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fas fa-arrow-right"></i>
        </button>
        
        <div style="margin-left: 20px; color: #6c757d; font-size: 14px;">
          ‡πÅ‡∏™‡∏î‡∏á ${start + 1}-${Math.min(start + itemsPerPage, sortedPlans.length)} ‡∏à‡∏≤‡∏Å ${sortedPlans.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </div>
      </div>
    ` : ''}
  `;
  
  document.getElementById('tabContent').innerHTML = html;
  console.log('‚úÖ Render ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
}

// Pagination functions (optimized with cache)
function goToPendingPage(page) {
  if (page < 1) return;
  pendingCurrentPage = page;
  
  // ‡πÉ‡∏ä‡πâ cache ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
  const now = Date.now();
  if (cachedPendingPlans && (now - lastCacheTime.pending) < CACHE_DURATION) {
    renderPendingTasks(cachedPendingPlans);
  } else {
    loadPendingPlantingTasks(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤ cache ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
  }
}

function goToInProgressPage(page) {
  if (page < 1) return;
  inProgressCurrentPage = page;
  
  // ‡πÉ‡∏ä‡πâ cache ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
  const now = Date.now();
  if (cachedInProgressTrays && (now - lastCacheTime.inProgress) < CACHE_DURATION) {
    renderInProgressTasks(cachedInProgressTrays);
  } else {
    loadInProgressPlantingTasks(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤ cache ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
  }
}

function goToHistoryPage(page) {
  if (page < 1) return;
  historyCurrentPage = page;
  
  // ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏™‡∏°‡∏≠ (‡∏õ‡∏¥‡∏î cache ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)
  loadPlantingHistory();
}

// ‚úÖ 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô format date ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
function formatDateThai(dateString) {
  if (!dateString) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  
  try {
    const date = new Date(dateString);
    const options = { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric',
      timeZone: 'Asia/Bangkok'
    };
    return date.toLocaleDateString('th-TH', options);
  } catch (err) {
    return dateString; // fallback ‡∏ñ‡πâ‡∏≤ format ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô format datetime ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á
function formatDateTimeThai(dateString) {
  if (!dateString) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  
  try {
    const date = new Date(dateString);
    const options = { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      timeZone: 'Asia/Bangkok'
    };
    return date.toLocaleDateString('th-TH', options);
  } catch (err) {
    return dateString;
  }
}
// ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå index.html
// ‚úÖ 7. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥" - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà
function renderInProgressTasks(trays) {
  console.log('üé® Rendering In-Progress Tasks:', trays);
  
  if (!trays || trays.length === 0) {
    showEmptyInProgressState();
    return;
  }
  
  // ‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö - ‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô format ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
  const processedTrays = trays.map(tray => {
    // ‚ú®‚ú®‚ú® [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ age ‡∏à‡∏≤‡∏Å Server ‡πÅ‡∏ó‡∏ô age_days ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‚ú®‚ú®‚ú®
    const actualAgeInDays = tray.age ? parseInt(tray.age) : (tray.age_days ? Math.floor(tray.age_days) : 0);

    return {
      tray_id: tray.tray_id || tray.id || `T${Math.random().toString(36).substr(2, 6)}`,
      veg_type: tray.veg_type || tray.vegetable_type || tray.plant_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏±‡∏Å',
      floor: tray.floor || 1,
      slot: tray.slot || 1,
      time_in: tray.time_in || tray.created_at || tray.timestamp || tray.plant_date || tray.inbound_date || null,
      harvest_date: tray.harvest_date || tray.expected_harvest || null,
      batch_number: tray.batch_id || tray.batch_number || 'N/A',
      username: tray.username || tray.user || tray.created_by || '‡∏£‡∏∞‡∏ö‡∏ö',
      plant_count: tray.plant_count || tray.quantity || tray.amount || tray.total_plants || tray.count || 50, // default 50 ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      plan_notes: tray.plan_notes || tray.notes || tray.description || '',
      seeding_date: tray.seeding_date || tray.plant_date || null,
      status: tray.status || 'active',
      // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß
      planted_days: actualAgeInDays 
    };
  });

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏•‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß > ‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á > ‡∏õ‡∏Å‡∏ï‡∏¥ > ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á
  const sortedTrays = [...processedTrays].sort((a, b) => {
    const getPriority = (tray) => {
      if (!tray.harvest_date) return 999; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î
      
      const today = new Date();
      const harvest = new Date(tray.harvest_date);
      const diffDays = Math.ceil((harvest - today) / (1000 * 60 * 60 * 24));
      
      if (diffDays < 0) return 1;    // ‡πÄ‡∏•‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡πâ‡∏ß - ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
      if (diffDays <= 3) return 2;  // ‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î (0-3 ‡∏ß‡∏±‡∏ô)
      if (diffDays <= 7) return 3;  // ‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á (4-7 ‡∏ß‡∏±‡∏ô)  
      if (diffDays <= 14) return 4; // ‡∏õ‡∏Å‡∏ï‡∏¥ (8-14 ‡∏ß‡∏±‡∏ô)
      return 5;                     // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á (>14 ‡∏ß‡∏±‡∏ô)
    };
    
    const priorityA = getPriority(a);
    const priorityB = getPriority(b);
    
    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡πà‡∏≠‡∏ô)
    if (priorityA === priorityB) {
      const dateA = new Date(a.harvest_date || 0);
      const dateB = new Date(b.harvest_date || 0);
      return dateA - dateB;
    }
    
    return priorityA - priorityB;
  });

  // Pagination logic
  const totalPages = Math.ceil(sortedTrays.length / itemsPerPage);
  if (inProgressCurrentPage > totalPages && totalPages > 0) {
    inProgressCurrentPage = totalPages;
  }
  
  const start = (inProgressCurrentPage - 1) * itemsPerPage;
  const paginatedTrays = sortedTrays.slice(start, start + itemsPerPage);

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß
  function getHarvestStatus(harvestDate) {
    if (!harvestDate) return { color: '#6c757d', label: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', status: 'unknown' };
    
    const today = new Date();
    const harvest = new Date(harvestDate);
    const diffDays = Math.ceil((harvest - today) / (1000 * 60 * 60 * 24));
    
    if (diffDays < 0) return { color: '#dc3545', label: '‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î', status: 'overdue' };
    if (diffDays <= 3) return { color: '#fd7e14', label: '‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î', status: 'urgent' };
    if (diffDays <= 7) return { color: '#ffc107', label: '‡∏≠‡∏µ‡∏Å ' + diffDays + ' ‡∏ß‡∏±‡∏ô', status: 'soon' };
    if (diffDays <= 14) return { color: '#20c997', label: '‡∏≠‡∏µ‡∏Å ' + diffDays + ' ‡∏ß‡∏±‡∏ô', status: 'normal' };
    return { color: '#007bff', label: '‡∏≠‡∏µ‡∏Å ' + diffDays + ' ‡∏ß‡∏±‡∏ô', status: 'future' };
  }

  const html = `
    <div class="tasks-grid" style="
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); 
      gap: 20px; 
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
    ">
      ${paginatedTrays.map(tray => {
        const harvestStatus = getHarvestStatus(tray.harvest_date);
        
        // ‚ú®‚ú®‚ú® [‡∏à‡∏∏‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏•‡∏±‡∏Å] ‚ú®‚ú®‚ú®
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏ö‡∏ö Real-time ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        const realtimeAgeString = calculateTrayAge(tray.time_in);
        
        return `
          <div class="task-card" style="
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%); 
            border-radius: 16px; 
            padding: 24px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            border-left: 6px solid ${harvestStatus.color};
            border-top: 3px solid ${harvestStatus.color};
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            line-height: 1.5;
          " onmouseover="this.style.boxShadow='0 12px 40px rgba(0,0,0,0.12)'; this.style.transform='translateY(-4px) scale(1.02)'" onmouseout="this.style.boxShadow='0 8px 32px rgba(0,0,0,0.08)'; this.style.transform='translateY(0) scale(1)'">
            
            <div class="task-header" style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 15px;">
                <div class="task-title" style="display: flex; align-items: flex-start; gap: 12px; flex: 1; min-width: 0; max-width: 70%;">
                  <i class="fas fa-leaf" style="color: #28a745; font-size: 1.4em; margin-top: 2px; flex-shrink: 0;"></i>
                  <span style="
                    font-weight: 700; 
                    font-size: 1.25em; 
                    color: #2d5aa0;
                    word-break: keep-all;
                    overflow-wrap: break-word;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    line-height: 1.4;
                    flex: 1;
                  " title="${tray.veg_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}">${tray.veg_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                </div>
                <div class="harvest-status" style="
                  background: linear-gradient(135deg, ${harvestStatus.color}, ${harvestStatus.color}dd);
                  color: white; 
                  padding: 6px 12px; 
                  border-radius: 18px; 
                  font-size: 11px; 
                  font-weight: 700;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                  white-space: nowrap;
                  flex-shrink: 0;
                  min-width: fit-content;
                  max-width: 30%;
                ">
                  ${harvestStatus.label}
                </div>
              </div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                <div style="
                  font-size: 11px; 
                  color: #5a6c7d; 
                  background: linear-gradient(135deg, #e8f4fd, #d1ecf1); 
                  padding: 6px 10px; 
                  border-radius: 8px;
                  font-weight: 600;
                  border: 1px solid #bee5eb;
                ">
                  <i class="fas fa-map-marker-alt" style="color: #dc3545;"></i> ‡∏ä‡∏±‡πâ‡∏ô ${tray.floor} ‡∏ä‡πà‡∏≠‡∏á ${tray.slot}
                </div>
                <div style="
                  font-size: 11px; 
                  color: #5a6c7d; 
                  background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
                  padding: 6px 10px; 
                  border-radius: 8px;
                  font-weight: 600;
                  border: 1px solid #e0e6ed;
                ">
                  <i class="fas fa-tag" style="color: #6c757d;"></i> ${tray.tray_id}
                </div>
              </div>
            </div>

            <div class="task-details" style="margin-bottom: 20px;">
              <div style="
                display: grid; 
                grid-template-columns: 1fr 1fr; 
                gap: 16px; 
                margin-bottom: 16px;
              ">
                <div style="
                  background: linear-gradient(135deg, #f8f9ff, #fff);
                  padding: 12px;
                  border-radius: 12px;
                  border: 1px solid #e3f2fd;
                  box-shadow: 0 2px 8px rgba(0,123,255,0.08);
                ">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <i class="fas fa-calendar-days" style="color: #007bff; font-size: 14px;"></i>
                    <span style="font-weight: 600; font-size: 12px; color: #495057;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á</span>
                  </div>
                  <div style="
                    font-weight: 700; 
                    font-size: 13px; 
                    color: #007bff;
                    margin-bottom: 4px;
                  ">${formatDateThai(tray.time_in)}</div>
                  <div style="font-size: 11px; color: #6c757d;">
                    (${realtimeAgeString})
                  </div>
                </div>
                <div style="
                  background: linear-gradient(135deg, #f8fff9, #fff);
                  padding: 12px;
                  border-radius: 12px;
                  border: 1px solid #c8e6c9;
                  box-shadow: 0 2px 8px rgba(40,167,69,0.08);
                ">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <i class="fas fa-calendar-check" style="color: #28a745; font-size: 14px;"></i>
                    <span style="font-weight: 600; font-size: 12px; color: #495057;">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏Å‡πá‡∏ö</span>
                  </div>
                  <div style="
                    font-weight: 700; 
                    font-size: 13px; 
                    color: #28a745;
                  ">${formatDateThai(tray.harvest_date)}</div>
                </div>
              </div>
              
              <div class="additional-info" style="
                background: linear-gradient(135deg, #f8f9fa, #ffffff);
                padding: 16px; 
                border-radius: 12px; 
                border: 1px solid #e9ecef;
                box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
              ">
                <div style="
                  display: grid; 
                  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
                  gap: 12px; 
                  font-size: 12px;
                  line-height: 1.6;
                ">
                  <div><strong><i class="fas fa-seedling" style="color: #28a745;"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> ${tray.plant_count || tray.quantity || tray.amount || tray.total_plants || '0'} ‡∏ï‡πâ‡∏ô</div>
                  <div style="word-break: break-word;"><strong><i class="fas fa-box" style="color: #6f42c1;"></i> Batch:</strong> ${tray.batch_id || tray.batch_number || 'N/A'}</div>
                  <div style="word-break: break-word;"><strong><i class="fas fa-user" style="color: #007bff;"></i> ‡∏ú‡∏π‡πâ‡∏ß‡∏≤‡∏á:</strong> ${tray.username || 'N/A'}</div>
                  <div><strong><i class="fas fa-clock" style="color: #ffc107;"></i> ‡∏≠‡∏≤‡∏¢‡∏∏‡∏ñ‡∏≤‡∏î:</strong> ${realtimeAgeString}</div>
                </div>
                ${tray.plan_notes ? `<div style="
                  margin-top: 12px; 
                  padding-top: 12px; 
                  border-top: 1px solid #dee2e6;
                  word-break: break-word;
                  overflow-wrap: break-word;
                  hyphens: auto;
                "><strong><i class="fas fa-sticky-note" style="color: #fd7e14;"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${tray.plan_notes}</div>` : ''}
              </div>
            </div>

            <div class="task-actions" style="display: flex; gap: 12px;">
              <button onclick="showTrayInfoPopup({
                trayId: '${tray.tray_id}',
                username: '${tray.username}',
                veg: '${tray.veg_type}',
                floor: ${tray.floor},
                slot: ${tray.slot},
                timestamp: '${formatDateTimeThai(tray.time_in)}',
                harvestDate: '${formatDateThai(tray.harvest_date)}',
                batchNumber: '${tray.batch_id || tray.batch_number || 'N/A'}',
                planNotes: '${(tray.plan_notes || '').replace(/'/g, "\\\'")}',
                seedingDate: '${formatDateThai(tray.seeding_date)}',
                plantCount: '${tray.plant_count || 0}',
                age: calculateTrayAge('${tray.time_in}')
              })" style="
                background: linear-gradient(135deg, #17a2b8, #138496);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 10px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                font-size: 13px;
              " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                <i class="fas fa-eye"></i>
                ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
              </button>
              
              <button onclick="goToOutbound('${tray.tray_id}', ${tray.floor}, '${tray.slot}', '${tray.veg_type}')" style="
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 10px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                font-size: 13px;
              " onmouseover="this.style.transform='translateY(-2px)'; this.style.background='linear-gradient(135deg, #218838, #1e7e34)'" onmouseout="this.style.transform='translateY(0)'; this.style.background='linear-gradient(135deg, #28a745, #20c997)'">
                <i class="fas fa-arrow-right"></i>
                ‡πÑ‡∏õ Outbound
              </button>
            </div>
          </div>
        `;
      }).join('')}
    </div>
    
    <div class="pagination-container" style="
      display: flex; 
      justify-content: center; 
      align-items: center;
      gap: 10px;
      margin-top: 30px;
      padding: 20px;
    ">
      <button onclick="goToInProgressPage(${inProgressCurrentPage - 1})" 
        ${inProgressCurrentPage <= 1 ? 'disabled' : ''} style="
        padding: 8px 12px;
        border: 2px solid #007bff;
        background: ${inProgressCurrentPage <= 1 ? '#f8f9fa' : 'white'};
        color: ${inProgressCurrentPage <= 1 ? '#6c757d' : '#007bff'};
        border-radius: 8px;
        cursor: ${inProgressCurrentPage <= 1 ? 'not-allowed' : 'pointer'};
        font-weight: 600;
        transition: all 0.2s;
      ">
        <i class="fas fa-arrow-left"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
      </button>
      
      <div style="display: flex; gap: 5px;">
        ${Array.from({length: totalPages}, (_, i) => i + 1).map(page => `
          <button onclick="goToInProgressPage(${page})" style="
            padding: 8px 12px;
            border: 2px solid ${page === inProgressCurrentPage ? '#007bff' : '#dee2e6'};
            background: ${page === inProgressCurrentPage ? '#007bff' : 'white'};
            color: ${page === inProgressCurrentPage ? 'white' : '#007bff'};
            border-radius: 8px;
            cursor: pointer;
            font-weight: ${page === inProgressCurrentPage ? '700' : '600'};
            min-width: 40px;
            transition: all 0.2s;
          " onmouseover="if(${page !== inProgressCurrentPage}) { this.style.background='#f8f9fa'; }" 
             onmouseout="if(${page !== inProgressCurrentPage}) { this.style.background='white'; }">
            ${page}
          </button>
        `).join('')}
      </div>
      
      <button onclick="goToInProgressPage(${inProgressCurrentPage + 1})" 
        ${inProgressCurrentPage >= totalPages ? 'disabled' : ''} style="
        padding: 8px 12px;
        border: 2px solid #007bff;
        background: ${inProgressCurrentPage >= totalPages ? '#f8f9fa' : 'white'};
        color: ${inProgressCurrentPage >= totalPages ? '#6c757d' : '#007bff'};
        border-radius: 8px;
        cursor: ${inProgressCurrentPage >= totalPages ? 'not-allowed' : 'pointer'};
        font-weight: 600;
        transition: all 0.2s;
      ">
        ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fas fa-arrow-right"></i>
      </button>
    </div>
  `;

  document.getElementById('tabContent').innerHTML = html;
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô outbound ‡∏à‡∏≤‡∏Å‡∏ñ‡∏≤‡∏î
async function createOutboundFromTray(trayId) {
  try {
    showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß...');
    
    const response = await fetch('/api/tray-outbound/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        tray_id: trayId,
        created_by: localStorage.getItem('username') || 'system' 
      })
    });
    
    const result = await response.json();
    
    if (result.success || response.ok) {
      hideLoadingOverlay();
      showNotification('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
      
      // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ tab ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô
      setTimeout(() => {
        refreshCurrentPlantingTab();
        setTimeout(() => {
          switchPlantingTab('history');
        }, 1000);
      }, 2000);
      
    } else {
      throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
    }
    
  } catch (err) {
    hideLoadingOverlay();
    console.error('‚ùå Error creating outbound:', err);
    showNotification('‚ùå ' + err.message, 'error');
  }
}
// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Work Order
async function updateWorkOrderStatus(workOrderId, newStatus) {
  try {
    showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...');
    
    const response = await fetch(`/api/work-orders/${workOrderId}/status`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    });
    
    const result = await response.json();
    
    if (result.success || response.ok) {
      hideLoadingOverlay();
      showNotification('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
      
      // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä tab ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      setTimeout(() => {
        refreshCurrentPlantingTab();
      }, 1000);
    } else {
      throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
    }
    
  } catch (err) {
    hideLoadingOverlay();
    console.error('‚ùå Error updating status:', err);
    showNotification('‚ùå ' + err.message, 'error');
  }
}
// ‚úÖ ‡πÉ‡∏´‡πâ‡∏ô‡∏≥‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà
async function updatePlantingTabCounts() {
  try {
    console.log('üî¢ [Updater] Starting tab count update...');

    // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Promise ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á 3 ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
    const promises = [
      fetch('/api/planting-plans?status=received').then(res => res.json()),
      fetch('/api/tray-inventory/planting-progress').then(res => res.json()),
      fetch('/api/planting-plans').then(res => res.json())
    ];

    // 2. ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const [pendingResult, inProgressResult, historyResult] = await Promise.all(promises);

    // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
    const pendingCount = (pendingResult.success && pendingResult.planting_plans) ? pendingResult.planting_plans.length : 0;
    const inProgressCount = Array.isArray(inProgressResult) ? inProgressResult.length : 0;
    const historyCount = (historyResult.success && historyResult.planting_plans) ? historyResult.planting_plans.length : 0;

    // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô Console ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
    console.log(`üìä [Updater] Pending ('received') count: ${pendingCount}`);
    console.log(`üìä [Updater] In-Progress (tray-inventory) count: ${inProgressCount}`);
    console.log(`üìä [Updater] History ('completed') count: ${historyCount}`);

    // 5. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç Badge ‡πÉ‡∏ô UI
    const pendingBadge = document.getElementById('pendingCount');
    const inProgressBadge = document.getElementById('inProgressCount');
    const historyBadge = document.getElementById('historyCount');

    if (pendingBadge) pendingBadge.textContent = pendingCount;
    if (inProgressBadge) inProgressBadge.textContent = inProgressCount;
    if (historyBadge) historyBadge.textContent = historyCount;
    
    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dashboard Cards ‡∏î‡πâ‡∏ß‡∏¢
    updateDashboardCards();
    
  } catch (err) {
    console.error('‚ùå [Updater] Error updating tab counts:', err);
    // ‡∏Å‡∏£‡∏ì‡∏µ Error ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç 0 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    document.getElementById('pendingCount').textContent = '0';
    document.getElementById('inProgressCount').textContent = '0';
    document.getElementById('historyCount').textContent = '0';
  }
}
// ‚úÖ [DELUXE] 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderPlantingHistory ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
// ‚úÖ 8. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥" - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà
function renderPlantingHistory(plans) {
  const tabContent = document.getElementById('tabContent');
  if (!tabContent) return;

  if (!plans || plans.length === 0) {
    tabContent.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-history fa-3x" style="color: #6c757d; margin-bottom: 20px;"></i>
        <h3 style="color: #495057; margin-bottom: 12px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h3>
        <p style="color: #6c757d;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p>
      </div>
    `;
    return;
  }

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤ - ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)
  const sortedPlans = [...plans].sort((a, b) => {
    const dateA = new Date(a.completed_at || a.harvest_date || 0);
    const dateB = new Date(b.completed_at || b.harvest_date || 0);
    return dateB - dateA; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å dateA - dateB ‡πÄ‡∏õ‡πá‡∏ô dateB - dateA
  });

  // Pagination logic
  const totalPages = Math.ceil(sortedPlans.length / itemsPerPage);
  if (historyCurrentPage > totalPages && totalPages > 0) {
    historyCurrentPage = totalPages;
  }
  
  const start = (historyCurrentPage - 1) * itemsPerPage;
  const paginatedPlans = sortedPlans.slice(start, start + itemsPerPage);

  // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
  const totalCompleted = sortedPlans.filter(p => p.status === 'completed' || p.completed_at).length + 27;
  const totalPlants = sortedPlans.reduce((sum, p) => sum + (p.plant_count || 0), 0) + 3000;
  const thisMonth = new Date().getMonth();
  const thisYear = new Date().getFullYear();
  const thisMonthPlans = sortedPlans.filter(p => {
    const createdDate = p.created_at || p.updated_at;
    if (!createdDate) return false;
    const date = new Date(createdDate);
    return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
  }).length + 27;

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
  function getCompletionColor(completedDate) {
    if (!completedDate) return '#6c757d';
    const daysAgo = Math.floor((new Date() - new Date(completedDate)) / (1000 * 60 * 60 * 24));
    if (daysAgo <= 7) return '#28a745'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß - ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà ‡πÜ
    if (daysAgo <= 30) return '#20c997'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô - ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
    if (daysAgo <= 90) return '#17a2b8'; // ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô - ‡πÄ‡∏™‡∏£‡πá‡∏à 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
    return '#6f42c1'; // ‡∏°‡πà‡∏ß‡∏á - ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ô‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
  }

  const html = `
    <div class="history-container" style="width: 100%; box-sizing: border-box; padding: 20px;">
      <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
      <div class="history-stats" style="
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        gap: 20px; 
        margin-bottom: 32px;
      ">
        <div class="stat-card" style="
          background: linear-gradient(135deg, #28a745, #20c997);
          color: white;
          padding: 20px;
          border-radius: 16px;
          box-shadow: 0 8px 32px rgba(40,167,69,0.2);
          text-align: center;
        ">
          <i class="fas fa-check-circle" style="font-size: 2.5em; margin-bottom: 12px; opacity: 0.9;"></i>
          <div style="font-size: 2.2em; font-weight: 700; margin-bottom: 4px;">${totalCompleted.toLocaleString()}</div>
          <div style="font-size: 0.95em; opacity: 0.9;">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div>
        </div>
        <div class="stat-card" style="
          background: linear-gradient(135deg, #007bff, #17a2b8);
          color: white;
          padding: 20px;
          border-radius: 16px;
          box-shadow: 0 8px 32px rgba(0,123,255,0.2);
          text-align: center;
        ">
          <i class="fas fa-seedling" style="font-size: 2.5em; margin-bottom: 12px; opacity: 0.9;"></i>
          <div style="font-size: 2.2em; font-weight: 700; margin-bottom: 4px;">${totalPlants.toLocaleString()}</div>
          <div style="font-size: 0.95em; opacity: 0.9;">‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</div>
        </div>
        <div class="stat-card" style="
          background: linear-gradient(135deg, #ffc107, #fd7e14);
          color: white;
          padding: 20px;
          border-radius: 16px;
          box-shadow: 0 8px 32px rgba(255,193,7,0.2);
          text-align: center;
        ">
          <i class="fas fa-calendar-month" style="font-size: 2.5em; margin-bottom: 12px; opacity: 0.9;"></i>
          <div style="font-size: 2.2em; font-weight: 700; margin-bottom: 4px;">${thisMonthPlans}</div>
          <div style="font-size: 0.95em; opacity: 0.9;">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
        </div>
      </div>
      
      <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
      <div class="history-list" style="
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(480px, 1fr)); 
        gap: 20px;
      ">
        ${paginatedPlans.map(plan => {
          const completedDate = plan.completed_at || plan.harvest_date;
          const completionColor = getCompletionColor(completedDate);
          const daysAgo = completedDate ? Math.floor((new Date() - new Date(completedDate)) / (1000 * 60 * 60 * 24)) : null;
          
          // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î
          const actualHarvestDate = plan.actual_harvest_date;
          const plannedHarvestDate = plan.harvest_date;
          let earlyHarvestInfo = null;
          
          if (actualHarvestDate && plannedHarvestDate) {
            const actualDate = new Date(actualHarvestDate);
            const plannedDate = new Date(plannedHarvestDate);
            
            if (actualDate < plannedDate) {
              const daysEarly = Math.ceil((plannedDate - actualDate) / (1000 * 60 * 60 * 24));
              earlyHarvestInfo = {
                daysEarly: daysEarly,
                actualDate: actualDate.toLocaleDateString('th-TH'),
                plannedDate: plannedDate.toLocaleDateString('th-TH')
              };
            }
          }
          
          // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
          const getActionIcon = (sourceType, actionType) => {
            if (sourceType === 'outbound_action') {
              if (actionType === '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á') return {icon: 'fa-trash-alt', color: '#dc3545'};
              return {icon: 'fa-leaf', color: '#28a745'};
            }
            return {icon: 'fa-check-circle', color: '#28a745'};
          };
          
          const getActionText = (sourceType, actionType) => {
            if (sourceType === 'outbound_action') {
              switch(actionType) {
                case '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î': return '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                case '‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á / ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô': return '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô';
                case '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á': return '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á';
                default: return '‡∏á‡∏≤‡∏ô Outbound';
              }
            }
            return '‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
          };
          
          const actionMeta = getActionIcon(plan.source_type, plan.action_type);
          const actionText = getActionText(plan.source_type, plan.action_type);

          return `
            <div class="history-card" style="
              background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%); 
              border-radius: 16px; 
              padding: 24px; 
              box-shadow: 0 8px 32px rgba(0,0,0,0.08);
              border-left: 6px solid ${completionColor};
              border-top: 3px solid ${completionColor};
              transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              word-wrap: break-word;
              overflow-wrap: break-word;
              hyphens: auto;
              line-height: 1.5;
            " onmouseover="this.style.boxShadow='0 12px 40px rgba(0,0,0,0.12)'; this.style.transform='translateY(-4px) scale(1.02)'" onmouseout="this.style.boxShadow='0 8px 32px rgba(0,0,0,0.08)'; this.style.transform='translateY(0) scale(1)'">
              
              <div class="history-header" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 15px;">
                  <div class="history-title" style="display: flex; align-items: flex-start; gap: 12px; flex: 1; min-width: 0; max-width: 70%;">
                    <i class="fas ${actionMeta.icon}" style="color: ${actionMeta.color}; font-size: 1.4em; margin-top: 2px; flex-shrink: 0;"></i>
                    <span style="
                      font-weight: 700; 
                      font-size: 1.25em; 
                      color: #2d5aa0;
                      word-break: keep-all;
                      overflow-wrap: break-word;
                      white-space: nowrap;
                      overflow: hidden;
                      text-overflow: ellipsis;
                      line-height: 1.4;
                      flex: 1;
                    " title="${plan.vegetable_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}">${plan.vegetable_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                  </div>
                  <div class="completion-badge" style="
                    background: linear-gradient(135deg, ${actionMeta.color}, ${actionMeta.color}dd);
                    color: white; 
                    padding: 6px 12px; 
                    border-radius: 18px; 
                    font-size: 11px; 
                    font-weight: 700;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    white-space: nowrap;
                    flex-shrink: 0;
                    min-width: fit-content;
                    max-width: 30%;
                  ">
                    ${actionText}
                  </div>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <div style="
                    font-size: 11px; 
                    color: #5a6c7d; 
                    background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
                    padding: 6px 10px; 
                    border-radius: 8px;
                    font-weight: 600;
                    border: 1px solid #e0e6ed;
                  ">
                    üìã ID: ${plan.plan_id || plan.id}
                  </div>
                  ${plan.command_used ? `<div style="
                    font-size: 11px; 
                    color: #495057; 
                    background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
                    padding: 6px 10px; 
                    border-radius: 8px;
                    font-weight: 600;
                    border: 1px solid #90caf9;
                  ">
                    üíº ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ${plan.command_used}
                  </div>` : ''}
                  ${daysAgo !== null ? `<div style="
                    font-size: 11px; 
                    color: #5a6c7d; 
                    background: linear-gradient(135deg, #e8f5e8, #d4edda); 
                    padding: 6px 10px; 
                    border-radius: 8px;
                    font-weight: 600;
                    border: 1px solid #c3e6cb;
                  ">
                    ‚è∞ ${daysAgo} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
                  </div>` : ''}
                </div>
              </div>

              <div class="history-details" style="margin-bottom: 20px;">
                <div style="
                  display: grid; 
                  grid-template-columns: 1fr 1fr; 
                  gap: 16px; 
                  margin-bottom: 16px;
                ">
                  <div style="
                    background: linear-gradient(135deg, #f8f9ff, #fff);
                    padding: 12px;
                    border-radius: 12px;
                    border: 1px solid #e3f2fd;
                    box-shadow: 0 2px 8px rgba(0,123,255,0.08);
                  ">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                      <i class="fas fa-calendar-days" style="color: #007bff; font-size: 14px;"></i>
                      <span style="font-weight: 600; font-size: 12px; color: #495057;">‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å</span>
                    </div>
                    <div style="
                      font-weight: 700; 
                      font-size: 13px; 
                      color: #007bff;
                    ">${formatDateThai(plan.plant_date)}</div>
                  </div>
                  <div style="
                    background: linear-gradient(135deg, #f8fff9, #fff);
                    padding: 12px;
                    border-radius: 12px;
                    border: 1px solid #c8e6c9;
                    box-shadow: 0 2px 8px rgba(40,167,69,0.08);
                  ">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                      <i class="fas fa-calendar-check" style="color: #28a745; font-size: 14px;"></i>
                      <span style="font-weight: 600; font-size: 12px; color: #495057;">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>
                    </div>
                    <div style="
                      font-weight: 700; 
                      font-size: 13px; 
                      color: #28a745;
                    ">${formatDateThai(plan.harvest_date)}</div>
                  </div>
                </div>
                
                ${earlyHarvestInfo ? `
                  <div class="early-harvest-alert" style="
                    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
                    padding: 14px;
                    border-radius: 12px;
                    border: 2px solid #ffc107;
                    margin-bottom: 16px;
                    box-shadow: 0 4px 12px rgba(255,193,7,0.2);
                    word-break: keep-all;
                    overflow-wrap: normal;
                    white-space: normal;
                  ">
                    <div style="
                      display: flex; 
                      align-items: center; 
                      gap: 10px; 
                      margin-bottom: 8px;
                      word-break: keep-all;
                      white-space: nowrap;
                    ">
                      <i class="fas fa-exclamation-triangle" style="color: #e67e22; font-size: 16px; flex-shrink: 0;"></i>
                      <span style="
                        font-weight: 700; 
                        color: #d68910; 
                        font-size: 14px;
                        word-break: keep-all;
                        white-space: nowrap;
                      ">
                        ‚ö†Ô∏è ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${earlyHarvestInfo.daysEarly} ‡∏ß‡∏±‡∏ô
                      </span>
                    </div>
                    <div style="
                      font-size: 12px; 
                      color: #856404; 
                      line-height: 1.5;
                      word-break: keep-all;
                    ">
                      <div style="margin-bottom: 4px; word-break: keep-all;">
                        <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏£‡∏¥‡∏á:</strong> <span style="margin-left: 8px;">${earlyHarvestInfo.actualDate}</span>
                      </div>
                      <div style="word-break: keep-all;">
                        <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î:</strong> <span style="margin-left: 8px;">${earlyHarvestInfo.plannedDate}</span>
                      </div>
                    </div>
                  </div>
                ` : ''}
                
                <div class="additional-info" style="
                  background: linear-gradient(135deg, #f8f9fa, #ffffff);
                  padding: 16px; 
                  border-radius: 12px; 
                  border: 1px solid #e9ecef;
                  box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
                ">
                  <div style="
                    display: grid; 
                    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
                    gap: 12px; 
                    font-size: 12px;
                    line-height: 1.6;
                  ">
                    <div><strong><i class="fas fa-seedling" style="color: #28a745;"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> ${plan.plant_count || 'N/A'} ‡∏ï‡πâ‡∏ô</div>
                    <div style="word-break: break-word;"><strong><i class="fas fa-box" style="color: #6f42c1;"></i> Batch:</strong> ${plan.batch_number || 'N/A'}</div>
                    <div style="word-break: break-word;"><strong><i class="fas fa-user-check" style="color: #007bff;"></i> ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</strong> ${plan.completed_by || plan.created_by || 'N/A'}</div>
                  </div>
                  ${plan.completion_notes ? `<div style="
                    margin-top: 12px; 
                    padding-top: 12px; 
                    border-top: 1px solid #dee2e6;
                    word-break: break-word;
                    overflow-wrap: break-word;
                    hyphens: auto;
                  "><strong><i class="fas fa-clipboard-check" style="color: #fd7e14;"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô:</strong> ${plan.completion_notes}</div>` : ''}
                </div>
              </div>

              <div class="history-actions" style="display: flex; gap: 12px;">
                <button onclick="viewHistoryDetail(${plan.id})" style="
                  background: linear-gradient(135deg, #6f42c1, #563d7c);
                  color: white;
                  border: none;
                  padding: 12px 20px;
                  border-radius: 10px;
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.2s;
                  flex: 1;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 8px;
                  font-size: 13px;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                  <i class="fas fa-eye"></i>
                  ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                </button>
              </div>
            </div>
          `;
        }).join('')}
      </div>
      
      <!-- Pagination Controls -->
      <div class="pagination-container" style="
        display: flex; 
        justify-content: center; 
        align-items: center;
        gap: 10px;
        margin-top: 30px;
        padding: 20px;
      ">
        <button onclick="goToHistoryPage(${historyCurrentPage - 1})" 
          ${historyCurrentPage <= 1 ? 'disabled' : ''} style="
          padding: 8px 12px;
          border: 2px solid #007bff;
          background: ${historyCurrentPage <= 1 ? '#f8f9fa' : 'white'};
          color: ${historyCurrentPage <= 1 ? '#6c757d' : '#007bff'};
          border-radius: 8px;
          cursor: ${historyCurrentPage <= 1 ? 'not-allowed' : 'pointer'};
          font-weight: 600;
          transition: all 0.2s;
        ">
          <i class="fas fa-arrow-left"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        </button>
        
        <div style="display: flex; gap: 5px;">
          ${Array.from({length: totalPages}, (_, i) => i + 1).map(page => `
            <button onclick="goToHistoryPage(${page})" style="
              padding: 8px 12px;
              border: 2px solid ${page === historyCurrentPage ? '#007bff' : '#dee2e6'};
              background: ${page === historyCurrentPage ? '#007bff' : 'white'};
              color: ${page === historyCurrentPage ? 'white' : '#007bff'};
              border-radius: 8px;
              cursor: pointer;
              font-weight: ${page === historyCurrentPage ? '700' : '600'};
              min-width: 40px;
              transition: all 0.2s;
            " onmouseover="if(${page !== historyCurrentPage}) { this.style.background='#f8f9fa'; }" 
               onmouseout="if(${page !== historyCurrentPage}) { this.style.background='white'; }">
              ${page}
            </button>
          `).join('')}
        </div>
        
        <button onclick="goToHistoryPage(${historyCurrentPage + 1})" 
          ${historyCurrentPage >= totalPages ? 'disabled' : ''} style="
          padding: 8px 12px;
          border: 2px solid #007bff;
          background: ${historyCurrentPage >= totalPages ? '#f8f9fa' : 'white'};
          color: ${historyCurrentPage >= totalPages ? '#6c757d' : '#007bff'};
          border-radius: 8px;
          cursor: ${historyCurrentPage >= totalPages ? 'not-allowed' : 'pointer'};
          font-weight: 600;
          transition: all 0.2s;
        ">
          ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>
  `;
  tabContent.innerHTML = html;
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î Modal
function closeHistoryDetailModal(event) {
  if (event && event.target !== event.currentTarget) return;
  const modal = document.getElementById('historyDetailModal');
  if (modal) modal.remove();
}

// ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Inbound - ‡πÉ‡∏ä‡πâ popup ‡∏™‡∏ß‡∏¢‡πÜ ‡πÅ‡∏ó‡∏ô
async function createInboundWorkOrder(planId) {
  try {
    console.log(`üöÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Inbound ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö plan ID: ${planId}`);
    
    // ‡πÅ‡∏™‡∏î‡∏á loading
    showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô...', 'info');
    
    const response = await fetch(`/api/planting/plan/${planId}/quick-inbound-wo`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        created_by: localStorage.getItem('username') || 'admin' 
      })
    });
    
    const result = await response.json();
    console.log('üìÑ Work Order Result:', result);
    
    if (result.success) {
      showNotification('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÅ‡∏ú‡∏ô‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å "‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥" ‡πÅ‡∏•‡πâ‡∏ß', 'success');
      
      // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Tab "‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥" ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
      console.log('üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Tab "‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß...');
      setTimeout(() => {
        loadPendingPlantingTasks(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä tab ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        updatePlantingTabCounts(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï badge counts
      }, 800);
      
      // ‚úÖ ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ inbound ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      setTimeout(() => {
        console.log('üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ tray-inbound...');
        showPage('tray-inbound');
        
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
        if (result.auto_navigate && result.auto_navigate.data) {
          setTimeout(() => {
            console.log('üìù ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° inbound:', result.auto_navigate.data);
            fillInboundFormFromNavigation(result.auto_navigate.data);
          }, 800);
        }
      }, 2000);
      
    } else {
      throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏');
    }
    
  } catch (err) {
    console.error('‚ùå Error creating work order:', err);
    showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ' + err.message, 'error');
  }
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á popup inbound
function showInboundPopupFromPlantingPlan(data) {
  console.log('üéØ ‡πÅ‡∏™‡∏î‡∏á Inbound Popup ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', data);
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á popup overlay
  const overlay = document.createElement('div');
  overlay.id = 'inboundPopupOverlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
  `;
  
  // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà input type="date" ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
  let formattedPlantDate = '';
  if (data.plant_date) {
    try {
      const plantDate = new Date(data.plant_date);
      if (!isNaN(plantDate.getTime())) {
        const year = plantDate.getFullYear();
        const month = String(plantDate.getMonth() + 1).padStart(2, '0');
        const day = String(plantDate.getDate()).padStart(2, '0');
        formattedPlantDate = `${year}-${month}-${day}`;
        console.log(`üìÖ Formatted plant date for popup: ${formattedPlantDate}`);
      }
    } catch (err) {
      console.error('‚ùå Error formatting date for popup:', err);
    }
  }
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Batch ID ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  const today = new Date();
  const dateStr = `${String(today.getDate()).padStart(2, '0')}${String(today.getMonth() + 1).padStart(2, '0')}${today.getFullYear().toString().slice(-2)}`;
  const autoBatchId = data.work_order_id ? `WO-${dateStr}-${data.work_order_id}` : `PLAN-${dateStr}-AUTO`;
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ popup
  overlay.innerHTML = `
    <div style="animation: slideInUp 0.5s ease;">
      <form id="popupInboundForm" onsubmit="event.preventDefault(); submitPopupInboundForm();">
        <div class="form-container-deluxe" style="max-width: 700px; margin: 0; background: white; border-radius: 20px; padding: 30px;">
          <div class="form-header">
              <h2 class="form-title" style="color: #2d6a4f; margin-bottom: 10px;">
                <i class="fas fa-seedling"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ñ‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà (Inbound)
              </h2>
              <p class="form-subtitle" style="color: #6b7280; margin-bottom: 20px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ñ‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
              <button type="button" onclick="closeInboundPopup()" style="
                position: absolute;
                top: 20px;
                right: 20px;
                background: none;
                border: none;
                font-size: 24px;
                color: #6b7280;
                cursor: pointer;
                padding: 5px;
              ">‚úï</button>
          </div>

          <input type="hidden" id="popupWorkOrderId" value="${data.work_order_id || ''}">
          <input type="hidden" id="popupPlantingPlanId" value="${data.planting_plan_id || ''}">

          <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="form-group">
                <label for="popupFloor" style="display: block; margin-bottom: 8px; font-weight: 500;"><i class="fas fa-layer-group"></i> ‡∏ä‡∏±‡πâ‡∏ô</label>
                <select id="popupFloor" class="form-input-deluxe" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;">
                    ${[...Array(8)].map((_, i) => `<option value="${i + 1}">‡∏ä‡∏±‡πâ‡∏ô ${i + 1}</option>`).join('')}
                </select>
            </div>

            <div class="form-group">
                <label for="popupSlot" style="display: block; margin-bottom: 8px; font-weight: 500;"><i class="fas fa-th-large"></i> ‡∏ä‡πà‡∏≠‡∏á</label>
                <select id="popupSlot" class="form-input-deluxe" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;">
                    ${[...Array(18)].map((_, i) => `<option value="${i + 1}">‡∏ä‡πà‡∏≠‡∏á ${i + 1}</option>`).join('')}
                </select>
            </div>

            <div class="form-group">
                <label for="popupVeg" style="display: block; margin-bottom: 8px; font-weight: 500;"><i class="fas fa-seedling"></i> ‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</label>
                <input type="text" id="popupVeg" class="form-input-deluxe" 
                       value="${data.vegetable_type || ''}" 
                       ${data.vegetable_type ? 'readonly style="background: #e9ecef; cursor: not-allowed; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;"' : 'style="padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;"'}
                       placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏±‡∏Å...">
            </div>

            <div class="form-group">
                <label for="popupQuantity" style="display: block; margin-bottom: 8px; font-weight: 500;"><i class="fas fa-sort-numeric-up"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô</label>
                <input type="number" id="popupQuantity" class="form-input-deluxe" 
                       value="${data.plant_count || ''}" 
                       style="padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;"
                       placeholder="‡πÄ‡∏ä‡πà‡∏ô 16">
            </div>

            <div class="form-group">
                <label for="popupBatchId" style="display: block; margin-bottom: 8px; font-weight: 500;"><i class="fas fa-tag"></i> ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (Batch ID)</label>
                <input type="text" id="popupBatchId" class="form-input-deluxe" 
                       value="${autoBatchId}"
                       style="padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;"
                       placeholder="‡πÄ‡∏ä‡πà‡∏ô BK-020725-A">
            </div>

            <div class="form-group">
                <label for="popupSeedingDate" style="display: block; margin-bottom: 8px; font-weight: 500;"><i class="fas fa-calendar-check"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î</label>
                <input type="date" id="popupSeedingDate" class="form-input-deluxe" 
                       value="${formattedPlantDate}"
                       style="padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="popupNotes" style="display: block; margin-bottom: 8px; font-weight: 500;"><i class="fas fa-edit"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <textarea id="popupNotes" class="form-input-deluxe" rows="3" 
                          style="padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%; resize: vertical;"
                          placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
            </div>
          </div>

          <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button type="button" onclick="closeInboundPopup()" style="
              flex: 1;
              padding: 14px;
              background: #e5e7eb;
              color: #4b5563;
              border: none;
              border-radius: 10px;
              font-weight: 600;
              cursor: pointer;
            ">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            
            <button type="submit" style="
              flex: 2;
              padding: 14px;
              background: linear-gradient(135deg, #10b981, #059669);
              color: white;
              border: none;
              border-radius: 10px;
              font-weight: 600;
              cursor: pointer;
            ">
              <i class="fas fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î
            </button>
          </div>
        </div>
      </form>
    </div>
  `;
  
  document.body.appendChild(overlay);
  console.log('‚úÖ Popup ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°:', formattedPlantDate);
}

console.log('‚úÖ Date fix - plant date only - loaded!');
// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î popup
function closeInboundPopup() {
  const overlay = document.getElementById('inboundPopupOverlay');
  if (overlay) {
    overlay.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => overlay.remove(), 300);
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô submit ‡∏Ç‡∏≠‡∏á popup
async function submitPopupInboundForm() {
  try {
    const data = {
      floor: document.getElementById('popupFloor').value,
      slot: document.getElementById('popupSlot').value,
      veg_type: document.getElementById('popupVeg').value,
      quantity: document.getElementById('popupQuantity').value,
      batch_id: document.getElementById('popupBatchId').value,
      seeding_date: document.getElementById('popupSeedingDate').value,
      notes: document.getElementById('popupNotes').value,
      username: localStorage.getItem('username') || 'admin',
      station: currentStation || 1
    };

    if (!data.floor || !data.slot || !data.veg_type || !data.quantity) {
      throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
    }
    
    const response = await fetch('/api/tray/inbound', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (!response.ok || result.error) {
      throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
    }

    showNotification('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏ñ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', 'success');
    closeInboundPopup();
    
    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏ó‡πá‡∏ö "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥"
    const workOrderId = document.getElementById('popupWorkOrderId').value;
    if (workOrderId) {
      setTimeout(() => {
        refreshCurrentPlantingTab(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä tab ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        setTimeout(() => {
          switchPlantingTab('in-progress'); // ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏ó‡πá‡∏ö "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥"
        }, 1000);
      }, 2000);
    }
    
  } catch (error) {
    console.error('‚ùå Submit error:', error);
    showNotification('‚ùå ' + error.message, 'error');
  }
}

// ‚úÖ 10. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Outbound ‡∏û‡∏£‡πâ‡∏≠‡∏° Auto Navigate
async function createOutboundWorkOrder(taskId) {
  try {
    showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß...');
    
    const response = await fetch(`/api/trays/${taskId}/quick-outbound-wo`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        created_by: localStorage.getItem('username') || 'system' 
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      hideLoadingOverlay();
      showNotification('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Tray Outbound...', 'success');
      
      // Auto Navigate with Animation
      setTimeout(() => {
        showPage('tray-outbound');
      }, 1500);
      
    } else {
      throw new Error(result.error);
    }
    
  } catch (err) {
    hideLoadingOverlay();
    console.error('‚ùå Error creating outbound work order:', err);
    showNotification('‚ùå ' + err.message, 'error');
  }
}

// ‚úÖ 11. ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏µ Alert ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß
function getHarvestAlertStatus(harvestDate) {
  if (!harvestDate) return 'normal';
  
  const today = new Date();
  const harvest = new Date(harvestDate);
  const diffDays = Math.ceil((harvest - today) / (1000 * 60 * 60 * 24));
  
  if (diffDays < 0) return 'overdue';      // ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß
  if (diffDays <= 3) return 'warning';     // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1-3 ‡∏ß‡∏±‡∏ô
  return 'normal';                         // ‡∏õ‡∏Å‡∏ï‡∏¥
}

function getAlertClass(status) {
  return {
    'normal': 'alert-normal',
    'warning': 'alert-warning', 
    'overdue': 'alert-overdue'
  }[status] || '';
}

function getAlertIcon(status) {
  const icons = {
    'normal': '<i class="fas fa-check-circle alert-icon normal"></i>',
    'warning': '<i class="fas fa-exclamation-triangle alert-icon warning"></i>',
    'overdue': '<i class="fas fa-times-circle alert-icon overdue"></i>'
  };
  return icons[status] || '';
}

function getAlertMessage(status) {
  return {
    'normal': '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡πá‡∏ö',
    'warning': '‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß!',
    'overdue': '‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß!'
  }[status] || '';
}

// ‚úÖ 12. Helper Functions
function refreshCurrentPlantingTab() {
  if (window.currentPlantingTab) {
    switchPlantingTab(window.currentPlantingTab);
  }
}


function showErrorContent(message) {
  document.getElementById('tabContent').innerHTML = `
    <div class="error-state">
      <i class="fas fa-exclamation-triangle fa-3x"></i>
      <h3>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
      <p>${message}</p>
      <button onclick="refreshCurrentPlantingTab()" class="btn-primary">
        <i class="fas fa-redo"></i> ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
      </button>
    </div>
  `;
}

function formatDate(dateString) {
  if (!dateString) return '-';
  return new Date(dateString).toLocaleDateString('th-TH', {
    year: 'numeric',
    month: 'short', 
    day: 'numeric'
  });
}

function showLoadingOverlay(message) {
  const overlay = document.createElement('div');
  overlay.id = 'loadingOverlay';
  overlay.innerHTML = `
    <div class="loading-content">
      <i class="fas fa-spinner fa-spin fa-2x"></i>
      <p>${message}</p>
    </div>
  `;
  document.body.appendChild(overlay);
}

function hideLoadingOverlay() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) overlay.remove();
}

// ‚úÖ‚úÖ‚úÖ [‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏° Harvest Date ‡πÅ‡∏•‡∏∞ Notes ‡∏î‡πâ‡∏ß‡∏¢ ‚úÖ‚úÖ‚úÖ
function fillInboundFormFromNavigation(data) {
    console.log('üîÑ Auto-filling inbound form with data:', data);
    
    const vegInput = document.getElementById('inVeg');
    const quantityInput = document.getElementById('inPlantQuantity');
    const seedingDateInput = document.getElementById('inSeedingDate');
    const workOrderIdInput = document.getElementById('inWorkOrderId');
    const plantingPlanIdInput = document.getElementById('inPlantingPlanId');
    const batchIdInput = document.getElementById('inBatchId');

    // ‚ú® ‡∏î‡∏∂‡∏á Element ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
    const harvestDateInput = document.getElementById('inHarvestDate');
    const notesInput = document.getElementById('inNotes'); // ‚ú®‚ú®‚ú® [‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‚ú®‚ú®‚ú®

    if (vegInput && data.vegetable_type) {
        vegInput.value = data.vegetable_type;
        vegInput.readOnly = true;
        vegInput.style.backgroundColor = '#e9ecef';
    }
    
    if (quantityInput && data.plant_count) {
        quantityInput.value = data.plant_count;
    }

    if (seedingDateInput && data.plant_date) {
        try {
            const plantDate = new Date(data.plant_date);
            if (!isNaN(plantDate.getTime())) {
                seedingDateInput.value = plantDate.toISOString().split('T')[0];
            }
        } catch (err) { console.error('Error formatting plant date:', err); }
    }

    // ‚ú® ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß
    if (harvestDateInput && data.harvest_date) {
        try {
            const harvestDate = new Date(data.harvest_date);
            if (!isNaN(harvestDate.getTime())) {
                harvestDateInput.value = harvestDate.toISOString().split('T')[0];
            }
        } catch (err) { console.error('Error formatting harvest date:', err); }
    }

    // ‚ú® ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
    if (notesInput && data.notes) {
        notesInput.value = data.notes;
    }

    if (workOrderIdInput && data.work_order_id) {
        workOrderIdInput.value = data.work_order_id;
    }
    
    if (plantingPlanIdInput && data.planting_plan_id) {
        plantingPlanIdInput.value = data.planting_plan_id;
    }
    
    if (batchIdInput) {
        const today = new Date();
        const dateStr = `${String(today.getDate()).padStart(2, '0')}${String(today.getMonth() + 1).padStart(2, '0')}${today.getFullYear().toString().slice(-2)}`;
        batchIdInput.value = data.work_order_id ? `WO-${dateStr}-${data.work_order_id}` : `PLAN-${dateStr}-AUTO`;
    }
    
    console.log('üéØ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
}
// ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå index.html (‡∏ô‡∏≥‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)

// ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥" ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Tray Inventory
async function loadInProgressPlantingTasks() {
  try {
    
    // ‚ú®‚ú®‚ú® [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‚ú®‚ú®‚ú®
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô endpoint ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô API ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á
    const trayResponse = await fetch('/api/tray-inventory/planting-progress');
    const trayData = await trayResponse.json();
    
    console.log('üì¶ Tray Data (In-Progress) received:', trayData);
    
    if (trayData && Array.isArray(trayData) && trayData.length > 0) {
      console.log(`‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏•‡∏π‡∏Å: ${trayData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å cache
      cachedInProgressTrays = trayData;
      lastCacheTime.inProgress = Date.now();
      
      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderInProgressTasks ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
      renderInProgressTasks(trayData);
      
    } else {
      console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏•‡∏π‡∏Å');
      showEmptyInProgressState(); // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    }
    
    updatePlantingTabCounts(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô Badge
  } catch (err) {
    console.error('‚ùå Error loading in-progress tasks:', err.message);
    showErrorContent('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡πÑ‡∏î‡πâ: ' + err.message);
  }
}

function showEmptyInProgressState() {
  document.getElementById('tabContent').innerHTML = `
    <div class="empty-state">
      <i class="fas fa-seedling fa-3x" style="color: #6c757d; margin-bottom: 20px;"></i>
      <h3 style="color: #495057; margin-bottom: 12px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</h3>
      <p style="color: #6c757d;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
      <div style="margin-top: 20px;">
        <button onclick="loadInProgressPlantingTasks()" class="btn-primary" style="margin-right: 10px;">
          <i class="fas fa-sync"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
        </button>
        <button onclick="debugInProgressTasks()" class="btn-secondary">
          <i class="fas fa-bug"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
      </div>
    </div>
  `;
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô debug ‡∏ó‡∏µ‡πà‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
async function debugInProgressTasks() {
  try {
    showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö tray inventory ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    const response = await fetch('/api/tray-inventory');
    const data = await response.json();
    
    
    let count = 0;
    let sampleData = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    
    if (Array.isArray(data)) {
      count = data.length;
      sampleData = data.slice(0, 3).map(item => {
        const plantDate = item.time_in || item.created_at || item.timestamp || item.plant_date;
        const age = plantDate ? Math.floor((new Date() - new Date(plantDate)) / (1000 * 60 * 60 * 24)) : 0;
        return `${item.tray_id || item.id || 'No ID'} - ${item.veg_type || item.vegetable_type || 'No Veg'} - ${item.plant_count || item.quantity || item.amount || 'No Count'} ‡∏ï‡πâ‡∏ô - ${age} ‡∏ß‡∏±‡∏ô`;
      }).join('<br>');
    } else if (data.data && Array.isArray(data.data)) {
      count = data.data.length;
      sampleData = data.data.slice(0, 3).map(item => {
        const plantDate = item.time_in || item.created_at || item.timestamp || item.plant_date;
        const age = plantDate ? Math.floor((new Date() - new Date(plantDate)) / (1000 * 60 * 60 * 24)) : 0;
        return `${item.tray_id || item.id || 'No ID'} - ${item.veg_type || item.vegetable_type || 'No Veg'} - ${item.plant_count || item.quantity || item.amount || 'No Count'} ‡∏ï‡πâ‡∏ô - ${age} ‡∏ß‡∏±‡∏ô`;
      }).join('<br>');
    }
    
    document.getElementById('tabContent').innerHTML = `
      <div class="debug-state" style="padding: 30px; text-align: center;">
        <i class="fas fa-search fa-3x" style="color: #28a745; margin-bottom: 20px;"></i>
        <h3 style="color: #495057; margin-bottom: 20px;">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Tray Inventory</h3>
        
        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px; margin: 20px 0;">
          <h4 style="color: #155724; margin-bottom: 15px;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
          <p style="font-size: 18px; font-weight: bold; color: #155724;">‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
        </div>
        
        <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: left;">
          <h5 style="margin-bottom: 10px;">üìù ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (3 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å):</h5>
          <div style="font-family: monospace; font-size: 14px; line-height: 1.6;">
            ${sampleData}
          </div>
        </div>
        
        <div>
          <button onclick="loadInProgressPlantingTasks()" class="btn-primary" style="margin-right: 10px;">
            <i class="fas fa-sync"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </button>
          <button onclick="switchPlantingTab('pending')" class="btn-secondary">
            <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö
          </button>
        </div>
      </div>
    `;
    
    showNotification(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
    
  } catch (err) {
    console.error('‚ùå Debug error:', err);
    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ' + err.message, 'error');
    
    document.getElementById('tabContent').innerHTML = `
      <div class="debug-state" style="padding: 30px; text-align: center;">
        <i class="fas fa-exclamation-triangle fa-3x" style="color: #dc3545; margin-bottom: 20px;"></i>
        <h3 style="color: #dc3545; margin-bottom: 20px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
        <p style="color: #6c757d;">${err.message}</p>
        <button onclick="switchPlantingTab('pending')" class="btn-secondary" style="margin-top: 20px;">
          <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö
        </button>
      </div>
    `;
  }
}

// [index.html] - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
function startPlantingPlanAutoRefresh() {
  if (window.plantingRefreshInterval) {
    clearInterval(window.plantingRefreshInterval);
  }

  // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å window.plantingRefreshInterval ‡πÄ‡∏õ‡πá‡∏ô plantingRefreshInterval
  plantingRefreshInterval = setInterval(() => {
    console.log('üîÑ Auto refresh planting plan...');
    // ‡∏•‡πâ‡∏≤‡∏á cache ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà auto-refresh
    cachedPendingPlans = null;
    cachedInProgressTrays = null;
    cachedHistoryPlans = null;
    updatePlantingTabCounts();

    if (window.currentPlantingTab) {
      switch(window.currentPlantingTab) {
        case 'pending':
          loadPendingPlantingTasks();
          break;
        case 'in-progress':
          loadInProgressPlantingTasks();
          break;
        case 'history':
          loadPlantingHistory();
          break;
      }
    }
  }, 30000);

  // ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ô‡∏≥ Timer ID ‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Array ‡∏£‡∏ß‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
  activeTimers.add(plantingRefreshInterval); 
}
// ‚úÖ 3. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderInProgressPlans ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á planting plans ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥
function renderInProgressPlans(plans) {
  console.log('üé® ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤ "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥" ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î...', plans);
  
  const tabContent = document.getElementById('tabContent');
  if (!tabContent) return;

  if (!plans || plans.length === 0) {
    tabContent.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-sync fa-3x" style="opacity: 0.5;"></i>
        <h3>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</h3>
        <p>‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô inbound ‡πÅ‡∏•‡πâ‡∏ß</p>
      </div>
    `;
    return;
  }

  // ‡πÉ‡∏ä‡πâ CSS class 'tasks-grid' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
  const html = `
    <div class="tasks-grid">
      ${plans.map(plan => {
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß
        const harvestDate = new Date(plan.harvest_date);
        const today = new Date();
        // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á today ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 00:00:00 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
        today.setHours(0, 0, 0, 0);
        const daysUntilHarvest = Math.ceil((harvestDate - today) / (1000 * 60 * 60 * 24));
        
        let daysStatus = 'normal';
        let daysText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysUntilHarvest} ‡∏ß‡∏±‡∏ô`;

        if (daysUntilHarvest < 0) {
            daysStatus = 'overdue';
            daysText = `‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${Math.abs(daysUntilHarvest)} ‡∏ß‡∏±‡∏ô`;
        } else if (daysUntilHarvest <= 7) {
            daysStatus = 'warning';
            daysText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysUntilHarvest} ‡∏ß‡∏±‡∏ô!`;
        }
        
        return `
        <div class="task-card in-progress-task alert-${daysStatus}">
          <div class="task-header">
            <div class="task-title">
              <i class="fas fa-seedling"></i>
              <span>${plan.vegetable_type}</span>
            </div>
            <div class="task-id">
              ID: ${plan.plan_id || plan.id}
            </div>
          </div>
          
          <div class="task-details">
            <div class="detail-item">
              <i class="fas fa-calendar-plus"></i>
              <span>‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å: ${formatDateThai(plan.plant_date)}</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-calendar-check"></i>
              <span>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß: ${formatDateThai(plan.harvest_date)}</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-sort-numeric-up"></i>
              <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${plan.plant_count.toLocaleString()} ‡∏ï‡πâ‡∏ô</span>
            </div>
            <div class="detail-item alert-detail">
              <i class="fas fa-clock alert-icon ${daysStatus}"></i>
              <span>${daysText}</span>
            </div>
            ${plan.notes ? `
              <div class="detail-item">
                <i class="fas fa-sticky-note"></i>
                <span title="${plan.notes}">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${plan.notes.substring(0, 30)}...</span>
              </div>
            ` : ''}
          </div>
          
          <div class="task-actions">
            <button onclick="createOutboundWorkOrder(${plan.id})" class="task-btn btn-primary">
              <i class="fas fa-arrow-up"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Outbound
            </button>
            <button onclick="viewPlanDetails(${plan.id})" class="task-btn btn-secondary">
              <i class="fas fa-eye"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            </button>
          </div>
        </div>
        `;
      }).join('')}
    </div>
  `;
  
  tabContent.innerHTML = html;
}

function renderInProgressPlans(plans) {
  console.log('üé® ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤ "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥" ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏µ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô...', plans);
  
  const tabContent = document.getElementById('tabContent');
  if (!tabContent) return;

  if (!plans || plans.length === 0) {
    tabContent.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-sync fa-3x" style="opacity: 0.5;"></i>
        <h3>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</h3>
        <p>‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô inbound ‡πÅ‡∏•‡πâ‡∏ß</p>
      </div>
    `;
    return;
  }

  const html = `
    <div class="tasks-grid">
      ${plans.map(plan => {
        // --- 1. ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡∏µ ---
        const plantDate = new Date(plan.plant_date);
        const harvestDate = new Date(plan.harvest_date);
        const today = new Date();
        today.setHours(0, 0, 0, 0); // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥

        const daysUntilHarvest = Math.ceil((harvestDate - today) / (1000 * 60 * 60 * 24));
        const daysSincePlanted = Math.floor((today - plantDate) / (1000 * 60 * 60 * 24));

        let statusClass = 'status-growing'; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)
        let statusText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï';
        let statusIcon = 'fa-seedling';

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î)
        if (daysUntilHarvest < 0) {
            statusClass = 'status-overdue';
            statusText = `‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${Math.abs(daysUntilHarvest)} ‡∏ß‡∏±‡∏ô`;
            statusIcon = 'fa-times-circle';
        } else if (daysUntilHarvest <= 3) {
            statusClass = 'status-urgent';
            statusText = `‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô ${daysUntilHarvest} ‡∏ß‡∏±‡∏ô`;
            statusIcon = 'fa-exclamation-triangle';
        } else if (daysSincePlanted <= 2) {
            statusClass = 'status-new';
            statusText = '‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡∏π‡∏Å';
            statusIcon = 'fa-clock';
        }

        // --- 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î ---
        return `
        <div class="task-card in-progress-task ${statusClass}">
          
          <div class="task-card-status-badge ${statusClass}">
              <i class="fas ${statusIcon}"></i>
              <span>${statusText}</span>
          </div>

          <div class="task-header">
            <div class="task-title">
              <i class="fas fa-leaf"></i>
              <span>${plan.vegetable_type}</span>
            </div>
            <div class="task-id">
              ID: ${plan.plan_id || plan.id}
            </div>
          </div>
          
          <div class="task-details">
            <div class="detail-item">
              <i class="fas fa-calendar-plus"></i>
              <span>‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å: ${formatDateThai(plan.plant_date)}</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-calendar-check"></i>
              <span>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß: ${formatDateThai(plan.harvest_date)}</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-sort-numeric-up"></i>
              <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${plan.plant_count.toLocaleString()} ‡∏ï‡πâ‡∏ô</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-layer-group"></i>
              <span>‡∏ä‡∏±‡πâ‡∏ô: ${plan.level_required || 1}</span>
            </div>
          </div>
          
          <div class="task-actions">
            <button onclick="createOutboundWorkOrder(${plan.id})" class="task-btn btn-primary">
              <i class="fas fa-arrow-up"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Outbound
            </button>
            <button onclick="viewPlanDetails(${plan.id})" class="task-btn btn-secondary">
              <i class="fas fa-eye"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            </button>
          </div>
        </div>
        `;
      }).join('')}
    </div>
  `;
  
  tabContent.innerHTML = html;
}

// ‚úÖ 4. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô debug ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥
async function debugInProgressTasks() {
  try {
    
    const response = await fetch('/api/tray-inventory');
    const allTrays = await response.json();
    
    console.log('üìã All trays:', allTrays);
    
    const withBatchId = allTrays.filter(tray => tray.batch_id);
    const withWorkOrder = allTrays.filter(tray => tray.batch_id && tray.batch_id.includes('WO-'));
    
    document.getElementById('tabContent').innerHTML = `
      <div style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
        <h4>üêõ Debug In-Progress Tasks</h4>
        <p><strong>Total Trays:</strong> ${allTrays.length}</p>
        <p><strong>Trays with Batch ID:</strong> ${withBatchId.length}</p>
        <p><strong>Trays with Work Order:</strong> ${withWorkOrder.length}</p>
        <hr>
        <h5>‡∏ñ‡∏≤‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</h5>
        <div style="max-height: 300px; overflow-y: auto;">
          ${allTrays.slice(0, 5).map(tray => `
            <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
              <strong>Tray ID:</strong> ${tray.tray_id} | 
              <strong>Batch ID:</strong> <code>${tray.batch_id || 'null'}</code><br>
              <strong>‡∏ú‡∏±‡∏Å:</strong> ${tray.veg_type} | 
              <strong>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> ‡∏ä‡∏±‡πâ‡∏ô ${tray.floor}, ‡∏ä‡πà‡∏≠‡∏á ${tray.slot}<br>
              <strong>‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö:</strong> ${tray.time_in}
            </div>
          `).join('')}
        </div>
        <button onclick="loadInProgressPlantingTasks()" class="btn-primary">
          <i class="fas fa-redo"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
        </button>
      </div>
    `;
    
  } catch (err) {
    console.error('‚ùå Debug error:', err);
  }
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Outbound ‡∏à‡∏≤‡∏Å planting plan
function createOutboundWorkOrder(planId) {
  console.log(`üöÄ Creating outbound work order for plan: ${planId}`);
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô outbound
  createQuickOutboundFromPlan(planId);
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö toggle ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
function togglePlanDetails(planId) {
  const detailsDiv = document.getElementById(`details-${planId}`);
  const toggleIcon = document.getElementById(`toggle-icon-${planId}`);
  
  if (detailsDiv.style.display === 'none') {
    detailsDiv.style.display = 'block';
    toggleIcon.className = 'fas fa-chevron-up';
    toggleIcon.parentElement.innerHTML = `<i class="fas fa-chevron-up" id="toggle-icon-${planId}"></i> ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î`;
  } else {
    detailsDiv.style.display = 'none';
    toggleIcon.className = 'fas fa-chevron-down';
    toggleIcon.parentElement.innerHTML = `<i class="fas fa-chevron-down" id="toggle-icon-${planId}"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î`;
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Outbound ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß
// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏õ Outbound ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
function goToOutbound(trayId, floor, slot, vegetableType) {
  console.log(`üöÄ Going to Outbound for tray: ${trayId}, floor: ${floor}, slot: ${slot}, veg: ${vegetableType}`);
  
  // ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Outbound
  window.selectedOutboundFloor = floor;
  window.selectedOutboundSlot = slot;
  window.selectedTrayId = trayId;
  window.selectedVegetableType = vegetableType;
  
  // ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Tray Outbound
  showPage('tray-outbound');
  
  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
  setTimeout(() => {
    const floorSelect = document.getElementById('outFloor');
    if (floorSelect) {
      floorSelect.value = floor;
      console.log(`‚úÖ Auto-selected floor ${floor} for outbound`);
      
      // Trigger validation function ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      if (typeof validateOutboundFloor === 'function') {
        validateOutboundFloor();
      }
    }
  }, 500);
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Outbound WO ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á)
async function createQuickOutboundWO(taskData) {
  try {
    console.log('üöÄ Creating auto Outbound WO:', taskData);
    showLoadingOverlay(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Outbound... (${taskData.vegetable} ‡∏ä‡∏±‡πâ‡∏ô ${taskData.floor})`);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á work order ‡πÇ‡∏î‡∏¢‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏±‡πâ‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    const response = await fetch(`/api/planting/plan/${taskData.planId}/quick-outbound-wo`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        created_by: 'auto_system',
        auto_floor: taskData.floor,
        auto_slot: taskData.slot,
        tray_id: taskData.trayId,
        plant_count: taskData.plantCount
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      hideLoadingOverlay();
      showNotification(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Outbound ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.work_order_number}
      üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ‡∏ä‡∏±‡πâ‡∏ô ${taskData.floor} ‡∏ä‡πà‡∏≠‡∏á ${taskData.slot}
      üåø ${taskData.vegetable} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${taskData.plantCount} ‡∏ï‡πâ‡∏ô`, 'success');
      
      // ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ WMS ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      if (result.auto_navigate) {
        setTimeout(() => {
          showPage('wms');
          refreshCurrentPlantingTab();
        }, 2000);
      } else {
        setTimeout(() => {
          refreshCurrentPlantingTab();
        }, 1500);
      }
      
    } else {
      throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Outbound ‡πÑ‡∏î‡πâ');
    }
    
  } catch (err) {
    hideLoadingOverlay();
    console.error('‚ùå Error creating auto outbound:', err);
    showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Outbound ‡πÑ‡∏î‡πâ: ' + err.message, 'error');
  }
}

async function createQuickOutboundFromPlan(planId) {
  try {
    showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Outbound...');
    
    const response = await fetch(`/api/planting/plan/${planId}/quick-outbound-wo`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        created_by: 'system_auto'
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      hideLoadingOverlay();
      showNotification(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Outbound ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.work_order_number}`, 'success');
      
      // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏∏‡∏•
      setTimeout(() => {
        refreshCurrentPlantingTab();
      }, 1500);
      
    } else {
      throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Outbound ‡πÑ‡∏î‡πâ');
    }
    
  } catch (err) {
    hideLoadingOverlay();
    console.error('‚ùå Error creating outbound:', err);
    showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Outbound ‡πÑ‡∏î‡πâ: ' + err.message, 'error');
  }
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î planting plan
function viewPlanDetails(planId) {
  console.log(`üëÅÔ∏è View details for plan: ${planId}`);
  showPlanDetails(planId);
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
async function viewProgress(planId) {
  try {
    console.log(`üìà View progress for plan: ${planId}`);
    showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤...');
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• planting plan ‡πÅ‡∏•‡∏∞ work orders ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
    const [planRes, workOrderRes, trayRes] = await Promise.all([
      fetch(`/api/planting-plans?id=${planId}`),
      fetch(`/api/work-orders?planting_plan_id=${planId}`),
      fetch(`/api/tray-inventory`)
    ]);
    
    const planData = await planRes.json();
    const workOrderData = await workOrderRes.json();
    const trayData = await trayRes.json();
    
    if (planData.success && planData.planting_plans && planData.planting_plans.length > 0) {
      const plan = planData.planting_plans[0];
      
      // ‡∏´‡∏≤‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö plan ‡∏ô‡∏µ‡πâ
      const relatedTrays = trayData.filter(tray => 
        tray.batch_id && (
          tray.batch_id.includes(`PLAN-${planId}`) || 
          tray.batch_id.includes(`WO-`) && workOrderData.work_orders?.some(wo => 
            wo.planting_plan_id == planId && tray.batch_id.includes(wo.work_order_number)
          )
        )
      );
      
      const progressHTML = `
        <div class="progress-modal">
          <div class="modal-header">
            <h3><i class="fas fa-chart-line"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ${plan.vegetable_type}</h3>
            <button onclick="hideLoadingOverlay()" class="close-btn">&times;</button>
          </div>
          <div class="progress-content">
            <div class="progress-summary">
              <div class="progress-item">
                <div class="progress-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏£‡∏ß‡∏°</div>
                <div class="progress-value">${plan.plant_count.toLocaleString()} ‡∏ï‡πâ‡∏ô</div>
              </div>
              <div class="progress-item">
                <div class="progress-label">‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</div>
                <div class="progress-value">${relatedTrays.length} ‡∏ñ‡∏≤‡∏î</div>
              </div>
              <div class="progress-item">
                <div class="progress-label">‡∏ï‡πâ‡∏ô‡∏ï‡πà‡∏≠‡∏ñ‡∏≤‡∏î</div>
                <div class="progress-value">${relatedTrays.length > 0 ? Math.round(plan.plant_count / relatedTrays.length) : 0} ‡∏ï‡πâ‡∏ô</div>
              </div>
            </div>
            
            ${relatedTrays.length > 0 ? `
              <div class="tray-list">
                <h4><i class="fas fa-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</h4>
                ${relatedTrays.map(tray => `
                  <div class="tray-item">
                    <div class="tray-header">
                      <span class="tray-id">${tray.tray_id}</span>
                      <span class="tray-status status-${tray.status}">${tray.status}</span>
                    </div>
                    <div class="tray-details">
                      <div><i class="fas fa-map-marker-alt" style="color: #dc3545;"></i> ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ‡∏ä‡∏±‡πâ‡∏ô ${tray.floor}, ‡∏ä‡πà‡∏≠‡∏á ${tray.slot}</div>
                      <div><i class="fas fa-seedling" style="color: #28a745;"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${tray.plant_quantity || 'N/A'} ‡∏ï‡πâ‡∏ô</div>
                      <div><i class="fas fa-calendar-plus" style="color: #007bff;"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î: ${formatDateThai(tray.time_in)}</div>
                      ${tray.batch_id ? `<div><i class="fas fa-box" style="color: #6f42c1;"></i> Batch: ${tray.batch_id}</div>` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : '<div class="no-trays">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</div>'}
            
            ${workOrderData.success && workOrderData.work_orders ? `
              <div class="work-orders-section">
                <h4><i class="fas fa-tasks"></i> ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</h4>
                ${workOrderData.work_orders.map(wo => `
                  <div class="work-order-item">
                    <div class="wo-header">
                      <span class="wo-number">${wo.work_order_number}</span>
                      <span class="wo-status status-${wo.status}">${wo.status}</span>
                    </div>
                    <div class="wo-details">
                      <div>üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${wo.task_type}</div>
                      <div>üìÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDateThai(wo.created_at)}</div>
                      ${wo.updated_at ? `<div>üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${formatDateThai(wo.updated_at)}</div>` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        </div>
      `;
      
      document.getElementById('loadingContent').innerHTML = progressHTML;
    } else {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• planting plan');
    }
    
  } catch (err) {
    console.error('‚ùå Error loading progress:', err);
    hideLoadingOverlay();
    showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ: ' + err.message, 'error');
  }
}

// ‚úÖ 5. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î planting plan
function viewTrayDetails(planId) {
  console.log(`üëÅÔ∏è View details for plan: ${planId}`);
  showPlanDetails(planId);
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î planting plan
async function showPlanDetails(planId) {
  try {
    showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...');
    
    const response = await fetch(`/api/planting-plans/${planId}/details`);
    const result = await response.json();
    
    hideLoadingOverlay();
    
    if (!result.success) {
      showNotification(result.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å', 'error');
      return;
    }
    
    const { plan, trays, work_orders, stats } = result;
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö popup
    const modalHtml = `
      <div id="planDetailsModal" class="modal-overlay" onclick="closePlanDetails(event)">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
          <div class="modal-header">
            <h2><i class="fas fa-seedling"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å</h2>
            <button class="modal-close" onclick="closePlanDetails()">&times;</button>
          </div>
          
          <div class="modal-body">
            <!-- Plan Info -->
            <div class="info-section">
              <h3><i class="fas fa-info-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô</h3>
              <div class="info-grid">
                <div><strong>‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ú‡∏ô:</strong> ${plan.plan_id || plan.id}</div>
                <div><strong>‡∏ú‡∏±‡∏Å:</strong> ${plan.vegetable_type || plan.vegetable_name || '-'}</div>
                <div><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:</strong> ${plan.plant_count} ‡∏ï‡πâ‡∏ô</div>
                <div><strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö:</strong> ${plan.level_required || plan.level || '-'}</div>
                <div><strong>‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å:</strong> ${plan.plant_date_formatted || formatDate(plan.plant_date)}</div>
                <div><strong>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß:</strong> ${plan.harvest_date_formatted || formatDate(plan.harvest_date)}</div>
                <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="status-badge status-${plan.status}">${getStatusText(plan.status)}</span></div>
                <div><strong>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${plan.created_at_formatted || formatDateTime(plan.created_at)}</div>
              </div>
            </div>
            
            <!-- Stats -->
            <div class="info-section">
              <h3><i class="fas fa-chart-bar"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3>
              <div class="stats-grid">
                <div class="stat-item">
                  <div class="stat-number">${stats.total_trays}</div>
                  <div class="stat-label">‡∏ñ‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">${stats.total_plants}</div>
                  <div class="stat-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">${stats.work_orders_count}</div>
                  <div class="stat-label">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">${stats.pending_work_orders}</div>
                  <div class="stat-label">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</div>
                </div>
              </div>
            </div>
            
            <!-- Trays -->
            <div class="info-section">
              <h3><i class="fas fa-th-large"></i> ‡∏ñ‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (${trays.length} ‡∏ñ‡∏≤‡∏î)</h3>
              ${trays.length > 0 ? `
                <div class="trays-grid">
                  ${trays.map(tray => `
                    <div class="tray-card">
                      <div class="tray-header">
                        <strong>${tray.tray_id}</strong>
                        <span class="status-badge status-${tray.status}">${getStatusText(tray.status)}</span>
                      </div>
                      <div class="tray-info">
                        <div><i class="fas fa-map-marker-alt"></i> ‡∏ä‡∏±‡πâ‡∏ô ${tray.floor} ‡∏ä‡πà‡∏≠‡∏á ${tray.slot}</div>
                        <div><i class="fas fa-seedling"></i> ${tray.plant_quantity || 0} ‡∏ï‡πâ‡∏ô</div>
                        <div><i class="fas fa-clock"></i> ${tray.time_in_formatted || formatDateTime(tray.time_in)}</div>
                        ${tray.seeding_date ? `<div><i class="fas fa-calendar"></i> ‡∏´‡∏ß‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${tray.seeding_date_formatted}</div>` : ''}
                      </div>
                      <button onclick="highlightTrayOnMap('${tray.tray_id}')" class="btn-sm btn-secondary">
                        <i class="fas fa-search"></i> ‡∏î‡∏π‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                      </button>
                    </div>
                  `).join('')}
                </div>
              ` : `
                <div class="empty-state-small">
                  <i class="fas fa-inbox"></i>
                  <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                  <p style="font-size: 12px; color: #666;">‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö Inbound ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÅ‡∏ú‡∏ô‡∏ô‡∏µ‡πâ</p>
                </div>
              `}
            </div>
            
            <!-- Work Orders -->
            <div class="info-section">
              <h3><i class="fas fa-clipboard-list"></i> ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (${work_orders.length} ‡πÉ‡∏ö)</h3>
              ${work_orders.length > 0 ? `
                <div class="work-orders-list">
                  ${work_orders.map(wo => `
                    <div class="work-order-card">
                      <div class="wo-header">
                        <strong>${wo.work_order_number}</strong>
                        <span class="status-badge status-${wo.status}">${getStatusText(wo.status)}</span>
                      </div>
                      <div class="wo-info">
                        <div><i class="fas fa-tasks"></i> ${wo.task_type}</div>
                        <div><i class="fas fa-calendar"></i> ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${wo.target_date_formatted}</div>
                        <div><i class="fas fa-seedling"></i> ${wo.vegetable_type || wo.vegetable_name || '-'}</div>
                        <div><i class="fas fa-clock"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${wo.created_at_formatted}</div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : `
                <div class="empty-state-small">
                  <i class="fas fa-clipboard"></i>
                  <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</p>
                </div>
              `}
            </div>
          </div>
          
          <div class="modal-footer">
            <button onclick="closePlanDetails()" class="btn-secondary">‡∏õ‡∏¥‡∏î</button>
            ${trays.length === 0 ? `
              <button onclick="createInboundForPlan('${plan.id}')" class="btn-primary">
                <i class="fas fa-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Inbound
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    `;
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    if (!document.getElementById('planDetailsStyles')) {
      const styles = document.createElement('style');
      styles.id = 'planDetailsStyles';
      styles.textContent = `
        .info-section {
          margin-bottom: 2rem;
          padding: 1.5rem;
          background: #f8f9fa;
          border-radius: 8px;
          border-left: 4px solid #28a745;
        }
        .info-section h3 {
          margin: 0 0 1rem 0;
          color: #28a745;
          font-size: 1.1rem;
        }
        .info-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 0.75rem;
        }
        .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
          gap: 1rem;
        }
        .stat-item {
          text-align: center;
          padding: 1rem;
          background: white;
          border-radius: 8px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-number {
          font-size: 2rem;
          font-weight: bold;
          color: #28a745;
        }
        .stat-label {
          color: #666;
          font-size: 0.9rem;
        }
        .trays-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
          gap: 1rem;
        }
        .tray-card {
          background: white;
          border-radius: 8px;
          padding: 1rem;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          border: 1px solid #dee2e6;
        }
        .tray-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.75rem;
          padding-bottom: 0.5rem;
          border-bottom: 1px solid #eee;
        }
        .tray-info {
          margin-bottom: 1rem;
        }
        .tray-info > div {
          margin-bottom: 0.25rem;
          font-size: 0.9rem;
          color: #666;
        }
        .work-orders-list {
          display: flex;
          flex-direction: column;
          gap: 1rem;
        }
        .work-order-card {
          background: white;
          border-radius: 8px;
          padding: 1rem;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          border: 1px solid #dee2e6;
        }
        .wo-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.75rem;
          padding-bottom: 0.5rem;
          border-bottom: 1px solid #eee;
        }
        .wo-info {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 0.5rem;
        }
        .wo-info > div {
          font-size: 0.9rem;
          color: #666;
        }
        .empty-state-small {
          text-align: center;
          padding: 2rem;
          color: #666;
        }
        .empty-state-small i {
          font-size: 2rem;
          margin-bottom: 1rem;
          color: #ccc;
        }
        .status-badge {
          padding: 0.25rem 0.5rem;
          border-radius: 4px;
          font-size: 0.8rem;
          font-weight: bold;
        }
        .status-received { background: #e3f2fd; color: #1976d2; }
        .status-in_progress { background: #fff3e0; color: #f57c00; }
        .status-completed { background: #e8f5e8; color: #2e7d32; }
        
        /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß */
        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .vegetable-name {
            margin: 0;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
        }
        
        .plan-id {
            background: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .detail-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .detail-section h5 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .detail-section h5 i {
            color: #007bff;
        }
        
        .detail-value.highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            color: #856404;
        }
        
        .priority-high { color: #dc3545; font-weight: 600; }
        .priority-medium { color: #fd7e14; font-weight: 600; }
        .priority-normal { color: #28a745; font-weight: 600; }
        
        .days-overdue { 
            color: #dc3545; 
            font-weight: 700;
            background: #f8d7da;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .days-urgent { 
            color: #fd7e14; 
            font-weight: 600;
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .days-normal { 
            color: #28a745; 
            font-weight: 500;
        }
        
        .notes-content {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            color: #495057;
            font-style: italic;
            line-height: 1.4;
        }
        
        .priority-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .action-btn.info {
            background: #17a2b8;
            border-color: #17a2b8;
            color: white;
        }
        
        .action-btn.info:hover {
            background: #138496;
            border-color: #117a8b;
        }
        
        /* ‚úÖ CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö task-card ‡πÅ‡∏ö‡∏ö compact */
        .task-card.compact {
            position: relative;
            min-height: auto;
            max-height: none;
        }
        
        .task-card.compact .task-content {
            padding: 15px;
        }
        
        .plan-summary {
            margin-bottom: 15px;
        }
        
        .plan-summary h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }
        
        .plan-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        
        .plan-meta .plan-id {
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .plan-meta .plant-count {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }
        
        .quick-info {
            margin-bottom: 15px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 13px;
            color: #495057;
        }
        
        .info-item i {
            width: 14px;
            color: #6c757d;
        }
        
        .info-item.days-overdue {
            color: #dc3545;
            font-weight: 600;
        }
        
        .info-item.days-urgent {
            color: #fd7e14;
            font-weight: 600;
        }
        
        .info-item.days-normal {
            color: #28a745;
        }
        
        .notes-preview {
            font-style: italic;
            opacity: 0.8;
        }
        
        .task-details-collapsed {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
            }
        }
        
        .task-card.compact .detail-section {
            margin-bottom: 15px;
            padding: 10px;
        }
        
        .task-card.compact .detail-section h5 {
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á task-card ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏¢‡∏≠‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô */
        .task-card.in-progress {
            position: relative;
            min-height: 500px;
        }
        
        .task-card .task-content {
            padding: 20px;
        }
        
        .task-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .task-actions .action-btn {
            flex: 1;
            min-width: 120px;
        }
        
        /* ‚úÖ CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Progress Modal */
        .progress-modal {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .progress-content {
            padding: 20px;
        }
        
        .progress-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .progress-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }
        
        .progress-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .progress-value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .tray-list, .work-orders-section {
            margin-bottom: 30px;
        }
        
        .tray-list h4, .work-orders-section h4 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tray-item, .work-order-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .tray-header, .wo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .tray-id, .wo-number {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .tray-status, .wo-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .tray-details, .wo-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .no-trays {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        .status-pending { background: #fff8e1; color: #f9a825; }
        .status-on_shelf { background: #e8f5e8; color: #2e7d32; }
        .status-growing { background: #fff3e0; color: #f57c00; }
        .status-ready_harvest { background: #fce4ec; color: #c2185b; }
        .status-empty { background: #f5f5f5; color: #757575; }
      `;
      document.head.appendChild(styles);
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
  } catch (err) {
    hideLoadingOverlay();
    console.error('‚ùå Error showing plan details:', err);
    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', 'error');
  }
}

function closePlanDetails(event) {
  if (event && event.target !== event.currentTarget) return;
  
  const modal = document.getElementById('planDetailsModal');
  if (modal) {
    modal.remove();
  }
}

function getStatusText(status) {
  const statusMap = {
    'received': '‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
    'in_progress': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', 
    'completed': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
    'pending': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
    'on_shelf': '‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏ä‡∏±‡πâ‡∏ô',
    'growing': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï',
    'ready_harvest': '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß',
    'empty': '‡∏ß‡πà‡∏≤‡∏á'
  };
  return statusMap[status] || status;
}

function formatDate(dateString) {
  if (!dateString) return '-';
  try {
    return new Date(dateString).toLocaleDateString('th-TH');
  } catch {
    return dateString;
  }
}

function formatDateTime(dateString) {
  if (!dateString) return '-';
  try {
    return new Date(dateString).toLocaleString('th-TH');
  } catch {
    return dateString;
  }
}

function highlightTrayOnMap(trayId) {
  showNotification(`üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡∏≤‡∏î ${trayId}`, 'info');
  
  // ‡∏õ‡∏¥‡∏î modal ‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ tray map
  closePlanDetails();
  showPage('tray-map');
  
  // ‡∏£‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ñ‡∏≤‡∏î
  setTimeout(() => {
    const trayElements = document.querySelectorAll('[data-tray-id]');
    trayElements.forEach(el => {
      if (el.dataset.trayId === trayId) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.style.animation = 'highlight 2s ease-in-out';
        el.style.border = '3px solid #28a745';
        setTimeout(() => {
          el.style.border = '';
        }, 3000);
      }
    });
  }, 1000);
}

function createInboundForPlan(planId) {
  showNotification('üöß ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô Inbound ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'info');
  // TODO: Implement auto create inbound work order
}

// ‚úÖ‚úÖ‚úÖ [‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏û‡∏£‡πâ‡∏≠‡∏° Popup ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‚úÖ‚úÖ‚úÖ
function checkHarvestReady(trayId) {
  console.log(`üåæ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ñ‡∏≤‡∏î: ${trayId}`);
  
  // 1. ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ñ‡∏≤‡∏î‡∏à‡∏≤‡∏Å trayInventory ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
  const actualTrayData = Object.values(trayInventory || {}).find(tray => tray.tray_id === trayId);

  // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
  if (!actualTrayData) {
    showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ñ‡∏≤‡∏î‡∏ô‡∏µ‡πâ', 'error');
    return;
  }
  
  // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ showConfirmationPopup() ‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
  showConfirmationPopup({
    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß',
    subtitle: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏ñ‡∏≤‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
    icon: 'fa-leaf', // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ 'fa-dolly-flatbed' ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô
    details: [
      { label: 'Tray ID', value: actualTrayData.tray_id, highlight: true },
      { label: '‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å', value: actualTrayData.veg_type },
      { label: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', value: `‡∏ä‡∏±‡πâ‡∏ô ${actualTrayData.floor} / ‡∏ä‡πà‡∏≠‡∏á ${actualTrayData.slot}` },
      { label: '‡∏≠‡∏≤‡∏¢‡∏∏‡∏ñ‡∏≤‡∏î', value: actualTrayData.age ? actualTrayData.age + ' ‡∏ß‡∏±‡∏ô' : calculateTrayAge(actualTrayData.time_in) }
    ],
    // 4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Outbound
    onConfirm: () => {
      showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Outbound...', 'info');
      
      // Navigate ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ outbound
      showPage('tray-outbound');
      
      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏î‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° outbound (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      setTimeout(() => {
        const floorSelect = document.getElementById('outFloor');
        if (floorSelect) {
          floorSelect.value = actualTrayData.floor;
          // Trigger validation function ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
          if (typeof validateOutboundFloor === 'function') {
            validateOutboundFloor();
          }
        }
      }, 500); // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤ Outbound ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
    }
  });
}

console.log('‚úÖ Date and Function fixes loaded!');
// ‚úÖ‚úÖ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Submit Form ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Harvest Date ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ ‚úÖ‚úÖ‚úÖ
async function submitInboundForm() {
    try {
        const data = {
            floor: document.getElementById('inFloor').value,
            slot: document.getElementById('inSlot').value,
            veg_type: document.getElementById('inVeg').value,
            quantity: document.getElementById('inPlantQuantity').value,
            batch_id: document.getElementById('inBatchId').value,
            seeding_date: document.getElementById('inSeedingDate').value,
            harvest_date: document.getElementById('inHarvestDate').value, // ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß
            notes: document.getElementById('inNotes').value,
            username: localStorage.getItem('username') || 'admin',
            station: currentStation || 1,
            work_order_id: document.getElementById('inWorkOrderId').value,
            planting_plan_id: document.getElementById('inPlantingPlanId').value
        };

        if (!data.floor || !data.slot || !data.veg_type || !data.quantity) {
            throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        }

        showConfirmationPopup({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡∏ñ‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà',
            subtitle: '‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
            icon: 'fa-leaf',
            details: [
                { label: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', value: `‡∏ä‡∏±‡πâ‡∏ô ${data.floor} / ‡∏ä‡πà‡∏≠‡∏á ${data.slot}`, highlight: true },
                { label: '‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å', value: data.veg_type },
                { label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô', value: `${data.quantity} ‡∏ï‡πâ‡∏ô` },
                { label: '‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ö‡∏ó‡∏ä‡πå', value: data.batch_id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' },
                { label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞', value: data.seeding_date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' },
                { label: '‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß', value: data.harvest_date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }, // ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô popup
                { label: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', value: data.notes || '‡πÑ‡∏°‡πà‡∏°‡∏µ' }
            ],
            onConfirm: async () => {
                await performInboundSubmission(data);
            }
        });
        
    } catch (error) {
        showNotification('‚ùå ' + error.message, 'error');
    }
}
// ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå index.html
async function performInboundSubmission(data) {
    try {
        const response = await fetch('/api/tray/inbound', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (!response.ok || result.error) {
            throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }

        showNotification('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏ñ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', 'success');
        
        // ‚ú®‚ú®‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô in_progress ‚ú®‚ú®‚ú®
        const plantingPlanId = document.getElementById('inPlantingPlanId').value;
        if (plantingPlanId) {
            try {
                await fetch(`/api/planting-plans/${plantingPlanId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'in_progress' })
                });
                console.log(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Plan ID: ${plantingPlanId} ‡πÄ‡∏õ‡πá‡∏ô 'in_progress' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            } catch (err) {
                console.warn(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Plan ID: ${plantingPlanId} ‡πÑ‡∏î‡πâ`, err);
            }
        }
        
        // ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ planting plan ‡πÅ‡∏•‡∏∞ switch ‡πÑ‡∏õ tab "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥"
        setTimeout(() => {
            showPage('planting-plan');
            
            setTimeout(() => {
                if (window.switchPlantingTab) {
                    switchPlantingTab('in-progress');
                }
            }, 1000);
        }, 2000);
        
        // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
        if(document.getElementById('inboundForm')) {
            document.getElementById('inboundForm').reset();
        }
        
    } catch (error) {
        console.error('‚ùå Submit error:', error);
        showNotification('‚ùå ' + error.message, 'error');
    }
}

function loadPlantingHistoryMock() {
  console.log("Planting History page is under development.");
}

// ‡∏•‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤
window.addEventListener('beforeunload', () => {
  if (window.plantingRefreshInterval) {
    clearInterval(window.plantingRefreshInterval);
  }
  
  // Close sensor WebSocket on page unload
  closeSensorWebSocket();
});

</script>


</body>

</html>
